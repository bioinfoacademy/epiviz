// Input 0
// Copyright 2006 The Closure Library Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS-IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/**
 * @fileoverview Bootstrap for the Google JS Library (Closure).
 *
 * In uncompiled mode base.js will write out Closure's deps file, unless the
 * global <code>CLOSURE_NO_DEPS</code> is set to true.  This allows projects to
 * include their own deps file(s) from different locations.
 *
 * @author arv@google.com (Erik Arvidsson)
 *
 * @provideGoog
 */


/**
 * @define {boolean} Overridden to true by the compiler when
 *     --process_closure_primitives is specified.
 */
var COMPILED = false;


/**
 * Base namespace for the Closure library.  Checks to see goog is already
 * defined in the current scope before assigning to prevent clobbering if
 * base.js is loaded more than once.
 *
 * @const
 */
var goog = goog || {};


/**
 * Reference to the global context.  In most cases this will be 'window'.
 */
goog.global = this;


/**
 * A hook for overriding the define values in uncompiled mode.
 *
 * In uncompiled mode, {@code CLOSURE_UNCOMPILED_DEFINES} may be defined before
 * loading base.js.  If a key is defined in {@code CLOSURE_UNCOMPILED_DEFINES},
 * {@code goog.define} will use the value instead of the default value.  This
 * allows flags to be overwritten without compilation (this is normally
 * accomplished with the compiler's "define" flag).
 *
 * Example:
 * <pre>
 *   var CLOSURE_UNCOMPILED_DEFINES = {'goog.DEBUG': false};
 * </pre>
 *
 * @type {Object<string, (string|number|boolean)>|undefined}
 */
goog.global.CLOSURE_UNCOMPILED_DEFINES;


/**
 * A hook for overriding the define values in uncompiled or compiled mode,
 * like CLOSURE_UNCOMPILED_DEFINES but effective in compiled code.  In
 * uncompiled code CLOSURE_UNCOMPILED_DEFINES takes precedence.
 *
 * Also unlike CLOSURE_UNCOMPILED_DEFINES the values must be number, boolean or
 * string literals or the compiler will emit an error.
 *
 * While any @define value may be set, only those set with goog.define will be
 * effective for uncompiled code.
 *
 * Example:
 * <pre>
 *   var CLOSURE_DEFINES = {'goog.DEBUG': false} ;
 * </pre>
 *
 * @type {Object<string, (string|number|boolean)>|undefined}
 */
goog.global.CLOSURE_DEFINES;


/**
 * Returns true if the specified value is not undefined.
 * WARNING: Do not use this to test if an object has a property. Use the in
 * operator instead.
 *
 * @param {?} val Variable to test.
 * @return {boolean} Whether variable is defined.
 */
goog.isDef = function(val) {
  // void 0 always evaluates to undefined and hence we do not need to depend on
  // the definition of the global variable named 'undefined'.
  return val !== void 0;
};


/**
 * Builds an object structure for the provided namespace path, ensuring that
 * names that already exist are not overwritten. For example:
 * "a.b.c" -> a = {};a.b={};a.b.c={};
 * Used by goog.provide and goog.exportSymbol.
 * @param {string} name name of the object that this file defines.
 * @param {*=} opt_object the object to expose at the end of the path.
 * @param {Object=} opt_objectToExportTo The object to add the path to; default
 *     is |goog.global|.
 * @private
 */
goog.exportPath_ = function(name, opt_object, opt_objectToExportTo) {
  var parts = name.split('.');
  var cur = opt_objectToExportTo || goog.global;

  // Internet Explorer exhibits strange behavior when throwing errors from
  // methods externed in this manner.  See the testExportSymbolExceptions in
  // base_test.html for an example.
  if (!(parts[0] in cur) && cur.execScript) {
    cur.execScript('var ' + parts[0]);
  }

  // Certain browsers cannot parse code in the form for((a in b); c;);
  // This pattern is produced by the JSCompiler when it collapses the
  // statement above into the conditional loop below. To prevent this from
  // happening, use a for-loop and reserve the init logic as below.

  // Parentheses added to eliminate strict JS warning in Firefox.
  for (var part; parts.length && (part = parts.shift());) {
    if (!parts.length && goog.isDef(opt_object)) {
      // last part and we have an object; use it
      cur[part] = opt_object;
    } else if (cur[part]) {
      cur = cur[part];
    } else {
      cur = cur[part] = {};
    }
  }
};


/**
 * Defines a named value. In uncompiled mode, the value is retrieved from
 * CLOSURE_DEFINES or CLOSURE_UNCOMPILED_DEFINES if the object is defined and
 * has the property specified, and otherwise used the defined defaultValue.
 * When compiled the default can be overridden using the compiler
 * options or the value set in the CLOSURE_DEFINES object.
 *
 * @param {string} name The distinguished name to provide.
 * @param {string|number|boolean} defaultValue
 */
goog.define = function(name, defaultValue) {
  var value = defaultValue;
  if (!COMPILED) {
    if (goog.global.CLOSURE_UNCOMPILED_DEFINES &&
        Object.prototype.hasOwnProperty.call(
            goog.global.CLOSURE_UNCOMPILED_DEFINES, name)) {
      value = goog.global.CLOSURE_UNCOMPILED_DEFINES[name];
    } else if (
        goog.global.CLOSURE_DEFINES &&
        Object.prototype.hasOwnProperty.call(
            goog.global.CLOSURE_DEFINES, name)) {
      value = goog.global.CLOSURE_DEFINES[name];
    }
  }
  goog.exportPath_(name, value);
};


/**
 * @define {boolean} DEBUG is provided as a convenience so that debugging code
 * that should not be included in a production js_binary can be easily stripped
 * by specifying --define goog.DEBUG=false to the JSCompiler. For example, most
 * toString() methods should be declared inside an "if (goog.DEBUG)" conditional
 * because they are generally used for debugging purposes and it is difficult
 * for the JSCompiler to statically determine whether they are used.
 */
goog.define('goog.DEBUG', true);


/**
 * @define {string} LOCALE defines the locale being used for compilation. It is
 * used to select locale specific data to be compiled in js binary. BUILD rule
 * can specify this value by "--define goog.LOCALE=<locale_name>" as JSCompiler
 * option.
 *
 * Take into account that the locale code format is important. You should use
 * the canonical Unicode format with hyphen as a delimiter. Language must be
 * lowercase, Language Script - Capitalized, Region - UPPERCASE.
 * There are few examples: pt-BR, en, en-US, sr-Latin-BO, zh-Hans-CN.
 *
 * See more info about locale codes here:
 * http://www.unicode.org/reports/tr35/#Unicode_Language_and_Locale_Identifiers
 *
 * For language codes you should use values defined by ISO 693-1. See it here
 * http://www.w3.org/WAI/ER/IG/ert/iso639.htm. There is only one exception from
 * this rule: the Hebrew language. For legacy reasons the old code (iw) should
 * be used instead of the new code (he), see http://wiki/Main/IIISynonyms.
 */
goog.define('goog.LOCALE', 'en');  // default to en


/**
 * @define {boolean} Whether this code is running on trusted sites.
 *
 * On untrusted sites, several native functions can be defined or overridden by
 * external libraries like Prototype, Datejs, and JQuery and setting this flag
 * to false forces closure to use its own implementations when possible.
 *
 * If your JavaScript can be loaded by a third party site and you are wary about
 * relying on non-standard implementations, specify
 * "--define goog.TRUSTED_SITE=false" to the JSCompiler.
 */
goog.define('goog.TRUSTED_SITE', true);


/**
 * @define {boolean} Whether a project is expected to be running in strict mode.
 *
 * This define can be used to trigger alternate implementations compatible with
 * running in EcmaScript Strict mode or warn about unavailable functionality.
 * @see https://goo.gl/PudQ4y
 *
 */
goog.define('goog.STRICT_MODE_COMPATIBLE', false);


/**
 * @define {boolean} Whether code that calls {@link goog.setTestOnly} should
 *     be disallowed in the compilation unit.
 */
goog.define('goog.DISALLOW_TEST_ONLY_CODE', COMPILED && !goog.DEBUG);


/**
 * @define {boolean} Whether to use a Chrome app CSP-compliant method for
 *     loading scripts via goog.require. @see appendScriptSrcNode_.
 */
goog.define('goog.ENABLE_CHROME_APP_SAFE_SCRIPT_LOADING', false);


/**
 * Defines a namespace in Closure.
 *
 * A namespace may only be defined once in a codebase. It may be defined using
 * goog.provide() or goog.module().
 *
 * The presence of one or more goog.provide() calls in a file indicates
 * that the file defines the given objects/namespaces.
 * Provided symbols must not be null or undefined.
 *
 * In addition, goog.provide() creates the object stubs for a namespace
 * (for example, goog.provide("goog.foo.bar") will create the object
 * goog.foo.bar if it does not already exist).
 *
 * Build tools also scan for provide/require/module statements
 * to discern dependencies, build dependency files (see deps.js), etc.
 *
 * @see goog.require
 * @see goog.module
 * @param {string} name Namespace provided by this file in the form
 *     "goog.package.part".
 */
goog.provide = function(name) {
  if (goog.isInModuleLoader_()) {
    throw Error('goog.provide can not be used within a goog.module.');
  }
  if (!COMPILED) {
    // Ensure that the same namespace isn't provided twice.
    // A goog.module/goog.provide maps a goog.require to a specific file
    if (goog.isProvided_(name)) {
      throw Error('Namespace "' + name + '" already declared.');
    }
  }

  goog.constructNamespace_(name);
};


/**
 * @param {string} name Namespace provided by this file in the form
 *     "goog.package.part".
 * @param {Object=} opt_obj The object to embed in the namespace.
 * @private
 */
goog.constructNamespace_ = function(name, opt_obj) {
  if (!COMPILED) {
    delete goog.implicitNamespaces_[name];

    var namespace = name;
    while ((namespace = namespace.substring(0, namespace.lastIndexOf('.')))) {
      if (goog.getObjectByName(namespace)) {
        break;
      }
      goog.implicitNamespaces_[namespace] = true;
    }
  }

  goog.exportPath_(name, opt_obj);
};


/**
 * Module identifier validation regexp.
 * Note: This is a conservative check, it is very possible to be more lenient,
 *   the primary exclusion here is "/" and "\" and a leading ".", these
 *   restrictions are intended to leave the door open for using goog.require
 *   with relative file paths rather than module identifiers.
 * @private
 */
goog.VALID_MODULE_RE_ = /^[a-zA-Z_$][a-zA-Z0-9._$]*$/;


/**
 * Defines a module in Closure.
 *
 * Marks that this file must be loaded as a module and claims the namespace.
 *
 * A namespace may only be defined once in a codebase. It may be defined using
 * goog.provide() or goog.module().
 *
 * goog.module() has three requirements:
 * - goog.module may not be used in the same file as goog.provide.
 * - goog.module must be the first statement in the file.
 * - only one goog.module is allowed per file.
 *
 * When a goog.module annotated file is loaded, it is enclosed in
 * a strict function closure. This means that:
 * - any variables declared in a goog.module file are private to the file
 * (not global), though the compiler is expected to inline the module.
 * - The code must obey all the rules of "strict" JavaScript.
 * - the file will be marked as "use strict"
 *
 * NOTE: unlike goog.provide, goog.module does not declare any symbols by
 * itself. If declared symbols are desired, use
 * goog.module.declareLegacyNamespace().
 *
 *
 * See the public goog.module proposal: http://goo.gl/Va1hin
 *
 * @param {string} name Namespace provided by this file in the form
 *     "goog.package.part", is expected but not required.
 * @return {void}
 */
goog.module = function(name) {
  if (!goog.isString(name) || !name ||
      name.search(goog.VALID_MODULE_RE_) == -1) {
    throw Error('Invalid module identifier');
  }
  if (!goog.isInModuleLoader_()) {
    throw Error(
        'Module ' + name + ' has been loaded incorrectly. Note, ' +
        'modules cannot be loaded as normal scripts. They require some kind of ' +
        'pre-processing step. You\'re likely trying to load a module via a ' +
        'script tag or as a part of a concatenated bundle without rewriting the ' +
        'module. For more info see: ' +
        'https://github.com/google/closure-library/wiki/goog.module:-an-ES6-module-like-alternative-to-goog.provide.');
  }
  if (goog.moduleLoaderState_.moduleName) {
    throw Error('goog.module may only be called once per module.');
  }

  // Store the module name for the loader.
  goog.moduleLoaderState_.moduleName = name;
  if (!COMPILED) {
    // Ensure that the same namespace isn't provided twice.
    // A goog.module/goog.provide maps a goog.require to a specific file
    if (goog.isProvided_(name)) {
      throw Error('Namespace "' + name + '" already declared.');
    }
    delete goog.implicitNamespaces_[name];
  }
};


/**
 * @param {string} name The module identifier.
 * @return {?} The module exports for an already loaded module or null.
 *
 * Note: This is not an alternative to goog.require, it does not
 * indicate a hard dependency, instead it is used to indicate
 * an optional dependency or to access the exports of a module
 * that has already been loaded.
 * @suppress {missingProvide}
 */
goog.module.get = function(name) {
  return goog.module.getInternal_(name);
};


/**
 * @param {string} name The module identifier.
 * @return {?} The module exports for an already loaded module or null.
 * @private
 */
goog.module.getInternal_ = function(name) {
  if (!COMPILED) {
    if (name in goog.loadedModules_) {
      return goog.loadedModules_[name];
    } else if (!goog.implicitNamespaces_[name]) {
      var ns = goog.getObjectByName(name);
      return ns != null ? ns : null;
    }
  }
  return null;
};


/**
 * @private {?{moduleName: (string|undefined), declareLegacyNamespace:boolean}}
 */
goog.moduleLoaderState_ = null;


/**
 * @private
 * @return {boolean} Whether a goog.module is currently being initialized.
 */
goog.isInModuleLoader_ = function() {
  return goog.moduleLoaderState_ != null;
};


/**
 * Provide the module's exports as a globally accessible object under the
 * module's declared name.  This is intended to ease migration to goog.module
 * for files that have existing usages.
 * @suppress {missingProvide}
 */
goog.module.declareLegacyNamespace = function() {
  if (!COMPILED && !goog.isInModuleLoader_()) {
    throw new Error(
        'goog.module.declareLegacyNamespace must be called from ' +
        'within a goog.module');
  }
  if (!COMPILED && !goog.moduleLoaderState_.moduleName) {
    throw Error(
        'goog.module must be called prior to ' +
        'goog.module.declareLegacyNamespace.');
  }
  goog.moduleLoaderState_.declareLegacyNamespace = true;
};


/**
 * Marks that the current file should only be used for testing, and never for
 * live code in production.
 *
 * In the case of unit tests, the message may optionally be an exact namespace
 * for the test (e.g. 'goog.stringTest'). The linter will then ignore the extra
 * provide (if not explicitly defined in the code).
 *
 * @param {string=} opt_message Optional message to add to the error that's
 *     raised when used in production code.
 */
goog.setTestOnly = function(opt_message) {
  if (goog.DISALLOW_TEST_ONLY_CODE) {
    opt_message = opt_message || '';
    throw Error(
        'Importing test-only code into non-debug environment' +
        (opt_message ? ': ' + opt_message : '.'));
  }
};


/**
 * Forward declares a symbol. This is an indication to the compiler that the
 * symbol may be used in the source yet is not required and may not be provided
 * in compilation.
 *
 * The most common usage of forward declaration is code that takes a type as a
 * function parameter but does not need to require it. By forward declaring
 * instead of requiring, no hard dependency is made, and (if not required
 * elsewhere) the namespace may never be required and thus, not be pulled
 * into the JavaScript binary. If it is required elsewhere, it will be type
 * checked as normal.
 *
 * Before using goog.forwardDeclare, please read the documentation at
 * https://github.com/google/closure-compiler/wiki/Bad-Type-Annotation to
 * understand the options and tradeoffs when working with forward declarations.
 *
 * @param {string} name The namespace to forward declare in the form of
 *     "goog.package.part".
 */
goog.forwardDeclare = function(name) {};


/**
 * Forward declare type information. Used to assign types to goog.global
 * referenced object that would otherwise result in unknown type references
 * and thus block property disambiguation.
 */
goog.forwardDeclare('Document');
goog.forwardDeclare('HTMLScriptElement');
goog.forwardDeclare('XMLHttpRequest');


if (!COMPILED) {
  /**
   * Check if the given name has been goog.provided. This will return false for
   * names that are available only as implicit namespaces.
   * @param {string} name name of the object to look for.
   * @return {boolean} Whether the name has been provided.
   * @private
   */
  goog.isProvided_ = function(name) {
    return (name in goog.loadedModules_) ||
        (!goog.implicitNamespaces_[name] &&
         goog.isDefAndNotNull(goog.getObjectByName(name)));
  };

  /**
   * Namespaces implicitly defined by goog.provide. For example,
   * goog.provide('goog.events.Event') implicitly declares that 'goog' and
   * 'goog.events' must be namespaces.
   *
   * @type {!Object<string, (boolean|undefined)>}
   * @private
   */
  goog.implicitNamespaces_ = {'goog.module': true};

  // NOTE: We add goog.module as an implicit namespace as goog.module is defined
  // here and because the existing module package has not been moved yet out of
  // the goog.module namespace. This satisifies both the debug loader and
  // ahead-of-time dependency management.
}


/**
 * Returns an object based on its fully qualified external name.  The object
 * is not found if null or undefined.  If you are using a compilation pass that
 * renames property names beware that using this function will not find renamed
 * properties.
 *
 * @param {string} name The fully qualified name.
 * @param {Object=} opt_obj The object within which to look; default is
 *     |goog.global|.
 * @return {?} The value (object or primitive) or, if not found, null.
 */
goog.getObjectByName = function(name, opt_obj) {
  var parts = name.split('.');
  var cur = opt_obj || goog.global;
  for (var part; part = parts.shift();) {
    if (goog.isDefAndNotNull(cur[part])) {
      cur = cur[part];
    } else {
      return null;
    }
  }
  return cur;
};


/**
 * Globalizes a whole namespace, such as goog or goog.lang.
 *
 * @param {!Object} obj The namespace to globalize.
 * @param {Object=} opt_global The object to add the properties to.
 * @deprecated Properties may be explicitly exported to the global scope, but
 *     this should no longer be done in bulk.
 */
goog.globalize = function(obj, opt_global) {
  var global = opt_global || goog.global;
  for (var x in obj) {
    global[x] = obj[x];
  }
};


/**
 * Adds a dependency from a file to the files it requires.
 * @param {string} relPath The path to the js file.
 * @param {!Array<string>} provides An array of strings with
 *     the names of the objects this file provides.
 * @param {!Array<string>} requires An array of strings with
 *     the names of the objects this file requires.
 * @param {boolean|!Object<string>=} opt_loadFlags Parameters indicating
 *     how the file must be loaded.  The boolean 'true' is equivalent
 *     to {'module': 'goog'} for backwards-compatibility.  Valid properties
 *     and values include {'module': 'goog'} and {'lang': 'es6'}.
 */
goog.addDependency = function(relPath, provides, requires, opt_loadFlags) {
  if (goog.DEPENDENCIES_ENABLED) {
    var provide, require;
    var path = relPath.replace(/\\/g, '/');
    var deps = goog.dependencies_;
    if (!opt_loadFlags || typeof opt_loadFlags === 'boolean') {
      opt_loadFlags = opt_loadFlags ? {'module': 'goog'} : {};
    }
    for (var i = 0; provide = provides[i]; i++) {
      deps.nameToPath[provide] = path;
      deps.loadFlags[path] = opt_loadFlags;
    }
    for (var j = 0; require = requires[j]; j++) {
      if (!(path in deps.requires)) {
        deps.requires[path] = {};
      }
      deps.requires[path][require] = true;
    }
  }
};




// NOTE(nnaze): The debug DOM loader was included in base.js as an original way
// to do "debug-mode" development.  The dependency system can sometimes be
// confusing, as can the debug DOM loader's asynchronous nature.
//
// With the DOM loader, a call to goog.require() is not blocking -- the script
// will not load until some point after the current script.  If a namespace is
// needed at runtime, it needs to be defined in a previous script, or loaded via
// require() with its registered dependencies.
//
// User-defined namespaces may need their own deps file. For a reference on
// creating a deps file, see:
// Externally: https://developers.google.com/closure/library/docs/depswriter
//
// Because of legacy clients, the DOM loader can't be easily removed from
// base.js.  Work is being done to make it disableable or replaceable for
// different environments (DOM-less JavaScript interpreters like Rhino or V8,
// for example). See bootstrap/ for more information.


/**
 * @define {boolean} Whether to enable the debug loader.
 *
 * If enabled, a call to goog.require() will attempt to load the namespace by
 * appending a script tag to the DOM (if the namespace has been registered).
 *
 * If disabled, goog.require() will simply assert that the namespace has been
 * provided (and depend on the fact that some outside tool correctly ordered
 * the script).
 */
goog.define('goog.ENABLE_DEBUG_LOADER', true);


/**
 * @param {string} msg
 * @private
 */
goog.logToConsole_ = function(msg) {
  if (goog.global.console) {
    goog.global.console['error'](msg);
  }
};


/**
 * Implements a system for the dynamic resolution of dependencies that works in
 * parallel with the BUILD system. Note that all calls to goog.require will be
 * stripped by the JSCompiler when the --process_closure_primitives option is
 * used.
 * @see goog.provide
 * @param {string} name Namespace to include (as was given in goog.provide()) in
 *     the form "goog.package.part".
 * @return {?} If called within a goog.module file, the associated namespace or
 *     module otherwise null.
 */
goog.require = function(name) {
  // If the object already exists we do not need do do anything.
  if (!COMPILED) {
    if (goog.ENABLE_DEBUG_LOADER && goog.IS_OLD_IE_) {
      goog.maybeProcessDeferredDep_(name);
    }

    if (goog.isProvided_(name)) {
      if (goog.isInModuleLoader_()) {
        return goog.module.getInternal_(name);
      }
    } else if (goog.ENABLE_DEBUG_LOADER) {
      var path = goog.getPathFromDeps_(name);
      if (path) {
        goog.writeScripts_(path);
      } else {
        var errorMessage = 'goog.require could not find: ' + name;
        goog.logToConsole_(errorMessage);

        throw Error(errorMessage);
      }
    }

    return null;
  }
};


/**
 * Path for included scripts.
 * @type {string}
 */
goog.basePath = '';


/**
 * A hook for overriding the base path.
 * @type {string|undefined}
 */
goog.global.CLOSURE_BASE_PATH;


/**
 * Whether to write out Closure's deps file. By default, the deps are written.
 * @type {boolean|undefined}
 */
goog.global.CLOSURE_NO_DEPS;


/**
 * A function to import a single script. This is meant to be overridden when
 * Closure is being run in non-HTML contexts, such as web workers. It's defined
 * in the global scope so that it can be set before base.js is loaded, which
 * allows deps.js to be imported properly.
 *
 * The function is passed the script source, which is a relative URI. It should
 * return true if the script was imported, false otherwise.
 * @type {(function(string): boolean)|undefined}
 */
goog.global.CLOSURE_IMPORT_SCRIPT;


/**
 * Null function used for default values of callbacks, etc.
 * @return {void} Nothing.
 */
goog.nullFunction = function() {};


/**
 * When defining a class Foo with an abstract method bar(), you can do:
 * Foo.prototype.bar = goog.abstractMethod
 *
 * Now if a subclass of Foo fails to override bar(), an error will be thrown
 * when bar() is invoked.
 *
 * Note: This does not take the name of the function to override as an argument
 * because that would make it more difficult to obfuscate our JavaScript code.
 *
 * @type {!Function}
 * @throws {Error} when invoked to indicate the method should be overridden.
 */
goog.abstractMethod = function() {
  throw Error('unimplemented abstract method');
};


/**
 * Adds a {@code getInstance} static method that always returns the same
 * instance object.
 * @param {!Function} ctor The constructor for the class to add the static
 *     method to.
 */
goog.addSingletonGetter = function(ctor) {
  // instance_ is immediately set to prevent issues with sealed constructors
  // such as are encountered when a constructor is returned as the export object
  // of a goog.module in unoptimized code.
  ctor.instance_ = undefined;
  ctor.getInstance = function() {
    if (ctor.instance_) {
      return ctor.instance_;
    }
    if (goog.DEBUG) {
      // NOTE: JSCompiler can't optimize away Array#push.
      goog.instantiatedSingletons_[goog.instantiatedSingletons_.length] = ctor;
    }
    return ctor.instance_ = new ctor;
  };
};


/**
 * All singleton classes that have been instantiated, for testing. Don't read
 * it directly, use the {@code goog.testing.singleton} module. The compiler
 * removes this variable if unused.
 * @type {!Array<!Function>}
 * @private
 */
goog.instantiatedSingletons_ = [];


/**
 * @define {boolean} Whether to load goog.modules using {@code eval} when using
 * the debug loader.  This provides a better debugging experience as the
 * source is unmodified and can be edited using Chrome Workspaces or similar.
 * However in some environments the use of {@code eval} is banned
 * so we provide an alternative.
 */
goog.define('goog.LOAD_MODULE_USING_EVAL', true);


/**
 * @define {boolean} Whether the exports of goog.modules should be sealed when
 * possible.
 */
goog.define('goog.SEAL_MODULE_EXPORTS', goog.DEBUG);


/**
 * The registry of initialized modules:
 * the module identifier to module exports map.
 * @private @const {!Object<string, ?>}
 */
goog.loadedModules_ = {};


/**
 * True if goog.dependencies_ is available.
 * @const {boolean}
 */
goog.DEPENDENCIES_ENABLED = !COMPILED && goog.ENABLE_DEBUG_LOADER;


/**
 * @define {string} How to decide whether to transpile.  Valid values
 * are 'always', 'never', and 'detect'.  The default ('detect') is to
 * use feature detection to determine which language levels need
 * transpilation.
 */
// NOTE(user): we could expand this to accept a language level to bypass
// detection: e.g. goog.TRANSPILE == 'es5' would transpile ES6 files but
// would leave ES3 and ES5 files alone.
goog.define('goog.TRANSPILE', 'detect');


/**
 * @define {string} Path to the transpiler.  Executing the script at this
 * path (relative to base.js) should define a function $jscomp.transpile.
 */
goog.define('goog.TRANSPILER', 'transpile.js');


if (goog.DEPENDENCIES_ENABLED) {
  /**
   * This object is used to keep track of dependencies and other data that is
   * used for loading scripts.
   * @private
   * @type {{
   *   loadFlags: !Object<string, !Object<string, string>>,
   *   nameToPath: !Object<string, string>,
   *   requires: !Object<string, !Object<string, boolean>>,
   *   visited: !Object<string, boolean>,
   *   written: !Object<string, boolean>,
   *   deferred: !Object<string, string>
   * }}
   */
  goog.dependencies_ = {
    loadFlags: {},  // 1 to 1

    nameToPath: {},  // 1 to 1

    requires: {},  // 1 to many

    // Used when resolving dependencies to prevent us from visiting file twice.
    visited: {},

    written: {},  // Used to keep track of script files we have written.

    deferred: {}  // Used to track deferred module evaluations in old IEs
  };


  /**
   * Tries to detect whether is in the context of an HTML document.
   * @return {boolean} True if it looks like HTML document.
   * @private
   */
  goog.inHtmlDocument_ = function() {
    /** @type {Document} */
    var doc = goog.global.document;
    return doc != null && 'write' in doc;  // XULDocument misses write.
  };


  /**
   * Tries to detect the base path of base.js script that bootstraps Closure.
   * @private
   */
  goog.findBasePath_ = function() {
    if (goog.isDef(goog.global.CLOSURE_BASE_PATH)) {
      goog.basePath = goog.global.CLOSURE_BASE_PATH;
      return;
    } else if (!goog.inHtmlDocument_()) {
      return;
    }
    /** @type {Document} */
    var doc = goog.global.document;
    var scripts = doc.getElementsByTagName('SCRIPT');
    // Search backwards since the current script is in almost all cases the one
    // that has base.js.
    for (var i = scripts.length - 1; i >= 0; --i) {
      var script = /** @type {!HTMLScriptElement} */ (scripts[i]);
      var src = script.src;
      var qmark = src.lastIndexOf('?');
      var l = qmark == -1 ? src.length : qmark;
      if (src.substr(l - 7, 7) == 'base.js') {
        goog.basePath = src.substr(0, l - 7);
        return;
      }
    }
  };


  /**
   * Imports a script if, and only if, that script hasn't already been imported.
   * (Must be called at execution time)
   * @param {string} src Script source.
   * @param {string=} opt_sourceText The optionally source text to evaluate
   * @private
   */
  goog.importScript_ = function(src, opt_sourceText) {
    var importScript =
        goog.global.CLOSURE_IMPORT_SCRIPT || goog.writeScriptTag_;
    if (importScript(src, opt_sourceText)) {
      goog.dependencies_.written[src] = true;
    }
  };


  /**
   * Whether the browser is IE9 or earlier, which needs special handling
   * for deferred modules.
   * @const @private {boolean}
   */
  goog.IS_OLD_IE_ =
      !!(!goog.global.atob && goog.global.document && goog.global.document.all);


  /**
   * Given a URL initiate retrieval and execution of a script that needs
   * pre-processing.
   * @param {string} src Script source URL.
   * @param {boolean} isModule Whether this is a goog.module.
   * @param {boolean} needsTranspile Whether this source needs transpilation.
   * @private
   */
  goog.importProcessedScript_ = function(src, isModule, needsTranspile) {
    // In an attempt to keep browsers from timing out loading scripts using
    // synchronous XHRs, put each load in its own script block.
    var bootstrap = 'goog.retrieveAndExec_("' + src + '", ' + isModule + ', ' +
        needsTranspile + ');';

    goog.importScript_('', bootstrap);
  };


  /** @private {!Array<string>} */
  goog.queuedModules_ = [];


  /**
   * Return an appropriate module text. Suitable to insert into
   * a script tag (that is unescaped).
   * @param {string} srcUrl
   * @param {string} scriptText
   * @return {string}
   * @private
   */
  goog.wrapModule_ = function(srcUrl, scriptText) {
    if (!goog.LOAD_MODULE_USING_EVAL || !goog.isDef(goog.global.JSON)) {
      return '' +
          'goog.loadModule(function(exports) {' +
          '"use strict";' + scriptText +
          '\n' +  // terminate any trailing single line comment.
          ';return exports' +
          '});' +
          '\n//# sourceURL=' + srcUrl + '\n';
    } else {
      return '' +
          'goog.loadModule(' +
          goog.global.JSON.stringify(
              scriptText + '\n//# sourceURL=' + srcUrl + '\n') +
          ');';
    }
  };

  // On IE9 and earlier, it is necessary to handle
  // deferred module loads. In later browsers, the
  // code to be evaluated is simply inserted as a script
  // block in the correct order. To eval deferred
  // code at the right time, we piggy back on goog.require to call
  // goog.maybeProcessDeferredDep_.
  //
  // The goog.requires are used both to bootstrap
  // the loading process (when no deps are available) and
  // declare that they should be available.
  //
  // Here we eval the sources, if all the deps are available
  // either already eval'd or goog.require'd.  This will
  // be the case when all the dependencies have already
  // been loaded, and the dependent module is loaded.
  //
  // But this alone isn't sufficient because it is also
  // necessary to handle the case where there is no root
  // that is not deferred.  For that there we register for an event
  // and trigger goog.loadQueuedModules_ handle any remaining deferred
  // evaluations.

  /**
   * Handle any remaining deferred goog.module evals.
   * @private
   */
  goog.loadQueuedModules_ = function() {
    var count = goog.queuedModules_.length;
    if (count > 0) {
      var queue = goog.queuedModules_;
      goog.queuedModules_ = [];
      for (var i = 0; i < count; i++) {
        var path = queue[i];
        goog.maybeProcessDeferredPath_(path);
      }
    }
  };


  /**
   * Eval the named module if its dependencies are
   * available.
   * @param {string} name The module to load.
   * @private
   */
  goog.maybeProcessDeferredDep_ = function(name) {
    if (goog.isDeferredModule_(name) && goog.allDepsAreAvailable_(name)) {
      var path = goog.getPathFromDeps_(name);
      goog.maybeProcessDeferredPath_(goog.basePath + path);
    }
  };

  /**
   * @param {string} name The module to check.
   * @return {boolean} Whether the name represents a
   *     module whose evaluation has been deferred.
   * @private
   */
  goog.isDeferredModule_ = function(name) {
    var path = goog.getPathFromDeps_(name);
    var loadFlags = path && goog.dependencies_.loadFlags[path] || {};
    var languageLevel = loadFlags['lang'] || 'es3';
    if (path && (loadFlags['module'] == 'goog' ||
                 goog.needsTranspile_(languageLevel))) {
      var abspath = goog.basePath + path;
      return (abspath) in goog.dependencies_.deferred;
    }
    return false;
  };

  /**
   * @param {string} name The module to check.
   * @return {boolean} Whether the name represents a
   *     module whose declared dependencies have all been loaded
   *     (eval'd or a deferred module load)
   * @private
   */
  goog.allDepsAreAvailable_ = function(name) {
    var path = goog.getPathFromDeps_(name);
    if (path && (path in goog.dependencies_.requires)) {
      for (var requireName in goog.dependencies_.requires[path]) {
        if (!goog.isProvided_(requireName) &&
            !goog.isDeferredModule_(requireName)) {
          return false;
        }
      }
    }
    return true;
  };


  /**
   * @param {string} abspath
   * @private
   */
  goog.maybeProcessDeferredPath_ = function(abspath) {
    if (abspath in goog.dependencies_.deferred) {
      var src = goog.dependencies_.deferred[abspath];
      delete goog.dependencies_.deferred[abspath];
      goog.globalEval(src);
    }
  };


  /**
   * Load a goog.module from the provided URL.  This is not a general purpose
   * code loader and does not support late loading code, that is it should only
   * be used during page load. This method exists to support unit tests and
   * "debug" loaders that would otherwise have inserted script tags. Under the
   * hood this needs to use a synchronous XHR and is not recommeneded for
   * production code.
   *
   * The module's goog.requires must have already been satisified; an exception
   * will be thrown if this is not the case. This assumption is that no
   * "deps.js" file exists, so there is no way to discover and locate the
   * module-to-be-loaded's dependencies and no attempt is made to do so.
   *
   * There should only be one attempt to load a module.  If
   * "goog.loadModuleFromUrl" is called for an already loaded module, an
   * exception will be throw.
   *
   * @param {string} url The URL from which to attempt to load the goog.module.
   */
  goog.loadModuleFromUrl = function(url) {
    // Because this executes synchronously, we don't need to do any additional
    // bookkeeping. When "goog.loadModule" the namespace will be marked as
    // having been provided which is sufficient.
    goog.retrieveAndExec_(url, true, false);
  };


  /**
   * Writes a new script pointing to {@code src} directly into the DOM.
   *
   * NOTE: This method is not CSP-compliant. @see goog.appendScriptSrcNode_ for
   * the fallback mechanism.
   *
   * @param {string} src The script URL.
   * @private
   */
  goog.writeScriptSrcNode_ = function(src) {
    goog.global.document.write(
        '<script type="text/javascript" src="' + src + '"></' +
        'script>');
  };


  /**
   * Appends a new script node to the DOM using a CSP-compliant mechanism. This
   * method exists as a fallback for document.write (which is not allowed in a
   * strict CSP context, e.g., Chrome apps).
   *
   * NOTE: This method is not analogous to using document.write to insert a
   * <script> tag; specifically, the user agent will execute a script added by
   * document.write immediately after the current script block finishes
   * executing, whereas the DOM-appended script node will not be executed until
   * the entire document is parsed and executed. That is to say, this script is
   * added to the end of the script execution queue.
   *
   * The page must not attempt to call goog.required entities until after the
   * document has loaded, e.g., in or after the window.onload callback.
   *
   * @param {string} src The script URL.
   * @private
   */
  goog.appendScriptSrcNode_ = function(src) {
    /** @type {Document} */
    var doc = goog.global.document;
    var scriptEl =
        /** @type {HTMLScriptElement} */ (doc.createElement('script'));
    scriptEl.type = 'text/javascript';
    scriptEl.src = src;
    scriptEl.defer = false;
    scriptEl.async = false;
    doc.head.appendChild(scriptEl);
  };


  /**
   * The default implementation of the import function. Writes a script tag to
   * import the script.
   *
   * @param {string} src The script url.
   * @param {string=} opt_sourceText The optionally source text to evaluate
   * @return {boolean} True if the script was imported, false otherwise.
   * @private
   */
  goog.writeScriptTag_ = function(src, opt_sourceText) {
    if (goog.inHtmlDocument_()) {
      /** @type {!HTMLDocument} */
      var doc = goog.global.document;

      // If the user tries to require a new symbol after document load,
      // something has gone terribly wrong. Doing a document.write would
      // wipe out the page. This does not apply to the CSP-compliant method
      // of writing script tags.
      if (!goog.ENABLE_CHROME_APP_SAFE_SCRIPT_LOADING &&
          doc.readyState == 'complete') {
        // Certain test frameworks load base.js multiple times, which tries
        // to write deps.js each time. If that happens, just fail silently.
        // These frameworks wipe the page between each load of base.js, so this
        // is OK.
        var isDeps = /\bdeps.js$/.test(src);
        if (isDeps) {
          return false;
        } else {
          throw Error('Cannot write "' + src + '" after document load');
        }
      }

      if (opt_sourceText === undefined) {
        if (!goog.IS_OLD_IE_) {
          if (goog.ENABLE_CHROME_APP_SAFE_SCRIPT_LOADING) {
            goog.appendScriptSrcNode_(src);
          } else {
            goog.writeScriptSrcNode_(src);
          }
        } else {
          var state = ' onreadystatechange=\'goog.onScriptLoad_(this, ' +
              ++goog.lastNonModuleScriptIndex_ + ')\' ';
          doc.write(
              '<script type="text/javascript" src="' + src + '"' + state +
              '></' +
              'script>');
        }
      } else {
        doc.write(
            '<script type="text/javascript">' +
            goog.protectScriptTag_(opt_sourceText) + '</' +
            'script>');
      }
      return true;
    } else {
      return false;
    }
  };

  /**
   * Rewrites closing script tags in input to avoid ending an enclosing script
   * tag.
   *
   * @param {string} str
   * @return {string}
   * @private
   */
  goog.protectScriptTag_ = function(str) {
    return str.replace(/<\/(SCRIPT)/ig, '\\x3c\\$1');
  };

  /**
   * Determines whether the given language needs to be transpiled.
   * @param {string} lang
   * @return {boolean}
   * @private
   */
  goog.needsTranspile_ = function(lang) {
    if (goog.TRANSPILE == 'always') {
      return true;
    } else if (goog.TRANSPILE == 'never') {
      return false;
    } else if (!goog.requiresTranspilation_) {
      goog.requiresTranspilation_ = goog.createRequiresTranspilation_();
    }
    if (lang in goog.requiresTranspilation_) {
      return goog.requiresTranspilation_[lang];
    } else {
      throw new Error('Unknown language mode: ' + lang);
    }
  };

  /** @private {?Object<string, boolean>} */
  goog.requiresTranspilation_ = null;


  /** @private {number} */
  goog.lastNonModuleScriptIndex_ = 0;


  /**
   * A readystatechange handler for legacy IE
   * @param {!HTMLScriptElement} script
   * @param {number} scriptIndex
   * @return {boolean}
   * @private
   */
  goog.onScriptLoad_ = function(script, scriptIndex) {
    // for now load the modules when we reach the last script,
    // later allow more inter-mingling.
    if (script.readyState == 'complete' &&
        goog.lastNonModuleScriptIndex_ == scriptIndex) {
      goog.loadQueuedModules_();
    }
    return true;
  };

  /**
   * Resolves dependencies based on the dependencies added using addDependency
   * and calls importScript_ in the correct order.
   * @param {string} pathToLoad The path from which to start discovering
   *     dependencies.
   * @private
   */
  goog.writeScripts_ = function(pathToLoad) {
    /** @type {!Array<string>} The scripts we need to write this time. */
    var scripts = [];
    var seenScript = {};
    var deps = goog.dependencies_;

    /** @param {string} path */
    function visitNode(path) {
      if (path in deps.written) {
        return;
      }

      // We have already visited this one. We can get here if we have cyclic
      // dependencies.
      if (path in deps.visited) {
        return;
      }

      deps.visited[path] = true;

      if (path in deps.requires) {
        for (var requireName in deps.requires[path]) {
          // If the required name is defined, we assume that it was already
          // bootstrapped by other means.
          if (!goog.isProvided_(requireName)) {
            if (requireName in deps.nameToPath) {
              visitNode(deps.nameToPath[requireName]);
            } else {
              throw Error('Undefined nameToPath for ' + requireName);
            }
          }
        }
      }

      if (!(path in seenScript)) {
        seenScript[path] = true;
        scripts.push(path);
      }
    }

    visitNode(pathToLoad);

    // record that we are going to load all these scripts.
    for (var i = 0; i < scripts.length; i++) {
      var path = scripts[i];
      goog.dependencies_.written[path] = true;
    }

    // If a module is loaded synchronously then we need to
    // clear the current inModuleLoader value, and restore it when we are
    // done loading the current "requires".
    var moduleState = goog.moduleLoaderState_;
    goog.moduleLoaderState_ = null;

    for (var i = 0; i < scripts.length; i++) {
      var path = scripts[i];
      if (path) {
        var loadFlags = deps.loadFlags[path] || {};
        var languageLevel = loadFlags['lang'] || 'es3';
        var needsTranspile = goog.needsTranspile_(languageLevel);
        if (loadFlags['module'] == 'goog' || needsTranspile) {
          goog.importProcessedScript_(
              goog.basePath + path, loadFlags['module'] == 'goog',
              needsTranspile);
        } else {
          goog.importScript_(goog.basePath + path);
        }
      } else {
        goog.moduleLoaderState_ = moduleState;
        throw Error('Undefined script input');
      }
    }

    // restore the current "module loading state"
    goog.moduleLoaderState_ = moduleState;
  };


  /**
   * Looks at the dependency rules and tries to determine the script file that
   * fulfills a particular rule.
   * @param {string} rule In the form goog.namespace.Class or project.script.
   * @return {?string} Url corresponding to the rule, or null.
   * @private
   */
  goog.getPathFromDeps_ = function(rule) {
    if (rule in goog.dependencies_.nameToPath) {
      return goog.dependencies_.nameToPath[rule];
    } else {
      return null;
    }
  };

  goog.findBasePath_();

  // Allow projects to manage the deps files themselves.
  if (!goog.global.CLOSURE_NO_DEPS) {
    goog.importScript_(goog.basePath + 'deps.js');
  }
}


/**
 * @param {function(?):?|string} moduleDef The module definition.
 */
goog.loadModule = function(moduleDef) {
  // NOTE: we allow function definitions to be either in the from
  // of a string to eval (which keeps the original source intact) or
  // in a eval forbidden environment (CSP) we allow a function definition
  // which in its body must call {@code goog.module}, and return the exports
  // of the module.
  var previousState = goog.moduleLoaderState_;
  try {
    goog.moduleLoaderState_ = {
      moduleName: undefined,
      declareLegacyNamespace: false
    };
    var exports;
    if (goog.isFunction(moduleDef)) {
      exports = moduleDef.call(undefined, {});
    } else if (goog.isString(moduleDef)) {
      exports = goog.loadModuleFromSource_.call(undefined, moduleDef);
    } else {
      throw Error('Invalid module definition');
    }

    var moduleName = goog.moduleLoaderState_.moduleName;
    if (!goog.isString(moduleName) || !moduleName) {
      throw Error('Invalid module name \"' + moduleName + '\"');
    }

    // Don't seal legacy namespaces as they may be uses as a parent of
    // another namespace
    if (goog.moduleLoaderState_.declareLegacyNamespace) {
      goog.constructNamespace_(moduleName, exports);
    } else if (
        goog.SEAL_MODULE_EXPORTS && Object.seal && goog.isObject(exports)) {
      Object.seal(exports);
    }

    goog.loadedModules_[moduleName] = exports;
  } finally {
    goog.moduleLoaderState_ = previousState;
  }
};


/**
 * @private @const {function(string):?}
 *
 * The new type inference warns because this function has no formal
 * parameters, but its jsdoc says that it takes one argument.
 * (The argument is used via arguments[0], but NTI does not detect this.)
 * @suppress {newCheckTypes}
 */
goog.loadModuleFromSource_ = function() {
  // NOTE: we avoid declaring parameters or local variables here to avoid
  // masking globals or leaking values into the module definition.
  'use strict';
  var exports = {};
  eval(arguments[0]);
  return exports;
};


/**
 * Normalize a file path by removing redundant ".." and extraneous "." file
 * path components.
 * @param {string} path
 * @return {string}
 * @private
 */
goog.normalizePath_ = function(path) {
  var components = path.split('/');
  var i = 0;
  while (i < components.length) {
    if (components[i] == '.') {
      components.splice(i, 1);
    } else if (
        i && components[i] == '..' && components[i - 1] &&
        components[i - 1] != '..') {
      components.splice(--i, 2);
    } else {
      i++;
    }
  }
  return components.join('/');
};


/**
 * Loads file by synchronous XHR. Should not be used in production environments.
 * @param {string} src Source URL.
 * @return {?string} File contents, or null if load failed.
 * @private
 */
goog.loadFileSync_ = function(src) {
  if (goog.global.CLOSURE_LOAD_FILE_SYNC) {
    return goog.global.CLOSURE_LOAD_FILE_SYNC(src);
  } else {
    try {
      /** @type {XMLHttpRequest} */
      var xhr = new goog.global['XMLHttpRequest']();
      xhr.open('get', src, false);
      xhr.send();
      // NOTE: Successful http: requests have a status of 200, but successful
      // file: requests may have a status of zero.  Any other status, or a
      // thrown exception (particularly in case of file: requests) indicates
      // some sort of error, which we treat as a missing or unavailable file.
      return xhr.status == 0 || xhr.status == 200 ? xhr.responseText : null;
    } catch (err) {
      // No need to rethrow or log, since errors should show up on their own.
      return null;
    }
  }
};


/**
 * Retrieve and execute a script that needs some sort of wrapping.
 * @param {string} src Script source URL.
 * @param {boolean} isModule Whether to load as a module.
 * @param {boolean} needsTranspile Whether to transpile down to ES3.
 * @private
 */
goog.retrieveAndExec_ = function(src, isModule, needsTranspile) {
  if (!COMPILED) {
    // The full but non-canonicalized URL for later use.
    var originalPath = src;
    // Canonicalize the path, removing any /./ or /../ since Chrome's debugging
    // console doesn't auto-canonicalize XHR loads as it does <script> srcs.
    src = goog.normalizePath_(src);

    var importScript =
        goog.global.CLOSURE_IMPORT_SCRIPT || goog.writeScriptTag_;

    var scriptText = goog.loadFileSync_(src);
    if (scriptText == null) {
      throw new Error('Load of "' + src + '" failed');
    }

    if (needsTranspile) {
      scriptText = goog.transpile_.call(goog.global, scriptText, src);
    }

    if (isModule) {
      scriptText = goog.wrapModule_(src, scriptText);
    } else {
      scriptText += '\n//# sourceURL=' + src;
    }
    var isOldIE = goog.IS_OLD_IE_;
    if (isOldIE) {
      goog.dependencies_.deferred[originalPath] = scriptText;
      goog.queuedModules_.push(originalPath);
    } else {
      importScript(src, scriptText);
    }
  }
};


/**
 * Lazily retrieves the transpiler and applies it to the source.
 * @param {string} code JS code.
 * @param {string} path Path to the code.
 * @return {string} The transpiled code.
 * @private
 */
goog.transpile_ = function(code, path) {
  var jscomp = goog.global['$jscomp'];
  if (!jscomp) {
    goog.global['$jscomp'] = jscomp = {};
  }
  var transpile = jscomp.transpile;
  if (!transpile) {
    var transpilerPath = goog.basePath + goog.TRANSPILER;
    var transpilerCode = goog.loadFileSync_(transpilerPath);
    if (transpilerCode) {
      // This must be executed synchronously, since by the time we know we
      // need it, we're about to load and write the ES6 code synchronously,
      // so a normal script-tag load will be too slow.
      eval(transpilerCode + '\n//# sourceURL=' + transpilerPath);
      // Even though the transpiler is optional, if $gwtExport is found, it's
      // a sign the transpiler was loaded and the $jscomp.transpile *should*
      // be there.
      if (goog.global['$gwtExport'] && goog.global['$gwtExport']['$jscomp'] &&
          !goog.global['$gwtExport']['$jscomp']['transpile']) {
        throw new Error(
            'The transpiler did not properly export the "transpile" ' +
            'method. $gwtExport: ' + JSON.stringify(goog.global['$gwtExport']));
      }
      // transpile.js only exports a single $jscomp function, transpile. We
      // grab just that and add it to the existing definition of $jscomp which
      // contains the polyfills.
      goog.global['$jscomp'].transpile =
          goog.global['$gwtExport']['$jscomp']['transpile'];
      jscomp = goog.global['$jscomp'];
      transpile = jscomp.transpile;
    }
  }
  if (!transpile) {
    // The transpiler is an optional component.  If it's not available then
    // replace it with a pass-through function that simply logs.
    var suffix = ' requires transpilation but no transpiler was found.';
    transpile = jscomp.transpile = function(code, path) {
      // TODO(user): figure out some way to get this error to show up
      // in test results, noting that the failure may occur in many
      // different ways, including in loadModule() before the test
      // runner even comes up.
      goog.logToConsole_(path + suffix);
      return code;
    };
  }
  // Note: any transpilation errors/warnings will be logged to the console.
  return transpile(code, path);
};


//==============================================================================
// Language Enhancements
//==============================================================================


/**
 * This is a "fixed" version of the typeof operator.  It differs from the typeof
 * operator in such a way that null returns 'null' and arrays return 'array'.
 * @param {?} value The value to get the type of.
 * @return {string} The name of the type.
 */
goog.typeOf = function(value) {
  var s = typeof value;
  if (s == 'object') {
    if (value) {
      // Check these first, so we can avoid calling Object.prototype.toString if
      // possible.
      //
      // IE improperly marshals typeof across execution contexts, but a
      // cross-context object will still return false for "instanceof Object".
      if (value instanceof Array) {
        return 'array';
      } else if (value instanceof Object) {
        return s;
      }

      // HACK: In order to use an Object prototype method on the arbitrary
      //   value, the compiler requires the value be cast to type Object,
      //   even though the ECMA spec explicitly allows it.
      var className = Object.prototype.toString.call(
          /** @type {!Object} */ (value));
      // In Firefox 3.6, attempting to access iframe window objects' length
      // property throws an NS_ERROR_FAILURE, so we need to special-case it
      // here.
      if (className == '[object Window]') {
        return 'object';
      }

      // We cannot always use constructor == Array or instanceof Array because
      // different frames have different Array objects. In IE6, if the iframe
      // where the array was created is destroyed, the array loses its
      // prototype. Then dereferencing val.splice here throws an exception, so
      // we can't use goog.isFunction. Calling typeof directly returns 'unknown'
      // so that will work. In this case, this function will return false and
      // most array functions will still work because the array is still
      // array-like (supports length and []) even though it has lost its
      // prototype.
      // Mark Miller noticed that Object.prototype.toString
      // allows access to the unforgeable [[Class]] property.
      //  15.2.4.2 Object.prototype.toString ( )
      //  When the toString method is called, the following steps are taken:
      //      1. Get the [[Class]] property of this object.
      //      2. Compute a string value by concatenating the three strings
      //         "[object ", Result(1), and "]".
      //      3. Return Result(2).
      // and this behavior survives the destruction of the execution context.
      if ((className == '[object Array]' ||
           // In IE all non value types are wrapped as objects across window
           // boundaries (not iframe though) so we have to do object detection
           // for this edge case.
           typeof value.length == 'number' &&
               typeof value.splice != 'undefined' &&
               typeof value.propertyIsEnumerable != 'undefined' &&
               !value.propertyIsEnumerable('splice')

               )) {
        return 'array';
      }
      // HACK: There is still an array case that fails.
      //     function ArrayImpostor() {}
      //     ArrayImpostor.prototype = [];
      //     var impostor = new ArrayImpostor;
      // this can be fixed by getting rid of the fast path
      // (value instanceof Array) and solely relying on
      // (value && Object.prototype.toString.vall(value) === '[object Array]')
      // but that would require many more function calls and is not warranted
      // unless closure code is receiving objects from untrusted sources.

      // IE in cross-window calls does not correctly marshal the function type
      // (it appears just as an object) so we cannot use just typeof val ==
      // 'function'. However, if the object has a call property, it is a
      // function.
      if ((className == '[object Function]' ||
           typeof value.call != 'undefined' &&
               typeof value.propertyIsEnumerable != 'undefined' &&
               !value.propertyIsEnumerable('call'))) {
        return 'function';
      }

    } else {
      return 'null';
    }

  } else if (s == 'function' && typeof value.call == 'undefined') {
    // In Safari typeof nodeList returns 'function', and on Firefox typeof
    // behaves similarly for HTML{Applet,Embed,Object}, Elements and RegExps. We
    // would like to return object for those and we can detect an invalid
    // function by making sure that the function object has a call method.
    return 'object';
  }
  return s;
};


/**
 * Returns true if the specified value is null.
 * @param {?} val Variable to test.
 * @return {boolean} Whether variable is null.
 */
goog.isNull = function(val) {
  return val === null;
};


/**
 * Returns true if the specified value is defined and not null.
 * @param {?} val Variable to test.
 * @return {boolean} Whether variable is defined and not null.
 */
goog.isDefAndNotNull = function(val) {
  // Note that undefined == null.
  return val != null;
};


/**
 * Returns true if the specified value is an array.
 * @param {?} val Variable to test.
 * @return {boolean} Whether variable is an array.
 */
goog.isArray = function(val) {
  return goog.typeOf(val) == 'array';
};


/**
 * Returns true if the object looks like an array. To qualify as array like
 * the value needs to be either a NodeList or an object with a Number length
 * property. As a special case, a function value is not array like, because its
 * length property is fixed to correspond to the number of expected arguments.
 * @param {?} val Variable to test.
 * @return {boolean} Whether variable is an array.
 */
goog.isArrayLike = function(val) {
  var type = goog.typeOf(val);
  // We do not use goog.isObject here in order to exclude function values.
  return type == 'array' || type == 'object' && typeof val.length == 'number';
};


/**
 * Returns true if the object looks like a Date. To qualify as Date-like the
 * value needs to be an object and have a getFullYear() function.
 * @param {?} val Variable to test.
 * @return {boolean} Whether variable is a like a Date.
 */
goog.isDateLike = function(val) {
  return goog.isObject(val) && typeof val.getFullYear == 'function';
};


/**
 * Returns true if the specified value is a string.
 * @param {?} val Variable to test.
 * @return {boolean} Whether variable is a string.
 */
goog.isString = function(val) {
  return typeof val == 'string';
};


/**
 * Returns true if the specified value is a boolean.
 * @param {?} val Variable to test.
 * @return {boolean} Whether variable is boolean.
 */
goog.isBoolean = function(val) {
  return typeof val == 'boolean';
};


/**
 * Returns true if the specified value is a number.
 * @param {?} val Variable to test.
 * @return {boolean} Whether variable is a number.
 */
goog.isNumber = function(val) {
  return typeof val == 'number';
};


/**
 * Returns true if the specified value is a function.
 * @param {?} val Variable to test.
 * @return {boolean} Whether variable is a function.
 */
goog.isFunction = function(val) {
  return goog.typeOf(val) == 'function';
};


/**
 * Returns true if the specified value is an object.  This includes arrays and
 * functions.
 * @param {?} val Variable to test.
 * @return {boolean} Whether variable is an object.
 */
goog.isObject = function(val) {
  var type = typeof val;
  return type == 'object' && val != null || type == 'function';
  // return Object(val) === val also works, but is slower, especially if val is
  // not an object.
};


/**
 * Gets a unique ID for an object. This mutates the object so that further calls
 * with the same object as a parameter returns the same value. The unique ID is
 * guaranteed to be unique across the current session amongst objects that are
 * passed into {@code getUid}. There is no guarantee that the ID is unique or
 * consistent across sessions. It is unsafe to generate unique ID for function
 * prototypes.
 *
 * @param {Object} obj The object to get the unique ID for.
 * @return {number} The unique ID for the object.
 */
goog.getUid = function(obj) {
  // TODO(arv): Make the type stricter, do not accept null.

  // In Opera window.hasOwnProperty exists but always returns false so we avoid
  // using it. As a consequence the unique ID generated for BaseClass.prototype
  // and SubClass.prototype will be the same.
  return obj[goog.UID_PROPERTY_] ||
      (obj[goog.UID_PROPERTY_] = ++goog.uidCounter_);
};


/**
 * Whether the given object is already assigned a unique ID.
 *
 * This does not modify the object.
 *
 * @param {!Object} obj The object to check.
 * @return {boolean} Whether there is an assigned unique id for the object.
 */
goog.hasUid = function(obj) {
  return !!obj[goog.UID_PROPERTY_];
};


/**
 * Removes the unique ID from an object. This is useful if the object was
 * previously mutated using {@code goog.getUid} in which case the mutation is
 * undone.
 * @param {Object} obj The object to remove the unique ID field from.
 */
goog.removeUid = function(obj) {
  // TODO(arv): Make the type stricter, do not accept null.

  // In IE, DOM nodes are not instances of Object and throw an exception if we
  // try to delete.  Instead we try to use removeAttribute.
  if (obj !== null && 'removeAttribute' in obj) {
    obj.removeAttribute(goog.UID_PROPERTY_);
  }
  /** @preserveTry */
  try {
    delete obj[goog.UID_PROPERTY_];
  } catch (ex) {
  }
};


/**
 * Name for unique ID property. Initialized in a way to help avoid collisions
 * with other closure JavaScript on the same page.
 * @type {string}
 * @private
 */
goog.UID_PROPERTY_ = 'closure_uid_' + ((Math.random() * 1e9) >>> 0);


/**
 * Counter for UID.
 * @type {number}
 * @private
 */
goog.uidCounter_ = 0;


/**
 * Adds a hash code field to an object. The hash code is unique for the
 * given object.
 * @param {Object} obj The object to get the hash code for.
 * @return {number} The hash code for the object.
 * @deprecated Use goog.getUid instead.
 */
goog.getHashCode = goog.getUid;


/**
 * Removes the hash code field from an object.
 * @param {Object} obj The object to remove the field from.
 * @deprecated Use goog.removeUid instead.
 */
goog.removeHashCode = goog.removeUid;


/**
 * Clones a value. The input may be an Object, Array, or basic type. Objects and
 * arrays will be cloned recursively.
 *
 * WARNINGS:
 * <code>goog.cloneObject</code> does not detect reference loops. Objects that
 * refer to themselves will cause infinite recursion.
 *
 * <code>goog.cloneObject</code> is unaware of unique identifiers, and copies
 * UIDs created by <code>getUid</code> into cloned results.
 *
 * @param {*} obj The value to clone.
 * @return {*} A clone of the input value.
 * @deprecated goog.cloneObject is unsafe. Prefer the goog.object methods.
 */
goog.cloneObject = function(obj) {
  var type = goog.typeOf(obj);
  if (type == 'object' || type == 'array') {
    if (obj.clone) {
      return obj.clone();
    }
    var clone = type == 'array' ? [] : {};
    for (var key in obj) {
      clone[key] = goog.cloneObject(obj[key]);
    }
    return clone;
  }

  return obj;
};


/**
 * A native implementation of goog.bind.
 * @param {Function} fn A function to partially apply.
 * @param {Object|undefined} selfObj Specifies the object which this should
 *     point to when the function is run.
 * @param {...*} var_args Additional arguments that are partially applied to the
 *     function.
 * @return {!Function} A partially-applied form of the function bind() was
 *     invoked as a method of.
 * @private
 * @suppress {deprecated} The compiler thinks that Function.prototype.bind is
 *     deprecated because some people have declared a pure-JS version.
 *     Only the pure-JS version is truly deprecated.
 */
goog.bindNative_ = function(fn, selfObj, var_args) {
  return /** @type {!Function} */ (fn.call.apply(fn.bind, arguments));
};


/**
 * A pure-JS implementation of goog.bind.
 * @param {Function} fn A function to partially apply.
 * @param {Object|undefined} selfObj Specifies the object which this should
 *     point to when the function is run.
 * @param {...*} var_args Additional arguments that are partially applied to the
 *     function.
 * @return {!Function} A partially-applied form of the function bind() was
 *     invoked as a method of.
 * @private
 */
goog.bindJs_ = function(fn, selfObj, var_args) {
  if (!fn) {
    throw new Error();
  }

  if (arguments.length > 2) {
    var boundArgs = Array.prototype.slice.call(arguments, 2);
    return function() {
      // Prepend the bound arguments to the current arguments.
      var newArgs = Array.prototype.slice.call(arguments);
      Array.prototype.unshift.apply(newArgs, boundArgs);
      return fn.apply(selfObj, newArgs);
    };

  } else {
    return function() {
      return fn.apply(selfObj, arguments);
    };
  }
};


/**
 * Partially applies this function to a particular 'this object' and zero or
 * more arguments. The result is a new function with some arguments of the first
 * function pre-filled and the value of this 'pre-specified'.
 *
 * Remaining arguments specified at call-time are appended to the pre-specified
 * ones.
 *
 * Also see: {@link #partial}.
 *
 * Usage:
 * <pre>var barMethBound = goog.bind(myFunction, myObj, 'arg1', 'arg2');
 * barMethBound('arg3', 'arg4');</pre>
 *
 * @param {?function(this:T, ...)} fn A function to partially apply.
 * @param {T} selfObj Specifies the object which this should point to when the
 *     function is run.
 * @param {...*} var_args Additional arguments that are partially applied to the
 *     function.
 * @return {!Function} A partially-applied form of the function goog.bind() was
 *     invoked as a method of.
 * @template T
 * @suppress {deprecated} See above.
 */
goog.bind = function(fn, selfObj, var_args) {
  // TODO(nicksantos): narrow the type signature.
  if (Function.prototype.bind &&
      // NOTE(nicksantos): Somebody pulled base.js into the default Chrome
      // extension environment. This means that for Chrome extensions, they get
      // the implementation of Function.prototype.bind that calls goog.bind
      // instead of the native one. Even worse, we don't want to introduce a
      // circular dependency between goog.bind and Function.prototype.bind, so
      // we have to hack this to make sure it works correctly.
      Function.prototype.bind.toString().indexOf('native code') != -1) {
    goog.bind = goog.bindNative_;
  } else {
    goog.bind = goog.bindJs_;
  }
  return goog.bind.apply(null, arguments);
};


/**
 * Like goog.bind(), except that a 'this object' is not required. Useful when
 * the target function is already bound.
 *
 * Usage:
 * var g = goog.partial(f, arg1, arg2);
 * g(arg3, arg4);
 *
 * @param {Function} fn A function to partially apply.
 * @param {...*} var_args Additional arguments that are partially applied to fn.
 * @return {!Function} A partially-applied form of the function goog.partial()
 *     was invoked as a method of.
 */
goog.partial = function(fn, var_args) {
  var args = Array.prototype.slice.call(arguments, 1);
  return function() {
    // Clone the array (with slice()) and append additional arguments
    // to the existing arguments.
    var newArgs = args.slice();
    newArgs.push.apply(newArgs, arguments);
    return fn.apply(this, newArgs);
  };
};


/**
 * Copies all the members of a source object to a target object. This method
 * does not work on all browsers for all objects that contain keys such as
 * toString or hasOwnProperty. Use goog.object.extend for this purpose.
 * @param {Object} target Target.
 * @param {Object} source Source.
 */
goog.mixin = function(target, source) {
  for (var x in source) {
    target[x] = source[x];
  }

  // For IE7 or lower, the for-in-loop does not contain any properties that are
  // not enumerable on the prototype object (for example, isPrototypeOf from
  // Object.prototype) but also it will not include 'replace' on objects that
  // extend String and change 'replace' (not that it is common for anyone to
  // extend anything except Object).
};


/**
 * @return {number} An integer value representing the number of milliseconds
 *     between midnight, January 1, 1970 and the current time.
 */
goog.now = (goog.TRUSTED_SITE && Date.now) || (function() {
             // Unary plus operator converts its operand to a number which in
             // the case of
             // a date is done by calling getTime().
             return +new Date();
           });


/**
 * Evals JavaScript in the global scope.  In IE this uses execScript, other
 * browsers use goog.global.eval. If goog.global.eval does not evaluate in the
 * global scope (for example, in Safari), appends a script tag instead.
 * Throws an exception if neither execScript or eval is defined.
 * @param {string} script JavaScript string.
 */
goog.globalEval = function(script) {
  if (goog.global.execScript) {
    goog.global.execScript(script, 'JavaScript');
  } else if (goog.global.eval) {
    // Test to see if eval works
    if (goog.evalWorksForGlobals_ == null) {
      goog.global.eval('var _evalTest_ = 1;');
      if (typeof goog.global['_evalTest_'] != 'undefined') {
        try {
          delete goog.global['_evalTest_'];
        } catch (ignore) {
          // Microsoft edge fails the deletion above in strict mode.
        }
        goog.evalWorksForGlobals_ = true;
      } else {
        goog.evalWorksForGlobals_ = false;
      }
    }

    if (goog.evalWorksForGlobals_) {
      goog.global.eval(script);
    } else {
      /** @type {Document} */
      var doc = goog.global.document;
      var scriptElt =
          /** @type {!HTMLScriptElement} */ (doc.createElement('SCRIPT'));
      scriptElt.type = 'text/javascript';
      scriptElt.defer = false;
      // Note(user): can't use .innerHTML since "t('<test>')" will fail and
      // .text doesn't work in Safari 2.  Therefore we append a text node.
      scriptElt.appendChild(doc.createTextNode(script));
      doc.body.appendChild(scriptElt);
      doc.body.removeChild(scriptElt);
    }
  } else {
    throw Error('goog.globalEval not available');
  }
};


/**
 * Indicates whether or not we can call 'eval' directly to eval code in the
 * global scope. Set to a Boolean by the first call to goog.globalEval (which
 * empirically tests whether eval works for globals). @see goog.globalEval
 * @type {?boolean}
 * @private
 */
goog.evalWorksForGlobals_ = null;


/**
 * Optional map of CSS class names to obfuscated names used with
 * goog.getCssName().
 * @private {!Object<string, string>|undefined}
 * @see goog.setCssNameMapping
 */
goog.cssNameMapping_;


/**
 * Optional obfuscation style for CSS class names. Should be set to either
 * 'BY_WHOLE' or 'BY_PART' if defined.
 * @type {string|undefined}
 * @private
 * @see goog.setCssNameMapping
 */
goog.cssNameMappingStyle_;


/**
 * Handles strings that are intended to be used as CSS class names.
 *
 * This function works in tandem with @see goog.setCssNameMapping.
 *
 * Without any mapping set, the arguments are simple joined with a hyphen and
 * passed through unaltered.
 *
 * When there is a mapping, there are two possible styles in which these
 * mappings are used. In the BY_PART style, each part (i.e. in between hyphens)
 * of the passed in css name is rewritten according to the map. In the BY_WHOLE
 * style, the full css name is looked up in the map directly. If a rewrite is
 * not specified by the map, the compiler will output a warning.
 *
 * When the mapping is passed to the compiler, it will replace calls to
 * goog.getCssName with the strings from the mapping, e.g.
 *     var x = goog.getCssName('foo');
 *     var y = goog.getCssName(this.baseClass, 'active');
 *  becomes:
 *     var x = 'foo';
 *     var y = this.baseClass + '-active';
 *
 * If one argument is passed it will be processed, if two are passed only the
 * modifier will be processed, as it is assumed the first argument was generated
 * as a result of calling goog.getCssName.
 *
 * @param {string} className The class name.
 * @param {string=} opt_modifier A modifier to be appended to the class name.
 * @return {string} The class name or the concatenation of the class name and
 *     the modifier.
 */
goog.getCssName = function(className, opt_modifier) {
  // String() is used for compatibility with compiled soy where the passed
  // className can be non-string objects like here
  // http://google3/java/com/google/privacy/accountcentral/common/ui/client/cards/popupcard.soy?l=74&rcl=94079467
  if (String(className).charAt(0) == '.') {
    throw new Error(
        'className passed in goog.getCssName must not start with ".".' +
        ' You passed: ' + className);
  }

  var getMapping = function(cssName) {
    return goog.cssNameMapping_[cssName] || cssName;
  };

  var renameByParts = function(cssName) {
    // Remap all the parts individually.
    var parts = cssName.split('-');
    var mapped = [];
    for (var i = 0; i < parts.length; i++) {
      mapped.push(getMapping(parts[i]));
    }
    return mapped.join('-');
  };

  var rename;
  if (goog.cssNameMapping_) {
    rename =
        goog.cssNameMappingStyle_ == 'BY_WHOLE' ? getMapping : renameByParts;
  } else {
    rename = function(a) {
      return a;
    };
  }

  var result =
      opt_modifier ? className + '-' + rename(opt_modifier) : rename(className);

  // The special CLOSURE_CSS_NAME_MAP_FN allows users to specify further
  // processing of the class name.
  if (goog.global.CLOSURE_CSS_NAME_MAP_FN) {
    return goog.global.CLOSURE_CSS_NAME_MAP_FN(result);
  }

  return result;
};


/**
 * Sets the map to check when returning a value from goog.getCssName(). Example:
 * <pre>
 * goog.setCssNameMapping({
 *   "goog": "a",
 *   "disabled": "b",
 * });
 *
 * var x = goog.getCssName('goog');
 * // The following evaluates to: "a a-b".
 * goog.getCssName('goog') + ' ' + goog.getCssName(x, 'disabled')
 * </pre>
 * When declared as a map of string literals to string literals, the JSCompiler
 * will replace all calls to goog.getCssName() using the supplied map if the
 * --process_closure_primitives flag is set.
 *
 * @param {!Object} mapping A map of strings to strings where keys are possible
 *     arguments to goog.getCssName() and values are the corresponding values
 *     that should be returned.
 * @param {string=} opt_style The style of css name mapping. There are two valid
 *     options: 'BY_PART', and 'BY_WHOLE'.
 * @see goog.getCssName for a description.
 */
goog.setCssNameMapping = function(mapping, opt_style) {
  goog.cssNameMapping_ = mapping;
  goog.cssNameMappingStyle_ = opt_style;
};


/**
 * To use CSS renaming in compiled mode, one of the input files should have a
 * call to goog.setCssNameMapping() with an object literal that the JSCompiler
 * can extract and use to replace all calls to goog.getCssName(). In uncompiled
 * mode, JavaScript code should be loaded before this base.js file that declares
 * a global variable, CLOSURE_CSS_NAME_MAPPING, which is used below. This is
 * to ensure that the mapping is loaded before any calls to goog.getCssName()
 * are made in uncompiled mode.
 *
 * A hook for overriding the CSS name mapping.
 * @type {!Object<string, string>|undefined}
 */
goog.global.CLOSURE_CSS_NAME_MAPPING;


if (!COMPILED && goog.global.CLOSURE_CSS_NAME_MAPPING) {
  // This does not call goog.setCssNameMapping() because the JSCompiler
  // requires that goog.setCssNameMapping() be called with an object literal.
  goog.cssNameMapping_ = goog.global.CLOSURE_CSS_NAME_MAPPING;
}


/**
 * Gets a localized message.
 *
 * This function is a compiler primitive. If you give the compiler a localized
 * message bundle, it will replace the string at compile-time with a localized
 * version, and expand goog.getMsg call to a concatenated string.
 *
 * Messages must be initialized in the form:
 * <code>
 * var MSG_NAME = goog.getMsg('Hello {$placeholder}', {'placeholder': 'world'});
 * </code>
 *
 * This function produces a string which should be treated as plain text. Use
 * {@link goog.html.SafeHtmlFormatter} in conjunction with goog.getMsg to
 * produce SafeHtml.
 *
 * @param {string} str Translatable string, places holders in the form {$foo}.
 * @param {Object<string, string>=} opt_values Maps place holder name to value.
 * @return {string} message with placeholders filled.
 */
goog.getMsg = function(str, opt_values) {
  if (opt_values) {
    str = str.replace(/\{\$([^}]+)}/g, function(match, key) {
      return (opt_values != null && key in opt_values) ? opt_values[key] :
                                                         match;
    });
  }
  return str;
};


/**
 * Gets a localized message. If the message does not have a translation, gives a
 * fallback message.
 *
 * This is useful when introducing a new message that has not yet been
 * translated into all languages.
 *
 * This function is a compiler primitive. Must be used in the form:
 * <code>var x = goog.getMsgWithFallback(MSG_A, MSG_B);</code>
 * where MSG_A and MSG_B were initialized with goog.getMsg.
 *
 * @param {string} a The preferred message.
 * @param {string} b The fallback message.
 * @return {string} The best translated message.
 */
goog.getMsgWithFallback = function(a, b) {
  return a;
};


/**
 * Exposes an unobfuscated global namespace path for the given object.
 * Note that fields of the exported object *will* be obfuscated, unless they are
 * exported in turn via this function or goog.exportProperty.
 *
 * Also handy for making public items that are defined in anonymous closures.
 *
 * ex. goog.exportSymbol('public.path.Foo', Foo);
 *
 * ex. goog.exportSymbol('public.path.Foo.staticFunction', Foo.staticFunction);
 *     public.path.Foo.staticFunction();
 *
 * ex. goog.exportSymbol('public.path.Foo.prototype.myMethod',
 *                       Foo.prototype.myMethod);
 *     new public.path.Foo().myMethod();
 *
 * @param {string} publicPath Unobfuscated name to export.
 * @param {*} object Object the name should point to.
 * @param {Object=} opt_objectToExportTo The object to add the path to; default
 *     is goog.global.
 */
goog.exportSymbol = function(publicPath, object, opt_objectToExportTo) {
  goog.exportPath_(publicPath, object, opt_objectToExportTo);
};


/**
 * Exports a property unobfuscated into the object's namespace.
 * ex. goog.exportProperty(Foo, 'staticFunction', Foo.staticFunction);
 * ex. goog.exportProperty(Foo.prototype, 'myMethod', Foo.prototype.myMethod);
 * @param {Object} object Object whose static property is being exported.
 * @param {string} publicName Unobfuscated name to export.
 * @param {*} symbol Object the name should point to.
 */
goog.exportProperty = function(object, publicName, symbol) {
  object[publicName] = symbol;
};


/**
 * Inherit the prototype methods from one constructor into another.
 *
 * Usage:
 * <pre>
 * function ParentClass(a, b) { }
 * ParentClass.prototype.foo = function(a) { };
 *
 * function ChildClass(a, b, c) {
 *   ChildClass.base(this, 'constructor', a, b);
 * }
 * goog.inherits(ChildClass, ParentClass);
 *
 * var child = new ChildClass('a', 'b', 'see');
 * child.foo(); // This works.
 * </pre>
 *
 * @param {!Function} childCtor Child class.
 * @param {!Function} parentCtor Parent class.
 */
goog.inherits = function(childCtor, parentCtor) {
  /** @constructor */
  function tempCtor() {}
  tempCtor.prototype = parentCtor.prototype;
  childCtor.superClass_ = parentCtor.prototype;
  childCtor.prototype = new tempCtor();
  /** @override */
  childCtor.prototype.constructor = childCtor;

  /**
   * Calls superclass constructor/method.
   *
   * This function is only available if you use goog.inherits to
   * express inheritance relationships between classes.
   *
   * NOTE: This is a replacement for goog.base and for superClass_
   * property defined in childCtor.
   *
   * @param {!Object} me Should always be "this".
   * @param {string} methodName The method name to call. Calling
   *     superclass constructor can be done with the special string
   *     'constructor'.
   * @param {...*} var_args The arguments to pass to superclass
   *     method/constructor.
   * @return {*} The return value of the superclass method/constructor.
   */
  childCtor.base = function(me, methodName, var_args) {
    // Copying using loop to avoid deop due to passing arguments object to
    // function. This is faster in many JS engines as of late 2014.
    var args = new Array(arguments.length - 2);
    for (var i = 2; i < arguments.length; i++) {
      args[i - 2] = arguments[i];
    }
    return parentCtor.prototype[methodName].apply(me, args);
  };
};


/**
 * Call up to the superclass.
 *
 * If this is called from a constructor, then this calls the superclass
 * constructor with arguments 1-N.
 *
 * If this is called from a prototype method, then you must pass the name of the
 * method as the second argument to this function. If you do not, you will get a
 * runtime error. This calls the superclass' method with arguments 2-N.
 *
 * This function only works if you use goog.inherits to express inheritance
 * relationships between your classes.
 *
 * This function is a compiler primitive. At compile-time, the compiler will do
 * macro expansion to remove a lot of the extra overhead that this function
 * introduces. The compiler will also enforce a lot of the assumptions that this
 * function makes, and treat it as a compiler error if you break them.
 *
 * @param {!Object} me Should always be "this".
 * @param {*=} opt_methodName The method name if calling a super method.
 * @param {...*} var_args The rest of the arguments.
 * @return {*} The return value of the superclass method.
 * @suppress {es5Strict} This method can not be used in strict mode, but
 *     all Closure Library consumers must depend on this file.
 */
goog.base = function(me, opt_methodName, var_args) {
  var caller = arguments.callee.caller;

  if (goog.STRICT_MODE_COMPATIBLE || (goog.DEBUG && !caller)) {
    throw Error(
        'arguments.caller not defined.  goog.base() cannot be used ' +
        'with strict mode code. See ' +
        'http://www.ecma-international.org/ecma-262/5.1/#sec-C');
  }

  if (caller.superClass_) {
    // Copying using loop to avoid deop due to passing arguments object to
    // function. This is faster in many JS engines as of late 2014.
    var ctorArgs = new Array(arguments.length - 1);
    for (var i = 1; i < arguments.length; i++) {
      ctorArgs[i - 1] = arguments[i];
    }
    // This is a constructor. Call the superclass constructor.
    return caller.superClass_.constructor.apply(me, ctorArgs);
  }

  // Copying using loop to avoid deop due to passing arguments object to
  // function. This is faster in many JS engines as of late 2014.
  var args = new Array(arguments.length - 2);
  for (var i = 2; i < arguments.length; i++) {
    args[i - 2] = arguments[i];
  }
  var foundCaller = false;
  for (var ctor = me.constructor; ctor;
       ctor = ctor.superClass_ && ctor.superClass_.constructor) {
    if (ctor.prototype[opt_methodName] === caller) {
      foundCaller = true;
    } else if (foundCaller) {
      return ctor.prototype[opt_methodName].apply(me, args);
    }
  }

  // If we did not find the caller in the prototype chain, then one of two
  // things happened:
  // 1) The caller is an instance method.
  // 2) This method was not called by the right caller.
  if (me[opt_methodName] === caller) {
    return me.constructor.prototype[opt_methodName].apply(me, args);
  } else {
    throw Error(
        'goog.base called from a method of one name ' +
        'to a method of a different name');
  }
};


/**
 * Allow for aliasing within scope functions.  This function exists for
 * uncompiled code - in compiled code the calls will be inlined and the aliases
 * applied.  In uncompiled code the function is simply run since the aliases as
 * written are valid JavaScript.
 *
 *
 * @param {function()} fn Function to call.  This function can contain aliases
 *     to namespaces (e.g. "var dom = goog.dom") or classes
 *     (e.g. "var Timer = goog.Timer").
 */
goog.scope = function(fn) {
  if (goog.isInModuleLoader_()) {
    throw Error('goog.scope is not supported within a goog.module.');
  }
  fn.call(goog.global);
};


/*
 * To support uncompiled, strict mode bundles that use eval to divide source
 * like so:
 *    eval('someSource;//# sourceUrl sourcefile.js');
 * We need to export the globally defined symbols "goog" and "COMPILED".
 * Exporting "goog" breaks the compiler optimizations, so we required that
 * be defined externally.
 * NOTE: We don't use goog.exportSymbol here because we don't want to trigger
 * extern generation when that compiler option is enabled.
 */
if (!COMPILED) {
  goog.global['COMPILED'] = COMPILED;
}


//==============================================================================
// goog.defineClass implementation
//==============================================================================


/**
 * Creates a restricted form of a Closure "class":
 *   - from the compiler's perspective, the instance returned from the
 *     constructor is sealed (no new properties may be added).  This enables
 *     better checks.
 *   - the compiler will rewrite this definition to a form that is optimal
 *     for type checking and optimization (initially this will be a more
 *     traditional form).
 *
 * @param {Function} superClass The superclass, Object or null.
 * @param {goog.defineClass.ClassDescriptor} def
 *     An object literal describing
 *     the class.  It may have the following properties:
 *     "constructor": the constructor function
 *     "statics": an object literal containing methods to add to the constructor
 *        as "static" methods or a function that will receive the constructor
 *        function as its only parameter to which static properties can
 *        be added.
 *     all other properties are added to the prototype.
 * @return {!Function} The class constructor.
 */
goog.defineClass = function(superClass, def) {
  // TODO(johnlenz): consider making the superClass an optional parameter.
  var constructor = def.constructor;
  var statics = def.statics;
  // Wrap the constructor prior to setting up the prototype and static methods.
  if (!constructor || constructor == Object.prototype.constructor) {
    constructor = function() {
      throw Error('cannot instantiate an interface (no constructor defined).');
    };
  }

  var cls = goog.defineClass.createSealingConstructor_(constructor, superClass);
  if (superClass) {
    goog.inherits(cls, superClass);
  }

  // Remove all the properties that should not be copied to the prototype.
  delete def.constructor;
  delete def.statics;

  goog.defineClass.applyProperties_(cls.prototype, def);
  if (statics != null) {
    if (statics instanceof Function) {
      statics(cls);
    } else {
      goog.defineClass.applyProperties_(cls, statics);
    }
  }

  return cls;
};


/**
 * @typedef {{
 *   constructor: (!Function|undefined),
 *   statics: (Object|undefined|function(Function):void)
 * }}
 */
goog.defineClass.ClassDescriptor;


/**
 * @define {boolean} Whether the instances returned by goog.defineClass should
 *     be sealed when possible.
 *
 * When sealing is disabled the constructor function will not be wrapped by
 * goog.defineClass, making it incompatible with ES6 class methods.
 */
goog.define('goog.defineClass.SEAL_CLASS_INSTANCES', goog.DEBUG);


/**
 * If goog.defineClass.SEAL_CLASS_INSTANCES is enabled and Object.seal is
 * defined, this function will wrap the constructor in a function that seals the
 * results of the provided constructor function.
 *
 * @param {!Function} ctr The constructor whose results maybe be sealed.
 * @param {Function} superClass The superclass constructor.
 * @return {!Function} The replacement constructor.
 * @private
 */
goog.defineClass.createSealingConstructor_ = function(ctr, superClass) {
  if (!goog.defineClass.SEAL_CLASS_INSTANCES) {
    // Do now wrap the constructor when sealing is disabled. Angular code
    // depends on this for injection to work properly.
    return ctr;
  }

  // Compute whether the constructor is sealable at definition time, rather
  // than when the instance is being constructed.
  var superclassSealable = !goog.defineClass.isUnsealable_(superClass);

  /**
   * @this {Object}
   * @return {?}
   */
  var wrappedCtr = function() {
    // Don't seal an instance of a subclass when it calls the constructor of
    // its super class as there is most likely still setup to do.
    var instance = ctr.apply(this, arguments) || this;
    instance[goog.UID_PROPERTY_] = instance[goog.UID_PROPERTY_];

    if (this.constructor === wrappedCtr && superclassSealable &&
        Object.seal instanceof Function) {
      Object.seal(instance);
    }
    return instance;
  };

  return wrappedCtr;
};


/**
 * @param {Function} ctr The constructor to test.
 * @return {boolean} Whether the constructor has been tagged as unsealable
 *     using goog.tagUnsealableClass.
 * @private
 */
goog.defineClass.isUnsealable_ = function(ctr) {
  return ctr && ctr.prototype &&
      ctr.prototype[goog.UNSEALABLE_CONSTRUCTOR_PROPERTY_];
};


// TODO(johnlenz): share these values with the goog.object
/**
 * The names of the fields that are defined on Object.prototype.
 * @type {!Array<string>}
 * @private
 * @const
 */
goog.defineClass.OBJECT_PROTOTYPE_FIELDS_ = [
  'constructor', 'hasOwnProperty', 'isPrototypeOf', 'propertyIsEnumerable',
  'toLocaleString', 'toString', 'valueOf'
];


// TODO(johnlenz): share this function with the goog.object
/**
 * @param {!Object} target The object to add properties to.
 * @param {!Object} source The object to copy properties from.
 * @private
 */
goog.defineClass.applyProperties_ = function(target, source) {
  // TODO(johnlenz): update this to support ES5 getters/setters

  var key;
  for (key in source) {
    if (Object.prototype.hasOwnProperty.call(source, key)) {
      target[key] = source[key];
    }
  }

  // For IE the for-in-loop does not contain any properties that are not
  // enumerable on the prototype object (for example isPrototypeOf from
  // Object.prototype) and it will also not include 'replace' on objects that
  // extend String and change 'replace' (not that it is common for anyone to
  // extend anything except Object).
  for (var i = 0; i < goog.defineClass.OBJECT_PROTOTYPE_FIELDS_.length; i++) {
    key = goog.defineClass.OBJECT_PROTOTYPE_FIELDS_[i];
    if (Object.prototype.hasOwnProperty.call(source, key)) {
      target[key] = source[key];
    }
  }
};


/**
 * Sealing classes breaks the older idiom of assigning properties on the
 * prototype rather than in the constructor. As such, goog.defineClass
 * must not seal subclasses of these old-style classes until they are fixed.
 * Until then, this marks a class as "broken", instructing defineClass
 * not to seal subclasses.
 * @param {!Function} ctr The legacy constructor to tag as unsealable.
 */
goog.tagUnsealableClass = function(ctr) {
  if (!COMPILED && goog.defineClass.SEAL_CLASS_INSTANCES) {
    ctr.prototype[goog.UNSEALABLE_CONSTRUCTOR_PROPERTY_] = true;
  }
};


/**
 * Name for unsealable tag property.
 * @const @private {string}
 */
goog.UNSEALABLE_CONSTRUCTOR_PROPERTY_ = 'goog_defineClass_legacy_unsealable';


/**
 * Returns a newly created map from language mode string to a boolean
 * indicating whether transpilation should be done for that mode.
 *
 * Guaranteed invariant:
 * For any two modes, l1 and l2 where l2 is a newer mode than l1,
 * `map[l1] == true` implies that `map[l2] == true`.
 * @private
 * @return {!Object<string, boolean>}
 */
goog.createRequiresTranspilation_ = function() {
  var /** !Object<string, boolean> */ requiresTranspilation = {'es3': false};
  var transpilationRequiredForAllLaterModes = false;

  /**
   * Adds an entry to requiresTranspliation for the given language mode.
   *
   * IMPORTANT: Calls must be made in order from oldest to newest language
   * mode.
   * @param {string} modeName
   * @param {function(): boolean} isSupported Returns true if the JS engine
   *     supports the given mode.
   */
  function addNewerLanguageTranspilationCheck(modeName, isSupported) {
    if (transpilationRequiredForAllLaterModes) {
      requiresTranspilation[modeName] = true;
    } else if (isSupported()) {
      requiresTranspilation[modeName] = false;
    } else {
      requiresTranspilation[modeName] = true;
      transpilationRequiredForAllLaterModes = true;
    }
  }

  /**
   * Does the given code evaluate without syntax errors and return a truthy
   * result?
   */
  function /** boolean */ evalCheck(/** string */ code) {
    try {
      return !!eval(code);
    } catch (ignored) {
      return false;
    }
  }

  // Identify ES3-only browsers by their incorrect treatment of commas.
  addNewerLanguageTranspilationCheck('es5', function() {
    return evalCheck('[1,].length==1');
  });
  addNewerLanguageTranspilationCheck('es6', function() {
    // Test es6: [FF50 (?), Edge 14 (?), Chrome 50]
    //   (a) default params (specifically shadowing locals),
    //   (b) destructuring, (c) block-scoped functions,
    //   (d) for-of (const), (e) new.target/Reflect.construct
    var es6fullTest =
        'class X{constructor(){if(new.target!=String)throw 1;this.x=42}}' +
        'let q=Reflect.construct(X,[],String);if(q.x!=42||!(q instanceof ' +
        'String))throw 1;for(const a of[2,3]){if(a==2)continue;function ' +
        'f(z={a}){let a=0;return z.a}{function f(){return 0;}}return f()' +
        '==3}';

    return evalCheck('(()=>{"use strict";' + es6fullTest + '})()');
  });
  // TODO(joeltine): Remove es6-impl references for b/31340605.
  // Consider es6-impl (widely-implemented es6 features) to be supported
  // whenever es6 is supported. Technically es6-impl is a lower level of
  // support than es6, but we don't have tests specifically for it.
  addNewerLanguageTranspilationCheck('es6-impl', function() {
    return true;
  });
  // ** and **= are the only new features in 'es7'
  addNewerLanguageTranspilationCheck('es7', function() {
    return evalCheck('2 ** 2 == 4');
  });
  // async functions are the only new features in 'es8'
  addNewerLanguageTranspilationCheck('es8', function() {
    return evalCheck('async () => 1, true');
  });
  return requiresTranspilation;
};

// Input 1
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/26/2015
 * Time: 9:45 AM
 */

goog.provide('epiviz.deferred.Promise');

goog.require('epiviz.deferred.Deferred');

/**
 * Wrapper around JQuery Promise
 * @param {Promise} promise
 * @constructor
 * @template T The type of result
 */
epiviz.deferred.Promise = function(promise) {
  /**
   * @type {Promise}
   * @private
   */
  this._promise = promise;
};

/**
 * @param {function(T)} doneFilter
 * @param {function} [failFilter]
 * @param {function} [progressFilter]
 * @returns {epiviz.deferred.Promise.<T>}
 */
epiviz.deferred.Promise.prototype.then = function(doneFilter, failFilter, progressFilter) {
  return new epiviz.deferred.Promise(this._promise.then(doneFilter, failFilter, progressFilter));
};

/**
 * @param {function(T)|Array.<function(T)>} doneCallbacks
 * @param {function(T)|Array.<function(T)>} [moreDoneCallbacks]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Promise.prototype.done = function(doneCallbacks, moreDoneCallbacks) {
  return new epiviz.deferred.Deferred(this._promise.done(doneCallbacks, moreDoneCallbacks));
};

/**
 * @param {function|Array.<function>} failCallbacks
 * @param {function|Array.<function>} [moreFailCallbacks]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Promise.prototype.fail = function(failCallbacks, moreFailCallbacks) {
  return new epiviz.deferred.Deferred(this._promise.fail(failCallbacks, moreFailCallbacks));
};

/**
 * @param {function|Array.<function>} alwaysCallbacks
 * @param {function|Array.<function>} [moreAlwaysCallbacks]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Promise.prototype.always = function(alwaysCallbacks, moreAlwaysCallbacks) {
  return new epiviz.deferred.Deferred(this._promise.always(alwaysCallbacks, moreAlwaysCallbacks));
};

/**
 * @returns {string}
 */
epiviz.deferred.Promise.prototype.state = function() {
  return this._promise.state();
};

// Input 2
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/26/2015
 * Time: 9:41 AM
 */

goog.provide('epiviz.deferred.Deferred');

goog.require('epiviz.deferred.Promise');

/**
 * Wrapper around JQuery Deferred
 * @param {Deferred} [deferred]
 * @constructor
 * @template T
 */
epiviz.deferred.Deferred = function(deferred) {
  /**
   * @type {Deferred}
   * @private
   */
  this._deferred = deferred || $.Deferred();
};

/**
 * @enum {string}
 */
epiviz.deferred.Deferred.State = {
  PENDING: 'pending',
  RESOLVED: 'resolved',
  REJECTED: 'rejected'
};

/**
 * @param {function(T)} doneFilter
 * @param {function} [failFilter]
 * @param {function} [progressFilter]
 * @returns {epiviz.deferred.Promise.<T>}
 */
epiviz.deferred.Deferred.prototype.then = function(doneFilter, failFilter, progressFilter) {
  return new epiviz.deferred.Promise(this._deferred.then(doneFilter, failFilter, progressFilter));
};

/**
 * @param {function(T)|Array.<function(T)>} doneCallbacks
 * @param {function(T)|Array.<function(T)>} [moreDoneCallbacks]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.done = function(doneCallbacks, moreDoneCallbacks) {
  return new epiviz.deferred.Deferred(this._deferred.done(doneCallbacks, moreDoneCallbacks));
};

/**
 * @param {function|Array.<function>} failCallbacks
 * @param {function|Array.<function>} [moreFailCallbacks]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.fail = function(failCallbacks, moreFailCallbacks) {
  return new epiviz.deferred.Deferred(this._deferred.fail(failCallbacks, moreFailCallbacks));
};

/**
 * @param {function|Array.<function>} alwaysCallbacks
 * @param {function|Array.<function>} [moreAlwaysCallbacks]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.always = function(alwaysCallbacks, moreAlwaysCallbacks) {
  return new epiviz.deferred.Deferred(this._deferred.always(alwaysCallbacks, moreAlwaysCallbacks));
};

/**
 * @returns {string}
 */
epiviz.deferred.Deferred.prototype.state = function() {
  return this._deferred.state();
};

/**
 * @param {Object} [args]
 * @retuns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.notify = function(args) {
  return new epiviz.deferred.Deferred(this._deferred.notify(args));
};

/**
 * @param {Object} context
 * @param {Array} [args]
 * @retuns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.notifyWith = function(context, args) {
  return new epiviz.deferred.Deferred(this._deferred.notifyWith(context, args));
};

/**
 * @param {function|Array.<function>} progressCallbacks
 * @param {function|Array.<function>} [moreProgressCallbacks]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.progress = function(progressCallbacks, moreProgressCallbacks) {
  return new epiviz.deferred.Deferred(this._deferred.progress(progressCallbacks, moreProgressCallbacks));
};

/**
 * @param {Object} [target]
 * @returns {epiviz.deferred.Promise.<T>}
 */
epiviz.deferred.Deferred.prototype.promise = function(target) {
  return new epiviz.deferred.Promise(this._deferred.promise(target));
};

/**
 * @param {*} [args]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.reject = function(args) {
  return new epiviz.deferred.Deferred(this._deferred.reject(args));
};

/**
 * @param {Object} context
 * @param {Array} [args]
 * @retuns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.rejectWith = function(context, args) {
  return new epiviz.deferred.Deferred(this._deferred.rejectWith(context, args));
};

/**
 * @param {*} [args]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.resolve = function(args) {
  return new epiviz.deferred.Deferred(this._deferred.resolve(args));
};

/**
 * @param {Object} context
 * @param {Array} [args]
 * @retuns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.resolveWith = function(context, args) {
  return new epiviz.deferred.Deferred(this._deferred.resolveWith(context, args));
};

// Input 3
/**
 * Created by: Florin Chelaru
 * Date: 10/4/13
 * Time: 11:19 AM
 */

goog.provide('epiviz.utils');
// goog.provide('epiviz.utils.capitalizeFirstLetter');
// goog.provide('epiviz.utils.fillArray');
// goog.provide('epiviz.utils.mapCopy');
// goog.provide('epiviz.utils.evaluateFullyQualifiedTypeName');
// goog.provide('epiviz.utils.generatePseudoGUID');
// goog.provide('epiviz.utils.stringContains');
// goog.provide('epiviz.utils.stringStartsWith');
// goog.provide('epiviz.utils.stringEndsWith');
// goog.provide('epiviz.utils.indexOf');
// goog.provide('epiviz.utils.arraysEqual');
// goog.provide('epiviz.utils.elementsEqual');
// goog.provide('epiviz.utils.range');
// goog.provide('epiviz.utils.arrayAppend');
// goog.provide('epiviz.utils.arrayFlip');
// goog.provide('epiviz.utils.indexOfMin');
// goog.provide('epiviz.utils.arrayIntersection');
// goog.provide('epiviz.utils.asyncFor');
// goog.provide('epiviz.utils.deferredFor');
// goog.provide('epiviz.utils.mapEquals');
// goog.provide('epiviz.utils.mapCombine');
// goog.provide('epiviz.utils.mapJoin');
// goog.provide('epiviz.utils.mapKeyIntersection');
// goog.provide('epiviz.utils.forEach');
// goog.provide('epiviz.utils.applyConstructor');
// goog.provide('epiviz.utils.getInternetExplorerVersion');
// goog.provide('epiviz.utils.colorize');
// goog.provide('epiviz.utils.colorizeBinary');
// goog.provide('epiviz.utils.sign');

goog.require('epiviz.deferred.Deferred');


epiviz.utils = function() {};

// String

/**
 * @param {string} str
 * @returns {string}
 */
epiviz.utils.capitalizeFirstLetter = function(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
};

/**
 * @param {string} str
 * @param {string} substr
 * @returns {boolean}
 */
epiviz.utils.stringContains = function(str, substr) {
  return str.indexOf(substr) != -1;
};

/**
 * @param {string} str
 * @param {string} prefix
 * @returns {boolean}
 */
epiviz.utils.stringStartsWith = function(str, prefix) {
  return str.indexOf(prefix) == 0;
};

/**
 * @param {string} str
 * @param {string} suffix
 * @returns {boolean}
 */
epiviz.utils.stringEndsWith = function(str, suffix) {
  return str.lastIndexOf(suffix) == str.length - suffix.length;
};

// Array

/**
 * Creates an array of length n filled with value
 * @param {number} n
 * @param {T} value
 * @returns {Array.<T>}
 * @template T
 */
epiviz.utils.fillArray = function(n, value) {
  n = n || 0;
  var result = new Array(n);
  for (var i = 0; i < n; ++i) {
    result[i] = value;
  }
  return result;
};

/**
 * @param {Array.<T>} arr
 * @param {function(T): boolean} predicate
 * @returns {number}
 * @template T
 */
epiviz.utils.indexOf = function(arr, predicate) {
  for (var i = 0; i < arr.length; ++i) {
    if (predicate(arr[i])) { return i; }
  }
  return -1;
};

/**
 * @param {Array} arr1
 * @param {Array} arr2
 * @returns {boolean}
 */
epiviz.utils.arraysEqual = function(arr1, arr2) {
  if (arr1 == arr2) { return true; }

  if (!arr1 || !arr2) { return false; }

  if (arr1.length != arr2.length) { return false; }

  if (arr1 < arr2 || arr2 < arr1) { return false; }

  // The previous check doesn't work when the elements of the array are complex objects
  for (var i = 0; i < arr1.length; ++i) {
    if (arr1[i] != arr2[i]) { return false; }
  }
  return true;
};

/**
 * Compares the two given arrays ignoring the order of their elements;
 * for example [1, 2, 1, 3] and [2, 1, 1, 3] will be considered equal.
 * @param {Array.<string|number>} arr1
 * @param {Array.<string|number>} arr2
 * @returns {boolean}
 */
epiviz.utils.elementsEqual = function(arr1, arr2) {
  if (arr1 == arr2) { return true; }

  if (!arr1 || !arr2) { return false; }

  if (arr1.length != arr2.length) { return false; }

  var valueMap = {};

  var i;
  for (i = 0; i < arr1.length; ++i) {
    if (!(arr1[i] in valueMap)) { valueMap[arr1[i]] = 0; }
    ++valueMap[arr1[i]];
  }

  for (i = 0; i < arr2.length; ++i) {
    if (!valueMap[arr2[i]]) { return false; }
    --valueMap[arr2[i]];
  }

  return true;
};

/**
 * Generates an array of consecutive numbers starting from startIndex
 * (or 0 if it's not defined)
 * @param {number} n
 * @param {number} [startIndex]
 */
epiviz.utils.range = function(n, startIndex) {
  startIndex = startIndex || 0;
  n = n || 0;

  var result = new Array(n);
  for (var i = 0; i < n; ++i) {
    result[i] = i + startIndex;
  }

  return result;
};

/**
 * Append an array to another in place
 * @param {Array} self
 * @param {Array} arr
 */
epiviz.utils.arrayAppend = function(self, arr) {
  self.push.apply(self, arr);
};

/**
 * @param {Array.<string|number>} arr
 * @returns {Object.<string|number, number>}
 */
epiviz.utils.arrayFlip = function(arr) {
  var result = {};
  for (var i = 0; i < arr.length; ++i) {
    result[arr[i]] = i;
  }

  return result;
};

/**
 * Gets the minimum value in the matrix, along with the i, j indices where this value is located
 * @param {Array.<Array.<number>>} matrix
 * @param {boolean} [isSymmetrical]
 * @returns {{min: number, index: Array}}
 */
epiviz.utils.indexOfMin = function(matrix, isSymmetrical) {
  var ret = null;
  var min = null;
  for (var i = 0; i < matrix.length; ++i) {
    for (var j = isSymmetrical ? (i + 1) : 0; j < matrix[i].length; ++j) {
      if (min == null || matrix[i][j] < min) {
        min = matrix[i][j];
        ret = [i, j];
      }
    }
  }

  return {min: min, index: ret};
};

/**
 * @param {Array.<number|string>} arr1
 * @param {Array.<number|string>} arr2
 * @returns {Array.<number|string>}
 */
epiviz.utils.arrayIntersection = function(arr1, arr2) {
  var arr1Map = {};
  arr1.forEach(function(e) { arr1Map[e] = e; });

  var ret = [];
  arr2.forEach(function(e) { if (e in arr1Map) { ret.push(e); }});

  return ret;
};

/**
 * @param {number} n
 * @param {function(number, function(boolean))} iterationCallback The callback parameter will be true if should break
 * @param {function} finishedCallback
 */
epiviz.utils.asyncFor = function(n, iterationCallback, finishedCallback) {
  if (!n) {
    if (finishedCallback) { finishedCallback(); }
    return;
  }

  var iteration = function(i) {
    if (i >= n) {
      if (finishedCallback) { finishedCallback(); }
      return;
    }

    iterationCallback(i, function(result) {
      if (result) {
        if (finishedCallback) { finishedCallback(); }
      }
      else {
        iteration(i + 1);
      }
    });
  };

  iteration(0);
};

/**
 * @param {number} n
 * @param {function(number): epiviz.deferred.Deferred} deferredIteration
 * @returns {epiviz.deferred.Deferred}
 */
epiviz.utils.deferredFor = function(n, deferredIteration) {
  var initial = new epiviz.deferred.Deferred();
  var ret = new epiviz.deferred.Deferred();
  var p = initial.promise();
  for (var i = 0; i < n; ++i) {
    (function(i) {
      p = p.then(function () {
        var promise = deferredIteration(i);
        if (i == n - 1) {
          promise.then(function () { ret.resolve(); });
        }
        return promise;
      });
    })(i);
  }

  initial.resolve();
  return ret;
};

// Object (Hashtable)

/**
 * Creates a copy of the given map
 * @param {Object.<K, V>} map
 * @returns {Object.<K, V>}
 * @template K, V
 */
epiviz.utils.mapCopy = function(map) {
  var result = {};
  for (var key in map) {
    if (!map.hasOwnProperty(key)) { continue; }
    result[key] = map[key];
  }

  return result;
};

/**
 * @param {Object.<K, V>} m1
 * @param {Object.<K, V>} m2
 * @returns {boolean}
 * @template K, V
 */
epiviz.utils.mapEquals = function(m1, m2) {
  if (m1 == m2) { return true; }
  if (!m1 || !m2) { return false; }

  var k;
  for (k in m1) {
    if (!m1.hasOwnProperty(k)) { continue; }
    if (!m2.hasOwnProperty(k)) { return false; }
    if (m1[k] != m2[k]) { return false; }
  }

  for (k in m2) {
    if (!m2.hasOwnProperty(k)) { continue; }
    if (!m1.hasOwnProperty(k)) { return false; }
  }

  return true;
};

/**
 * Creates a new map that contains the keys of both m1 and m2.
 * If one key is in both maps, then the value from m1 will be used.
 * @param {Object<*,*>} m1
 * @param {Object<*,*>} m2
 * @param {boolean} [combineArrayVals] specifies that array values should also be combined
 * @returns {Object<*,*>}
 */
epiviz.utils.mapCombine = function(m1, m2, combineArrayVals) {
  var result = {};

  var key;

  if (m2) {
    for (key in m2) {
      if (!m2.hasOwnProperty(key)) { continue; }
      result[key] = m2[key];
    }
  }

  if (m1) {
    for (key in m1) {
      if (!m1.hasOwnProperty(key)) { continue; }
      if (combineArrayVals &&
        result[key] && $.isArray(result[key]) &&
        m1[key] && $.isArray(m1[key])) {
        result[key] = result[key].concat(m1[key]);
      } else {
        result[key] = m1[key];
      }
    }
  }

  return result;
};

/**
 * @param {Object.<*, *>} map
 * @param {string} [keyValueSep] Default: ':'
 * @param {string} [separator] Default: ','
 */
epiviz.utils.mapJoin = function(map, keyValueSep, separator) {
  if (!keyValueSep && keyValueSep !== '') { keyValueSep = ':'; }
  if (!separator && separator !== '') { separator = ','; }
  var result = '';
  for (var key in map) {
    if (!map.hasOwnProperty(key)) { continue; }
    if (result) { result += separator; }
    result += key + keyValueSep + map[key];
  }

  return result;
};

/**
 * Gets the keys that are in both maps
 * @param {Object.<*, *>} m1
 * @param {Object.<*, *>} m2
 * @returns {Array.<*>}
 */
epiviz.utils.mapKeyIntersection = function(m1, m2) {
  var result = [];

  if (!m1 || !m2) { return result; }

  for (var key in m1) {
    if (!m1.hasOwnProperty(key)) { continue; }
    if (key in m2) { result.push(key); }
  }

  return result;
};

/**
 * Loops through all the elements of an object or until callback returns something that evaluates to true
 * @param {Object.<string|number, T>} obj
 * @param {function(T=, string|number=, Object.<string|number, T>=)} callback
 * @template T
 */
epiviz.utils.forEach = function(obj, callback) {
  for (var key in obj) {
    if (!obj.hasOwnProperty(key)) { continue; }
    if (callback(obj[key], key, obj)) { break; }
  }
};

// Reflection

/**
 * Evaluates the given string into a constructor for a type
 * @param {string} typeName
 * @returns {?function(new: T)}
 * @template T
 */
epiviz.utils.evaluateFullyQualifiedTypeName = function(typeName) {
  try {
    var namespaces = typeName.split('.');
    var func = namespaces.pop();
    var context = window;
    for (var i = 0; i < namespaces.length; ++i) {
      context = context[namespaces[i]];
    }

    var result = context[func];
    if (typeof(result) !== 'function') {
      console.error('Unknown type name: ' + typeName);
      return null;
    }

    return result;
  } catch (error) {
    console.error('Unknown type name: ' + typeName);
    return null;
  }
};

/**
 * Applies the given constructor to the given parameters and creates
 * a new instance of the class it defines
 * @param {function(new: T)} ctor
 * @param {Array} params
 * @returns {T}
 * @template T
 */
epiviz.utils.applyConstructor = function(ctor, params) {
  var obj;

  // Use a fake constructor function with the target constructor's
  // `prototype` property to create the object with the right prototype
  var fakeCtor = function() {};
  fakeCtor.prototype = ctor.prototype;

  /** @type {T} */
  obj = new fakeCtor();

  // Set the object's `constructor`
  obj.constructor = ctor;

  // Call the constructor function
  ctor.apply(obj, params);

  return obj;
};

// Misc

/**
 * @const
 * @type {number}
 */
epiviz.utils.RAD_TO_DEG = 180 / Math.PI;

/**
 * @const
 * @type {number}
 */
epiviz.utils.DEG_TO_RAD = Math.PI / 180;

/**
 * @returns {number} The version of Internet Explorer or -1 (indicating the use of another browser).
 */
epiviz.utils.getInternetExplorerVersion = function() {
  var rv = -1; // Return value assumes failure.
  if (navigator.appName == 'Microsoft Internet Explorer') {
    var ua = navigator.userAgent;
    var re  = new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");
    var match = re.exec(ua);
    if (match != null)
      rv = parseFloat(match[1]);
  }
  return rv;
};

/**
 * @param {number} size
 * @returns {string}
 */
epiviz.utils.generatePseudoGUID = function(size) {
  var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
  var result = '';

  for (var i = 0; i < size; ++i) {
    result += chars[Math.round(Math.random() * (chars.length - 1))];
  }

  return result;
};

/**
 * This function will take a set of 3 "increasing" colors and
 * return a color scale that fills in intensities between the
 * colors. For use in turning each column of the observation
 * matrix into a heatmap.
 * @param {number} min
 * @param {number} max
 * @param {number} median
 * @param {string} colorMin
 * @param {string} colorMax
 * @param {string} colorMedian
 * @returns {function(number): string} A function that takes in a number and returns a color
 */
epiviz.utils.colorize = function(min, max, median, colorMin, colorMax, colorMedian){
  return d3.scale.linear()
    .domain([min, median, max])
    .range([colorMin, colorMedian, colorMax]);
};

/**
 * @param {number} min
 * @param {number} max
 * @param {string} colorMin
 * @param {string} colorMax
 * @returns {function(number): string}
 */
epiviz.utils.colorizeBinary = function(min, max, colorMin, colorMax){
  return d3.scale.linear()
    .domain([min, max])
    .range([colorMin, colorMax]);
};

// Math

/**
 * @param {number} val
 * @returns {number}
 */
epiviz.utils.sign = function(val) { return val < 0 ? -1 : (val == 0 ? 0 : 1); };

// Input 4
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 8:49 PM
 */

goog.provide('epiviz.events.EventListener');

/**
 * @param {function(T=)} updateCallback
 * @constructor
 * @template T
 */
epiviz.events.EventListener = function(updateCallback) {
  /**
   * @type {number}
   * @private
   */
  this._id = epiviz.events.EventListener._nextId++;

  /**
   * @type {function(T)}
   * @private
   */
  this._updateCallback = updateCallback;
};

epiviz.events.EventListener._nextId = 0;

/**
 * @param {T} [args]
 */
epiviz.events.EventListener.prototype.update = function(args) {
  this._updateCallback(args);
};

/**
 * @returns {number}
 */
epiviz.events.EventListener.prototype.id = function() {
  return this._id;
};

// Input 5
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/18/14
 * Time: 10:17 PM
 */

goog.provide('epiviz.ui.WebArgsManager');

goog.require('epiviz.utils');
goog.require('epiviz.events.EventListener');

/**
 * @param {epiviz.ui.LocationManager} locationManager
 * @param {epiviz.workspaces.WorkspaceManager} workspaceManager
 * @constructor
 */
epiviz.ui.WebArgsManager = function(locationManager, workspaceManager) {
  /**
   * @type {epiviz.ui.LocationManager}
   * @private
   */
  this._locationManager = locationManager;

  /**
   * @type {epiviz.workspaces.WorkspaceManager}
   * @private
   */
  this._workspaceManager = workspaceManager;

  this._registerLocationChanged();
  this._registerActiveWorkspaceChanged();
};

/**
 * @type {Object.<string, *>}
 */
epiviz.ui.WebArgsManager.WEB_ARGS = epiviz.ui.WebArgsManager.WEB_ARGS || {};

/**
 * @returns {Object.<string, string|Array.<string>>}
 */
epiviz.ui.WebArgsManager.extractWindowLocationArgs = function() {
  var argsStr = window.location.search.length > 0 ? window.location.search.substr(1) : '';
  var argPairs = argsStr.split('&');

  var args = {};
  argPairs.forEach(function(pair, i) {
    if (pair.trim().length == 0) { return; }
    var arrInd = pair.indexOf('[]');
    if (arrInd == 0) { return; }

    var arg, val;
    var eqInd = pair.indexOf('=');
    if (eqInd < 0) {
      arg = (arrInd < 0) ? pair : pair.substr(0, arrInd);
      val = 'true';
    } else {
      arg = (arrInd < 0) ? pair.substr(0, eqInd) : pair.substr(0, arrInd);
      val = pair.substr(eqInd + 1);
    }

    arg = decodeURIComponent(arg);
    val = decodeURIComponent(val);

    if (arrInd < 0) { args[arg] = val; }
    else {
      if (!(arg in args)) { args[arg] = []; }
      args[arg].push(val);
    }
  });

  return args;
};

/**
 * @private
 */
epiviz.ui.WebArgsManager.prototype._updateUrl = function() {
  var url = '?';
  var args = epiviz.ui.WebArgsManager.WEB_ARGS;

  // 'ws' and 'workspace' are arguments for the same functionality
  // (the latter is kept for backward compatibility)
  if (!('ws' in args) && 'workspace' in args) {
    args['ws'] = args['workspace'];
    delete args['workspace'];
  }

  for (var arg in args) {
    if (!args.hasOwnProperty(arg)) { continue; }

    if (Array.isArray(args[arg])) {
      var val;
      for (var i = 0; i < args[arg].length; ++i) {
        val = args[arg][i];
        if (val == undefined) { val = 'undefined'; }
        url += sprintf('%s[]=%s&', arg, val);
      }
    } else {
      val = args[arg];
      if (val == undefined) { val = 'undefined'; }
      url += sprintf('%s=%s&', arg, val);
    }
  }

  // IE versions before 10 don't support the history API
  var ie = epiviz.utils.getInternetExplorerVersion();
  if (ie < 0 || ie >= 10) {
    switch(window.location.protocol) {
      case 'http:':
      case 'https:':
        //remote file over http or https
        history.replaceState(null, '', url);
        break;
      case 'file:':
        //local file
        break;
      default:
      //some other protocol
    }
  }
};

/**
 * @private
 */
epiviz.ui.WebArgsManager.prototype._registerLocationChanged = function() {
  var self = this;
  this._locationManager.onCurrentLocationChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {{oldValue: epiviz.datatypes.GenomicRange, newValue: epiviz.datatypes.GenomicRange}} e
     */
    function(e) {
      epiviz.ui.WebArgsManager.WEB_ARGS['seqName'] = e.newValue.seqName();
      epiviz.ui.WebArgsManager.WEB_ARGS['start'] = e.newValue.start();
      epiviz.ui.WebArgsManager.WEB_ARGS['end'] = e.newValue.end();

      self._updateUrl();
    }));
};

/**
 * @private
 */
epiviz.ui.WebArgsManager.prototype._registerActiveWorkspaceChanged = function() {
  var self = this;
  this._workspaceManager.onActiveWorkspaceChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {{oldValue: epiviz.workspaces.Workspace, newValue: epiviz.workspaces.Workspace, workspaceId: string}} e
     */
    function(e) {
      epiviz.ui.WebArgsManager.WEB_ARGS['ws'] = e.workspaceId || '';
      delete epiviz.ui.WebArgsManager.WEB_ARGS['workspace'];

      self._updateUrl();
    }
  ));
};

// Input 6
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 8:42 PM
 */

goog.provide('epiviz.events.Event');

/**
 * @constructor
 * @template T
 */
epiviz.events.Event = function() {
  /**
   * @type {number}
   * @private
   */
  this._count = 0;

  /**
   * @type {Object.<number, epiviz.events.EventListener.<T>>}
   * @private
   */
  this._listeners = {};

  /**
   * Set to true when in the notify() method, to avoid loops
   * @type {boolean}
   * @private
   */
  this._firing = false;
};

/**
 * @param {epiviz.events.EventListener.<T>} listener
 */
epiviz.events.Event.prototype.addListener = function(listener) {
  if (!this._listeners[listener.id()]) { ++this._count; }

  this._listeners[listener.id()] = listener;
};

/**
 * @param {epiviz.events.EventListener.<T>} listener
 */
epiviz.events.Event.prototype.removeListener = function(listener) {
  if (!this._listeners[listener.id()]) { return; }

  delete this._listeners[listener.id()];
  --this._count;
};

/**
 * @param {T} [args]
 */
epiviz.events.Event.prototype.notify = function(args) {
  if (this._firing) { return; }

  if (this._count == 0) { return; }

  this._firing = true;

  for (var id in this._listeners) {
    if (!this._listeners.hasOwnProperty(id)) { continue; }
    this._listeners[id].update(args);
  }

  this._firing = false;
};

/**
 * Returns true if the event is already firing
 * @returns {boolean}
 */
epiviz.events.Event.prototype.isFiring = function() { return this._firing; };

// Input 7
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/15/14
 * Time: 1:50 PM
 */

goog.provide('epiviz.data.MessageType');

/**
 * @enum {string}
 */
epiviz.data.MessageType = {
  REQUEST: 'request',
  RESPONSE: 'response'
};

// Input 8
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 8:36 PM
 */

goog.provide('epiviz.data.Response');

goog.require('epiviz.data.MessageType');

/**
 * @param {number} requestId
 * @param {T} data
 * @constructor
 * @template T
 */
epiviz.data.Response = function(requestId, data) {
  /**
   * @type {number}
   * @private
   */
  this._id = requestId;

  /**
   * @type {T}
   * @private
   */
  this._data = data;
};

/**
 * @returns {number}
 */
epiviz.data.Response.prototype.id = function() { return this._id; };

/**
 * @returns {T}
 */
epiviz.data.Response.prototype.data = function() {

  var data = this._data;

  // for getMeasurements and getSeqInfo response!
  var all_keys = Object.keys(data);
  if(all_keys.length > 0) {
    if (all_keys.indexOf('success') != -1) {
      all_keys.splice(all_keys.indexOf('success'), 1);
      delete data['success'];
      //for SeqInfo response
/*      if(all_keys.indexOf("") != -1) {
        return data[all_keys[0]];
      }*/
    }
  }
  return data;
};

/**
 * @returns {epiviz.data.MessageType}
 */
epiviz.data.Response.prototype.type = function() { return epiviz.data.MessageType.RESPONSE; };

/**
 * @returns {{requestId: number, type: epiviz.data.MessageType, data: T}}
 */
epiviz.data.Response.prototype.raw = function() {
  return {
    requestId: this._id,
    type: this.type(),
    data: this._data
  };
};

/**
 * @param {{requestId: number, data: T}} o
 * @constructor
 * @template T
 * @returns {epiviz.data.Response.<T>}
 */
epiviz.data.Response.fromRawObject = function(o) {
  return new epiviz.data.Response(o.requestId, o.data);
};

// Input 9
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 8:28 PM
 */

goog.provide('epiviz.data.DataProvider');

goog.require('epiviz.events.Event');
goog.require('epiviz.data.Response');

/**
 * @param {string} id
 * @constructor
 */
epiviz.data.DataProvider = function(id) {
  /**
   * @type {string}
   * @private
   */
  this._id = id;

  /**
   * seqInfos: an array of raw seqInfos, which consist of 3-element arrays: name, min and max
   * @type {epiviz.events.Event.<{seqInfos: Array.<Array>, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestAddSeqInfos = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{seqNames: Array.<string>, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRemoveSeqNames = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestAddMeasurements = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRemoveMeasurements = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{type: string, visConfigSelection: epiviz.ui.controls.VisConfigSelection, result: epiviz.events.EventResult.<{id: string}>}>}
   * @private
   */
  this._requestAddChart = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRemoveChart = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestFlushCache = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{datasourceGroup: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestClearDatasourceGroupCache = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{range: epiviz.datatypes.GenomicRange, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestNavigate = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRedraw = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestCurrentLocation = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestPrintWorkspace = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestSetChartSettings = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestGetChartSettings = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestGetAvailableCharts = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestLoadWorkspace = new epiviz.events.Event();

};

/**
 * @returns {string}
 */
epiviz.data.DataProvider.prototype.id = function() { return this._id; };

/**
 * @param {epiviz.data.Request} request
 * @param {function(epiviz.data.Response<*>)} callback
 */
epiviz.data.DataProvider.prototype.getData = function(request, callback) {
  callback(epiviz.data.Response.fromRawObject({
    requestId: request.id(),
    data: null
  }));
};

/**
 * seqInfos: an array of raw seqInfos, which consist of 3-element arrays: name, min and max
 * @returns {epiviz.events.Event.<{seqInfos: Array.<Array>, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestAddSeqInfos = function() { return this._requestAddSeqInfos; };

/**
 * @returns {epiviz.events.Event.<{seqNames: Array.<string>, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestRemoveSeqNames = function() { return this._requestRemoveSeqNames; };

/**
 * Fired whenever the data provider requests the UI to add new measurements
 * @returns {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestAddMeasurements = function() { return this._requestAddMeasurements; };

/**
 * Fired whenever the data provider requests the UI to remove measurements
 * @returns {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestRemoveMeasurements = function() { return this._requestRemoveMeasurements; };

/**
 * The type argument is a string denoting the complete class name of the chart to be used.
 * For example: 'epiviz.plugins.charts.BlocksTrack'.
 * @returns {epiviz.events.Event.<{type: string, visConfigSelection: epiviz.ui.controls.VisConfigSelection, result: epiviz.events.EventResult.<{id: string}>}>}
 */
epiviz.data.DataProvider.prototype.onRequestAddChart = function() { return this._requestAddChart; };

/**
 * @returns {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestRemoveChart = function() { return this._requestRemoveChart; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestFlushCache = function() { return this._requestFlushCache; };

/**
 * @returns {epiviz.events.Event.<{datasourceGroup: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestClearDatasourceGroupCache = function() { return this._requestClearDatasourceGroupCache; };

/**
 * @returns {epiviz.events.Event.<{range: epiviz.datatypes.GenomicRange, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestNavigate = function() { return this._requestNavigate; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestRedraw = function() { return this._requestRedraw; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestCurrentLocation = function() { return this._requestCurrentLocation; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestPrintWorkspace = function() { return this._requestPrintWorkspace; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestGetChartSettings = function() { return this._requestGetChartSettings; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestSetChartSettings = function() { return this._requestSetChartSettings; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestGetAvailableCharts = function() { return this._requestGetAvailableCharts; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestLoadWorkspace = function() { return this._requestLoadWorkspace; };

// Input 10
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 8:35 PM
 */

goog.provide('epiviz.data.Request');

goog.require('epiviz.data.MessageType');
goog.require('epiviz.utils');

/**
 * @param {number} id
 * @param {Object.<string, string>} args
 * @param {epiviz.data.Request.Method} [method]
 * @constructor
 */
epiviz.data.Request = function(id, args, method) {
  /**
   * @type {number}
   * @private
   */
  this._id = id;

  /**
   * @type {Object.<string, string>}
   * @private
   */
  this._args = args;

  /**
   * @type {epiviz.data.Request.Method}
   * @private
   */
  this._method = method;
};

/**
 * @enum {string}
 */
epiviz.data.Request.Method = {
  GET: 'get',
  POST: 'post'
};

/**
 * @enum {string}
 */
epiviz.data.Request.Action = {
  // Server actions
  GET_ROWS: 'getRows',
  GET_VALUES: 'getValues',
  GET_COMBINED: 'getCombined',
  GET_MEASUREMENTS: 'getMeasurements',
  SEARCH: 'search',
  GET_SEQINFOS: 'getSeqInfos',
  SAVE_WORKSPACE: 'saveWorkspace',
  DELETE_WORKSPACE: 'deleteWorkspace',
  GET_WORKSPACES: 'getWorkspaces',

  GET_HIERARCHY: 'getHierarchy',
  PROPAGATE_HIERARCHY_CHANGES: 'propagateHierarchyChanges',

  GET_PCA: 'getPCA',
  GET_DIVERSITY: 'getDiversity',

  GET_CHART_SETTINGS: 'getChartSettings',
  SET_CHART_SETTINGS: 'setChartSettings',
  GET_AVAILABLE_CHARTS: 'getAvailableCharts',

  // UI actions
  ADD_MEASUREMENTS: 'addMeasurements',
  REMOVE_MEASUREMENTS: 'removeMeasurements',
  ADD_SEQINFOS: 'addSeqInfos',
  REMOVE_SEQNAMES: 'removeSeqNames',
  ADD_CHART: 'addChart',
  REMOVE_CHART: 'removeChart',
  CLEAR_DATASOURCE_GROUP_CACHE: 'clearDatasourceGroupCache',
  FLUSH_CACHE: 'flushCache',
  NAVIGATE: 'navigate',
  REDRAW: 'redraw',
  GET_CURRENT_LOCATION: 'getCurrentLocation',
  WRITE_DEBUG_MSG: 'writeMsg',
  PRINT_WORKSPACE: 'printWorkspace',
  LOAD_WORKSPACE: 'loadWorkspace',
  REGISTER_CHART_TYPES: 'registerChartTypes'
};

/**
 * @param {Object.<string, string>} args A map with the arguments for the request
 * @param {epiviz.data.Request.Method} [method]
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.createRequest = function(args, method) {
  return new epiviz.data.Request(
    epiviz.data.Request._nextId++,
    args,
    method || epiviz.data.Request.Method.GET
  );
};

/**
 * @param {{requestId: number, type: string, data: Object.<string, string>}} o
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.fromRawObject = function(o) {
  return new epiviz.data.Request(o.requestId, o.data);
};

/**
 * @type {number}
 * @private
 */
epiviz.data.Request._nextId = 0;

/**
 * @returns {number}
 */
epiviz.data.Request.prototype.id = function() { return this._id; };

/**
 * @returns {epiviz.data.MessageType}
 */
epiviz.data.Request.prototype.type = function() { return epiviz.data.MessageType.REQUEST; };

/**
 * @returns {epiviz.data.Request.Method}
 */
epiviz.data.Request.prototype.method = function() { return this._method; };

/**
 * Concatenates all arguments in the request into one string. By default, the result will have the following format:
 *   <key1>=<val1>&<key2>=<val2>...
 * @param {string} [keyValGlue] The token used to join keys and values; by default, this is '='
 * @param {string} [argGlue] The token used to join different arguments together; by default, this is '&'
 * @returns {string}
 */
epiviz.data.Request.prototype.joinArgs = function(keyValGlue, argGlue) {
  keyValGlue = keyValGlue || '=';
  argGlue = argGlue || '&';

  var result = sprintf('requestId%s%s', keyValGlue, this._id);
  for (var arg in this._args) {
    if (!this._args.hasOwnProperty(arg)) { continue; }
    if (!Array.isArray(this._args[arg])) {
      result += sprintf('%s%s%s%s', argGlue, arg, keyValGlue, this._args[arg] || '');
    } else {
      for (var i = 0; i < this._args[arg].length; ++i) {
        result += sprintf('%s%s[]%s%s', argGlue, arg, keyValGlue, this._args[arg][i]);
      }
    }
  }

  return result;
};

/**
 * @returns {boolean}
 */
epiviz.data.Request.prototype.isEmpty = function() {
  for (var arg in this._args) {
    if (!this._args.hasOwnProperty(arg)) { continue; }
    return false;
  }

  return true;
};

/**
 * @param arg
 * @returns {?string}
 */
epiviz.data.Request.prototype.get = function(arg) {
  return (arg in this._args) ? this._args[arg] : null;
};

/**
 * @returns {{requestId: number, type: string, data: Object.<string, string>}}
 */
epiviz.data.Request.prototype.raw = function() {
  return {
    requestId: this._id,
    type: this.type(),
    data: epiviz.utils.mapCopy(this._args)
  };
};

/**
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.emptyRequest = function() {
  return epiviz.data.Request.createRequest({});
};

/**
 * @param {epiviz.measurements.Measurement} datasource
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getRows = function(datasource, range) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_ROWS,
    datasource: datasource.id(),
    seqName: range ? range.seqName() : undefined,
    start: range ? range.start() : undefined,
    end: range ? range.end() : undefined,
    metadata: datasource.metadata()
  });
};

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getValues = function(measurement, range) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_VALUES,
    datasource: measurement.datasource().id(),
    measurement: measurement.id(),
    seqName: range ? range.seqName() : undefined,
    start: range ? range.start() : undefined,
    end: range ? range.end() : undefined
  });
};

/**
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} measurementsByDatasource
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getCombined = function(measurementsByDatasource, range) {
  var rawMsByDs = {};
  for (var ds in measurementsByDatasource) {
    if (!measurementsByDatasource.hasOwnProperty(ds)) { continue; }
    rawMsByDs[ds] = (function() {
      var ms = [];
      measurementsByDatasource[ds].foreach(function(m) {
        ms.push(m.id());
      });
      return ms;
    })();
  }
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_COMBINED,
    seqName: range ? range.seqName() : undefined,
    start: range ? range.start() : undefined,
    end: range ? range.end() : undefined,
    measurements: rawMsByDs
  });
};

/**
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getMeasurements = function(datasourceGroup) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_MEASUREMENTS,
    datasourceGroup: datasourceGroup
  });
};

/**
 * @param {string} query
 * @param {number} maxResults
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.search = function(query, maxResults) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.SEARCH,
    q: query || '',
    maxResults: maxResults
  });
};

/**
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getSeqInfos = function(datasourceGroup) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_SEQINFOS,
    datasourceGroup: datasourceGroup
  });
};

/**
 * @param {epiviz.workspaces.Workspace} workspace
 * @param {epiviz.Config} config
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.saveWorkspace = function(workspace, config) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.SAVE_WORKSPACE,
    id: workspace.id(),
    name: workspace.name(),
    content: encodeURIComponent(JSON.stringify(workspace.raw(config).content))
  },
  epiviz.data.Request.Method.POST);
};

/**
 * @param {epiviz.workspaces.Workspace} workspace
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.deleteWorkspace = function(workspace) {
  return epiviz.data.Request.createRequest({
      version: epiviz.EpiViz.VERSION,
      action: epiviz.data.Request.Action.DELETE_WORKSPACE,
      id: workspace.id()
    },
    epiviz.data.Request.Method.POST);
};

/**
 * @param filter
 * @param requestWorkspaceId
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getWorkspaces = function(filter, requestWorkspaceId) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_WORKSPACES,
    q: filter || '',
    ws: requestWorkspaceId
  });
};

/**
 * @param {string} datasourceGroup
 * @param {string} [nodeId]
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getHierarchy = function(datasourceGroup, nodeId) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_HIERARCHY,
    datasourceGroup: datasourceGroup,
    nodeId: nodeId
  });
};

/**
 * @param {string} datasourceGroup
 * @param {Object.<string, epiviz.ui.charts.tree.NodeSelectionType>} [selection]
 * @param {Object.<string, number>} [order]
 * @param {Object.<number, number>} [selectedLevels]
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.propagateHierarchyChanges = function(datasourceGroup, selection, order, selectedLevels) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.PROPAGATE_HIERARCHY_CHANGES,
    datasourceGroup: datasourceGroup,
    selection: selection,
    order: order,
    selectedLevels: selectedLevels
  });
};

/**
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} measurementsByDatasource
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getPCA = function(measurementsByDatasource, range) {
  var rawMsByDs = {};
  for (var ds in measurementsByDatasource) {
    if (!measurementsByDatasource.hasOwnProperty(ds)) { continue; }
    rawMsByDs[ds] = (function() {
      var ms = [];
      measurementsByDatasource[ds].foreach(function(m) {
        ms.push(m.id());
      });
      return ms;
    })();
  }
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_PCA,
    measurements: rawMsByDs
  });
};


/**
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} measurementsByDatasource
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getDiversity = function(measurementsByDatasource, range) {
  var rawMsByDs = {};
  for (var ds in measurementsByDatasource) {
    if (!measurementsByDatasource.hasOwnProperty(ds)) { continue; }
    rawMsByDs[ds] = (function() {
      var ms = [];
      measurementsByDatasource[ds].foreach(function(m) {
        ms.push(m.id());
      });
      return ms;
    })();
  }
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_DIVERSITY,
    measurements: rawMsByDs
  });
};



// Input 11
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 6:47 PM
 */

goog.provide('epiviz.measurements.Measurement');
goog.provide('epiviz.measurements.Measurement.Type');

goog.require('epiviz.utils');

/**
 * @param {string} id
 * @param {string} name
 * @param {epiviz.measurements.Measurement.Type} type
 * @param {string} datasourceId
 * @param {string} datasourceGroup
 * @param {string} dataprovider
 * @param {{referredMeasurements: Object.<number, epiviz.measurements.Measurement>, expression: epiviz.utils.ExpressionParser.Expression}} [formula]
 * @param {string} [defaultChartType]
 * @param {Object.<string, string>} [annotation]
 * @param {number} [minValue]
 * @param {number} [maxValue]
 * @param {Array.<string>} [metadata]
 * @constructor
 */
epiviz.measurements.Measurement = function(id, name, type, datasourceId, datasourceGroup,
                                           dataprovider, formula, defaultChartType, annotation,
                                           minValue, maxValue, metadata) {

  var MeasurementType = epiviz.measurements.Measurement.Type;

  /**
   * @type {string}
   * @private
   */
  this._id = id;

  /**
   * @type {string}
   * @private
   */
  this._name = name;

  /**
   * @type {epiviz.measurements.Measurement.Type}
   * @private
   */
  this._type = type;

  /**
   * @type {epiviz.measurements.Measurement}
   * @private
   */
  this._datasource = type == (MeasurementType.RANGE) ? this :
    new epiviz.measurements.Measurement(
      datasourceId, // id
      datasourceId, // name
      MeasurementType.RANGE, // type
      datasourceId, // datasource
      datasourceGroup, // datasourceGroup
      dataprovider, // dataprovider
      null, // formula
      'Blocks Track', // defaultChartType
      null, null, null, // annotation, minValue, maxValue
      metadata); // metadata

  /**
   * @type {string}
   * @private
   */
  this._datasourceGroup = datasourceGroup;

  /**
   * @type {string}
   * @private
   */
  this._dataprovider = dataprovider;

  /**
   * @type {?{referredMeasurements: Object.<number, epiviz.measurements.Measurement>, expression: epiviz.utils.ExpressionParser.Expression}}
   * @private
   */
  this._formula = formula || null;

  /**
   * @type {?string}
   * @private
   */
  this._defaultChartType = defaultChartType || null;

  /**
   * @type {?Object.<string, string>}
   * @private
   */
  this._annotation = annotation || null;

  /**
   * @type {?number}
   * @private
   */
  this._minValue = (minValue || minValue === 0) ? minValue : null;

  /**
   * @type {?number}
   * @private
   */
  this._maxValue = (maxValue || maxValue === 0) ? maxValue : null;

  /**
   * @type {?Array.<string>}
   * @private
   */
  this._metadata = metadata || null;
};

/**
 * @enum {string}
 */
epiviz.measurements.Measurement.Type = {
  FEATURE: 'feature',
  RANGE: 'range',
  UNORDERED: 'unordered'
};

/**
 * @param {epiviz.measurements.Measurement.Type} type
 * @returns {boolean}
 */
epiviz.measurements.Measurement.Type.isOrdered = function(type) {
  return type == epiviz.measurements.Measurement.Type.FEATURE || type == epiviz.measurements.Measurement.Type.RANGE;
};

/**
 * @param {epiviz.measurements.Measurement.Type} type
 * @returns {boolean}
 */
epiviz.measurements.Measurement.Type.hasValues = function(type) {
  return type == epiviz.measurements.Measurement.Type.FEATURE || type == epiviz.measurements.Measurement.Type.UNORDERED;
};


/**
 * @returns {string}
 */
epiviz.measurements.Measurement.prototype.id = function() {
  return this._id;
};

/**
 * @returns {string}
 */
epiviz.measurements.Measurement.prototype.name = function() {
  return this._name;
};

/**
 * @returns {epiviz.measurements.Measurement.Type}
 */
epiviz.measurements.Measurement.prototype.type = function() {
  return this._type;
};

/**
 * @returns {epiviz.measurements.Measurement}
 */
epiviz.measurements.Measurement.prototype.datasource = function() {
  return this._datasource;
};

/**
 * @returns {string}
 */
epiviz.measurements.Measurement.prototype.datasourceId = function() {
  return this._datasource.id();
};

/**
 * @returns {string}
 */
epiviz.measurements.Measurement.prototype.datasourceGroup = function() {
  return this._datasourceGroup;
};

/**
 * @returns {string}
 */
epiviz.measurements.Measurement.prototype.dataprovider = function() {
  return this._dataprovider;
};

/**
 * @returns {?{referredMeasurements: Object.<number, epiviz.measurements.Measurement>, expression: epiviz.utils.ExpressionParser.Expression}}
 */
epiviz.measurements.Measurement.prototype.formula = function() {
  return this._formula;
};

/**
 * @returns {string}
 */
epiviz.measurements.Measurement.prototype.formulaStr = function() {
  if (!this._formula) { return ''; }
  var referredMs = this._formula.referredMeasurements;
  var expression = this._formula.expression.toString();

  for (var formulaIndex in referredMs) {
    if (!referredMs.hasOwnProperty(formulaIndex)) { continue; }

    expression = expression.replace(
      new RegExp('\\{' + formulaIndex + '\\}', 'g'),
      ' {' + referredMs[formulaIndex].name()  + '} ');
  }

  return expression;
};

/**
 * @param {epiviz.measurements.MeasurementHashtable.<number>} values A map between
 *   each of the component measurements and their corresponding values. See
 *   epiviz.measurements.Measurement.prototype.componentMeasurements() for more.
 */
epiviz.measurements.Measurement.prototype.evaluate = function(values) {
  var tuple = {};
  for (var i in this._formula.referredMeasurements) {
    if (!this._formula.referredMeasurements.hasOwnProperty(i)) { continue; }

    var m = this._formula.referredMeasurements[i];
    tuple['{' + i + '}'] = m.isComputed() ?
      m.evaluate(values) : values.get(m);
  }

  return this._formula.expression.evaluate(tuple);
};

/*
 *@param {epiviz.measurements.MeasurementHashtable.<Array.<number>>} values A map between
 *   each of the component measurements and an array of their corresponding values. See
 *   epiviz.measurements.Measurement.prototype.componentMeasurements() for more.
 */
epiviz.measurements.Measurement.prototype.evaluateArr = function(values) {
  /** @type {Object.<string, Array.<number>>} */
  var tuple = {};
  for (var i in this._formula.referredMeasurements) {
    if (!this._formula.referredMeasurements.hasOwnProperty(i)) { continue; }

    var m = this._formula.referredMeasurements[i];
    tuple['{' + i + '}'] = m.isComputed() ?
      m.evaluateArr(values) : values.get(m);
  }

  return this._formula.expression.evaluateArr(tuple);
};

/**
 * @returns {?string}
 */
epiviz.measurements.Measurement.prototype.defaultChartType = function() {
  return this._defaultChartType;
};

/**
 * @returns {?Object.<string, string>}
 */
epiviz.measurements.Measurement.prototype.annotation = function() {
  return this._annotation;
};

/**
 * @returns {?number}
 */
epiviz.measurements.Measurement.prototype.minValue = function() {
  return this._minValue;
};

/**
 * @returns {?number}
 */
epiviz.measurements.Measurement.prototype.maxValue = function() {
  return this._maxValue;
};

/**
 * @returns {Array.<string>}
 */
epiviz.measurements.Measurement.prototype.metadata = function() {
  return this._metadata || [];
};

/**
 * Gets a set of all independent measurements needed to compute this measurement. If the measurement is independent,
 * then the returned set contains this measurement only.
 *
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.measurements.Measurement.prototype.componentMeasurements = function() {
  var result = new epiviz.measurements.MeasurementSet();

  if (!this._formula) {
    result.add(this);
    return result;
  }

  for (var i in this._formula.referredMeasurements) {
    if (!this._formula.referredMeasurements.hasOwnProperty(i)) { continue; }

    result.addAll(this._formula.referredMeasurements[i].componentMeasurements());
  }

  return result;
};

/**
 * @returns {boolean}
 */
epiviz.measurements.Measurement.prototype.isComputed = function() { return (this._formula) ? true : false; };

/**
 *
 * @param {epiviz.measurements.MeasurementHashtable.<number>} measurementsIndexMap
 * @returns {{id: string, name: string, type: epiviz.measurements.Measurement.Type, datasourceId: string, datasourceGroup: string, dataprovider: string, formula: {expression: (string), referredMeasurements: Object.<number, number>}, defaultChartType: ?string, annotation: ?Object.<string, string>, minValue: ?number, maxValue: ?number, metadata: ?Array.<string>}}
 */
epiviz.measurements.Measurement.prototype.raw = function(measurementsIndexMap) {

  if (this._formula) {
    /** @type {Object.<number, epiviz.measurements.Measurement>} */
    var referredMeasurements = this._formula.referredMeasurements;

    /** @type {Object.<number, number>} */
    var rawReferredMeasurements = {};

    for (var formulaIndex in referredMeasurements) {
      if (!referredMeasurements.hasOwnProperty(formulaIndex)) { continue; }

      rawReferredMeasurements[formulaIndex] = measurementsIndexMap.get(referredMeasurements[formulaIndex]);
    }
  }

  return {
    id: this._id,
    name: this._name,
    type: this._type,
    datasourceId: this._datasource._id,
    datasourceGroup: this._datasourceGroup,
    dataprovider: this._dataprovider,
    formula: this._formula ?
      {expression: this._formula.expression.toString(), referredMeasurements: rawReferredMeasurements} :
      null,
    defaultChartType: this._defaultChartType,
    annotation: this._annotation,
    minValue: this._minValue,
    maxValue: this._maxValue,
    metadata: this._metadata
  };
};

/**
 * @returns {string}
 */
epiviz.measurements.Measurement.prototype.toString = function() {
  return this.name();
};

/**
 * @param {{
 *   id: string,
 *   name: string,
 *   type: string,
 *   datasourceId: string,
 *   datasourceGroup: string,
 *   dataprovider: string,
 *   formula: ?{expression: string, referredMeasurements: Object.<number, number>},
 *   defaultChartType: ?string,
 *   annotation: ?Object.<string, string>,
 *   minValue: ?number,
 *   maxValue: ?number,
 *   metadata: ?Array.<string>}} o
 * @param {Array.<epiviz.measurements.Measurement>} [measurements] This argument is used in conjunction
 *   with o.formula. If that is null, then this parameter is ignored.
 * @returns {epiviz.measurements.Measurement}
 */
epiviz.measurements.Measurement.fromRawObject = function(o, measurements) {
  var formula = null;
  if (o.formula) {
    var expr = epiviz.utils.ExpressionParser.parse(o.formula.expression);
    var refMs = {};

    var vars = expr.variables();
    for (var i = 0; i < vars.length; ++i) {
      if (!epiviz.utils.stringStartsWith(vars[i], '{') || !epiviz.utils.stringEndsWith(vars[i], '}')) {
        // This means that the variable is something else than a measurement
        continue;
      }
      var formulaIndex = parseInt(vars[i].substring(1, vars[i].length - 1));
      var index = o.formula.referredMeasurements[formulaIndex];
      refMs[formulaIndex] = measurements[index];
    }
    formula = {expression: expr, referredMeasurements: refMs};
  }

  return new epiviz.measurements.Measurement(o.id, o.name, o.type, o.datasourceId, o.datasourceGroup, o.dataprovider,
    formula, o.defaultChartType, o.annotation, o.minValue, o.maxValue, o.metadata);
};

// Input 12
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/31/14
 * Time: 10:12 AM
 */

goog.provide('epiviz.utils.Iterable');

/**
 * @interface
 * @template T
 */
epiviz.utils.Iterable = function() {};

/**
 * @param {function(T)} iteration A function that is called for every iteration;
 * if the function returns something that evaluates to true, iteration should break.
 */
epiviz.utils.Iterable.prototype.foreach = function(iteration) {};

// Input 13
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/15/13
 * Time: 11:14 AM
 */

goog.provide('epiviz.utils.Iterator');

/**
 * @interface
 * @template T
 */
epiviz.utils.Iterator = function() {};

/**
 * @returns {?T}
 */
epiviz.utils.Iterator.prototype.first = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {?T}
 */
epiviz.utils.Iterator.prototype.next = function() { throw Error('unimplemented abstract method'); };

// Input 14
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 7:19 PM
 */

goog.provide('epiviz.measurements.MeasurementSet');

goog.require('epiviz.utils.Iterable');
goog.require('epiviz.utils.Iterator');


/**
 * A collection of measurements, where each item is stored only once,
 * and iteration is done in the insertion order.
 *
 * @param {epiviz.measurements.MeasurementSet} [other]
 * @constructor
 * @implements {epiviz.utils.Iterable}
 */
epiviz.measurements.MeasurementSet = function(other) {
  /**
   * A map containing measurements in a tree structure, by the following levels:
   *   dataprovider, type, datasourceGroup, datasource, id
   * @type {Object.<string, Object.<string, Object.<string, Object.<string, Object.<string, {measurement: epiviz.measurements.Measurement, index: number}>>>>>}
   * @private
   */
  this._measurementTree = {};

  /**
   * @type {number}
   * @private
   */
  this._size = 0;

  /**
   * @type {Array.<{measurement: epiviz.measurements.Measurement, contained: boolean}>}
   * @private
   */
  this._order = [];

  if (other) {
    this.addAll(other);
  }
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {boolean} true if the measurement was successfully added to the collection and
 *   false if there was already a measurement with this id in the collection
 */
epiviz.measurements.MeasurementSet.prototype.add = function(m) {
  if (!(m.dataprovider() in this._measurementTree)) {
    this._measurementTree[m.dataprovider()] = {};
  }

  if (!(m.type() in this._measurementTree[m.dataprovider()])) {
    this._measurementTree[m.dataprovider()][m.type()] = {};
  }

  if (!(m.datasourceGroup() in this._measurementTree[m.dataprovider()][m.type()])) {
    this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()] = {};
  }

  if (!(m.datasource().id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()])) {
    this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()] = {};
  }

  if (m.id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()]) {
    return false;
  }

  this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()] = {
    measurement: m,
    index: this._order.length
  };

  this._order.push({
    measurement: m,
    contained: true
  });

  ++this._size;

  return true;
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {boolean} true if the measurement was in the collection and
 *   false if there was no measurement with this id in the collection
 */
epiviz.measurements.MeasurementSet.prototype.remove = function(m) {
  if (!(m.dataprovider() in this._measurementTree)) {
    return false;
  }

  if (!(m.type() in this._measurementTree[m.dataprovider()])) {
    return false;
  }

  if (!(m.datasourceGroup() in this._measurementTree[m.dataprovider()][m.type()])) {
    return false;
  }

  if (!(m.datasource().id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()])) {
    return false;
  }

  if (!(m.id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()])) {
    return false;
  }

  this._order[this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()].index].contained = false;

  delete this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()];
  --this._size;
  return true;
};

/**
 * Returns true if any new measurements were added and false if
 * all measurements were already in the collection.
 * @param {?epiviz.measurements.MeasurementSet} measurements
 * @returns {boolean}
 */
epiviz.measurements.MeasurementSet.prototype.addAll = function(measurements) {
  if (!measurements || !measurements.size()) { return false; }
  var newMeasurementsAdded = false;
  var self = this;
  measurements.foreach(
    /**
     * @param {epiviz.measurements.Measurement} m
     * @returns {boolean}
     */
    function(m) {
      if (self.add(m)) {
        newMeasurementsAdded = true;
      }
      return false;
    });

  return newMeasurementsAdded;
};

/**
 * @param {epiviz.measurements.MeasurementSet} measurements
 * @returns {boolean}
 */
epiviz.measurements.MeasurementSet.prototype.removeAll = function(measurements) {
  var someMeasurementsRemoved = false;
  var self = this;
  measurements.foreach(
    /**
     * @param {epiviz.measurements.Measurement} m
     * @returns {boolean}
     */
    function(m) {
      if (self.remove(m)) {
        someMeasurementsRemoved = true;
      }
      return false;
    });

  return someMeasurementsRemoved;
};

/**
 * Iterates through all items stored in this collection, in the order they were added.
 *
 * @param {function(epiviz.measurements.Measurement, number=)} func A function called
 *   for each measurement matching the given filters. Iteration
 *   is stopped if the function returns something that evaluates to true.
 * @param {function(epiviz.measurements.Measurement): boolean} [predicate]
 */
epiviz.measurements.MeasurementSet.prototype.foreach = function(func, predicate) {
  var iter = this.iterator();
  for (var m = iter.first(), i = 0; m !== null; m = iter.next(), ++i) {
    if (predicate && !predicate(m)) { continue; }
    if (func(m, i)) { return; }
  }
};

/**
 * @returns {epiviz.utils.Iterator.<epiviz.measurements.Measurement>}
 */
epiviz.measurements.MeasurementSet.prototype.iterator = function() {
  return new epiviz.measurements.MeasurementSet.Iterator(this);
};

/**
 * @param {function(epiviz.measurements.Measurement): boolean} [predicate]
 *
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.measurements.MeasurementSet.prototype.subset = function(predicate) {
  var measurements = new epiviz.measurements.MeasurementSet();
  this.foreach(function(m) { measurements.add(m); }, predicate);

  return measurements;
};

/**
 * @param {function(epiviz.measurements.Measurement): epiviz.measurements.Measurement} transformer
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.measurements.MeasurementSet.prototype.map = function(transformer) {
  var ret = new epiviz.measurements.MeasurementSet();
  this.foreach(function(m) {
    ret.add(transformer(m));
  });
  return ret;
};

/**
 * @returns {number}
 */
epiviz.measurements.MeasurementSet.prototype.size = function() { return this._size; };

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {boolean}
 */
epiviz.measurements.MeasurementSet.prototype.contains = function(m) {
  if (!(m.dataprovider() in this._measurementTree)) {
    return false;
  }

  if (!(m.type() in this._measurementTree[m.dataprovider()])) {
    return false;
  }

  if (!(m.datasourceGroup() in this._measurementTree[m.dataprovider()][m.type()])) {
    return false;
  }

  if (!(m.datasource().id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()])) {
    return false;
  }

  return (m.id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()]);
};

/**
 * @returns {?epiviz.measurements.Measurement}
 */
epiviz.measurements.MeasurementSet.prototype.first = function() {
  return this.iterator().first();
};

/**
 * Gets measurement at the given index. This method performs in O(n) time, so
 * it's not appropriate for iteration.
 * @param index
 * @returns {epiviz.measurements.Measurement}
 */
epiviz.measurements.MeasurementSet.prototype.get = function(index) {
  if (index >= this._size || index < 0) { return null; }
  if (this._size == this._order.length) {
    return this._order[index].measurement;
  }

  var result = null;
  this.foreach(function(m, i) {
    if (i == index) {
      result = m;
      return true;
    }
    return false;
  });

  return result;
};

/**
 * @returns {Array.<epiviz.measurements.Measurement>}
 */
epiviz.measurements.MeasurementSet.prototype.toArray = function() {
  var result = new Array(this._size);
  this.foreach(function(m, i) {
    result[i] = m;
  });

  return result;
};

/**
 * @param {function(epiviz.measurements.Measurement, epiviz.measurements.Measurement): number} comparer
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.measurements.MeasurementSet.prototype.sorted = function(comparer) {
  /** @type {Array.<epiviz.measurements.Measurement>} */
  var msArr = this.toArray().sort(comparer);
  var ret = new epiviz.measurements.MeasurementSet();
  msArr.forEach(function(m) { ret.add(m); });
  return ret;
};

/**
 * @returns {Array.<{id: string, name: string, type: epiviz.measurements.Measurement.Type, datasourceId: string, datasourceGroup: string, dataprovider: string, formula: null, defaultChartType: ?string, annotation: ?Object.<string, string>, minValue: ?number, maxValue: ?number, metadata: ?Array.<string>}>}
 */
epiviz.measurements.MeasurementSet.prototype.raw = function() {
  var result = new Array(this._size);
  this.foreach(function(m, i) {
    result[i] = m.raw();
  });

  return result;
};

/**
 * @param {function(epiviz.measurements.Measurement): number|string} criterion
 * @returns {Object.<string, epiviz.measurements.MeasurementSet>}
 */
epiviz.measurements.MeasurementSet.prototype.split = function(criterion) {
  var ret = {};
  this.foreach(function(m, i) {
    var key = criterion(m);
    var group = ret[key];
    if (group == undefined) {
      group = new epiviz.measurements.MeasurementSet();
      ret[key] = group;
    }
    group.add(m);
  });

  return ret;
};

/**
 *
 * @param {epiviz.measurements.MeasurementSet} measurementSet
 * @constructor
 * @implements {epiviz.utils.Iterator}
 */
epiviz.measurements.MeasurementSet.Iterator = function(measurementSet) {
  /**
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._parent = measurementSet;

  /**
   * @type {number}
   * @private
   */
  this._lastIndex = null;
};

/**
 * @returns {?epiviz.measurements.Measurement}
 */
epiviz.measurements.MeasurementSet.Iterator.prototype.first = function() {
  if (this._parent.size() == 0) {
    return null;
  }

  for (var i = 0; i < this._parent._order.length; ++i) {
    if (this._parent._order[i].contained) {
      this._lastIndex = i;
      return this._parent._order[i].measurement;
    }
  }

  // Should never be reached!
  throw Error('Inconsistent MeasurementSet with size() > 0 and no first element');
};

/**
 * @returns {?epiviz.measurements.Measurement}
 */
epiviz.measurements.MeasurementSet.Iterator.prototype.next = function() {
  if (this._lastIndex === null) {
    throw Error('Iterator.next() called before calling Iterator.first()');
  }

  for (var i = this._lastIndex + 1; i < this._parent._order.length; ++i) {
    if (this._parent._order[i].contained) {
      this._lastIndex = i;
      return this._parent._order[i].measurement;
    }
  }

  this._lastIndex = this._parent._order.length;
  return null;
};

// Input 15
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/1/14
 * Time: 3:31 PM
 */

goog.provide('epiviz.ui.controls.VisConfigSelection');

/**
 * @param {epiviz.measurements.MeasurementSet} [measurements]
 * @param {string} [datasource]
 * @param {string} [datasourceGroup]
 * @param {string} [dataprovider]
 * @param {Object.<string, string>} [annotation]
 * @param {string} [defaultChartType]
 * @param {number} [minSelectedMeasurements]
 * @param {T} [customData]
 * @constructor
 * @struct
 * @template T
 */
epiviz.ui.controls.VisConfigSelection = function(measurements, datasource, datasourceGroup, dataprovider, annotation, defaultChartType, minSelectedMeasurements, customData) {
  /**
   * @type {epiviz.measurements.MeasurementSet}
   */
  this.measurements = measurements;

  /**
   * @type {string}
   */
  this.datasource = datasource;

  /**
   * @type {string}
   */
  this.datasourceGroup = datasourceGroup;

  /**
   * @type {string}
   */
  this.dataprovider = dataprovider;

  /**
   * @type {Object.<string, string>}
   */
  this.annotation = annotation;

  /**
   * @type {string}
   */
  this.defaultChartType = defaultChartType;

  /**
   * @type {number}
   */
  this.minSelectedMeasurements = minSelectedMeasurements || 1;

  /**
   * @type {T}
   */
  this.customData = customData;
};

// Input 16
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/4/14
 * Time: 10:45 AM
 */

goog.provide('epiviz.events.EventResult');

/**
 * @constructor
 * @struct
 * @template T
 */
epiviz.events.EventResult = function() {
  /**
   * @type {?boolean}
   */
  this.success = null;

  /**
   * @type {?string}
   */
  this.errorMessage = null;

  /**
   * @type {?T}
   */
  this.value = null;
};

// Input 17
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 6:01 PM
 */

goog.provide('epiviz.datatypes.GenomicRange');

/**
 * A genomic range to be used within EpiViz for requesting and displaying data.
 * IMPORTANT: Not to be confused with epiviz.datatypes.GenomicRanges.Row (an element
 * of GenomicRanges)
 * @param {string} seqname
 * @param {number} start
 * @param {number} width
 * @constructor
 * @implements {epiviz.datatypes.Range}
 */
epiviz.datatypes.GenomicRange = function(seqname, start, width) {

  if (width != undefined && width < 0) {
    width = -width;
    if (start != undefined) {
      start -= width;
    }
  }

  /**
   * @type {string}
   * @private
   */
  this._seqname = seqname;

  /**
   * @type {number}
   * @private
   */
  this._start = start;

  /**
   * @type {number}
   * @private
   */
  this._width = width;
};

/**
 * @param {string} seqname
 * @param {number} start
 * @param {number} end
 * @returns {epiviz.datatypes.GenomicRange}
 */
epiviz.datatypes.GenomicRange.fromStartEnd = function(seqname, start, end) {
  return new epiviz.datatypes.GenomicRange(seqname, start, (start != undefined && end != undefined) ? end - start : undefined);
};

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicRange.prototype.seqName = function() { return this._seqname; };

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicRange.prototype.start = function() { return this._start; };

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicRange.prototype.width = function() { return this._width; };

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicRange.prototype.end = function() { return (this._start != undefined && this._width != undefined) ? this._start + this._width : undefined; };

/**
 * @returns {boolean}
 */
epiviz.datatypes.GenomicRange.prototype.isEmpty = function() { return this._width <= 0; };

/**
 * @param {epiviz.datatypes.GenomicRange} other
 * @returns {Array.<epiviz.datatypes.GenomicRange>}
 */
epiviz.datatypes.GenomicRange.prototype.subtract = function(other) {
  if (!other || other.seqName() != this._seqname || other.isEmpty()
      || other.start() >= this.end() || this._start >= other.end()) {
    return [this];
  }

  if (other.start() <= this._start && other.end() >= this.end()) {
    return [];
  }

  if (other.start() > this._start && other.end() < this.end()) {
    return [
      epiviz.datatypes.GenomicRange.fromStartEnd(this._seqname, this._start, other.start()),
      epiviz.datatypes.GenomicRange.fromStartEnd(this._seqname, other.end(), this.end())
    ];
  }

  if (other.start() > this._start) {
    return [epiviz.datatypes.GenomicRange.fromStartEnd(this._seqname, this._start, other.start())];
  }

  // other.end() < this.end()
  return [epiviz.datatypes.GenomicRange.fromStartEnd(this._seqname, other.end(), this.end())];
};

/**
 * @param {epiviz.datatypes.GenomicRange} other
 * @returns {boolean}
 */
epiviz.datatypes.GenomicRange.prototype.equals = function(other) {
  if (!other) { return false; }

  if (other == this) { return true; }

  return (this._seqname == other._seqname && this._start == other._start && this._width == other._width);
};

/**
 * @param {epiviz.datatypes.GenomicRange} other
 * @returns {boolean}
 */
epiviz.datatypes.GenomicRange.prototype.overlapsWith = function(other) {
  if (!other) { return false; }
  if (this == other) { return true; }
  if (this.seqName() != other.seqName()) { return false; }
  return (this.start() < other.end() && this.end() > other.start());
};

/**
 * @returns {{seqName: string, start: number, width: number}}
 */
epiviz.datatypes.GenomicRange.prototype.raw = function() {
  return {
    seqName: this._seqname,
    start: this._start,
    width: this._width
  };
};

/**
 * @param {{seqName: string, start: number, width: number}} o
 * @returns {epiviz.datatypes.GenomicRange}
 */
epiviz.datatypes.GenomicRange.fromRawObject = function(o) {
  return new epiviz.datatypes.GenomicRange(o.seqName, o.start, o.width);
};

// Input 18
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/22/13
 * Time: 9:00 PM
 */

goog.provide('epiviz.ui.charts.ColorPalette');

goog.require('epiviz.utils');
goog.require('epiviz.Config');

/**
 * @param {Array.<string>} colors
 * @param {string} [name]
 * @param {string} [id]
 * @param {Object.<string|number, number>} [keyIndices]
 * @constructor
 */
epiviz.ui.charts.ColorPalette = function(colors, name, id, keyIndices) {
  /**
   * @type {Array.<string>}
   * @private
   */
  this._colors = colors;

  /**
   * @type {string}
   * @private
   */
  this._id = id || epiviz.utils.generatePseudoGUID(6);

  /**
   * @type {string}
   * @private
   */
  this._name = name || 'Custom (' + this._id + ')';

  /**
   * @type {Object.<string|number, number>}
   * @private
   */
  this._keyIndices = keyIndices || {};

  /**
   * @type {number}
   * @private
   */
  this._nKeys = 0;
};

/**
 * @returns {string}
 */
epiviz.ui.charts.ColorPalette.prototype.id = function() { return this._id; };

/**
 * @returns {string}
 */
epiviz.ui.charts.ColorPalette.prototype.name = function() { return this._name; };

/**
 * @param {number} i
 * @returns {string} A color corresponding to the index i
 */
epiviz.ui.charts.ColorPalette.prototype.get = function(i) {
  return this._colors[i % this._colors.length];
};

/**
 * @param {string|number} key
 * @returns {string}
 */
epiviz.ui.charts.ColorPalette.prototype.getByKey = function(key) {
  var index = this._keyIndices[key];
  if (index == undefined) {
    index = this._nKeys;
    this._keyIndices[key] = this._nKeys;
    ++this._nKeys;
  }
  return this.get(index);
};

/**
 * @param {string} key
 * @returns {number}
 */
epiviz.ui.charts.ColorPalette.prototype.keyColorIndex = function(key) {
  var ret = this._keyIndices[key];
  if (ret == undefined) { return -1; }
  return ret;
};

/**
 * @returns {Object.<string|number, number>}
 */
epiviz.ui.charts.ColorPalette.prototype.keyIndices = function() { return this._keyIndices; };

/**
 * @returns {Number} The number of colors contained in this palette
 */
epiviz.ui.charts.ColorPalette.prototype.size = function() {
  return this._colors.length;
};

/**
 * @param {epiviz.ui.charts.ColorPalette} other
 * @returns {boolean}
 */
epiviz.ui.charts.ColorPalette.prototype.equals = function(other) {
  if (this == other) { return true; }
  if (!other) { return false; }

  return epiviz.utils.arraysEqual(this._colors, other._colors);
};

/**
 * @returns {epiviz.ui.charts.ColorPalette}
 */
epiviz.ui.charts.ColorPalette.prototype.copy = function() {
  return new epiviz.ui.charts.ColorPalette(this._colors.slice(0));
};

/**
 * @param {epiviz.Config} [config]
 * @returns {{id: string, name: string, colors: Array.<string>}}
 */
epiviz.ui.charts.ColorPalette.prototype.raw = function(config) {
  if (config && (this._id in config.colorPalettesMap)) {
    return {id: this._id};
  }
  return {id: this._id, name: this._name, colors: this._colors};
};

/**
 * @param {Array.<string>|{id:string, name:string, colors:Array.<string>}} o
 * @param {epiviz.Config} [config]
 * @returns {epiviz.ui.charts.ColorPalette}
 */
epiviz.ui.charts.ColorPalette.fromRawObject = function(o, config) {
  if ($.isArray(o)) {
    return new epiviz.ui.charts.ColorPalette(o);
  }

  if (config && (o.id in config.colorPalettesMap)) {
    return config.colorPalettesMap[o.id];
  }

  if (!o.colors || !o.colors.length) { o.colors = epiviz.Config.COLORS_BRIGHT; }

  return new epiviz.ui.charts.ColorPalette(o.colors, o.name, o.id);
};

// Input 19
/**
 * Created by: Florin Chelaru
 * Date: 10/1/13
 * Time: 1:22 PM
 */

goog.provide('epiviz.data.WebsocketDataProvider');

goog.require('epiviz.Config');
goog.require('epiviz.utils');
goog.require('epiviz.data.DataProvider');
goog.require('epiviz.data.Response');
goog.require('epiviz.ui.WebArgsManager');
goog.require('epiviz.data.MessageType');
goog.require('epiviz.data.Request');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.measurements.MeasurementSet');
goog.require('epiviz.ui.controls.VisConfigSelection');
goog.require('epiviz.events.EventResult');
goog.require('epiviz.datatypes.GenomicRange');
goog.require('epiviz.ui.charts.ColorPalette');

/**
 * @param {?string} [id]
 * @param {string} websocketHost
 * @constructor
 * @extends {epiviz.data.DataProvider}
 */
epiviz.data.WebsocketDataProvider = function (id, websocketHost) {
  epiviz.data.DataProvider.call(this, id || epiviz.data.WebsocketDataProvider.DEFAULT_ID);

  /**
   * @type {string}
   * @private
   */
  this._websocketHost = websocketHost;

  /**
   * @type {?WebSocket}
   * @private
   */
  this._socket = null;

  /**
   * Variable used for testing. If this is set to false, then
   * events triggered by instances of this class should have no
   * UI effect
   * @type {boolean}
   * @private
   */
  this._useUI = (epiviz.ui.WebArgsManager.WEB_ARGS['websocketNoUI'] != 'true');

  /**
   * Used for testing
   * @type {boolean}
   * @private
   */
  this._debug = (epiviz.ui.WebArgsManager.WEB_ARGS['debug'] == 'true');

  /**
   * Callbacks hashtable, mapping request ids to their corresponding callbacks
   * @type {Object.<string, function>}
   * @private
   */
  this._callbacks = {};

  /**
   * Stores messages as a stack until the socket is actually open
   * @type {Array.<string>}
   * @private
   */
  this._requestsStack = [];

  this._initialize();
};

/**
 * Copy methods from upper class
 */
epiviz.data.WebsocketDataProvider.prototype = epiviz.utils.mapCopy(epiviz.data.DataProvider.prototype);
epiviz.data.WebsocketDataProvider.constructor = epiviz.data.WebsocketDataProvider;

epiviz.data.WebsocketDataProvider.DEFAULT_ID = 'websocket';

/**
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._initialize = function () {
  if (!this._websocketHost || this._websocketHost == 'None') { return; }

  try {
    this._socket = new WebSocket(this._websocketHost);
    this._log('WebSocket - status ' + this._socket.readyState);
    var self = this;
    this._socket.onopen = function () { self._onSocketOpen(); };
    this._socket.onmessage = function (msg) { self._onSocketMessage(msg); };
    this._socket.onclose = function () { self._onSocketClose(); };
  } catch (error) {
    this._log(error.toString());
    // TODO: Throw some error to be caught up in epiviz.js
  }
};

/**
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._onSocketOpen = function () {
  // Send the requests that were made before the socked was fully open.
  // Those are stored in this._requestStack
  for (var i = 0; i < this._requestsStack.length; ++i) {
    this._socket.send(this._requestsStack[i]);
  }

  this._requestsStack = [];

  this._registerAvailableCharts();
};


/**
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._onSocketClose = function () {
  this._socket = null;
};

/**
 * @param {string} message
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._sendMessage = function (message) {
  if (this.connected() && this._socket.readyState) {
    this._socket.send(message);
  } else {
    this._requestsStack.push(message);
  }
};

/**
 * @param {{data: string}} msg
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._onSocketMessage = function (msg) {
  this._log('Local Controller Received: ' + msg.data);

  /**
   * @type {{requestId: number, type: string, data: *}}
   */
  var message = JSON.parse(msg.data);
  message.data.dataprovidertype = "websocket";
  if (message['type'] == epiviz.data.MessageType.RESPONSE) {
    var response = epiviz.data.Response.fromRawObject(message);
    var callback = this._callbacks[response.id()];
    delete this._callbacks[response.id()];
    callback(response);
  } else if (message['type'] == epiviz.data.MessageType.REQUEST) {
    var Action = epiviz.data.Request.Action;
    var request = epiviz.data.Request.fromRawObject(message);

    switch (request.get('action')) {
      case Action.ADD_MEASUREMENTS:
        this._addMeasurements(request);
        break;
      case Action.REMOVE_MEASUREMENTS:
        this._removeMeasurements(request);
        break;
      case Action.ADD_SEQINFOS:
        this._addSeqInfos(request);
        break;
      case Action.REMOVE_SEQNAMES:
        this._removeSeqNames(request);
        break;
      case Action.ADD_CHART:
        this._addChart(request);
        break;
      case Action.REMOVE_CHART:
        this._removeChart(request);
        break;
      case Action.CLEAR_DATASOURCE_GROUP_CACHE:
        this._clearDatasourceGroupCache(request);
        break;
      case Action.FLUSH_CACHE:
        this._flushCache(request);
        break;
      case Action.NAVIGATE:
        this._navigate(request);
        break;
      case Action.REDRAW:
        this._redraw(request);
        break;
      case Action.GET_CURRENT_LOCATION:
        this._getCurrentLocation(request);
        break;
      case Action.WRITE_DEBUG_MSG: 
        this._writeDebugMsg(request);
        break;
      case Action.PRINT_WORKSPACE:
        this._printWorkspace(request);
        break;
      case Action.SET_CHART_SETTINGS:
        this._setChartSettings(request);
        break;
      case Action.GET_CHART_SETTINGS:
        this._getChartSettings(request);
        break;
      case Action.GET_AVAILABLE_CHARTS:
        this._getAvailableCharts(request);
        break;
      case Action.LOAD_WORKSPACE:
        this._loadWorkspace(request);
        break;
    }
  }
};

/**
 * @param {string} message
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._log = function(message) {
  if (this._debug) { console.log(message); }
};

/**
 * @param {epiviz.events.Event.<{result: epiviz.events.EventResult<*>}>} event
 * @param {{result: epiviz.events.EventResult<*>}} args
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._fireEvent = function(event, args) {
  if (!this._useUI) {
    args.result.success = true;
    return;
  }

  event.notify(args);
};

/**
 * @returns {boolean}
 */
epiviz.data.WebsocketDataProvider.prototype.connected = function () {
  return (this._socket != null);
};

/**
 * @param {epiviz.data.Request} request
 * @param {function(epiviz.data.Response)} callback
 * @override
 */
epiviz.data.WebsocketDataProvider.prototype.getData = function (request, callback) {
  var message = JSON.stringify(request.raw());
  this._callbacks[request.id()] = callback;

  this._sendMessage(message);
};

// This is the interface to the websocket

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._addMeasurements = function (request) {
  var result = new epiviz.events.EventResult();
  var measurements = new epiviz.measurements.MeasurementSet();

  /**
   * @type {Array.<{
   *   id: string,
   *   name: string,
   *   type: string,
   *   datasourceId: string,
   *   datasourceGroup: string,
   *   defaultChartType: ?string,
   *   annotation: ?Object.<string, string>,
   *   minValue: ?number,
   *   maxValue: ?number,
   *   metadata: ?Array.<string>}>}
   */
  var rawMeasurements = JSON.parse(request.get('measurements'));
  for (var i = 0; i < rawMeasurements.length; ++i) {
    measurements.add(new epiviz.measurements.Measurement(
      rawMeasurements[i]['id'],
      rawMeasurements[i]['name'],
      rawMeasurements[i]['type'],
      rawMeasurements[i]['datasourceId'],
      rawMeasurements[i]['datasourceGroup'],
      this.id(),
      null,
      rawMeasurements[i]['defaultChartType'],
      rawMeasurements[i]['annotation'],
      rawMeasurements[i]['minValue'],
      rawMeasurements[i]['maxValue'],
      rawMeasurements[i]['metadata']
    ));
  }

  this._fireEvent(this.onRequestAddMeasurements(), {measurements: measurements, result: result});

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._removeMeasurements = function (request) {
  var result = new epiviz.events.EventResult();
  var measurements = new epiviz.measurements.MeasurementSet();

  /**
   * @type {Array.<{
   *   id: string,
   *   name: string,
   *   type: string,
   *   datasourceId: string,
   *   datasourceGroup: string,
   *   defaultChartType: ?string,
   *   annotation: ?Object.<string, string>,
   *   minValue: ?number,
   *   maxValue: ?number,
   *   metadata: ?Array.<string>}>}
   */
  var rawMeasurements = JSON.parse(request.get('measurements'));
  for (var i = 0; i < rawMeasurements.length; ++i) {
    measurements.add(new epiviz.measurements.Measurement(
      rawMeasurements[i]['id'],
      rawMeasurements[i]['name'],
      rawMeasurements[i]['type'],
      rawMeasurements[i]['datasourceId'],
      rawMeasurements[i]['datasourceGroup'],
      this.id(),
      null,
      rawMeasurements[i]['defaultChartType'],
      rawMeasurements[i]['annotation'],
      rawMeasurements[i]['minValue'],
      rawMeasurements[i]['maxValue'],
      rawMeasurements[i]['metadata']
    ));
  }
  this._fireEvent(this.onRequestRemoveMeasurements(), {measurements: measurements, result: result});

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._addSeqInfos = function (request) {
  var result = new epiviz.events.EventResult();

  /**
   * @type {Array.<Array>}
   */
  var seqInfos = JSON.parse(request.get('seqInfos'));

  this._fireEvent(this.onRequestAddSeqInfos(), {seqInfos: seqInfos, result: result});

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._removeSeqNames = function (request) {
  var result = new epiviz.events.EventResult();

  /**
   * @type {Array.<string>}
   */
  var seqNames = JSON.parse(request.get('seqNames'));

  this._fireEvent(this.onRequestRemoveSeqNames(), {seqNames: seqNames, result: result});

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._addChart = function (request) {
  /** @type {epiviz.events.EventResult.<{id: string}>} */
  var result = new epiviz.events.EventResult();

  var measurements, datasource, datasourceGroup;

  if (request.get('measurements') != undefined) {
    measurements = new epiviz.measurements.MeasurementSet();

    /**
     * @type {Array.<{
     *   id: string,
     *   name: string,
     *   type: string,
     *   datasourceId: string,
     *   datasourceGroup: string,
     *   defaultChartType: ?string,
     *   annotation: ?Object.<string, string>,
     *   minValue: ?number,
     *   maxValue: ?number,
     *   metadata: ?Array.<string>}>}
     */
    var rawMeasurements = JSON.parse(request.get('measurements'));
    for (var i = 0; i < rawMeasurements.length; ++i) {
      measurements.add(new epiviz.measurements.Measurement(
        rawMeasurements[i]['id'],
        rawMeasurements[i]['name'],
        rawMeasurements[i]['type'],
        rawMeasurements[i]['datasourceId'],
        rawMeasurements[i]['datasourceGroup'],
        this.id(),
        null,
        rawMeasurements[i]['defaultChartType'],
        rawMeasurements[i]['annotation'],
        rawMeasurements[i]['minValue'],
        rawMeasurements[i]['maxValue'],
        rawMeasurements[i]['metadata']
      ));
    }
  }

  datasource = request.get('datasource');
  datasourceGroup = request.get('datasourceGroup') || datasource;

  this._fireEvent(this.onRequestAddChart(), {
    type: request.get('type'),
    visConfigSelection: new epiviz.ui.controls.VisConfigSelection(measurements, datasource, datasourceGroup),
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._removeChart = function (request) {
  var chartId = request.get('chartId');
  var result = new epiviz.events.EventResult();

  this._fireEvent(this.onRequestRemoveChart(), {
    id: chartId,
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._clearDatasourceGroupCache = function (request) {
  var result = new epiviz.events.EventResult();

  this._fireEvent(this.onRequestClearDatasourceGroupCache(), {
    datasourceGroup: request.get('datasourceGroup'),
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._flushCache = function (request) {
  var result = new epiviz.events.EventResult();
  this._fireEvent(this.onRequestFlushCache(), {
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._navigate = function (request) {
  /**
   * @type {{seqName: string, start: number, end: number}}
   */
  var range = JSON.parse(request.get('range'));
  var result = new epiviz.events.EventResult();

  this._fireEvent(this.onRequestNavigate(), {
    range: epiviz.datatypes.GenomicRange.fromStartEnd(range.seqName, range.start, range.end),
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._redraw = function (request) {
  var result = new epiviz.events.EventResult();
  this._fireEvent(this.onRequestRedraw(), {
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._getCurrentLocation = function(request) {
  var result = new epiviz.events.EventResult();
  this._fireEvent(this.onRequestCurrentLocation(), {
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._writeDebugMsg = function(request) {
    var msg = request.get('msg');
    var msgDiv = document.createElement("pre");
    msgDiv.innerHTML = msg.replace(/&/g, "&amp;").replace(/\\</g,"&lt;");
    var response = new epiviz.data.Response(request.id(), {msg: "that msg"});
    document.getElementById("chart-container").appendChild(msgDiv);
    this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._printWorkspace = function (request) {
  var contrId = request.get('chartId');
  var fName = request.get('fileName');
  var fType = request.get('fileType');
  var result = new epiviz.events.EventResult();
  this._fireEvent(this.onRequestPrintWorkspace(), {
    chartId: contrId,
    fileName: fName,
    fileType: fType,
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._setChartSettings = function (request) {
  var chartId = request.get('chartId');
  var settings = request.get('settings');
  var colorMap = request.get('colorMap');

  var colors = new epiviz.ui.charts.ColorPalette(colorMap);
  var result = new epiviz.events.EventResult();

  this._fireEvent(this.onRequestSetChartSettings(), {
    chartId: chartId,
    settings: settings,
    colorMap: colors,
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._getChartSettings = function (request) {
  var chartId = request.get('chartId');
  var result = new epiviz.events.EventResult();

  this._fireEvent(this.onRequestGetChartSettings(), {
    chartId: chartId,
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._getAvailableCharts = function (request) {
  var result = new epiviz.events.EventResult();

  this._fireEvent(this.onRequestGetChartSettings(), {
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};


/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._registerAvailableCharts = function () {
  var result = new epiviz.events.EventResult();

  this._fireEvent(this.onRequestGetChartSettings(), {
    result: result
  });

  request = epiviz.data.Request.createRequest({
    action: epiviz.data.Request.Action.REGISTER_CHART_TYPES,
    data: result.value
  });

  var message = JSON.stringify(request.raw());

  this._callbacks[request.id()] = function (resp) {
    //do nothing
  };

  this._sendMessage(message);
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype.updateChartSettings = function (request, callback) {
  var message = JSON.stringify(request.raw());
  this._callbacks[request.id()] = callback;
  this._sendMessage(message);
};


/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._loadWorkspace = function (request) {
  var workspaceId = request.get('workspaceId');
  var result = new epiviz.events.EventResult();
  this._fireEvent(this.onRequestLoadWorkspace(), {
    workspace: workspaceId
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

// goog.inherits(epiviz.data.WebsocketDataProvider, epiviz.data.DataProvider);
// Input 20
/**
 * Created by: Florin Chelaru
 * Date: 10/2/13
 * Time: 11:20 AM
 */

goog.provide('epiviz.data.WebServerDataProvider');

goog.require('epiviz.Config');
goog.require('epiviz.utils');
goog.require('epiviz.data.DataProvider');
goog.require('epiviz.data.Response');

/**
 * @param {string} [id]
 * @param {string} [serverEndpoint]
 * @constructor
 * @extends epiviz.data.DataProvider
 */
epiviz.data.WebServerDataProvider = function(id, serverEndpoint) {
  epiviz.data.DataProvider.call(this, id || epiviz.Config.DEFAULT_DATA_PROVIDER_ID);

  /**
   * @type {string}
   * @private
   */
  this._serverEndpoint = serverEndpoint || epiviz.data.WebServerDataProvider.DEFAULT_SERVER_ENDPOINT;
};

/**
 * Copy methods from upper class
 */
epiviz.data.WebServerDataProvider.prototype = epiviz.utils.mapCopy(epiviz.data.DataProvider.prototype);
epiviz.data.WebServerDataProvider.constructor = epiviz.data.WebServerDataProvider;

/**
 * @constant
 * @type {string}
 */
epiviz.data.WebServerDataProvider.DEFAULT_SERVER_ENDPOINT = 'data/main.php';

/**
 * @param {epiviz.data.Request} request
 * @param {function(epiviz.data.Response.<*>)} callback
 */
epiviz.data.WebServerDataProvider.prototype.getData = function(request, callback) {
  if (request.isEmpty()) { return; }

  if (request.method() == epiviz.data.Request.Method.GET) {
    var query = sprintf('%s?%s', this._serverEndpoint, request.joinArgs());

    epiviz.data.WebServerDataProvider.makeGetRequest(query, function(jsondata) {
      callback(epiviz.data.Response.fromRawObject(jsondata));
    });
  } else {
    epiviz.data.WebServerDataProvider.makePostRequest(this._serverEndpoint, request.joinArgs(), function(jsondata) {
      callback(epiviz.data.Response.fromRawObject(jsondata));
    });
  }
};

/**
 *
 * @param query
 * @param callback
 */
epiviz.data.WebServerDataProvider.makeGetRequest = function(query, callback) {
  var request = $.ajax({
    type: "get",
    url: query,
    dataType: "json",
    async: true,
    cache: false,
    processData: true
  });

  // callback handler that will be called on success
  request.done(function (jsonData){
    callback(jsonData);
  });

  // callback handler that will be called on failure
  request.fail(function (jqXHR, textStatus, errorThrown){
    //console.error("The following error occured: " + textStatus, errorThrown);
  });

  // callback handler that will be called regardless
  // if the request failed or succeeded
  request.always(function () {});
};

/**
 * @param {string} query
 * @param {Object} postData
 * @param {function} callback
 */
epiviz.data.WebServerDataProvider.makePostRequest = function(query, postData, callback) {
  var request = $.ajax({
    type: "post",
    url: query,
    data: postData,
    dataType: "json",
    async: true,
    cache: false,
    processData: true
  });

  // callback handler that will be called on success
  request.done(function (data, textStatus, jqXHR){
    callback(data);
  });

  // callback handler that will be called on failure
  request.fail(function (jqXHR, textStatus, errorThrown){
    console.error("The following error occured: " + textStatus, errorThrown);
  });

  // callback handler that will be called regardless
  // if the request failed or succeeded
  request.always(function () {});
};

// goog.inherits(epiviz.data.WebServerDataProvider, epiviz.data.DataProvider);
// Input 21
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 12:14 PM
 */

goog.provide('epiviz.Config');

goog.require('epiviz.ui.WebArgsManager');
goog.require('epiviz.data.WebsocketDataProvider');
goog.require('epiviz.data.WebServerDataProvider');

/**
 * @param {*} [settingsMap] A map of settings to override the default settings for the config.
 * @constructor
 */
epiviz.Config = function(settingsMap) {

  /**
   * The server storing all the back-end PHP scripts
   * @type {string}
   */
  this.dataServerLocation = null;

  /**
   * The path of the php script that handles chart saving, relative to dataServerLocation
   * @type {string}
   */
  this.chartSaverLocation = null;

  /**
   * A number between 0 and 1
   * @type {number}
   */
  this.zoominRatio = null;

  /**
   * A number greater than 1
   * @type {number}
   */
  this.zoomoutRatio = null;

  /**
   * A number between 0 and 1
   * @type {number}
   */
  this.navigationStepRatio = null;

  /**
   * The delay in milliseconds between a user command and the command being propagated to the data layer
   * @type {number}
   */
  this.navigationDelay = null;

  /**
   * @type {{
   *    name: string,
   *    content: {
   *      range: {seqName: string, start: number, width: number},
   *      measurements: Array.<{
            id: string, name: string, type: string, datasourceId: string,
            datasourceGroup: string, dataprovider: string, formula: null,
            defaultChartType: string, annotation: ?Object.<string, string>,
            minValue: ?number, maxValue: ?number,
            metadata: ?Array.<string>
          }>,
   *      charts: Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<{
   *        id: string,
   *        type: string,
   *        properties: {
   *          width: number, height: number, margins: { top: number, left: number, bottom: number, right: number },
   *          measurements: Array.<number>, colors: Array.<string>, customSettings: Object.<string, string>
   *        }
   *      }>>
   *    }
   * }}
   */
  this.defaultWorkspaceSettings = null;

  /**
   * An array of strings in the following format:
   *   [typename],[arguments], where typename is the name of a type that
   *   extends DataProvider, and arguments is a list of arguments used for
   *   constructing the data provider, separated by comma.
   *
   * @type {Array.<string>}
   */
  this.dataProviders = null;

  /**
   * @type {string}
   */
  this.workspacesDataProvider = null;

  /**
   * @type {boolean}
   */
  this.useCache = true;

  /**
   * @type {string}
   */
  this.useCookie = null;

  /**
   * The time interval used by the cache to clear away unneeded loaded data
   * @type {number}
   */
  this.cacheUpdateIntervalMilliseconds = 30000;

  /**
   * The maximum number of search results to show in the gene search box
   * @type {number}
   */
  this.maxSearchResults = null;

  /**
   * @type {Array.<string>}
   */
  this.chartTypes = null;

  // Default chart properties: these settings map either generic chart display types (plot or track),
  // or specific chart types (for example epiviz.plugins.charts.BlocksTrack) to corresponding
  // configurations.
  //
  // Example:
  // this.chartSettings = {
  //   plot: { width: 400, height: 100 },
  //   'epiviz.plugins.charts.GenesTrack': { height: 150 },
  //   'epiviz.plugins.charts.BlocksTrack': { width: 450, height: 190 }
  // }


  /**
   * @type {Object.<epiviz.ui.charts.VisualizationType.DisplayType|string, Object.<epiviz.Config.VisualizationPropertySettings, *>>}
   */
  this.chartSettings = null;

  /**
   * A map of chart type and settings specific to that particular chart type
   * Example:
   * this.chartCustomSettings = {
   *   'epiviz.plugins.charts.LineTrack': {
   *     maxPoints: 1000
   *   }
   * }
   * @type {Object<string, Object<string, *>>}
   */
  this.chartCustomSettings = null;

  /**
   * @type {{algorithms: Array.<string>, metrics: Array.<string>, linkages: Array.<string>}}
   */
  this.clustering = null;

  /**
   * @type {Array.<epiviz.ui.charts.ColorPalette>}
   */
  this.colorPalettes = null;

  /**
   * @type {Object.<string, epiviz.ui.charts.ColorPalette>}
   */
  this.colorPalettesMap = null;

  // Override settings included in the given object
  if (settingsMap) {
    for (var setting in settingsMap) {
      if (!settingsMap.hasOwnProperty(setting)) { continue; }
      this[setting] = settingsMap[setting];
    }

    if(settingsMap.configType != 'epivizr_standalone') {
      var socketHosts = epiviz.ui.WebArgsManager.WEB_ARGS['websocket-host'];
      if (socketHosts && socketHosts.length) {
        for (var i = 0; i < socketHosts.length; ++i) {
          this.dataProviders.push(sprintf('epiviz.data.WebsocketDataProvider,%s,%s',
              epiviz.data.WebsocketDataProvider.DEFAULT_ID + '-' + i,
              socketHosts[i]));
        }
      }
    }
  }

  var colorPalettesMap = {};
  this.colorPalettes.forEach(function(palette) {
    colorPalettesMap[palette.id()] = palette;
  });
  this.colorPalettesMap = colorPalettesMap;
  
  if(settingsMap.configType != 'default') {
    this.useCookie = epiviz.ui.WebArgsManager.WEB_ARGS.useCookie;
  }
};

/**
 * A map of settings that are used as input for the EpiViz configuration
 * @type {*}
 */
epiviz.Config.SETTINGS = {};

/**
 * @const {string}
 */
epiviz.Config.DEFAULT_DATA_PROVIDER_ID = 'umd';

/**
 * @const {string}
 */
epiviz.Config.DEFAULT_WORKSPACE_NAME = 'Default Workspace';

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.EPIVIZ_V1_COLORS = ['#025167', '#e7003e', '#ffcd00', '#057d9f', '#970026', '#ffe373', '#ff8100'];

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.COLORS_BRIGHT = ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'];

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.COLORS_LIGHT = ['#b8d2eb', '#f2aeac', '#d8e4aa', '#cccccc', '#f2d1b0', '#d4b2d3', '#ddb8a9', '#ebbfd9'];

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.COLORS_MEDIUM = ['#599ad3', '#f1595f', '#79c36a', '#727272', '#f9a65a', '#9e66ab', '#cd7058', '#d77fb3'];

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.COLORS_D3_CAT10 = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"];

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.COLORS_D3_CAT20 = ["#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896", "#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7", "#bcbd22", "#dbdb8d", "#17becf", "#9edae5"];

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.COLORS_D3_CAT20B = ["#393b79", "#5254a3", "#6b6ecf", "#9c9ede", "#637939", "#8ca252", "#b5cf6b", "#cedb9c", "#8c6d31", "#bd9e39", "#e7ba52", "#e7cb94", "#843c39", "#ad494a", "#d6616b", "#e7969c", "#7b4173", "#a55194", "#ce6dbd", "#de9ed6"];

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.COLORS_D3_CAT20C = ["#3182bd", "#6baed6", "#9ecae1", "#c6dbef", "#e6550d", "#fd8d3c", "#fdae6b", "#fdd0a2", "#31a354", "#74c476", "#a1d99b", "#c7e9c0", "#756bb1", "#9e9ac8", "#bcbddc", "#dadaeb", "#636363", "#969696", "#bdbdbd", "#d9d9d9"];

/**
 * @enum {string}
 */
epiviz.Config.VisualizationPropertySettings = {
  WIDTH: 'width',
  HEIGHT: 'height',
  MARGINS: 'margins',
  COLORS: 'colors',
  DECORATIONS: 'decorations'
};

// Input 22
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/11/14
 * Time: 12:01 PM
 */

goog.provide('epiviz.ui.LocationManager');

goog.require('epiviz.events.Event');
goog.require('epiviz.datatypes.GenomicRange');

/**
 * @param {epiviz.Config} config
 * @constructor
 */
epiviz.ui.LocationManager = function(config) {
  /**
   * @type {Object.<string, epiviz.datatypes.SeqInfo>}
   * @private
   */
  this._seqInfos = {};

  /**
   * @type {epiviz.datatypes.GenomicRange}
   * @private
   */
  this._currentLocation = null;

  /**
   * @type {?epiviz.datatypes.GenomicRange}
   * @private
   */
  this._lastUnfilledRequest = null;

  /**
   * @type {?number}
   * @private
   */
  this._timeout = null;

  /**
   * @type {number}
   * @private
   */
  this._navigationDelay = config.navigationDelay;

  /**
   * @type {epiviz.events.Event.<{oldValue: epiviz.datatypes.GenomicRange, newValue: epiviz.datatypes.GenomicRange}>}
   * @private
   */
  this._currentLocationChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<Array.<epiviz.datatypes.SeqInfo>>}
   * @private
   */
  this._seqInfosUpdated = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event}
   * @private
   */
  this._requestSeqInfos = new epiviz.events.Event();
};

epiviz.ui.LocationManager.prototype.initialize = function() {
  this._requestSeqInfos.notify();
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 */
epiviz.ui.LocationManager.prototype.changeCurrentLocation = function(range) {
  if (this._currentLocationChanged.isFiring()) {
    // Event cannot be fired again until it finishes firing;
    // Avoid infinite loops
    return;
  }

  this._lastUnfilledRequest = range;

  if (this._timeout !== null) {
    window.clearTimeout(this._timeout);
    this._timeout = null;
  }

  var self = this;
  var locationChangeFunction = function() {
    var request = self._lastUnfilledRequest;

    if (request === null) { return; }

    self._doChangeCurrentLocation(request);
  };

  if (this._navigationDelay) {
    this._timeout = window.setTimeout(locationChangeFunction, this._navigationDelay);
  } else {
    locationChangeFunction();
  }
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 */
epiviz.ui.LocationManager.prototype._doChangeCurrentLocation = function(range) {
  var oldValue = this._currentLocation;

  var seqName = range.seqName();
  if (!(range.seqName() in this._seqInfos)) {
    if (!oldValue) { return; }
    seqName = oldValue.seqName();
  }

  var start = undefined, end = undefined;
  if (this._seqInfos[seqName] && this._seqInfos[seqName].min != undefined && this._seqInfos[seqName].max != undefined) {
    start = range.start() != undefined && range.start() >= this._seqInfos[seqName].min ? range.start() : this._seqInfos[seqName].min;
    end = range.width() != undefined ? start + range.width() : start + 9999; // TODO: Set this constant somewhere
  }

  if (start != undefined && end != undefined &&
    end > this._seqInfos[seqName].max) {
    start = Math.max(this._seqInfos[seqName].min, this._seqInfos[seqName].max - end + start);
    end = this._seqInfos[seqName].max;
  }

  this._lastUnfilledRequest = null;

  this._currentLocation = epiviz.datatypes.GenomicRange.fromStartEnd(seqName, start, end);

  this._currentLocationChanged.notify({oldValue: oldValue, newValue: this._currentLocation});
};

/**
 * @returns {epiviz.datatypes.GenomicRange}
 */
epiviz.ui.LocationManager.prototype.currentLocation = function() { return this._currentLocation; };

/**
 * @returns {?epiviz.datatypes.GenomicRange}
 */
epiviz.ui.LocationManager.prototype.lastUnfilledLocationChangeRequest = function() { return this._lastUnfilledRequest; };

/**
 * @param {Array.<epiviz.datatypes.SeqInfo>} seqInfos
 */
epiviz.ui.LocationManager.prototype.updateSeqInfos = function(seqInfos) {
  this._seqInfos = {};
  for (var i = 0; i < seqInfos.length; ++i) {
    this._seqInfos[seqInfos[i].seqName] = seqInfos[i];
  }

  this._seqInfosUpdated.notify(seqInfos);

  if (this._lastUnfilledRequest !== null) {
    if (this._lastUnfilledRequest.seqName() in this._seqInfos) {
      this._doChangeCurrentLocation(this._lastUnfilledRequest);
    } else if (seqInfos.length > 0) {
      var request = new epiviz.datatypes.GenomicRange(seqInfos[0].seqName, this._lastUnfilledRequest.start(), this._lastUnfilledRequest.width());
      this._doChangeCurrentLocation(request);
    }
  }
};

/**
 * @param {Array.<epiviz.datatypes.SeqInfo>} seqInfos
 */
epiviz.ui.LocationManager.prototype.addSeqInfos = function(seqInfos) {
  for (var i = 0; i < seqInfos.length; ++i) {
    if (!this._seqInfos[seqInfos[i].seqName]) {
      this._seqInfos[seqInfos[i].seqName] = seqInfos[i];
    }
  }

  var eventSeqInfos = [];
  for (var seqName in this._seqInfos) {
    if (!this._seqInfos.hasOwnProperty(seqName)) { continue; }
    eventSeqInfos.push(this._seqInfos[seqName]);
  }

  this._seqInfosUpdated.notify(eventSeqInfos);
};

/**
 * @param {Array.<string>} seqNames
 */
epiviz.ui.LocationManager.prototype.removeSeqNames = function(seqNames) {

  for (var i = 0; i < seqNames.length; ++i) {
    delete this._seqInfos[seqNames[i]];
  }

  var eventSeqInfos = [];
  for (var seqName in this._seqInfos) {
    if (!this._seqInfos.hasOwnProperty(seqName)) { continue; }
    eventSeqInfos.push(this._seqInfos[seqName]);
  }

  this._seqInfosUpdated.notify(eventSeqInfos);

  if (!(this._currentLocation.seqName() in this._seqInfos)) {
    this.changeCurrentLocation(new epiviz.datatypes.GenomicRange(
      eventSeqInfos[0].seqName,
      this._currentLocation.start(),
      this._currentLocation.width()));
  }
};

/**
 * @returns {Object.<string, epiviz.datatypes.SeqInfo>}
 */
epiviz.ui.LocationManager.prototype.seqInfos = function() { return this._seqInfos; };

/**
 * @returns {epiviz.events.Event.<{oldValue: epiviz.datatypes.GenomicRange, newValue: epiviz.datatypes.GenomicRange}>}
 */
epiviz.ui.LocationManager.prototype.onCurrentLocationChanged = function() { return this._currentLocationChanged; };

/**
 * @returns {epiviz.events.Event.<Array.<epiviz.datatypes.SeqInfo>>}
 */
epiviz.ui.LocationManager.prototype.onSeqInfosUpdated = function() { return this._seqInfosUpdated; };

/**
 * @returns {epiviz.events.Event}
 */
epiviz.ui.LocationManager.prototype.onRequestSeqInfos = function() { return this._requestSeqInfos; };

// Input 23
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/28/14
 * Time: 12:04 PM
 */

goog.provide('epiviz.measurements.MeasurementsManager');

goog.require('epiviz.events.Event');
goog.require('epiviz.measurements.MeasurementSet');

/**
 * @constructor
 */
epiviz.measurements.MeasurementsManager = function() {
  /**
   * @type {epiviz.events.Event}
   * @private
   */
  this._requestMeasurements = new epiviz.events.Event();

  /**
   * Fires when new measurements are added in a data provider or
   * a computed measurement is created.
   * @type {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
   * @private
   */
  this._measurementsAdded = new epiviz.events.Event();

  /**
   * Fires when a data provider removes a measurement or a computed
   * measurement is removed.
   * @type {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
   * @private
   */
  this._measurementsRemoved = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
   * @private
   */
  this._computedMeasurementsAdded = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
   * @private
   */
  this._computedMeasurementsRemoved = new epiviz.events.Event();

  /**
   * Contains all measurements, including computed ones
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._measurements = new epiviz.measurements.MeasurementSet();

  /**
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._computedMeasurements = new epiviz.measurements.MeasurementSet();
};

/**
 */
epiviz.measurements.MeasurementsManager.prototype.initialize = function() {
  this._requestMeasurements.notify();
};

/**
 * @returns {epiviz.events.Event}
 */
epiviz.measurements.MeasurementsManager.prototype.onRequestMeasurements = function() { return this._requestMeasurements; };

/**
 * @returns {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
 */
epiviz.measurements.MeasurementsManager.prototype.onMeasurementsAdded = function() { return this._measurementsAdded; };

/**
 * @returns {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
 */
epiviz.measurements.MeasurementsManager.prototype.onMeasurementsRemoved = function() { return this._measurementsRemoved; };

/**
 * @returns {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
 */
epiviz.measurements.MeasurementsManager.prototype.onComputedMeasurementsAdded = function() { return this._computedMeasurementsAdded; };

/**
 * @returns {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
 */
epiviz.measurements.MeasurementsManager.prototype.onComputedMeasurementsRemoved = function() { return this._computedMeasurementsRemoved; };

/**
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.measurements.MeasurementsManager.prototype.measurements = function() { return this._measurements; };

/**
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.measurements.MeasurementsManager.prototype.computedMeasurements = function() { return this._computedMeasurements; };

/**
 * @param {epiviz.measurements.MeasurementSet} measurements
 */
epiviz.measurements.MeasurementsManager.prototype.addMeasurements = function(measurements) {
  if (!measurements || !measurements.size()) { return; } // No measurements to add

  var self = this;
  this._measurements.addAll(measurements);

  var computedMeasurements = new epiviz.measurements.MeasurementSet();

  measurements.foreach(function(m) {
    if (m.isComputed()) {
      computedMeasurements.add(m);
      self._computedMeasurements.add(m);
    }
  });

  this._measurementsAdded.notify(measurements);

  if (computedMeasurements.size() > 0) {
    this._computedMeasurementsAdded.notify(computedMeasurements);
  }
};

/**
 * @param {epiviz.measurements.MeasurementSet} measurements
 */
epiviz.measurements.MeasurementsManager.prototype.removeMeasurements = function(measurements) {
  var self = this;
  this._measurements.removeAll(measurements);

  var computedMeasurements = new epiviz.measurements.MeasurementSet();
  measurements.foreach(function(m) {
    if (m.isComputed()) {
      computedMeasurements.add(m);
      self._computedMeasurements.remove(m);
    }
  });

  this._measurementsRemoved.notify(measurements);

  if (computedMeasurements.size() > 0) {
    this._computedMeasurementsRemoved.notify(computedMeasurements);
  }
};

/**
 * @param {epiviz.measurements.Measurement} measurement
 */
epiviz.measurements.MeasurementsManager.prototype.addMeasurement = function(measurement) {
  var measurements = new epiviz.measurements.MeasurementSet();
  measurements.add(measurement);

  this.addMeasurements(measurements);
};

/**
 * @param {epiviz.measurements.Measurement} measurement
 */
epiviz.measurements.MeasurementsManager.prototype.removeMeasurement = function(measurement) {
  var measurements = new epiviz.measurements.MeasurementSet();
  measurements.add(measurement);

  this.removeMeasurements(measurements);
};

// Input 24
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/27/2015
 * Time: 9:47 AM
 */

goog.provide('caja');
goog.provide('epiviz.caja');

goog.require('epiviz.deferred.Deferred');
// goog.require('epiviz.utils.fillArray');
goog.require('epiviz.utils');


caja.initialize = function() {};

/**
 * @param {string} funcStr
 * @param {Object.<string, *>} [args]
 * @returns {epiviz.deferred.Deferred.<function>}
 */
epiviz.caja.cajole = function(funcStr, args) {
  var deferred = new epiviz.deferred.Deferred();

  setTimeout(function() {
    deferred.resolve(eval('(' + funcStr + ')'));
  }, 0);

  return deferred;
};

/**
 * @param {string} scriptUrl
 * @param {Object.<string, *>} [args]
 * @returns {epiviz.deferred.Deferred}
 */
epiviz.caja.run = function(scriptUrl, args) {
  var deferred = new epiviz.deferred.Deferred();

  setTimeout(function() {
    // Adding the script tag to the head as suggested before
    var head = document.getElementsByTagName('head')[0];
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = scriptUrl;

    // Then bind the event to the callback function.
    // There are several events for cross browser compatibility.
    script.onreadystatechange = script.onload = function() {
      deferred.resolve();
    };

    // Fire the loading
    head.appendChild(script);
  }, 0);

  return deferred;
};

/**
 * @param {Array.<string>} scriptUrls
 * @param {Array.<Object.<string, *>>|Object.<string, *>} [args]
 * @returns {epiviz.deferred.Deferred}
 */
epiviz.caja.chain = function(scriptUrls, args) {
  if (!$.isArray(args)) {
    args = epiviz.utils.fillArray(scriptUrls.length, args);
  }
  return epiviz.utils.deferredFor(scriptUrls.length, function(j) {
    return epiviz.caja.run(scriptUrls[j], args[j]);
  });
};

/**
 * @returns {Object.<string, *>}
 */
epiviz.caja.buildChartMethodContext = function() {
  return {
    epiviz: {
      ui: {
        charts: epiviz.ui.charts,
        controls: epiviz.ui.controls
      },
      utils: epiviz.utils,
      plugins: epiviz.plugins,
      measurements: epiviz.measurements,
      events: epiviz.events,
      deferred: epiviz.deferred,
      datatypes: epiviz.datatypes,
      data: {
        DataProvider: epiviz.data.DataProvider,
        Request: epiviz.data.Request,
        Response: epiviz.data.Response,
        WebServerDataProvider: {
          // TODO: In the future, restrict the access to this method, as it can be a risk factor
          // TODO: For now, it is kept here for DataProvider plugins
          makeGetRequest: epiviz.data.WebServerDataProvider.makeGetRequest
        }
      },
      Config: epiviz.Config
    },
    d3: d3,
    $: $,
    sprintf: sprintf,
    goog: goog
  };
};

// Input 25
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/29/14
 * Time: 2:52 PM
 */

goog.provide('epiviz.ui.charts.CustomSetting');

/**
 * @param {string} id
 * @param {epiviz.ui.charts.CustomSetting.Type} type
 * @param defaultValue
 * @param {string} [label]
 * @param {Array} [possibleValues]
 * @constructor
 * @struct
 */
epiviz.ui.charts.CustomSetting = function(id, type, defaultValue, label, possibleValues) {
  /**
   * @type {string}
   */
  this.id = id;

  /**
   * @type {epiviz.ui.charts.CustomSetting.Type}
   */
  this.type = type;

  this.defaultValue = defaultValue;

  /**
   * @type {string}
   */
  this.label = label || id;

  /**
   * @type {Array}
   */
  this.possibleValues = possibleValues || null;
};

/**
 * @enum {string}
 */
epiviz.ui.charts.CustomSetting.Type = {
  NUMBER: 'number',
  STRING: 'string',
  ARRAY: 'array',
  BOOLEAN: 'boolean',
  CATEGORICAL: 'categorical',
  MEASUREMENTS_METADATA: 'measurementsMetadata',
  MEASUREMENTS_ANNOTATION: 'measurementsAnnotation'
};

/**
 * @type {string}
 * @constant
 */
epiviz.ui.charts.CustomSetting.DEFAULT = 'default';

// Input 26
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/15/2014
 * Time: 9:19 AM
 */

goog.provide('epiviz.ui.charts.VisEventArgs');

/**
 * @param {string} id The id of the visualization
 * @param {T} [args] The custom event arguments
 * @constructor
 * @struct
 * @template T
 */
epiviz.ui.charts.VisEventArgs = function(id, args) {
  /**
   * @type {string}
   */
  this.id = id;

  /**
   * @type {T}
   */
  this.args = args;
};

// Input 27
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/22/13
 * Time: 8:37 PM
 */

goog.provide('epiviz.ui.charts.Axis');

/**
 * @enum {string}
 */
epiviz.ui.charts.Axis = {
  X: 'x',
  Y: 'y'
};

// Input 28
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/22/13
 * Time: 8:34 PM
 */

goog.provide('epiviz.ui.charts.Margins');

goog.require('epiviz.ui.charts.Axis');

/**
 * @param {number} top
 * @param {number} left
 * @param {number} bottom
 * @param {number} right
 * @constructor
 */
epiviz.ui.charts.Margins = function(top, left, bottom, right) {
  /**
   * @type {number}
   * @private
   */
  this._top = top;

  /**
   * @type {number}
   * @private
   */
  this._left = left;

  /**
   * @type {number}
   * @private
   */
  this._bottom = bottom;

  /**
   * @type {number}
   * @private
   */
  this._right = right;
};

/**
 * @type {epiviz.ui.charts.Margins}
 * @const
 */
epiviz.ui.charts.Margins.ZERO_MARGIN = new epiviz.ui.charts.Margins(0, 0, 0, 0);

/**
 * @returns {number}
 */
epiviz.ui.charts.Margins.prototype.top = function() { return this._top; };

/**
 * @returns {number}
 */
epiviz.ui.charts.Margins.prototype.left = function() { return this._left; };

/**
 * @returns {number}
 */
epiviz.ui.charts.Margins.prototype.bottom = function() { return this._bottom; };

/**
 * @returns {number}
 */
epiviz.ui.charts.Margins.prototype.right = function() { return this._right; };

/**
 * @param {epiviz.ui.charts.Axis} axis
 * @returns {number}
 */
epiviz.ui.charts.Margins.prototype.sumAxis = function(axis) {
  switch (axis) {
    case epiviz.ui.charts.Axis.X: return this._left + this._right;
    case epiviz.ui.charts.Axis.Y: return this._top + this._bottom;
    default: throw Error('Invalid argument: ' + axis);
  }
};

/**
 * @returns {{top: number, left: number, bottom: number, right: number}}
 */
epiviz.ui.charts.Margins.prototype.raw = function() {
  return {
    top: this._top,
    left: this._left,
    bottom: this._bottom,
    right: this._right
  };
};

/**
 * @param {{top: number, left: number, bottom: number, right: number}} o
 * @returns {epiviz.ui.charts.Margins}
 */
epiviz.ui.charts.Margins.fromRawObject = function(o) {
  return new epiviz.ui.charts.Margins(o.top, o.left, o.bottom, o.right);
};

/**
 * @returns {epiviz.ui.charts.Margins}
 */
epiviz.ui.charts.Margins.prototype.copy = function() {
  return new epiviz.ui.charts.Margins(this._top, this._left, this._bottom, this._right);
};

/**
 * @param {epiviz.ui.charts.Margins} other
 * @returns {boolean}
 */
epiviz.ui.charts.Margins.prototype.equals = function(other) {
  if (!other) { return false; }
  if (this == other) { return true; }
  return (this._top == other._top && this._left == other._left && this._bottom == other._bottom && this._right == other._right);
};

// Input 29
/**
 * Created by: Florin Chelaru
 * Date: 11/22/14
 * Time: 12:43 PM
 */

goog.provide('epiviz.ui.charts.VisualizationType');
goog.provide('epiviz.ui.charts.VisualizationType.DisplayType');

goog.require('epiviz.ui.charts.Visualization');
goog.require('epiviz.Config');
goog.require('epiviz.utils');
goog.require('epiviz.ui.charts.CustomSetting');

/**
 * Abstract class
 * @param {epiviz.Config} config
 * @constructor
 */
epiviz.ui.charts.VisualizationType = function(config) {

  var VisualizationPropertySettings = epiviz.Config.VisualizationPropertySettings;

  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {Object.<epiviz.Config.VisualizationPropertySettings|string, *>}
   * @protected
   */
  this._defaultSettings = epiviz.utils.mapCombine(
    epiviz.utils.mapCombine(config.chartSettings[this.typeName()], config.chartSettings[this.chartDisplayType()], true),
    config.chartSettings['default'], true);

  /**
   * @type {string|number}
   * @private
   */
  this._defaultWidth = this._defaultSettings[VisualizationPropertySettings.WIDTH];

  /**
   * @type {string|number}
   * @private
   */
  this._defaultHeight = this._defaultSettings[VisualizationPropertySettings.HEIGHT];

  /**
   * @type {epiviz.ui.charts.Margins}
   * @private
   */
  this._defaultMargins = this._defaultSettings[VisualizationPropertySettings.MARGINS];

  /**
   * @type {epiviz.ui.charts.ColorPalette}
   * @private
   */
  this._defaultColors = config.colorPalettesMap[this._defaultSettings[VisualizationPropertySettings.COLORS]];

  /**
   * @type {Array.<string>}
   * @private
   */
  this._decorations = this._defaultSettings[VisualizationPropertySettings.DECORATIONS];

  /**
   * @type {?Object.<string, *>}
   * @private
   */
  this._customSettingsValues = config.chartCustomSettings[this.typeName()] || null;
};

/**
 * @enum {string}
 */
epiviz.ui.charts.VisualizationType.DisplayType = {
  PLOT: 'plot',
  TRACK: 'track',
  DATA_STRUCTURE: 'data-structure'
};

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.ui.charts.Chart}
 */
epiviz.ui.charts.VisualizationType.prototype.createNew = function(id, container, properties) { throw Error('unimplemented abstract method'); };

/**
 * @returns {string} The fully qualified type name of the chart
 */
epiviz.ui.charts.VisualizationType.prototype.typeName = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string}
 */
epiviz.ui.charts.VisualizationType.prototype.chartName = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string} a string to be used for html id attributes of
 *   elements containing this chart type
 */
epiviz.ui.charts.VisualizationType.prototype.chartHtmlAttributeName = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.VisualizationType.prototype.chartDisplayType = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.ui.charts.VisualizationType.prototype.measurementsFilter = function() { return function(m) { return true; }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.ui.charts.VisualizationType.prototype.isRestrictedToSameDatasourceGroup = function() { return false; };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.VisualizationType.prototype.isRestrictedToRangeMeasurements = function() { return false; };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.VisualizationType.prototype.isRestrictedToFeatureMeasurements = function() { return !this.isRestrictedToRangeMeasurements(); };

/**
 * Gets the minimum number of measurements that must be selected for the chart to be displayed
 * @returns {number}
 */
epiviz.ui.charts.VisualizationType.prototype.minSelectedMeasurements = function() { return 1; };

/**
 * @returns {string}
 */
epiviz.ui.charts.VisualizationType.prototype.chartContainer = function() {
  return epiviz.ui.ControlManager.CHART_TYPE_CONTAINERS[this.chartDisplayType()];
};

/**
 * @returns {string}
 */
epiviz.ui.charts.VisualizationType.prototype.cssClass = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {number|string}
 */
epiviz.ui.charts.VisualizationType.prototype.defaultWidth = function() { return this._defaultWidth; };

/**
 * @returns {number|string}
 */
epiviz.ui.charts.VisualizationType.prototype.defaultHeight = function() { return this._defaultHeight; };

/**
 * @returns {epiviz.ui.charts.Margins}
 */
epiviz.ui.charts.VisualizationType.prototype.defaultMargins = function() { return this._defaultMargins; };

/**
 * @returns {epiviz.ui.charts.ColorPalette}
 */
epiviz.ui.charts.VisualizationType.prototype.defaultColors = function() { return this._defaultColors; };

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.VisualizationType.prototype.decorations = function() { return this._decorations; };

/**
 * @returns {?Object.<string, *>}
 */
epiviz.ui.charts.VisualizationType.prototype.customSettingsValues = function() { return this._customSettingsValues; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.ui.charts.VisualizationType.prototype.customSettingsDefs = function() {
  return [
    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.TITLE,
      epiviz.ui.charts.CustomSetting.Type.STRING,
      '',
      'Title'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.MARGIN_TOP,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      this._defaultMargins.top(),
      'Top margin'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.MARGIN_BOTTOM,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      this._defaultMargins.bottom(),
      'Bottom margin'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.MARGIN_LEFT,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      this._defaultMargins.left(),
      'Left margin'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.MARGIN_RIGHT,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      this._defaultMargins.right(),
      'Right margin')
  ];
};

// Input 30
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/16/2015
 * Time: 6:58 PM
 */

goog.provide('epiviz.ui.charts.markers.MeasurementAggregator');

/**
 * @param {string} [id]
 * @param {function(string, Array.<epiviz.measurements.Measurement>, Array.<number>): {value: number, errMinus: number=, errPlus: number=}} aggregator
 * @constructor
 */
epiviz.ui.charts.markers.MeasurementAggregator = function(id, aggregator) {
  /**
   * @type {string}
   * @private
   */
  this._id = id;

  /**
   * @type {function(string, Array.<epiviz.measurements.Measurement>, Array.<number>): {value: number, errMinus?: number, errPlus?: number}}
   * @private
   */
  this._aggregator = aggregator;
};

/**
 * @param {string} label
 * @param {Array.<epiviz.measurements.Measurement>} measurements
 * @param {Array.<number>} values
 * @returns {{value: number, errMinus?: number, errPlus?: number}}
 */
epiviz.ui.charts.markers.MeasurementAggregator.prototype.aggregate = function(label, measurements, values) {
  return this._aggregator(label, measurements, values);
};

/**
 * @returns {string}
 */
epiviz.ui.charts.markers.MeasurementAggregator.prototype.id = function() { return this._id; };

/**
 * @type{Object.<string, epiviz.ui.charts.markers.MeasurementAggregator>}
 */
epiviz.ui.charts.markers.MeasurementAggregators = {
  'mean-stdev': new epiviz.ui.charts.markers.MeasurementAggregator('mean-stdev', function(label, measurements, values) {
    if (!values || values.length == 0) { return null; }
    var mean = values.reduce(function(v1, v2) { return v1 + v2; }) / values.length;
    var variance = values
        .map(function(v) { return (v - mean) * (v - mean); })
        .reduce(function(v1, v2) { return v1 + v2; }) / values.length;
    var stdev = Math.sqrt(variance);
    return { value: mean, errMinus: mean - stdev, errPlus: mean + stdev };
  }),

  'quartiles': new epiviz.ui.charts.markers.MeasurementAggregator('quartiles', function(label, measurements, values) {
    if (!values || values.length == 0) { return null; }
    values = values.slice(0).sort(function(v1, v2) { return v1 - v2; });
    var n = values.length;
    var m1 = Math.floor(n * 0.5);
    var m2 = Math.ceil(n * 0.5);
    var q2 = (values[Math.floor((n - 1) * 0.5)] + values[m1]) * 0.5;
    var q1 = (values[Math.floor((m1 - 1) * 0.5)] + values[Math.floor(m1 * 0.5)]) * 0.5;
    var q3 = (values[m2 + Math.floor((n - m2 - 1) * 0.5)] + values[m2 + Math.floor((n - m2) * 0.5)]) * 0.5;

    return { value: q2, errMinus: q1, errPlus: q3 };
  }),

  'count': new epiviz.ui.charts.markers.MeasurementAggregator('count', function(label, measurements, values) {
    if (!values || values.length == 0) { return 0; }
    return { value: values.length };
  }),

  'min': new epiviz.ui.charts.markers.MeasurementAggregator('min', function(label, measurements, values) {
    if (!values || values.length == 0) { return null; }
    return { value: Math.min.apply(undefined, values) };
  }),

  'max': new epiviz.ui.charts.markers.MeasurementAggregator('max', function(label, measurements, values) {
    if (!values || values.length == 0) { return null; }
    return { value: Math.max.apply(undefined, values) };
  }),

  'sum': new epiviz.ui.charts.markers.MeasurementAggregator('sum', function(label, measurements, values) {
    if (!values || values.length == 0) { return null; }
    return { value: values.reduce(function(v1, v2) { return v1 + v2; }) };
  })
};

// Input 31
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 11:02 PM
 */

goog.provide('epiviz.ui.charts.ChartType');

goog.require('epiviz.ui.charts.VisualizationType');
goog.require('epiviz.ui.charts.markers.MeasurementAggregator');
goog.require('epiviz.ui.charts.CustomSetting');

/**
 * Abstract class
 * @param {epiviz.Config} config
 * @constructor
 * @extends {epiviz.ui.charts.VisualizationType}
 */
epiviz.ui.charts.ChartType = function(config) {
  epiviz.ui.charts.VisualizationType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.ChartType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.VisualizationType.prototype);
epiviz.ui.charts.ChartType.constructor = epiviz.ui.charts.ChartType;

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.ui.charts.Chart}
 */
epiviz.ui.charts.ChartType.prototype.createNew = function(id, container, properties) { throw Error('unimplemented abstract method'); };

epiviz.ui.charts.ChartType.prototype.customSettingsDefs = function() {
  var defs = epiviz.ui.charts.VisualizationType.prototype.customSettingsDefs.call(this);
  if (this.isRestrictedToRangeMeasurements()) { return defs; }

  var aggregators = Object.keys(epiviz.ui.charts.markers.MeasurementAggregators);

  return defs.concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.ChartType.CustomSettings.MEASUREMENT_GROUPS_AGGREGATOR,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      aggregators[0],
      'Aggregator for measurement groups', aggregators)
  ]);
};

/**
 * @enum {string}
 */
epiviz.ui.charts.ChartType.CustomSettings = {
  MEASUREMENT_GROUPS_AGGREGATOR: 'measurementGroupsAggregator'
};

// Input 32
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/15/2014
 * Time: 9:05 AM
 */

goog.provide('epiviz.ui.charts.Visualization');

goog.require('epiviz.caja');
goog.require('epiviz.deferred.Deferred');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.events.Event');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.ui.charts.Margins');
goog.require('epiviz.ui.charts.ChartType');

/**
 * Uses data of T type for drawing objects of a subtype of epiviz.ui.charts.VisObject
 * @param {string} id
 * @param {jQuery} container The div where the visualization will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @constructor
 * @template T
 */
epiviz.ui.charts.Visualization = function(id, container, properties) {
  /**
   * @type {string}
   * @private
   */
  this._id = id;

  /**
   * @type {jQuery}
   * @private
   */
  this._container = container;

  /**
   * @type {epiviz.ui.charts.VisualizationProperties}
   * @private
   */
  this._properties = properties;

  /**
   * @type {Object.<string, function>}
   * @private
   */
  this._originalMethods = {};

  /**
   * @type {boolean}
   * @private
   */
  this._hasModifiedMethods = false;

  /**
   * @type {string}
   * @private
   */
  this._lastModifiedMethod = 'draw';

  var self = this;
  if (properties.modifiedMethods) {
    var methodsUpdated = new epiviz.deferred.Deferred();
    var modifiedMethods = properties.modifiedMethods;
    var modifiedMethodNames = Object.keys(modifiedMethods);
    var cajoledMethods = {};
    var nMethodsUpdated = 0;
    for (var m in modifiedMethods) {
      if (!modifiedMethods.hasOwnProperty(m)) { continue; }
      if (m == '_setModifiedMethods') { continue; } // Ignore modifications to this method
      (function(m) {
        epiviz.caja.cajole(modifiedMethods[m], epiviz.caja.buildChartMethodContext()).done(function(method) {
          if (!method) { return; }
          cajoledMethods[m] = method;
          nMethodsUpdated += 1;
          if (nMethodsUpdated >= modifiedMethodNames.length) {
            methodsUpdated.resolve();
          }
        });
      })(m);
    }
    methodsUpdated.done(function() {
      for (var m in cajoledMethods) {
        if (!cajoledMethods.hasOwnProperty(m)) { continue; }
        self._originalMethods[m] = self[m];
        self[m] = cajoledMethods[m];
        self._lastModifiedMethod = m;
      }
      self._hasModifiedMethods = true;
      self.draw();
    });
  }

  /**
   * @type {Object.<string, *>}
   * @private
   */
  this._customSettingsValues = {};
  for (var i = 0; i < properties.customSettingsDefs.length; ++i) {
    var setting = properties.customSettingsDefs[i];
    var val = properties.customSettingsValues[setting.id];
    switch (setting.type) {
      case epiviz.ui.charts.CustomSetting.Type.BOOLEAN:
        this._customSettingsValues[setting.id] = (val === false || val) ? val : setting.defaultValue;
        break;
      case epiviz.ui.charts.CustomSetting.Type.NUMBER:
        this._customSettingsValues[setting.id] = (val === 0 || val) ? val : setting.defaultValue;
        break;
      case epiviz.ui.charts.CustomSetting.Type.STRING:
        this._customSettingsValues[setting.id] = (val === '' || val) ? val : setting.defaultValue;
        break;
      case epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_METADATA:
        var possibleValues = {};
        properties.visConfigSelection.measurements.foreach(function(m) {
          m.metadata().forEach(function(metadataCol) { possibleValues[metadataCol] = metadataCol; });
        });
        setting.possibleValues = Object.keys(possibleValues);
        setting.possibleValues.sort();
        val = val || setting.defaultValue;
        this._customSettingsValues[setting.id] = (val in possibleValues) ?
          val : ((setting.possibleValues.length) ? setting.possibleValues[0] : '');
        break;
      case epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_ANNOTATION:
        var possibleValues = {name: 'name'};
        properties.visConfigSelection.measurements.foreach(function(m) {
          var anno = m.annotation();
          if (!anno) { return; }
          Object.keys(anno).forEach(function(key) { possibleValues[key] = key; });
        });
        setting.possibleValues = Object.keys(possibleValues);
        setting.possibleValues.sort();
        val = val || setting.defaultValue;
        this._customSettingsValues[setting.id] = (val in possibleValues) ?
          val : ((setting.possibleValues.length) ? setting.possibleValues[0] : '');
        break;
      default:
        this._customSettingsValues[setting.id] = val || setting.defaultValue;
        break;
    }
  }

  /**
   * @type {string}
   * @private
   */
  this._svgId = sprintf('%s-svg', this._id);

  /**
   * The D3 svg handler for the visualization
   * @protected
   */
  this._svg = null;

  /**
   * @type {?T}
   * @protected
   */
  this._unalteredData = null;

  /**
   * @type {?T}
   * @protected
   */
  this._lastData = null;

  /**
   * @type {epiviz.datatypes.Range}
   * @protected
   */
  this._lastRange = null;

  /**
   * @type {number}
   * @protected
   */
  this._slide = 0;

  /**
   * @type {number}
   * @protected
   */
  this._zoom = 1;

  /**
   * @type {Array.<epiviz.ui.charts.markers.VisualizationMarker>}
   * @protected
   */
  this._markers = properties.chartMarkers;

  /**
   * @type {Object.<string, epiviz.ui.charts.markers.VisualizationMarker>}
   * @protected
   */
  this._markersMap = {};

  /**
   * @type {Object.<string, number>}
   * @private
   */
  this._markersIndices = {};

  this._markers.forEach(function(marker, i) {
    if (!marker) { return; }
    self._markersMap[marker.id()] = marker;
    self._markersIndices[marker.id()] = i;
  });

  /**
   * @type {boolean}
   */
  this._autoPropagateChanges = true;

  // Events

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.VisObject>>}
   * @protected
   */
  this._hover = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @protected
   */
  this._unhover = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.VisObject>>}
   * @protected
   */
  this._select = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @protected
   */
  this._deselect = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @private
   */
  this._save = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @private
   */
  this._remove = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.ColorPalette>>}
   * @protected
   */
  this._colorsChanged = new epiviz.events.Event();

  /**
   * Event arg: a map of method -> code
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, string>>>}
   * @private
   */
  this._methodsModified = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @private
   */
  this._methodsReset = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Array.<epiviz.ui.charts.markers.VisualizationMarker>>>}
   * @private
   */
  this._markersModified = new epiviz.events.Event();

  /**
   * Event arg: custom settings values setting -> value
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, *>>>}
   * @private
   */
  this._customSettingsChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{width: number|string, height: number|string}>>}
   * @private
   */
  this._sizeChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.Margins>>}
   * @private
   */
  this._marginsChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @private
   */
  this._dataWaitStart = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @protected
   */
  this._dataWaitEnd = new epiviz.events.Event();
};

/**
 * @type {number}
 * @constant
 */
epiviz.ui.charts.Visualization.SVG_MARGIN = 20;

/**
 * Initializes the visualization and draws the initial SVG in the container
 * @protected
 */
epiviz.ui.charts.Visualization.prototype._initialize = function() {
  if (this._properties.height == '100%') { this._properties.height = this._container.height() - epiviz.ui.charts.Visualization.SVG_MARGIN; }
  if (this._properties.width == '100%') { this._properties.width = this._container.width() - epiviz.ui.charts.Visualization.SVG_MARGIN; }

  var width = this.width();
  var height = this.height();

  this._container.addClass('visualization-container');

  this._container.append(sprintf('<svg id="%s" class="visualization" width="%s" height="%s"><style type="text/css"></style><defs></defs></svg>', this._svgId, width, height));
  this._svg = d3.select('#' + this._svgId);

  var jSvg = $('#' + this._svgId);

  /**
   * The difference in size between the container and the inner SVG
   * @type {number}
   * @private
   */
  this._widthDif = jSvg.width() - (this._container.width() - epiviz.ui.charts.Visualization.SVG_MARGIN);

  /**
   * The difference in size between the container and the inner SVG
   * @type {number}
   * @private
   */
  this._heightDif = height - (this._container.height() - epiviz.ui.charts.Visualization.SVG_MARGIN);

  this._properties.width = width;
  this._properties.height = height;

  var self = this;
  this._container.click(function() { self._deselect.notify(new epiviz.ui.charts.VisEventArgs(self._id)); });
};

/**
 * @param [svg] D3 svg container for the axes
 * @protected
 */
epiviz.ui.charts.Visualization.prototype._clearAxes = function(svg) {
  svg = svg || this._svg;
  svg.selectAll('.xAxis').remove();
  svg.selectAll('.yAxis').remove();
};

/**
 * @param [xScale] D3 linear scale for the x axis
 * @param [yScale] D3 linear scale for the y axis
 * @param {number} [xTicks]
 * @param {number} [yTicks]
 * @param [svg] D3 svg container for the axes
 * @param {number} [width]
 * @param {number} [height]
 * @param {epiviz.ui.charts.Margins} [margins]
 * @param {function} [xAxisFormat]
 * @param {function} [yAxisFormat]
 * @param {Array.<string>} [xLabels]
 * @param {Array.<string>} [yLabels]
 * @param {boolean} [xLabelsBtTicks]
 * @param {boolean} [yLabelsBtTicks]
 * @protected
 */
epiviz.ui.charts.Visualization.prototype._drawAxes = function (xScale, yScale, xTicks, yTicks, svg, width, height, margins, xAxisFormat, yAxisFormat, xLabels, yLabels, xLabelsBtTicks, yLabelsBtTicks) {

  svg = svg || this._svg;
  margins = margins || this.margins();
  height = height || this.height();
  width = width || this.width();

  var axesGroup = svg.select('.axes'),
    xAxisGrid = axesGroup.select('.xAxis-grid'),
    yAxisGrid = axesGroup.select('.yAxis-grid'),
    xAxisLine = axesGroup.select('.xAxis-line'),
    yAxisLine = axesGroup.select('.yAxis-line');

  if (axesGroup.empty()) { axesGroup = svg.append('g').attr('class', 'axes'); }

  if (xAxisGrid.empty()) { xAxisGrid = axesGroup.append('g').attr('class', 'xAxis xAxis-grid'); }
  if (yAxisGrid.empty()) { yAxisGrid = axesGroup.append('g').attr('class', 'yAxis yAxis-grid'); }
  if (xAxisLine.empty()) { xAxisLine = axesGroup.append('g').attr('class', 'xAxis xAxis-line'); }
  if (yAxisLine.empty()) { yAxisLine = axesGroup.append('g').attr('class', 'yAxis yAxis-line'); }

  if (xScale) {
    // Draw X-axis grid lines
    xAxisGrid
      .attr('transform', 'translate(' + margins.left() + ', ' + margins.top() + ')')
      .selectAll('line.x')
      .data(xScale.ticks(xTicks))
      .enter().append('line')
      .attr('x1', xScale)
      .attr('x2', xScale)
      .attr('y1', 0)
      .attr('y2', height - margins.top() - margins.bottom())
      .style('stroke', '#eeeeee')
      .style('shape-rendering', 'crispEdges');

    var xAxisTickFormat = xAxisFormat ||
      ((xLabels) ?
        function(i) { return xLabels[i]; } :
        function(x) {
          var format = d3.format('s');
          var rounded = Math.round(x * 1000) / 1000;
          return format(rounded);
        });

    var xAxis = d3.svg.axis()
      .scale(xScale)
      .orient('bottom')
      .ticks(xTicks)
      .tickFormat(xAxisTickFormat);

    xAxisLine
      .attr('transform', 'translate(' + margins.left() + ', ' + (height - margins.bottom()) + ')')
      .call(xAxis);

    if (xLabels) {
      var xTransform = 'rotate(-90)';
      if (xLabelsBtTicks) { xTransform += 'translate(0,' + (xScale(0.5) - xScale(0)) + ')'; }
      xAxisLine
      .selectAll('text')
      .style('text-anchor', 'end')
      .attr('dx', '-.8em')
      .attr('dy', '-0.5em')
      .attr('transform', xTransform);
    }
  }

  if (yScale) {
    // Draw Y-axis grid lines
    yAxisGrid
      .attr('transform', 'translate(' + margins.left() + ', ' + margins.top() + ')')
      .selectAll('line.y')
      .data(yScale.ticks(yTicks - 1))
      .enter().append('line')
      .attr('x1', 0)
      .attr('x2', width - margins.left() - margins.right())
      .attr('y1', yScale)
      .attr('y2', yScale)
      .style('stroke', '#eeeeee')
      .style('shape-rendering', 'crispEdges');

    var yAxisTickFormat = (yLabels) ? function(i) { return yLabels[i]; } :
      function(y) {
        var format = d3.format('s');
        var rounded = Math.round(y * 1000) / 1000;
        return format(rounded);
      };

    var yAxis = d3.svg.axis()
      .ticks(yTicks - 1)
      .scale(yScale)
      .orient('left')
      .tickFormat(yAxisTickFormat);
    yAxisLine
      .attr('transform', 'translate(' + margins.left() + ', ' + margins.top() + ')')
      .call(yAxis);
  }
};

/**
 * @private
 */
epiviz.ui.charts.Visualization.prototype._drawTitle = function() {
  var svgTitle = this._svg.selectAll('.visualization-title');

  var Settings = epiviz.ui.charts.Visualization.CustomSettings;
  var settingsVals = this.customSettingsValues();

  var title = settingsVals[Settings.TITLE];
  if (!title || title.trim() == '') {
    if (!svgTitle.empty()) {
      svgTitle.remove();
    }
    return;
  }

  if (svgTitle.empty()) {
    svgTitle = this._svg.append('text')
      .attr('class', 'visualization-title')
      .attr('text-anchor', 'middle');
  }

  svgTitle
    .attr('x', this.width() * 0.5)
    .attr('y', 25)
    .text(title);
};

/**
 * @param {number} width
 * @param {number} height
 */
epiviz.ui.charts.Visualization.prototype.resize = function(width, height) {
  if (width) { this._properties.width = width; }
  if (height) { this._properties.height = height; }

  this.draw();

  this._sizeChanged.notify(new epiviz.ui.charts.VisEventArgs(this._id, {width: this._properties.width, height: this._properties.height}));
};


/**
 */
epiviz.ui.charts.Visualization.prototype.updateSize = function() {
  this.resize(
    this._widthDif + this._container.width() - epiviz.ui.charts.Visualization.SVG_MARGIN,
    this._heightDif + this._container.height() - epiviz.ui.charts.Visualization.SVG_MARGIN);
};

/**
 * @param {epiviz.datatypes.Range} [range]
 * @param {T} [data]
 * @returns {Array.<epiviz.ui.charts.VisObject>}
 */
epiviz.ui.charts.Visualization.prototype.draw = function(range, data) {

  if (range != undefined) {
    this._lastRange = range;
  }

  if (data != undefined) {
    this._lastData = data;
    this._unalteredData = data;
    this._dataWaitEnd.notify(new epiviz.ui.charts.VisEventArgs(this._id));
  }

  this._svg
    .attr('width', this.width())
    .attr('height', this.height());

  this._drawTitle();

  return [];
};

/* Getters */

/**
 * @returns {jQuery}
 */
epiviz.ui.charts.Visualization.prototype.container = function() { return this._container; };

/**
 * @returns {string}
 */
epiviz.ui.charts.Visualization.prototype.id = function() { return this._id; };

/**
 * @returns {epiviz.ui.charts.VisualizationProperties}
 */
epiviz.ui.charts.Visualization.prototype.properties = function() {
  return this._properties;
};

/**
 * @returns {number}
 */
epiviz.ui.charts.Visualization.prototype.height = function() {
  return this._properties.height;
};

/**
 * @returns {number}
 */
epiviz.ui.charts.Visualization.prototype.width = function() {
  return this._properties.width;
};

/**
 * @returns {epiviz.ui.charts.Margins}
 */
epiviz.ui.charts.Visualization.prototype.margins = function() {
  return this._properties.margins;
};

/**
 * @returns {epiviz.ui.charts.ColorPalette}
 */
epiviz.ui.charts.Visualization.prototype.colors = function() {
  return this._properties.colors;
};

/**
 * @param {epiviz.ui.charts.ColorPalette} colors
 */
epiviz.ui.charts.Visualization.prototype.setColors = function(colors) {
  if (!colors || colors.equals(this._properties.colors)) { return; }
  this._properties.colors = colors;
  this.draw();
  this._colorsChanged.notify(new epiviz.ui.charts.VisEventArgs(this._id, this._properties.colors));
};

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.Visualization.prototype.colorLabels = function() {
  var self = this;
  var colors = new Array(this.measurements().size());
  this.measurements().foreach(
    /**
     * @param {epiviz.measurements.Measurement} m
     * @param {number} i
     */
      function(m, i) {
      colors[i] = m.name();
    });

  return colors;
};

/**
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.ui.charts.Visualization.prototype.measurements = function() {
  return this.properties().visConfigSelection.measurements;
};

/**
 * @returns {Object.<string, *>}
 */
epiviz.ui.charts.Visualization.prototype.customSettingsValues = function() { return this._customSettingsValues; };

/**
 * @param {Object.<string, *>} settingsValues
 */
epiviz.ui.charts.Visualization.prototype.setCustomSettingsValues = function(settingsValues) {
  if (this._customSettingsValues == settingsValues || !settingsValues || epiviz.utils.mapEquals(this._customSettingsValues, settingsValues)) {
    return;
  }
  var CustomSettings = epiviz.ui.charts.Visualization.CustomSettings;

  var currentTitle = this._customSettingsValues[CustomSettings.TITLE] || '';
  var newTitle = settingsValues[CustomSettings.TITLE] || '';

  var currentLen = currentTitle.trim().length;
  var newLen = newTitle.trim().length;

  // Check if either both titles are undefined or both are defined
  if (!(currentLen * newLen) && (currentLen + newLen)) {
    var marginDelta = epiviz.utils.sign(newLen - currentLen) * 20;
    var top = settingsValues[CustomSettings.MARGIN_TOP] || this._properties.margins.top();
    var left = settingsValues[CustomSettings.MARGIN_LEFT] || this._properties.margins.left();
    var right = settingsValues[CustomSettings.MARGIN_RIGHT] || this._properties.margins.right();
    var bottom = settingsValues[CustomSettings.MARGIN_BOTTOM] || this._properties.margins.bottom();
    settingsValues[CustomSettings.MARGIN_TOP] = top + marginDelta;
    settingsValues[CustomSettings.MARGIN_LEFT] = left;
    settingsValues[CustomSettings.MARGIN_RIGHT] = right;
    settingsValues[CustomSettings.MARGIN_BOTTOM] = bottom;
  }

  // FIXME: This is a property specific to Chart and not Visualization; move this portion of the code in Chart
  var currentMeasurementAggregator = this._customSettingsValues[epiviz.ui.charts.ChartType.CustomSettings.MEASUREMENT_GROUPS_AGGREGATOR];
  var newMeasurementAggregator = settingsValues[epiviz.ui.charts.ChartType.CustomSettings.MEASUREMENT_GROUPS_AGGREGATOR];

  this._customSettingsValues = settingsValues;

  if (CustomSettings.MARGIN_TOP in settingsValues && CustomSettings.MARGIN_BOTTOM in settingsValues && CustomSettings.MARGIN_LEFT in settingsValues && CustomSettings.MARGIN_RIGHT in settingsValues) {
    this._properties.margins = new epiviz.ui.charts.Margins(settingsValues[CustomSettings.MARGIN_TOP], settingsValues[CustomSettings.MARGIN_LEFT], settingsValues[CustomSettings.MARGIN_BOTTOM], settingsValues[CustomSettings.MARGIN_RIGHT]);
    this._marginsChanged.notify(new epiviz.ui.charts.VisEventArgs(this._id, this._properties.margins));
  }

  if (currentMeasurementAggregator != newMeasurementAggregator) {
    var self = this;
    this.transformData(this._lastRange, this._unalteredData).done(function() {
      self.draw();
    });
  } else {
    this.draw();
  }

  this._customSettingsChanged.notify(new epiviz.ui.charts.VisEventArgs(this._id, settingsValues));
};

/**
 * @param {Object.<string, string>} modifiedMethods
 */
epiviz.ui.charts.Visualization.prototype.setModifiedMethods = function(modifiedMethods) {
  var self = this;
  var methodsModified = false;
  if (!modifiedMethods) { return; }
  var modifiedMethodNames = Object.keys(modifiedMethods);
  var methodsUpdated = new epiviz.deferred.Deferred();
  var nMethodsUpdated = 0;
  var cajoledMethods = {};
  for (var m in modifiedMethods) {
    if (!modifiedMethods.hasOwnProperty(m)) { continue; }
    if (m == '_setModifiedMethods') { continue; } // Ignore modifications to this method
    if (this[m].toString() == modifiedMethods[m]) { continue; }

    if (!(m in this._originalMethods)) {
      this._originalMethods[m] = this[m];
    }

    (function(m) {
      epiviz.caja.cajole(modifiedMethods[m], epiviz.caja.buildChartMethodContext()).done(function(method) {
        if (method) {
          cajoledMethods[m] = method;
          methodsModified = true;

          nMethodsUpdated += 1;
          if (nMethodsUpdated >= modifiedMethodNames.length) {
            methodsUpdated.resolve();
          }
        }
      });
    })(m);
  }

  methodsUpdated.done(function() {
    if (methodsModified) {
      for (var m in cajoledMethods) {
        if (!cajoledMethods.hasOwnProperty(m)) { continue; }
        self[m] = cajoledMethods[m];
        self._lastModifiedMethod = m;
      }
      self._hasModifiedMethods = true;
      self.draw();
      self._methodsModified.notify(new epiviz.ui.charts.VisEventArgs(self._id, modifiedMethods));
    }
  });
};

/**
 * @returns {boolean}
 */
epiviz.ui.charts.Visualization.prototype.hasModifiedMethods = function() { return this._hasModifiedMethods; };

/**
 * @returns {string}
 */
epiviz.ui.charts.Visualization.prototype.lastModifiedMethod = function() { return this._lastModifiedMethod; };

/**
 */
epiviz.ui.charts.Visualization.prototype.resetModifiedMethods = function() {
  if (!this._hasModifiedMethods) { return; }
  for (var m in this._originalMethods) {
    if (!this._originalMethods.hasOwnProperty(m)) { continue; }
    this[m] = this._originalMethods[m];
  }

  this._hasModifiedMethods = false;

  this.draw();

  this._methodsReset.notify(new epiviz.ui.charts.VisEventArgs(this._id));
};

/**
 * @param {epiviz.ui.charts.markers.VisualizationMarker} marker
 */
epiviz.ui.charts.Visualization.prototype.putMarker = function(marker) {
  if (!marker) { return; }
  var i;
  if (marker.id() in this._markersMap) {
    i = this._markersIndices[marker.id()];
    var oldMarker = this._markers[i];
    if (oldMarker == marker ||
        (oldMarker.type() == marker.type() &&
         oldMarker.preMarkStr() == marker.preMarkStr() &&
         oldMarker.markStr() == marker.markStr())) {
      // Marker not modified
      return;
    }
    this._markers[i] = marker;
    this._markersMap[marker.id()] = marker;
  } else {
    i = this._markers.length;
    this._markers.push(marker);
    this._markersIndices[marker.id()] = i;
    this._markersMap[marker.id()] = marker;
  }

  var self = this;
  this.transformData(this._lastRange, this._unalteredData).done(function() {
    self.draw();
  });

  this._markersModified.notify(new epiviz.ui.charts.VisEventArgs(this._id, this._markers));
};

epiviz.ui.charts.Visualization.prototype.removeMarker = function(markerId) {
  if (!(markerId in this._markersMap)) { return; }

  var i = this._markersIndices[markerId];
  this._markers[i] = null;
  delete this._markersMap[markerId];
  delete this._markersIndices[markerId];

  var self = this;
  this.transformData(this._lastRange, this._unalteredData).done(function() {
    self.draw();
  });

  this._markersModified.notify(new epiviz.ui.charts.VisEventArgs(this._id, this._markers));
};

/**
 * @param {string} markerId
 * @returns {epiviz.ui.charts.markers.VisualizationMarker}
 */
epiviz.ui.charts.Visualization.prototype.getMarker = function(markerId) {
  if (!markerId || !(markerId in this._markersMap)) { return null; }
  return this._markersMap[markerId];
};

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.Visualization.prototype.displayType = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.Visualization.prototype.autoPropagateChanges = function() { return this._autoPropagateChanges; };

/**
 * @param {boolean} val
 */
epiviz.ui.charts.Visualization.prototype.setAutoPropagateChanges = function(val) { this._autoPropagateChanges = val; };

/**
 * @param {epiviz.datatypes.Range} range
 * @param {T} data
 * @returns {epiviz.deferred.Deferred}
 */
epiviz.ui.charts.Visualization.prototype.transformData = function(range, data) {
  var lastRange = this._lastRange;

  if (range != undefined) {
    this._lastRange = range;
  }
  if (data != undefined) {
    this._lastData = data;
    this._unalteredData = data;
  }

  if (lastRange && range && lastRange.overlapsWith(range) && lastRange.width() == range.width()) {
    this._slide = range.start() - lastRange.start();
  }

  if (lastRange && range && lastRange.overlapsWith(range) && lastRange.width() != range.width()) {
    this._zoom = lastRange.width() / range.width();
  }

  var deferred = new epiviz.deferred.Deferred();
  deferred.resolve();
  return deferred;
};

/* Events */

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.VisObject>>}
 */
epiviz.ui.charts.Visualization.prototype.onHover = function() { return this._hover; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.Visualization.prototype.onUnhover = function() { return this._unhover; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.VisObject>>}
 */
epiviz.ui.charts.Visualization.prototype.onSelect = function() { return this._select; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.Visualization.prototype.onDeselect = function() { return this._deselect; };

// Deprecated code, kept here for future reference
// Selection and hovering by changing the class of the selected items

/**
 * @param {epiviz.ui.charts.VisObject} selectedObject
 */
/*epiviz.ui.charts.Visualization.prototype.doHover = function(selectedObject) {
  var itemsGroup = this._svg.select('.items');
  itemsGroup.classed('unhovered', true);
  var selectItems = itemsGroup.selectAll('.item').filter(function(d) {
    return selectedObject.overlapsWith(d);
  });
  selectItems.classed('hovered', true);
  itemsGroup.selectAll('.item').sort(function(d1, d2) { return selectedObject.overlapsWith(d1) ? 1 : -1; });
};*/

/**
 */
/*epiviz.ui.charts.Visualization.prototype.doUnhover = function() {
  this._svg.select('.items').classed('unhovered', false);
  this._svg.select('.items').selectAll('.item').classed('hovered', false);
};*/

/**
 * @param {epiviz.ui.charts.ChartObject} selectedObject
 */
/*epiviz.ui.charts.Visualization.prototype.doSelect = function(selectedObject) {
  var itemsGroup = this._svg.select('.items');
  var selectItems = itemsGroup.selectAll('.item').filter(function(d) {
    return selectedObject.overlapsWith(d);
  });
  selectItems.classed('selected', true);
};*/

/**
 */
/*epiviz.ui.charts.Visualization.prototype.doDeselect = function() {
  this._svg.select('.items').selectAll('.selected').classed('selected', false);
};*/

/**
 * @param {epiviz.ui.charts.VisObject} selectedObject
 */
epiviz.ui.charts.Visualization.prototype.doHover = function(selectedObject) {
  var itemsGroup = this._container.find('.items');
  var unselectedHoveredGroup = itemsGroup.find('> .hovered');
  var selectedGroup = itemsGroup.find('> .selected');
  var selectedHoveredGroup = selectedGroup.find('> .hovered');

  var filter = function() {
    return selectedObject.overlapsWith(d3.select(this).data()[0]);
  };
  var selectItems = itemsGroup.find('> .item').filter(filter);
  unselectedHoveredGroup.append(selectItems);

  selectItems = selectedGroup.find('> .item').filter(filter);
  selectedHoveredGroup.append(selectItems);
};

/**
 */
epiviz.ui.charts.Visualization.prototype.doUnhover = function() {
  var itemsGroup = this._container.find('.items');
  var unselectedHoveredGroup = itemsGroup.find('> .hovered');
  var selectedGroup = itemsGroup.find('> .selected');
  var selectedHoveredGroup = selectedGroup.find('> .hovered');

  itemsGroup.prepend(unselectedHoveredGroup.children());

  selectedGroup.prepend(selectedHoveredGroup.children());
};

/**
 * @param {epiviz.ui.charts.ChartObject} selectedObject
 */
epiviz.ui.charts.Visualization.prototype.doSelect = function(selectedObject) {
  var itemsGroup = this._container.find('.items');
  var unselectedHoveredGroup = itemsGroup.find('> .hovered');
  var selectedGroup = itemsGroup.find('> .selected');
  var selectedHoveredGroup = selectedGroup.find('> .hovered');

  var filter = function() {
    return selectedObject.overlapsWith(d3.select(this).data()[0]);
  };
  var selectItems = itemsGroup.find('> .item').filter(filter);
  selectedGroup.append(selectItems);

  selectItems = unselectedHoveredGroup.find('> .item').filter(filter);
  selectedHoveredGroup.append(selectItems);
};

/**
 */
epiviz.ui.charts.Visualization.prototype.doDeselect = function() {
  var itemsGroup = this._container.find('.items');
  var unselectedHoveredGroup = itemsGroup.find('> .hovered');
  var selectedGroup = itemsGroup.find('> .selected');
  var selectedHoveredGroup = selectedGroup.find('> .hovered');

  itemsGroup.prepend(selectedGroup.find('> .item'));
  unselectedHoveredGroup.prepend(selectedHoveredGroup.children());
};

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.Visualization.prototype.onSave = function() { return this._save; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.Visualization.prototype.onRemove = function() { return this._remove; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.ColorPalette>>}
 */
epiviz.ui.charts.Visualization.prototype.onColorsChanged = function() { return this._colorsChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, string>>>}
 */
epiviz.ui.charts.Visualization.prototype.onMethodsModified = function() { return this._methodsModified; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.Visualization.prototype.onMethodsReset = function() { return this._methodsReset; };

/**
 * @returns {epiviz.events.Event.<Array.<epiviz.ui.charts.markers.VisualizationMarker>>}
 */
epiviz.ui.charts.Visualization.prototype.onMarkersModified = function() { return this._markersModified; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, *>>>}
 */
epiviz.ui.charts.Visualization.prototype.onCustomSettingsChanged = function() { return this._customSettingsChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{width: (number|string), height: (number|string)}>>}
 */
epiviz.ui.charts.Visualization.prototype.onSizeChanged = function() { return this._sizeChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.Margins>>}
 */
epiviz.ui.charts.Visualization.prototype.onMarginsChanged = function() { return this._marginsChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.Visualization.prototype.onDataWaitStart = function() { return this._dataWaitStart; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.Visualization.prototype.onDataWaitEnd = function() { return this._dataWaitEnd; };

/**
 * @enum {string}
 */
epiviz.ui.charts.Visualization.CustomSettings = {
  TITLE: 'title',
  MARGIN_LEFT: 'marginLeft',
  MARGIN_RIGHT: 'marginRight',
  MARGIN_TOP: 'marginTop',
  MARGIN_BOTTOM: 'marginBottom',
  X_MIN: 'xMin',
  X_MAX: 'xMax',
  Y_MIN: 'yMin',
  Y_MAX: 'yMax',
  COL_LABEL: 'colLabel',
  ROW_LABEL: 'rowLabel'
};

// Input 33
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/15/2015
 * Time: 2:20 PM
 */

goog.provide('epiviz.datatypes.GenomicData');

/**
 * @interface
 */
epiviz.datatypes.GenomicData = function() {};

/**
 * @param {function} callback Called when data is fully initialized and ready to be manipulated
 */
epiviz.datatypes.GenomicData.prototype.ready = function(callback) { throw Error('unimplemented abstract method'); };

/**
 * @returns {boolean}
 */
epiviz.datatypes.GenomicData.prototype.isReady = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {epiviz.datatypes.MeasurementGenomicData}
 */
epiviz.datatypes.GenomicData.prototype.firstSeries = function() { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {epiviz.datatypes.MeasurementGenomicData}
 */
epiviz.datatypes.GenomicData.prototype.getSeries = function(m) { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} i
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.GenomicData.prototype.get = function(m, i) { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} i
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.GenomicData.prototype.getRow = function(m, i) { throw Error('unimplemented abstract method'); };

/**
 * @returns {Array.<epiviz.measurements.Measurement>}
 */
epiviz.datatypes.GenomicData.prototype.measurements = function() { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {number}
 */
epiviz.datatypes.GenomicData.prototype.globalStartIndex = function(m) { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {number}
 */
epiviz.datatypes.GenomicData.prototype.globalEndIndex = function(m) { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {number}
 */
epiviz.datatypes.GenomicData.prototype.size = function(m) { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.GenomicData.prototype.getByGlobalIndex = function(m, globalIndex) { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.GenomicData.prototype.getRowByGlobalIndex = function(m, globalIndex) { throw Error('unimplemented abstract method'); };

/**
 * Gets the first index and length of the rows that have start positions within the given range
 * @param {epiviz.measurements.Measurement} m
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {{index: ?number, length: number}}
 */
epiviz.datatypes.GenomicData.prototype.binarySearchStarts = function(m, range) { throw Error('unimplemented abstract method'); };

/**
 * Iterates through all pairs in the map, or until the given function returns something that
 * evaluates to true.
 * @param {function(epiviz.measurements.Measurement, epiviz.datatypes.MeasurementGenomicData, number=)} callback
 */
epiviz.datatypes.GenomicData.prototype.foreach = function(callback) { throw Error('unimplemented abstract method'); };


goog.provide('epiviz.datatypes.GenomicData.ValueItem');


/**
 * @param {number} globalIndex
 * @param {epiviz.datatypes.GenomicData.RowItem} rowItem
 * @param {?number} [value]
 * @param {epiviz.measurements.Measurement} measurement
 * @param {Object.<string, *>} [valueAnnotation]
 * @constructor
 * @struct
 */
epiviz.datatypes.GenomicData.ValueItem = function(globalIndex, rowItem, value, measurement, valueAnnotation) {
  /**
   * @type {number}
   */
  this.globalIndex = globalIndex;

  /**
   * @type {epiviz.datatypes.GenomicData.RowItem}
   */
  this.rowItem = rowItem;

  /**
   * @type {number}
   */
  this.value = (value === 0 || value) ? value : null;

  /**
   * @type {epiviz.measurements.Measurement}
   */
  this.measurement = measurement;

  /**
   * @type {?Object.<string, *>}
   */
  this.valueAnnotation = valueAnnotation;
};


goog.provide('epiviz.datatypes.GenomicData.RowItem');

/**
 * @interface
 */
epiviz.datatypes.GenomicData.RowItem = function() {};

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.id = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.seqName = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.start = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.end = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.globalIndex = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.strand = function() { throw Error('unimplemented abstract method'); };

/**
 * @param {string} column
 * @returns {*}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.metadata = function(column) { throw Error('unimplemented abstract method'); };

/**
 * @returns {Object.<string, *>}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.rowMetadata = function() { throw Error('unimplemented abstract method'); };

// Input 34
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/15/2015
 * Time: 4:52 PM
 */

goog.provide('epiviz.datatypes.MapGenomicData');

goog.require('epiviz.datatypes.GenomicData');
goog.require('epiviz.deferred.Deferred');


/**
 * @param {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.MeasurementGenomicData>} [map]
 * @constructor
 * @implements {epiviz.datatypes.GenomicData}
 */
epiviz.datatypes.MapGenomicData = function(map) {
  /**
   * @type {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.MeasurementGenomicData>}
   * @private
   */
  this._map = map;

  /**
   * @type {Array.<epiviz.measurements.Measurement>}
   * @private
   */
  this._measurements = map ? map.keys() : null;

  /**
   * @type {epiviz.deferred.Deferred}
   * @private
   */
  this._mapLoaded = new epiviz.deferred.Deferred();

  if (this._map) { this._mapLoaded.resolve(); }
};

/**
 * @param {function} callback
 */
epiviz.datatypes.MapGenomicData.prototype.ready = function(callback) {
  this._mapLoaded.done(callback);
};

/**
 * @returns {boolean}
 */
epiviz.datatypes.MapGenomicData.prototype.isReady = function() {
  return this._mapLoaded.state() == epiviz.deferred.Deferred.State.RESOLVED;
};

/**
 * @param {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.MeasurementGenomicData>} map
 * @protected
 */
epiviz.datatypes.MapGenomicData.prototype._setMap = function(map) {
  if (this._map) { throw Error('MapGenomicData is immutable'); }
  this._map = map;
  if (!map) { return; }
  this._measurements = map.keys();
  this._mapLoaded.resolve();
};

/**
 * @returns {epiviz.datatypes.MeasurementGenomicData}
 */
epiviz.datatypes.MapGenomicData.prototype.firstSeries = function() {
  if (this._map.size() == 0) { return null; }
  return this._map.first().value;
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {epiviz.datatypes.MeasurementGenomicData}
 */
epiviz.datatypes.MapGenomicData.prototype.getSeries = function(m) {
  return this._map.get(m);
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} i
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MapGenomicData.prototype.get = function(m, i) {
  var mItems = this._map.get(m);
  if (!mItems) { return null; }
  return mItems.get(i);
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} i
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MapGenomicData.prototype.getRow = function(m, i) {
  var mItems = this._map.get(m);
  if (!mItems) { return null; }
  return mItems.getRow(i);
};

/**
 * @returns {Array.<epiviz.measurements.Measurement>}
 */
epiviz.datatypes.MapGenomicData.prototype.measurements = function() {
  return this._measurements;
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {number}
 */
epiviz.datatypes.MapGenomicData.prototype.globalStartIndex = function(m) {
  var mItems = this._map.get(m);
  if (!mItems) { return null; }
  return mItems.globalStartIndex();
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {number}
 */
epiviz.datatypes.MapGenomicData.prototype.globalEndIndex = function(m) {
  var mItems = this._map.get(m);
  if (!mItems) { return null; }
  return mItems.globalEndIndex();
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {number}
 */
epiviz.datatypes.MapGenomicData.prototype.size = function(m) {
  var mItems = this._map.get(m);
  if (!mItems) { return null; }
  return mItems.size();
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MapGenomicData.prototype.getByGlobalIndex = function(m, globalIndex) {
  var mItems = this._map.get(m);
  if (!mItems) { return null; }
  return mItems.getByGlobalIndex(globalIndex);
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MapGenomicData.prototype.getRowByGlobalIndex = function(m, globalIndex) {
  var mItems = this._map.get(m);
  if (!mItems) { return null; }
  return mItems.getRowByGlobalIndex(globalIndex);
};

/**
 * Gets the first index and length of the rows that have start positions within the given range
 * @param {epiviz.measurements.Measurement} m
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {{index: ?number, length: number}}
 */
epiviz.datatypes.MapGenomicData.prototype.binarySearchStarts = function(m, range) {
  var mItems = this._map.get(m);
  if (!mItems) { return {index:null, length:0}; }
  return mItems.binarySearchStarts(range);
};

/**
 * Iterates through all pairs in the map, or until the given function returns something that
 * evaluates to true.
 * @param {function(epiviz.measurements.Measurement, epiviz.datatypes.MeasurementGenomicData, number=)} callback
 */
epiviz.datatypes.MapGenomicData.prototype.foreach = function(callback) {
  this._map.foreach(function(m, series, seriesIndex) {
    callback(m, series, seriesIndex);
  });
};


// Input 35
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/13
 * Time: 3:45 PM
 */

goog.provide('epiviz.measurements.MeasurementHashtable');

goog.require('epiviz.utils.Iterable');
goog.require('epiviz.utils.Iterator');


/**
 * @constructor
 * @implements {epiviz.utils.Iterable}
 * @template T
 */
epiviz.measurements.MeasurementHashtable = function() {
  /**
   * @type {number}
   * @private
   */
  this._size = 0;

  /**
   * A map containing measurement values in a tree structure, by the following levels:
   *   dataprovider, type, datasourceGroup, datasource, id
   * @type {Object.<string, Object.<string, Object.<string, Object.<string, Object.<string, {key: epiviz.measurements.Measurement, value: T, index: number}>>>>>}
   * @private
   */
  this._measurementTree = {};

  /**
   * @type {Array.<{key: epiviz.measurements.Measurement, value: T, contained: boolean}>}
   * @private
   */
  this._order = [];
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {T} value
 */
epiviz.measurements.MeasurementHashtable.prototype.put = function(m, value) {
  if (this.contains(m)) {
    var existingItem = this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()];
    this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()] = {key: m, value: value, index: existingItem.index};
    this._order[existingItem.index] = {key: m, value: value, contained: true};
    return;
  }

  if (!(m.dataprovider() in this._measurementTree)) {
    this._measurementTree[m.dataprovider()] = {};
  }

  if (!(m.type() in this._measurementTree[m.dataprovider()])) {
    this._measurementTree[m.dataprovider()][m.type()] = {};
  }

  if (!(m.datasourceGroup() in this._measurementTree[m.dataprovider()][m.type()])) {
    this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()] = {};
  }

  if (!(m.datasource().id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()])) {
    this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()] = {};
  }

  this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()] = {key: m, value: value, index: this._order.length};
  this._order.push({key: m, value: value, contained: true});

  ++this._size;
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {?T}
 */
epiviz.measurements.MeasurementHashtable.prototype.get = function(m) {
  if (!this.contains(m)) { return null; }

  return this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()].value;
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {boolean} true if the measurement was in the data structure and was removed
 *   and false if the measurement was not in the collection
 */
epiviz.measurements.MeasurementHashtable.prototype.remove = function(m) {
  if (!this.contains(m)) {
    return false;
  }

  var item = this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()];
  delete this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()];
  this._order[item.index].contained = false;
  --this._size;
  return true;
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {boolean}
 */
epiviz.measurements.MeasurementHashtable.prototype.contains = function(m) {
  if (!(m.dataprovider() in this._measurementTree)) {
    return false;
  }

  if (!(m.type() in this._measurementTree[m.dataprovider()])) {
    return false;
  }

  if (!(m.datasourceGroup() in this._measurementTree[m.dataprovider()][m.type()])) {
    return false;
  }

  if (!(m.datasource().id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()])) {
    return false;
  }

  return (m.id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()]);
};

/**
 */
epiviz.measurements.MeasurementHashtable.prototype.clear = function() {
  this._size = 0;
  this._measurementTree = {};
  this._order = [];
};

/**
 * @returns {boolean}
 */
epiviz.measurements.MeasurementHashtable.prototype.isEmpty = function() {
  return this._size == 0;
};

/**
 * returns {number}
 */
epiviz.measurements.MeasurementHashtable.prototype.size = function() {
  return this._size;
};

/**
 * Iterates through all pairs in the map, or until the given function returns something that
 * evaluates to true.
 * @param {function(epiviz.measurements.Measurement, T, number=)} func
 * @param {function(epiviz.measurements.Measurement):boolean} [predicate]
 */
epiviz.measurements.MeasurementHashtable.prototype.foreach = function(func, predicate) {
  var iter = this.iterator();
  for (var pair = iter.first(), i = 0; pair !== null; pair = iter.next(), ++i) {
    if (predicate && !predicate(pair.key)) { continue; }
    if (func(pair.key, pair.value, i)) { return; }
  }
};

/**
 * @returns {{key: epiviz.measurements.Measurement, value: T}}
 */
epiviz.measurements.MeasurementHashtable.prototype.first = function() {
  return this.iterator().first();
};

/**
 * Creates a copy of this hashtable, ordered by keys (measurements)
 * @param {function(epiviz.measurements.Measurement, epiviz.measurements.Measurement): number} comparer
 * @returns {epiviz.measurements.MeasurementHashtable}
 */
epiviz.measurements.MeasurementHashtable.prototype.sorted = function(comparer) {
  var ret = new epiviz.measurements.MeasurementHashtable();

  var pairs = this._order.slice(0);
  pairs.sort(function(p1, p2) { return comparer(p1.key, p2.key); });

  pairs.forEach(function(pair) {
    if (!pair.contained) { return; }
    ret.put(pair.key, pair.value);
  });

  return ret;
};

/**
 * @returns {Array.<epiviz.measurements.Measurement>}
 */
epiviz.measurements.MeasurementHashtable.prototype.keys = function() {
  var ret = [];
  this._order.forEach(function(o) {
    if (o.contained) { ret.push(o.key); }
  });
  return ret;
};

/**
 * @returns {epiviz.utils.Iterator.<{key: epiviz.measurements.Measurement, value: T}>}
 */
epiviz.measurements.MeasurementHashtable.prototype.iterator = function() {
  return new epiviz.measurements.MeasurementHashtable.Iterator(this);
};

/**
 * @returns {string}
 */
epiviz.measurements.MeasurementHashtable.prototype.toString = function() {
  var result = {};
  this.foreach(function(m, v) {
    var id = m.id();
    var i = 2;
    while (id in result) {
      id = m.id() + ' (' + (i++) + ')';
    }
    result[id] = v;
  });
  return JSON.stringify(result);
};

/**
 * @param {epiviz.measurements.MeasurementHashtable} measurementHashtable
 * @constructor
 * @implements {epiviz.utils.Iterator}
 */
epiviz.measurements.MeasurementHashtable.Iterator = function(measurementHashtable) {
  /**
   * @type {epiviz.measurements.MeasurementHashtable}
   * @private
   */
  this._parent = measurementHashtable;

  /**
   * @type {number}
   * @private
   */
  this._lastIndex = null;
};

/**
 * @returns {?{key: epiviz.measurements.Measurement, value: T}}
 */
epiviz.measurements.MeasurementHashtable.Iterator.prototype.first = function() {
  if (this._parent.size() == 0) {
    return null;
  }

  for (var i = 0; i < this._parent._order.length; ++i) {
    if (this._parent._order[i].contained) {
      this._lastIndex = i;
      return {key: this._parent._order[i].key, value: this._parent._order[i].value};
    }
  }

  // Should never be reached!
  throw Error('Inconsistent MeasurementHashtable with size() > 0 and no first element');
};

/**
 * @returns {?{key: epiviz.measurements.Measurement, value: T}}
 */
epiviz.measurements.MeasurementHashtable.Iterator.prototype.next = function() {
  if (this._lastIndex === null) {
    throw Error('Iterator.next() called before calling Iterator.first()');
  }

  for (var i = this._lastIndex + 1; i < this._parent._order.length; ++i) {
    if (this._parent._order[i].contained) {
      this._lastIndex = i;
      return {key: this._parent._order[i].key, value: this._parent._order[i].value};
    }
  }

  this._lastIndex = this._parent._order.length;
  return null;
};

// Input 36
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/15/2015
 * Time: 1:32 PM
 */

goog.provide('epiviz.datatypes.MeasurementGenomicData');

/**
 * @interface
 */
epiviz.datatypes.MeasurementGenomicData = function() {};

/**
 * @param {number} index
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.get = function(index) { throw Error('unimplemented abstract method'); };

/**
 * @param {number} index
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.getRow = function(index) { throw Error('unimplemented abstract method'); };

/**
 * @returns {epiviz.measurements.Measurement}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.measurement = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.globalStartIndex = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.globalEndIndex = function() { throw Error('unimplemented abstract method'); };


/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.size = function() { throw Error('unimplemented abstract method'); };

/**
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.getByGlobalIndex = function(globalIndex) { throw Error('unimplemented abstract method'); };

/**
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.getRowByGlobalIndex = function(globalIndex) { throw Error('unimplemented abstract method'); };

/**
 * Gets the first index and length of the rows that have start positions within the given range
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {{index: ?number, length: number}}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.binarySearchStarts = function(range) { throw Error('unimplemented abstract method'); };

// Input 37
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/15/2015
 * Time: 3:05 PM
 */

goog.provide('epiviz.datatypes.MeasurementGenomicDataArrayWrapper');

goog.require('epiviz.datatypes.MeasurementGenomicData');

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {Array.<epiviz.datatypes.GenomicData.ValueItem>} items
 * @param {Object.<number, epiviz.datatypes.GenomicData.ValueItem>} itemsByGlobalIndex
 * @constructor
 * @implements {epiviz.datatypes.MeasurementGenomicData}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper = function(measurement, items, itemsByGlobalIndex) {
  /**
   * @type {epiviz.measurements.Measurement}
   * @private
   */
  this._measurement = measurement;

  /**
   * @type {Array.<epiviz.datatypes.GenomicData.ValueItem>}
   * @private
   */
  this._items = items;

  /**
   * @type {Object.<number, epiviz.datatypes.GenomicData.ValueItem>}
   * @private
   */
  this._itemsByGlobalIndex = itemsByGlobalIndex;
};

/**
 * @param {number} index
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.get = function(index) {
  return (this._items && index >= 0 && index < this._items.length) ? this._items[index] : null;
};

/**
 * @param {number} index
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.getRow = function(index) {
  return (this._items && index >= 0 && index < this._items.length) ? this._items[index].rowItem : null;
};

/**
 * @returns {epiviz.measurements.Measurement}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.measurement = function() {
  return this._measurement;
};

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.globalStartIndex = function() {
  return (this._items && this._items.length) ? this._items[0].globalIndex : null;
};

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.globalEndIndex = function() {
  return (this._items && this._items.length) ? this._items[this._items.length - 1].globalIndex + 1 : null;
};

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.size = function() {
  return (this._items) ? this._items.length : 0;
};

/**
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.getByGlobalIndex = function(globalIndex) {
  return (this._itemsByGlobalIndex && (globalIndex in this._itemsByGlobalIndex)) ? this._itemsByGlobalIndex[globalIndex] : null;
};

/**
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.getRowByGlobalIndex = function(globalIndex) {
  return (this._itemsByGlobalIndex && (globalIndex in this._itemsByGlobalIndex)) ? this._itemsByGlobalIndex[globalIndex].rowItem : null;
};

/**
 * TODO: Test to check correctness
 * Gets the first index and length of the rows that have start positions within the given range
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {{index: ?number, length: number}}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.binarySearchStarts = function(range) {
  if (!this._items || !this._items.length ||
      this._items[0].rowItem.start() > range.end() ||
      this._items[this._items.length - 1].rowItem.start() < range.start()) {
    return {index:null, length:0};
  }

  // Perform binary search to find the start row index

  var s = 0, e = this._items.length - 1;
  var m;

  var startIndex = null;

  while (s <= e) {
    m = Math.floor((s + e) * 0.5);
    if (this._items[m].rowItem.start() == range.start()) {
      startIndex = m;
      e = m - 1;
    } else if (this._items[m].rowItem.start() < range.start()) { s = m + 1; }
    else { e = m - 1; }
  }

  if (startIndex === null) { startIndex = s; }

  // Perform binary search to find the end row index

  s = 0;
  e = this._items.length - 1;

  var endIndex = null;

  while (s <= e) {
    m = Math.floor((s + e) * 0.5);
    if (this._items[m].rowItem.start() == range.end()) {
      endIndex = m;
      s = m + 1;
    } else if (this._items[m].rowItem.start() < range.end()) { s = m + 1; }
    else { e = m - 1; }
  }

  if (endIndex === null) { endIndex = s - 1; }

  return {
    index: startIndex,
    length: endIndex + 1 - startIndex
  };
};


// Input 38
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/16/2015
 * Time: 1:12 PM
 */

goog.provide('epiviz.datatypes.RowItemImpl');

/**
 * @param {string} id
 * @param {string} seqName
 * @param {number} start
 * @param {number} end
 * @param {number} globalIndex
 * @param {string} strand
 * @param {Object.<string, *>} rowMetadata
 * @constructor
 * @implements {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.RowItemImpl = function(id, seqName, start, end, globalIndex, strand, rowMetadata) {
  /**
   * @type {string}
   * @private
   */
  this._id = id;

  /**
   * @type {string}
   * @private
   */
  this._seqName = seqName;

  /**
   * @type {number}
   * @private
   */
  this._start = start;

  /**
   * @type {number}
   * @private
   */
  this._end = end;

  /**
   * @type {number}
   * @private
   */
  this._globalIndex = globalIndex;

  /**
   * @type {string}
   * @private
   */
  this._strand = strand;

  /**
   * @type {Object.<string, *>}
   * @private
   */
  this._rowMetadata = rowMetadata;
};

/**
 * @returns {string}
 */
epiviz.datatypes.RowItemImpl.prototype.id = function() { return this._id; };

/**
 * @returns {string}
 */
epiviz.datatypes.RowItemImpl.prototype.seqName = function() { return this._seqName; };

/**
 * @returns {number}
 */
epiviz.datatypes.RowItemImpl.prototype.start = function() { return this._start; };

/**
 * @returns {number}
 */
epiviz.datatypes.RowItemImpl.prototype.end = function() { return this._end; };

/**
 * @returns {number}
 */
epiviz.datatypes.RowItemImpl.prototype.globalIndex = function() { return this._globalIndex; };

/**
 * @returns {string}
 */
epiviz.datatypes.RowItemImpl.prototype.strand = function() { return this._strand; };

/**
 * @param {string} column
 * @returns {*}
 */
epiviz.datatypes.RowItemImpl.prototype.metadata = function(column) {
  var ret = this._rowMetadata[column];
  if (ret == undefined) { return null; }
  return ret;
};

/**
 * @returns {Object.<string, *>}
 */
epiviz.datatypes.RowItemImpl.prototype.rowMetadata = function() { return this._rowMetadata; };


// Input 39
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/16/2015
 * Time: 10:56 AM
 */

goog.provide('epiviz.datatypes.MeasurementAggregatedGenomicData');

goog.require('epiviz.datatypes.MapGenomicData');
goog.require('epiviz.deferred.Deferred');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.utils');
goog.require('epiviz.datatypes.MeasurementGenomicDataArrayWrapper');
goog.require('epiviz.datatypes.GenomicData.ValueItem');
goog.require('epiviz.datatypes.RowItemImpl');

/**
 * @param {epiviz.datatypes.GenomicData} data
 * @param {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.measurements.Measurement, string>} groupByMarker
 * @param {epiviz.ui.charts.markers.MeasurementAggregator} aggregator
 * @constructor
 * @extends {epiviz.datatypes.MapGenomicData}
 */
epiviz.datatypes.MeasurementAggregatedGenomicData = function(data, groupByMarker, aggregator) {
  epiviz.datatypes.MapGenomicData.call(this);

  /**
   * @type {epiviz.datatypes.GenomicData}
   * @private
   */
  this._data = data;

  /**
   * @type {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.measurements.Measurement, string>}
   * @private
   */
  this._groupByMarker = groupByMarker;

  /**
   * @type {epiviz.ui.charts.markers.MeasurementAggregator}
   * @private
   */
  this._aggregator = aggregator;

  /**
   * @type {epiviz.deferred.Deferred}
   * @private
   */
  this._deferredInit = null;

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.datatypes.MeasurementAggregatedGenomicData.prototype = epiviz.utils.mapCopy(epiviz.datatypes.MapGenomicData.prototype);
epiviz.datatypes.MeasurementAggregatedGenomicData.constructor = epiviz.datatypes.MeasurementAggregatedGenomicData;

/**
 * @returns {epiviz.deferred.Deferred}
 * @private
 */
epiviz.datatypes.MeasurementAggregatedGenomicData.prototype._initialize = function() {
  if (this._deferredInit) { return this._deferredInit; }

  this._deferredInit = new epiviz.deferred.Deferred();

  var self = this;

  /** @type {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.measurements.Measurement, string>} */
  var groupBy = this._groupByMarker;

  /** @type {epiviz.datatypes.GenomicData} */
  var data = this._data;

  data.ready(function() {
    groupBy.preMark()(data).done(function(preGroupVars) {
      /** @type {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.MeasurementGenomicData>} */
      var map = new epiviz.measurements.MeasurementHashtable();

      /** @type {Object.<string, Array.<epiviz.measurements.Measurement>>} */
      var grouped = {};

      var measurements = data.measurements();

      epiviz.utils.deferredFor(measurements.length, function(j) {
        var mDeferredIteration = new epiviz.deferred.Deferred();
        var m = measurements[j];
        groupBy.mark()(m, data, preGroupVars).done(function(groupLabel) {
          if (!(groupLabel in grouped)) {
            grouped[groupLabel] = [];
          }
          grouped[groupLabel].push(m);
          mDeferredIteration.resolve();
        });
        return mDeferredIteration;
      }).done(function() {
        var labelMeasurements = {};
        var label;
        /** @type {Array.<epiviz.measurements.Measurement>} */
        var ms;
        for (label in grouped) {
          if (!grouped.hasOwnProperty(label)) { continue; }

          ms = grouped[label];
          var id = label + '-group',
            name = label,
            type = ms[0].type(),
            datasourceId = ms[0].datasourceId(),
            datasourceGroup = ms[0].datasourceGroup(),
            dataprovider = ms[0].dataprovider(),
            defaultChartType = ms[0].defaultChartType(),
            annotation = epiviz.utils.mapCopy(ms[0].annotation()),
            minValue = ms[0].minValue(),
            maxValue = ms[0].maxValue(),
            metadata = ms[0].metadata();
          var metadataColsMap = {};
          metadata.forEach(function(c) { metadataColsMap[c] = c; });
          grouped[label].forEach(function(m) {
            if (datasourceId != m.datasourceId()) { datasourceId = '*'; }
            if (datasourceGroup != m.datasourceGroup()) { datasourceGroup = '*'; }
            if (dataprovider != m.dataprovider()) { dataprovider = '*'; }
            if (defaultChartType != m.defaultChartType()) { defaultChartType = '*'; }

            var mAnno = m.annotation();
            if (annotation != mAnno) {
              if (annotation == undefined) { annotation = epiviz.utils.mapCopy(mAnno); }
              else if (mAnno != undefined) {
                for (var k in mAnno) {
                  if (!mAnno.hasOwnProperty(k)) { continue; }
                  if (!(k in annotation)) { annotation[k] = mAnno[k]; continue; }
                  if (annotation[k] != mAnno[k]) { annotation[k] = '*'; }
                }
              }
            }
            minValue = Math.min(minValue, m.minValue());
            maxValue = Math.max(maxValue, m.maxValue());

            m.metadata().forEach(function(c) {
              if (!(c in metadataColsMap)) {
                metadataColsMap[c] = c;
                metadata.push(c);
              }
            });
          });
          labelMeasurements[label] = new epiviz.measurements.Measurement(id, name, type, datasourceId, datasourceGroup, dataprovider, null, defaultChartType, annotation, minValue, maxValue, metadata);
        }

        for (label in grouped) {
          if (!grouped.hasOwnProperty(label)) { continue; }
          var m = labelMeasurements[label];
          var items = [];
          var itemsByGlobalIndex = {};
          ms = grouped[label];
          var globalStartIndex = Math.min.apply(undefined, ms.map(function(m) { return data.globalStartIndex(m); }));
          var globalEndIndex = Math.max.apply(undefined, ms.map(function(m) { return data.globalEndIndex(m); }));
          for (var globalIndex = globalStartIndex; globalIndex < globalEndIndex; ++globalIndex) {
            /** @type {Array.<epiviz.datatypes.GenomicData.ValueItem>} */
            var indexItems = ms
              .map(function(m) { return data.getByGlobalIndex(m, globalIndex); })
              .filter(function(item) { return item; });
            if (!indexItems.length) { continue; }
            var values = indexItems
              .map(function(item) { return item.value; });
            var aggregation = self._aggregator.aggregate(label, ms, values);
            var row = indexItems[0].rowItem;
            var aggRow = new epiviz.datatypes.RowItemImpl(row.id(), row.seqName(), row.start(), row.end(), row.globalIndex(), row.strand(),
              row.rowMetadata() || {});
            var item = new epiviz.datatypes.GenomicData.ValueItem(globalIndex, aggRow, aggregation.value, m, {errMinus:aggregation.errMinus, errPlus:aggregation.errPlus});
            items.push(item);
            itemsByGlobalIndex[globalIndex] = item;
          }
          var series = new epiviz.datatypes.MeasurementGenomicDataArrayWrapper(m, items, itemsByGlobalIndex);
          map.put(m, series);
        }

        self._setMap(map);
        self._deferredInit.resolve();
      });
    });
  });

  return this._deferredInit;
};

// goog.inherits(epiviz.datatypes.MeasurementAggregatedGenomicData, epiviz.datatypes.MapGenomicData);

// Input 40
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/27/2015
 * Time: 9:47 AM
 */

goog.provide('epiviz.caja.cajole');

goog.require('epiviz.deferred.Deferred');
// goog.require('epiviz.utils.fillArray');
goog.require('epiviz.utils');


/**
 * @param {string} funcStr
 * @param {Object.<string, *>} [args]
 * @returns {epiviz.deferred.Deferred.<function>}
 */
epiviz.caja.cajole = function(funcStr, args) {
  var deferred = new epiviz.deferred.Deferred();
  caja.load(
    undefined,  // no DOM access
    undefined,  // no network access
    function(frame) {
      frame.code(
        undefined,
        'application/javascript',
        'return (' + funcStr + ');')
        .api(args ? args : {})
        .run(function(func) {
          deferred.resolve(func);
        });
    });
  return deferred;
};

/**
 * @param {string} scriptUrl
 * @param {Object.<string, *>} [args]
 * @returns {epiviz.deferred.Deferred}
 */
epiviz.caja.run = function(scriptUrl, args) {
  var deferred = new epiviz.deferred.Deferred();
  caja.load(
    undefined,  // no DOM access
    undefined,  // no network access
    function(frame) {
      frame.code(
        scriptUrl,
        'application/javascript',
        undefined)
        .api(args ? args : {})
        .run(function() {
          deferred.resolve();
        });
    });
  return deferred;
};

/**
 * @param {Array.<string>} scriptUrls
 * @param {Array.<Object.<string, *>>|Object.<string, *>} [args]
 * @returns {epiviz.deferred.Deferred}
 */
epiviz.caja.chain = function(scriptUrls, args) {
  if (!$.isArray(args)) {
    args = epiviz.utils.fillArray(scriptUrls.length, args);
  }
  return epiviz.utils.deferredFor(scriptUrls.length, function(j) {
    return epiviz.caja.run(scriptUrls[j], args[j]);
  });
};

/**
 * @returns {Object.<string, *>}
 */
epiviz.caja.buildChartMethodContext = function() {
  return {
    epiviz: {
      ui: {
        charts: epiviz.ui.charts,
        controls: epiviz.ui.controls
      },
      utils: epiviz.utils,
      plugins: epiviz.plugins,
      measurements: epiviz.measurements,
      events: epiviz.events,
      deferred: epiviz.deferred,
      datatypes: epiviz.datatypes,
      data: {
        DataProvider: epiviz.data.DataProvider,
        Request: epiviz.data.Request,
        Response: epiviz.data.Response,
        WebServerDataProvider: {
          // TODO: In the future, restrict the access to this method, as it can be a risk factor
          // TODO: For now, it is kept here for DataProvider plugins
          makeGetRequest: epiviz.data.WebServerDataProvider.makeGetRequest
        }
      },
      Config: epiviz.Config
    },
    d3: d3,
    $: $,
    sprintf: sprintf,
    goog: goog
  };
};

// Input 41
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/10/2015
 * Time: 10:19 AM
 */

goog.provide('epiviz.ui.charts.markers.VisualizationMarker');

goog.require('epiviz.utils');
goog.require('epiviz.deferred.Deferred');
goog.require('epiviz.caja.cajole');

/**
 * @param {epiviz.ui.charts.markers.VisualizationMarker.Type} type
 * @param {string} [id]
 * @param {string} [name]
 * @param {string} [preMark]
 * @param {string} [mark]
 * @constructor
 * @template Data, InitialVars, Item, MarkResult
 */
epiviz.ui.charts.markers.VisualizationMarker = function(type, id, name, preMark, mark) {

  /**
   * @type {epiviz.ui.charts.markers.VisualizationMarker.Type}
   * @private
   */
  this._type = type;

  /**
   * @type {string}
   * @protected
   */
  this._id = id || epiviz.utils.generatePseudoGUID(6);

  /**
   * @type {string}
   * @protected
   */
  this._name = name || 'Custom Marker ' + this._id;

  /**
   * @type {string}
   * @private
   */
  this._preMarkStr = preMark || '';

  /**
   * @type {string}
   * @private
   */
  this._markStr = mark || '';

  var deferredPreMark = new epiviz.deferred.Deferred();
  var cajoledPreMark = null;
  epiviz.caja.cajole(this._preMarkStr).done(function(preMarkFunc) {
    cajoledPreMark = preMarkFunc;
    deferredPreMark.resolve();
  });

  /**
   * @type {function(Data): epiviz.deferred.Deferred.<InitialVars>}
   * @private
   */
  this._preMark = function(data) {
    var d = new epiviz.deferred.Deferred();
    deferredPreMark.done(function(){
      var initialVars = cajoledPreMark(data);
      d.resolve(initialVars);
    });
    return d;
  };

  var deferredMark = new epiviz.deferred.Deferred();
  var cajoledMark = null;
  epiviz.caja.cajole(this._markStr).done(function(markFunc) {
    cajoledMark = markFunc;
    deferredMark.resolve();
  });

  /**
   * @type {function(Item, Data, InitialVars): epiviz.deferred.Deferred.<MarkResult>}
   * @private
   */
  this._mark = function(item, data, preMarkResult) {
    var d = new epiviz.deferred.Deferred();
    deferredMark.done(function() {
      var markResult = cajoledMark(item, data, preMarkResult);
      d.resolve(markResult);
    });
    return d;
  };
};

/**
 * @returns {epiviz.ui.charts.markers.VisualizationMarker.Type}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.type = function() { return this._type; };

/**
 * @returns {string}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.id = function() { return this._id; };

/**
 * @returns {string}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.name = function() { return this._name; };

/**
 * @returns {function(Data, function(InitialVars))}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.preMark = function() { return this._preMark; };

/**
 * @returns {function(Item, Data, InitialVars, function(MarkResult))}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.mark = function() { return this._mark; };

/**
 * @returns {string}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.preMarkStr = function() { return this._preMarkStr; };

/**
 * @returns {string}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.markStr = function() { return this._markStr; };

/**
 * @enum {string}
 */
epiviz.ui.charts.markers.VisualizationMarker.Type = {
  FILTER: 'filter',
  COLOR_BY_ROW: 'colorByRow',
  ORDER_BY_MEASUREMENTS: 'orderByMeasurements',
  COLOR_BY_MEASUREMENTS: 'colorByMeasurements',
  GROUP_BY_MEASUREMENTS: 'groupByMeasurements'
};

/**
 * @returns {{type: string, id: string, name: string, preMark: string, mark: string}}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.raw = function() {
  return {
    type: this._type,
    id: this._id,
    name: this._name,
    preMark: this._preMarkStr,
    mark: this._markStr
  };
};

/**
 * @param {{type: string, id: string, name: string, preMark: string, mark: string}} o
 * @returns {epiviz.ui.charts.markers.VisualizationMarker}
 */
epiviz.ui.charts.markers.VisualizationMarker.fromRawObject = function(o) {
  return new epiviz.ui.charts.markers.VisualizationMarker(o.type, o.id, o.name, o.preMark, o.mark);
};

// Input 42
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/15/2015
 * Time: 1:56 PM
 */

goog.provide('epiviz.datatypes.ItemFilteredGenomicData');

goog.require('epiviz.datatypes.MapGenomicData');
goog.require('epiviz.utils');
goog.require('epiviz.deferred.Deferred');
goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.datatypes.MeasurementGenomicDataArrayWrapper');

/**
 * @param {epiviz.datatypes.GenomicData} data
 * @param {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.datatypes.GenomicData.ValueItem, boolean>} filter
 * @constructor
 * @extends {epiviz.datatypes.MapGenomicData}
 */
epiviz.datatypes.ItemFilteredGenomicData = function(data, filter) {
  epiviz.datatypes.MapGenomicData.call(this);

  /**
   * @type {epiviz.datatypes.GenomicData}
   * @private
   */
  this._data = data;

  /**
   * @type {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.datatypes.GenomicData.ValueItem, boolean>}
   * @private
   */
  this._filter = filter;

  /**
   * @type {epiviz.deferred.Deferred}
   * @private
   */
  this._deferredInit = null;

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.datatypes.ItemFilteredGenomicData.prototype = epiviz.utils.mapCopy(epiviz.datatypes.MapGenomicData.prototype);
epiviz.datatypes.ItemFilteredGenomicData.constructor = epiviz.datatypes.ItemFilteredGenomicData;

/**
 * @returns {epiviz.deferred.Deferred}
 * @private
 */
epiviz.datatypes.ItemFilteredGenomicData.prototype._initialize = function() {

  if (this._deferredInit) { return this._deferredInit; }

  this._deferredInit = new epiviz.deferred.Deferred();

  var self = this;

  /** @type {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.datatypes.GenomicData.ValueItem, boolean>} */
  var filter = this._filter;

  /** @type {epiviz.datatypes.GenomicData} */
  var data = this._data;

  data.ready(function() {
    filter.preMark()(data).done(function(preFilterVars) {
      /** @type {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.MeasurementGenomicData>} */
      var map = new epiviz.measurements.MeasurementHashtable();

      var measurements = data.measurements();

      epiviz.utils.deferredFor(measurements.length, function(j) {
        var mDeferredIteration = new epiviz.deferred.Deferred();
        var m = measurements[j];
        var mItems = [];
        var mItemsByGlobalIndex = {};

        epiviz.utils.deferredFor(data.size(m), function(i) {
          var dataDeferredIteration = new epiviz.deferred.Deferred();
          var item = data.get(m, i);
          filter.mark()(item, data, preFilterVars).done(function(markResult) {
            if (markResult) {
              mItems.push(item);
              mItemsByGlobalIndex[item.globalIndex] = item;
            }
            dataDeferredIteration.resolve();
          });
          return dataDeferredIteration;
        }).done(function() {
          map.put(m, new epiviz.datatypes.MeasurementGenomicDataArrayWrapper(m, mItems, mItemsByGlobalIndex));
          mDeferredIteration.resolve();
        });

        return mDeferredIteration;
      }).done(function() {
        self._setMap(map);
        self._deferredInit.resolve();
      });
    });
  });

  return this._deferredInit;
};

// goog.inherits(epiviz.datatypes.ItemFilteredGenomicData, epiviz.datatypes.MapGenomicData);

// Input 43
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/15/2015
 * Time: 5:42 PM
 */

goog.provide('epiviz.datatypes.MeasurementOrderedGenomicData');

goog.require('epiviz.datatypes.MapGenomicData');
goog.require('epiviz.deferred.Deferred');
goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.utils');

/**
 * @param {epiviz.datatypes.GenomicData} data
 * @param {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.measurements.Measurement, string|number>} order
 * @constructor
 * @extends {epiviz.datatypes.MapGenomicData}
 */
epiviz.datatypes.MeasurementOrderedGenomicData = function(data, order) {
  epiviz.datatypes.MapGenomicData.call(this);

  /**
   * @type {epiviz.datatypes.GenomicData}
   * @private
   */
  this._data = data;

  /**
   * @type {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.measurements.Measurement, string|number>}
   * @private
   */
  this._order = order;

  /**
   * @type {epiviz.deferred.Deferred}
   * @private
   */
  this._deferredInit = null;

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.datatypes.MeasurementOrderedGenomicData.prototype = epiviz.utils.mapCopy(epiviz.datatypes.MapGenomicData.prototype);
epiviz.datatypes.MeasurementOrderedGenomicData.constructor = epiviz.datatypes.MeasurementOrderedGenomicData;

/**
 * @returns {epiviz.deferred.Deferred}
 * @private
 */
epiviz.datatypes.MeasurementOrderedGenomicData.prototype._initialize = function() {

  if (this._deferredInit) { return this._deferredInit; }

  this._deferredInit = new epiviz.deferred.Deferred();

  var self = this;

  /** @type {epiviz.datatypes.GenomicData} */
  var data = this._data;

  /** @type {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.datatypes.GenomicData.ValueItem, boolean>} */
  var order = this._order;

  data.ready(function() {
    order.preMark()(data).done(function(preOrderVars) {
      /** @type {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.MeasurementGenomicData>} */
      var map = new epiviz.measurements.MeasurementHashtable();

      var measurements = data.measurements();
      var measurementLabels = new epiviz.measurements.MeasurementHashtable();
      epiviz.utils.deferredFor(measurements.length, function(j) {
        var mDeferredIteration = new epiviz.deferred.Deferred();
        var m = measurements[j];
        order.mark()(m, data, preOrderVars).done(function(label) {
          measurementLabels.put(m, label);
          mDeferredIteration.resolve();
        });
        return mDeferredIteration;
      }).done(function() {
        measurements.sort(function(m1, m2) {
          var v1 = measurementLabels.get(m1);
          var v2 = measurementLabels.get(m2);
          return (v1 == v2) ? 0 : (v1 < v2 ? -1 : 1);
        });

        measurements.forEach(function(m) {
          map.put(m, data.getSeries(m));
        });

        self._setMap(map);
        self._deferredInit.resolve();
      });
    });
  });

  return this._deferredInit;
};

// Input 44
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 8:21 PM
 */

goog.provide('epiviz.ui.charts.Chart');

goog.require('epiviz.ui.charts.Visualization');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.deferred.Deferred');
goog.require('epiviz.ui.charts.markers.MeasurementAggregator');
goog.require('epiviz.ui.charts.ChartType');
goog.require('epiviz.datatypes.MeasurementAggregatedGenomicData');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');
goog.require('epiviz.datatypes.ItemFilteredGenomicData');
goog.require('epiviz.datatypes.MeasurementOrderedGenomicData');
goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.ui.charts.VisEventArgs');

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @constructor
 * @extends {epiviz.ui.charts.Visualization.<epiviz.datatypes.GenomicData>}
 */
epiviz.ui.charts.Chart = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Visualization.call(this, id, container, properties);

  /**
   * Constant used for mouse highlighting by location
   * @type {number}
   * @protected
   */
  this._nBins = 100;

  /**
   * Used for mouse highlighting by location
   * @type {?number}
   * @protected
   */
  this._binSize = null;

  /**
   * @type {epiviz.measurements.MeasurementHashtable.<string>}
   * @protected
   */
  this._measurementColorLabels = null;

  /**
   * @type {Object.<number, string>}
   * @protected
   */
  this._globalIndexColorLabels = null;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.Chart.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Visualization.prototype);
epiviz.ui.charts.Chart.constructor = epiviz.ui.charts.Chart;

/**
 * @protected
 */
epiviz.ui.charts.Chart.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Visualization.prototype._initialize.call(this);

  this._svg.classed('base-chart', true);
};

/**
 * Deprecated method, kept for future reference
 * @protected
 * @deprecated
 */
epiviz.ui.charts.Chart.prototype._addFilters = function() {
  var defs = this._svg.append('defs');
  var glow = defs.append('filter')
    .attr('id', this.id() + '-glow');
  glow.append('feGaussianBlur')
    .attr('id', 'gaussianBlur')
    .attr('stdDeviation', '2')
    .attr('result', 'blurResult');
  glow.append('feComposite')
    .attr('id', 'composite')
    .attr('in', 'SourceGraphic')
    .attr('in2', 'blurResult')
    .attr('operator', 'over');

  var contour = defs.append('filter')
    .attr('id', this.id() + '-contour');
  contour.append('feGaussianBlur')
    .attr('in', 'SourceAlpha')
    .attr('stdDeviation', '1')
    .attr('result', 'blur');
  contour.append('feColorMatrix')
    .attr('values', '1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 10 -1 ')
    .attr('result', 'colorMatrix');
  contour.append('feFlood')
    .attr('result', 'fillColor')
    .attr('flood-color', '#800000')
    .attr('in', 'blur');
  contour.append('feComposite')
    .attr('result', 'composite')
    .attr('in', 'fillColor')
    .attr('in2', 'colorMatrix')
    .attr('operator', 'atop');
  contour.append('feComposite')
    .attr('in', 'SourceGraphic')
    .attr('in2', 'composite')
    .attr('operator', 'atop');

  var dropShadow = defs.append('filter')
    .attr('id', this.id() + '-dropshadow')
    .attr('filterUnits', 'userSpaceOnUse')
    .attr('color-interpolation-filters', 'sRGB');
  var temp = dropShadow.append('feComponentTransfer')
    .attr('in', 'SourceAlpha');
  temp.append('feFuncR')
    .attr('type', 'discrete')
    .attr('tableValues', '1');
  temp.append('feFuncG')
    .attr('type', 'discrete')
    .attr('tableValues', 198/255);
  temp.append('feFuncB')
    .attr('type', 'discrete')
    .attr('tableValues', '0');
  dropShadow.append('feGaussianBlur')
    .attr('stdDeviation', '2');
  dropShadow.append('feOffset')
    .attr('dx', '0')
    .attr('dy', '0')
    .attr('result', 'shadow');
  dropShadow.append('feComposite')
    .attr('in', 'SourceGraphic')
    .attr('in2', 'shadow')
    .attr('operator', 'over');
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {epiviz.datatypes.GenomicData} [data]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.ui.charts.Chart.prototype.draw = function(range, data) {
  epiviz.ui.charts.Visualization.prototype.draw.call(this, range, data);
  if (range) {
    this._binSize = Math.ceil((range.end() - range.start()) / this._nBins);
  }

  return [];
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @returns {epiviz.deferred.Deferred}
 */
epiviz.ui.charts.Chart.prototype.transformData = function(range, data) {
  var deferred = new epiviz.deferred.Deferred();
  var self = this;
  epiviz.ui.charts.Visualization.prototype.transformData.call(this, range, data)
    .done(function() {
      if (!self._lastData) { deferred.resolve(); return; }
      self._lastData.ready(function() {
        var isFeatureChart = false;
        self._lastData.measurements().every(function(m) { isFeatureChart = m.type() !== epiviz.measurements.Measurement.Type.RANGE; return !isFeatureChart });

        if (isFeatureChart) {
          var groupByMarker;
          self._markers.every(function(marker) {
            if (marker && marker.type() == epiviz.ui.charts.markers.VisualizationMarker.Type.GROUP_BY_MEASUREMENTS) {
              groupByMarker = marker;
            }
            return !groupByMarker;
          });
          if (groupByMarker) {
            var aggregator = epiviz.ui.charts.markers.MeasurementAggregators[
              self.customSettingsValues()[epiviz.ui.charts.ChartType.CustomSettings.MEASUREMENT_GROUPS_AGGREGATOR]];
            self._lastData = new epiviz.datatypes.MeasurementAggregatedGenomicData(self._lastData, groupByMarker, aggregator);
          }
        }

        var filter;
        self._markers.every(function(marker) {
          if (marker && marker.type() == epiviz.ui.charts.markers.VisualizationMarker.Type.FILTER) {
            filter = marker;
          }
          return !filter;
        });
        if (filter) { self._lastData = new epiviz.datatypes.ItemFilteredGenomicData(self._lastData, filter); }

        var order;
        self._markers.every(function(marker) {
          if (marker && marker.type() == epiviz.ui.charts.markers.VisualizationMarker.Type.ORDER_BY_MEASUREMENTS) {
            order = marker;
          }
          return !order;
        });

        if (order) { self._lastData = new epiviz.datatypes.MeasurementOrderedGenomicData(self._lastData, order); }

        self._lastData.ready(function() {
          // self._lastData might have changed since we started to wait for it
          // so check the last version of it
          var data = self._lastData;
          if (data.isReady()) {
            // Also reassign color labels for both measurements and global indices
            var deferredColorByMeasurements = new epiviz.deferred.Deferred();
            var colorByMeasurements;
            self._markers.every(function(marker) {
              if (marker && marker.type() == epiviz.ui.charts.markers.VisualizationMarker.Type.COLOR_BY_MEASUREMENTS) {
                colorByMeasurements = marker;
              }
              return !colorByMeasurements;
            });

            self._measurementColorLabels = null;
            if (colorByMeasurements) {
              var measurementColorLabels = new epiviz.measurements.MeasurementHashtable();
              colorByMeasurements.preMark()(data).done(function(preColorVars) {
                var measurements = data.measurements();
                epiviz.utils.deferredFor(measurements.length, function(j) {
                  var mDeferredIteration = new epiviz.deferred.Deferred();
                  colorByMeasurements.mark()(measurements[j], data, preColorVars).done(function(label) {
                    measurementColorLabels.put(measurements[j], label);
                    mDeferredIteration.resolve();
                  });
                  return mDeferredIteration;
                }).done(function() {
                  self._measurementColorLabels = measurementColorLabels;
                  deferredColorByMeasurements.resolve();
                });
              });
            } else {
              deferredColorByMeasurements.resolve();
            }

            var deferredColorByGlobalIndices = new epiviz.deferred.Deferred();
            var colorByGlobalIndices;
            self._markers.every(function(marker) {
              if (marker && marker.type() == epiviz.ui.charts.markers.VisualizationMarker.Type.COLOR_BY_ROW) {
                colorByGlobalIndices = marker;
              }
              return !colorByGlobalIndices;
            });

            self._globalIndexColorLabels = null;
            if (colorByGlobalIndices) {
              var globalIndexColorLabels = {};
              colorByGlobalIndices.preMark()(data).done(function(preColorVars) {
                var firstSeries = data.firstSeries();
                epiviz.utils.deferredFor(firstSeries.size(), function(j) {
                  var seriesDeferredIteration = new epiviz.deferred.Deferred();
                  colorByGlobalIndices.mark()(firstSeries.getRow(j), data, preColorVars).done(function(label) {
                    globalIndexColorLabels[j + firstSeries.globalStartIndex()] = label;
                    seriesDeferredIteration.resolve();
                  });
                  return seriesDeferredIteration;
                }).done(function() {
                  self._globalIndexColorLabels = globalIndexColorLabels;
                  deferredColorByGlobalIndices.resolve();
                });
              });
            } else {
              deferredColorByGlobalIndices.resolve();
            }

            deferredColorByMeasurements.done(function() {
              if (deferredColorByGlobalIndices.state() == epiviz.deferred.Deferred.State.RESOLVED) {
                self._dataWaitEnd.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
                deferred.resolve();
              }
            });

            deferredColorByGlobalIndices.done(function() {
              if (deferredColorByMeasurements.state() == epiviz.deferred.Deferred.State.RESOLVED) {
                self._dataWaitEnd.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
                deferred.resolve();
              }
            });
          }
        });
      });
    });
  return deferred;
};

/**
 * @returns {epiviz.ui.charts.VisualizationProperties}
 */
epiviz.ui.charts.Chart.prototype.properties = function() {
  return /** @type {epiviz.ui.charts.VisualizationProperties} */ epiviz.ui.charts.Visualization.prototype.properties.call(this);
};

// Input 45
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/15/2014
 * Time: 11:03 AM
 */

goog.provide('epiviz.ui.charts.VisObject');

goog.require('epiviz.utils');

/**
 * @constructor
 */
epiviz.ui.charts.VisObject = function() {};

/**
 * @returns {number}
 */
epiviz.ui.charts.VisObject.prototype.regionStart = function() {
    return null; };

/**
 * @returns {number}
 */
epiviz.ui.charts.VisObject.prototype.regionEnd = function() {
    return null; };

/**
 * Measurement i, object j
 * @param {number} i
 * @param {number} j
 * @param {string} metadataCol
 * @returns {string}
 */
epiviz.ui.charts.VisObject.prototype.getMetadata = function(i, j, metadataCol) {
    return null; };

/**
 * Measurement i, object j
 * @param {number} i
 * @param {number} j
 * @returns {number}
 */
epiviz.ui.charts.VisObject.prototype.getStart = function(i, j) {
    return null; };

/**
 * Measurement i, object j
 * @param {number} i
 * @param {number} j
 * @returns {number}
 */
epiviz.ui.charts.VisObject.prototype.getEnd = function(i, j) {
    return null; };

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.VisObject.prototype.metadataColumns = function() {
    return null; };

/**
 * Number of measurements times number of objects stored per measurement
 * @returns {Array.<number>}
 */
epiviz.ui.charts.VisObject.prototype.dimensions = function() {
    return [0, 0]; };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.VisObject.prototype.metadataLooseCompare = function() {
    return false; };

/**
 * @param {epiviz.ui.charts.VisObject} other
 * @returns {boolean}
 */
epiviz.ui.charts.VisObject.prototype.overlapsWith = function(other) {
    if (!other) {
        return false; }
    if (this === other) {
        return true; }

    var i, j, k;

    // If this is a generic selection with no cells inside, then check its start and end against
    // the other object's cells/location
    var thisDim = this.dimensions();
    var otherDim = other.dimensions();

    if ((!thisDim[0] || !otherDim[0]) &&
        (this.regionStart() == undefined || other.regionStart() == undefined || this.regionEnd() == undefined || other.regionEnd() == undefined)) {

        return false;
    }

    if (!thisDim[0]) {
        if (!otherDim[0]) {
            return (this.regionStart() < other.regionEnd() && this.regionEnd() > other.regionStart());
        }

        for (j = 0; j < otherDim[1]; ++j) {
            var otherRowStart = other.getStart(0, j);
            var otherRowEnd = other.getEnd(0, j);

            if (otherRowStart != undefined && otherRowEnd != undefined &&
                this.regionStart() < otherRowEnd && this.regionEnd() > otherRowStart) {
                return true;
            }
        }

        return false;
    }

    // Check metadata
    var commonMetadata = epiviz.utils.arrayIntersection(this.metadataColumns(), other.metadataColumns());

    if (commonMetadata.length) {
        for (i = 0; i < thisDim[1]; ++i) {
            for (j = 0; j < otherDim[1]; ++j) {
                var metadataMatches = true;
                for (k = 0; k < commonMetadata.length; ++k) {
                    var useLooseCompare = this.metadataLooseCompare() || other.metadataLooseCompare();
                    var thisM = this.getMetadata(0, i, commonMetadata[k]);
                    var otherM = other.getMetadata(0, j, commonMetadata[k]);

                    if (thisM == otherM) {
                        continue; }
                    if (!useLooseCompare) { metadataMatches = false;
                        break; }

                    var first, second;
                    if (thisM.length <= otherM.length) {
                        first = thisM;
                        second = otherM;
                    } else {
                        first = otherM;
                        second = thisM;
                    }

                    var r = new RegExp('^(.+,)?' + first + '(,.+)?$');

                    if (!r.test(second)) {
                        metadataMatches = false;
                        break;
                    }
                }

                if (metadataMatches) {
                    return true;
                }
            }
        }

        return false;
    }

    // If there are no common metadata columns, then we'll check for location overlaps
    for (i = 0; i < thisDim[1]; ++i) {
        for (j = 0; j < otherDim[1]; ++j) {
            if (this.getStart(0, i) < other.getEnd(0, j) && this.getEnd(0, i) > other.getStart(0, j)) {
                return true;
            }
        }
    }

    return false;
};
// Input 46
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/25/14
 * Time: 2:03 PM
 */

goog.provide('epiviz.ui.charts.ChartObject');

goog.require('epiviz.ui.charts.VisObject');


/**
 * A struct for various objects in visualizations, like blocks, genes or circles in scatter plots
 * @param {string} id
 * @param {number} start
 * @param {number} end
 * @param {?Array.<number>} [values] One for each measurement
 * @param {number} [seriesIndex]
 * @param {Array.<Array.<epiviz.datatypes.GenomicData.ValueItem>>} [valueItems] For each measurement, an array of value items
 * @param {Array.<epiviz.measurements.Measurement>} [measurements]
 * @param {string} [cssClasses]
 * @constructor
 * @struct
 * @extends {epiviz.ui.charts.VisObject}
 */
epiviz.ui.charts.ChartObject = function(id, start, end, values, seriesIndex, valueItems, measurements, cssClasses) {
  epiviz.ui.charts.VisObject.call(this);

  /**
   * @type {string}
   */
  this.id = id;

  /**
   * @type {number}
   */
  this.start = start;

  /**
   * @type {number}
   */
  this.end = end;

  /**
   * @type {?Array<number>}
   */
  this.values = values;

  /**
   * @type {number}
   */
  this.seriesIndex = seriesIndex;

  /**
   * For each measurement, an array of value items
   * @type {Array.<Array.<epiviz.datatypes.GenomicData.ValueItem>>}
   */
  this.valueItems = valueItems;

  /**
   * @type {Array.<epiviz.measurements.Measurement>}
   */
  this.measurements = measurements;

  /**
   * @type {string}
   */
  this.cssClasses = cssClasses;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.ChartObject.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.VisObject.prototype);
epiviz.ui.charts.ChartObject.constructor = epiviz.ui.charts.ChartObject;

/**
 * @returns {number}
 */
epiviz.ui.charts.ChartObject.prototype.regionStart = function() { return this.start; };

/**
 * @returns {number}
 */
epiviz.ui.charts.ChartObject.prototype.regionEnd = function() { return this.end; };

/**
 * @param {number} i
 * @param {number} j
 * @param {string} metadataCol
 * @returns {string}
 */
epiviz.ui.charts.ChartObject.prototype.getMetadata = function(i, j, metadataCol) {
  if (this.valueItems) {
    return this.valueItems[i][j].rowItem.metadata(metadataCol);
  }

  return null;
};

/**
 * Measurement i, object j
 * @param {number} i
 * @param {number} j
 * @returns {number}
 */
epiviz.ui.charts.ChartObject.prototype.getStart = function(i, j) { return this.valueItems[i][j].rowItem.start(); };

/**
 * Measurement i, object j
 * @param {number} i
 * @param {number} j
 * @returns {number}
 */
epiviz.ui.charts.ChartObject.prototype.getEnd = function(i, j) { return this.valueItems[i][j].rowItem.end(); };

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.ChartObject.prototype.metadataColumns = function() { return Object.keys(this.valueItems[0][0].rowItem.rowMetadata()); };

/**
 * Number of measurements times number of objects stored per measurement
 * @returns {Array.<number>}
 */
epiviz.ui.charts.ChartObject.prototype.dimensions = function() {
  var ret = [];

  if (this.valueItems) {
    ret.push(this.valueItems.length);
    if (this.valueItems.length) {
      ret.push(this.valueItems[0].length);
    } else {
      ret.push(0);
    }
    return ret;
  }

  return [0, 0];
};

// Input 47
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/22/13
 * Time: 6:47 PM
 */

goog.provide('epiviz.ui.charts.Track');

goog.require('epiviz.ui.charts.Chart');
goog.require('epiviz.ui.charts.VisualizationType');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.ui.charts.Axis');

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Chart}
 * @constructor
 */
epiviz.ui.charts.Track = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Chart.call(this, id, container, properties);

  /**
   * D3 rectangle in the SVG
   * @type {*}
   * @protected
   */
  this._background = null;

  /**
   * D3 group in the SVG used for adding hover/selection elements
   * @type {*}
   * @protected
   */
  this._highlightGroup = null;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.Track.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Chart.prototype);
epiviz.ui.charts.Track.constructor = epiviz.ui.charts.Track;


/**
 * Initializes the chart and draws the initial SVG in the container
 * @protected
 */
epiviz.ui.charts.Track.prototype._initialize = function() {
  this._properties.width = '100%';

  epiviz.ui.charts.Chart.prototype._initialize.call(this);

  var self = this;

  this._highlightGroup = this._svg
    .append('g')
    .attr('class', 'track-highlight');

  this._background = this._svg
    .append('rect')
    .attr('class', 'chart-background')
    .attr('x', 0)
    .attr('y', 0)
    .attr('width', '100%')
    .attr('height', '100%')
    .attr('fill', '#ffffff')
    .attr('fill-opacity', '0');

  this._background
    .on('mouseover', function() { self._captureMouseHover(); })
    .on('mousemove', function() { self._captureMouseHover(); })
    .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.ui.charts.Track.prototype.draw = function(range, data, slide, zoom) {
  var result = epiviz.ui.charts.Chart.prototype.draw.call(this, range, data);

  this._drawLegend();

  return result;
};

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.Track.prototype.displayType = function() { return epiviz.ui.charts.VisualizationType.DisplayType.TRACK; };

/**
 * @param {epiviz.ui.charts.ChartObject} selectedObject
 */
epiviz.ui.charts.Track.prototype.doHover = function(selectedObject) {
  epiviz.ui.charts.Chart.prototype.doHover.call(this, selectedObject);

  if (selectedObject.start == undefined || selectedObject.end == undefined) {
    return;
  }

  if (!this._lastRange) { return; }

  this._highlightGroup.selectAll('rect').remove();
  this._highlightGroup.attr('transform', 'translate(' + this.margins().left() + ', ' + 0 + ')');

  var Axis = epiviz.ui.charts.Axis;
  var xScale = d3.scale.linear()
    .domain([this._lastRange.start(), this._lastRange.end()])
    .range([0, this.width() - this.margins().sumAxis(Axis.X)]);

  var items = [];
  if (!selectedObject.measurements || !selectedObject.measurements.length) {
    items.push({start: selectedObject.start, end: selectedObject.end});
  } else {
    for (var i = 0; i < selectedObject.valueItems[0].length; ++i) {
      var rowItem = selectedObject.valueItems[0][i].rowItem;
      items.push({start: rowItem.start(), end: rowItem.end()});
    }
  }

  var minHighlightSize = 5;
  this._highlightGroup.selectAll('rect').data(items, function(d) { return sprintf('%s-%s', d.start, d.end); })
    .enter()
    .append('rect')
    .style('fill', this.colors().get(0))
    .style('fill-opacity', '0.1')
    .attr('x', function(d) {
      var defaultWidth = xScale(d.end + 1) - xScale(d.start);
      var width = Math.max(minHighlightSize, defaultWidth);
      return xScale(d.start) + defaultWidth * 0.5 - width * 0.5;
    })
    .attr('width', function(d) { return Math.max(minHighlightSize, xScale(d.end + 1) - xScale(d.start)); })
    .attr('y', 0)
    .attr('height', this.height());
};

/**
 */
epiviz.ui.charts.Track.prototype.doUnhover = function() {
  epiviz.ui.charts.Chart.prototype.doUnhover.call(this);

  this._highlightGroup.selectAll('rect').remove();
};

/**
 * @protected
 */
epiviz.ui.charts.Track.prototype._captureMouseHover = function() {
  if (!this._lastRange) { return; }
  this._unhover.notify(new epiviz.ui.charts.VisEventArgs(this.id()));
  var inverseXScale = d3.scale.linear()
    .domain([0, this.width()])
    .range([this._lastRange.start(), this._lastRange.end()]);
  var start = inverseXScale(d3.mouse(this._background[0][0])[0]) - this._binSize / 2;
  var end = start + this._binSize;

  var selectedObject = new epiviz.ui.charts.ChartObject(sprintf('%s-highlight', this.id()), start, end);
  this._hover.notify(new epiviz.ui.charts.VisEventArgs(this.id(), selectedObject));
};

/**
 * @private
 */
epiviz.ui.charts.Track.prototype._drawLegend = function() {
  var self = this;
  this._svg.selectAll('.chart-title').remove();
  this._svg.selectAll('.chart-title-color ').remove();

  if (!this._lastData || !this._lastData.isReady()) { return; }

  var title = '';
  var measurements = this._lastData.measurements();

  var titleEntries = this._svg
    .selectAll('.chart-title')
    .data(measurements)
    .enter()
    .append('text')
    .attr('class', 'chart-title')
    .attr('font-weight', 'bold')
    .attr('fill', function(m, i) {
      if (!self._measurementColorLabels) { return self.colors().get(i); }
      return self.colors().getByKey(self._measurementColorLabels.get(m));
    })
    .attr('y', self.margins().top() - 5)
    .text(function(m, i) { return m.name(); });

  var textLength = 0;
  var titleEntriesStartPosition = [];

  $('#' + this.id() + ' .chart-title')
    .each(function(i) {
      titleEntriesStartPosition.push(textLength);
      textLength += this.getBBox().width + 15;
    });

  titleEntries.attr('x', function(column, i) {
    return self.margins().left() + 10 + titleEntriesStartPosition[i];
  });

  var colorEntries = this._svg
    .selectAll('.chart-title-color')
    .data(measurements)
    .enter()
    .append('circle')
    .attr('class', 'chart-title-color')
    .attr('cx', function(column, i) { return self.margins().left() + 4 + titleEntriesStartPosition[i]; })
    .attr('cy', self.margins().top() - 9)
    .attr('r', 4)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .style('fill', function(m, i) {
      if (!self._measurementColorLabels) { return self.colors().get(i); }
      return self.colors().getByKey(self._measurementColorLabels.get(m));
    });
};

// Input 48
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/16/13
 * Time: 9:35 AM
 */

goog.provide('epiviz.plugins.charts.BlocksTrack');

goog.require('epiviz.ui.charts.Track');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.ui.charts.Visualization');


/**
 * @param id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Track}
 * @constructor
 */
epiviz.plugins.charts.BlocksTrack = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Track.call(this, id, container, properties);

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.BlocksTrack.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Track.prototype);
epiviz.plugins.charts.BlocksTrack.constructor = epiviz.plugins.charts.BlocksTrack;

/**
 * @protected
 */
epiviz.plugins.charts.BlocksTrack.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Track.prototype._initialize.call(this);

  this._svg.classed('blocks-track', true);
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.BlocksTrack.prototype.draw = function(range, data, slide, zoom) {

  epiviz.ui.charts.Track.prototype.draw.call(this, range, data, slide, zoom);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  // If data is not defined, there is nothing to draw
  if (!data || !range || !data.isReady()) { return []; }

  return this._drawBlocks(range, data, slide || 0, zoom || 1);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {number} slide
 * @param {number} zoom
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.BlocksTrack.prototype._drawBlocks = function(range, data, slide, zoom) {
  var Axis = epiviz.ui.charts.Axis;

  /** @type {number} */
  var start = range.start();

  /** @type {number} */
  var end = range.end();

  /** @type {number} */
  var width = this.width();

  /** @type {number} */
  var height = this.height();

  /** @type {epiviz.ui.charts.Margins} */
  var margins = this.margins();

  /** @type {epiviz.measurements.MeasurementSet} */
  var measurements = this.measurements();

  /** @type {epiviz.ui.charts.ColorPalette} */
  var colors = this.colors();

  var minBlockDistance = this.customSettingsValues()[epiviz.plugins.charts.BlocksTrackType.CustomSettings.MIN_BLOCK_DISTANCE];

  var colorLabel = this.customSettingsValues()[epiviz.plugins.charts.BlocksTrackType.CustomSettings.BLOCK_COLOR_BY];

  var useColorBy = this.customSettingsValues()[epiviz.plugins.charts.BlocksTrackType.CustomSettings.USE_COLOR_BY];

  var colorBy = function(row) {
    if(data.measurements().length > 1) {
      return colors.get(row.seriesIndex);
    }

    return useColorBy ? colors.getByKey(row.values) : colors.get(row.seriesIndex);
  };

  var xScale = d3.scale.linear()
    .domain([start, end])
    .range([0, width - margins.sumAxis(Axis.X)]);
  var delta = slide * (width - margins.sumAxis(Axis.X)) / (end - start);

  this._clearAxes();
  this._drawAxes(xScale, null, 10, 5);

  var self = this;
  /** @type {Array.<epiviz.ui.charts.ChartObject>} */
  var blocks = [];

  var i = 0;

  data.foreach(function(m, series, seriesIndex) {
    var seriesBlocks = [];

    for (var j = 0; j < series.size(); ++j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);

      if (cell.rowItem.start() > range.end() || cell.rowItem.end() < range.start()) { continue; }

      var classes = sprintf('item data-series-%s', i);


      if (minBlockDistance !== null && seriesBlocks.length > 0) {
        var lastBlock = seriesBlocks[seriesBlocks.length - 1];
        var start = xScale(cell.rowItem.start());
        var lastEnd = xScale(lastBlock.end);

        if (start - lastEnd < minBlockDistance) {
          lastBlock.end = Math.max(lastBlock.end, cell.rowItem.end());
          lastBlock.valueItems[0].push(cell);
          lastBlock.id = sprintf('b-%s-%s-%s', i, lastBlock.start, lastBlock.end);
          continue;
        }
      }

      seriesBlocks.push(new epiviz.ui.charts.ChartObject(
        sprintf('b-%s-%s-%s', i, cell.rowItem.start(), cell.rowItem.end()),
        cell.rowItem.start(),
        cell.rowItem.end(),
        cell.rowItem.metadata(colorLabel),
        i, // seriesIndex
        [[cell]], // valueItems
        [m], // measurements
        classes));
    }

    blocks = blocks.concat(seriesBlocks);
    ++i;
  });

  var items = this._svg.select('.items');
  var selected = items.select('.selected');
  var clipPath = this._svg.select('#clip-' + this.id());

  if (items.empty()) {
    if (clipPath.empty()) {
      this._svg.select('defs')
        .append('clipPath')
        .attr('id', 'clip-' + this.id())
        .append('rect')
        .attr('class', 'clip-path-rect');
    }

    items = this._svg.append('g')
      .attr('class', 'items')
      .attr('id', this.id() + '-gene-content')
      .attr('clip-path', 'url(#clip-' + this.id() + ')');

    selected = items.append('g').attr('class', 'selected');
    items.append('g').attr('class', 'hovered');
    selected.append('g').attr('class', 'hovered');
  }

  items.attr('transform', 'translate(' + margins.left() + ', ' + margins.top() + ')');

  this._svg.select('.clip-path-rect')
    .attr('x', 0)
    .attr('y', 0)
    .attr('width', width - margins.sumAxis(Axis.X))
    .attr('height', height - margins.sumAxis(Axis.Y));

  items.selectAll('.item').remove();

  var selection = items.selectAll('.item')
    .data(blocks, function(b) { return b.id; });

  selection
    .enter()
    .insert('rect', ':first-child')
    .attr('class', function(b) { return b.cssClasses; })
    .style('fill', function(b) { return colorBy(b); })
    .attr('x', function(b) {
      return xScale(b.start) / zoom + delta;
    })
    .attr('width', function(b) {
      // We're using b.end + 1 since b.end is the index of the last covered bp
      return zoom * (xScale(b.end + 1) - xScale(b.start));
    })
    .on('mouseout', function () {
      self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
    })
    .on('mouseover', function (b) {
      self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), b));
    })
    .on('click', function(b) {
      self._deselect.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
      self._select.notify(new epiviz.ui.charts.VisEventArgs(self.id(), b));
      d3.event.stopPropagation();
    });

  selection
    .attr('class', function(b) { return b.cssClasses; })
    .attr('height', height - margins.sumAxis(Axis.Y))
    .attr('y', 0)
    .transition()
    .duration(500)
    .attr('x', function(b) { return xScale(b.start); })
    .attr('width', function(b) { return xScale(b.end + 1) - xScale(b.start); });

  selection
    .exit()
    .transition()
    .duration(500)
    .attr('x', function(b) { return xScale(b.start); })
    .remove();

  return blocks;
};

/**
 * @param {epiviz.ui.charts.ColorPalette} colors
 */
epiviz.plugins.charts.BlocksTrack.prototype.setColors = function(colors) {
  this.container().find('.items').remove();
  epiviz.ui.charts.Visualization.prototype.setColors.call(this, colors);
};

// goog.inherits(epiviz.plugins.charts.BlocksTrack, epiviz.plugins.charts.Track);
// Input 49
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/22/13
 * Time: 6:49 PM
 */

goog.provide('epiviz.ui.charts.TrackType');

goog.require('epiviz.ui.charts.ChartType');
goog.require('epiviz.ui.charts.VisualizationType');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.ChartType}
 * @constructor
 */
epiviz.ui.charts.TrackType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.ChartType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.TrackType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.ChartType.prototype);
epiviz.ui.charts.TrackType.constructor = epiviz.ui.charts.TrackType;

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.TrackType.prototype.chartDisplayType = function() { return epiviz.ui.charts.VisualizationType.DisplayType.TRACK; };

/**
 * @returns {string}
 */
epiviz.ui.charts.TrackType.prototype.cssClass = function() {
  return 'track-container ui-widget-content';
};

// Input 50
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/16/13
 * Time: 9:36 AM
 */

goog.provide('epiviz.plugins.charts.BlocksTrackType');

goog.require('epiviz.plugins.charts.BlocksTrack');
goog.require('epiviz.ui.charts.TrackType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.TrackType}
 * @constructor
 */
epiviz.plugins.charts.BlocksTrackType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.TrackType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.BlocksTrackType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.TrackType.prototype);
epiviz.plugins.charts.BlocksTrackType.constructor = epiviz.plugins.charts.BlocksTrackType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.BlocksTrack}
 */
epiviz.plugins.charts.BlocksTrackType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.BlocksTrack(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.BlocksTrackType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.BlocksTrack';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.BlocksTrackType.prototype.chartName = function() {
  return 'Blocks Track';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.BlocksTrackType.prototype.chartHtmlAttributeName = function() {
  return 'blocks';
};

/**
 * @returns {epiviz.measurements.Measurement.Type}
 */
/*epiviz.plugins.charts.BlocksTrackType.prototype.chartContentType = function() {
  return epiviz.measurements.Measurement.Type.RANGE;
};*/

/**
 * @returns {boolean}
 */
epiviz.plugins.charts.BlocksTrackType.prototype.isRestrictedToRangeMeasurements = function() { return true; };

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.BlocksTrackType.prototype.measurementsFilter = function() { return function(m) { return m.type() == epiviz.measurements.Measurement.Type.RANGE; }; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.BlocksTrackType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.TrackType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.BlocksTrackType.CustomSettings.MIN_BLOCK_DISTANCE,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      5,
      'Minimum block distance'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.BlocksTrackType.CustomSettings.USE_COLOR_BY,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      false,
      'Use Block Color by'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.BlocksTrackType.CustomSettings.BLOCK_COLOR_BY,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_METADATA,
      'colLabel',
      'Block color by')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.BlocksTrackType.CustomSettings = {
  MIN_BLOCK_DISTANCE: 'minBlockDistance',
  BLOCK_COLOR_BY: 'blockColorBy',
  USE_COLOR_BY: 'useColorBy'
};

// goog.inherits(epiviz.plugins.charts.BlocksTrackType, epiviz.ui.charts.TrackType);

// Input 51
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 9:30 AM
 */

goog.provide('epiviz.plugins.charts.LineTrack');

goog.require('epiviz.ui.charts.Track');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.datatypes.GenomicRange');
goog.require('epiviz.ui.charts.CustomSetting');


/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Track}
 * @constructor
 */
epiviz.plugins.charts.LineTrack = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Track.call(this, id, container, properties);

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.LineTrack.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Track.prototype);
epiviz.plugins.charts.LineTrack.constructor = epiviz.plugins.charts.LineTrack;

/**
 * @protected
 */
epiviz.plugins.charts.LineTrack.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Track.prototype._initialize.call(this);
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.LineTrack.prototype.draw = function(range, data, slide, zoom) {
  epiviz.ui.charts.Track.prototype.draw.call(this, range, data, slide, zoom);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  slide = slide || this._slide || 0;
  zoom = zoom || this._zoom || 1;
  this._slide = 0;
  this._zoom = 1;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  var CustomSetting = epiviz.ui.charts.CustomSetting;
  var minY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MIN];
  var maxY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MAX];

  if (minY == CustomSetting.DEFAULT) {
    minY = null;
    this.measurements().foreach(function(m) {
      if (m === null) { return; }
      if (minY === null || m.minValue() < minY) { minY = m.minValue(); }
    });
  }

  if (maxY == CustomSetting.DEFAULT) {
    maxY = null;
    this.measurements().foreach(function(m) {
      if (m === null) { return; }
      if (maxY === null || m.maxValue() > maxY) { maxY = m.maxValue(); }
    });
  }

  if (minY === null && maxY === null) { minY = -1; maxY = 1; }
  if (minY === null) { minY = maxY - 1; }
  if (maxY === null) { maxY = minY + 1; }

  var Axis = epiviz.ui.charts.Axis;
  var xScale = d3.scale.linear()
    .domain([range.start(), range.end()])
    .range([0, this.width() - this.margins().sumAxis(Axis.X)]);
  var yScale = d3.scale.linear()
    .domain([minY, maxY])
    .range([this.height() - this.margins().sumAxis(Axis.Y), 0]);

  this._clearAxes();
  this._drawAxes(xScale, yScale, 10, 5);

  var delta = slide * (this.width() - this.margins().sumAxis(Axis.X)) / range.width();
  var linesGroup = this._svg.selectAll('.lines');

  if (linesGroup.empty()) {
    linesGroup = this._svg.append('g')
      .attr('class', 'lines')
      .attr('transform', 'translate(' + this.margins().left() + ', ' + this.margins().top() + ')');
  }

  data.measurements().forEach(function(m, i) {
    var lineSeries = linesGroup.selectAll('.line-series-index-' + i);
    var pointSeries = linesGroup.selectAll('.point-series-index-' + i);

    if (lineSeries.empty()) { linesGroup.append('g').attr('class', 'line-series-index-' + i); }
    if (pointSeries.empty()) { linesGroup.append('g').attr('class', 'point-series-index-' + i); }
  });

  for (var i = data.measurements().length;; ++i) {
    var lineSeries = linesGroup.selectAll('.line-series-index-' + i);
    var pointSeries = linesGroup.selectAll('.point-series-index-' + i);
    if (lineSeries.empty()) { break; }
    lineSeries.remove();
    pointSeries.remove();
  }

  return this._drawLines(range, data, delta, zoom, xScale, yScale);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {number} delta
 * @param {number} zoom
 * @param {function} xScale D3 linear scale
 * @param {function} yScale D3 linear scale
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.LineTrack.prototype._drawLines = function(range, data, delta, zoom, xScale, yScale) {
  /** @type {epiviz.ui.charts.ColorPalette} */
  var colors = this.colors();

  /** @type {number} */
  var step = parseInt(this.customSettingsValues()[epiviz.plugins.charts.LineTrackType.CustomSettings.STEP]);

  /** @type {boolean} */
  var showPoints = this.customSettingsValues()[epiviz.plugins.charts.LineTrackType.CustomSettings.SHOW_POINTS];

  /** @type {boolean} */
  var showLines = this.customSettingsValues()[epiviz.plugins.charts.LineTrackType.CustomSettings.SHOW_LINES];

  /** @type {boolean} */
  var showErrorBars = this.customSettingsValues()[epiviz.plugins.charts.LineTrackType.CustomSettings.SHOW_ERROR_BARS];

  /** @type {number} */
  var pointRadius = this.customSettingsValues()[epiviz.plugins.charts.LineTrackType.CustomSettings.POINT_RADIUS];

  /** @type {number} */
  var lineThickness = this.customSettingsValues()[epiviz.plugins.charts.LineTrackType.CustomSettings.LINE_THICKNESS];

  var interpolation = this.customSettingsValues()[epiviz.plugins.charts.LineTrackType.CustomSettings.INTERPOLATION];

  var self = this;

  var invXScale = d3.scale.linear()
    .domain([0, this.width() - this.margins().sumAxis(epiviz.ui.charts.Axis.X)])
    .range([range.start(), range.end()]);
  var deltaInBp = invXScale(delta) - range.start();
  var extendedRange = epiviz.datatypes.GenomicRange.fromStartEnd(
    range.seqName(),
    Math.min(range.start(), range.start() + deltaInBp),
    Math.max(range.end(), range.end() + deltaInBp));

  var graph = this._svg.select('.lines');

  /** @type {Array.<epiviz.ui.charts.ChartObject>} */
  var items = [];

  data.foreach(function(m, series, i) {
    var color = self._measurementColorLabels ? colors.getByKey(self._measurementColorLabels.get(m)) : colors.get(i);

    /** @type {{index: ?number, length: number}} */
    var drawBoundaries = series.binarySearchStarts(extendedRange);
    if (drawBoundaries.length == 0) { return; }

    // TODO: In the future, use global index to align steps:
    //var globalIndex = series.get(drawBoundaries.index).globalIndex;
    //globalIndex = Math.ceil(globalIndex / step) * step;
    var index = Math.ceil(drawBoundaries.index / step) * step;
    drawBoundaries.length = Math.max(0, drawBoundaries.length - index + drawBoundaries.index);
    drawBoundaries.index = index;

    var indices = epiviz.utils.range(drawBoundaries.length, drawBoundaries.index)
      .filter(function(i) {
        return !step || step <= 1 || ((i - drawBoundaries.index) % step == 0);
      });

    for (var k = 0; k < indices.length; ++k) {
      var cell = series.get(indices[k]);
      items.push(new epiviz.ui.charts.ChartObject(sprintf('line_%s_%s', i, cell.globalIndex), cell.rowItem.start(), cell.rowItem.end(), [cell.value], i, [[cell]], [m], sprintf('item data-series-%s', i)));
    }

    var x = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      return xScale(cell.rowItem.start());
    };

    var y = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      return yScale(cell.value);
    };

    var errMinus = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      var v = cell.valueAnnotation ? cell.valueAnnotation['errMinus'] : null;
      return v != undefined ? yScale(v) : null;
    };

    var errPlus = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      var v = cell.valueAnnotation ? cell.valueAnnotation['errPlus'] : null;
      return v != undefined ? yScale(v) : null;
    };

    if (showLines) {
      var line = d3.svg.line()
        .x(x).y(y)
        .interpolate(interpolation);

      var lines = graph.select('.line-series-index-' + i)
        .selectAll('path')
        .data([indices]);

      lines.enter()
        .append('path')
        .attr('d', line)
        .style('shape-rendering', 'auto')
        .style('stroke-opacity', '0.8')
        .on('mouseover', function() { self._captureMouseHover(); })
        .on('mousemove', function() { self._captureMouseHover(); })
        .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });

      lines
        .attr('d', line)
        .style('stroke', color)
        .style('stroke-width', lineThickness)
        .attr('transform', 'translate(' + (+delta) + ')')
        .transition()
        .duration(500)
        .attr('transform', 'translate(' + (0) + ')');
    } else {
      graph.select('.line-series-index-' + i)
        .selectAll('path').remove();
    }

    graph.select('.point-series-index-' + i)
      .selectAll('circle').remove();
    graph.select('.point-series-index-' + i)
      .selectAll('.error-bar').remove();
    if (showPoints) {
      var points = graph.select('.point-series-index-' + i)
        .selectAll('circle')
        .data(indices);
      points.enter()
        .append('circle')
        .attr('class', 'point-series-index-' + i)
        .attr('r', pointRadius)
        .attr('cx', x)
        .attr('cy', y)
        .attr('fill', color)
        .attr('stroke', color)
        .attr('transform', 'translate(' + (+delta) + ')')
        .transition()
        .duration(500)
        .attr('transform', 'translate(' + (0) + ')');

      points
        .on('mouseover', function() { self._captureMouseHover(); })
        .on('mousemove', function() { self._captureMouseHover(); })
        .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });

      points.exit()
        .transition()
        .duration(500)
        .style('opacity', 0)
        .remove();

      if (showErrorBars) {
        var errorBars = graph.select('.point-series-index-' + i)
          .selectAll('.error-bar')
          .data(indices);
        errorBars.enter()
          .append('g')
          .attr('class', 'error-bar')
          .each(function(j) {
            var m = errMinus(j), p = errPlus(j);
            if (m == null || p == null) { return; }
            d3.select(this).append('line')
              .attr('x1', x(j)).attr('x2', x(j)).attr('y1', m).attr('y2', p)
              .style('stroke', color)
              .style('shape-rendering', 'auto');
            d3.select(this).append('line')
              .attr('x1', x(j) - 2).attr('x2', x(j) + 2).attr('y1', m).attr('y2', m)
              .style('stroke', color)
              .style('shape-rendering', 'auto');
            d3.select(this).append('line')
              .attr('x1', x(j) - 2).attr('x2', x(j) + 2).attr('y1', p).attr('y2', p)
              .style('stroke', color)
              .style('shape-rendering', 'auto');
          })
          .attr('transform', 'translate(' + (+delta) + ')')
          .transition()
          .duration(500)
          .attr('transform', 'translate(' + (0) + ')');

        errorBars
          .on('mouseover', function() { self._captureMouseHover(); })
          .on('mousemove', function() { self._captureMouseHover(); })
          .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });

        errorBars.exit()
          .transition()
          .duration(500)
          .style('opacity', 0)
          .remove();
      }
    }
  });

  // show baseline
  if(absLine != epiviz.ui.charts.CustomSetting.DEFAULT) {

    graph.selectAll('.abLine').remove();

    graph.append("svg:line")
          .attr("class", "abLine")
          .attr("x1", 0)
          .attr("x2", self.width() - self.margins().sumAxis(epiviz.ui.charts.Axis.X))
          .attr("y1", yScale(absLine))
          .attr("y2", yScale(absLine))
          .style("stroke", "black")
          .style("stroke-dasharray", ("5, 5")) ;
  }

  return items;
};

// goog.inherits(epiviz.plugins.charts.LineTrack, epiviz.plugins.charts.Track);
// Input 52
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 9:30 AM
 */

goog.provide('epiviz.plugins.charts.LineTrackType');

goog.require('epiviz.plugins.charts.LineTrack');
goog.require('epiviz.ui.charts.TrackType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.TrackType}
 * @constructor
 */
epiviz.plugins.charts.LineTrackType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.TrackType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.LineTrackType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.TrackType.prototype);
epiviz.plugins.charts.LineTrackType.constructor = epiviz.plugins.charts.LineTrackType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.LineTrack}
 */
epiviz.plugins.charts.LineTrackType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.LineTrack(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LineTrackType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.LineTrack';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LineTrackType.prototype.chartName = function() {
  return 'Line Track';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LineTrackType.prototype.chartHtmlAttributeName = function() {
  return 'lines';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.LineTrackType.prototype.measurementsFilter = function() { return function(m) { return m.type() == epiviz.measurements.Measurement.Type.FEATURE; }; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.LineTrackType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.TrackType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.STEP,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      50,
      'Step'),
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.SHOW_POINTS,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      false,
      'Show points'),
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.SHOW_LINES,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      true,
      'Show lines'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.SHOW_ERROR_BARS,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      true,
      'Show error bars'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.POINT_RADIUS,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      1,
      'Point radius'),
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.LINE_THICKNESS,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      1,
      'Line thickness'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.INTERPOLATION,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'linear',
      'Interpolation',
      ['linear', 'step-before', 'step-after', 'basis', 'basis-open', 'basis-closed', 'bundle', 'cardinal', 'cardinal-open', 'monotone']),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.ABS_LINE_VAL,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Draw abline')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.LineTrackType.CustomSettings = {
  STEP: 'step',
  SHOW_POINTS: 'showPoints',
  SHOW_ERROR_BARS: 'showErrorBars',
  SHOW_LINES: 'showLines',
  POINT_RADIUS: 'pointRadius',
  LINE_THICKNESS: 'lineThickness',
  INTERPOLATION: 'interpolation',
  ABS_LINE_VAL: 'abLine'
};

// goog.inherits(epiviz.plugins.charts.LineTrackType, epiviz.ui.charts.TrackType);

// Input 53
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/8/2014
 * Time: 1:32 PM
 */


goog.provide('epiviz.plugins.charts.StackedLineTrack');

goog.require('epiviz.ui.charts.Track');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.datatypes.GenomicRange');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Track}
 * @constructor
 */
epiviz.plugins.charts.StackedLineTrack = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Track.call(this, id, container, properties);

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.StackedLineTrack.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Track.prototype);
epiviz.plugins.charts.StackedLineTrack.constructor = epiviz.plugins.charts.StackedLineTrack;

/**
 * @protected
 */
epiviz.plugins.charts.StackedLineTrack.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Track.prototype._initialize.call(this);
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.StackedLineTrack.prototype.draw = function(range, data, slide, zoom) {
  epiviz.ui.charts.Track.prototype.draw.call(this, range, data, slide, zoom);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;
  slide = slide || this._slide;
  zoom = zoom || this._zoom;
  this._slide = 0;
  this._zoom = 1;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  var Axis = epiviz.ui.charts.Axis;
  slide = slide || 0;
  var delta = slide * (this.width() - this.margins().sumAxis(Axis.X)) / range.width();
  return this._drawLines(range, data, delta, zoom || 1);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {number} delta
 * @param {number} zoom
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.StackedLineTrack.prototype._drawLines = function(range, data, delta, zoom) {
  var Axis = epiviz.ui.charts.Axis;

  /** @type {epiviz.ui.charts.ColorPalette} */
  var colors = this.colors();

  /** @type {number} */
  var step = this.customSettingsValues()[epiviz.plugins.charts.StackedLineTrackType.CustomSettings.STEP];

  /** @type {string} */
  var interpolation = this.customSettingsValues()[epiviz.plugins.charts.StackedLineTrackType.CustomSettings.INTERPOLATION];

  /** @type {string} */
  var offset = this.customSettingsValues()[epiviz.plugins.charts.StackedLineTrackType.CustomSettings.OFFSET];

  var self = this;

  var invXScale = d3.scale.linear()
    .domain([0, this.width() - this.margins().sumAxis(Axis.X)])
    .range([range.start(), range.end()]);
  var deltaInBp = invXScale(delta) - range.start();

  // TODO: Re-introduce extendedRange (this is what we need to draw to make the track look continuous on navigation transition)
  var extendedRange = epiviz.datatypes.GenomicRange.fromStartEnd(
    range.seqName(),
    Math.min(range.start(), range.start() + deltaInBp),
    Math.max(range.end(), range.end() + deltaInBp));

  /** @type {Array.<epiviz.ui.charts.ChartObject>} */
  var items = [];

  var seriesAreas = [];

  var firstGlobalIndex = data.firstSeries().globalStartIndex();
  var lastGlobalIndex = data.firstSeries().globalEndIndex();

  data.foreach(function(measurement, series) {
    var firstIndex = series.globalStartIndex();
    var lastIndex = series.globalEndIndex();

    if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
  });

  firstGlobalIndex = Math.ceil(firstGlobalIndex / step) * step;
  lastGlobalIndex = Math.floor(lastGlobalIndex / step) * step;

  // TODO: Continue getting the labels on the x axis
  /** @type {Array.<string>} */
  var labels;

  data.foreach(function(m, series, i) {
    var indices = epiviz.utils.range((lastGlobalIndex - firstGlobalIndex) / step)
      .map(function(i) { return i * step + firstGlobalIndex; })
      .filter(function(globalIndex) {
        return series.getByGlobalIndex(globalIndex);
      });

    for (var k = 0; k < indices.length; ++k) {
      var cell = series.getByGlobalIndex(indices[k]);
      items.push(new epiviz.ui.charts.ChartObject(sprintf('line_%s_%s', i, cell.globalIndex), cell.rowItem.start(), cell.rowItem.end(), [cell.value], i, [[cell]], [m], sprintf('item data-series-%s', i)));
    }

    var x = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.getByGlobalIndex(j);
      return cell.rowItem.start();
    };

    var y = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.getByGlobalIndex(j);
      return cell.value;
    };

    var areas = [];
    indices.forEach(function(j) { areas.push({x: x(j), y: y(j)}); });
    seriesAreas.push(areas);
    if (!labels) {
      labels = [];
      indices.forEach(function(j) {
        /** @type {epiviz.datatypes.GenomicData.ValueItem} */
        var cell = series.getByGlobalIndex(j);
        labels.push(cell.rowItem.metadata('bacteria')); // TODO: Change to something more generic
      });
    }
  });

  var xScale = d3.scale.linear()
    .domain([range.start(), range.end()])
    .range([0, this.width() - this.margins().sumAxis(Axis.X)]);

  this._clearAxes();

  this._drawAxes(xScale, undefined, 10);
  // TODO: Add option for labels on tracks
  /* this._drawAxes(
    xScale, undefined, // scales
    labels.length, undefined, // ticks
    undefined, undefined, undefined, undefined, undefined, undefined, labels, undefined);*/

  var graph = this._svg.select('.lines');
  if (graph.empty()) {
    graph = this._svg.append('g')
      .attr('class', 'lines')
      .attr('transform', 'translate(' + this.margins().left() + ', ' + this.margins().top() + ')');
  }

  var stack = d3.layout.stack().offset(offset);
  var layers = stack(seriesAreas);

  var yScale = d3.scale.linear()
    .domain([
      Math.min(0, d3.min(layers, function(layer) { return d3.min(layer, function(d) { return d.y0 + d.y; }); })),
      d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y0 + d.y; }); })])
    .range([this.height() - this.margins().sumAxis(Axis.Y), 0]);

  var area = d3.svg.area()
    .x(function(d) { return xScale(d.x); })
    .y0(function(d) { return yScale(d.y0); })
    .y1(function(d) { return yScale(d.y0 + d.y); })
    .interpolate(interpolation);

  var lines = graph
    .selectAll('path')
    .data(layers);

  lines.enter()
    .append('path')
    .attr('d', area)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .style('fill', function(d, i) { return colors.get(i); })
    .on('mouseover', function() { self._captureMouseHover(); })
    .on('mousemove', function() { self._captureMouseHover(); })
    .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });

  lines
    .attr('d', area)
    .style('fill', function(d, i) { return colors.get(i); })
    .attr('transform', 'translate(' + (+delta) + ')')
    .transition()
    .duration(500)
    .attr('transform', 'translate(' + (0) + ')');

  // show baseline
  if(absLine != epiviz.ui.charts.CustomSetting.DEFAULT) {

    graph.selectAll('.abLine').remove();

    graph.append("svg:line")
          .attr("class", "abLine")
          .attr("x1", 0)
          .attr("x2", self.width() - self.margins().sumAxis(epiviz.ui.charts.Axis.X))
          .attr("y1", yScale(absLine))
          .attr("y2", yScale(absLine))
          .style("stroke", "black")
          .style("stroke-dasharray", ("5, 5")) ;
  }



  return items;
};

// goog.inherits(epiviz.plugins.charts.StackedLineTrack, epiviz.plugins.charts.Track);
// Input 54
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/8/2014
 * Time: 1:32 PM
 */


goog.provide('epiviz.plugins.charts.StackedLineTrackType');

goog.require('epiviz.plugins.charts.StackedLineTrack');
goog.require('epiviz.ui.charts.TrackType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.TrackType}
 * @constructor
 */
epiviz.plugins.charts.StackedLineTrackType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.TrackType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.StackedLineTrackType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.TrackType.prototype);
epiviz.plugins.charts.StackedLineTrackType.constructor = epiviz.plugins.charts.StackedLineTrackType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.StackedLineTrack}
 */
epiviz.plugins.charts.StackedLineTrackType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.StackedLineTrack(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.StackedLineTrackType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.StackedLineTrack';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.StackedLineTrackType.prototype.chartName = function() {
  return 'Stacked Track';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.StackedLineTrackType.prototype.chartHtmlAttributeName = function() {
  return 'stacked-lines';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.StackedLineTrackType.prototype.measurementsFilter = function() { return function(m) { return m.type() == epiviz.measurements.Measurement.Type.FEATURE; }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.plugins.charts.StackedLineTrackType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.StackedLineTrackType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.TrackType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLineTrackType.CustomSettings.STEP,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      1,
      'Step'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLineTrackType.CustomSettings.OFFSET,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'zero',
      'Offset',
      ['zero', 'wiggle']),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLineTrackType.CustomSettings.INTERPOLATION,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'basis',
      'Interpolation',
      ['linear', 'step-before', 'step-after', 'basis', 'basis-open', 'basis-closed', 'bundle', 'cardinal', 'cardinal-open', 'monotone']),
    
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLineTrackType.CustomSettings.ABS_LINE_VAL,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Draw abline')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.StackedLineTrackType.CustomSettings = {
  STEP: 'step',
  OFFSET: 'offset',
  INTERPOLATION: 'interpolation',
  ABS_LINE_VAL: 'abLine'
};

// goog.inherits(epiviz.plugins.charts.StackedLineTrackType, epiviz.ui.charts.TrackType);

// Input 55
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/28/13
 * Time: 10:25 AM
 */

goog.provide('epiviz.ui.charts.Plot');

goog.require('epiviz.ui.charts.Chart');
goog.require('epiviz.ui.charts.VisualizationType');

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Chart}
 * @constructor
 */
epiviz.ui.charts.Plot = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Chart.call(this, id, container, properties);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.Plot.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Chart.prototype);
epiviz.ui.charts.Plot.constructor = epiviz.ui.charts.Plot;

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.Plot.prototype.displayType = function() { return epiviz.ui.charts.VisualizationType.DisplayType.PLOT; };

// Input 56
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 11:55 PM
 */

goog.provide('epiviz.plugins.charts.ScatterPlot');

goog.require('epiviz.ui.charts.Plot');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.measurements.Measurement');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Plot}
 * @constructor
 */
epiviz.plugins.charts.ScatterPlot = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Plot.call(this, id, container, properties);

  /**
   * D3 chart container
   * @type {*}
   * @private
   */
  this._chartContent = null;

  /**
   * D3 legend container
   * @type {*}
   * @private
   */
  this._legend = null;

  /**
   * @type {Array.<epiviz.measurements.Measurement>}
   * @private
   */
  this._measurementsX = [];

  /**
   * @type {Array.<epiviz.measurements.Measurement>}
   * @private
   */
  this._measurementsY = [];

  var self = this;
  this.measurements().foreach(function(m, i) {
    if (i % 2 == 0) { self._measurementsX.push(m); }
    else { self._measurementsY.push(m); }
  });

  /**
   * @type {string}
   * @private
   */
  this._xLabel = '';

  /**
   * @type {string}
   * @private
   */
  this._yLabel = '';

  for (var i = 0; i < Math.min(this._measurementsX.length, this._measurementsY.length); ++i) {
    if (i > 0) {
      this._xLabel += ', ';
      this._yLabel += ', ';
    }
    this._xLabel += this._measurementsX[i].name();
    this._yLabel += this._measurementsY[i].name();
  }

  /**
   * @type {Array.<string>}
   * @private
   */
  this._colorLabels = [];

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.ScatterPlot.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Plot.prototype);
epiviz.plugins.charts.ScatterPlot.constructor = epiviz.plugins.charts.ScatterPlot;

/**
 * @protected
 */
epiviz.plugins.charts.ScatterPlot.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Plot.prototype._initialize.call(this);

  this._svg.classed('scatter-plot', true);

  this._chartContent = this._svg.append('g').attr('class', 'chart-content');
  this._legend = this._svg.append('g').attr('class', 'chart-legend');
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.ScatterPlot.prototype.draw = function(range, data) {

  epiviz.ui.charts.Plot.prototype.draw.call(this, range, data);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  return this._drawCircles(range, data);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.ScatterPlot.prototype._drawCircles = function(range, data) {
  var self = this;
  var Axis = epiviz.ui.charts.Axis;
  var circleRadius = Math.max(1,this.customSettingsValues()[epiviz.plugins.charts.ScatterPlotType.CustomSettings.CIRCLE_RADIUS_RATIO] * Math.min(this.width(), this.height()));
  var gridSquareSize = Math.max(Math.floor(circleRadius), 1);
  var nSeries = Math.min(this._measurementsX.length, this._measurementsY.length);

  var absLine = this.customSettingsValues()[epiviz.plugins.charts.ScatterPlotType.CustomSettings.ABS_LINE_VAL];

  var firstGlobalIndex = data.firstSeries().globalStartIndex();
  var lastGlobalIndex = data.firstSeries().globalEndIndex();
  data.foreach(function(measurement, series) {

    var firstIndex = series.globalStartIndex();
    var lastIndex = series.globalEndIndex();

    if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
  });

  var nItems = lastGlobalIndex - firstGlobalIndex;

  var margins = this.margins();
  var width = this.width();
  var height = this.height();

  var CustomSetting = epiviz.ui.charts.CustomSetting;
  var minY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MIN];
  var maxY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MAX];
  var minX = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.X_MIN];
  var maxX = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.X_MAX];

  if (minX == CustomSetting.DEFAULT) { minX = this._measurementsX[0].minValue(); }
  if (minY == CustomSetting.DEFAULT) { minY = this._measurementsY[0].minValue(); }
  if (maxX == CustomSetting.DEFAULT) { maxX = this._measurementsX[0].maxValue(); }
  if (maxY == CustomSetting.DEFAULT) { maxY = this._measurementsY[0].maxValue(); }

  var dataHasGenomicLocation = epiviz.measurements.Measurement.Type.isOrdered(this._measurementsX[0].type());

  var xScale = d3.scale.linear()
    .domain([minX, maxX])
    .range([0, width - margins.sumAxis(Axis.X)]);
  var yScale = d3.scale.linear()
    .domain([minY, maxY])
    .range([height - margins.sumAxis(Axis.Y), 0]);

  this._clearAxes(this._chartContent);
  this._drawAxes(xScale, yScale, 15, 15, this._chartContent);

  var i, index;
  var indices = []; //epiviz.utils.range(nSeries * nItems);
  for (i = 0; i < nItems; ++i) {
    index = i + firstGlobalIndex;
    var item = data.getSeries(this._measurementsX[0]).getRowByGlobalIndex(index);
    if (!item) { continue; }
    if (!dataHasGenomicLocation ||
      (range.start() == undefined || range.end() == undefined) ||
      (item.start() < range.end() && item.end() > range.start())) {

      for (var j = 0; j < nSeries; ++j) {
        indices.push(j * nItems + i);
      }
    }
  }

  var grid = {};
  var items = [];
  var maxGroupItems = 1;
  for (i = 0; i < indices.length; ++i) {
    index = indices[i] % nItems;
    var globalIndex = index + firstGlobalIndex;
    var seriesIndex = Math.floor(indices[i] / nItems);
    var mX = self._measurementsX[seriesIndex];
    var mY = self._measurementsY[seriesIndex];
    var cellX = data.getSeries(mX).getByGlobalIndex(globalIndex);
    var cellY = data.getSeries(mY).getByGlobalIndex(globalIndex);

    if (!cellX || !cellY) { continue; }

    var classes = sprintf('item data-series-%s', seriesIndex);

    var x = xScale(cellX.value);
    var y = yScale(cellY.value);
    var gridX = Math.floor(x / gridSquareSize) * gridSquareSize;
    var gridY = Math.floor(y / gridSquareSize) * gridSquareSize;

    var uiObj = null;
    if (grid[gridY] && grid[gridY][gridX]) {
      uiObj = grid[gridY][gridX];
      uiObj.id += '_' + cellX.globalIndex;
      uiObj.start = Math.min(uiObj.start, cellX.rowItem.start());
      uiObj.end = Math.max(uiObj.end, cellX.rowItem.end());
      uiObj.values[0] = (uiObj.values[0] * uiObj.valueItems[0].length + cellX.value) / (uiObj.valueItems[0].length + 1);
      uiObj.values[1] = (uiObj.values[1] * uiObj.valueItems[1].length + cellY.value) / (uiObj.valueItems[1].length + 1);
      uiObj.valueItems[0].push(cellX);
      uiObj.valueItems[1].push(cellY);

      if (uiObj.valueItems[0].length > maxGroupItems) {
        maxGroupItems = uiObj.valueItems[0].length;
      }

      continue;
    }

    uiObj = new epiviz.ui.charts.ChartObject(
      sprintf('scatter_%s_%s', seriesIndex, cellX.globalIndex),
      cellX.rowItem.start(),
      cellX.rowItem.end(),
      [cellX.value, cellY.value],
      seriesIndex,
      [[cellX], [cellY]], // valueItems one for each measurement
      [mX, mY], // measurements
      classes);

    if (!grid[gridY]) { grid[gridY] = {}; }
    grid[gridY][gridX] = uiObj;

    items.push(uiObj);
  }

  var itemsGroup = this._chartContent.select('.items');

  if (itemsGroup.empty()) {
    itemsGroup = this._chartContent.append('g').attr('class', 'items');
    var selectedGroup = itemsGroup.append('g').attr('class', 'selected');
    itemsGroup.append('g').attr('class', 'hovered');
    selectedGroup.append('g').attr('class', 'hovered');
  }

  var selection = itemsGroup.selectAll('circle').data(items, function(d) { return d.id; });

  selection
    .enter()
    .insert('circle', ':first-child')
    .attr('id', function (d) {
      return sprintf('%s-item-%s-%s', self.id(), d.seriesIndex, d.valueItems[0][0].globalIndex);
    })
    .style('opacity', 0)
    .style('fill-opacity', 0)
    .attr('r', 0);
  selection
    .each(
      /**
       * @param {epiviz.ui.charts.ChartObject} d
       */
      function(d) {
        var circle = d3.select(this);

        var fill;
        if (!self._globalIndexColorLabels) { fill = self.colors().get(d.seriesIndex); }
        else {
          fill = self.colors().getByKey(self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]);
        }
        circle
          .attr('cx', margins.left() + (d.values[0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
          .attr('cy', height - margins.bottom() - ((d.values[1] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
          .attr('class', d.cssClasses)
          .style('fill', fill);
      });

  selection
    .transition()
    .duration(1000)
    .style('fill-opacity', function(d) {
      //return Math.max(0.3, d.valueItems[0].length / maxGroupItems);
      return Math.max(0.6, d.valueItems[0].length / maxGroupItems);
    })
    .style('opacity', null)
    .attr('r', circleRadius);

  selection
    .exit()
    .transition()
    .duration(1000)
    .style('opacity', 0)
    .attr('r', 0)
    .remove();

  selection
    .on('mouseover', function (d) {
      self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
    })
    .on('mouseout', function () {
      self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
    })
    .on('click', function (d) {
      self._deselect.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
      self._select.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));

      d3.event.stopPropagation();
    });

  // Draw legend if necessary
  if (this._globalIndexColorLabels) {
    var colorLabelsMap = {};
    for (j = firstGlobalIndex; j < lastGlobalIndex; ++j) {
      colorLabelsMap[this._globalIndexColorLabels[j]] = this._globalIndexColorLabels[j];
    }
    this._colorLabels = Object.keys(colorLabelsMap);

    this._svg.selectAll('.chart-title').remove();
    this._svg.selectAll('.chart-title-color ').remove();
    var titleEntries = this._svg
      .selectAll('.chart-title')
      .data(this._colorLabels);
    titleEntries
      .enter()
      .append('text')
      .attr('class', 'chart-title')
      .attr('font-weight', 'bold')
      .attr('y', self.margins().top() - 5);
    titleEntries
      .attr('fill', function(label, i) {
        return self.colors().getByKey(label);
      })
      .text(function(label) { return label; });
    var textLength = 0;
    var titleEntriesStartPosition = [];

    $('#' + this.id() + ' .chart-title')
      .each(function(i) {
        titleEntriesStartPosition.push(textLength);
        textLength += this.getBBox().width + 15;
      });

    titleEntries.attr('x', function(column, i) {
      return self.margins().left() + 10 + titleEntriesStartPosition[i];
    });

    var colorEntries = this._svg
      .selectAll('.chart-title-color')
      .data(this._colorLabels)
      .enter()
      .append('circle')
      .attr('class', 'chart-title-color')
      .attr('cx', function(column, i) { return self.margins().left() + 4 + titleEntriesStartPosition[i]; })
      .attr('cy', self.margins().top() - 9)
      .attr('r', 4)
      .style('shape-rendering', 'auto')
      .style('stroke-width', '0')
      .attr('fill', function(label, i) {
        return self.colors().getByKey(label);
      })
      .style('stroke-width', 0)
  } else {
    var n = Math.min(this._measurementsX.length, this._measurementsY.length);
    var colors = new Array(n);

    for (j = 0; j < n; ++j) {
      colors[j] = sprintf('%s vs %s', this._measurementsX[j].name(), this._measurementsY[j].name());
    }

    this._colorLabels = colors;
  }

  // Draw abline
  if(absLine != epiviz.ui.charts.CustomSetting.DEFAULT) {

    itemsGroup.selectAll(".abLine").remove();

    itemsGroup.append("svg:line")
          .attr("class", "abLine")
          .attr("x1", margins.left() + (minX - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
          .attr("x2", margins.left() + (maxX - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
          .attr("y1", height - margins.bottom() - ((absLine - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
          .attr("y2", height - margins.bottom() - ((absLine - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
          .style("stroke", "black")
          .style("stroke-dasharray", ("5, 5")) ;
  }

  return items;
};

/**
 * @returns {Array.<{name: string, color: string}>}
 */
epiviz.plugins.charts.ScatterPlot.prototype.colorLabels = function() {
  return this._colorLabels;
};

/**
 * @param xScale D3 linear scale for the x axis
 * @param yScale D3 linear scale for the y axis
 * @param {number} [xTicks]
 * @param {number} [yTicks]
 * @param [svg] D3 svg container for the axes
 * @param {number} [width]
 * @param {number} [height]
 * @param {epiviz.ui.charts.Margins} [margins]
 * @protected
 */
epiviz.plugins.charts.ScatterPlot.prototype._drawAxes = function(xScale, yScale, xTicks, yTicks, svg, width, height, margins) {
  epiviz.ui.charts.Plot.prototype._drawAxes.call(this, xScale, yScale, xTicks, yTicks, svg, width, height, margins);

  this._legend.selectAll('text').remove();

  var xMeasurements = this._measurementsX;
  var self = this;
  this._legend.selectAll('.x-measurement').remove();
  this._legend.selectAll('.x-measurement-color').remove();

  var xEntries = this._legend
    .selectAll('.x-measurement')
    .data(xMeasurements)
    .enter()
    .append('text')
    .attr('class', 'x-measurement')
    .attr('font-weight', 'bold')
    .attr('fill', function(m, i) {
      return self._globalIndexColorLabels ?
        "#000000" : self.colors().get(i);
    })
    .attr('y', (this.height() - this.margins().bottom() + 35))
    .text(function(m, i) { return m.name(); });

  var xTextLength = 0;
  var xTitleEntriesStartPosition = [];

  $('#' + this.id() + ' .x-measurement')
    .each(function(i) {
      xTitleEntriesStartPosition.push(xTextLength);
      xTextLength += this.getBBox().width + 15;
    });

  xEntries.attr('x', function(column, i) {
    return (self.width() - xTextLength) * 0.5 + 7 + xTitleEntriesStartPosition[i];
  });

  var xColorEntries = this._legend
    .selectAll('.x-measurement-color')
    .data(xMeasurements)
    .enter()
    .append('circle')
    .attr('class', 'x-measurement-color')
    .attr('cx', function(column, i) { return (self.width() - xTextLength) * 0.5 + 1 + xTitleEntriesStartPosition[i]; })
    .attr('cy', (this.height() - this.margins().bottom() + 31))
    .attr('r', 4)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .style('fill', function(m, i) {
      return self._globalIndexColorLabels ?
        "#ffffff" : self.colors().get(i);
    });


  var yMeasurements = this._measurementsY;
  this._legend.selectAll('.y-measurement').remove();
  this._legend.selectAll('.y-measurement-color').remove();

  var yEntries = this._legend
    .selectAll('.y-measurement')
    .data(yMeasurements)
    .enter()
    .append('text')
    .attr('class', 'y-measurement')
    .attr('font-weight', 'bold')
    .attr('fill', function(m, i) {
      return self._globalIndexColorLabels ?
        "#000000" : self.colors().get(i);
    })
    .attr('y', (this.margins().left() - 35))
    .attr('transform', 'rotate(-90)')
    .text(function(m, i) { return m.name(); });

  var yTextLength = 0;
  var yTitleEntriesStartPosition = [];

  $('#' + this.id() + ' .y-measurement')
    .each(function(i) {
      yTitleEntriesStartPosition.push(yTextLength);
      yTextLength += this.getBBox().width + 15;
    });

  yEntries.attr('x', function(column, i) {
    return - self.height() + (self.height() - yTextLength) * 0.5 + 12 + self.margins().top() + yTitleEntriesStartPosition[i];
  });

  var yColorEntries = this._legend
    .selectAll('.y-measurement-color')
    .data(yMeasurements)
    .enter()
    .append('circle')
    .attr('class', 'y-measurement-color')
    .attr('cx', function(column, i) { return - self.height() + (self.height() - yTextLength) * 0.5 + 6 + self.margins().top() + yTitleEntriesStartPosition[i]; })
    .attr('cy', (this.margins().left() - 39))
    .attr('transform', 'rotate(-90)')
    .attr('r', 4)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .style('fill', function(m, i) {
      return self._globalIndexColorLabels ?
        "#ffffff" : self.colors().get(i);
    });
};

// goog.inherits(epiviz.plugins.charts.ScatterPlot, epiviz.ui.charts.Plot);

// Input 57
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/28/13
 * Time: 10:26 AM
 */

goog.provide('epiviz.ui.charts.PlotType');

goog.require('epiviz.ui.charts.ChartType');
goog.require('epiviz.ui.charts.VisualizationType');
/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.ChartType}
 * @constructor
 */
epiviz.ui.charts.PlotType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.ChartType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.PlotType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.ChartType.prototype);
epiviz.ui.charts.PlotType.constructor = epiviz.ui.charts.PlotType;

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.PlotType.prototype.chartDisplayType = function() { return epiviz.ui.charts.VisualizationType.DisplayType.PLOT; };

/**
 * @returns {string}
 */
epiviz.ui.charts.PlotType.prototype.cssClass = function() {
  return 'plot-container ui-widget-content';
};

// Input 58
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 11:55 PM
 */

goog.provide('epiviz.plugins.charts.ScatterPlotType');

goog.require('epiviz.plugins.charts.ScatterPlot');
goog.require('epiviz.ui.charts.PlotType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.PlotType}
 * @constructor
 */
epiviz.plugins.charts.ScatterPlotType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.PlotType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.ScatterPlotType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.PlotType.prototype);
epiviz.plugins.charts.ScatterPlotType.constructor = epiviz.plugins.charts.ScatterPlotType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.ScatterPlot}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.ScatterPlot(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.ScatterPlot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.chartName = function() {
  return 'Scatter Plot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.chartHtmlAttributeName = function() {
  return 'scatter';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.measurementsFilter = function() { return function(m) { return epiviz.measurements.Measurement.Type.hasValues(m.type()); }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * Gets the minimum number of measurements that must be selected for the chart to be displayed
 * @returns {number}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.minSelectedMeasurements = function() { return 2; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.PlotType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.ScatterPlotType.CustomSettings.CIRCLE_RADIUS_RATIO,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      0.015,
      'Circle radius ratio'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.X_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min X'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.X_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max X'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.ScatterPlotType.CustomSettings.ABS_LINE_VAL,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Draw abline')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.ScatterPlotType.CustomSettings = {
  CIRCLE_RADIUS_RATIO: 'circleRadiusRatio',
  ABS_LINE_VAL: 'abLine'
};

// goog.inherits(epiviz.plugins.charts.ScatterPlotType, epiviz.ui.charts.PlotType);

// Input 59
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/18/13
 * Time: 7:33 PM
 */

goog.provide('epiviz.plugins.charts.GenesTrack');

goog.require('epiviz.ui.charts.Track');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Track}
 * @constructor
 */
epiviz.plugins.charts.GenesTrack = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Track.call(this, id, container, properties);

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.GenesTrack.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Track.prototype);
epiviz.plugins.charts.GenesTrack.constructor = epiviz.plugins.charts.GenesTrack;

/**
 * @protected
 */
epiviz.plugins.charts.GenesTrack.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Track.prototype._initialize.call(this);

  this._svg.classed('genes-track', true);
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.GenesTrack.prototype.draw = function(range, data, slide, zoom) {
  epiviz.ui.charts.Track.prototype.draw.call(this, range, data, slide, zoom);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  slide = slide || this._slide;
  zoom = zoom || this._zoom;
  this._slide = 0;
  this._zoom = 1;

  return this._drawGenes(range, data, slide || 0, zoom || 1);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {number} slide
 * @param {number} zoom
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.GenesTrack.prototype._drawGenes = function(range, data, slide, zoom) {
  var Axis = epiviz.ui.charts.Axis;

  /** @type {number} */
  var start = range.start();

  /** @type {number} */
  var end = range.end();

  /** @type {number} */
  var width = this.width();

  /** @type {number} */
  var height = this.height();

  /** @type {epiviz.ui.charts.Margins} */
  var margins = this.margins();

  var xScale = d3.scale.linear()
    .domain([start, end])
    .range([0, width - margins.sumAxis(Axis.X)]);
  var delta = slide * (width - margins.sumAxis(Axis.X)) / (end - start);

  this._clearAxes();
  this._drawAxes(xScale, null, 10, 5);

  var self = this;
  /** @type {epiviz.datatypes.MeasurementGenomicData} */
  var series = data.firstSeries();

  var indices = epiviz.utils.range(series.size());

  /** @type {Array.<epiviz.ui.charts.ChartObject>} */
  var dataItems = indices
    .map(function(i) {
    var cell = series.get(i);
    var item = cell.rowItem;
    var classes = sprintf('item gene-%s', item.metadata('gene'));

    return new epiviz.ui.charts.ChartObject(
      item.metadata('gene'),
      item.start(),
      item.end(),
      null,
      0,
      [[cell]],
      [series.measurement()],
      classes);
  });

  if (zoom) {
    this._svg.select('.items').remove();
    this._svg.select('defs').select('#clip-' + this.id()).remove();
  }

  var items = this._svg.select('.items');
  var selected = items.select('.selected');

  if (items.empty()) {
    var defs = this._svg.select('defs');
    defs.append('clipPath')
      .attr('id', 'clip-' + this.id())
      .append('rect')
      .attr('x', 0)
      .attr('y', 0)
      .attr('width', width - margins.sumAxis(Axis.X))
      .attr('height', height - margins.sumAxis(Axis.Y));

    items = this._svg.append('g')
      .attr('class', 'items')
      .attr('transform', 'translate(' + margins.left() + ', ' + margins.top() + ')')
      .attr('id', this.id() + '-gene-content')
      .attr('clip-path', 'url(#clip-' + this.id() + ')');

    selected = items.append('g').attr('class', 'selected');
    items.append('g').attr('class', 'hovered');
    selected.append('g').attr('class', 'hovered');
  }

  var selection = items.selectAll('.item')
    .data(dataItems, function(d) { return d.id; });

  selection
    .enter()
    .insert('g', ':first-child')
    .on('mouseout', function () {
      self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
    })
    .on('mouseover', function (d) {
      self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
    })
    .on('click', function(d) {
      self._deselect.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
      self._select.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
      d3.event.stopPropagation();
    })
    .attr('transform', 'translate(' + (delta) + ', 0) scale(1, 1)')
    .each(function(d) {
      self._drawGene(this, d, xScale);
    });

  if (delta) {
    selection.each(function(d) {
      self._translateGene(this, d, delta);
    });
  }

  selection
    .exit()
    .transition()
    .duration(500)
    .style('opacity', 0)
    .remove();

  return dataItems;
};

/**
 * @param elem
 * @param {epiviz.ui.charts.ChartObject} d
 * @param delta
 * @private
 */
epiviz.plugins.charts.GenesTrack.prototype._translateGene = function(elem, d, delta) {
  var gene = d3.select(elem);
  var transform = gene.attr('transform');
  var translateRx = new RegExp('translate\\\([\\\d\\\.\\\-]+[\\\,\\\s]+[\\\d\\\.\\\-]+\\\)', 'g');
  var numberRx = new RegExp('[\\\d\\\.\\\-]+', 'g');
  var translate = transform.match(translateRx)[0];
  var x = parseFloat(translate.match(numberRx)[0]);

  transform = transform.replace(translateRx, 'translate(' + (x-delta) + ', 0)');
  gene
    .transition()
    .duration(500)
    .attr('transform', transform);
};

/**
 * @param elem
 * @param {epiviz.ui.charts.ChartObject} d
 * @param {function(number): number} xScale
 * @private
 */
epiviz.plugins.charts.GenesTrack.prototype._drawGene = function(elem, d, xScale) {
  var Axis = epiviz.ui.charts.Axis;
  var self = this;
  var rowItem = d.valueItems[0][0].rowItem;
  var geneStart = xScale(d.start);
  var geneEnd = xScale(d.end);
  var or = (rowItem.strand() == '+') ? 1 : -1;
  var offset = - or * (this.height() - this.margins().sumAxis(Axis.Y)) * 0.25;

  var exonStarts = rowItem.metadata('exon_starts').split(',').map(function(s) { return parseInt(s); });
  var exonEnds = rowItem.metadata('exon_ends').split(',').map(function(s) { return parseInt(s); });
  var exonCount = exonStarts.length;
  var exonIndices = d3.range(0, exonCount);

  var geneHeight = this.height() * 0.08;
  var exonHeight = this.height() * 0.16;
  var h = geneHeight * Math.sqrt(3) * 0.5;

  var gene = d3.select(elem);
  gene.attr('class', d.cssClasses);

  gene.append('polygon')
    .attr('class', 'gene-body')
    .style('fill', this.colors().get(0))
    .attr('points', function() {
      var xs = null, ys;
      var y0 = (self.height() - self.margins().sumAxis(Axis.Y) - geneHeight) * 0.5 + offset;
      ys = [y0, y0, y0 + geneHeight * 0.5, y0 + geneHeight, y0 + geneHeight];
      if (rowItem.strand() == '+') {
        xs = [geneStart, geneEnd, geneEnd + h, geneEnd, geneStart];
      } else {
        xs = [geneEnd, geneStart, geneStart - h, geneStart, geneEnd];
      }

      return sprintf('%s,%s %s,%s %s,%s %s,%s %s,%s', xs[0], ys[0], xs[1], ys[1], xs[2], ys[2], xs[3], ys[3], xs[4], ys[4]);
    });

  var exons = gene.append('g')
    .attr('class', 'exons')
    .style('fill', this.colors().get(1));

  exons.selectAll('rect')
    .data(exonIndices)
    .enter()
    .append('rect')
    .attr('x', function(j) {
      return xScale(exonStarts[j]);
    })
    .attr('y', (self.height() - exonHeight - self.margins().sumAxis(Axis.Y)) * 0.5 + offset)
    .attr('width', function(j) {
      return xScale(exonEnds[j]) - xScale(exonStarts[j]);
    })
    .attr('height', exonHeight);

  gene
    .append('text')
    .attr('class', 'gene-name')
    .attr('x', geneStart + 2)
    .attr('y', (self.height() - self.margins().sumAxis(Axis.Y)) * 0.5 + offset - or * (geneHeight + 2))
    .style('dominant-baseline', 'central')
    .text(d.id); //Gene
};

/**
 * @returns {Array.<{name: string, color: string}>}
 */
epiviz.plugins.charts.GenesTrack.prototype.colorLabels = function() {
  return ['Genes', 'Exons'];
};

/**
 * @param xScale D3 linear scale for the x axis
 * @param yScale D3 linear scale for the y axis
 * @param {number} [xTicks]
 * @param {number} [yTicks]
 * @param [svg] D3 svg container for the axes
 * @param {number} [width]
 * @param {number} [height]
 * @param {epiviz.ui.charts.Margins} [margins]
 * @protected
 */
epiviz.plugins.charts.GenesTrack.prototype._drawAxes = function(xScale, yScale, xTicks, yTicks, svg, width, height, margins) {
  epiviz.ui.charts.Track.prototype._drawAxes.call(this, xScale, yScale, xTicks, yTicks, svg, width, height, margins);

  var Axis = epiviz.ui.charts.Axis;
  var axesGroup = this._svg.select('.axes');
  axesGroup
    .append('g')
    .attr('class', 'xAxis')
    .append('line')
    .attr('x1', this.margins().left())
    .attr('x2', this.width() - this.margins().left())
    .attr('y1', this.margins().top() + (this.height() - this.margins().sumAxis(Axis.Y)) * 0.5)
    .attr('y2', this.margins().top() + (this.height() - this.margins().sumAxis(Axis.Y)) * 0.5)
    .style('stroke', '#555555')
    .style('shape-rendering', 'crispEdges');
};

// goog.inherits(epiviz.plugins.charts.GenesTrack, epiviz.plugins.charts.Track);
// Input 60
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/18/13
 * Time: 7:34 PM
 */

goog.provide('epiviz.plugins.charts.GenesTrackType');

goog.require('epiviz.plugins.charts.GenesTrack');
goog.require('epiviz.ui.charts.TrackType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');


/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.TrackType}
 * @constructor
 */
epiviz.plugins.charts.GenesTrackType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.TrackType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.GenesTrackType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.TrackType.prototype);
epiviz.plugins.charts.GenesTrackType.constructor = epiviz.plugins.charts.GenesTrackType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.GenesTrack}
 */
epiviz.plugins.charts.GenesTrackType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.GenesTrack(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.GenesTrackType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.GenesTrack';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.GenesTrackType.prototype.chartName = function() {
  return 'Genes Track';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.GenesTrackType.prototype.chartHtmlAttributeName = function() {
  return 'genes';
};

/**
 * @returns {epiviz.measurements.Measurement.Type}
 */
/*epiviz.plugins.charts.GenesTrackType.prototype.chartContentType = function() {
  return epiviz.measurements.Measurement.Type.RANGE;
};*/

/**
 * @returns {boolean}
 */
epiviz.plugins.charts.GenesTrackType.prototype.isRestrictedToRangeMeasurements = function() { return true; };

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.GenesTrackType.prototype.measurementsFilter = function() { return function(m) { return m.type() == epiviz.measurements.Measurement.Type.RANGE; }; };

// goog.inherits(epiviz.plugins.charts.GenesTrackType, epiviz.ui.charts.TrackType);

// Input 61
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/14/14
 * Time: 10:17 AM
 */

goog.provide('epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory');

goog.require('epiviz.utils');

/**
 * @param {epiviz.Config} config
 * @constructor
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory = function(config) {
  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {Object.<string, epiviz.ui.charts.transform.clustering.HierarchicalClusteringAlgorithm>}
   * @private
   */
  this._algorithms = {};

  /**
   * @type {Object.<string, epiviz.ui.charts.transform.clustering.ClusteringMetric>}
   * @private
   */
  this._metrics = {};

  /**
   * @type {Object.<string, epiviz.ui.charts.transform.clustering.ClusteringLinkage>}
   * @private
   */
  this._linkages = {};

  var i;
  for (i = 0; i < config.clustering.algorithms.length; ++i) {
    /** @type {?function(new:epiviz.ui.charts.transform.clustering.HierarchicalClusteringAlgorithm)} */
    var algorithmConstructor = epiviz.utils.evaluateFullyQualifiedTypeName(config.clustering.algorithms[i]);

    /** @type {epiviz.ui.charts.transform.clustering.HierarchicalClusteringAlgorithm} */
    var algorithm = epiviz.utils.applyConstructor(algorithmConstructor);

    this._algorithms[algorithm.id()] = algorithm;
  }

  for (i = 0; i < config.clustering.metrics.length; ++i) {
    /** @type {?function(new:epiviz.ui.charts.transform.clustering.ClusteringMetric)} */
    var metricConstructor = epiviz.utils.evaluateFullyQualifiedTypeName(config.clustering.metrics[i]);

    /** @type {epiviz.ui.charts.transform.clustering.ClusteringMetric} */
    var metric = epiviz.utils.applyConstructor(metricConstructor);

    this._metrics[metric.id()] = metric;
  }

  for (i = 0; i < config.clustering.linkages.length; ++i) {
    /** @type {?function(new:epiviz.ui.charts.transform.clustering.ClusteringLinkage)} */
    var linkageConstructor = epiviz.utils.evaluateFullyQualifiedTypeName(config.clustering.linkages[i]);

    /** @type {epiviz.ui.charts.transform.clustering.ClusteringLinkage} */
    var linkage = epiviz.utils.applyConstructor(linkageConstructor);

    this._linkages[linkage.id()] = linkage;
  }
};

/**
 * @type {?epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory}
 * @private
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory._instance = null;

/**
 * @returns {?epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory}
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.instance = function() {
  return epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory._instance;
};

/**
 * @param {epiviz.Config} config
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.initialize = function(config) {
  epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory._instance =
    new epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory(config);
};

/**
 * @param {string} id
 * @returns {epiviz.ui.charts.transform.clustering.HierarchicalClusteringAlgorithm}
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.prototype.algorithm = function(id) { return this._algorithms[id]; };

/**
 * @param {string} id
 * @returns {epiviz.ui.charts.transform.clustering.ClusteringMetric}
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.prototype.metric = function(id) { return this._metrics[id]; };

/**
 * @param {string} id
 * @returns {epiviz.ui.charts.transform.clustering.ClusteringLinkage}
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.prototype.linkage = function(id) { return this._linkages[id]; };

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.prototype.algorithms = function() { return Object.keys(this._algorithms); };

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.prototype.metrics = function() { return Object.keys(this._metrics); };

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.prototype.linkages = function() { return Object.keys(this._linkages); };

// Input 62
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/1/14
 * Time: 5:56 PM
 */

goog.provide('epiviz.plugins.charts.HeatmapPlot');

goog.require('epiviz.ui.charts.Plot');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory');
goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.datatypes.MapGenomicData');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Plot}
 * @constructor
 */
epiviz.plugins.charts.HeatmapPlot = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Plot.call(this, id, container, properties);

  /**
   * D3 chart container
   * @type {*}
   * @private
   */
  this._chartContent = null;

  /**
   * @type {number}
   * @private
   */
  this._min = this.measurements().first().minValue();

  /**
   * @type {number}
   * @private
   */
  this._max = this.measurements().first().maxValue();

  /**
   * @type {function(number): string}
   * @private
   */
  this._colorScale = epiviz.utils.colorizeBinary(this._min, this._max, '#ffffff', this.colors().getByKey('Max'));

  /**
   * @type {Array.<string>}
   * @private
   */
  this._colorLabels = [];

  /**
   * @type {number}
   * @private
   */
  this._dendrogramRatio = 0.1;

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.HeatmapPlot.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Plot.prototype);
epiviz.plugins.charts.HeatmapPlot.constructor = epiviz.plugins.charts.HeatmapPlot;

/**
 * @protected
 */
epiviz.plugins.charts.HeatmapPlot.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Plot.prototype._initialize.call(this);
  this._svg.classed('heatmap-plot', true);
  this._chartContent = this._svg.append('g').attr('class', 'chart-content');
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {epiviz.datatypes.GenomicData} [data]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.HeatmapPlot.prototype.draw = function(range, data) {

  epiviz.ui.charts.Plot.prototype.draw.call(this, range, data);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  var cluster = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTER];

  var pair = this._applyClustering(range, data);

  /** @type {epiviz.datatypes.GenomicData} */
  var orderedData = pair.data;
  var colOrder = pair.columnOrder;

  return this._drawCells(range, orderedData, colOrder);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @returns {{data:epiviz.datatypes.GenomicData, columnOrder:Array.<number>}}
 * @private
 */
epiviz.plugins.charts.HeatmapPlot.prototype._applyClustering = function(range, data) {
  // TODO: This might not be needed anymore
  // TODO: Search for all usages of this method
  var dataHasGenomicLocation = epiviz.measurements.Measurement.Type.isOrdered(this.measurements().first().type());

  // Apply clustering
  var cluster = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTER];
  var showDendrogram = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_DENDROGRAM];
  var clusteringAlgFactory = epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.instance();
  var clusterer = clusteringAlgFactory.algorithm(
    this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTERING_ALG]);
  var metric = clusteringAlgFactory.metric(
    this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTERING_METRIC]);
  var linkage = clusteringAlgFactory.linkage(
    this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTERING_LINKAGE]);
  var maxColumns = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.MAX_COLUMNS];

  var firstGlobalIndex = data.firstSeries().globalStartIndex();
  var lastGlobalIndex = data.firstSeries().size() + firstGlobalIndex;

  data.foreach(function(measurement, series) {
    var firstIndex = series.globalStartIndex();
    var lastIndex = series.globalEndIndex();

    if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
  });
  var nEntries = lastGlobalIndex - firstGlobalIndex;

  var clusterRows = (cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.ROWS || cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.BOTH);
  var clusterCols = (cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.COLS || cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.BOTH);
  var dendrogramRatio = showDendrogram * this._dendrogramRatio;
  var dendrogramCols = (showDendrogram && clusterCols && maxColumns >= nEntries);

  var population, dendrogram, indexOrder, top, left, height, width;

  var svg = this._svg;
  ['dendrogram-horizontal', 'dendrogram-vertical'].forEach(function(dendClass) { svg.select('.' + dendClass).remove(); });

  /** @type {epiviz.datatypes.GenomicData} */
  var orderedData = data;

  if (clusterRows) {
    population = [];
    data.foreach(function(measurement, series) {
      var row = [];
      for (var j = 0; j < nEntries; ++j) {
        var globalIndex = j + firstGlobalIndex;
        var item = series.getByGlobalIndex(globalIndex);
        var rowInfo = item.rowItem;

        if (!dataHasGenomicLocation ||
            (range.start() == undefined || range.end() == undefined) ||
            rowInfo.start() < range.end() && rowInfo.end() >= range.start()) {
          row.push(item.value);
        }
      }
      population.push(row);
    });
    dendrogram = clusterer.cluster(population, metric, linkage);
    indexOrder = dendrogram.root().data();
    var measurements = [];
    data.foreach(function(measurement) { measurements.push(measurement); });
    var orderedMs = [];
    var i;
    for (i = 0; i < indexOrder.length; ++i) {
      orderedMs[i] = measurements[indexOrder[i]];
    }

    var ordered = new epiviz.measurements.MeasurementHashtable();
    for (i = 0; i < orderedMs.length; ++i) {
      ordered.put(orderedMs[i], data.getSeries(orderedMs[i]));
    }
    orderedData = new epiviz.datatypes.MapGenomicData(ordered);

    if (dendrogramRatio) {
      width = (this.width()) * dendrogramRatio;
      height = this.height() * (1 - dendrogramRatio * dendrogramCols) - this.margins().sumAxis(epiviz.ui.charts.Axis.Y);
      top = this.margins().top();
      left = this.width() - width - this.margins().right();
      this._drawDendrogram(dendrogram, top, left, height, width);
    }
  }

  // Column clustering
  indexOrder = null;
  if (clusterCols) {
    population = [];
    data.foreach(function(measurement, series) {
      for (var j = 0, row = 0; j < nEntries; ++j) {
        var globalIndex = j + firstGlobalIndex;
        var item = series.getByGlobalIndex(globalIndex);
        var rowInfo = item.rowItem;
        if (!dataHasGenomicLocation ||
            (range.start() == undefined || range.end() == undefined) ||
            rowInfo.start() < range.end() && rowInfo.end() >= range.start()) {
          if (population.length <= row) {
            population.push([]);
          }
          population[row].push(item.value);
          ++row;
        }
      }
    });

    if (population.length == 0) {
      return {data: orderedData, columnOrder: []};
    }

    dendrogram = clusterer.cluster(population, metric, linkage);
    indexOrder = dendrogram.root().data();

    if (dendrogramCols) {
      var rowLabelsAsColors = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_COLORS_FOR_ROW_LABELS];
      var rowLabelColorWidth = rowLabelsAsColors ? 20 : 0; // TODO: Customize
      left = this.margins().left();
      top = this.height() * (1 - dendrogramRatio) - this.margins().bottom();
      width = this.height() * dendrogramRatio;
      height = this.width() * (1 - dendrogramRatio * clusterRows) - this.margins().left() - this.margins().right() - rowLabelColorWidth;
      this._drawDendrogram(dendrogram, top, left, height, width, true);
    }
  }

  return {data: orderedData, columnOrder: indexOrder};
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {Array.<number>} [colOrder]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.HeatmapPlot.prototype._drawCells = function(range, data, colOrder) {
  var self = this;
  var Axis = epiviz.ui.charts.Axis;

  var maxColumns = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.MAX_COLUMNS];

  var firstGlobalIndex = data.firstSeries().globalStartIndex();
  var lastGlobalIndex = data.firstSeries().size() + firstGlobalIndex;
  var rows = [];

  // TODO: This might not be needed anymore
  // TODO: Search for all usages of this method
  var dataHasGenomicLocation = epiviz.measurements.Measurement.Type.isOrdered(this.measurements().first().type());

  data.foreach(function(measurement, series) {
    var firstIndex = series.globalStartIndex();
    var lastIndex = series.globalEndIndex();

    if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }

    rows.push(measurement);
  });

  var nEntries = lastGlobalIndex - firstGlobalIndex;

  var colLabel = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.COL_LABEL];

  //var dendrogramRatio = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.DENDROGRAM_RATIO];
  var cluster = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTER];
  var clusterRows = (cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.ROWS || cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.BOTH);
  var clusterCols = ((cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.COLS || cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.BOTH)
                     && maxColumns >= nEntries);

  var dendrogramRatio = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_DENDROGRAM] * this._dendrogramRatio;
  var rowLabelsAsColors = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_COLORS_FOR_ROW_LABELS];
  var rowLabelColorWidth = rowLabelsAsColors ? 20 : 0; // TODO: Customize


  var width = this.width() * (1 - dendrogramRatio * clusterRows) - rowLabelColorWidth;
  var height = this.height() * (1 - dendrogramRatio * clusterCols);

  var globalIndices = [];
  var colnames = [];
  var i, globalIndex;

  for (i = 0; i < nEntries; ++i) {
    globalIndex = i + firstGlobalIndex;

    // Find a defined row item for the data
    var item;
    data.foreach(function(m, series) {
      item = series.getRowByGlobalIndex(globalIndex);
      return item; // break if item is defined
    });

    if (!item) { continue; }

    if (!dataHasGenomicLocation ||
      (range.start() == undefined || range.end() == undefined) ||
      item.start() < range.end() && item.end() >= range.start()) {
      globalIndices.push(globalIndex);
      var label = item.metadata(colLabel) || '' + item.id();
      colnames.push(label);
    }
  }

  if (colOrder) {
    var unorderedGlobalIndices = globalIndices;
    var unorderedColnames = colnames;
    globalIndices = new Array(globalIndices.length);
    colnames = new Array(colnames.length);
    for (i = 0; i < globalIndices.length; ++i) {
      globalIndices[i] = unorderedGlobalIndices[colOrder[i]];
      colnames[i] = unorderedColnames[colOrder[i]];
      // TODO: Columnmap seems to have same functionality as globalIndices!
      //columnMap[i] = globalIndices[i];
    }
  }

  /** @type {Array.<epiviz.ui.charts.ChartObject>} */
  var items = [];
  var colIndex = {};
  data.foreach(function(m, series, seriesIndex) {
    var nextCellsPerCol = Math.ceil(colnames.length / maxColumns), cellsPerCol = 0;
    var colsLeft = maxColumns;
    for (var i = 0; i < colnames.length; ++i) {
      globalIndex = globalIndices[i];

      var cell = series.getByGlobalIndex(globalIndex);
      if (!cell) { continue; }
      var uiObj = null;
      if (cellsPerCol == 0) {
        var classes = sprintf('item data-series-%s', seriesIndex);

        uiObj = new epiviz.ui.charts.ChartObject(
          sprintf('heatmap_%s_%s', seriesIndex, globalIndex),
          cell.rowItem.start(),
          cell.rowItem.end(),
          [cell.value],
          seriesIndex,
          [[cell]], // valueItems one for each measurement
          [m], // measurements
          classes);
        items.push(uiObj);

        nextCellsPerCol = Math.ceil((colnames.length - i) / colsLeft);
        cellsPerCol = nextCellsPerCol;
        --colsLeft;
      } else {
        uiObj = items[items.length - 1];
        uiObj.id += '_' + globalIndex;
        if (epiviz.measurements.Measurement.Type.isOrdered(series.measurement().type())) {
          uiObj.start = Math.min(uiObj.start, cell.rowItem.start());
          uiObj.end = Math.max(uiObj.end, cell.rowItem.end());
        }
        uiObj.values[0] = (uiObj.values[0] * uiObj.valueItems[0].length + cell.value) / (uiObj.valueItems[0].length + 1);
        uiObj.valueItems[0].push(cell);
      }

      if (seriesIndex == 0) {
        colIndex[globalIndex] = items.length - 1;
      }

      --cellsPerCol;
    }
  });

  var colorLabelsMap;
  var colorScales;
  this._min = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MIN];
  this._max = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MAX];
  var CustomSetting = epiviz.ui.charts.CustomSetting;
  if (this._min == CustomSetting.DEFAULT) { this._min = data.measurements()[0].minValue(); }
  if (this._max == CustomSetting.DEFAULT) { this._max = data.measurements()[0].maxValue(); }
  if (this._globalIndexColorLabels) {
    colorLabelsMap = {};
    for (var j = firstGlobalIndex; j < lastGlobalIndex; ++j) {
      colorLabelsMap[this._globalIndexColorLabels[j]] = this._globalIndexColorLabels[j];
    }
    this._colorLabels = Object.keys(colorLabelsMap);
    colorScales = {};
    this._colorLabels.forEach(function(label, i) {
      var color = self.colors().getByKey(label);
      colorScales[label] = epiviz.utils.colorizeBinary(self._min, self._max, '#ffffff', color);
    });
  } else {
    this._colorLabels = [
      sprintf('Max', data.firstSeries().measurement().maxValue())
    ];
    this._colorScale = epiviz.utils.colorizeBinary(this._min, this._max, '#ffffff', this.colors().getByKey('Max'));
  }

  var nCols = Math.min(colnames.length, maxColumns);
  var cellWidth = nCols ? (width - this.margins().sumAxis(Axis.X)) / nCols : 0;
  var cellHeight = (height - this.margins().sumAxis(Axis.Y)) / data.measurements().length;

  var itemsGroup = this._chartContent.select('.items');

  if (itemsGroup.empty()) {
    itemsGroup = this._chartContent.append('g')
      .attr('class', 'items');
    var selectedGroup = itemsGroup.append('g').attr('class', 'selected');
    itemsGroup.append('g').attr('class', 'hovered');
    selectedGroup.append('g').attr('class', 'hovered');
  }

  itemsGroup.attr('transform', 'translate(' + this.margins().left() + ', ' + this.margins().top() + ')');

  var selection = itemsGroup.selectAll('rect').data(items, function(d) { return d.id; });

  selection
    .enter()
    .append('rect')
    .attr('id', function (d) {
      return sprintf('%s-item-%s-%s', self.id(), d.seriesIndex, d.valueItems[0][0].globalIndex);
    })
    .attr('class', function(d) { return d.cssClasses; })
    .style('opacity', 0)
    .style('fill-opacity', 0)
    .attr('x', function(d) { return cellWidth * colIndex[d.valueItems[0][0].globalIndex]; })
    .attr('y', function(d) { return cellHeight * d.seriesIndex; })
    .attr('width', cellWidth)
    .attr('height', cellHeight)
    .style('fill', function(d, i) {
      if (!self._globalIndexColorLabels) { return self._colorScale(d.values[0]); }
      return colorScales[self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]](d.values[0]);
    });

  selection
    .transition()
    .duration(1000)
    .style('fill-opacity', null)
    .style('opacity', null)
    .attr('x', function(d) {
      return cellWidth * colIndex[d.valueItems[0][0].globalIndex];
    })
    .attr('y', function(d) { return cellHeight * d.seriesIndex; })
    .attr('width', cellWidth)
    .attr('height', cellHeight)
    .style('fill', function(d) {
      if (!self._globalIndexColorLabels) { return self._colorScale(d.values[0]); }
      return colorScales[self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]](d.values[0]);
    });

  selection
    .exit()
    .transition()
    .duration(1000)
    .style('opacity', 0)
    .remove();

  selection
    .on('mouseover', function (d) {
      self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
    })
    .on('mouseout', function () {
      self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
    })
    .on('click', function (d) {
      self._deselect.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
      self._select.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));

      d3.event.stopPropagation();
    });

  this._drawLabels(itemsGroup, colnames, globalIndices, nCols, rows, cellWidth, cellHeight, firstGlobalIndex, width);

  return items;
};

/**
 * @param {epiviz.ui.charts.transform.clustering.ClusterTree} dendrogram
 * @param {number} top
 * @param {number} left
 * @param {number} height
 * @param {number} width
 * @param {boolean} [horizontal]
 * @private
 */
epiviz.plugins.charts.HeatmapPlot.prototype._drawDendrogram = function(dendrogram, top, left, height, width, horizontal) {
  var dendClass = horizontal ? 'dendrogram-horizontal' : 'dendrogram-vertical';
  var showLabels = false;

  var dendContainer = this._svg.append('g').attr('class', dendClass);

  if (!horizontal) {
    dendContainer.attr('transform', 'translate(' + left + ',' + top + ')');
    this._drawSubDendrogram(this._svg.select('.' + dendClass), dendrogram.root(), 0, 0, width, height, showLabels);
  } else {
    dendContainer.attr('transform', 'translate(' + left + ',' + top + ')scale(-1, 1)rotate(90, 0, 0)');
    this._drawSubDendrogram(this._svg.select('.' + dendClass), dendrogram.root(), 0, 0, width, height, showLabels);
  }
};

/**
 * @param svg
 * @param {epiviz.ui.charts.transform.clustering.ClusterNode} node
 * @param {number} top
 * @param {number} left
 * @param {number} width
 * @param {number} height
 * @param {boolean} showLabels
 * @private
 */
epiviz.plugins.charts.HeatmapPlot.prototype._drawSubDendrogram = function(svg, node, top, left, width, height, showLabels) {
  var children = node.children();
  if (children.length == 0) {
    return top + height * 0.5;
  }

  var xScale = d3.scale.linear()
    .domain([0, node.distance()])
    .range([0, width]);
  var nextTop = 0;
  var firstY, lastY;
  for (var i = 0; i < children.length; ++i) {
    var childTop = top + nextTop;
    var childHeight = (height / node.weight()) * children[i].weight();
    var childWidth = xScale(children[i].distance());

    var yCenter = this._drawSubDendrogram(
      svg,
      children[i],
      childTop,
      left,
      childWidth,
      childHeight,
      showLabels);

    svg.append('line')
      .attr('x1', left + childWidth)
      .attr('x2', left + width)
      .attr('y1', yCenter)
      .attr('y2', yCenter)
      .style('stroke', '#555555')
      .style('stroke-width', 1)
      .style('shape-rendering', 'auto');

    if (i == 0 && showLabels) {
      svg.append('text')
        .attr('class', 'row-text')
        .attr('x', Math.max(left + 10, left + (childWidth + width) * 0.5))
        .attr('y', yCenter - 10)
        .style('text-anchor', 'middle')
        .text(Globalize.format(node.distance(), 'n2'));
    }

    if (firstY == undefined || firstY > yCenter) {
      firstY = yCenter;
    }

    if (lastY == undefined || lastY < yCenter) {
      lastY = yCenter;
    }

    nextTop += (height / node.weight()) * children[i].weight();
  }

  svg.append('line')
    .attr('x1', left + width)
    .attr('x2', left + width)
    .attr('y1', firstY)
    .attr('y2', lastY)
    .style('stroke', '#555555')
    .style('stroke-width', 1)
    .style('shape-rendering', 'auto');

  return (firstY + lastY) * 0.5;
};

/**
 * @param itemsGroup D3 selection
 * @param {Array.<string>} colnames
 * @param {Object.<number, number>} columnMap
 * @param {number} nCols
 * @param {Array.<epiviz.measurements.Measurement>} rows
 * @param {number} cellWidth
 * @param {number} cellHeight
 * @param {number} firstGlobalIndex
 * @param {number} width
 * @private
 */
epiviz.plugins.charts.HeatmapPlot.prototype._drawLabels = function(itemsGroup, colnames, columnMap, nCols, rows, cellWidth, cellHeight, firstGlobalIndex, width) {

  var self = this;

  var mapCol = function(i, centered) {
    return i * cellWidth + ((centered) ? 0.5 * cellWidth : 0);
  };

  var mapRow = function(i, centered) {
    return i * cellHeight + ((centered) ? cellHeight * 0.5 : 0);
  };

  var measurementLabel = function(m) {
    var label;
    if (rowLabel == 'name') { label = m.name(); }
    else {
      var anno = m.annotation();
      if (!anno || !(rowLabel in anno)) { label = '<NA>'; }
      else { label = anno[rowLabel]; }
    }
    rowLabelMap[label] = label;
    return label;
  };

  // Column names
  var colSelection = itemsGroup.selectAll('.col-text');

  var maxColSize = 0;
  if (colnames.length > nCols) {
    colSelection
      .transition()
      .duration(500)
      .style('opacity', 0)
      .remove();
  } else {
    colSelection = colSelection
      .data(colnames, function(d, i) { return d + columnMap[i]; });

    colSelection
      .enter()
      .append('text')
      .attr('class', 'col-text')
      .style('opacity', '0')
      .attr('x', 0)
      .attr('y', 0)
      .attr('transform', function(d, i){
        return 'translate(' + (mapCol(i, true))  + ',' + (-5) + ')rotate(-60)';
      })
      .text(function(d){ return d; });

    colSelection
      .transition()
      .duration(500)
      .attr('x', 0)
      .attr('y', 0)
      .attr('transform', function(d, i){
        return 'translate(' + (mapCol(i, true))  + ',' + (-5) + ')rotate(-60)';
      })
      .style('opacity', null)
      .attr('fill', function(colName, i) {
        var globalIndex = i + firstGlobalIndex;
        if (!self._globalIndexColorLabels) { return '#000000'; }
        return self.colors().getByKey(self._globalIndexColorLabels[globalIndex]);
      });

    colSelection
      .exit()
      .transition()
      .duration(500)
      .style('opacity', 0)
      .remove();

    $('#' + this.id() + ' .col-text')
      .each(function(i) {
        var textWidth = this.getBBox().width;
        if (maxColSize < textWidth) { maxColSize = textWidth; }
      });
  }

  // Row names

  var rowLabel = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL];
  var rowLabelsAsColors = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_COLORS_FOR_ROW_LABELS];

  if (!rowLabelsAsColors) {
    itemsGroup.selectAll('.row-color-label').remove();
    var rowSelection = itemsGroup.selectAll('.row-text')
      .data(rows, function(m) { return m.id(); });

    rowSelection
      .enter()
      .append('text')
      .attr('class', 'row-text')
      .attr('x', 0)
      .attr('y', 0)
      .attr('transform', function(d, i){
        return 'translate(' + (-5) + ',' + (mapRow(i, true)) + ')rotate(30)';
      });

    rowSelection
      .text(function(m){
        if (rowLabel == 'name') { return m.name(); }
        var anno = m.annotation();
        if (!anno || !(rowLabel in anno)) { return '<NA>'; }
        return anno[rowLabel];
      });

    rowSelection
      .transition()
      .duration(500)
      .attr('x', 0)
      .attr('y', 0)
      .attr('transform', function(d, i){
        return 'translate(' + (-5) + ',' + (mapRow(i, true)) + ')rotate(30)';
      });

    rowSelection.exit().remove();
  }

  var rowLabelCat;
  if (rowLabelsAsColors) {
    itemsGroup.selectAll('.row-text').remove();
    var rowLabelMap = {};
    rows.forEach(function(m) {
      var label = measurementLabel(m);
      rowLabelMap[label] = label;
    });
    rowLabelCat = Object.keys(rowLabelMap);

    var rowColorLabels = itemsGroup.selectAll('.row-color-label')
      .data(rows, function(m) { return m.id(); });

    rowColorLabels
      .enter()
      .append('rect')
      .attr('class', 'row-color-label')
      .attr('x', width - self.margins().sumAxis(epiviz.ui.charts.Axis.X))
      .attr('y', -cellHeight*0.5)
      .attr('width', 20)// TODO: Use a custom variable
      .attr('height', cellHeight)
      .attr('transform', function(d, i){
        return 'translate(' + (0) + ',' + (mapRow(i, true)) + ')';
      });

    rowColorLabels
      .style('fill', function(m) {
        var label = measurementLabel(m);
        return self.colors().getByKey(label);
      });

    rowColorLabels
      .transition()
      .duration(500)
      .attr('x', width - self.margins().sumAxis(epiviz.ui.charts.Axis.X))
      .attr('y', -cellHeight*0.5)
      .attr('height', cellHeight)
      .attr('transform', function(d, i){
        return 'translate(' + (0) + ',' + (mapRow(i, true)) + ')';
      });

    rowColorLabels.exit().remove();
  }

  // Legend
  this._svg.selectAll('.chart-title').remove();
  this._svg.selectAll('.chart-title-color ').remove();
  var titleEntries = this._svg
    .selectAll('.chart-title')
    .data(['Min'].concat(this._colorLabels));
  titleEntries
    .enter()
    .append('text')
    .attr('class', 'chart-title')
    .attr('font-weight', 'bold')
    .attr('y', self.margins().top() - 5 - maxColSize);
  titleEntries
    .attr('fill', function(label, i) {
      if (i == 0) { return '#000000'; }
      return self.colors().getByKey(label);
    })
    .text(function(label) { return label; });
  var textLength = 0;
  var titleEntriesStartPosition = [];

  $('#' + this.id() + ' .chart-title')
    .each(function(i) {
      titleEntriesStartPosition.push(textLength);
      textLength += this.getBBox().width + 15;
    });

  titleEntries.attr('x', function(column, i) {
    return self.margins().left() + 10 + titleEntriesStartPosition[i];
  });

  var colorEntries = this._svg
    .selectAll('.chart-title-color')
    .data(['Min'].concat(this._colorLabels))
    .enter()
    .append('circle')
    .attr('class', 'chart-title-color')
    .attr('cx', function(column, i) { return self.margins().left() + 4 + titleEntriesStartPosition[i]; })
    .attr('cy', self.margins().top() - 9 - maxColSize)
    .attr('r', 4)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .attr('fill', function(label, i) {
      if (i == 0) { return '#ffffff'; }
      return self.colors().getByKey(label);
    })
    .style('stroke-width', function(label, i) { return i ? 0 : 1; })
    .style('stroke', '#000000');

  // Row labels legend

  this._svg.selectAll('.row-legend').remove();
  this._svg.selectAll('.row-legend-color').remove();
  if (rowLabelsAsColors) {
    // TODO: Make this optional
    //rowLabelCat.sort();
    var textEntries = this._svg
      .selectAll('.row-legend')
      .data(rowLabelCat);
    textEntries
      .enter()
      .append('text')
      .attr('class', 'row-legend')
      .attr('font-weight', 'bold')
      .attr('x', -20);
    textEntries
      .attr('fill', function(label) {
        return self.colors().getByKey(label);
      })
      .text(function(label) { return label; })
      .attr('transform', function(d, i){
        return 'translate(' + (self.margins().left()) + ',' + (self.margins().top()) + ')';
      });

    textEntries.attr('y', function(label, i) {
      return 10 + i * 15;
    });

    this._svg
      .selectAll('.row-legend-color')
      .data(rowLabelCat)
      .enter()
      .append('rect')
      .attr('class', 'chart-title-color')
      .attr('x', -18)
      .attr('y', function(label, i) { return 2 + i * 15})
      .attr('width', 10)
      .attr('height', 10)
      .style('shape-rendering', 'auto')
      .style('stroke-width', '0')
      .attr('fill', function(label) { return self.colors().getByKey(label); })
      .style('stroke-width', 0)
      .attr('transform', function(d, i){
        return 'translate(' + (self.margins().left()) + ',' + (self.margins().top()) + ')';
      });

    this._colorLabels = this._colorLabels.concat(rowLabelCat)
  }
};

/**
 * @returns {Array.<{name: string, color: string}>}
 */
epiviz.plugins.charts.HeatmapPlot.prototype.colorLabels = function() {
  return this._colorLabels;
};

// goog.inherits(epiviz.plugins.charts.HeatmapPlot, epiviz.ui.charts.Plot);

// Input 63
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/1/14
 * Time: 5:56 PM
 */

goog.provide('epiviz.plugins.charts.HeatmapPlotType');

goog.require('epiviz.plugins.charts.HeatmapPlot');
goog.require('epiviz.ui.charts.PlotType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');
goog.require('epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.PlotType}
 * @constructor
 */
epiviz.plugins.charts.HeatmapPlotType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.PlotType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.HeatmapPlotType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.PlotType.prototype);
epiviz.plugins.charts.HeatmapPlotType.constructor = epiviz.plugins.charts.HeatmapPlotType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.HeatmapPlot}
 */
epiviz.plugins.charts.HeatmapPlotType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.HeatmapPlot(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.HeatmapPlotType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.HeatmapPlot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.HeatmapPlotType.prototype.chartName = function() {
  return 'Heatmap';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.HeatmapPlotType.prototype.chartHtmlAttributeName = function() {
  return 'heatmap';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.HeatmapPlotType.prototype.measurementsFilter = function() { return function(m) { return epiviz.measurements.Measurement.Type.hasValues(m.type()); }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.plugins.charts.HeatmapPlotType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.HeatmapPlotType.prototype.customSettingsDefs = function() {
  var clusteringFactory = epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.instance();

  return epiviz.ui.charts.PlotType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.COL_LABEL,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_METADATA,
      'colLabel',
      'Columns labels'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_ANNOTATION,
      'name',
      'Row labels'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_COLORS_FOR_ROW_LABELS,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      false,
      'Row labels as colors'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.MAX_COLUMNS,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      40,
      'Max columns'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min Value'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max Value'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTER,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'rows',
      'Cluster',
      Object.keys(epiviz.plugins.charts.HeatmapPlotType.Cluster).map(function(key) { return epiviz.plugins.charts.HeatmapPlotType.Cluster[key]; })),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTERING_ALG,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      clusteringFactory.algorithms()[0],
      'Clustering Algorithm',
      clusteringFactory.algorithms()),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTERING_METRIC,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      clusteringFactory.metrics()[0],
      'Clustering Metric',
      clusteringFactory.metrics()),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTERING_LINKAGE,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      clusteringFactory.linkages()[0],
      'Clustering Linkage',
      clusteringFactory.linkages()),

    // TODO: Maybe add back later
    /*new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.DENDROGRAM_RATIO,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      0,
      'Dendrogram Ratio'),*/

    /*new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_DENDROGRAM_LABELS,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      false,
      'Show Dendrogram Labels')*/
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_DENDROGRAM,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      true,
      'Show Dendrogram')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.HeatmapPlotType.Cluster = {
  NONE: 'none',
  ROWS: 'rows',
  COLS: 'columns',
  BOTH: 'both'
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.HeatmapPlotType.CustomSettings = {
  MAX_COLUMNS: 'maxColumns',
  CLUSTER: 'cluster',
  CLUSTERING_ALG: 'clusteringAlg',
  CLUSTERING_METRIC: 'clusteringMetric',
  CLUSTERING_LINKAGE: 'clusteringLinkage',
  // TODO: Maybe add back later
  //DENDROGRAM_RATIO: 'dendrogramRatio',
  //SHOW_DENDROGRAM_LABELS: 'showDendrogramLabels',
  SHOW_DENDROGRAM: 'showDendrogram',
  SHOW_COLORS_FOR_ROW_LABELS: 'showColorsForRowLabels'
};

// goog.inherits(epiviz.plugins.charts.HeatmapPlotType, epiviz.ui.charts.PlotType);

// Input 64
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/9/2014
 * Time: 1:09 AM
 */

goog.provide('epiviz.plugins.charts.LinePlot');

goog.require('epiviz.ui.charts.Plot');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.measurements.Measurement');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Plot}
 * @constructor
 */
epiviz.plugins.charts.LinePlot = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Plot.call(this, id, container, properties);

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.LinePlot.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Plot.prototype);
epiviz.plugins.charts.LinePlot.constructor = epiviz.plugins.charts.LinePlot;

/**
 * @protected
 */
epiviz.plugins.charts.LinePlot.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Plot.prototype._initialize.call(this);

  this._svg.classed('line-plot', true);
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.LinePlot.prototype.draw = function(range, data, slide, zoom) {
  epiviz.ui.charts.Plot.prototype.draw.call(this, range, data, slide, zoom);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  var CustomSetting = epiviz.ui.charts.CustomSetting;
  var minY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MIN];
  var maxY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MAX];

  var rowLabel = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL];

  if (minY == CustomSetting.DEFAULT) {
    minY = null;
    data.measurements().forEach(function(m) {
      if (m === null) { return; }
      if (minY === null || m.minValue() < minY) { minY = m.minValue(); }
    });
  }

  if (maxY == CustomSetting.DEFAULT) {
    maxY = null;
    data.measurements().forEach(function(m) {
      if (m === null) { return; }
      if (maxY === null || m.maxValue() > maxY) { maxY = m.maxValue(); }
    });
  }

  if (minY === null && maxY === null) { minY = -1; maxY = 1; }
  if (minY === null) { minY = maxY - 1; }
  if (maxY === null) { maxY = minY + 1; }

  var Axis = epiviz.ui.charts.Axis;
  var xScale = d3.scale.linear()
    .domain([0, data.measurements().length - 1])
    .range([0, this.width() - this.margins().sumAxis(Axis.X)]);
  var yScale = d3.scale.linear()
    .domain([minY, maxY])
    .range([this.height() - this.margins().sumAxis(Axis.Y), 0]);

  this._clearAxes();
  this._drawAxes(xScale, yScale, data.measurements().length, 5,
    undefined, undefined, undefined, undefined, undefined, undefined,
    data.measurements().map(function(m) {
      if (rowLabel == 'name') { return m.name(); }
      var anno = m.annotation();
      if (!anno || !(rowLabel in anno)) { return '<NA>'; }
      return anno[rowLabel];
    }));

  var linesGroup = this._svg.selectAll('.lines');

  if (linesGroup.empty()) {
    linesGroup = this._svg.append('g')
      .attr('class', 'lines items');

    var selectedGroup = linesGroup.append('g').attr('class', 'selected');
    linesGroup.append('g').attr('class', 'hovered');
    selectedGroup.append('g').attr('class', 'hovered');
  }
  linesGroup.attr('transform', 'translate(' + this.margins().left() + ', ' + this.margins().top() + ')');
  return this._drawLines(range, data, xScale, yScale);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {function} xScale D3 linear scale
 * @param {function} yScale D3 linear scale
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.LinePlot.prototype._drawLines = function(range, data, xScale, yScale) {
  /** @type {epiviz.ui.charts.ColorPalette} */
  var colors = this.colors();

  /** @type {boolean} */
  var showPoints = this.customSettingsValues()[epiviz.plugins.charts.LinePlotType.CustomSettings.SHOW_POINTS];

  /** @type {boolean} */
  var showLines = this.customSettingsValues()[epiviz.plugins.charts.LinePlotType.CustomSettings.SHOW_LINES];

  /** @type {boolean} */
  var showErrorBars = this.customSettingsValues()[epiviz.plugins.charts.LinePlotType.CustomSettings.SHOW_ERROR_BARS];

  /** @type {number} */
  var pointRadius = this.customSettingsValues()[epiviz.plugins.charts.LinePlotType.CustomSettings.POINT_RADIUS];

  /** @type {number} */
  var lineThickness = this.customSettingsValues()[epiviz.plugins.charts.LinePlotType.CustomSettings.LINE_THICKNESS];

  var interpolation = this.customSettingsValues()[epiviz.plugins.charts.LinePlotType.CustomSettings.INTERPOLATION];

  var colLabel = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.COL_LABEL];

  var absLine = this.customSettingsValues()[epiviz.plugins.charts.LinePlotType.CustomSettings.ABS_LINE_VAL];

  var self = this;

  var graph = this._svg.select('.lines');

  var firstGlobalIndex = data.firstSeries().globalStartIndex();
  var lastGlobalIndex = data.firstSeries().globalEndIndex();

  data.foreach(function(measurement, series) {
    var firstIndex = series.globalStartIndex();
    var lastIndex = series.globalEndIndex();

    if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
  });

  var nEntries = lastGlobalIndex - firstGlobalIndex;

  // TODO: This might not be needed anymore
  // TODO: Search for all usages of this method
  var dataHasGenomicLocation = epiviz.measurements.Measurement.Type.isOrdered(data.measurements()[0].type());
  var firstIndex, lastIndex;
  for (var i = 0; i < nEntries; ++i) {
    var globalIndex = i + firstGlobalIndex;
    var item = data.firstSeries().getRowByGlobalIndex(globalIndex);
    if (!dataHasGenomicLocation ||
      (range.start() == undefined || range.end() == undefined) ||
      item.start() < range.end() && item.end() >= range.start()) {
      if (firstIndex == undefined) { firstIndex = globalIndex; }
      lastIndex = globalIndex + 1;
    }
  }

  firstGlobalIndex = firstIndex;
  lastGlobalIndex = lastIndex;
  nEntries = lastIndex - firstIndex;

  var width = this.width();

  var lineFunc = d3.svg.line()
    .x(function(d) {
      return xScale(d.x);
    })
    .y(function(d) {
      return yScale(d.y);
    })
    .interpolate(interpolation);

  /**
   * @param {epiviz.datatypes.GenomicData.RowItem} row
   * @returns {string|number}
   */
  var colorBy = function(row) {
    return self._globalIndexColorLabels ? self._globalIndexColorLabels[row.globalIndex()] : row.metadata(colLabel);
  };


  var valuesForIndex = function(index) {
    return data.measurements()
      .map(function(m, i) {
        var item = data.getByGlobalIndex(m, index);
        return {
          x: i,
          y: item ? item.value : null,
          errMinus: (item && item.valueAnnotation) ? item.valueAnnotation['errMinus'] : null,
          errPlus: (item && item.valueAnnotation) ? item.valueAnnotation['errPlus'] : null
        };
      })
      .filter(function(o) {
        return o.y !== null;
      });
  };

  var indices = epiviz.utils.range(nEntries, firstGlobalIndex);

  var lineItems;
  if (!showLines) {
    graph.selectAll('.line-series').remove();
  } else {
    lineItems = indices.map(function(index) {
      var rowItem = data.firstSeries().getRowByGlobalIndex(index);
      return new epiviz.ui.charts.ChartObject(
        sprintf('line-series-%s', index),
        rowItem.start(),
        rowItem.end(),
        valuesForIndex(index),
        index,
        data.measurements().map(function(m, i) { return [data.getByGlobalIndex(m, index)]; }), // valueItems one for each measurement
        data.measurements(), // measurements
        '');
    });
    var lines = graph.selectAll('.line-series')
      .data(lineItems, function(d) { return d.id; });

    lines
      .enter()
      .insert('g', ':first-child').attr('class', 'line-series item')
      .style('opacity', '0')
      .on('mouseover', function(d) {
        self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
      })
      .on('mouseout', function () {
        self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
      })
      .each(function(d) {
        d3.select(this)
          .append('path').attr('class', 'bg-line')
          .attr('d', lineFunc(d.values))
          .style('shape-rendering', 'auto')
          .style('stroke-width', 10)
          .style('stroke', '#dddddd')
          .style('stroke-opacity', '0.1');
        d3.select(this)
          .append('path').attr('class', 'main-line')
          .attr('d', lineFunc(d.values))
          .style('shape-rendering', 'auto');
      });

    lines
      .transition()
      .duration(500)
      .style('opacity', '0.7')
      .each(function(d) {
        var color = colors.getByKey(colorBy(data.firstSeries().getRowByGlobalIndex(d.seriesIndex)));
        d3.select(this)
          .selectAll('.bg-line')
          .attr('d', lineFunc(d.values));
        d3.select(this).selectAll('.main-line')
          .attr('d', lineFunc(d.values))
          .style('stroke', color)
          .style('stroke-width', lineThickness);
      });

    lines
      .exit()
      .transition()
      .duration(500)
      .style('opacity', '0')
      .remove();
  }

  if (!showPoints) {
    graph.selectAll('.points').remove();
  } else {
    var points = graph.selectAll('.points')
      .data(lineItems, function(d) { return d.id; });

    points
      .enter()
      .append('g').attr('class', 'points')
      .style('opacity', '0');

    points
      .each(function(d) {
        d3.select(this).selectAll('.data-point').remove();
        var selection = d3.select(this).selectAll('.data-point').data(d.values);
        selection.enter().append('g').attr('class', 'data-point')
          .each(function(dataPoint) {
            d3.select(this).append('circle')
              .attr('cx', function(d) { return xScale(d.x); })
              .attr('cy', function(d) { return yScale(d.y); })
              .attr('r', pointRadius)
              .style('stroke-width', 2)
              .attr('fill', 'none')
              .attr('stroke', colors.getByKey(colorBy(data.firstSeries().getRowByGlobalIndex(d.seriesIndex))));
            d3.select(this).selectAll('.error-bar').remove();
            if (showErrorBars && dataPoint.errMinus != undefined && dataPoint.errPlus != undefined) {
              d3.select(this)
                .append('line').attr('x1', xScale(dataPoint.x)).attr('x2', xScale(dataPoint.x)).attr('y1', yScale(dataPoint.errMinus)).attr('y2', yScale(dataPoint.errPlus))
                .style('stroke', colors.getByKey(colorBy(data.firstSeries().getRowByGlobalIndex(d.seriesIndex))))
                .style('stroke-width', 2)
                .attr('class', 'error-bar');

              d3.select(this)
                .append('line').attr('x1', xScale(dataPoint.x) - 4).attr('x2', xScale(dataPoint.x) + 4).attr('y1', yScale(dataPoint.errMinus)).attr('y2', yScale(dataPoint.errMinus))
                .style('stroke', colors.getByKey(colorBy(data.firstSeries().getRowByGlobalIndex(d.seriesIndex))))
                .style('stroke-width', 2)
                .attr('class', 'error-bar');

              d3.select(this)
                .append('line').attr('x1', xScale(dataPoint.x) - 4).attr('x2', xScale(dataPoint.x) + 4).attr('y1', yScale(dataPoint.errPlus)).attr('y2', yScale(dataPoint.errPlus))
                .style('stroke', colors.getByKey(colorBy(data.firstSeries().getRowByGlobalIndex(d.seriesIndex))))
                .style('stroke-width', 2)
                .attr('class', 'error-bar');
            }
          });
        selection.exit().remove();
      })
      .transition()
      .duration(500)
      .style('opacity', '1');

    points
      .exit()
      .transition()
      .duration(500)
      .style('opacity', '0')
      .remove();
  }

  // Draw legend
  var title = '';

  var labels = {};
  indices.forEach(function(index) {
    var label = colorBy(data.firstSeries().getRowByGlobalIndex(index));
    labels[label] = label;
  });

  this._svg.selectAll('.chart-title').remove();
  this._svg.selectAll('.chart-title-color').remove();
  var titleEntries = this._svg
    .selectAll('.chart-title')
    .data(Object.keys(labels));
  titleEntries
    .enter()
    .append('text')
    .attr('class', 'chart-title')
    .attr('font-weight', 'bold')
    .attr('y', self.margins().top() - 5);
  titleEntries
    .attr('fill', function(label) { return colors.getByKey(label); })
    .text(function(label) { return label; });

  var textLength = 0;
  var titleEntriesStartPosition = [];

  $('#' + this.id() + ' .chart-title')
    .each(function(i) {
      titleEntriesStartPosition.push(textLength);
      textLength += this.getBBox().width + 15;
    });

  titleEntries.attr('x', function(column, i) {
    return self.margins().left() + 10 + titleEntriesStartPosition[i];
  });

  var colorEntries = this._svg
    .selectAll('.chart-title-color')
    .data(Object.keys(labels))
    .enter()
    .append('circle')
    .attr('class', 'chart-title-color')
    .attr('cx', function(column, i) { return self.margins().left() + 4 + titleEntriesStartPosition[i]; })
    .attr('cy', self.margins().top() - 9)
    .attr('r', 4)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .style('fill', function(label) { return colors.getByKey(label); });


// show baseline
if(absLine != epiviz.ui.charts.CustomSetting.DEFAULT) {

  graph.selectAll('.abLine').remove();

  graph.append("svg:line")
        .attr("class", "abLine")
        .attr("x1", 0)
        .attr("x2", self.width() - self.margins().sumAxis(epiviz.ui.charts.Axis.X))
        .attr("y1", yScale(absLine))
        .attr("y2", yScale(absLine))
        .style("stroke", "black")
        .style("stroke-dasharray", ("5, 5")) ;
}

  return lineItems;
};

/**
 * @returns {Array.<string>}
 */
epiviz.plugins.charts.LinePlot.prototype.colorLabels = function() {
  var labels = [];
  for (var i = 0; i < this.colors().size() && i < 20; ++i) {
    labels.push('Color ' + (i + 1));
  }
  return labels;
};

// goog.inherits(epiviz.plugins.charts.LinePlot, epiviz.ui.charts.Plot);

// Input 65
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/9/2014
 * Time: 1:09 AM
 */

goog.provide('epiviz.plugins.charts.LinePlotType');

goog.require('epiviz.plugins.charts.LinePlot');
goog.require('epiviz.ui.charts.PlotType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.PlotType}
 * @constructor
 */
epiviz.plugins.charts.LinePlotType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.PlotType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.LinePlotType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.PlotType.prototype);
epiviz.plugins.charts.LinePlotType.constructor = epiviz.plugins.charts.LinePlotType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.LinePlot}
 */
epiviz.plugins.charts.LinePlotType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.LinePlot(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LinePlotType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.LinePlot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LinePlotType.prototype.chartName = function() {
  return 'Line Plot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LinePlotType.prototype.chartHtmlAttributeName = function() {
  return 'line-plot';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.LinePlotType.prototype.measurementsFilter = function() { return function(m) { return m.type() == epiviz.measurements.Measurement.Type.FEATURE; }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.plugins.charts.LinePlotType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.LinePlotType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.PlotType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.COL_LABEL,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_METADATA,
      'colLabel',
      'Columns labels'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_ANNOTATION,
      'name',
      'Row labels'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LinePlotType.CustomSettings.SHOW_POINTS,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      false,
      'Show points'),
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LinePlotType.CustomSettings.SHOW_LINES,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      true,
      'Show lines'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LinePlotType.CustomSettings.SHOW_ERROR_BARS,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      true,
      'Show error bars'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LinePlotType.CustomSettings.POINT_RADIUS,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      4,
      'Point radius'),
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LinePlotType.CustomSettings.LINE_THICKNESS,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      3,
      'Line thickness'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LinePlotType.CustomSettings.INTERPOLATION,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'basis',
      'Interpolation',
      ['linear', 'step-before', 'step-after', 'basis', 'basis-open', 'basis-closed', 'bundle', 'cardinal', 'cardinal-open', 'monotone']),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LinePlotType.CustomSettings.ABS_LINE_VAL,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Draw abline')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.LinePlotType.CustomSettings = {
  SHOW_POINTS: 'showPoints',
  SHOW_ERROR_BARS: 'showErrorBars',
  SHOW_LINES: 'showLines',
  POINT_RADIUS: 'pointRadius',
  LINE_THICKNESS: 'lineThickness',
  INTERPOLATION: 'interpolation',
  ABS_LINE_VAL: 'abLine'
};

// goog.inherits(epiviz.plugins.charts.LinePlotType, epiviz.ui.charts.PlotType);

// Input 66
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/2/2015
 * Time: 3:50 PM
 */

goog.provide('epiviz.plugins.charts.StackedLinePlot');

goog.require('epiviz.ui.charts.Plot');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');
goog.require('epiviz.measurements.MeasurementHashtable');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Plot}
 * @constructor
 */
epiviz.plugins.charts.StackedLinePlot = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Plot.call(this, id, container, properties);

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.StackedLinePlot.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Plot.prototype);
epiviz.plugins.charts.StackedLinePlot.constructor = epiviz.plugins.charts.StackedLinePlot;

/**
 * @protected
 */
epiviz.plugins.charts.StackedLinePlot.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Plot.prototype._initialize.call(this);

  this._svg.classed('stacked-line-plot', true);
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.StackedLinePlot.prototype.draw = function(range, data, slide, zoom) {
  epiviz.ui.charts.Plot.prototype.draw.call(this, range, data, slide, zoom);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  var groupBy = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.ROW_GROUP_BY];
  var useGroupBy = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.USE_GROUP_BY];

  var self = this;

  var removeMarker = function() {

    for(var k=0; k < self._markers.length; k ++) {
      if (self._markers[k]._type == epiviz.ui.charts.markers.VisualizationMarker.Type.GROUP_BY_MEASUREMENTS) {
        // remove existing groupby marker.
        var old_mId = self._markers[k].id(); 
        delete self._markersMap[old_mId];
        delete self._markersIndices[old_mId];
        delete self._markers[k];

        self._markers.length--;
      }
    }
  };

  var checkMarker = function(marker) {

    // marker is empty!
    if (!marker) { return null; }
      var i;
      if (marker.id() in self._markersMap) {
        i = self._markersIndices[marker.id()];
        var oldMarker = self._markers[i];
        if (oldMarker == marker ||
            (oldMarker.type() == marker.type() &&
            oldMarker.preMarkStr() == marker.preMarkStr() &&
            oldMarker.markStr() == marker.markStr())) {
          // Marker not modified
          return null;
        }
        self._markers[i] = marker;
        self._markersMap[marker.id()] = marker;
      } 
      else {
        // remove if the marker type already exists
        removeMarker();

        // add the new marker
        i = self._markers.length;
        self._markers.push(marker);
        self._markersIndices[marker.id()] = i;
        self._markersMap[marker.id()] = marker;
      }
  };

  var transformPlotData = function() {
    self.transformData(self._lastRange, self._unalteredData).done(function() {
       self._drawPlot(self._lastRange, self._lastData, slide, zoom);
    });

    self._markersModified.notify(new epiviz.ui.charts.VisEventArgs(self._id, self._markers));
  };

  if(useGroupBy) {
    var marker = new epiviz.ui.charts.markers.VisualizationMarker(epiviz.ui.charts.markers.VisualizationMarker.Type.GROUP_BY_MEASUREMENTS, null, null, 'function(data){return null}', "function(m, data, preMarkResult) {return m.annotation()['" + groupBy + "'];}");
    var value = checkMarker(marker);

    //if(value != null) {
    //  this._drawPlot(range, data, slide, zoom);
    //}
  }
  else {
    removeMarker();
  }

  transformPlotData();
  
};

epiviz.plugins.charts.StackedLinePlot.prototype._drawPlot = function(range, data, slide, zoom) {

  var rowLabel = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL];

  var interpolation = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.INTERPOLATION];
  var xBound = interpolation.indexOf('step') == 0 ? data.measurements().length : data.measurements().length - 1;

  var Axis = epiviz.ui.charts.Axis;
  var xScale = d3.scale.linear()
    .domain([0, xBound])
    .range([0, this.width() - this.margins().sumAxis(Axis.X)]);

  this._clearAxes();
  this._drawAxes(xScale, undefined, data.measurements().length, 5,
    undefined, undefined, undefined, undefined, undefined, undefined,
    data.measurements().map(function(m) {
      if (rowLabel == 'name') { return m.name(); }
      var anno = m.annotation();
      if (!anno || !(rowLabel in anno)) { return '<NA>'; }
      return anno[rowLabel];
    }), undefined, interpolation.indexOf('step') == 0);

  var linesGroup = this._svg.selectAll('.lines');

  if (linesGroup.empty()) {
    linesGroup = this._svg.append('g')
      .attr('class', 'lines items');

    var selectedGroup = linesGroup.append('g').attr('class', 'selected');
    linesGroup.append('g').attr('class', 'hovered');
    selectedGroup.append('g').attr('class', 'hovered');
  }
  linesGroup
    .attr('transform', 'translate(' + this.margins().left() + ', ' + this.margins().top() + ')');
  return this._drawLines(range, data, xScale);
}

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {function} xScale D3 linear scale
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.StackedLinePlot.prototype._drawLines = function(range, data, xScale) {
  var Axis = epiviz.ui.charts.Axis;

  /** @type {epiviz.ui.charts.ColorPalette} */
  var colors = this.colors();

  var interpolation = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.INTERPOLATION];

  var colLabel = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.COL_LABEL];

  /** @type {string} */
  var offset = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.OFFSET];

  /** @type {boolean} */
  var scaleToPercent = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.SCALE_TO_PERCENT];

  var hoverOpacity = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.HOVER_OPACITY];
  
  var self = this;

  var graph = this._svg.select('.lines');

  var firstGlobalIndex = data.firstSeries().globalStartIndex();
  var lastGlobalIndex = data.firstSeries().globalEndIndex();

  data.foreach(function(measurement, series) {
    var firstIndex = series.globalStartIndex();
    var lastIndex = series.globalEndIndex();

    if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
  });

  var nEntries = lastGlobalIndex - firstGlobalIndex;

  // TODO: This might not be needed anymore
  // TODO: Search for all usages of this method
  var dataHasGenomicLocation = epiviz.measurements.Measurement.Type.isOrdered(this.measurements().first().type());
  var firstIndex, lastIndex;
  for (var i = 0; i < nEntries; ++i) {
    var globalIndex = i + firstGlobalIndex;
    var item = data.firstSeries().getRowByGlobalIndex(globalIndex);
    if (!item) { continue; }
    if (!dataHasGenomicLocation ||
      (range.start() == undefined || range.end() == undefined) ||
      item.start() < range.end() && item.end() >= range.start()) {
      if (firstIndex == undefined) { firstIndex = globalIndex; }
      lastIndex = globalIndex + 1;
    }
  }

  firstGlobalIndex = firstIndex;
  lastGlobalIndex = lastIndex;
  nEntries = lastIndex - firstIndex;
  var indices = epiviz.utils.range(nEntries, firstGlobalIndex);

  if (indices.length == 0) { return []; }

  /** @type {epiviz.measurements.MeasurementHashtable.<number>} */
  var msSums = null;
  if (scaleToPercent) {
    msSums = new epiviz.measurements.MeasurementHashtable();

    data.measurements().forEach(function(m) {
      var sum = indices
        .filter(function(i) {
          return data.getByGlobalIndex(m, i); // filter out undefined items
        })
        .map(function(i) { return data.getByGlobalIndex(m, i).value; })
        .reduce(function(v1, v2) { return v1 + v2; });
      msSums.put(m, sum);
    });
  }

  /**
   * @param {epiviz.datatypes.GenomicData.RowItem} row
   * @returns {string|number}
   */
  var colorBy = function(row) {
    return self._globalIndexColorLabels ? self._globalIndexColorLabels[row.globalIndex()] : row.metadata(colLabel);
  };

  var valuesForIndex = function(index) {
    var ret = [];
    if (interpolation == 'step-before') {
      ret.push({ x: 0, y: 0 })
    }
    var ms = data.measurements();
    ret = ret.concat(ms.map(function(m, i) {
      var div = scaleToPercent ? msSums.get(m) : 1;
      div = div || 1; // Prevent division by 0
      var item = data.getByGlobalIndex(m, index);
      return { x: ret.length + i, y: item ? item.value / div : null };
    }));

    if (interpolation == 'step-after') {
      ret.push({ x: ret.length, y: 0 });
    }
    return ret.filter(function(o) {
      return o.y !== null;
    });
  };

  var lineItems;

  lineItems = indices
    .filter(function(index) { return data.firstSeries().getRowByGlobalIndex(index); })
    .map(function(index) {
    var rowItem = data.firstSeries().getRowByGlobalIndex(index);
    var measurements = data.measurements();
    return new epiviz.ui.charts.ChartObject(
      sprintf('line-series-%s', index),
      rowItem.start(),
      rowItem.end(),
      valuesForIndex(index),
      index,
      measurements.map(function(m, i) { return [data.getByGlobalIndex(m, index)]; }), // valueItems one for each measurement
      measurements, // measurements
      '');
  });

  var seriesAreas = indices.map(function(index) { return valuesForIndex(index); });
  var stack = d3.layout.stack().offset(offset);
  var layers = stack(seriesAreas);

  var yScale = d3.scale.linear()
    .domain([
      Math.min(0, d3.min(layers, function(layer) { return d3.min(layer, function(d) { return d.y0 + d.y; }); })),
      d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y0 + d.y; }); })])
    .range([this.height() - this.margins().sumAxis(Axis.Y), 0]);

  var area = d3.svg.area()
    .x(function(d) { return xScale(d.x); })
    .y0(function(d) { return yScale(d.y0); })
    .y1(function(d) { return yScale(d.y0 + d.y); })
    .interpolate(interpolation);

  var lines = graph
    .selectAll('.line-series')
    .data(lineItems, function(d) { return d.seriesIndex; });

  lines.enter()
    .insert('path', ':first-child').attr('class', 'line-series item')
    .attr('d', function(d, i) { return area(layers[i]); })
    .style('opacity', '0')
    .style('shape-rendering', 'auto')
    .style('fill', function(d, i) { return colors.getByKey(colorBy(data.firstSeries().getRowByGlobalIndex(d.seriesIndex))); })
    .on('mouseover', function(d, i) {
      self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));

      graph.selectAll(".item")
      .style("opacity", 1 - hoverOpacity);

      graph.selectAll(".hovered .item")
      .style("opacity", hoverOpacity);

    })
    .on('mouseout', function () {
      self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));



    });

  lines
    .transition()
    .duration(500)
    .style('opacity', '0.7')
    .attr('d', function(d, i) { return area(layers[i]); })
    .style('fill', function(d, i) { return colors.getByKey(colorBy(data.firstSeries().getRowByGlobalIndex(d.seriesIndex))); });

  lines
    .exit()
    .transition()
    .duration(500)
    .style('opacity', '0')
    .remove();

  // Draw legend
  var title = '';

  var labels = {};
  indices.forEach(function(index) {
    if (!data.firstSeries().getByGlobalIndex(index)) { return; }
    var label = colorBy(data.firstSeries().getRowByGlobalIndex(index));
    labels[label] = label;
  });

  this._svg.selectAll('.chart-title').remove();
  this._svg.selectAll('.chart-title-color ').remove();
  var titleEntries = this._svg
    .selectAll('.chart-title')
    .data(Object.keys(labels));
  titleEntries
    .enter()
    .append('text')
    .attr('class', 'chart-title')
    .attr('font-weight', 'bold')
    .attr('y', self.margins().top() - 5);
  titleEntries
    .attr('fill', function(label) { return colors.getByKey(label); })
    .text(function(label) { return label; });
  var textLength = 0;
  var titleEntriesStartPosition = [];

  $('#' + this.id() + ' .chart-title')
    .each(function(i) {
      titleEntriesStartPosition.push(textLength);
      textLength += this.getBBox().width + 15;
    });

  titleEntries.attr('x', function(column, i) {
    return self.margins().left() + 10 + titleEntriesStartPosition[i];
  });

  var colorEntries = this._svg
    .selectAll('.chart-title-color')
    .data(Object.keys(labels))
    .enter()
    .append('circle')
    .attr('class', 'chart-title-color')
    .attr('cx', function(column, i) { return self.margins().left() + 4 + titleEntriesStartPosition[i]; })
    .attr('cy', self.margins().top() - 9)
    .attr('r', 4)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .attr('fill', function(label) { return colors.getByKey(label); });

  return lineItems;
};

/**
 * @returns {Array.<string>}
 */
epiviz.plugins.charts.StackedLinePlot.prototype.colorLabels = function() {
  var labels = [];
  for (var i = 0; i < this.colors().size() && i < 20; ++i) {
    labels.push('Color ' + (i + 1));
  }
  return labels;
};


epiviz.plugins.charts.StackedLinePlot.prototype.doHover = function(selectedObject) {

    var hoverOpacity = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.HOVER_OPACITY];


  var itemsGroup = this._container.find('.items');
  var unselectedHoveredGroup = itemsGroup.find('> .hovered');
  var selectedGroup = itemsGroup.find('> .selected');
  var selectedHoveredGroup = selectedGroup.find('> .hovered');

  var filter = function() {
    return selectedObject.overlapsWith(d3.select(this).data()[0]);
  };
  var selectItems = itemsGroup.find('> .item').filter(filter);
  unselectedHoveredGroup.append(selectItems);

  selectItems = selectedGroup.find('> .item').filter(filter);
  selectedHoveredGroup.append(selectItems);

        this._svg.selectAll(".item")
      .style("opacity", 1 - hoverOpacity);

      this._svg.selectAll(".hovered .item")
      .style("opacity", hoverOpacity);
};

/**
 */
epiviz.plugins.charts.StackedLinePlot.prototype.doUnhover = function() {

    var hoverOpacity = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.HOVER_OPACITY];


  var itemsGroup = this._container.find('.items');
  var unselectedHoveredGroup = itemsGroup.find('> .hovered');
  var selectedGroup = itemsGroup.find('> .selected');
  var selectedHoveredGroup = selectedGroup.find('> .hovered');

  itemsGroup.prepend(unselectedHoveredGroup.children());

  selectedGroup.prepend(selectedHoveredGroup.children());

        this._svg.selectAll(".item")
      .style("opacity", 1);

      this._svg.selectAll(".hovered .item")
      .style("opacity", 1);
};

// goog.inherits(epiviz.plugins.charts.StackedLinePlot, epiviz.ui.charts.Plot);

// Input 67
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/2/2015
 * Time: 4:43 PM
 */

goog.provide('epiviz.plugins.charts.StackedLinePlotType');

goog.require('epiviz.plugins.charts.StackedLinePlot');
goog.require('epiviz.ui.charts.PlotType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.PlotType}
 * @constructor
 */
epiviz.plugins.charts.StackedLinePlotType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.PlotType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.StackedLinePlotType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.PlotType.prototype);
epiviz.plugins.charts.StackedLinePlotType.constructor = epiviz.plugins.charts.StackedLinePlotType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.StackedLinePlot}
 */
epiviz.plugins.charts.StackedLinePlotType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.StackedLinePlot(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.StackedLinePlotType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.StackedLinePlot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.StackedLinePlotType.prototype.chartName = function() {
  return 'Stacked Plot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.StackedLinePlotType.prototype.chartHtmlAttributeName = function() {
  return 'stacked-line-plot';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.StackedLinePlotType.prototype.measurementsFilter = function() { return function(m) { return m.type() == epiviz.measurements.Measurement.Type.FEATURE; }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.plugins.charts.StackedLinePlotType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.StackedLinePlotType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.PlotType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.COL_LABEL,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_METADATA,
      'colLabel',
      'Color by'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_ANNOTATION,
      'name',
      'Labels'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLinePlotType.CustomSettings.OFFSET,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'zero',
      'Offset',
      ['zero', 'wiggle']),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLinePlotType.CustomSettings.INTERPOLATION,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'step-after',
      'Interpolation',
      ['linear', 'step-before', 'step-after', 'basis', 'basis-open', 'basis-closed', 'bundle', 'cardinal', 'cardinal-open', 'monotone']),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLinePlotType.CustomSettings.SCALE_TO_PERCENT,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      true,
      'Scale to Percent'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLinePlotType.CustomSettings.USE_GROUP_BY,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      false,
      'Use Group by'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLinePlotType.CustomSettings.ROW_GROUP_BY,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_ANNOTATION,
      'name',
      'Group By'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLinePlotType.CustomSettings.HOVER_OPACITY,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      0.6,
      'Hover Opacity')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.StackedLinePlotType.CustomSettings = {
  INTERPOLATION: 'interpolation',
  OFFSET: 'offset',
  SCALE_TO_PERCENT: 'scaleToPercent',
  ROW_GROUP_BY: 'groupBy',
  USE_GROUP_BY: 'useGroupBy',
  HOVER_OPACITY: 'hoverOpacity'
};

// goog.inherits(epiviz.plugins.charts.StackedLinePlotType, epiviz.ui.charts.PlotType);

// Input 68
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/1/2014
 * Time: 6:52 PM
 */

goog.provide('epiviz.ui.charts.DataStructureVisualizationType');

goog.require('epiviz.ui.charts.VisualizationType');


/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.VisualizationType}
 * @constructor
 */
epiviz.ui.charts.DataStructureVisualizationType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.VisualizationType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.DataStructureVisualizationType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.VisualizationType.prototype);
epiviz.ui.charts.DataStructureVisualizationType.constructor = epiviz.ui.charts.DataStructureVisualizationType;

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.DataStructureVisualizationType.prototype.chartDisplayType = function() { return epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE; };

/**
 * @returns {string}
 */
epiviz.ui.charts.DataStructureVisualizationType.prototype.cssClass = function() {
  return 'data-structure-container ui-widget-content';
};

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.ui.charts.DataStructureVisualizationType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.DataStructureVisualizationType.prototype.hasMeasurements = function() { return false; };


epiviz.ui.charts.DataStructureVisualizationType.prototype.customSettingsDefs = function() {
  var defs = epiviz.ui.charts.VisualizationType.prototype.customSettingsDefs.call(this);
  return defs;
};
// Input 69
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/22/2014
 * Time: 12:56 PM
 */

goog.provide('epiviz.ui.charts.tree.IcicleType');

goog.require('epiviz.ui.charts.DataStructureVisualizationType');
goog.require('epiviz.ui.charts.CustomSetting');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.tree.HierarchyVisualizationType}
 * @constructor
 */
epiviz.ui.charts.tree.IcicleType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.DataStructureVisualizationType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.tree.IcicleType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.tree.HierarchyVisualizationType.prototype);
epiviz.ui.charts.tree.IcicleType.constructor = epiviz.ui.charts.tree.IcicleType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.ui.charts.tree.Icicle}
 */
epiviz.ui.charts.tree.IcicleType.prototype.createNew = function(id, container, properties) {
  return new epiviz.ui.charts.tree.Icicle(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.ui.charts.tree.IcicleType.prototype.typeName = function() {
  return 'epiviz.ui.charts.tree.Icicle';
};

/**
 * @returns {string}
 */
epiviz.ui.charts.tree.IcicleType.prototype.chartName = function() {
  return 'Icicle';
};

/**
 * @returns {string}
 */
epiviz.ui.charts.tree.IcicleType.prototype.chartHtmlAttributeName = function() {
  return 'icicle';
};

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.ui.charts.tree.IcicleType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.DataStructureVisualizationType.prototype.customSettingsDefs.call(this).concat([

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.tree.IcicleType.CustomSettings.HOVER_OPACITY,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      0.9,
      'Hover Opacity'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.tree.IcicleType.CustomSettings.AGG_LEVEL,
      epiviz.ui.charts.CustomSetting.Type.STRING,
      '',
      'Agg Level'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.tree.IcicleType.CustomSettings.NODE_SEL,
      epiviz.ui.charts.CustomSetting.Type.STRING,
      '{}',
      'Node Selection')
  ]);
};

/**
 * @enum {string}
 */
epiviz.ui.charts.tree.IcicleType.CustomSettings = {
  HOVER_OPACITY: 'hoverOpacity',
  AGG_LEVEL: 'aggLevel',
  NODE_SEL: 'nodeSel'
};

// Input 70
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/25/14
 * Time: 2:03 PM
 */

goog.provide('epiviz.ui.charts.ChartIndexObject');

goog.require('epiviz.ui.charts.VisObject');
/**
 * A struct for various objects in visualizations, like blocks, genes or circles in scatter plots
 * @param {string} id
 * @param {number} start
 * @param {number} end
 * @param {?Array.<number>} [values] One for each measurement
 * @param {number} [seriesIndex]
 * @param {Array.<Array.<epiviz.datatypes.GenomicData.ValueItem>>} [valueItems] For each measurement, an array of value items
 * @param {Array.<epiviz.measurements.Measurement>} [measurements]
 * @param {string} [cssClasses]
 * @constructor
 * @struct
 * @extends {epiviz.ui.charts.VisObject}
 */
epiviz.ui.charts.ChartIndexObject = function(id, keys, keyValues, values, valueItems, measurements, seriesIndex, cssClasses) {
    epiviz.ui.charts.VisObject.call(this);

    this.id = id;

    // Array
    this.keys = keys;

    // Array - made of [keys]
    this.keyValues = keyValues;

    // array [x, y]
    this.values = values;

    // number
    this.seriesIndex = seriesIndex;

    // array [actual dataX and dataY items]
    this.valueItems = valueItems;

    // [dimx, dimY]
    this.measurements = measurements;
    this.cssClasses = cssClasses;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.ChartIndexObject.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.VisObject.prototype);
epiviz.ui.charts.ChartIndexObject.constructor = epiviz.ui.charts.ChartIndexObject;

epiviz.ui.charts.ChartIndexObject.prototype.getMetadata = function(i, j, metadataCol) {
    if (this.valueItems) {
        return this.valueItems[i][j][metadataCol];
    }

    return null;
};

epiviz.ui.charts.ChartIndexObject.prototype.metadataColumns = function() {
    return this.keys;
};

epiviz.ui.charts.ChartIndexObject.prototype.dimensions = function() {
    return [1, 1];
};
// Input 71
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 11:55 PM
 */

goog.provide('epiviz.plugins.charts.DiversityScatterPlot');

goog.require('epiviz.ui.charts.Plot');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.ui.charts.Visualization');
goog.require('epiviz.utils');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.ChartIndexObject');
goog.require('epiviz.deferred.Deferred');


/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Plot}
 * @constructor
 */
epiviz.plugins.charts.DiversityScatterPlot = function(id, container, properties) {
    // Call superclass constructor
    epiviz.ui.charts.Plot.call(this, id, container, properties);

    this._dispatch = d3.dispatch("hover", "click");

    /**
     * D3 chart container
     * @type {*}
     * @private
     */
    this._chartContent = null;

    /**
     * D3 legend container
     * @type {*}
     * @private
     */
    this._legend = null;

    /**
     * @type {Array.<epiviz.measurements.Measurement>}
     * @private
     */
    this._measurementsX = [];

    /**
     * @type {Array.<epiviz.measurements.Measurement>}
     * @private
     */
    this._measurementsY = [];

    var self = this;
    this.measurements().foreach(function(m, i) {
        if (i % 2 == 0) { self._measurementsX.push(m); } else { self._measurementsY.push(m); }
    });

    /**
     * @type {string}
     * @private
     */
    this._xLabel = '';

    /**
     * @type {string}
     * @private
     */
    this._yLabel = '';

    for (var i = 0; i < Math.min(this._measurementsX.length, this._measurementsY.length); ++i) {
        if (i > 0) {
            this._xLabel += ', ';
            this._yLabel += ', ';
        }
        this._xLabel += this._measurementsX[i].name();
        this._yLabel += this._measurementsY[i].name();
    }

    /**
     * @type {Array.<string>}
     * @private
     */
    this._colorLabels = [];

    this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.DiversityScatterPlot.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Plot.prototype);
epiviz.plugins.charts.DiversityScatterPlot.constructor = epiviz.plugins.charts.DiversityScatterPlot;

/**
 * @protected
 */
epiviz.plugins.charts.DiversityScatterPlot.prototype._initialize = function() {
    // Call super
    epiviz.ui.charts.Plot.prototype._initialize.call(this);

    this._svg.classed('scatter-plot', true);

    this._chartContent = this._svg.append('g').attr('class', 'chart-content');
    this._legend = this._svg.append('g').attr('class', 'chart-legend');
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */

epiviz.plugins.charts.DiversityScatterPlot.prototype.draw = function() {
    epiviz.ui.charts.Plot.prototype.draw.call(this, undefined, undefined);
    var self = this;

    self.drawScatter(self._lastRange, self._lastData.data, "sample_id", self._xLabel, "alphaDiversity");
};

epiviz.plugins.charts.DiversityScatterPlot.prototype.drawScatter = function(range, data, key, dimx, dimy) {

    // epiviz.ui.charts.Plot.prototype.draw.call(this, range, data);

    // If data is defined, then the base class sets this._lastData to data.
    // If it isn't, then we'll use the data from the last draw call
    // data = this._lastData;
    //range = this._lastRange;

    // If data is not defined, there is nothing to draw
    // if (!data || !range) {
    //     return [];
    // }

    // group data by keys

    // var keysList = Objects.keys(tempData);

    // var groupData = d3.nest().key(function(d) { return d[key]; }).entries(data);

    // collapse data points -> dataX, dataY (assume same length dataX, and dataY)

    // joint dataX, dataY on common keys -> data (array of objects)

    this.xTag = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL];
    // if (this.xTag == "name"){
    //     var keys = Object.keys(data[0]);
    //     for(k = 0; k < keys.length; k++){
    //         var key = keys[k];
    //         var values = data.map(function(i) {return i[key];});
    //         if (values.length > 2){
    //             this.xTag = key;
    //             break;
    //         }
    //     }
    // }
    var old_x_axis = this._measurementsX[0];
    var tempAnnotation = old_x_axis.annotation();
    this._measurementsX = [];
    var new_x_axis = new epiviz.measurements.Measurement(this.xTag, this.xTag, 'feature', 'ihmp', 'ihmp',
                                           'ihmp', null, null, tempAnnotation,
                                           -1, 1,[]);
    this._measurementsX.push(new_x_axis);
    return this._drawCircles(data, this.xTag, dimy, key);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.DiversityScatterPlot.prototype._drawCircles = function(data, dimx, dimy, key) {
    var self = this;
    var Axis = epiviz.ui.charts.Axis;
    var circleRadius = Math.max(1, this.customSettingsValues()[epiviz.plugins.charts.DiversityScatterPlotType.CustomSettings.CIRCLE_RADIUS_RATIO] * Math.min(this.width(), this.height()));
    var gridSquareSize = Math.max(Math.floor(circleRadius), 1);
    // var nSeries = Math.min(this._measurementsX.length, this._measurementsY.length);

    // var firstGlobalIndex = data.firstSeries().globalStartIndex();
    // var lastGlobalIndex = data.firstSeries().globalEndIndex();
    // data.foreach(function(measurement, series) {

    //     var firstIndex = series.globalStartIndex();
    //     var lastIndex = series.globalEndIndex();

    //     if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    //     if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
    // });

    // var nItems = lastGlobalIndex - firstGlobalIndex;

    var margins = this.margins();
    var width = this.width();
    var height = this.height();

    var CustomSetting = epiviz.ui.charts.CustomSetting;
    var minY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MIN];
    var maxY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MAX];
    var minX = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.X_MIN];
    var maxX = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.X_MAX];

    // if (minX == CustomSetting.DEFAULT) { minX = this._measurementsX[0].minValue(); }
    if (minY == CustomSetting.DEFAULT) { minY = this._measurementsY[0].minValue(); }
    // if (maxX == CustomSetting.DEFAULT) { maxX = this._measurementsX[0].maxValue(); }
    if (maxY == CustomSetting.DEFAULT) { maxY = this._measurementsY[0].maxValue(); }



    var allValues = []
    data.forEach(function(m) { allValues.push(m[dimx]);});

    var uniqueValues = [];

    allValues.forEach(function(m) {
        if(uniqueValues.indexOf(m) == -1) {
            uniqueValues.push(m);
        }
    });

    console.log(uniqueValues);
    this.xTickValues = uniqueValues;
    data.forEach(function(n) {
        var index = uniqueValues.indexOf(n[dimx]);
        n._xVal = index+1;
    } );

    var count= 0;
    var plotData = [];
    uniqueValues.forEach(function(m) {
        plotData[count] = [];
        plotData[count][0] = count;
        plotData[count][1] = [];
        count++;
    });

    data.forEach(function(d) {
        var ind = uniqueValues.indexOf(d[dimx]);

        plotData[ind][1].push(d[dimy]);
    });

    if (minX == CustomSetting.DEFAULT) {
        minX = 0;
    }
    if (maxX == CustomSetting.DEFAULT) {
        maxX = uniqueValues.length+1;
    }
    
    // if (minY == CustomSetting.DEFAULT) {
    //     minY = d3.min(data, function(d) {
    //         return d[dimy];
    //     });
    // }
    // if (maxY == CustomSetting.DEFAULT) {
    //     maxY = d3.max(data, function(d) {
    //         return d[dimy];
    //     });
    // }

    // var dataHasGenomicLocation = epiviz.measurements.Measurement.Type.isOrdered(this._measurementsX[0].type());

    var xScale = d3.scale.linear()
        .domain([minX, maxX])
        .range([0, width - margins.sumAxis(Axis.X)]);
    var yScale = d3.scale.linear()
        .domain([minY, maxY])
        .range([height - margins.sumAxis(Axis.Y), 0]);

    this._clearAxes(this._chartContent);
    //this._drawAxes(xScale, yScale, 15, 15, this._chartContent);
    //this._drawAxes(xScale, yScale, uniqueValues.length, 15, this._chartContent);
    //this._drawAxes(xScale, yScale, xTicks, yTicks, svg, width, height, margins, undefined, undefined,this.xTickValues, undefined, undefined)
    xLabelsPadded = [""];
    uniqueValues.forEach(function(n) {xLabelsPadded.push(n);});
    console.log(xLabelsPadded);
    this._drawAxes(xScale, yScale, xLabelsPadded.length, 15, this._chartContent, width, height, margins, undefined, undefined,xLabelsPadded, undefined, undefined)

    // var i, index;
    // var indices = []; //epiviz.utils.range(nSeries * nItems);
    // for (i = 0; i < nItems; ++i) {
    //     index = i + firstGlobalIndex;
    //     var item = data.getSeries(this._measurementsX[0]).getRowByGlobalIndex(index);
    //     if (!item) {
    //         continue;
    //     }
    //     if (!dataHasGenomicLocation ||
    //         (range.start() == undefined || range.end() == undefined) ||
    //         (item.start() < range.end() && item.end() > range.start())) {

    //         for (var j = 0; j < nSeries; ++j) {
    //             indices.push(j * nItems + i);
    //         }
    //     }
    // }

    // var grid = {};
    // var items = [];
    // var maxGroupItems = 1;
    // for (i = 0; i < indices.length; ++i) {
    //     index = indices[i] % nItems;
    //     var globalIndex = index + firstGlobalIndex;
    //     var seriesIndex = Math.floor(indices[i] / nItems);
    //     var mX = self._measurementsX[seriesIndex];
    //     var mY = self._measurementsY[seriesIndex];
    //     var cellX = data.getSeries(mX).getByGlobalIndex(globalIndex);
    //     var cellY = data.getSeries(mY).getByGlobalIndex(globalIndex);

    //     if (!cellX || !cellY) {
    //         continue;
    //     }

    //     var classes = sprintf('item data-series-%s', seriesIndex);

    //     var x = xScale(cellX.value);
    //     var y = yScale(cellY.value);
    //     var gridX = Math.floor(x / gridSquareSize) * gridSquareSize;
    //     var gridY = Math.floor(y / gridSquareSize) * gridSquareSize;

    //     var uiObj = null;
    //     if (grid[gridY] && grid[gridY][gridX]) {
    //         uiObj = grid[gridY][gridX];
    //         uiObj.id += '_' + cellX.globalIndex;
    //         uiObj.start = Math.min(uiObj.start, cellX.rowItem.start());
    //         uiObj.end = Math.max(uiObj.end, cellX.rowItem.end());
    //         uiObj.values[0] = (uiObj.values[0] * uiObj.valueItems[0].length + cellX.value) / (uiObj.valueItems[0].length + 1);
    //         uiObj.values[1] = (uiObj.values[1] * uiObj.valueItems[1].length + cellY.value) / (uiObj.valueItems[1].length + 1);
    //         uiObj.valueItems[0].push(cellX);
    //         uiObj.valueItems[1].push(cellY);

    //         if (uiObj.valueItems[0].length > maxGroupItems) {
    //             maxGroupItems = uiObj.valueItems[0].length;
    //         }

    //         continue;
    //     }


    //     uiObj = new epiviz.ui.charts.ChartObject(
    //         sprintf('scatter_%s_%s', seriesIndex, cellX.globalIndex),
    //         cellX.rowItem.start(),
    //         cellX.rowItem.end(), [cellX.value, cellY.value],
    //         seriesIndex, [
    //             [cellX],
    //             [cellY]
    //         ], // valueItems one for each measurement
    //         [mX, mY], // measurements
    //         classes);

    //     if (!grid[gridY]) { grid[gridY] = {}; }
    //     grid[gridY][gridX] = uiObj;

    //     items.push(uiObj);
    // }





    var grid = {};
    var items = [];
    var maxGroupItems = 1;
    var seriesIndex = 0; // Assume only 1 pair of datax and datay
    for (var i = 0; i < data.length; ++i) {

        console.log(data[i]);
        //index = indices[i] % nItems;
        //var globalIndex = index + firstGlobalIndex;
        //var seriesIndex = Math.floor(indices[i] / nItems);
        //var mX = self._measurementsX[seriesIndex];
        //var mY = self._measurementsY[seriesIndex];
        //var cellX = data.getSeries(mX).getByGlobalIndex(globalIndex);
        //var cellY = data.getSeries(mY).getByGlobalIndex(globalIndex);
        var cellX = data[i]["_xVal"];
        var cellY = data[i][dimy];
        if (!cellX || !cellY) {
            continue;
        }

        var classes = sprintf('item data-series-%s', seriesIndex);

        var x = xScale(cellX);
        var y = yScale(cellY);

        var gridX = Math.floor(x / gridSquareSize) * gridSquareSize;
        var gridY = Math.floor(y / gridSquareSize) * gridSquareSize;

        var uiObj = null;
        if (grid[gridY] && grid[gridY][gridX]) {
            uiObj = grid[gridY][gridX];
            uiObj.id += '_' + data[i][key];
            uiObj.values[0] = (uiObj.values[0] * uiObj.valueItems[0].length + cellX) / (uiObj.valueItems[0].length + 1);
            uiObj.values[1] = (uiObj.values[1] * uiObj.valueItems[1].length + cellY) / (uiObj.valueItems[1].length + 1);
            uiObj.valueItems[0].push(data[i]);
            uiObj.valueItems[1].push(data[i]);
            if (uiObj.valueItems[0].length > maxGroupItems) {
                maxGroupItems = uiObj.valueItems[0].length;
            }
            continue;
        }

        uiObj = new epiviz.ui.charts.ChartIndexObject(
            sprintf('scatter_%s_%s_%s_%s', cellX, cellY, seriesIndex, data[i][key]), [key],
            data[i][key], [cellX, cellY], [
                [data[i]],
                [data[i]]
            ], // valueItems one for each measurement
            ["_xVal", dimy], // measurements
            seriesIndex,
            classes);

        if (!grid[gridY]) { grid[gridY] = {}; }
        grid[gridY][gridX] = uiObj;

        items.push(uiObj);
    }

    console.log("after loop");


    var itemsGroup = this._chartContent.select('.items');

    if (itemsGroup.empty()) {
        itemsGroup = this._chartContent.append('g').attr('class', 'items');
        var selectedGroup = itemsGroup.append('g').attr('class', 'selected');
        itemsGroup.append('g').attr('class', 'hovered');
        selectedGroup.append('g').attr('class', 'hovered');
    }



    var selection = itemsGroup.selectAll('circle').data(items, function(d) {
        return d.id;
    });

    // selection
    //     .enter()
    //     .insert('circle', ':first-child')
    //     .attr('id', function(d) {
    //         return sprintf('%s-item-%s-%s', self.id(), d.seriesIndex, d.valueItems[0][0].globalIndex);
    //     })
    //     .style('opacity', 0)
    //     .style('fill-opacity', 0)
    //     .attr('r', 0);
    // selection
    //     .each(
    //         /**
    //          * @param {epiviz.ui.charts.ChartObject} d
    //          */
    //         function(d) {
    //             var circle = d3.select(this);

    //             var fill;
    //             if (!self._globalIndexColorLabels) { fill = self.colors().get(d.seriesIndex); } else {
    //                 fill = self.colors().getByKey(self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]);
    //             }
    //             circle
    //                 .attr('cx', margins.left() + (d.values[0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    //                 .attr('cy', height - margins.bottom() - ((d.values[1] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
    //                 .attr('class', d.cssClasses)
    //                 .style('fill', fill);
    //         });

    selection
        .enter()
        .insert('circle', ':first-child')
        .attr('id', function(d) {
            return sprintf('%s-item-%s', self.id(), d.seriesIndex);
        })
        .style('opacity', 0)
        .style('fill-opacity', 0)
        .attr('r', 0);
    selection
        .each(
            /**
             * @param {epiviz.ui.charts.ChartObject} d
             */
            function(d) {
                var circle = d3.select(this);

                var fill = self.colors().get(d.seriesIndex);
                // if (!self._globalIndexColorLabels) { fill = self.colors().get(d.seriesIndex); } else {
                //     fill = self.colors().getByKey(self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]);
                // }
                circle
                    .attr('cx', margins.left() + (d.values[0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
                    .attr('cy', height - margins.bottom() - ((d.values[1] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
                    .attr('class', d.cssClasses)
                    .style('fill', fill);
            });


    selection
        .transition()
        .duration(1000)
        .style('fill-opacity', function(d) {
            //return Math.max(0.3, d.valueItems[0].length / maxGroupItems);
            return Math.max(0.6, d.valueItems[0].length / maxGroupItems);
        })
        .style('opacity', null)
        .attr('r', circleRadius);

    selection
        .exit()
        .transition()
        .duration(1000)
        .style('opacity', 0)
        .attr('r', 0)
        .remove();

    selection
        //.on('mouseover', function(d) {
        //    console.log("mouseover");
        //    console.log(d);
        //    self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
        //    self._dispatch.hover(self.id(), d);
        //})
        //.on('mouseout', function() {
        //    self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
        //    self._dispatch.hover(self.id(), null);
        //
        //})
        .on('click', function(d) {
            console.log("click");
            console.log(d);
            self._deselect.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
            self._select.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
            self._dispatch.click(self.id(), null);

            d3.event.stopPropagation();
        });

    // Draw legend if necessary
    if (this._globalIndexColorLabels) {
        var colorLabelsMap = {};
        for (j = firstGlobalIndex; j < lastGlobalIndex; ++j) {
            colorLabelsMap[this._globalIndexColorLabels[j]] = this._globalIndexColorLabels[j];
        }
        this._colorLabels = Object.keys(colorLabelsMap);

        this._svg.selectAll('.chart-title').remove();
        this._svg.selectAll('.chart-title-color ').remove();
        var titleEntries = this._svg
            .selectAll('.chart-title')
            .data(this._colorLabels);
        titleEntries
            .enter()
            .append('text')
            .attr('class', 'chart-title')
            .attr('font-weight', 'bold')
            .attr('y', self.margins().top() - 5);
        titleEntries
            .attr('fill', function(label, i) {
                return self.colors().getByKey(label);
            })
            .text(function(label) {
                return label;
            });
        var textLength = 0;
        var titleEntriesStartPosition = [];

        $('#' + this.id() + ' .chart-title')
            .each(function(i) {
                titleEntriesStartPosition.push(textLength);
                textLength += this.getBBox().width + 15;
            });

        titleEntries.attr('x', function(column, i) {
            return self.margins().left() + 10 + titleEntriesStartPosition[i];
        });

        var colorEntries = this._svg
            .selectAll('.chart-title-color')
            .data(this._colorLabels)
            .enter()
            .append('circle')
            .attr('class', 'chart-title-color')
            .attr('cx', function(column, i) {
                return self.margins().left() + 4 + titleEntriesStartPosition[i];
            })
            .attr('cy', self.margins().top() - 9)
            .attr('r', 4)
            .style('shape-rendering', 'auto')
            .style('stroke-width', '0')
            .attr('fill', function(label, i) {
                return self.colors().getByKey(label);
            })
            .style('stroke-width', 0)
    } else {
        var n = Math.min(this._measurementsX.length, this._measurementsY.length);
        var colors = new Array(n);

        for (j = 0; j < n; ++j) {
            colors[j] = sprintf('%s vs %s', this._measurementsX[j].name(), this._measurementsY[j].name());
        }

        this._colorLabels = colors;
    }

    var rectBox = itemsGroup;
    
    console.log(uniqueValues);

    rectBox.selectAll('.iqr-range').remove();
    rectBox.selectAll('.whisker').remove();
    for(i = 0; i < plotData.length; i++){
        var findIQR = plotData[i][1];
        console.log(findIQR);
        var lower_upper = [];
        lower_upper = quartiles(findIQR);
        console.log(lower_upper);  
        
        var iqr_result = lower_upper[1] - lower_upper[0];
        var iqr_15 = iqr_result * 1.5;

        var whisker_lower_index = 0;
        var whisker_upper_index = findIQR.length-1;
        for(j = 0; j < findIQR.length; j++){
            if(findIQR[j] < lower_upper[0] - iqr_15) {
                whisker_lower_index = j;
            }
            else {
                break;
            }
        }
        for(k = findIQR.length-1; k > 0; k--){
            if(findIQR[k] > (lower_upper[1] + iqr_15)) {
                whisker_upper_index = k;
            }
            else {
                break;
            }
        }
    rectBox.append("rect")
    //.attr('id', function(d) {console.log(d[0]); return d[0];})
    .attr('id', "0")
    .attr('class', 'iqr-range')
    .style('opacity', 1)
    .style('fill-opacity', 0.2)
    //.attr('x', xScale(.6))
    //.attr('y', yScale(1-.2))
    .attr('x', margins.left() + (0.6 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y', height - margins.bottom() - ((lower_upper[1] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
    //.attr('y', function(d) { d = plotData[i]; console.log(d[1][0]); return height + 2*(margins._bottom) - margins._top - yScale(.25); })
    .attr('width', xScale(.8))
    .attr('height', Math.abs((yScale(lower_upper[1])-yScale(lower_upper[0]))))
    //.attr('height', Math.abs(((yScale(.3)-yScale(.25)))))
    //.attr('height', lower_upper[1]-lower_upper[0])
    //.attr('height', Math.abs(yScale(.5)))
    .attr('fill', '#1E90FF');


     rectBox.append("line")
    .style("stroke", "gray")
    .attr('class', 'whisker')
    .attr("x1", margins.left() + (1 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y1', height - margins.bottom() - ((lower_upper[1] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
    .attr("x2", margins.left() + (1 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y2', (height - margins.bottom() - ((findIQR[whisker_upper_index] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY))));

    rectBox.append("line")
    .style("stroke", "gray")
    .attr('class', 'whisker')
    .attr("x1", margins.left() + (1 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y1', height - margins.bottom() - ((lower_upper[0] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
    .attr("x2", margins.left() + (1 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y2', (height - margins.bottom() - ((findIQR[whisker_lower_index] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY))));

     rectBox.append("line")
    .style("stroke", "gray")
    .attr('class', 'whisker')
    .attr("x1", margins.left() + (0.6 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y1', height - margins.bottom() - ((findIQR[whisker_upper_index] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
    .attr("x2", margins.left() + (1.4 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y2', (height - margins.bottom() - ((findIQR[whisker_upper_index] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY))));

    rectBox.append("line")
    .style("stroke", "gray")
    .attr('class', 'whisker')
    .attr("x1", margins.left() + (0.6 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y1', height - margins.bottom() - ((findIQR[whisker_lower_index] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
    .attr("x2", margins.left() + (1.4 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y2', (height - margins.bottom() - ((findIQR[whisker_lower_index] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY))));

    }
    // .style('fill', function(d, i) {
    //   if (!self._globalIndexColorLabels) { return self._colorScale(d.values[0]); }
    //   return colorScales[self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]](d.values[0]);
    // });

    function quartiles(d) {
        d.sort(d3.ascending);
        var q1 = d3.quantile(d, .25);
        var q3 = d3.quantile(d, .75);
        return [q1, q3];
    };



    return items;
};



/**
 * @returns {Array.<{name: string, color: string}>}
 */
epiviz.plugins.charts.DiversityScatterPlot.prototype.colorLabels = function() {
    return this._colorLabels;
};

/**
 * @param xScale D3 linear scale for the x axis
 * @param yScale D3 linear scale for the y axis
 * @param {number} [xTicks]
 * @param {number} [yTicks]
 * @param [svg] D3 svg container for the axes
 * @param {number} [width]
 * @param {number} [height]
 * @param {epiviz.ui.charts.Margins} [margins]
 * @protected
 */
epiviz.plugins.charts.DiversityScatterPlot.prototype._drawAxesOld = function(xScale, yScale, xTicks, yTicks, svg, width, height, margins) {
    epiviz.ui.charts.Plot.prototype._drawAxes(xScale, yScale, xTicks, yTicks,
    svg, width, height, margins, undefined, undefined,
    this.xTickValues, undefined, undefined);
    //epiviz.ui.charts.Plot.prototype._drawAxes.call(this, xScale, yScale, xTicks, yTicks, svg, width, height, margins);

    this._legend.selectAll('text').remove();

    var xMeasurements = this._measurementsX;
    var self = this;
    this._legend.selectAll('.x-measurement').remove();
    this._legend.selectAll('.x-measurement-color').remove();

    var xEntries = this._legend
        .selectAll('.x-measurement')
        .data(xMeasurements)
        .enter()
        .append('text')
        .attr('class', 'x-measurement')
        .attr('font-weight', 'bold')
        .attr('fill', function(m, i) {
            return self._globalIndexColorLabels ?
                "#000000" : self.colors().get(i);
        })
        .attr('y', (this.height() - this.margins().bottom() + 35))
        .text(function(m, i) {
            return m.name();
        });

    var xTextLength = 0;
    var xTitleEntriesStartPosition = [];

    $('#' + this.id() + ' .x-measurement')
        .each(function(i) {
            xTitleEntriesStartPosition.push(xTextLength);
            xTextLength += this.getBBox().width + 15;
        });

    xEntries.attr('x', function(column, i) {
        return (self.width() - xTextLength) * 0.5 + 7 + xTitleEntriesStartPosition[i];
    });

    var xColorEntries = this._legend
        .selectAll('.x-measurement-color')
        .data(xMeasurements)
        .enter()
        .append('circle')
        .attr('class', 'x-measurement-color')
        .attr('cx', function(column, i) {
            return (self.width() - xTextLength) * 0.5 + 1 + xTitleEntriesStartPosition[i];
        })
        .attr('cy', (this.height() - this.margins().bottom() + 31))
        .attr('r', 4)
        .style('shape-rendering', 'auto')
        .style('stroke-width', '0')
        .style('fill', function(m, i) {
            return self._globalIndexColorLabels ?
                "#ffffff" : self.colors().get(i);
        });


    var yMeasurements = ['alphaDiversity'];
    this._legend.selectAll('.y-measurement').remove();
    this._legend.selectAll('.y-measurement-color').remove();

    var yEntries = this._legend
        .selectAll('.y-measurement')
        .data(yMeasurements)
        .enter()
        .append('text')
        .attr('class', 'y-measurement')
        .attr('font-weight', 'bold')
        .attr('fill', function(m, i) {
            return self._globalIndexColorLabels ?
                "#000000" : self.colors().get(i);
        })
        .attr('y', (this.margins().left() - 35))
        .attr('transform', 'rotate(-90)')
        .text(function(m, i) {
            return m;
        });

    var yTextLength = 0;
    var yTitleEntriesStartPosition = [];

    $('#' + this.id() + ' .y-measurement')
        .each(function(i) {
            yTitleEntriesStartPosition.push(yTextLength);
            yTextLength += this.getBBox().width + 15;
        });

    yEntries.attr('x', function(column, i) {
        return -self.height() + (self.height() - yTextLength) * 0.5 + 12 + self.margins().top() + yTitleEntriesStartPosition[i];
    });

    var yColorEntries = this._legend
        .selectAll('.y-measurement-color')
        .data(yMeasurements)
        .enter()
        .append('circle')
        .attr('class', 'y-measurement-color')
        .attr('cx', function(column, i) {
            return -self.height() + (self.height() - yTextLength) * 0.5 + 6 + self.margins().top() + yTitleEntriesStartPosition[i];
        })
        .attr('cy', (this.margins().left() - 39))
        .attr('transform', 'rotate(-90)')
        .attr('r', 4)
        .style('shape-rendering', 'auto')
        .style('stroke-width', '0')
        .style('fill', function(m, i) {
            return self._globalIndexColorLabels ?
                "#ffffff" : self.colors().get(i);
        });
};

epiviz.plugins.charts.DiversityScatterPlot.prototype.transformData = function(range, data) {
  var lastRange = this._lastRange;

  if (range != undefined) {
    this._lastRange = range;
  }
  if (data != undefined) {
    this._lastData = data;
    this._unalteredData = data;
  }

  var deferred = new epiviz.deferred.Deferred();
  deferred.resolve();
  return deferred;
};


// goog.inherits(epiviz.plugins.charts.DiversityScatterPlot, epiviz.ui.charts.Plot);

// Input 72
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 11:55 PM
 */

goog.provide('epiviz.plugins.charts.DiversityScatterPlotType');

goog.require('epiviz.plugins.charts.DiversityScatterPlot');
goog.require('epiviz.ui.charts.PlotType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.PlotType}
 * @constructor
 */
epiviz.plugins.charts.DiversityScatterPlotType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.PlotType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.PlotType.prototype);
epiviz.plugins.charts.DiversityScatterPlotType.constructor = epiviz.plugins.charts.DiversityScatterPlotType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.ScatterPlot}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.DiversityScatterPlot(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.DiversityScatterPlot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.chartName = function() {
  return 'Diversity Scatter Plot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.chartHtmlAttributeName = function() {
  return 'diversity_scatter';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.measurementsFilter = function() { return function(m) { return epiviz.measurements.Measurement.Type.hasValues(m.type()); }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * Gets the minimum number of measurements that must be selected for the chart to be displayed
 * @returns {number}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.minSelectedMeasurements = function() { return 2; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.PlotType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.DiversityScatterPlotType.CustomSettings.CIRCLE_RADIUS_RATIO,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      0.015,
      'Circle radius ratio'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_ANNOTATION,
      'name',
      'Row labels'),
      
    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.X_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min X'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.X_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max X'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max Y')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.DiversityScatterPlotType.CustomSettings = {
  CIRCLE_RADIUS_RATIO: 'circleRadiusRatio'
};

// goog.inherits(epiviz.plugins.charts.DiversityScatterPlotType, epiviz.ui.charts.PlotType);

// Input 73
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 11:55 PM
 */

goog.provide('epiviz.plugins.charts.CustomScatterPlot');

goog.require('epiviz.ui.charts.Plot');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.ChartIndexObject');
goog.require('epiviz.deferred.Deferred');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Plot}
 * @constructor
 */
epiviz.plugins.charts.CustomScatterPlot = function(id, container, properties) {
    // Call superclass constructor
    epiviz.ui.charts.Plot.call(this, id, container, properties);

    // this._dispatch = d3.dispatch("hover", "click");

    /**
     * D3 chart container
     * @type {*}
     * @private
     */
    this._chartContent = null;

    /**
     * D3 legend container
     * @type {*}
     * @private
     */
    this._legend = null;

    /**
     * @type {Array.<epiviz.measurements.Measurement>}
     * @private
     */
    this._measurementsX = [];

    /**
     * @type {Array.<epiviz.measurements.Measurement>}
     * @private
     */
    this._measurementsY = [];

    var self = this;
    this.measurements().foreach(function(m, i) {
        if (i % 2 == 0) { self._measurementsX.push(m); } else { self._measurementsY.push(m); }
    });

    /**
     * @type {string}
     * @private
     */
    this._xLabel = '';

    /**
     * @type {string}
     * @private
     */
    this._yLabel = '';

    for (var i = 0; i < Math.min(this._measurementsX.length, this._measurementsY.length); ++i) {
        if (i > 0) {
            this._xLabel += ', ';
            this._yLabel += ', ';
        }
        this._xLabel += this._measurementsX[i].name();
        this._yLabel += this._measurementsY[i].name();
    }

    /**
     * @type {Array.<string>}
     * @private
     */
    this._colorLabels = [];

    this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.CustomScatterPlot.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Plot.prototype);
epiviz.plugins.charts.CustomScatterPlot.constructor = epiviz.plugins.charts.CustomScatterPlot;

/**
 * @protected
 */
epiviz.plugins.charts.CustomScatterPlot.prototype._initialize = function() {
    // Call super
    epiviz.ui.charts.Plot.prototype._initialize.call(this);

    this._svg.classed('scatter-plot', true);

    this._chartContent = this._svg.append('g').attr('class', 'chart-content');
    this._legend = this._svg.append('g').attr('class', 'chart-legend');
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */

epiviz.plugins.charts.CustomScatterPlot.prototype.draw = function() {
    epiviz.ui.charts.Plot.prototype.draw.call(this, undefined, undefined);
    var self = this;
    self._variance_labels = self._lastData.pca_variance_explained;
    // self._variance_labels = [0.9, 0.1];
    self.drawScatter(self._lastRange, self._lastData.data, "sample_id", "PC1", "PC2");
};



epiviz.plugins.charts.CustomScatterPlot.prototype.drawScatter = function(range, data, key, dimx, dimy) {

    // epiviz.ui.charts.Plot.prototype.draw.call(this, range, data);

    // If data is defined, then the base class sets this._lastData to data.
    // If it isn't, then we'll use the data from the last draw call
    // data = this._lastData;
    //range = this._lastRange;

    // If data is not defined, there is nothing to draw
    // if (!data || !range) {
    //     return [];
    // }

    // group data by keys

    // var keysList = Objects.keys(tempData);

    // var groupData = d3.nest().key(function(d) { return d[key]; }).entries(data);

    // collapse data points -> dataX, dataY (assume same length dataX, and dataY)

    // joint dataX, dataY on common keys -> data (array of objects)

    return this._drawCircles(data, dimx, dimy, key);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.CustomScatterPlot.prototype._drawCircles = function(data, dimx, dimy, key) {
    var self = this;
    var Axis = epiviz.ui.charts.Axis;
    var circleRadius = Math.max(1, this.customSettingsValues()[epiviz.plugins.charts.CustomScatterPlotType.CustomSettings.CIRCLE_RADIUS_RATIO] * Math.min(this.width(), this.height()));
    var gridSquareSize = Math.max(Math.floor(circleRadius), 1);
    // var nSeries = Math.min(this._measurementsX.length, this._measurementsY.length);

    // var firstGlobalIndex = data.firstSeries().globalStartIndex();
    // var lastGlobalIndex = data.firstSeries().globalEndIndex();
    // data.foreach(function(measurement, series) {

    //     var firstIndex = series.globalStartIndex();
    //     var lastIndex = series.globalEndIndex();

    //     if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    //     if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
    // });

    // var nItems = lastGlobalIndex - firstGlobalIndex;

    var margins = this.margins();
    var width = this.width();
    var height = this.height();

    var CustomSetting = epiviz.ui.charts.CustomSetting;
    var minY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MIN];
    var maxY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MAX];
    var minX = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.X_MIN];
    var maxX = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.X_MAX];

    var colorbylabel = this.customSettingsValues()[epiviz.plugins.charts.CustomScatterPlotType.CustomSettings.COLOR_BY];

    if (minX == CustomSetting.DEFAULT) { minX = this._measurementsX[0].minValue(); }
    if (minY == CustomSetting.DEFAULT) { minY = this._measurementsY[0].minValue(); }
    if (maxX == CustomSetting.DEFAULT) { maxX = this._measurementsX[0].maxValue(); }
    if (maxY == CustomSetting.DEFAULT) { maxY = this._measurementsY[0].maxValue(); }

    // if (minX == CustomSetting.DEFAULT) {
    //     minX = d3.min(data, function(d) {
    //         return d[dimx];
    //     });
    // }
    // if (minY == CustomSetting.DEFAULT) {
    //     minY = d3.min(data, function(d) {
    //         return d[dimy];
    //     });
    // }
    // if (maxX == CustomSetting.DEFAULT) {
    //     maxX = d3.max(data, function(d) {
    //         return d[dimx];
    //     });
    // }
    // if (maxY == CustomSetting.DEFAULT) {
    //     maxY = d3.max(data, function(d) {
    //         return d[dimy];
    //     });
    // }
    
    // var padding = 2*this.customSettingsValues()[epiviz.plugins.charts.CustomScatterPlotType.CustomSettings.CIRCLE_RADIUS_RATIO];
    // minX = minX - padding;
    // maxX = maxX + padding;
    // minY = minY - padding;
    // maxY = maxY + padding;

    // var dataHasGenomicLocation = epiviz.measurements.Measurement.Type.isOrdered(this._measurementsX[0].type());

    var xScale = d3.scale.linear()
        .domain([minX, maxX])
        .range([0, width - margins.sumAxis(Axis.X)])
        .nice();
    var yScale = d3.scale.linear()
        .domain([minY, maxY])
        .range([height - margins.sumAxis(Axis.Y), 0])
        .nice();

    this._clearAxes(this._chartContent);
    this._drawAxes(xScale, yScale, 15, 15, this._chartContent);

    // var i, index;
    // var indices = []; //epiviz.utils.range(nSeries * nItems);
    // for (i = 0; i < nItems; ++i) {
    //     index = i + firstGlobalIndex;
    //     var item = data.getSeries(this._measurementsX[0]).getRowByGlobalIndex(index);
    //     if (!item) {
    //         continue;
    //     }
    //     if (!dataHasGenomicLocation ||
    //         (range.start() == undefined || range.end() == undefined) ||
    //         (item.start() < range.end() && item.end() > range.start())) {

    //         for (var j = 0; j < nSeries; ++j) {
    //             indices.push(j * nItems + i);
    //         }
    //     }
    // }

    // var grid = {};
    // var items = [];
    // var maxGroupItems = 1;
    // for (i = 0; i < indices.length; ++i) {
    //     index = indices[i] % nItems;
    //     var globalIndex = index + firstGlobalIndex;
    //     var seriesIndex = Math.floor(indices[i] / nItems);
    //     var mX = self._measurementsX[seriesIndex];
    //     var mY = self._measurementsY[seriesIndex];
    //     var cellX = data.getSeries(mX).getByGlobalIndex(globalIndex);
    //     var cellY = data.getSeries(mY).getByGlobalIndex(globalIndex);

    //     if (!cellX || !cellY) {
    //         continue;
    //     }

    //     var classes = sprintf('item data-series-%s', seriesIndex);

    //     var x = xScale(cellX.value);
    //     var y = yScale(cellY.value);
    //     var gridX = Math.floor(x / gridSquareSize) * gridSquareSize;
    //     var gridY = Math.floor(y / gridSquareSize) * gridSquareSize;

    //     var uiObj = null;
    //     if (grid[gridY] && grid[gridY][gridX]) {
    //         uiObj = grid[gridY][gridX];
    //         uiObj.id += '_' + cellX.globalIndex;
    //         uiObj.start = Math.min(uiObj.start, cellX.rowItem.start());
    //         uiObj.end = Math.max(uiObj.end, cellX.rowItem.end());
    //         uiObj.values[0] = (uiObj.values[0] * uiObj.valueItems[0].length + cellX.value) / (uiObj.valueItems[0].length + 1);
    //         uiObj.values[1] = (uiObj.values[1] * uiObj.valueItems[1].length + cellY.value) / (uiObj.valueItems[1].length + 1);
    //         uiObj.valueItems[0].push(cellX);
    //         uiObj.valueItems[1].push(cellY);

    //         if (uiObj.valueItems[0].length > maxGroupItems) {
    //             maxGroupItems = uiObj.valueItems[0].length;
    //         }

    //         continue;
    //     }


    //     uiObj = new epiviz.ui.charts.ChartObject(
    //         sprintf('scatter_%s_%s', seriesIndex, cellX.globalIndex),
    //         cellX.rowItem.start(),
    //         cellX.rowItem.end(), [cellX.value, cellY.value],
    //         seriesIndex, [
    //             [cellX],
    //             [cellY]
    //         ], // valueItems one for each measurement
    //         [mX, mY], // measurements
    //         classes);

    //     if (!grid[gridY]) { grid[gridY] = {}; }
    //     grid[gridY][gridX] = uiObj;

    //     items.push(uiObj);
    // }





    var grid = {};
    var items = [];
    var maxGroupItems = 1;
    var seriesIndex = 0; // Assume only 1 pair of datax and datay
    for (var i = 0; i < data.length; ++i) {

        //index = indices[i] % nItems;
        //var globalIndex = index + firstGlobalIndex;
        //var seriesIndex = Math.floor(indices[i] / nItems);
        //var mX = self._measurementsX[seriesIndex];
        //var mY = self._measurementsY[seriesIndex];
        //var cellX = data.getSeries(mX).getByGlobalIndex(globalIndex);
        //var cellY = data.getSeries(mY).getByGlobalIndex(globalIndex);
        var cellX = data[i][dimx];
        var cellY = data[i][dimy];
        if (!cellX || !cellY) {
            continue;
        }

        var classes = sprintf('item data-series-%s', seriesIndex);

        var x = xScale(cellX);
        var y = yScale(cellY);

        var gridX = Math.floor(x / gridSquareSize) * gridSquareSize;
        var gridY = Math.floor(y / gridSquareSize) * gridSquareSize;

        var uiObj = null;
        if (grid[gridY] && grid[gridY][gridX]) {
            uiObj = grid[gridY][gridX];
            uiObj.id += '_' + data[i][key];
            uiObj.values[0] = (uiObj.values[0] * uiObj.valueItems[0].length + cellX) / (uiObj.valueItems[0].length + 1);
            uiObj.values[1] = (uiObj.values[1] * uiObj.valueItems[1].length + cellY) / (uiObj.valueItems[1].length + 1);
            uiObj.valueItems[0].push(data[i]);
            uiObj.valueItems[1].push(data[i]);
            if (uiObj.valueItems[0].length > maxGroupItems) {
                maxGroupItems = uiObj.valueItems[0].length;
            }
            continue;
        }

        uiObj = new epiviz.ui.charts.ChartIndexObject(
            sprintf('scatter_%s_%s_%s_%s', cellX, cellY, seriesIndex, data[i][key]), [key],
            data[i][key], [cellX, cellY], [
                [data[i]],
                [data[i]]
            ], // valueItems one for each measurement
            [dimx, dimy], // measurements
            seriesIndex,
            classes);

        if (!grid[gridY]) { grid[gridY] = {}; }
        grid[gridY][gridX] = uiObj;

        items.push(uiObj);
    }

    var itemsGroup = this._chartContent.select('.items');

    if (itemsGroup.empty()) {
        itemsGroup = this._chartContent.append('g').attr('class', 'items');
        var selectedGroup = itemsGroup.append('g').attr('class', 'selected');
        itemsGroup.append('g').attr('class', 'hovered');
        selectedGroup.append('g').attr('class', 'hovered');
    }

    var selection = itemsGroup.selectAll('circle').data(items, function(d) {
        return d.id;
    });

    // selection
    //     .enter()
    //     .insert('circle', ':first-child')
    //     .attr('id', function(d) {
    //         return sprintf('%s-item-%s-%s', self.id(), d.seriesIndex, d.valueItems[0][0].globalIndex);
    //     })
    //     .style('opacity', 0)
    //     .style('fill-opacity', 0)
    //     .attr('r', 0);
    // selection
    //     .each(
    //         /**
    //          * @param {epiviz.ui.charts.ChartObject} d
    //          */
    //         function(d) {
    //             var circle = d3.select(this);

    //             var fill;
    //             if (!self._globalIndexColorLabels) { fill = self.colors().get(d.seriesIndex); } else {
    //                 fill = self.colors().getByKey(self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]);
    //             }
    //             circle
    //                 .attr('cx', margins.left() + (d.values[0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    //                 .attr('cy', height - margins.bottom() - ((d.values[1] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
    //                 .attr('class', d.cssClasses)
    //                 .style('fill', fill);
    //         });

    selection
        .enter()
        .insert('circle', ':first-child')
        .attr('id', function(d) {
            return sprintf('%s-item-%s', self.id(), d.seriesIndex);
        })
        .style('opacity', 0)
        .style('fill-opacity', 0)
        .attr('r', 0);
    selection
        .each(
            /**
             * @param {epiviz.ui.charts.ChartObject} d
             */
            function(d) {
                var circle = d3.select(this);

                //var fill = self.colors().get(d.seriesIndex);
                var fill = self.colors().getByKey(d.valueItems[0][0][colorbylabel]);
                if(self._globalIndexColorLabels != null && self._globalIndexColorLabels.indexOf(d.valueItems[0][0][colorbylabel]) == -1){
                    self._globalIndexColorLabels.push(d.valueItems[0][0][colorbylabel]);
                }
                // if (!self._globalIndexColorLabels) { fill = self.colors().get(d.seriesIndex); } else {
                //     fill = self.colors().getByKey(self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]);
                // }
                circle
                    .attr('cx', margins.left() + (d.values[0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
                    .attr('cy', height - margins.bottom() - ((d.values[1] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
                    .attr('class', d.cssClasses)
                    .style('fill', fill);
            });


    selection
        .transition()
        .duration(1000)
        .style('fill-opacity', function(d) {
            //return Math.max(0.3, d.valueItems[0].length / maxGroupItems);
            return Math.max(0.6, d.valueItems[0].length / maxGroupItems);
        })
        .style('opacity', null)
        .attr('r', circleRadius);

    selection
        .exit()
        .transition()
        .duration(1000)
        .style('opacity', 0)
        .attr('r', 0)
        .remove();

    selection
        //.on('mouseover', function(d) {
        //    console.log("mouseover");
        //    console.log(d);
        //    self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
        //    self._dispatch.hover(self.id(), d);
        //})
        //.on('mouseout', function() {
        //    self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
        //    self._dispatch.hover(self.id(), null);
        //
        //})
        .on('click', function(d) {
            console.log("click");
            self._deselect.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
            self._select.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
            // self._dispatch.click(self.id(), null);

            d3.event.stopPropagation();
        });

    // Draw legend if necessary
    if (this._globalIndexColorLabels) {
        var colorLabelsMap = {};
        for (j = firstGlobalIndex; j < lastGlobalIndex; ++j) {
            colorLabelsMap[this._globalIndexColorLabels[j]] = this._globalIndexColorLabels[j];
        }
        this._colorLabels = Object.keys(colorLabelsMap);

        this._svg.selectAll('.chart-title').remove();
        this._svg.selectAll('.chart-title-color ').remove();
        var titleEntries = this._svg
            .selectAll('.chart-title')
            .data(this._colorLabels);
        titleEntries
            .enter()
            .append('text')
            .attr('class', 'chart-title')
            .attr('font-weight', 'bold')
            .attr('y', self.margins().top() - 5);
        titleEntries
            .attr('fill', function(label, i) {
                return self.colors().getByKey(label);
            })
            .text(function(label) {
                return label;
            });
        var textLength = 0;
        var titleEntriesStartPosition = [];

        $('#' + this.id() + ' .chart-title')
            .each(function(i) {
                titleEntriesStartPosition.push(textLength);
                textLength += this.getBBox().width + 15;
            });

        titleEntries.attr('x', function(column, i) {
            return self.margins().left() + 10 + titleEntriesStartPosition[i];
        });

        var colorEntries = this._svg
            .selectAll('.chart-title-color')
            .data(this._colorLabels)
            .enter()
            .append('circle')
            .attr('class', 'chart-title-color')
            .attr('cx', function(column, i) {
                return self.margins().left() + 4 + titleEntriesStartPosition[i];
            })
            .attr('cy', self.margins().top() - 9)
            .attr('r', 4)
            .style('shape-rendering', 'auto')
            .style('stroke-width', '0')
            .attr('fill', function(label, i) {
                return self.colors().getByKey(label);
            })
            .style('stroke-width', 0)
    } else {
        var n = Math.min(this._measurementsX.length, this._measurementsY.length);
        var colors = new Array(n);

        for (j = 0; j < n; ++j) {
            colors[j] = sprintf('%s vs %s', this._measurementsX[j].name(), this._measurementsY[j].name());
        }

        this._colorLabels = colors;
    }
    this._colorLabels = [];
    //this._colorLabels = Object.keys(self.colors()._keyIndices);
    
    Object.keys(self.colors()._keyIndices).forEach(function(m) {if (!(m == "undefined" || m == "Max")) {self._colorLabels.push(m)};})
    //console.log(this._colorLabels);
    this._svg.selectAll('.chart-title').remove();
    this._svg.selectAll('.chart-title-color ').remove();
    var titleEntries = this._svg
      .selectAll('.chart-title')
      .data(this._colorLabels);
    titleEntries
      .enter()
      .append('text')
      .attr('class', 'chart-title')
      .attr('font-weight', 'bold')
      .attr('y', self.margins().top() - 5);
    titleEntries
      .attr('fill', function(label, i) {
        return self.colors().getByKey(label);
      })
      .text(function(label) { return label; });
    var textLength = 0;
    var titleEntriesStartPosition = [];

    $('#' + this.id() + ' .chart-title')
      .each(function(i) {
        titleEntriesStartPosition.push(textLength);
        textLength += this.getBBox().width + 15;
      });

    titleEntries.attr('x', function(column, i) {
      return self.margins().left() + 10 + titleEntriesStartPosition[i];
    });

    var colorEntries = this._svg
      .selectAll('.chart-title-color')
      .data(this._colorLabels)
      .enter()
      .append('circle')
      .attr('class', 'chart-title-color')
      .attr('cx', function(column, i) { return self.margins().left() + 4 + titleEntriesStartPosition[i]; })
      .attr('cy', self.margins().top() - 9)
      .attr('r', 4)
      .style('shape-rendering', 'auto')
      .style('stroke-width', '0')
      .attr('fill', function(label, i) {
        return self.colors().getByKey(label);
      })
      .style('stroke-width', 0)

    var title = '';


    return items;
};

/**
 * @returns {Array.<{name: string, color: string}>}
 */
epiviz.plugins.charts.CustomScatterPlot.prototype.colorLabels = function() {
    return this._colorLabels;
};

/**
 * @param xScale D3 linear scale for the x axis
 * @param yScale D3 linear scale for the y axis
 * @param {number} [xTicks]
 * @param {number} [yTicks]
 * @param [svg] D3 svg container for the axes
 * @param {number} [width]
 * @param {number} [height]
 * @param {epiviz.ui.charts.Margins} [margins]
 * @protected
 */
epiviz.plugins.charts.CustomScatterPlot.prototype._drawAxes = function(xScale, yScale, xTicks, yTicks, svg, width, height, margins) {
    epiviz.ui.charts.Plot.prototype._drawAxes.call(this, xScale, yScale, xTicks, yTicks, svg, width, height, margins);
    var self = this;
    this._legend.selectAll('text').remove();

    var xMeasurements = ['pca1'];
    var self = this;
    this._legend.selectAll('.x-measurement').remove();
    this._legend.selectAll('.x-measurement-color').remove();
    
    var xEntries = this._legend
        .selectAll('.x-measurement')
        .data(xMeasurements)
        .enter()
        .append('text')
        .attr('class', 'x-measurement')
        .attr('font-weight', 'bold')
        .attr('fill', function(m, i) {
            return self._globalIndexColorLabels ?
                "#000000" : self.colors().get(i);
        })
        .attr('y', (this.height() - this.margins().bottom() + 35))
        .text(function(m, i) {
            return m + " (% Variance Explained = " + self._variance_labels[0] + ")";
        });

    var xTextLength = 0;
    var xTitleEntriesStartPosition = [];

    $('#' + this.id() + ' .x-measurement')
        .each(function(i) {
            xTitleEntriesStartPosition.push(xTextLength);
            xTextLength += this.getBBox().width + 15;
        });

    xEntries.attr('x', function(column, i) {
        return (self.width() - xTextLength) * 0.5 + 7 + xTitleEntriesStartPosition[i];
    });

    var yMeasurements = ['pca2'];
    this._legend.selectAll('.y-measurement').remove();
    this._legend.selectAll('.y-measurement-color').remove();

    var yEntries = this._legend
        .selectAll('.y-measurement')
        .data(yMeasurements)
        .enter()
        .append('text')
        .attr('class', 'y-measurement')
        .attr('font-weight', 'bold')
        .attr('fill', function(m, i) {
            return self._globalIndexColorLabels ?
                "#000000" : self.colors().get(i);
        })
        .attr('y', (this.margins().left() - 35))
        .attr('transform', 'rotate(-90)')
        .text(function(m, i) {
            return m  + " (% Variance Explained = " + self._variance_labels[1] + ")";
        });

    var yTextLength = 0;
    var yTitleEntriesStartPosition = [];

    $('#' + this.id() + ' .y-measurement')
        .each(function(i) {
            yTitleEntriesStartPosition.push(yTextLength);
            yTextLength += this.getBBox().width + 15;
        });

    yEntries.attr('x', function(column, i) {
        return -self.height() + (self.height() - yTextLength) * 0.5 + 12 + self.margins().top() + yTitleEntriesStartPosition[i];
    });
};

epiviz.plugins.charts.CustomScatterPlot.prototype.transformData = function(range, data) {
  var lastRange = this._lastRange;

  if (range != undefined) {
    this._lastRange = range;
  }
  if (data != undefined) {
    this._lastData = data;
    this._unalteredData = data;
  }

  var deferred = new epiviz.deferred.Deferred();
  deferred.resolve();
  return deferred;
};

// goog.inherits(epiviz.plugins.charts.CustomScatterPlot, epiviz.ui.charts.Plot);

// Input 74
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 11:55 PM
 */

goog.provide('epiviz.plugins.charts.CustomScatterPlotType');

goog.require('epiviz.plugins.charts.CustomScatterPlot');
goog.require('epiviz.ui.charts.PlotType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.PlotType}
 * @constructor
 */
epiviz.plugins.charts.CustomScatterPlotType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.PlotType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.PlotType.prototype);
epiviz.plugins.charts.CustomScatterPlotType.constructor = epiviz.plugins.charts.CustomScatterPlotType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.ScatterPlot}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.CustomScatterPlot(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.CustomScatterPlot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.chartName = function() {
  return 'PCA Scatter Plot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.chartHtmlAttributeName = function() {
  return 'pca_scatter';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.measurementsFilter = function() { return function(m) { return epiviz.measurements.Measurement.Type.hasValues(m.type()); }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * Gets the minimum number of measurements that must be selected for the chart to be displayed
 * @returns {number}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.minSelectedMeasurements = function() { return 2; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.PlotType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.CustomScatterPlotType.CustomSettings.CIRCLE_RADIUS_RATIO,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      0.015,
      'Circle radius ratio'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.X_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min X'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.X_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max X'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.CustomScatterPlotType.CustomSettings.COLOR_BY,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_ANNOTATION,
      'name',
      'Color By')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.CustomScatterPlotType.CustomSettings = {
  CIRCLE_RADIUS_RATIO: 'circleRadiusRatio',
  COLOR_BY: 'colorBy'
};

// goog.inherits(epiviz.plugins.charts.CustomScatterPlotType, epiviz.ui.charts.PlotType);

// Input 75
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 10:59 PM
 */

goog.provide('epiviz.ui.charts.ChartFactory');

goog.require('epiviz.utils');
goog.require('epiviz.plugins.charts.BlocksTrackType');
goog.require('epiviz.plugins.charts.LineTrackType');
goog.require('epiviz.plugins.charts.StackedLineTrackType');
goog.require('epiviz.plugins.charts.ScatterPlotType');
goog.require('epiviz.plugins.charts.GenesTrackType');
goog.require('epiviz.plugins.charts.HeatmapPlotType');
goog.require('epiviz.plugins.charts.LinePlotType');
goog.require('epiviz.plugins.charts.StackedLinePlotType');
goog.require('epiviz.ui.charts.tree.IcicleType');
goog.require('epiviz.plugins.charts.DiversityScatterPlotType');
goog.require('epiviz.plugins.charts.CustomScatterPlotType');


/**
 * @param {epiviz.Config} config
 * @constructor
 * @implements {epiviz.utils.Iterable}
 */
epiviz.ui.charts.ChartFactory = function(config) {

  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * A map of type names and their corresponding constructors
   * @type {Object.<string, epiviz.ui.charts.ChartType>}
   * @private
   */
  this._types = {};

  /**
   * @type {number}
   * @private
   */
  this._size = 0;

  for (var i = 0; i < config.chartTypes.length; ++i) {
    this.register(config.chartTypes[i]);
  }
};

/**
 * @returns {number}
 */
epiviz.ui.charts.ChartFactory.prototype.size = function() {
  return this._size;
};

/**
 * @param {epiviz.ui.charts.ChartType} type
 */
epiviz.ui.charts.ChartFactory.prototype.registerType = function(type) {
  if (!(type.typeName() in this._types)) {
    ++this._size;
  }
  this._types[type.typeName()] = type;
};

/**
 * @param {epiviz.ui.charts.ChartType} type
 * @returns {boolean}
 */
epiviz.ui.charts.ChartFactory.prototype.unregisterType = function(type) {
  if (!(type.typeName() in this._types)) { return false; }

  --this._size;

  delete this._types[type.typeName()];
  return true;
};

/**
 * @param {string} typeName
 * @returns {boolean}
 */
epiviz.ui.charts.ChartFactory.prototype.register = function(typeName) {
  /** @type {?function(new:epiviz.ui.charts.ChartType)} */
  var typeDescriptorConstructor = epiviz.utils.evaluateFullyQualifiedTypeName(typeName);

  if (!typeDescriptorConstructor) { return false; }

  this.registerType(/** @type {epiviz.ui.charts.ChartType} */ (new typeDescriptorConstructor(this._config)));
  return true;
};

/**
 * @param {string} typeName
 * @returns {boolean}
 */
epiviz.ui.charts.ChartFactory.prototype.unregister = function(typeName) {
  /** @type {?function(new:epiviz.ui.charts.ChartType)} */
  var typeDescriptorConstructor = epiviz.utils.evaluateFullyQualifiedTypeName(typeName);

  if (!typeDescriptorConstructor) { return false; }

  return this.unregisterType(/** @type {epiviz.ui.charts.ChartType} */ (new typeDescriptorConstructor(this._config)));
};

/**
 * @param {string} typeName
 * @returns {?epiviz.ui.charts.ChartType}
 */
epiviz.ui.charts.ChartFactory.prototype.get = function(typeName) {
  if (typeName && typeName in this._types) {
    return this._types[typeName];
  }

  return null;
};

/**
 * Iterates through all types in the factory, or until func returns something that evaluates to true.
 * @param {function(string, epiviz.ui.charts.ChartType)} func A function called for each (typeName, descriptor) pair in the factory.
 */
epiviz.ui.charts.ChartFactory.prototype.foreach = function(func) {
  for (var typeName in this._types) {
    if (!this._types.hasOwnProperty(typeName)) { continue; }
    if (func(typeName, this._types[typeName])) {
      return;
    }
  }
};


// Input 76
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/17/13
 * Time: 11:38 AM
 */

goog.provide('epiviz.ui.controls.Control');

goog.require('epiviz.utils');

/**
 * @param {jQuery} container
 * @param {string} [title]
 * @param {string} [id]
 * @constructor
 */
epiviz.ui.controls.Control = function(container, title, id) {
  /**
   * @type {jQuery}
   * @protected
   */
  this._container = container;

  /**
   * @type {string}
   * @private
   */
  this._title = title || '';

  /**
   * @type {string}
   * @private
   */
  this._id = id || epiviz.utils.generatePseudoGUID(6);
};

/**
 */
epiviz.ui.controls.Control.prototype.initialize = function() {};

/**
 * @returns {string}
 */
epiviz.ui.controls.Control.prototype.id = function() { return this._id; };

/**
 * @returns {string}
 */
epiviz.ui.controls.Control.prototype.title = function() { return this._title; };

// Input 77
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/30/14
 * Time: 9:33 PM
 */

goog.provide('epiviz.ui.controls.DataTable');

goog.require('epiviz.ui.controls.Control');

/**
 * @param {jQuery} container
 * @param {Array.<epiviz.ui.controls.DataTable.Column>} columns
 * @param {Iterable.<T>} rows
 * @param {function(T, epiviz.ui.controls.DataTable.Column): number|string} rowParser
 * @param {boolean} [multiselect]
 * @param {boolean} [showColumnSelector]
 * @constructor
 * @extends {epiviz.ui.controls.Control}
 * @template T
 */
epiviz.ui.controls.DataTable = function(container, columns, rows, rowParser, multiselect, showColumnSelector) {
  // Call superclass constructor
  epiviz.ui.controls.Control.call(this, container);

  /**
   * @type {Array.<epiviz.ui.controls.DataTable.Column>}
   * @private
   */
  this._columns = columns;

  /**
   * @type {Iterable.<T>}
   * @private
   */
  this._rows = rows;

  /**
   * @type {Array.<T>}
   * @private
   */
  this._rowsArray = [];

  var self = this;
  this._rows.foreach(function(row) { self._rowsArray.push(row); });

  /**
   * @type {function(T, epiviz.ui.controls.DataTable.Column): number|string}
   * @private
   */
  this._rowParser = rowParser;

  /**
   * @type {boolean}
   * @private
   */
  this._multiselect = multiselect || false;

  /**
   * @type {boolean}
   * @private
   */
  this._showColumnSelector = showColumnSelector || false;

  /**
   * @type {?jQuery}
   * @private
   */
  this._table = null;

  /**
   * @type {?jQuery}
   * @private
   */
  this._columnSelector = null;

  /**
   * @type {Array.<number>}
   * @private
   */
  this._selectedIndices = [];

  /**
   * @type {Object.<number, boolean>}
   * @private
   */
  this._selectedIndicesMap = {};

  // Helper members used for selection

  /**
   * @type {?Array.<HTMLElement>}
   * @private
   */
  this._selectList = null;

  /**
   * @type {?Array.<HTMLElement>}
   * @private
   */
  this._deselectList = null;

  /**
   * @type {?HTMLElement}
   * @private
   */
  this._lastSelection = null;
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.DataTable.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Control.prototype);
epiviz.ui.controls.DataTable.constructor = epiviz.ui.controls.DataTable;

/**
 * @enum {string}
 */
epiviz.ui.controls.DataTable.ColumnType = {
  STRING: 'string',
  NUMBER: 'number',
  BOOLEAN: 'boolean'
};

epiviz.ui.controls.DataTable.prototype.initialize = function() {
  this._container.append('<div class="epiviz-data-table"><table style="width: 100%!important;"><thead></thead><tbody></tbody><tfoot></tfoot></table></div>');
  this._table = this._container.find('table');
  var thead = this._table.find('thead');
  var tfoot = this._table.find('tfoot');
  var tbody = this._table.find('tbody');

  var headFootContent = sprintf('<tr><th>%s</th></tr>', this._columns.join('</th><th>'));
  thead.append(headFootContent);
  tfoot.append(headFootContent);

  var self = this;
  this._rows.foreach(
    /** @param {T} row */
    function(row) {
      var rowHtml = '';
      for (var i = 0; i < self._columns.length; ++i) {
        rowHtml += sprintf('<td>%s</td>', self._rowParser(row, self._columns[i]));
      }
      tbody.append(sprintf('<tr>%s</tr>', rowHtml));
    });

  var j;
  var columnFilterTypes = new Array(this._columns.length);
  for (j = 0; j < this._columns.length; ++j) {
    columnFilterTypes[j] = {
      type: 'text',
      bRegex: true,
      bSmart: true
    };
  }

  this._table.dataTable({
    bJQueryUI: true,
    sDom: '<"H"lfr>Tt<"F"ip>',
    oTableTools: {
      //'sSwfPath': 'src/jquery/DataTables-1.9.4/extras/TableTools/media/swf/copy_csv_xls_pdf.swf',
      sRowSelect: this._multiselect ? 'multi' : 'single',
      aButtons: ['select_all'],

      fnPreRowSelect: function(e, nodes, isSelect) { return self._preRowSelect(this, e, nodes, isSelect); },
      fnRowSelected:  function(nodes) { return self._select(this, nodes); },
      fnRowDeselected: function(nodes) { return self._select(this, nodes); }
    }
  }).columnFilter({ aoColumns: columnFilterTypes });

  var visibleIndex = -1;
  for (j = 0; j < this._columns.length; ++j) {
    if (this._columns[j].isVisible) { ++visibleIndex; }
    this._table.fnSetColumnVis(j, this._columns[j].isVisible);
    if (!this._columns[j].defaultFilter) { continue; }
    this._table.fnFilter(this._columns[j].defaultFilter, j, true, true);
    this._table
      .find('tfoot')
      .find(sprintf('th:eq(%s)', visibleIndex))
      .find('input')
      .removeClass('search_init')
      .val(this._columns[j].defaultFilter);
  }

  // Hack
  this._container.find('.ui-buttonset').first().attr('style', 'position: absolute!important;');

  if (this._showColumnSelector) {
    var colSelectorCls = 'epiviz-data-table-column-selector';
    this._container.find('.fg-toolbar').first().append(sprintf(
      '<div style="float: right; margin-right: 5px;">' +
        '<label>Selected Columns: </label>' +
        '<select class="%s" multiple="multiple" style="">' +
          '<option value="-1">All</option>' +
        '</select>' +
      '</div>', colSelectorCls));

    this._columnSelector = this._container.find('.' + colSelectorCls);
    for (var i = 0; i < this._columns.length; ++i) {
      var option = sprintf('<option value="%s"%s%s>%s</option>',
        i,
        this._columns[i].isVisible ? ' selected="selected"' : '',
        this._columns[i].isFixed ? ' disabled="disabled"' : '',
        this._columns[i].name);

      this._columnSelector.append(option);
    }

    this._columnSelector.dropdownchecklist({
      width: '80px',
      firstItemChecksAll: true,
      onComplete: function(selector) { self._selectColumns(selector); }
    });
  }
};

/**
 * @returns {Array.<number>}
 */
epiviz.ui.controls.DataTable.prototype.selectedIndices = function() {
  return this._selectedIndices || [];
};

/**
 * @returns {Array.<T>}
 */
epiviz.ui.controls.DataTable.prototype.selectedRows = function() {
  if (!this._selectedIndices) { return []; }

  var result = new Array(this._selectedIndices.length);
  for (var i = 0; i < this._selectedIndices.length; ++i) {
    result[i] = this._rowsArray[this._selectedIndices[i]];
  }

  return result;
};

/**
 * @param {TableTools} tableTools
 * @param {jQuery.Event} e
 * @param {Array.<HTMLElement>} nodes
 * @param {boolean} isSelect
 * @returns {boolean}
 * @private
 */
epiviz.ui.controls.DataTable.prototype._preRowSelect = function(tableTools, e, nodes, isSelect) {
  if (e) {
    this._selectList = this._deselectList = null;
    if (e.shiftKey && nodes.length == 1) {
      this._deselectList = tableTools.fnGetSelected();
      if (!this._lastSelection) { this._lastSelection = nodes[0]; }
      this._selectList = this._getRangeOfRows(this._lastSelection, nodes[0]);
    } else {
      this._lastSelection = nodes[0];
      if (!e.ctrlKey && !e.metaKey) {
        this._deselectList = tableTools.fnGetSelected();
        if (!isSelect) {
          this._selectList = nodes;
        }
      }
    }
  }
  return true;
};

/**
 * @param {HTMLElement} fromNode
 * @param {HTMLElement} toNode
 * @returns {?Array.<HTMLElement>}
 * @private
 */
epiviz.ui.controls.DataTable.prototype._getRangeOfRows = function(fromNode, toNode) {
  var
    fromPos = this._table.fnGetPosition(fromNode),
    toPos = this._table.fnGetPosition(toNode),
    oSettings = this._table.fnSettings(),
    fromIndex = $.inArray(fromPos, oSettings.aiDisplay),
    toIndex = $.inArray(toPos, oSettings.aiDisplay),
    result = [];

  if (fromIndex >= 0 && toIndex >= 0) {
    for (var i = Math.min(fromIndex, toIndex); i <= Math.max(fromIndex, toIndex); ++i) {
      var dataIndex = oSettings.aiDisplay[i];
      result.push(oSettings.aoData[dataIndex].nTr);
    }
  }
  return (result.length > 0) ? result : null;
};

/**
 * @param {TableTools} tableTools
 * @param {Array.<HTMLElement>} nodes
 * @returns {boolean}
 * @private
 */
epiviz.ui.controls.DataTable.prototype._select = function(tableTools, nodes) {
  var nodeList;
  if (this._deselectList) {
    nodeList = this._deselectList;
    this._deselectList = null;
    tableTools.fnDeselect(nodeList);
  }
  if (this._selectList) {
    nodeList = this._selectList;
    if (!this._multiselect && nodeList.length > 0) {
      nodeList = [nodeList[nodeList.length - 1]];}
    this._selectList = null;
    tableTools.fnSelect(nodeList);
  }

  var selection = tableTools.fnGetSelected();

  // We want to maintain order of selected indices, so we'll remove from the
  // _selectedIndices member the indices that have been deselected, and
  // add the new ones.

  var selectedIndices = new Array(selection.length);
  var selectedIndicesMap = {};

  var i;
  for (i = 0; i < selection.length; ++i) {
    selectedIndices[i] = this._table.fnGetPosition(selection[i]);
    selectedIndicesMap[selectedIndices[i]] = true;
  }

  // Remove indices corresponding to deselected nodes
  for (i = 0; i < this._selectedIndices.length; ++i) {
    if (!selectedIndicesMap[this._selectedIndices[i]]) {
      delete this._selectedIndicesMap[this._selectedIndices[i]];
      this._selectedIndices.splice(i, 1);
      --i;
    }
  }

  // Add indices corresponding to newly selected nodes
  for (i = 0; i < selectedIndices.length; ++i) {
    if (!this._selectedIndicesMap[selectedIndices[i]]) {
      this._selectedIndicesMap[selectedIndices[i]] = true;
      this._selectedIndices.push(selectedIndices[i]);
    }
  }

  return true;
};

/**
 * @param selector
 * @private
 */
epiviz.ui.controls.DataTable.prototype._selectColumns = function(selector) {
  var selectedIndices = {}, i;
  for(i = 0; i < selector.options.length; ++i) {
    if (selector.options[i].selected && selector.options[i].value) {
      selectedIndices[parseInt(selector.options[i].value)] = true;
    }
  }

  for (i = 0; i < this._columns.length; ++i) {
    this._table.fnSetColumnVis(i, selectedIndices[i] || this._columns[i].isFixed);
  }
};

goog.provide('epiviz.ui.controls.DataTable.Column');

/**
 * @param {string} id
 * @param {string} name
 * @param {epiviz.ui.controls.DataTable.ColumnType} type
 * @param {boolean} [isHidden]
 * @param {boolean} [isFixed]
 * @param {string} [defaultFilter]
 * @constructor
 * @struct
 */
epiviz.ui.controls.DataTable.Column = function(id, name, type, isHidden, isFixed, defaultFilter) {
  this.id = id;
  this.name = name;
  this.type = type;
  this.isVisible = !(isHidden);
  this.isFixed = isFixed || false;
  this.defaultFilter = defaultFilter || '';
};

/**
 * @returns {string}
 */
epiviz.ui.controls.DataTable.Column.prototype.toString = function() { return this.name; };

// Input 78
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/31/14
 * Time: 12:44 PM
 */

goog.provide('epiviz.ui.controls.DatasourceGroupWizardStep');

goog.require('epiviz.ui.controls.DataTable');
/**
 * @constructor
 * @implements {epiviz.ui.controls.Wizard.Step}
 */
epiviz.ui.controls.DatasourceGroupWizardStep = function() {
  /**
   * @type {?epiviz.ui.controls.DataTable}
   * @private
   */
  this._dataTable = null;

  /**
   * @type {epiviz.ui.controls.VisConfigSelection}
   * @private
   */
  this._data = null;
};

/**
 * @param {jQuery} container
 * @param {epiviz.ui.controls.VisConfigSelection} data
 */
epiviz.ui.controls.DatasourceGroupWizardStep.prototype.initialize = function(container, data) {
  this._data = data;

  container.find('.epiviz-data-table').remove();

  var columns = [
    new epiviz.ui.controls.DataTable.Column('datasourceGroup', 'Data Source Group', epiviz.ui.controls.DataTable.ColumnType.STRING)
  ];

  var datasourceGroups = {};
  data.measurements.foreach(function(m) {
    if (data.dataprovider && data.dataprovider != m.dataprovider()) { return; }
    if (data.annotation) {
      for (var key in data.annotation) {
        if (!data.annotation.hasOwnProperty(key)) { continue; }
        if (!m.annotation() || m.annotation()[key] != data.annotation[key]) { return; }
      }
    }

    datasourceGroups[m.datasourceGroup()] = true;
  });

  this._dataTable = new epiviz.ui.controls.DataTable(container, columns, new epiviz.utils.IterableArray(Object.keys(datasourceGroups)), function(v) { return v; });
  this._dataTable.initialize();
};

/**
 * Gets the selected datasource group, or, if
 * there is an error, success is set to false and errorMessage contains
 * the details of the error that occurred.
 *
 * @returns {{
 *   error: string=,
 *   data: epiviz.ui.controls.VisConfigSelection=}}
 */
epiviz.ui.controls.DatasourceGroupWizardStep.prototype.next = function() {
  var selectedRows = this._dataTable ? this._dataTable.selectedRows() : [];
  if (selectedRows.length == 0) {
    return {
      error: 'No rows selected'
    };
  }

  this._data.datasourceGroup = selectedRows[0];

  var copy = new epiviz.ui.controls.VisConfigSelection(
    this._data.measurements.subset(function(m) { return m.datasourceGroup() == selectedRows[0]; }),
    this._data.datasource,
    this._data.datasourceGroup,
    this._data.dataprovider,
    this._data.annotation ? epiviz.utils.mapCopy(this._data.annotation) : this._data.annotation,
    this._data.defaultChartType,
    this._data.minSelectedMeasurements,
    this._data.customData
  );

  return {
    data: copy
  };
};

epiviz.ui.controls.DatasourceGroupWizardStep.prototype.title = function() {
  return 'Select Datasource Group';
};

// Input 79
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/1/14
 * Time: 9:32 AM
 */

goog.provide('epiviz.ui.controls.MeaurementsWizardStep');

goog.require('epiviz.ui.controls.DataTable');
goog.require('epiviz.measurements.MeasurementSet');

/**
 * @constructor
 * @implements {epiviz.ui.controls.Wizard.Step}
 */
epiviz.ui.controls.MeaurementsWizardStep = function() {
  /**
   * @type {?epiviz.ui.controls.DataTable}
   * @private
   */
  this._dataTable = null;

  /**
   * @type {epiviz.ui.controls.VisConfigSelection}
   * @private
   */
  this._data = null;

  /**
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._measurements = null;
};

/**
 * @param {jQuery} container
 * @param {epiviz.ui.controls.VisConfigSelection} data
 */
epiviz.ui.controls.MeaurementsWizardStep.prototype.initialize = function(container, data) {
  this._data = data;

  container.find('.epiviz-data-table').remove();

  var viewCount = 2;

  var ColumnType = epiviz.ui.controls.DataTable.ColumnType;
  var columns = [
    new epiviz.ui.controls.DataTable.Column('id', 'Id', ColumnType.STRING, true),
    new epiviz.ui.controls.DataTable.Column('name', 'Name', ColumnType.STRING, false, true),
    // new epiviz.ui.controls.DataTable.Column('defaultChartType', 'Default Chart Type', ColumnType.STRING, true, true),
    new epiviz.ui.controls.DataTable.Column('type', 'Type', ColumnType.STRING, true),
    new epiviz.ui.controls.DataTable.Column('datasourceId', 'Data Source', ColumnType.STRING, true),
    new epiviz.ui.controls.DataTable.Column('datasourceGroup', 'Data Source Group', ColumnType.STRING, true),
    new epiviz.ui.controls.DataTable.Column('dataprovider', 'Data Provider', ColumnType.STRING, true),
    new epiviz.ui.controls.DataTable.Column('formulaStr', 'Formula', ColumnType.STRING, true)//,
    //new epiviz.ui.controls.DataTable.Column('annotation', 'Annotation', ColumnType.STRING)
  ];

  var annotationColumns = [];
  var annotationMap = {};
  data.measurements.foreach(function(m) {
    var anno = m.annotation();
    if (anno == undefined) { return; }
    for (var annoCol in anno) {
      if (!anno.hasOwnProperty(annoCol)) { continue; }
      if (!(annoCol in annotationMap)) {
        annotationColumns.push(annoCol);
        annotationMap[annoCol] = true;
      }
    }
  });
  annotationColumns.sort();
  columns = columns.concat(annotationColumns.map(function(annoCol) {
    var hidden = false;

    if(viewCount <= 0) {
      hidden = true;
    }
    viewCount--;
    return new epiviz.ui.controls.DataTable.Column('[anno] ' + annoCol, annoCol, ColumnType.STRING, hidden)
  }));

  // Filter out measurements that don't match the given restrictions
  this._measurements = data.measurements.subset(
    function(m) {
      if (data.datasource && data.datasource != m.datasourceId()) { return false; }
      if (data.datasourceGroup && data.datasourceGroup != m.datasourceGroup()) { return false; }
      if (data.dataprovider && data.dataprovider != m.dataprovider()) { return false; }
      if (data.annotation) {
        for (var key in data.annotation) {
          if (!data.annotation.hasOwnProperty(key)) { continue; }
          if (!m.annotation() || m.annotation()[key] != data.annotation[key]) { return false; }
        }
      }
      return true;
    });

  this._dataTable = new epiviz.ui.controls.DataTable(container, columns, this._measurements,
    /**
     * @param {epiviz.measurements.Measurement} m
     * @param {epiviz.ui.controls.DataTable.Column} column
     * @returns {string|number}
     */
    function(m, column) {
      var result = null;
      if (epiviz.utils.stringStartsWith(column.id, '[anno] ')) {
        result = '';
        if (m.annotation() != undefined) { result = m.annotation()[column.name] || ''; }
      } else {
        switch (column.id) {
          case 'annotation':
            result = epiviz.utils.mapJoin(m.annotation(), ': ', '<br />');
            break;
          default:
            result = m[column.id](); // Getter with the same name
            break;
        }
      }
      if (result === 0 || result) { return result; }
      return '';
    }, true, true);
  this._dataTable.initialize();
};

/**
 * Gets the selected datasource group, or, if
 * there is an error, success is set to false and errorMessage contains
 * the details of the error that occurred.
 *
 * @returns {{
 *   error: string=,
 *   data: epiviz.ui.controls.VisConfigSelection=
 * }}
 */
epiviz.ui.controls.MeaurementsWizardStep.prototype.next = function() {
  var selectedRows = this._dataTable ? this._dataTable.selectedRows() : [];
  if (selectedRows.length < this._data.minSelectedMeasurements) {
    return {
      error: 'Minimum selected rows required is ' + this._data.minSelectedMeasurements
    };
  }

  var selectedMeasurements = new epiviz.measurements.MeasurementSet();
  for (var i = 0; i < selectedRows.length; ++i) {
    selectedMeasurements.add(selectedRows[i]);
  }
  this._data.measurements = selectedMeasurements;

  return {
    data: this._data
  };
};

epiviz.ui.controls.MeaurementsWizardStep.prototype.title = function() {
  return 'Select Measurements';
};


// Input 80
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/19/13
 * Time: 2:03 PM
 */

goog.provide('epiviz.ui.controls.Dialog');

goog.require('epiviz.utils');
/**
 * @param {string} title
 * @param {Object.<string, function>} handlers
 * @constructor
 */
epiviz.ui.controls.Dialog = function(title, handlers) {
  /**
   * @type {jQuery}
   * @protected
   */
  this._container = $('#dialogs');

  /**
   * @type {string}
   * @protected
   */
  this._title = title;

  /**
   * @type {string}
   * @protected
   */
  this._id = epiviz.ui.controls.Dialog.generateId();

  /**
   * @type {Object.<string, Function>}
   * @protected
   */
  this._handlers = handlers;

  this._container.append(sprintf('<div id="%s" title="%s" style="display: none;"></div>', this._id, this._title));

  /**
   * @type {jQuery}
   * @protected
   */
  this._dialog = null;
};

/**
 * @type {number}
 * @private
 */
epiviz.ui.controls.Dialog._nextIdIndex = 0;

/**
 * @returns {string}
 */
epiviz.ui.controls.Dialog.generateId = function() {
  return sprintf('dialog-%s', epiviz.utils.generatePseudoGUID(5));
};

/**
 */
epiviz.ui.controls.Dialog.prototype.show = function() {};

// Input 81
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/16/14
 * Time: 4:22 PM
 */

goog.provide('epiviz.ui.controls.MessageDialog');

goog.require('epiviz.ui.controls.Dialog');

/**
 * @param {string} title
 * @param {string} message
 * @param {Object.<string, function>} handlers
 * @param {epiviz.ui.controls.MessageDialog.Icon} [icon]
 * @constructor
 * @extends {epiviz.ui.controls.Dialog}
 */
epiviz.ui.controls.MessageDialog = function(title, handlers, message, icon) {
  epiviz.ui.controls.Dialog.call(this, title, handlers);

  /**
   * @type {string}
   * @private
   */
  this._message = message;

  /**
   * @type {epiviz.ui.controls.MessageDialog.Icon}
   * @private
   */
  this._icon = icon || epiviz.ui.controls.MessageDialog.Icon.INFO;
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.MessageDialog.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Dialog.prototype);
epiviz.ui.controls.MessageDialog.constructor = epiviz.ui.controls.MessageDialog;

/**
 * @enum {string}
 */
epiviz.ui.controls.MessageDialog.Icon = {
  INFO: 'info',
  ERROR: 'error',
  QUESTION: 'question'
};

/**
 */
epiviz.ui.controls.MessageDialog.prototype.show = function() {
  epiviz.ui.controls.Dialog.prototype.show.call(this);

  var Icon = epiviz.ui.controls.MessageDialog.Icon;

  if (!this._dialog) {
    var self = this;
    this._dialog = $('#' + this._id);
    this._dialog.css('display', 'inline');

    var state = this._icon == Icon.ERROR ? 'error' : 'highlight';
    var icon = this._icon == Icon.ERROR ? 'alert' : 'info';
    this._dialog.append(sprintf(
      '<div class="ui-state-%s ui-corner-all" style="margin: 5px; padding: 5px; height: auto;">' +
        '<div class="ui-icon ui-icon-%s" style="float: left; margin-right: 5px;"></div>' +
        '<div class="dialog-text">%s</div>' +
      '</div>', state, icon, this._message));

    var buttons = {};
    for (var buttonName in this._handlers) {
      if (!this._handlers.hasOwnProperty(buttonName)) { continue; }
      (function(buttonName) {
        buttons[buttonName] = function() {
          self._handlers[buttonName]();
          $(this).dialog('close');
        };
      })(buttonName);
    }

    this._dialog.dialog({
      autoOpen: false,
      resizable: false,
      //width: '600',
      buttons: buttons,
      modal: true
    });

    // This makes the dialog only able to open once:
    this._dialog.dialog({
      close: function(event, ui) {
        $(this).remove();
        self._dialog = null;
      }
    });
  }

  this._dialog.dialog('open');

  this._dialog.dialog('option', 'position', 'center');
};

// Input 82
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/30/14
 * Time: 6:21 PM
 */

goog.provide('epiviz.ui.controls.Wizard');

goog.require('epiviz.ui.controls.Dialog');
goog.require('epiviz.ui.controls.MessageDialog');
goog.require('epiviz.utils');

/**
 * @param {string} title
 * @param {{finish: function(*)=, close: function()=}} handlers
 * @param {Array.<epiviz.ui.controls.Wizard.Step>} steps
 * @param {*} initialData
 * @param {string} [width]
 * @param {string} [height]
 * @param {boolean} [showTabs]
 * @constructor
 * @extends {epiviz.ui.controls.Dialog}
 */
epiviz.ui.controls.Wizard = function(title, handlers, steps, initialData, width, height, showTabs) {
  epiviz.ui.controls.Dialog.call(this, title, handlers);

  /**
   * @type {Array.<epiviz.ui.controls.Wizard.Step>}
   * @private
   */
  this._steps = steps;

  /**
   * @type {*}
   * @private
   */
  this._initialData = initialData;

  /**
   * @type {string=}
   * @private
   */
  this._width = width;

  /**
   * @type {string=}
   * @private
   */
  this._height = height;

  /**
   * @type {boolean}
   * @private
   */
  this._showTabs = showTabs || false;

  /**
   * @type {?jQuery}
   * @private
   */
  this._tabs = null;

  this._initialize();
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.Wizard.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Dialog.prototype);
epiviz.ui.controls.Wizard.constructor = epiviz.ui.controls.Wizard;

/**
 * @private
 */
epiviz.ui.controls.Wizard.prototype._initialize = function() {
  var self = this;
  this._dialog = $('#' + this._id);
  this._dialog.append(
    '<div id="wizardDialog" class="wizard-dialog">' +
      '<div class="wizard-tabs">' +
        '<ul class="wizard-tabs-title-list"></ul>' +
      '</div>' +
    '</div>');

  this._tabs = this._dialog.find('.wizard-tabs');

  /** @type {jQuery} */
  var titleList = this._tabs.find('.wizard-tabs-title-list');

  for (var i = 0; i < this._steps.length; ++i) {
    titleList.append(sprintf('<li><a href="#%s-tab-%s">%s</a></li>', this._id, i, this._steps[i].title()));
    this._tabs.append(sprintf('<div id="%s-tab-%s"></div>', this._id, i));
  }

  if (!this._showTabs) {
    titleList.css('visibility', 'hidden');
    titleList.css('position', 'absolute');
  }

  this._tabs.tabs({
    activate: function(e, ui) { self._tabActivate(ui); },
    disabled: epiviz.utils.range(this._steps.length - 1, 1)
  });

  this._dialog.dialog({
    autoOpen: false,
    resizable: true,
    width: this._width || undefined,
    height: this._height || undefined,
    buttons: {
      Back: function() {
        var selectedTabIndex = self._tabs.tabs('option', 'active');
        if (selectedTabIndex == 0) { return; }

        self._tabs.tabs('option', 'disabled', epiviz.utils.range(self._steps.length - selectedTabIndex, selectedTabIndex));
        self._tabs.tabs('option', 'active', selectedTabIndex - 1);
      },
      Next: function() {
        var selectedTabIndex = self._tabs.tabs('option', 'active');

        /** @type {{data: *=, error: string=}} */
        var result = self._steps[selectedTabIndex].next();

        if (result.error) {
          var errorDialog = new epiviz.ui.controls.MessageDialog('Error', { Ok: function() {} }, result.error, epiviz.ui.controls.MessageDialog.Icon.ERROR);
          errorDialog.show();
          return;
        }

        self._steps[selectedTabIndex+1].initialize($(sprintf('#%s-tab-%s', self._id, selectedTabIndex+1)), result.data);

        self._tabs.tabs('option', 'disabled', epiviz.utils.range(self._steps.length - selectedTabIndex - 2, selectedTabIndex + 2));
        self._tabs.tabs('option', 'active', selectedTabIndex + 1);
      },
      Finish: function() {
        /** @type {{data: *=, error: string=}} */
        var result = self._steps[self._steps.length - 1].next();

        if (result.error) {
          var errorDialog = new epiviz.ui.controls.MessageDialog('Error', { Ok: function() {} }, result.error, epiviz.ui.controls.MessageDialog.Icon.ERROR);
          errorDialog.show();
          return;
        }

        if (self._handlers.finish) {
          self._handlers.finish(result.data);
        }

        $(this).dialog('close');
      },
      Cancel: function() {
        if (self._handlers.close) {
          self._handlers.close();
        }
        $(this).dialog('close');
      }
    },
    modal: true
  });

  if (this._steps.length > 1) {
    this._dialog.parent().find('button:contains("Finish")').button('disable');
    this._dialog.parent().find('button:contains("Next")').button('enable');
  } else {
    this._dialog.parent().find('button:contains("Finish")').button('enable');
    this._dialog.parent().find('button:contains("Next")').button('disable');
  }
  this._steps[0].initialize($(sprintf('#%s-tab-0', self._id)), this._initialData);
  this._dialog.css('overflow', 'visible');
};

/**
 * @param ui
 * @private
 */
epiviz.ui.controls.Wizard.prototype._tabActivate = function(ui) {
  var selectedTabIndex = this._tabs.tabs('option', 'active');
  var finishButton = this._dialog.parent().find('button:contains("Finish")');
  var nextButton = this._dialog.parent().find('button:contains("Next")');

  if (selectedTabIndex == this._steps.length - 1) {
    nextButton.button('disable');
    finishButton.button('enable');
  } else {
    nextButton.button('enable');
    finishButton.button('disable');
  }

  this._tabs.tabs('option', 'disabled', epiviz.utils.range(this._steps.length - selectedTabIndex - 1, selectedTabIndex + 1));
};

/**
 */
epiviz.ui.controls.Wizard.prototype.show = function() {
  var self = this;

  this._dialog.dialog('open');
  this._dialog.dialog('option', 'position', 'center');

  // This makes the dialog only able to open once:
  this._dialog.dialog({
    close: function(event, ui) {
      $(this).remove();
      self._dialog = null;
    }
  });
};

goog.provide('epiviz.ui.controls.Wizard.Step');

/**
 * @interface
 * @template I, O
 */
epiviz.ui.controls.Wizard.Step = function() {};

/**
 * @param {jQuery} container
 * @param {I} [data]
 */
epiviz.ui.controls.Wizard.Step.prototype.initialize = function(container, data) {};

/**
 * Gets the data resulted from manipulation of this wizard step, or, if
 * there is an error, error contains the details of the error that occurred.
 * @returns {{data: O=, error: string=}}
 */
epiviz.ui.controls.Wizard.Step.prototype.next = function() {};

/**
 * @returns {string}
 */
epiviz.ui.controls.Wizard.Step.prototype.title = function() {};

// Input 83
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/20/14
 * Time: 6:20 PM
 */

goog.provide('epiviz.ui.controls.ComputedMeasurementsDialog');

goog.require('epiviz.ui.controls.Dialog');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.utils');
goog.require('epiviz.ui.controls.MessageDialog');

/**
 * @param {string} title
 * @param {{add: function(epiviz.measurements.Measurement), remove: function(epiviz.measurements.Measurement), close: function()}} handlers
 * @param {epiviz.measurements.MeasurementSet} measurements
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartsMeasurements
 * @constructor
 * @extends {epiviz.ui.controls.Dialog}
 */
epiviz.ui.controls.ComputedMeasurementsDialog = function(title, handlers, measurements, chartsMeasurements) {
  epiviz.ui.controls.Dialog.call(this, title, handlers);

  /**
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._measurements = measurements;

  /**
   * @type {Object.<string, epiviz.measurements.MeasurementSet>}
   * @private
   */
  this._chartsMeasurements = chartsMeasurements;

  /**
   * @type {?jQuery}
   * @private
   */
  this._expressionTextBox = null;

  /**
   * @type {?jQuery}
   * @private
   */
  this._idTextBox = null;

  /**
   * @type {?jQuery}
   * @private
   */
  this._nameTextBox = null;

  /**
   * @type {?jQuery}
   * @private
   */
  this._minTextBox = null;

  /**
   * @type {?jQuery}
   * @private
   */
  this._maxTextBox = null;

  /**
   * @type {?jQuery}
   * @private
   */
  this._measurementsList = null;

  /**
   * @type {{text: boolean, icons: {primary: string}}}
   * @private
   */
  this._addButtonProperties = {
    text: false,
    icons: {
      primary: 'ui-icon ui-icon-plus'
    }
  };

  /**
   * @type {{text: boolean, icons: {primary: string}}}
   * @private
   */
  this._deleteButtonsProperties = {
    text: false,
    icons: {
      primary: 'ui-icon ui-icon-trash'
    }
  };

  /**
   * @type {?jQuery}
   * @private
   */
  this._tabs = null;

  /**
   * @type {string}
   * @private
   */
  this._selectedDatasourceGroup = null;

  /**
   * @type {Array.<epiviz.measurements.Measurement>}
   * @private
   */
  this._datasourceGroupMeasurements = null;

  this._addTabs();
  this._addDialogContents();
  this._addDatasourceGroupTable(measurements);
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Dialog.prototype);
epiviz.ui.controls.ComputedMeasurementsDialog.constructor = epiviz.ui.controls.ComputedMeasurementsDialog;

/**
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype.show = function() {
  epiviz.ui.controls.Dialog.prototype.show.call(this);

  var self = this;
  if (this._dialog) {
    this._dialog.dialog('open');
    this._dialog.dialog('option', 'position', 'center');

    // This makes the dialog only able to open once:
    this._dialog.dialog({
      close: function(event, ui) {
        $(this).remove();
        self._dialog = null;
        self._handlers.close();
      }
    });
  }
};

/**
 * @param {epiviz.measurements.MeasurementSet} measurements
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._addDatasourceGroupTable = function(measurements) {
  var self = this;
  var container = $(sprintf('#datasource-group-tab-%s', this._id));
  var rawTableCls = 'computed-measurements-dialog-raw-table';

  var table = '<table ' +
    'style="border-spacing:0; ' +
    'border-collapse:collapse; ' +
    '-webkit-touch-callout: none; ' +
    '-webkit-user-select: none; ' +
    '-khtml-user-select: none; ' +
    '-moz-user-select: moz-none; ' +
    '-ms-user-select: none; ' +
    'user-select: none; ' +
    'width: 100%%;" ' +
    'class="' + rawTableCls + '">%s</table>';

  var header = '<thead><tr><th>Data Source Group</th></tr></thead>';
  var footer = '<tfoot><tr><th>Data Source Group</th></tr></tfoot>';
  var body = '';

  /**
   * @type {Object.<string, Array.<epiviz.measurements.Measurement>>}
   */
  var measurementsByDatasourceGroup = {};

  measurements.foreach(function(m) {
    if (m.type() != epiviz.measurements.Measurement.Type.FEATURE) { return; } // continue

    if (!(m.datasourceGroup() in measurementsByDatasourceGroup)) {
      measurementsByDatasourceGroup[m.datasourceGroup()] = [];
    }

    measurementsByDatasourceGroup[m.datasourceGroup()].push(m);
  });

  for (var g in measurementsByDatasourceGroup) {
    if (!measurementsByDatasourceGroup.hasOwnProperty(g)) { continue; }

    body += sprintf('<tr><td class="center">%s</td></tr>', g);
  }

  container.append(sprintf(table, header + body + footer));

  var rawTable = container.find('.' + rawTableCls);
  var oTable = rawTable.dataTable({
    bJQueryUI: true,
    sDom: '<"H"lfr>Tt<"F"ip>',
    'oTableTools': {
      "sRowSelect": "single",
      "aButtons": [],

      "fnPreRowSelect": function(e, nodes, isSelect) {
        return true;
      },
      "fnRowSelected":   function(nodes) {
        var data = oTable.fnGetData(nodes[0]);
        self._selectedDatasourceGroup = data[0];
        self._datasourceGroupMeasurements = measurementsByDatasourceGroup[self._selectedDatasourceGroup];
      },
      "fnRowDeselected": function(nodes) {
        var data = oTable.fnGetData(nodes[0]);
        if (data == self._selectedDatasourceGroup) {
          self._selectedDatasourceGroup = null;
          self._datasourceGroupMeasurements = null;
        }
      }
    }
  });

  // Hack, to position the table at the top
  container.find('.DTTT_container').css('position', 'absolute');
};

/**
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._addTabs = function() {
  var self = this;
  this._selectDialog().append(
    '<div id="computedMeasurementsDialog" class="computed-measurements-dialog">' +
      '<div class="computed-measurements-tabs">' +
        '<ul>' +
          sprintf('<li><a href="#datasource-group-tab-%s">Data Source Group</a></li>', this._id) +
          sprintf('<li><a href="#formula-tab-%s">Expression</a></li>', this._id) +
        '</ul>' +
        sprintf('<div id="datasource-group-tab-%s"></div>', this._id) +
        sprintf('<div id="formula-tab-%s"></div>', this._id) +
      '</div>' +
    '</div>');

  this._tabs = this._selectTabs();
  this._tabs.tabs({
    activate: function(e, ui) { self._tabActivate(ui); }
  });
};

/**
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._addDialogContents = function() {
  var self = this;
  this._selectDialog().dialog({
    autoOpen: false,
    resizable: true,
    width: '600',
    height: '550',
    buttons: {
      Back: function() {
        var selectedTabIndex = self._tabs.tabs('option', 'active');
        if (selectedTabIndex == 0) { return; }

        self._tabs.tabs('option', 'active', 0);
      },
      Next: function() {
        var selectedTabIndex = self._tabs.tabs('option', 'active');
        if (selectedTabIndex == 1) { return; }

        self._tabs.tabs('option', 'active', 1);
      },
      Add: function() {
        /** @type {epiviz.utils.ExpressionParser.Expression} */
        var expr = epiviz.utils.ExpressionParser.parse(self._selectExpressionTextBox().val().trim());

        var referredMeasurements = {};
        var variables = expr.variables();
        var min = null, max = null;
        var metadata = [];
        var usedMetadata = {};

        for (var i = 0; i < variables.length; ++i) {
          var variable = variables[i];

          if (!epiviz.utils.stringStartsWith(variable, '{') || !epiviz.utils.stringEndsWith(variable, '}')) {
            // This means that the variable is something else than a measurement
            continue;
          }
          var index = parseInt(variable.substring(1, variable.length - 1));

          var m = self._datasourceGroupMeasurements[index];
          referredMeasurements[index] = m;

          if (min === null || min > m.minValue()) {
            min = m.minValue();
          }

          if (max === null || max < m.maxValue()) {
            max = m.maxValue();
          }

          if (m.metadata()) {
            for (var j = 0; j < m.metadata().length; ++j) {
              if (!usedMetadata[m.metadata()[j]]) {
                usedMetadata[m.metadata()[j]] = true;
                metadata.push(m.metadata()[j]);
              }
            }
          }
        }

        var userMin = self._selectMinTextBox().val().trim();
        var userMax = self._selectMaxTextBox().val().trim();

        min = userMin ? parseFloat(userMin) : min;
        max = userMax ? parseFloat(userMax) : max;

        var id = self._selectIdTextBox().val().trim() || epiviz.utils.generatePseudoGUID(5);
        var measurement = new epiviz.measurements.Measurement(
          id,
          self._selectNameTextBox().val().trim() || 'Unnamed [' + id + ']',
          epiviz.measurements.Measurement.Type.FEATURE,
          null, // datasourceId
          self._selectedDatasourceGroup,
          null, // data provider
          {referredMeasurements: referredMeasurements, expression: expr},
          'any',
          null,
          min,
          max,
          metadata
        );

        var nextIndex = self._datasourceGroupMeasurements.length;
        var msList = $(sprintf('#computed-measurement-measurements-%s', self._id));
        var removeButton = '<button id="delete-button-%2$s-%3$s" data-measurement="%2$s">Delete</button>';
        msList.append(sprintf(
          '<div style="min-height: 30px; padding: 2px;">' +
            '<div style="margin: 6px; float: left;">%1$s {<b>%2$s</b>}</div>' +
            '<div style="float: right;">' +
              removeButton +
              '<button style="" id="measurement-button-%2$s-%3$s" data-measurement="%2$s">Insert %2$s</button>' +
            '</div>' +
          '</div>', measurement.name(), nextIndex, self._id));

        $('#measurement-button-' + nextIndex + '-' + self._id)
          .button(self._addButtonProperties)
          .click(function() { self._addButtonClick($(this)); });
        $('#delete-button-' + nextIndex + '-' + self._id)
          .button(self._deleteButtonsProperties)
          .click(function() { self._deleteButtonClick($(this)); });

        self._datasourceGroupMeasurements.push(measurement);

        self._handlers.add(measurement);

      },
      Close: function() {
        self._handlers.close();
        $(this).dialog('close');
      }
    },
    modal: true
  });
};

/**
 * @param {jQuery} button
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._addButtonClick = function(button) {
  var measurementIndex = button.data('measurement');

  var exprBox = this._selectExpressionTextBox();
  exprBox.val(exprBox.val().trim() + ' {' + measurementIndex + '}');
};

/**
 * @param {jQuery} button
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._deleteButtonClick = function(button) {
  var measurementIndex = button.data('measurement');
  var measurement = this._datasourceGroupMeasurements[measurementIndex];
  var dialog;

  // Check if there are other measurements using this measurement.
  // If there are, display a message and don't delete it.
  for (var i = 0; i < this._datasourceGroupMeasurements.length; ++i) {
    var m = this._datasourceGroupMeasurements[i];
    if (m == null || m === measurement || !m.isComputed()) { continue; }
    if (m.componentMeasurements().contains(measurement)) {
      dialog = new epiviz.ui.controls.MessageDialog(
        'Measurement cannot be deleted',
        {
          Ok: function() {}
        },
        'There are other measurements that depend on the one selected. Please delete those before deleting this.',
        epiviz.ui.controls.MessageDialog.Icon.ERROR);
      dialog.show();
      return;
    }
  }

   // Check if there are existing charts using this measurement.
   // If there are, then display a message and don't delete it.
  for (var chartId in this._chartsMeasurements) {
    if (!this._chartsMeasurements.hasOwnProperty(chartId)) { continue; }
    if (this._chartsMeasurements[chartId].contains(measurement)) {
      dialog = new epiviz.ui.controls.MessageDialog(
        'Measurement cannot be deleted',
        {
          Ok: function() {}
        },
        'There are charts using the selected measurement. Remove them from the workspace and then try again.',
        epiviz.ui.controls.MessageDialog.Icon.ERROR);
      dialog.show();
      return;
    }
  }

  this._datasourceGroupMeasurements[measurementIndex] = null;
  button.parent().parent().remove();
  this._handlers.remove(measurement);
};

/**
 * @param ui
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._tabActivate = function(ui) {
  var selectedTabIndex = this._selectTabs().tabs('option', 'active');

  if (selectedTabIndex == 0) { return; }

  ui.newPanel.empty();

  this._idTextBox = null;
  this._nameTextBox = null;
  this._expressionTextBox = null;
  this._minTextBox = null;
  this._maxTextBox = null;
  this._measurementsList = null;

  if (!this._selectedDatasourceGroup) { return; }

  ui.newPanel.append(sprintf(
    '<label for="computed-measurement-key-%1$s"><b>Id:</b></label> ' +
    '<input id="computed-measurement-key-%1$s" class="ui-widget-content ui-corner-all" style="padding: 2px;" type="text"/>&nbsp;' +
    '<label for="computed-measurement-name-%1$s"><b>Name:</b></label> ' +
    '<input id="computed-measurement-name-%1$s" class="ui-widget-content ui-corner-all" style="padding: 2px;" type="text"/>' +
    '<br /><br />' +
    '<div id="computed-measurement-measurements-%1$s" style="overflow: auto; max-height: 200px; border-style: solid; border-width: 1px; border-color: #999999;"></div>' +
    '<br/>' +
    '<label for="computed-measurement-min-%1$s"><b>Min:</b></label> ' +
    '<input id="computed-measurement-min-%1$s" class="ui-widget-content ui-corner-all" style="padding: 2px;" type="text"/>&nbsp;' +
    '<label for="computed-measurement-max-%1$s"><b>Max:</b></label> ' +
    '<input id="computed-measurement-max-%1$s" class="ui-widget-content ui-corner-all" style="padding: 2px;" type="text"/><br/>' +
    '<div style="overflow: hidden; padding: 10px; padding-right: 20px; margin: 0px;">' +
      '<textarea id="computed-measurement-expr-%1$s" class="ui-widget-content ui-corner-all" style="width: 100%%; height: 55px; padding: 5px; margin: 0; resize: none;"></textarea>' +
    '</div>',
    this._id));

  var msList = this._selectMeasurementsList();

  var contents = '';
  for (var i = 0; i < this._datasourceGroupMeasurements.length; ++i) {
    var m = this._datasourceGroupMeasurements[i];
    var removeButton = '';
    if (m.isComputed()) {
      removeButton = '<button id="delete-button-%2$s-%3$s" data-measurement="%2$s">Delete %2$s</button>';
    }
    contents += sprintf(
      '<div style="min-height: 30px; padding: 2px;">' +
        '<div style="margin: 6px; float: left;">%1$s {<b>%2$s</b>}</div>' +
        '<div style="float: right;">' +
          removeButton +
          //editButton +
          '<button style="" id="measurement-button-%2$s-%3$s" data-measurement="%2$s">Insert %2$s</button>' +
        '</div>' +
      '</div>', m.name(), i, this._id);
  }

  msList.append(contents);

  var self = this;
  for (i = 0; i < this._datasourceGroupMeasurements.length; ++i) {
    m = this._datasourceGroupMeasurements[i];
    if (m.isComputed()) {
      $('#delete-button-' + i + '-' + this._id)
        .button(this._deleteButtonsProperties)
        .click(function() { self._deleteButtonClick($(this)); });
    }
    $('#measurement-button-' + i + '-' + this._id)
      .button(this._addButtonProperties)
      .click(function() { self._addButtonClick($(this)); });
  }

  this._selectIdTextBox().watermark('[auto]');
  this._selectNameTextBox().watermark('[auto]');
  this._selectMinTextBox().watermark('[auto]');
  this._selectMaxTextBox().watermark('[auto]');
  this._selectExpressionTextBox().watermark('[expression; for example: {0} - {1}]');
};


/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectDialog = function() {
  if (!this._dialog) { this._dialog = $('#' + this._id); }

  return this._dialog;
};

/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectExpressionTextBox = function() {
  if (!this._expressionTextBox) { this._expressionTextBox = $('#computed-measurement-expr-' + this._id); }

  return this._expressionTextBox;
};

/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectIdTextBox = function() {
  if (!this._idTextBox) { this._idTextBox = $('#computed-measurement-key-' + this._id); };

  return this._idTextBox;
};

/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectNameTextBox = function() {
  if (!this._nameTextBox) { this._nameTextBox = $('#computed-measurement-name-' + this._id); };

  return this._nameTextBox;
};

/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectMinTextBox = function() {
  if (!this._minTextBox) { this._minTextBox = $('#computed-measurement-min-' + this._id); };

  return this._minTextBox;
};

/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectMaxTextBox = function() {
  if (!this._maxTextBox) { this._maxTextBox = $('#computed-measurement-max-' + this._id); };

  return this._maxTextBox;
};

/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectTabs = function() {
  if (!this._tabs) { this._tabs = this._dialog.find('.computed-measurements-tabs'); }

  return this._tabs;
};

/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectMeasurementsList = function() {
  if (!this._measurementsList) { this._measurementsList = $('#computed-measurement-measurements-' + this._id); }

  return this._measurementsList;
};

// Input 84
goog.provide('epiviz.ui.tutorials');

epiviz.ui.tutorials = function() {
    this._tutorialList = [
        {
            "name": 'Epiviz Overview',
            "id": 'tut_epiviz_overview',
            "tutorial": [
                {
                    target: 'body',
                    content: "<p class='intro-header'>Welcome to Epiviz Genomic Browser!<br></p>" +
                    "<p class='intro-text'>This tutorial will walk you through the functionality available in Epiviz.</p>",
                    position: 'center'
                }, {
                    target: '#intro-navigation',
                    content: "<p class='intro-text'>The navigation section of Epiviz lets you select a chromosome and explore the genome. Options are available to move left/right and zoom in/out.</p>" +
                    "<p class='intro-text'>The settings icon allows you to control the navigation parameters.</p>",
                    position: 'right',
                    buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
                }, {
                    target: '#search-box',
                    content: "<p class='intro-header'>Use the search input to look for a specific gene or target.</p>" +
                    "<p class='intro-text'>This will navigate Epiviz to the selected gene location and update the workspace with the new data.</p>",
                    position: 'right',
                    buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
                }, {
                    target: '#vis-menu-button',
                    content: '<p class="intro-text">Choose from a list of available data sources, measurements or chart types to add visualizations to the Epiviz Workspace.</p>',
                    position: 'right',
                    buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
                }, {
                    target: '#intro-workspace',
                    content: '<p class="intro-header">managing workspaces.</p>' +
                    '<p class="intro-text">If you are logged in, you will be able to save your Epiviz analysis and workspaces.' +
                    'You will also be able to retrieve them at a later time from your account.</p>',
                    position: 'right',
                    buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
                }, {
                    target: '#login-link',
                    content: '<p class="intro-text">Please login to save and manage Epiviz workspaces.</p>',
                    position: 'left',
                    buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
                }, {
                    target: 'body',
                    content: "<p class='intro-header'>Thank you for using Epiviz!</p>" +
                    '<p class="intro-text">If you would like to give us some feedback or stay informed with updates, Please visit the <a target="_blank" href="http://epiviz.github.io/">Epiviz webpage</a>.</p>',
                    position: 'center'
                }]
        }, {
            "name": 'Data Visualization and Controls',
            "id": 'tut_data_controls',
            "tutorial": [{
                target: 'body',
                content: "<p class='intro-header'>Welcome to Epiviz Genomic Browser!<br><br>" +
                "Data visualization tutorial<br></p>" +
                "<p class='intro-text'>This tutorial will help create/add new data visualizations to the Epiviz workspace " +
                "and controls available for each visualization.</p>",
                position: 'center'
            }, {
                target: '#vis-menu-button',
                content: '<p class="intro-text">The Data Visualizations button helps users add new charts to the workspace.</p>' +
                '<p>Users have the option to choose data sources and measurements to add to the workspace.</p>',
                position: 'right',
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $('#vis-menu-button').button().trigger("click");
                },
                showOverlay: function(){},
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: '#vis-menu',
                content: '<p class="intro-text">Choose the type of chart to add to your workspace. We choose scatter plot to continue with the tutorial</p>',
                position: 'right',
                onShow: function(anno, $target, $annoElem) {
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $('#plot-menu-add-scatter').trigger("click");
                },
                showOverlay: function(){},
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() {
                    var parent = $('#wizardDialog').parent().attr('id');
                    var p_parent = $('#' + parent).parent();
                    return p_parent;
                },
                content: '<p class="intro-text">This window lets you choose form a list of data sources and ' +
                'the measurements available from each data source to add to your Epiviz workspace</p>' +
                '<p>We selected the first data source in the table or choose a data source from the list.</p>',
                showOverlay: function(){},
                onShow: function(anno, $target, $annoElem) {
                    $('#wizardDialog table tbody tr:first').trigger('click');
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $('.ui-button:contains("Next")').trigger('click');
                },
                position: 'right',
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() {
                    var parent = $('#wizardDialog').parent().attr('id');
                    var p_parent = $('#' + parent).parent();
                    return p_parent;
                },
                content: '<p class="intro-text">After choosing a data source, the next tab lists all the measurements (or features) ' +
                'available from this data source. If you have any computed measurements for this data source, they will be added to this list.</p>' +
                '<p>To add a plot to the workspace, pick a few measurements and select finish on this window. </p>',
                showOverlay: function(){},
                position: 'right',
                onShow: function(anno, $target, $annoElem) {
                    //$('#wizardDialog table tbody tr:first').trigger('click');
                    //$('#wizardDialog table tbody tr:eq(2)').trigger('click');
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    var parent = $('#wizardDialog').parent().attr('id');
                    $('#' + parent).dialog('close');
                    //$('.ui-button:contains("Finish")').trigger('click');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: '#feature-view',
                content: '<p class="intro-text">Visualizations are added to the workspace based on the type of chart. </p>' +
                '<p>Brushing is implemented on all the plots. When you hover over a data point, it highlight that region in the gene on all the visualizations.</p>',
                position: {
                    top: '24em',
                    left: '14em'
                },
                showOverlay: function(){},
                onShow: function(anno, $target, $annoElem) {

                    $('button:contains("Remove"):first').css('display', 'block');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() {
                    return $('button:contains("Remove"):first');
                },
                content: '<p class="intro-text">Removes the plot from the workspace</p>',
                position: 'left',
                showOverlay: function(){},
                className: 'anno-width-175',
                onShow: function(anno, $target, $annoElem) {
                    $('button:contains("Save"):eq(1)').css('display', 'block');
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $($target).css('display', 'none');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() { return $('button:contains("Save"):eq(1)'); },
                content: '<p class="intro-text">Save a plot to your local machine (image, pdf)</p>',
                position: 'left',
                showOverlay: function(){},
                className: 'anno-width-175',
                onShow: function(anno, $target, $annoElem) {
                    $('button:contains("Custom settings"):first').css('display', 'inline-block');
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $($target).css('display', 'none');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() { return $('button:contains("Custom settings"):first'); },
                content: '<p class="intro-text">Change chart display properties and aggregation methods for grouping.</p>',
                position: 'left',
                showOverlay: function(){},
                className: 'anno-width-175',
                onShow: function(anno, $target, $annoElem) {
                    $('button:contains("Code"):first').css('display', 'inline-block');
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $($target).css('display', 'none');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() { return $('button:contains("Code"):first'); },
                content: '<p class="intro-text">Edit code to redraw the chart on the workspace.</p>',
                position: 'left',
                showOverlay: function(){},
                className: 'anno-width-175',
                onShow: function(anno, $target, $annoElem) {
                    $('button:contains("Colors"):first').css('display', 'inline-block');
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $($target).css('display', 'none');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() { return $('button:contains("Colors"):first'); },
                content: '<p class="intro-text">Choose colors for data points on the plot</p>',
                position: 'left',
                showOverlay: function(){},
                className: 'anno-width-175',
                onShow: function(anno, $target, $annoElem) {
                    $('label:contains("Toggle tooltip"):first').css('display', 'block');
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $($target).css('display', 'none');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() {
                    return $('label:contains("Toggle tooltip"):first');
                },
                content: '<p class="intro-text">Toggle tooltips for data points</p>',
                position: 'right',
                showOverlay: function(){},
                className: 'anno-width-175',
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $($target).css('display', 'none');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: 'body',
                content: "<p class='intro-header'>Thank you for using Epiviz!</p>" +
                '<p class="intro-text">If you would like to give us some feedback or stay informed with updates, Please visit the <a target="_blank" href="http://epiviz.github.io/">Epiviz webpage</a>.</p>',
                position: 'center'
            }]
        }, {
            "name": 'Computed Measurements',
            "id": 'tut_comp_measurements',
            "tutorial": [{
                target: 'body',
                content: "<p class='intro-header'>Welcome to Epiviz Genomic Browser!<br>" +
                "Compute Measurements Tutorial<br></p>" +
                "<p class='intro-text'>This tutorial will help you create new measurements (derived from existing measurements) and generate plots to add " +
                "to the workspace.</p>",
                position: 'center'
            }, {
                target: '#computed-measurements-button',
                content: "<p class='intro-text'>The computed measurements button helps users " +
                "add new measurements to data sources</p>",
                position: 'right',
                onShow: function(anno, $target, $annoElem) {
                    $('#computed-measurements-button').button().trigger("click");
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: '#computedMeasurementsDialog',
                content: "<p class='intro-text'>This tab lets you " +
                "choose a data source where you will create a new measurement.</p>" +
                "<p>We choose the first data source in the list or choose any data source.</p>",
                position: {
                    top: '20em',
                    left: '1em'
                },
                showOverlay: function(){},
                onShow: function(anno, $target, $annoElem) {
                    $('#computedMeasurementsDialog table tbody tr td:first').trigger('click');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: '#computedMeasurementsDialog',
                content: "<p class='intro-text'>The measurements tab lists " +
                "all available measurements from the selected data source (including previously created computed measurements).</p>" +
                "<p>Use the buttons next to each measurement to add to the expression window</p>",
                position: {
                    top: '20em',
                    left: '1em'
                },
                showOverlay: function(){},
                onShow: function(anno, $target, $annoElem) {
                    $('.ui-button:contains("Next")').trigger('click');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: '#computedMeasurementsDialog',
                content: "<p class='intro-text'> After choosing measurements, use mathematical operators to evaluate the expression.</p>" +
                "<p><a target='_blank' href='https://silentmatt.com/javascript-expression-evaluator/'>supported operators</a> </p>",
                position: {
                    top: '33em',
                    left: '1em'
                },
                showOverlay: function(){},
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: '#computedMeasurementsDialog',
                content: "<p class='intro-text'>After adding a computed measurement, " +
                "use the data visualization button to plot the measurement to your workspace.</p>" +
                "<p>To learn how to add new plots to the workspace, please use the Epiviz data visualization tutorial.</p>",
                position: {
                    top: '10em',
                    left: '1em'
                },
                showOverlay: function(){},
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    var parent = $('#computedMeasurementsDialog').parent().attr('id');
                    $('#' + parent).dialog('close');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: 'body',
                content: "<p class='intro-header'>Thank you for using Epiviz!</p>" +
                '<p class="intro-text">If you would like to give us some feedback or stay informed with updates, Please visit the <a target="_blank" href="http://epiviz.github.io/">Epiviz webpage</a>.</p>',
                position: 'center'
            }]
        }
    ];
};
// Input 85
/**
 * Created by Jayaram Kancherla ( jkanche [at] umd [dot] edu )
 * Date: 4/6/2016
 */

goog.provide('epiviz.ui.PrintManager');

/**
 * @param {string} ctrId DOM ID to print/save. Can be the whole page or a epiviz.chart id.
 * @param {string} fName File Name to use
 * @param {string} fType File Format (pdf, png)
 * @constructor
 */
epiviz.ui.PrintManager = function(ctrId, fName, fType, workspaceId) {

    /**
     * DOM ID to print
     * @type {string}
     */
    this._containerId = ctrId ? ctrId : 'pagemain';

    /**
     * File Name for the screenshot/chart
     * @type {string}
     */
    this._fName = fName ? fName : "epiviz_" + Math.floor($.now() / 1000);

    /**
     * File Format to save (pdf, png)
     * @type {string}
     */
    this._fType = fType ? fType : "pdf";

    /**
     * workspace id of the current plot
     * @type {string}
     */
    this._workspaceId = workspaceId;
};


/**
 * Prints the chart or the specified DOM ID to a pdf or png.
 */
epiviz.ui.PrintManager.prototype.print = function() {

    var self = this;

    var container = $('#' + self._containerId);

    function inline_styles(dom) {
        var used = "";
        var sheets = document.styleSheets;
        for (var i = 0; i < sheets.length; i++) {
            var rules = sheets[i].cssRules;
            for (var j = 0; j < rules.length; j++) {
                var rule = rules[j];
                if (typeof(rule.style) != "undefined") {
                    var elems = dom.querySelectorAll(rule.selectorText);
                    if (elems.length > 0) {
                        used += rule.selectorText + " { " + rule.style.cssText + " }\n";
                    }
                }
            }
        }

        $(dom).find('style').remove();

        var s = document.createElement('style');
        s.setAttribute('type', 'text/css');
        s.innerHTML = "<![CDATA[\n" + used + "\n]]>";

        //dom.getElementsByTagName("defs")[0].appendChild(s);
        dom.insertBefore(s, dom.firstChild);
    }

    //add inline styles to svg elements
    function custom_styles(dom) {

        // style axes lines
        var axes = $(dom).find('.domain');
        axes.each(function () {
            $(this).css({"fill": "none", "stroke-width": "1px", "stroke": "#000000", "shape-rendering": "crispEdges"});
        });

        //remove gene name labels
        var gLabels = $(dom).find('.gene-name');
        gLabels.each(function () {
            $(this).remove();
        });

        // fill path on single line tracks

            var lines = $(dom).find('.lines path');
            lines.each(function() {
                $(this).css({"fill": "none"});
            });

        //change text size to fit screen
        var texts = $(dom).find('text');
        texts.each(function(){
            $(this).css({"font-size": "11px"});
        });

        var cLegends = $(dom).find('.chart-legend');
        cLegends.each(function() {
            $(this).css({"border": "none", "background": "transparent"});
        });
    }

    var svgElems = container.find('svg');

    svgElems.each(function () {
        var canvas, xml;

        canvas = document.createElement("canvas");
        canvas.className = "tempCanvas";

        custom_styles(this);

        // Convert SVG into a XML string
        xml = new XMLSerializer().serializeToString(this);

        // Removing the name space as IE throws an error
        xml = xml.replace(/xmlns=\"http:\/\/www\.w3\.org\/2000\/svg\"/, '');

        // draw the canvas object created from canvg
        var self = this;
        canvg(canvas, xml, {
            useCORS: true,
            renderCallback: function() {
                $(canvas).insertAfter(this);
                $(this).hide();
            }
        });
    });

    // use html2canvas to take a screenshot of the page!
    html2canvas(container, {
        //allowTaint: true,
        //taintTest: false,
        timeout: 0,
        //logging: true,
        width: container[0].scrollWidth + 200,
        height: container[0].scrollHeight + 200,
        useCORS: true
    }).then(function (canvas) {

        var ctx = canvas.getContext("2d");
        ctx.mozImageSmoothingEnabled = false;
        ctx.imageSmoothingEnabled = false;

        var filename = self._fName + "." + self._fType;
        var format = self._fType;
        var image = canvas.toDataURL("image/png");

        if(format == "pdf") {

            var dWidth = container[0].scrollWidth > 1400 ? container[0].scrollWidth : 1400;
            var dHeight = container[0].scrollHeight > 1000 ? container[0].scrollHeight : 1000;

            var jsdoc = new jsPDF('l', 'px', [dWidth * 0.6, dHeight * 0.65]);

            function toDataUrl(url, callback, outputFormat){
                var img = new Image();
                //img.crossOrigin = 'Anonymous';
                img.onload = function(){
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext('2d');
                    var dataURL;
                    canvas.height = this.height;
                    canvas.width = this.width;
                    ctx.drawImage(this, 0, 0);

                    dataURL = canvas.toDataURL(outputFormat);
                    callback(dataURL);
                    canvas = null;
                };
                img.src = url;
            }

            //TODO: save workspace if user is not signed in and get workspace id
            var s_url ="http://epiviz.cbcb.umd.edu/4/?ws=" + self._workspaceId;

            /*      toDataUrl(window.location.href + '/img/epiviz_4_logo_medium.png', function(imgData) {
             jsdoc.addImage(imgData, 'PNG', 20, 20, 100, 21);
             });*/
            jsdoc.addImage("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQ4AAAAyCAYAAACtfjXHAAAVX0lEQVR4nO1de5QU1Zn/db27errnxVMcHAaF+AxmiKLBRN3Bo+7RELOAB4OS1YVN9piHyQmY1SSuiYKJa8IxcSFZwyZRw2BO3NWsCeJj1SO7hEHFVzAwIIg4wsz0dE/XVHU9ev+oLqem+lZ3VVd1z6j1O6fOzNS9db9bNfd+93vd78balm/BREWit1tgWk8/T2cbLlDZxnlGjJ1tUPRkytAnq0yCYXUpb1DsAGWoBwHspoz8U/zgq9szUxYOjXffAXQAWAdgSfHv7QDWAugJmc46AGuKv/cUaWwPmUaEDykOPbC0qudiE41xJHq7Of3Erit1ir3aoLjLdIoX/TxPG3kNMLaxWu5+Lv3GI5kpC/Va9bUC9sNkHnYMApgPoDckGk8A6CLcn4/wGVSEDyGqZRxUyP2oGo3pPZN4LXu73L74sMy1bFWZ5Of9Mg0A0CmO0SnhcplrfTg36ZN/FdTBf0y99zxXiz6XwRqUMg0AaAawMSQaq0BmGoAphUSIUDNQydyBk8e5Dw2sLt0x3HjqAYVJ3qJT3JSwGtYpfpbMNt+Xa+3cK+QHqmOt1WFJmbIumAwkKFbVgUaECERQknjia7w29MPG9J6GehPn1cwywNir0uLNeowl0qcNuY/Vhp9mtez9rJa7W8j3387q0l2sLm2iDfkxFPSDlejodLxd5lq2sFruqcTIkTmhv0gpSNKGHeUmvdf2OyvUcZNGIkx8rANQALALE3QBoPQYyylM4zeHU3P3NEiHLq4H0Qbp8CRWy3UrbOq3AHWCvYw28mley/yGLqgrEvLRWTolTFOZhotVJnm9yiS+KXOt31FpcY1Ki6t1SrgCMXpWQj46nTbyqwHjccBQ3eiqTOIimZ/8UnJ439rDDy6ja/R6Haj8zw46qctJNPZ+TER0wJwU9mtN2Sc+erAWlk4EX2RqgvdtHDrFzxqOz3hCyA/c0Zjew9SKoKj0XTYiTHlFZRK2wW8YvJb9E6+mP8e++eA0hUmt0GPsb3LC9INe2swJ09/VKW4TQF2eGni5ndZHbqON/HukujrFxbMNJ9859/Mbnm489sJJobzUWHiZsEFVCS+MZ6IyjgiVsan4s8f2+4TCWONojKZkruXm4eQpzyZGjrSFSSjR280I+YF1EjfpDzrFTzPvGnley9wvKsdPVZjkpQrb9Ij8sZVKEDqZlrPf0en493h1sJ3XMl8DjHdJ9SR+6gVSy7yXROXYlUHoEUBSIbYS7lW7kjSjlHGQ2o8YxwcXawHEYHrHBse5L0QQvSo6HT9P5if/WZTf/VQYRJLD+6fIJ13xlMy1rEGMjgEGROXY75PZ/acrTOp6iZ/yZhh07JD4qSMKk/qJkE+fAuAHKOglDEmlxSaJa3kkIR/9QYiqC0mSIK0a1aorJIbTg1L3ayUbSIQIVcPVHatT3FRJmPKkkB+4PgiBhHx0niSe+Gedjl9g3jFeTMh9F0n85KuyyVP2BWnbC2SuZRjALYI6dAZtKNtKKsToWE6Y/u25V214tOGtR5IhkCSt9D0olQqqVVdIDGcTSmNDmqtsP0KEiqAA5MsU8zLX9Atey9x++MFlMb+NC/n+q2R+0vM6xc9EQZd5LXsTQM3PCdOfqb7L1UHmWvYd/O21lxaNqFlnuSRMvUydcfELjcd3zgpIyrnSDxYvUkCWX3WFpKZsL7ZPCiqL1JUINQGVzB04nS6oW2Bat0lVoDCpWzqW/fL+1JFtrJdGDz+4LMZqw7fIbNPDeoxN0EZ+l6AOdipM8h4ARnjd94e25VsKOsVtonXl47Q+ssNZrjCpM4ZbztohqINBxHznZLUYRhjqCsmbYoWXk3ThoOpKF0yPxy6UekJ2Fcsmott3TfFy9rkAoBvuAXoRPILKJmbt02Ps1byaXkgb8ituFVVaXDkybeEjjcd3lo3mTB3Zxp68ZON/qEzD7YjFQBvKnTrFnSdzk14Pv/vVQafjB4S3Hv00q0t3wsHIdEqYqjINTwv5/r+pomnSRLUkgUGU7iHxq664qSkAWaKpVlVZBTNk/gmYMQWk9+oslj1RrOvFRewGK27B7fLirm22tbMO7tGzS4pl1vt5Za4W89zlsX4lNAMYAPn9rPfoLvNsue9V7hog0PON920cCtv0QuLos528NnQzCrpMqqzS4uXDzWc+nsq8kSKVNw7sToxM/dR/KmzTCgBpVpcX6xT/bQBa0I6GjVzHUk2lxW8L+f7FtJHP2Mv0GJtU2dR/C/kBv5OBtIrZVQjS5jOvNJoJdS01xUmnXH8q0XgCZli8n2c7YA7yboyPXaULJiPwOyG6YDICLyH664s/OxGO4XkVzG81iPq6XC0GG0hSHGMczcy4RFWYxnWCmv4kbSgvkx7Q6finc4n2pxqkw5Ps91OZv7RKjR97UmUSl9GGspfXsueotPhfQTpXD8hc66MNQ68v4LXsXvt9PcZyMtv4EK8NfcFHc5UYRxB1pZyaYtFxqit+BngnzEkUZEAtgcl46qkGrCrSDMKw1hTbKIetGP1fBpGuLFj2LTvz94pBmO7aai5LMg3E/IheFZlrfbVh8JVzeS2zgWSS0Ol454gw+VlR7jsBABIj70zNNbQ/o9LiuawuPSuOvHO+wiT/GqRj9cRQ87w3+L4d5/Ja5g9jCmI0rTCNm3k17dWzVIlxkIykS+Bt0JMmtNNT45Q6vE5gS2Ig1d8EYCnGDr4WmLEGJCmnE/WTPJbAfdPgegCLUDpx3NIOdMFdNbBgfe+gjKMLo9+aFINTK3Ta6AZKveDqjh1qna8oTOqrQj59NQr6sLNcp4RTFa75eVHumx0rqBqAAq9lHxLTr1+STcwaCNKp8UBmxiVDzKE/Xslq2TsczJJWmOTPeTX9JQ/NVGIcAHmgVBqIJG9KD6Htal2yJKbRAzMAaTVK+zwIc2LOxqgIb0cn/O0CtgKe3C4SjQ4XGtsxythIk8NiKEtRutIvQXl1x/oOHQjGPKxne1E/xmEtDs1FmoHSLlTcVi9zLVtE5dgC2pDfcpbpFDdL4ZqeU9nGaYnju87e133DNUOt8wNFfo4nch1LDZVJ/nNC7rvezOtRRIyOKWzTT3k1fWOFJpziH0l9IA2USuoByYhKasdNAiiHNYQ62+E9p8dakCf2EtR2n8VGlH6TTTCZghfRf6tL3XVwl9TsgXZhMI562jasxaEH5mIQCJ7ycUjCtNfEkaMLaEPZ6SzTKX66RovP5ps+1tm2fIuLS/eDhZww/X5ROnwFbch2SSumsKkNvJq+2eUx0upOmsi98K+ukAapV8ZRTl1pRukK2wtzNfYCaxVzW6VrtXmtE2QJzO+EcHvGi9SxBNXZciyjqL2tWsPyHln/28Bh7J4T+WQTs94Vc29dxOrSY84yneJaVCb1pJDvr8vu2nog2zD7jw1Df/kMq2Vte10oKGzTHbya/hEhIM6LmmLBj7riVU1xo1ducNsHsYW1qDywrIRE5dyw1upfC1sHiWa1+Va2olSlKcfI12P0+1QjddhTSYaVCa4cLA/KIMxvFApNXxnAssk5kpjd9zm6oD7gLNMprsF0YfZ/NoyOTQQMNc/bLfa/dB6vZt6w31fYpm+0L9v8UCrzRtx2u1wMhxNuxjkSvKopbvTKMQ7nwPeic6+BGQvgpoZYas5qkFW1MECKng0yIZwqA4lZ22F9I7+qWIet3XpIG6swKj2Fmu/Wd+rAoaazNGrPfdexWnazs0yPsbzKpn4n5I9fG0rvxgGJkbdTrJbbxmvZLezLG+ihqRcc5I/tXMir6efs9XQ6vmwkcdL/iMqxmcVbpBXKbTCTNqW5BYORBrCbRZw0UcsxDiezKzeYV8FkGG4xDz0wJYxFqG2+02aQbTJBQHq+3HezG0n9uK/tRtFa2ze6MGo8Xhs2vapyjqof/4quMsm/57Whf3OW6TGWltnmzayWvSl49+oLXhuaKfNTnleZxCID1HSxbaEAAJkTugaYw9suEfIDYyaWSouflPjJu3ktsxj+VBWgdJK6rXJOqYDEdMrRdDOOum3GI9HfD7Ix0qK3GqaUUY/s6n6/sxeQ3OTlGIddwvGjrlgSSq2lDcv2BJgMg2S8DoQgyYoL+7pXfZnXMj8uKYnRMZVJ3s1r2XvZlzfUKtNWqBDyx8/RaPH/dIo7k9Vyj4vp1y4davlEzirPdSyV//rwl64WlffucbhrW1Ew1sOfqgJ4iyIl6dqVBp1XdYV0zy6tdME0qrnFdwzCXMlmo/6Rj6S+BIUfSQ0YfWevjMNuTK0l42jGqNt1O0LwoJAQKNNX2/ItBQX4Oq+mhxU2dYuTDylM8p/YM25oE/ID1xS3t09I8FrmOpmbdB+AOK9lf8337bh+aMYlJSkI25ZvMSTgJlF+96DET/5XxGgaADRaOBlAxlG9kn5vSQ52hmOpK4O2v52otKr3oHQwWxZ1L3CeB0PCephM46OMTTDtB80wJYlKzNP6npUkxqDohvn/tlTH9/HA/95eUvm52SX3VgKwZ8a7rXhvs71SKMcjKGzTrUI+fSNglJxhotLilSrTsENU+sY7m3oJEvJRgdWljQqT2gwgLirH7t7XfcN1GQLTsEMSpm0Q88eXoKBLAKBTAgWgyVHNy0StpK6QjJeVBh2JWXkV75uL991W200YDa5yg7UZbI3tChOk9xuP/TH2TYt+AvhqKW1sLNLx41K3Yx6AXwL4XvFqhzmu73FWDO1cFZlruVfID1xNF9SSDXI6xZ2hsM1/FvIDl4VFLygapEPzZbapR6XFVXRB1YX8wI0SP/mbXmNRJH7q73ktexEKOjG3KbwxjnLqih9vSiW6Xg23lvTjZAxbMeopKSdF2Q2X1g7VMPZ12FFNkFutYP0/uir0oR4b2tYU6QRxu9oZRBrA1wF8FaWLYrgHMsncpIcF5fjFtJEvyfOpU1yTzLU8xurSjxr7d/Fh0vWDZPZNVlAHbxuJT9+h0/HTaCOfEeT3rpC5lnv9tqWwTTtpI7+ALmikvKZe/nGkeAyLYXjZm+LWphNug5oUiAaYDG1T8acVnu1FvK60Ec8NfiQGkiFzvHKCeN34ZpVtRW3c01aqAMBk7tWoQhcWLwuW7fJrpMqhn+SWE6bv4NWhc1hdeolET6XFbww3n7FTyB8/PWzalSAqfZ+REu0vymzzd/QYy9CG/GZc6VuQi894vNo2dTp+QI9RpHM0vXJ8N3XFGSPgRU0BRjOO2eGmejhp2/dgrIbJNPx4SkhqifN5rxJROTj7TYokrRcqbXyzb8OvhZpi37OzNgCNX9p+PwjgJzAlkBJpA6jREZASP/mwIL39KVaXNpPKdUo4S+Ym7Wa13Pp6HASVGDkyh9Wl30n81Kd1ijsdAHgt+4eGzJvnDsfb3qj0fGWMPRumiGoZB2CuHtWoKW603c562QTyXo1qbAakrFq9IDMeJ02/k570LdzcxbWGpXq4bXyzx26E7a628qc0I5jbdSVMe4aF22AyjJVuD9Ts7Nhsco6k0uIXhXz/P9AFdYRQhVOZxLeGU3P/wmvZLyR6u0M/yyUx8vZprJb9VS4+/TWVFq8CEKMLqibkj6/d133DFUNNZ6VDIhUktoCkrpDa88M4SJKJm0vVOdjsMQBe0QVyYJibEZX0vn6YBymAqpp+hwE7QyjHOGph27Bc5UHcrk7j50swPSjt5R6q+aHTMtf6C1F6ez5tyLtJ5TrFz1CY5K/l9sV7eTX95cb0HiEIvURvNyfk+z/ParltufgJr6pMcgVAMQBAG8pBQX7vIpmbtD7kDXkOG4JxKLbrrjJJoEtQiSm4JTt2g5/Q8/WEtq3MWF6MjlYiHSe2wv293CQGP5vGSPlArH57bcduGwgCu5HULvWsKvalFkZRy4NS4nb1Cafx8+teHqrLafXZxKzXxdyhBbya/j5dUIkTSqe4DoVt+ulwau5RUXnvV8nh/Vcmers9MZHGYy9MF/L9y3gt8yu5fXGfzLU+rDKJRQBV3IhmgNWlf08M9348F5/xfHhvBoA4SKk3C/O/lSu974pKIqzfQefVJWuBZIW3MoJtROlKau2qtcqdsKJJ3eB2gNR+eE9rZ3kPnOjEaKQraS+JlYB5P0ZjHoLCUvmsmA4LdmNzmEZRy4PSi2BMowljjZ/PFK+KqNlRj05kk3NUALcmRo5syXPNG1VaPJ9UT6f4JomfsgL8lBW0eGKe14ZeB/BKzNDfAQppoFAoxBhRo8UmwJgDUHOHJp07CzFygCpt5A/wavorEj/lMTV1qqe+HnrAuwt85jXdpIHn16ptDSw3Hd2vbuxVVbFgDUBS2r9V8LeZy2qr3ETphSkxkFZ7UuyHW84Pa7UlSTxWn/0kFAqCrUWaS2D2tVYb2iymPQjvuUfc4DR+ftHrg3VjHBZy8RmvHn5w2cJT/u5nV6tMYp1OCTPd6uoUz+kUPw9mYIov0EY+QxW0H8b7d9+dmbKQZGMJC5VCt71iPcgTqRqjWjWxDr0wYzW6Ub2HYju853tYD3I+kGpozofJIMbz9LpNMBlHJ0zmYfUl7Cxf1jaEXgTbo9OOscbPzTC9KZ5QF1XFibblWwoy1/pQw+Crc3ht6EZaHzkSVtusLh3jtey/iNLb7Sotfr/GTAPwtyu2HEinsQHVhXb7cck6n7PiNvy8g6Wa+F0B11ZBiwQrzWE13yqsnBg9GGXw9uRGYds2rP52wOfRCNcsuPX96/DUkw7Y2rSCvTxjXBiHBTOvaeO91Ks/70gO718h5Ad2oFAStV4ZBV0X8v1PJrN7r9Vf+lmbwiS/m23oqNdhvaTVuZrBaOnsPY6/q12tnOqKnyMht8LcvLYI7nkceoplixBso5uTVpDVeT3MHKWr4Z6QyNqctxZm+HyYm8CWYqx0uB7h70zdDm/JllzRJfeirW9MJtAfw2QenhFrW06KXRo/NEiH5o4I0z6LWOxvAZyvx1iiOkUb+eOUkX+SgvEnbuTdP2aTc46G1Qc/No4IET4oeG72mdavL2JU/T8I4GyUMo4LATxt+3tMxru62zgqYVicuRfAXQDuSh56NG5M/sRphRh9ms6ITSgYlEFxR1DQ9/R237CvbfkWAwCUJPF8qAgRIpRiJcbaDG+DT2kDmICMw47szCtG4LINeaJJShEifEDwXdvvVrCXb0xoxhEhQoRQsRhjI0IPYiwjsaPd8feYerFC4UNxokGECBEq4LnZZ34XZp6NwBhXr0qECBHqipJD1apFpKpEiPDRwWaYkaJejjBpwlgj6jP2wkhViRDhIwKbO9YLLkQZd2ykqkSIEME3IsYRIUIE34gYR4QIEXwjYhwRIkTwjcirEiFCBBLSKJPU5/8B11FP6b8S6U4AAAAASUVORK5CYII=", 'PNG', 20, 20, 100, 21);
            //jsdoc.setFontSize(10);
            //jsdoc.text(150, 25, "Chromosome: Location");
            //jsdoc.setFontSize(14);
            //jsdoc.text(150, 40, $('#chromosome-selector').val() + ' : ' + $('#text-location').val());
            jsdoc.setTextColor(0, 0, 0);
            jsdoc.setFontSize(10);

            //if(self._workspaceId != null ) {
            //  jsdoc.text(350, 25, "Workspace ID");
            //  jsdoc.setTextColor(0, 0, 255);
            //  jsdoc.setFontSize(16);
            //  jsdoc.text(350, 45, s_url);
            //}

            //jsdoc.setFontSize(14);
            //jsdoc.text(350, 40, $('#save-workspace-text').val());
            jsdoc.addImage(image, 'PNG', 15, 55);
            jsdoc.save(filename);

        }
        else {

            if (navigator.msSaveBlob) {
                // IE 10+
                var image_blob = canvas.msToBlob();
                var blob = new Blob([image_blob], {type: "image/png"});
                navigator.msSaveBlob(blob, filename);
            }
            else {
                var blob = new Blob([image], {type: "image/png"});
                var link = document.createElement("a");

                if (link.download !== undefined) {
                    // check if browser supports HTML5 download attribute
                    var url = URL.createObjectURL(blob);
                    link.setAttribute("href", image);
                    link.setAttribute("download", filename);
                    link.style = "visibility:hidden";
                    link.setAttribute("target", "_blank");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                else {
                    var image_octet = image.replace("image/png", "image/octet-stream");
                    window.open(image_octet);
                }
            }

            //$(container).css("overflow", "auto");

            // remove all changes made to the DOM
            container.find('.tempCanvas').remove();
            svgElems.each(function () {
                $(this).show();
            });
        }
    });
};

// Input 86
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 12:56 PM
 */

goog.provide('epiviz.ui.ControlManager');

goog.require('epiviz.utils');
goog.require('epiviz.Config');
goog.require('epiviz.events.Event');
goog.require('epiviz.ui.controls.DatasourceGroupWizardStep');
goog.require('epiviz.datatypes.GenomicRange');
goog.require('epiviz.ui.charts.VisualizationType');
goog.require('epiviz.ui.controls.VisConfigSelection');
goog.require('epiviz.ui.controls.MeaurementsWizardStep');
goog.require('epiviz.ui.controls.Wizard');
goog.require('epiviz.ui.controls.ComputedMeasurementsDialog');
goog.require('epiviz.ui.tutorials');
goog.require('epiviz.ui.PrintManager');
goog.require('epiviz.ui.controls.MessageDialog');
goog.require('epiviz.events.EventListener');

// goog.require('epiviz.ui.charts.Chart');
// goog.require('epiviz.ui.charts.ChartFactory');
// goog.require('epiviz.ui.charts.ChartManager');
// goog.require('epiviz.workspaces.WorkspaceManager');

/**
 * @param {epiviz.Config} config
 * @param {epiviz.ui.charts.ChartFactory} chartFactory
 * @param {epiviz.ui.charts.ChartManager} chartManager
 * @param {epiviz.measurements.MeasurementsManager} measurementsManager
 * @param {epiviz.ui.LocationManager} locationManager
 * @constructor
 */
epiviz.ui.ControlManager = function(config, chartFactory, chartManager, measurementsManager, locationManager) {

  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {epiviz.ui.charts.ChartFactory}
   * @private
   */
  this._chartFactory = chartFactory;

  /**
   * @type {epiviz.ui.charts.ChartManager}
   * @private
   */
  this._chartManager = chartManager;

  /**
   * @type {epiviz.measurements.MeasurementsManager}
   * @private
   */
  this._measurementsManager = measurementsManager;

  /**
   * @type {epiviz.ui.LocationManager}
   * @private
   */
  this._locationManager = locationManager;

  // Events

  /**
   * @type {epiviz.events.Event.<{type: epiviz.ui.charts.ChartType, visConfigSelection: epiviz.ui.controls.VisConfigSelection}>}
   * @private
   */
  this._addChart = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{oldValue: {id: string, name: string}, newValue: {id: string, name: string}}>}
   * @private
   */
  this._activeWorkspaceChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{name: string, id: ?string}>}
   * @private
   */
  this._saveWorkspace = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event}
   * @private
   */
  this._deleteActiveWorkspace = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event}
   * @private
   */
  this._revertActiveWorkspace = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event}
   * @private
   */
  this._loginLinkClicked = new epiviz.events.Event();

  /**
   * Fired whenever the user clicks or searches through the workspaces textbox
   *
   * @type {epiviz.events.Event.<{searchTerm: string, callback: function(Array.<epiviz.workspaces.Workspace>)}>}
   * @private
   */
  this._searchWorkspaces = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{searchTerm: string, callback: function(Array.<{probe: string, gene: string, seqName: string, start: number, end: number}>)}>}
   * @private
   */
  this._search = new epiviz.events.Event();

  // Selection

  /**
   * @type {?{id: string, name: string}}
   * @private
   */
  this._activeWorkspaceInfo = null;

  /**
   * @type {number}
   * @private
   */
  this._stepRatio = config.navigationStepRatio;

  /**
   * @type {number}
   * @private
   */
  this._zoominRatio = config.zoominRatio;

  /**
   * @type {number}
   * @private
   */
  this._zoomoutRatio = config.zoomoutRatio;
};

/**
 * @type {Object.<epiviz.ui.charts.VisualizationType.DisplayType, string>}
 * @const
 */
epiviz.ui.ControlManager.CHART_TYPE_CONTAINERS = {
  'plot': 'feature-view',
  'track': 'location-view',
  'data-structure': 'data-structure-view'
};

/**
 * @type {Object.<epiviz.ui.charts.VisualizationType.DisplayType, string>}
 * @const
 */
epiviz.ui.ControlManager.DISPLAY_TYPE_LABELS = {
  'plot': 'Feature',
  'track': 'Location',
  'data-structure': 'Data Structure'
};

epiviz.ui.ControlManager.prototype.initialize = function() {

  /*
   * Toolbar
   */
  this._initializeChromosomeSelector();
  this._initializeLocationTextbox();
  this._initializeNavigationButtons();
  this._initializeZoomButtons();
  this._initializeLocationSettingsDialog();
  this._initializeChartMenus();
  this._initializeComputedMeasurementsMenu();
  this._initializeHelpButton();
  this._initializeSearchBox();
  this._initializeWorkspaceSaving();
  this._initializeTutorials();
  this._initializeScreenshotMenu();

  /*
   * Log in/out
   */
  this._initializeLoginLink();

  /*
   * Layout
   */
  this._initializeLayout();

  /*
   * Browser compatibility
   */
  this._checkBrowserCompatibility();

  // Register for events

  this._registerLocationChanged();

  this._registerSeqInfosUpdated();

};

/**
 * @returns {epiviz.events.Event.<{type: epiviz.ui.charts.ChartType, visConfigSelection: epiviz.ui.controls.VisConfigSelection}>}
 */
epiviz.ui.ControlManager.prototype.onAddChart = function() { return this._addChart; };

/**
 * @returns {epiviz.events.Event.<{oldValue: {id: string, name: string}, newValue: {id: string, name: string}}>}
 */
epiviz.ui.ControlManager.prototype.onActiveWorkspaceChanged = function() { return this._activeWorkspaceChanged; };

/**
 * @returns {epiviz.events.Event.<{name: string, id: ?string}>}
 */
epiviz.ui.ControlManager.prototype.onSaveWorkspace = function() { return this._saveWorkspace; };

/**
 * @returns {epiviz.events.Event}
 */
epiviz.ui.ControlManager.prototype.onDeleteActiveWorkspace = function() { return this._deleteActiveWorkspace; };

/**
 * @returns {epiviz.events.Event}
 */
epiviz.ui.ControlManager.prototype.onRevertActiveWorkspace = function() { return this._revertActiveWorkspace; };

/**
 * @returns {epiviz.events.Event}
 */
epiviz.ui.ControlManager.prototype.onLoginLinkClicked = function() { return this._loginLinkClicked; };

/**
 * @returns {epiviz.events.Event.<{searchTerm: string, callback: (function(Array))}>}
 */
epiviz.ui.ControlManager.prototype.onSearchWorkspaces = function() { return this._searchWorkspaces; };

/**
 * @returns {epiviz.events.Event.<{searchTerm: string, callback: (function(Array.<{probe: string, gene: string, seqName: string, start: number, end: number}>))}>}
 */
epiviz.ui.ControlManager.prototype.onSearch = function() { return this._search; };

/**
 * @param {Array.<epiviz.datatypes.SeqInfo>} seqInfos
 * @private
 */
epiviz.ui.ControlManager.prototype._updateSeqNames = function(seqInfos) {
  var chromosomeSelector = $('#chromosome-selector');
  var optionFormat = '<option value="%s"%s>%s</option>';
  chromosomeSelector.empty();
  for (var i = 0; i < seqInfos.length; ++i) {
    var option = sprintf(
      optionFormat,
      seqInfos[i].seqName,
      (this._locationManager.currentLocation() && seqInfos[i].seqName == this._locationManager.currentLocation().seqName()) ?
        'selected="selected"' : '', seqInfos[i].seqName);
    chromosomeSelector.append(option);
  }
  chromosomeSelector.selectmenu();
};

/**
 * @param {epiviz.measurements.MeasurementSet} measurements
 */
/*epiviz.ui.ControlManager.prototype.updateMeasurements = function(measurements) {
  this._measurements = measurements;
};*/

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @private
 */
epiviz.ui.ControlManager.prototype._updateSelectedLocation = function(range) {
  if (!range) { return; }

  this._locationManager.changeCurrentLocation(range);
  range = this._locationManager.currentLocation();

  var locationTextBox = $('#text-location');
  locationTextBox.val(Globalize.format(range.start(), 'n0') + ' - ' + Globalize.format(range.end(), 'n0'));

  var chromosomeSelector = $('#chromosome-selector');
  chromosomeSelector.val(range.seqName());
  chromosomeSelector.selectmenu();
};

/**
 * @param {{id: string, name: string}} workspaceInfo
 */
epiviz.ui.ControlManager.prototype.updateSelectedWorkspace = function(workspaceInfo) {
  var self = this;
  var saveTextBox = $('#save-workspace-text');
  var oldValue = this._activeWorkspaceInfo;
  saveTextBox.val(workspaceInfo.name);
  this._activeWorkspaceInfo = workspaceInfo;
  var args = {oldValue: oldValue, newValue: workspaceInfo, cancel: function() {
    saveTextBox.val(oldValue.name);
    self._activeWorkspaceInfo = oldValue;
  }};
  this._activeWorkspaceChanged.notify(args);
};

epiviz.ui.ControlManager.prototype._initializeChromosomeSelector = function() {
  var chromosomeSelector = $('#chromosome-selector');
  chromosomeSelector.selectmenu({
    style:'popup',
    width:'90',
    maxHeight:'100',
    menuWidth:'90'
  });

  var self = this;
  chromosomeSelector.change(function () {
    var currentLocation = self._locationManager.lastUnfilledLocationChangeRequest() || self._locationManager.currentLocation();
    var seqName = $(this).val();
    self._updateSelectedLocation(new epiviz.datatypes.GenomicRange(
      seqName,
      currentLocation.start(),
      currentLocation.width()));
  });
};

epiviz.ui.ControlManager.prototype._initializeLocationTextbox = function() {
  var self = this;
  var locationTextBox = $('#text-location');
  locationTextBox.keypress(function(event) {
    if (event.which != 13) { return true; }

    try {
      var location = $(this).val();
      var startEnd = location.split('-');

      var start = Globalize.parseInt(startEnd[0]);
      var end = Globalize.parseInt(startEnd[1]);

      var currentLocation = self._locationManager.lastUnfilledLocationChangeRequest() || self._locationManager.currentLocation();
      self._updateSelectedLocation(
        epiviz.datatypes.GenomicRange.fromStartEnd(currentLocation.seqName(), start, end));

      return true;
    } catch (error) {
      return false;
    }
  });
};

epiviz.ui.ControlManager.prototype._initializeNavigationButtons = function() {
  var self = this;
  $('#moveright').button({
    icons:{
      primary: 'ui-icon ui-icon-seek-next'
    },
    text:false
  }).click(
    function () {
      var currentLocation = self._locationManager.lastUnfilledLocationChangeRequest() || self._locationManager.currentLocation();
      var start = currentLocation.start() + Math.round(currentLocation.width() * self._stepRatio);
      self._updateSelectedLocation(
        new epiviz.datatypes.GenomicRange(currentLocation.seqName(), start, currentLocation.width()));
    });

  $("#moveleft").button({
    icons:{
      primary: 'ui-icon ui-icon-seek-prev'
    },
    text:false
  }).click(
    function () {
      var currentLocation = self._locationManager.lastUnfilledLocationChangeRequest() || self._locationManager.currentLocation();
      var start = currentLocation.start() - Math.round(currentLocation.width() * self._stepRatio);
      self._updateSelectedLocation(
        new epiviz.datatypes.GenomicRange(currentLocation.seqName(), start, currentLocation.width()));
    });
};

epiviz.ui.ControlManager.prototype._initializeZoomButtons = function() {
  var self = this;
  var zoomin = $('#zoomin');
  zoomin.button({
    icons:{
      primary:'ui-icon ui-icon-zoomin'
    },
    text:false
  });

  var zoomout = $('#zoomout');
  zoomout.button({
    icons:{
      primary:'ui-icon ui-icon-zoomout'
    },
    text:false
  });

  var zoomHandler = function(zoomRatio) {
    var currentLocation = self._locationManager.lastUnfilledLocationChangeRequest() || self._locationManager.currentLocation();
    var mid = currentLocation.start() + currentLocation.width() * 0.5;
    var width = Math.round(currentLocation.width() * zoomRatio);
    var start = Math.round(mid - width * 0.5);
    self._updateSelectedLocation(
      new epiviz.datatypes.GenomicRange(currentLocation.seqName(), start, width));
  };

  zoomin.click(function() { zoomHandler(self._zoominRatio); });
  zoomout.click(function() { zoomHandler(self._zoomoutRatio); });
};

epiviz.ui.ControlManager.prototype._initializeLocationSettingsDialog = function() {
  // TODO: Remove location-settings-dialog div, and create it dynamically
  var self = this;
  $('#location-settings')
    .button({
      text: false,
      icons: {
        primary: 'ui-icon ui-icon-gear'
      }
    })
    .click(function() {
      $('#location-settings-dialog').dialog('open');
    });

  $('#location-settings-dialog').dialog({
    autoOpen: false,
    resizable: false,
    width: '300',
    buttons: {
      'Ok': function() {
        self._zoominRatio = $('#zoomin-ratio-text').val();
        self._zoomoutRatio = $('#zoomout-ratio-text').val();
        self._stepRatio = $('#navigation-step-ratio-text').val();
        $(this).dialog('close');
      },
      'Cancel': function() {
        $('#zoomin-ratio-text').val(Globalize.format(self._zoominRatio, 'n3'));
        $('#zoomout-ratio-text').val(Globalize.format(self._zoomoutRatio, 'n3'));
        $('#navigation-step-ratio-text').val(Globalize.format(self._stepRatio, 'n6'));
        $(this).dialog('close');
      }
    },
    modal:true
  });

  $('#zoomout-ratio-text').spinner({
    min: 1.001,
    max: 1000.000,
    step: 0.001,
    start: 1.200,
    numberFormat: 'n3'
  }).val(self._zoomoutRatio);

  $('#zoomin-ratio-text').spinner({
    min: 0.001,
    max: 0.999,
    step: 0.010,
    start: 0.800,
    numberFormat: 'n3'
  }).val(self._zoominRatio);

  $('#navigation-step-ratio-text').spinner({
    min:   0.000001,
    max:   1.000000,
    step:  0.000001,
    start: 0.200000,
    numberFormat: 'n6'
  }).val(self._stepRatio);
};

epiviz.ui.ControlManager.prototype._initializeChartMenus = function() {
  var self = this;
  var visMenu = $('#vis-menu');

  $('#vis-menu-button')
    .button({
      text: false,
      icons: {
        primary: 'ui-icon ui-icon-scatterplot', // 'ui-icon ui-icon-bookmark',
        secondary: "ui-icon-triangle-1-s"
      }
    })
    .click(function() {
      var menu = visMenu;
      var visible = menu.is(":visible");
      $('.dropdown-menu').find(">:first-child").hide();
      if (!visible) {
        menu.show().position({
          my: "left top",
          at: "left bottom",
          of: this
        });
      }
      else {
        menu.hide();
      }
/*      $( document ).one('click', function() {
        menu.hide();
      });*/
      return false;
    });

  /** @type {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<epiviz.ui.charts.ChartType>>} */
  var chartsByDisplayType = {};

  var displayTypeLabels = epiviz.ui.ControlManager.DISPLAY_TYPE_LABELS;

  this._chartFactory.foreach(
    /**
     * @param {string} typeName
     * @param {epiviz.ui.charts.ChartType} chartType
     */
    function(typeName, chartType) {
      if (!(chartType.chartDisplayType() in chartsByDisplayType)) { chartsByDisplayType[chartType.chartDisplayType()] = []; }
      chartsByDisplayType[chartType.chartDisplayType()].push(chartType);
    });

  for (var displayType in chartsByDisplayType) {
    if (!chartsByDisplayType.hasOwnProperty(displayType)) { continue; }
    $(sprintf('<li class="ui-widget-header">%s</li>', displayTypeLabels[displayType])).appendTo(visMenu);
    chartsByDisplayType[displayType].forEach(function(chartType, i) {
      var id = sprintf('%s-menu-add-%s', chartType.chartDisplayType(), chartType.chartHtmlAttributeName());
      visMenu.append(sprintf('<li><a href="javascript:void(0)" id="%s">Add New %s</a></li>', id, chartType.chartName()));

      $('#' + id).click(function() {
        var wizardSteps = [];
        if (chartType.isRestrictedToSameDatasourceGroup()) {
          wizardSteps.push(new epiviz.ui.controls.DatasourceGroupWizardStep());
        }
        if (chartType.chartDisplayType() != epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) {
          wizardSteps.push(new epiviz.ui.controls.MeaurementsWizardStep());
        }

        if (!wizardSteps.length) {
          self._addChart.notify({
            type: chartType,
            visConfigSelection: new epiviz.ui.controls.VisConfigSelection(
              self._measurementsManager.measurements().subset(chartType.measurementsFilter()))});
          return;
        }

        var wizardMeasurements = self._measurementsManager.measurements().subset(chartType.measurementsFilter());
        wizardMeasurements.addAll(self._measurementsManager.measurements()
          .map(function(m) { return m.datasource(); })
          .subset(chartType.measurementsFilter()));
        var dialog = new epiviz.ui.controls.Wizard(
          sprintf('Add new %s', chartType.chartName()),
          {finish:
            /** @param {epiviz.ui.controls.VisConfigSelection} data */
            function(data) {
              self._addChart.notify({type: chartType, visConfigSelection: data});
            }
          },
          wizardSteps,
          new epiviz.ui.controls.VisConfigSelection(
            wizardMeasurements, // measurements
            undefined, // datasource
            undefined, // datasourceGroup
            undefined, // dataprovider
            undefined, // annotation
            chartType.chartName(), // defaultChartType
            chartType.minSelectedMeasurements()),
          '750', undefined, // size of dialog
          chartType.isRestrictedToSameDatasourceGroup()); // showTabs
        dialog.show();

        visMenu.hide();
      });
    });
  }

  visMenu.hide().menu();
};

epiviz.ui.ControlManager.prototype._initializeComputedMeasurementsMenu = function() {
  var self = this;
  $('#computed-measurements-button')
    .button({
      text: false,
      icons: {
        primary: 'ui-icon ui-icon-calculator'
      }
    })
    .click(function() {
      var dialog = new epiviz.ui.controls.ComputedMeasurementsDialog(
        'Computed Measurements',
        {
          add: function(measurement) {
            self._measurementsManager.addMeasurement(measurement);
          },
          remove: function(measurement) {
            self._measurementsManager.removeMeasurement(measurement);
          },
          close: function() {}
        },
        self._measurementsManager.measurements(),
        self._chartManager.chartsMeasurements()
      );

      dialog.show();
    });
};

epiviz.ui.ControlManager.prototype._initializeHelpButton = function() {
  $('#help-button').button({
    text: false,
    icons: {
      primary: 'ui-icon ui-icon-help'
    }
  }).click(
    function() {
      var win=window.open('http://epiviz.github.io/', '_blank');
      win.focus();
    });
};

epiviz.ui.ControlManager.prototype._initializeTutorials = function() {
  var self = this;

  var tutorialMenu = $('#help-tutorials');

  var tuts = new epiviz.ui.tutorials();

  var tMenu = '<div class="dropdown-menu">' +
      '<ul id="tutorial-list">' +
      '<li class="ui-widget-header">Tutorials</li>';

  if(tuts._tutorialList.length > 0) {
    tuts._tutorialList.forEach(function(t) {
      tMenu += '<li><a href="javascript:void(0);" id="' + t.id +'">' + t.name + '</a></li>';
    });
  }
  else {
    tMenu += '<li>No Tutorials available</li>';
  }

  tMenu += '</ul>' +
      '</div>';

  $(sprintf(tMenu)).insertAfter(tutorialMenu);

  var tutorialList = $('#tutorial-list');

  tutorialList.hide().menu();

  tutorialMenu.button({
    icons:{
      primary:'ui-icon ui-icon-info',
      secondary: "ui-icon-triangle-1-s"
    },
    text:false
  })
  .click( function() {

    var visible = tutorialList.is(":visible");
    if (!visible) {
      tutorialList.show().position({
        my: "left top",
        at: "left bottom",
        of: this
      });
    }
    else {
      tutorialList.hide()
    }
    return false;
  });

  if(tuts._tutorialList.length > 0) {
    tuts._tutorialList.forEach(function(t) {
      $('#' + t.id).click(function() {
        var anno = new Anno(t.tutorial);
        anno.show();
        tutorialList.hide();
      });
    });
  }
};

epiviz.ui.ControlManager.prototype._initializeScreenshotMenu = function() {
  var self = this;

  var savePageButton = $('#save-page');

  savePageButton.button({
    icons:{
      primary:'ui-icon ui-icon-print'
    },
    text:false
  })
  .click( function() {

    self._saveWorkspace.notify({name: name, id: name == self._activeWorkspaceInfo.name ? self._activeWorkspaceInfo.id : null});

    savePageButton.append(sprintf('<div id="loading" title="printing workspace">' +
        '<p>Save/Print the existing EpiViz workspace.</p>' +
        '<div style="position:absolute; right:15px;">' +
        '<select class="screenshot-file-format">' +
          '<option value="pdf" selected="selected">PDF</option>' +
          '<option value="png" >PNG</option>' +
        '</select>' +
        '</div>' +
        '</div>'));

    savePageButton.find("#loading").dialog({
      resizable: false,
      modal: true,
      title: "Print workspace as image",
      buttons: {
        "Print": function () {

          // hide the dialog box from the UI so that its not in the screenshot
          $(this).dialog('close');

          var format = $('.screenshot-file-format option:selected').val();
          var timestamp = Math.floor($.now() / 1000);

          var workspace_id = self._activeWorkspaceInfo.id;
          var pm = new epiviz.ui.PrintManager('pagemain', "epiviz_" + timestamp, format, workspace_id);
          pm.print();

          $(this).dialog('destroy').remove();
        },
        "cancel": function () {
          $(this).dialog('destroy').remove();
        }
      }
    }).show();
  });

};

epiviz.ui.ControlManager.prototype._initializeSearchBox = function() {
  var self = this;

  var searchBox = $('#search-box');
  searchBox.watermark('Find Gene/Probe');

  searchBox.autocomplete({
    source: function(request, callback) {
      self._search.notify({ searchTerm: request.term, callback:
        /**
         * @param {Array.<{probe: string, gene: string, seqName: string, start: number, end: number}>} results
         */
        function(results) {
          var items = [];
          for (var i = 0; i < results.length; ++i) {
            items.push({
              value: results[i].probe || results[i].gene,
              label: results[i].probe || results[i].gene,
              html: results[i].probe ?
                sprintf('<b>%s</b>, %s, [%s: %s - %s]',
                  results[i].probe, results[i].gene, results[i].seqName,
                  Globalize.format(results[i].start, 'n0'), Globalize.format(results[i].end, 'n0')) :
                sprintf('<b>%s</b>, [%s: %s - %s]',
                  results[i].gene, results[i].seqName,
                  Globalize.format(results[i].start, 'n0'), Globalize.format(results[i].end, 'n0')),
              range: epiviz.datatypes.GenomicRange.fromStartEnd(results[i].seqName, results[i].start, results[i].end)
            });
          }

          callback(items);
        }});
    },
    minLength: 1,
    select: function(event, ui) {
      var currentLocation = self._locationManager.lastUnfilledLocationChangeRequest() || self._locationManager.currentLocation();
      var seqName = ui.item.range.seqName();
      var start = Math.round(ui.item.range.start() - ui.item.range.width() * 11);
      var width = ui.item.range.width() * 22;
      self._updateSelectedLocation(new epiviz.datatypes.GenomicRange(seqName, start, width));
    },
    focus: function(event) {
      event.preventDefault();
    },
    open: function() {},
    close: function() {}
  }).data('autocomplete')._renderItem = function(ul, item) {
    return $('<li></li>')
      .data( 'item.autocomplete', item )
      .append(sprintf('<a>%s</a>', item.html))
      .appendTo(ul);
  };
};

epiviz.ui.ControlManager.prototype._initializeWorkspaceSaving = function() {
  var self = this;

  var saveTextBox = $('#save-workspace-text');
  var saveWorkspaceButton = $('#save-workspace-button');
  var revertWorkspaceButton = $('#revert-workspace-button');
  var deleteWorkspaceButton = $('#delete-workspace-button');

  saveWorkspaceButton.button({
    text: false,
    icons: {
      primary: 'ui-icon-disk'
    }
  }).click(function() {
    var dialog = null;

    try {
      var name = saveTextBox.val();
      var pattern = /[a-zA-Z0-9_\s]+/g;

      var result = pattern.exec(name);

      if (result == name) { // Name is good.

        if (!epiviz.workspaces.UserManager.USER_STATUS.loggedIn) {
          dialog = new epiviz.ui.controls.MessageDialog(
            'User not logged in',
            {
              Yes: function() { self._loginLinkClicked.notify(); },
              No: function() {}
            },
            'You need to log in in order to save the workspace. Do you wish to log in now?',
            epiviz.ui.controls.MessageDialog.Icon.QUESTION);
          dialog.show();
          return;
        }

        self._saveWorkspace.notify({name: name, id: name == self._activeWorkspaceInfo.name ? self._activeWorkspaceInfo.id : null});
      } else {
        dialog = new epiviz.ui.controls.MessageDialog(
          'Invalid workspace name',
          { Ok: function() { $(this).remove(); } },
          'Invalid workspace name: ' + name,
          epiviz.ui.controls.MessageDialog.Icon.ERROR);
        dialog.show();
      }
    } catch(error) {
      dialog = new epiviz.ui.controls.MessageDialog(
        'Error',
        { ok: function() { $(this).remove(); } },
        'An error occurred while trying to save workspace: ' + error.message,
        epiviz.ui.controls.MessageDialog.Icon.ERROR);
      dialog.show();
    }
  });

  deleteWorkspaceButton.button({
    text: false,
    icons: {
      primary: 'ui-icon-trash'
    }
  }).click(function(e) {
    // Delete the active workspace

    if (!epiviz.workspaces.UserManager.USER_STATUS.loggedIn) {
      // Only a logged in user can delete a workspace
      return;
    }

    var dialog = new epiviz.ui.controls.MessageDialog(
      'Delete active workspace',
      {
        Yes: function() { self._deleteActiveWorkspace.notify(); },
        No: function() {}
      },
      'Are you sure you want to delete the active workspace?',
      epiviz.ui.controls.MessageDialog.Icon.QUESTION);
    dialog.show();
  });

  revertWorkspaceButton.button({
    text: false,
    icons: {
      primary: 'ui-icon-arrowreturnthick-1-w'
    }
  }).click(function(e) {
    var dialog = new epiviz.ui.controls.MessageDialog(
      'Delete active workspace',
      {
        Yes: function() { self._revertActiveWorkspace.notify(); },
        No: function() {}
      },
      'Are you sure you want to revert the changes on the active workspace?',
      epiviz.ui.controls.MessageDialog.Icon.QUESTION);
    dialog.show();
  });

  saveTextBox.watermark('Save Workspace Name');

  saveTextBox.autocomplete({
    source: function(request, callback) {
      self._searchWorkspaces.notify({ searchTerm: request.term, callback: function(workspaces) {
        var items = [];
        for (var i = 0; i < workspaces.length; ++i) {
          items.push({
            value: workspaces[i].id,
            label: workspaces[i].name,
            html: sprintf('<b>%s</b> %s', workspaces[i].name, workspaces[i].id || '')
          });
        }

        callback(items);
      }});
    },
    minLength: 0,
    select: function(event, ui) {
      event.preventDefault();
      self.updateSelectedWorkspace({id: ui.item.value || saveTextBox.val(), name: ui.item.label});
    },
    focus: function(event) {
      event.preventDefault();
    },
    open: function() {},
    close: function() {}
  }).data('autocomplete')._renderItem = function(ul, item) {
    return $('<li></li>')
      .data( 'item.autocomplete', item )
      .append(sprintf('<a>%s</a>', item.html))
      .appendTo(ul);
  };

  saveTextBox.click(function() { saveTextBox.autocomplete('search', ''); });
};

/**
 * @private
 */
epiviz.ui.ControlManager.prototype._initializeLoginLink = function() {
  var self = this;
  $('#login-link').live({ click: function() {
      self._loginLinkClicked.notify();
  }});
};

/**
 * @private
 */
epiviz.ui.ControlManager.prototype._initializeLayout = function() {
  var layout = $('body').layout({
    applyDefaultStyles: true,
    east__size:    390,
    east__minSize: 390,
    east__initHidden: true,
    north__resizable: false,
    north__initHidden: false,
    south__initHidden: true,
    east__initClosed: true
  });
};

/**
 * @private
 */
epiviz.ui.ControlManager.prototype._checkBrowserCompatibility = function() {
  var ie = epiviz.utils.getInternetExplorerVersion();
  if (ie > 0) {
    var dialog = new epiviz.ui.controls.MessageDialog(
      'Browser compatibility warning',
      {
        Ok: function() {}
      },
      'EpiViz works best on Google Chrome, Apple Safari or Mozilla Firefox. Please open it using one of those browsers.',
      epiviz.ui.controls.MessageDialog.Icon.ERROR);
    dialog.show();
  }
};

/**
 * @private
 */
epiviz.ui.ControlManager.prototype._registerLocationChanged = function() {
  var self = this;
  this._locationManager.onCurrentLocationChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {{oldValue: epiviz.datatypes.GenomicRange, newValue: epiviz.datatypes.GenomicRange}} e
     */
    function(e) {
      self._updateSelectedLocation(e.newValue);
    }));
};

/**
 * @private
 */
epiviz.ui.ControlManager.prototype._registerSeqInfosUpdated = function() {
  var self = this;
  this._locationManager.onSeqInfosUpdated().addListener(new epiviz.events.EventListener(function(seqNames) {
    self._updateSeqNames(seqNames);
  }));
};

// Input 87
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/15/2014
 * Time: 9:07 AM
 */

goog.provide('epiviz.ui.charts.VisualizationProperties');

goog.require('epiviz.ui.controls.VisConfigSelection');
goog.require('epiviz.utils');
goog.require('epiviz.measurements.MeasurementSet');

/**
 * @param {number|string} [width]
 * @param {number|string} [height]
 * @param {epiviz.ui.charts.Margins} [margins]
 * @param {epiviz.ui.controls.VisConfigSelection} [visConfigSelection]
 * @param {epiviz.ui.charts.ColorPalette} [colors]
 * @param {Object.<string, string>} [modifiedMethods]
 * @param {Object<string, *>} [customSettingsValues]
 * @param {Array.<epiviz.ui.charts.CustomSetting>} [customSettingsDefs]
 * @param {Array.<epiviz.ui.charts.markers.VisualizationMarker>} [chartMarkers]
 * @constructor
 * @struct
 */
epiviz.ui.charts.VisualizationProperties = function(width, height, margins, visConfigSelection, colors, modifiedMethods, customSettingsValues, customSettingsDefs, chartMarkers) {
  /**
   * @type {number|string}
   */
  this.width = width;

  /**
   * @type {number|string}
   */
  this.height = height;

  /**
   * @type {epiviz.ui.charts.Margins}
   */
  this.margins = margins;

  /**
   * @type {epiviz.ui.controls.VisConfigSelection}
   */
  this.visConfigSelection = visConfigSelection;

  /**
   * @type {epiviz.ui.charts.ColorPalette}
   */
  this.colors = colors;

  /**
   * @type {Object.<string, string>}
   */
  this.modifiedMethods = modifiedMethods;

  /**
   * @type {Object.<string, *>}
   */
  this.customSettingsValues = customSettingsValues || {};

  /**
   * @type {Array.<epiviz.ui.charts.CustomSetting>}
   */
  this.customSettingsDefs = customSettingsDefs || [];

  /**
   * @type {Array.<epiviz.ui.charts.markers.VisualizationMarker>}
   */
  this.chartMarkers = chartMarkers || [];
};

/**
 * @returns {epiviz.ui.charts.VisualizationProperties}
 */
epiviz.ui.charts.VisualizationProperties.prototype.copy = function() {
  var visConfigSelection = new epiviz.ui.controls.VisConfigSelection(
    this.visConfigSelection.measurements ? new epiviz.measurements.MeasurementSet(this.visConfigSelection.measurements) : undefined,
    this.visConfigSelection.datasource,
    this.visConfigSelection.datasourceGroup,
    this.visConfigSelection.dataprovider,
    epiviz.utils.mapCopy(this.visConfigSelection.annotation),
    this.visConfigSelection.defaultChartType,
    this.visConfigSelection.minSelectedMeasurements);
  return new epiviz.ui.charts.VisualizationProperties(
    this.width, this.height,
    this.margins ? this.margins.copy() : this.margins,
    visConfigSelection,
    this.colors,
    this.modifiedMethods ? epiviz.utils.mapCopy(this.modifiedMethods) : this.modifiedMethods,
    this.customSettingsValues ? epiviz.utils.mapCopy(this.customSettingsValues) : this.customSettingsValues,
    this.customSettingsDefs ? this.customSettingsDefs.slice(0) : this.customSettingsDefs,
    this.chartMarkers.slice(0));
};


// Input 88
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/18/14
 * Time: 6:44 PM
 */

goog.provide('epiviz.ui.controls.SaveSvgAsImageDialog');

goog.require('epiviz.ui.controls.Dialog');

/**
 * @param {{ok: function(), cancel: function()}} handlers
 * @param {string} chartId The id of the chart being saved
 * @param {string} chartSaverLocation The location of the
 *   PHP server providing the SVG saving functionality
 * @constructor
 * @extends {epiviz.ui.controls.Dialog}
 */
epiviz.ui.controls.SaveSvgAsImageDialog = function(handlers, chartId, chartSaverLocation) {
  epiviz.ui.controls.Dialog.call(this, 'Save Chart SVG as Image', handlers);

  this._dialog = $('#' + this._id);

  this._dialog.append(
    '<div class="save-svg-dialog">' +
    '<label class="dialog-label">Choose file format:</label>' +
    '<br/><br/>' +
    '<div style="position:absolute; right:15px;">' +
      '<select class="svg-file-format">' +
        '<option value="pdf" selected="selected">PDF</option>' +
        '<option value="ps" >PS</option>' +
        '<option value="png" >PNG</option>' +
        '<option value="svg">SVG</option>' +
        '<option value="eps">EPS</option>' +
      '</select>' +
    '</div>' +
    sprintf('<form name="%s-svg-save-form" method="POST">', this._id) +
      '<div>' +
        '<input type="hidden" name="svg" />' +
        '<input type="hidden" name="format" />' +
        '<br/><br/>' +
      '</div>' +
    '</form>' +
  '</div>');

  /**
   * @type {string}
   * @private
   */
  this._chartId = chartId;

  /**
   * @type {string}
   * @private
   */
  this._chartSaverLocation = chartSaverLocation;

  var self = this;
  this._dialog.dialog({
    autoOpen: false,
    resizable: false,
    width: '200',
    buttons: {
      Ok: function() {
        var svg = $('#' + self._chartId).find('svg').clone();
        svg.attr('xmlns', 'http://www.w3.org/2000/svg');
        svg.attr('version', '1.1');

        var fileFormat = self._dialog.find('.svg-file-format');

        var form = document.forms[sprintf('%s-svg-save-form', self._id)];

        form.action = self._chartSaverLocation;
        form['svg'].value = $('<div>').append(svg).html();
        form['format'].value = fileFormat.val();
        form.submit();

        self._handlers.ok();
        $(this).dialog('close');
      },
      Cancel: function() {
        self._handlers.cancel();
        $(this).dialog('close');
      }
    },
    modal: true
  });
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.SaveSvgAsImageDialog.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Dialog.prototype);
epiviz.ui.controls.SaveSvgAsImageDialog.constructor = epiviz.ui.controls.SaveSvgAsImageDialog;

/**
 */
epiviz.ui.controls.SaveSvgAsImageDialog.prototype.show = function() {
  epiviz.ui.controls.Dialog.prototype.show.call(this);

  var self = this;
  if (this._dialog) {
    this._dialog.dialog('open');

    this._dialog.dialog('option', 'position', 'center');

    // This makes the dialog only able to open once:
    this._dialog.dialog({
      close: function(event, ui) {
        $(this).remove();
        self._dialog = null;
      }
    });
  }
};

// Input 89
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 11:24 PM
 */

goog.provide('epiviz.ui.charts.ChartManager');

goog.require('epiviz.events.Event');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');
goog.require('epiviz.utils');
goog.require('epiviz.ui.ControlManager');
goog.require('epiviz.ui.charts.VisualizationProperties');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.ui.charts.VisualizationType');
goog.require('epiviz.events.EventListener');
goog.require('epiviz.ui.controls.SaveSvgAsImageDialog');

/**
 * @param {epiviz.Config} config
 * @constructor
 */
epiviz.ui.charts.ChartManager = function(config) {

  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * Map id to chart
   * @type {Object.<string, epiviz.ui.charts.Chart>}
   * @private
   */
  this._charts = {};

  /**
   * Each array in the map contains the ids of the charts in order
   * @type {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>}
   * @private
   */
  this._chartsOrder = {};

  /**
   * Used to resize the charts after window has been resized
   * @type {?number}
   * @private
   */
  this._resizeInterval = null;

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{
   *   type: epiviz.ui.charts.ChartType,
   *   properties: epiviz.ui.charts.VisualizationProperties,
   *   chartsOrder: Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>
   * }>>}
   * @private
   */
  this._chartAdded = new epiviz.events.Event();

  /**
   * Argument is chartsOrder: track -> ids, plot -> ids
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>>>}
   * @private
   */
  this._chartRemoved = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>>}
   * @private
   */
  this._chartsOrderChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event}
   * @private
   */
  this._chartsCleared = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.ColorPalette>>}
   * @private
   */
  this._chartColorsChanged = new epiviz.events.Event();

  /**
   * Event arg: a map of method -> code
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, string>>>}
   * @private
   */
  this._chartMethodsModified = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @private
   */
  this._chartMethodsReset = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Array.<epiviz.ui.charts.markers.VisualizationMarker>>>}
   * @private
   */
  this._chartMarkersModified = new epiviz.events.Event();

  /**
   * Event arg: custom settings values setting -> value
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, *>>>}
   * @private
   */
  this._chartCustomSettingsChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{width: number|string, height: number|string}>>}
   * @private
   */
  this._chartSizeChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.Margins>>}
   * @private
   */
  this._chartMarginsChanged = new epiviz.events.Event();

  /**
   * event -> event args -> selection -> data
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.controls.VisConfigSelection.<*>>>}
   * @protected
   */
  this._chartRequestHierarchy = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{selection: Object.<string, epiviz.ui.charts.tree.NodeSelectionType>, order: Object.<string, number>}>>}
   * @private
   */
  this._chartPropagateHierarchyChanges = new epiviz.events.Event();

  this._chartPropogateIcicleLocationChanges = new epiviz.events.Event();

  this._chartIcicleLocationChanges = new epiviz.events.Event();

  this._registerWindowResize();
};

/**
 * @param {epiviz.ui.charts.ChartType} chartType
 * @param {epiviz.ui.controls.VisConfigSelection} visConfigSelection
 * @param {string} [id] The specific id for the chart. If not
 *   specified, it's generated dynamically
 * @param {epiviz.ui.charts.VisualizationProperties} [chartProperties]
 * @returns {string} The id of the newly created chart
 */
epiviz.ui.charts.ChartManager.prototype.addChart = function(chartType, visConfigSelection, id, chartProperties) {
  id = id || sprintf('%s-%s-%s', chartType.chartDisplayType(), chartType.chartHtmlAttributeName(), epiviz.utils.generatePseudoGUID(5));
  var css = chartType.cssClass();

  var chartDisplayTypeContainer = $('#' + chartType.chartContainer());
  var chartsAccordion = chartDisplayTypeContainer.find('.accordion');
  var chartsContainer = chartsAccordion.find('.vis-container');
  if (chartsAccordion.length == 0) {
    chartsAccordion = $('<div class="accordion"></div>').appendTo(chartDisplayTypeContainer);
    var displayType = chartType.chartDisplayType();
    chartsAccordion.append(
      sprintf('<h3><a href="#"><b><span style="color: #025167">Views by %s</span></b></a></h3>',
        epiviz.ui.ControlManager.DISPLAY_TYPE_LABELS[displayType]));
    chartsContainer = $('<div class="vis-container"></div>').appendTo(chartsAccordion);
    chartsAccordion.multiAccordion();
    chartsAccordion.multiAccordion('option', 'active', 'all');
    var self = this;
    // TODO: This doesn't go well with the icicle, because that requires a lot of drag & drop
    // TODO: Once we find a solution for it, re-enable the feature
    /*chartsContainer.sortable({
      stop: function(e, ui) {
        var newOrder = chartsContainer.find('.visualization-container')
          .map(function(i, el) {
            return $(el).attr('id');
          });
        if (epiviz.utils.arraysEqual(newOrder, self._chartsOrder[displayType])) { return; }
        self._chartsOrder[displayType] = newOrder;
        self._chartsOrderChanged.notify(self._chartsOrder);
      }
    });*/
  }

  chartsContainer.append(sprintf('<div id="%s" class="%s"></div>', id, css));
  var container = chartsContainer.find('#' + id);

  var chartMarkers = []; 
  
  if( chartType._defaultSettings.chartMarkers != null || chartType._defaultSettings.chartMarkers != undefined) {
    for (var i=0; i < chartType._defaultSettings.chartMarkers.length ; i++ ) {
      var tMark = chartType._defaultSettings.chartMarkers[i];
      chartMarkers.push(new epiviz.ui.charts.markers.VisualizationMarker(tMark.type, tMark.id, tMark.name, tMark.preMark, tMark.mark));
    }
  } 

  chartProperties = chartProperties || new epiviz.ui.charts.VisualizationProperties(
    chartType.defaultWidth(), // width
    chartType.defaultHeight(), // height
    chartType.defaultMargins(), // margins
    visConfigSelection, // configuration of measurements and other information selected by the user
    chartType.defaultColors(), // colors
    null, // modified methods
    chartType.customSettingsValues(),
    chartType.customSettingsDefs(),
    //[],
    chartMarkers
  );

  var chart = chartType.createNew(id, container, chartProperties);
  this._charts[id] = chart;

  this._registerChartHover(chart);
  this._registerChartUnhover(chart);
  this._registerChartSelect(chart);
  this._registerChartDeselect(chart);
  this._registerChartColorsChanged(chart);
  this._registerChartMethodsModified(chart);
  this._registerChartMethodsReset(chart);
  this._registerChartMarkersModified(chart);
  this._registerChartCustomSettingsChanged(chart);
  this._registerChartSizeChanged(chart);
  this._registerChartMarginsChanged(chart);
  this._registerChartRemove(chart);
  this._registerChartSave(chart);
  this._registerChartRequestHierarchy(chart);
  this._registerChartPropagateHierarchyChanges(chart);
  this._registerChartPropogateIcicleLocationChanges(chart);
  this._registerChartIcicleLocationChanges(chart);

  if (chartType.decorations()) {
    /** @type {epiviz.ui.charts.decoration.VisualizationDecoration} */
    var topDecoration = undefined;
    for (var i = 0; i < chartType.decorations().length; ++i) {
      /** @type {?(function(new:epiviz.ui.charts.decoration.VisualizationDecoration))} */
      var decorationCtor = epiviz.utils.evaluateFullyQualifiedTypeName(chartType.decorations()[i]);

      if (!decorationCtor) { continue; }

      /** @type {epiviz.ui.charts.decoration.VisualizationDecoration} */
      topDecoration  = epiviz.utils.applyConstructor(decorationCtor, [chart, topDecoration, this._config]);
    }

    if (topDecoration) {
      topDecoration.decorate();
    }
  }

  if (!(chartType.chartDisplayType() in this._chartsOrder)) { this._chartsOrder[chartType.chartDisplayType()] = []; }
  this._chartsOrder[chartType.chartDisplayType()].push(id);

  this._chartAdded.notify(new epiviz.ui.charts.VisEventArgs(id, {
      type: chartType,
      properties: chartProperties,
      chartsOrder: this._chartsOrder
    }));

  return id;
};

/**
 * @param {string} id The id of the chart being removed
 */
epiviz.ui.charts.ChartManager.prototype.removeChart = function(id) {
  $('#' + id).remove();

  var chart = this._charts[id];
  delete this._charts[id];
  this._chartsOrder[chart.displayType()].splice(this._chartsOrder[chart.displayType()].indexOf(id), 1);

  var chartDisplayTypeContainer = $('#' + epiviz.ui.ControlManager.CHART_TYPE_CONTAINERS[chart.displayType()]);
  var chartsAccordion = chartDisplayTypeContainer.find('.accordion');
  var chartsContainer = chartsAccordion.find('.vis-container');
  if (chartsContainer.children().length == 0) {
    chartDisplayTypeContainer.empty();
  }

  this._chartRemoved.notify(new epiviz.ui.charts.VisEventArgs(id, this._chartsOrder));
};

/**
 * Returns a map of chart ids as keys and corresponding measurements as values
 * @returns {Object.<string, epiviz.measurements.MeasurementSet>}
 */
epiviz.ui.charts.ChartManager.prototype.chartsMeasurements = function() {
  /** @type {Object.<string, epiviz.measurements.MeasurementSet>} */
  var result = {};
  for (var chartId in this._charts) {
    if (!this._charts.hasOwnProperty(chartId)) { continue; }
    if (this._charts[chartId].displayType() == epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) { continue; }
    result[chartId] = this._charts[chartId].measurements();
  }

  return result;
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {Array.<string>} [chartIds]
 */
epiviz.ui.charts.ChartManager.prototype.updateCharts = function(range, data, chartIds) {
  chartIds = chartIds || Object.keys(this._charts);
  for (var i = 0; i < chartIds.length; ++i) {
    if (!this._charts.hasOwnProperty(chartIds[i])) { continue; }
    var chart = this._charts[chartIds[i]];
    if (!chart) { continue; }

    (function(chart) {
      chart.transformData(range, data).done(function() {
        // No need to call with arguments, since transformData will set the lastRange and lastData values
        chart.draw();
      });
    })(chart);
  }
};

/**
 */
epiviz.ui.charts.ChartManager.prototype.updateDataStructureCharts = function() {
  var chartIds = Object.keys(this._charts);
  for (var i = 0; i < chartIds.length; ++i) {
    if (!this._charts.hasOwnProperty(chartIds[i])) { continue; }
    var chart = this._charts[chartIds[i]];
    if (!chart) { continue; }
    if (chart.displayType() != epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) { continue; }

    (function(chart) {
      setTimeout(function() {
        chart.fireRequestHierarchy();
      }, 0);
    })(chart);
  }
};

/**
 * Clears all the charts on stage
 */
epiviz.ui.charts.ChartManager.prototype.clear = function() {
  this._charts = {};
  this._chartsOrder = {};

  var chartContainers = epiviz.ui.ControlManager.CHART_TYPE_CONTAINERS;

  for (var displayType in chartContainers) {
    if (!chartContainers.hasOwnProperty(displayType)) { continue; }
    $('#' + chartContainers[displayType]).empty();
  }

  this._chartsCleared.notify();
};

/**
 * Tells all charts that new data has been requested.
 * Used, for example, by ChartLoaderAnimation decoration.
 * @param {string} [chartId]
 * @param {function(epiviz.ui.charts.Visualization): boolean} [chartFilter]
 */
epiviz.ui.charts.ChartManager.prototype.dataWaitStart = function(chartId, chartFilter) {
  if (chartId && this._charts[chartId]) {
    this._charts[chartId].onDataWaitStart().notify(new epiviz.ui.charts.VisEventArgs(chartId));
    return;
  }
  for (var id in this._charts) {
    if (!this._charts.hasOwnProperty(id)) { continue; }
    if (!chartFilter || !chartFilter[this._charts[id]]) { continue; }
    this._charts[id].onDataWaitStart().notify(new epiviz.ui.charts.VisEventArgs(id));
  }
};

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{type: epiviz.ui.charts.ChartType, properties: epiviz.ui.charts.VisualizationProperties, chartsOrder: Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>}>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartAdded = function() { return this._chartAdded; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartRemoved = function() { return this._chartRemoved; };

/**
 * @returns {epiviz.events.Event.<Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartsOrderChanged = function() { return this._chartsOrderChanged; };

/**
 * @returns {epiviz.events.Event}
 */
epiviz.ui.charts.ChartManager.prototype.onChartsCleared = function() { return this._chartsCleared; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.ColorPalette>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartColorsChanged = function() { return this._chartColorsChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, string>>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartMethodsModified = function() { return this._chartMethodsModified; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartMethodsReset = function() { return this._chartMethodsReset; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Array.<epiviz.ui.charts.markers.VisualizationMarker>>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartMarkersModified = function() { return this._chartMarkersModified; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, *>>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartCustomSettingsChanged = function() { return this._chartCustomSettingsChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{width: (number|string), height: (number|string)}>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartSizeChanged = function() { return this._chartSizeChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.Margins>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartMarginsChanged = function() { return this._chartMarginsChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.controls.VisConfigSelection.<*>>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartRequestHierarchy = function() { return this._chartRequestHierarchy; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{selection: Object.<string, epiviz.ui.charts.tree.NodeSelectionType>, order: Object.<string, number>}>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartPropagateHierarchyChanges = function() { return this._chartPropagateHierarchyChanges; };

epiviz.ui.charts.ChartManager.prototype.onChartPropogateIcicleLocationChanges = function() { return this._chartPropogateIcicleLocationChanges; };

epiviz.ui.charts.ChartManager.prototype.onChartIcicleLocationChanges = function() { return this._chartIcicleLocationChanges; };


/**
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerWindowResize = function() {
  var self = this;
  $(window).resize(function() {
    if (self._resizeInterval !== null) { window.clearTimeout(self._resizeInterval); }
    self._resizeInterval = window.setTimeout(function() {
      for (var chartId in self._charts) {
        if (!self._charts.hasOwnProperty(chartId)) { continue; }
        self._charts[chartId].updateSize();
      }
      self._resizeInterval = null;
    }, 500);
  });
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartHover = function(chart) {
  var self = this;
  chart.onHover().addListener(new epiviz.events.EventListener(
    /** @param {epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.ChartObject>} e */
    function(e) {
      for (var id in self._charts) {
        if (!self._charts.hasOwnProperty(id)) { continue; }
        self._charts[id].doHover(e.args);
      }
    }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartUnhover = function(chart) {
  var self = this;
  chart.onUnhover().addListener(new epiviz.events.EventListener(function() {
    for (var id in self._charts) {
      if (!self._charts.hasOwnProperty(id)) { continue; }
      self._charts[id].doUnhover();
    }
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartSelect = function(chart) {
  var self = this;
  chart.onSelect().addListener(new epiviz.events.EventListener(
    /** @param {epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.ChartObject>} e */
      function(e) {
      var selectedObject = e.args;
      for (var id in self._charts) {
        if (!self._charts.hasOwnProperty(id)) { continue; }
        self._charts[id].doSelect(selectedObject);
      }
    }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartDeselect = function(chart) {
  var self = this;
  chart.onDeselect().addListener(new epiviz.events.EventListener(function() {
    for (var id in self._charts) {
      if (!self._charts.hasOwnProperty(id)) { continue; }
      self._charts[id].doDeselect();
    }
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartRemove = function(chart) {
  var self = this;
  chart.onRemove().addListener(new epiviz.events.EventListener(
    /** @param {epiviz.ui.charts.VisEventArgs} e */
    function(e) { self.removeChart(e.id); }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartSave = function(chart) {
  var self = this;

  if(self._config.configType != "default") {
    chart.onSave().addListener(new epiviz.events.EventListener(
        /** @param {epiviz.ui.charts.VisEventArgs} e */
        function(e) {
          var pm = new epiviz.ui.PrintManager(e.id, "epiviz_" + Math.floor($.now() / 1000), "pdf");
          pm.print();
        }));
  }
  else {
    chart.onSave().addListener(new epiviz.events.EventListener(
        /** @param {epiviz.ui.charts.VisEventArgs} e */
        function(e) {
          var saveSvgDialog = new epiviz.ui.controls.SaveSvgAsImageDialog(
              {ok: function(){}, cancel: function(){}},
              e.id,
              self._config.dataServerLocation + self._config.chartSaverLocation);

          saveSvgDialog.show();
        }));
  }

};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartColorsChanged = function(chart) {
  var self = this;
  chart.onColorsChanged().addListener(new epiviz.events.EventListener(function(e) {
    self._chartColorsChanged.notify(e);
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartMethodsModified = function(chart) {
  var self = this;
  chart.onMethodsModified().addListener(new epiviz.events.EventListener(function(e) {
    self._chartMethodsModified.notify(e);
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartMethodsReset = function(chart) {
  var self = this;
  chart.onMethodsReset().addListener(new epiviz.events.EventListener(function(e) {
    self._chartMethodsReset.notify(e);
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartMarkersModified = function(chart) {
  var self = this;
  chart.onMarkersModified().addListener(new epiviz.events.EventListener(function(e) {
    self._chartMarkersModified.notify(e);
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartCustomSettingsChanged = function(chart) {
  var self = this;
  chart.onCustomSettingsChanged().addListener(new epiviz.events.EventListener(function(e) {
    self._chartCustomSettingsChanged.notify(e);
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartSizeChanged = function(chart) {
  var self = this;
  chart.onSizeChanged().addListener(new epiviz.events.EventListener(function(e) {
    self._chartSizeChanged.notify(e);
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartMarginsChanged = function(chart) {
  var self = this;
  chart.onMarginsChanged().addListener(new epiviz.events.EventListener(function(e) {
    self._chartMarginsChanged.notify(e);
  }));
};

/**
 * @param {epiviz.ui.charts.Visualization} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartRequestHierarchy = function(chart) {
  var self = this;
  if (chart.displayType() == epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) {
    var dataStructVis = /** @type {epiviz.ui.charts.DataStructureVisualization} */ chart; // Assignment done for consistency
    dataStructVis.onRequestHierarchy().addListener(new epiviz.events.EventListener(function(e) {
      self._chartRequestHierarchy.notify(e);
    }));
  }
};

/**
 * @param {epiviz.ui.charts.Visualization} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartPropagateHierarchyChanges = function(chart) {
  var self = this;
  if (chart.displayType() == epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) {
    var dataStructVis = /** @type {epiviz.ui.charts.DataStructureVisualization} */ chart; // Assignment done for consistency
    dataStructVis.onPropagateHierarchyChanges().addListener(new epiviz.events.EventListener(function(e) {
      self._chartPropagateHierarchyChanges.notify(e);
    }));
  }
};

epiviz.ui.charts.ChartManager.prototype._registerChartPropogateIcicleLocationChanges = function(chart) {
  var self = this;

  if (chart.displayType() == epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) {
    var dataStructVis = /** @type {epiviz.ui.charts.DataStructureVisualization} */ chart; // Assignment done for consistency
    dataStructVis.onPropagateIcicleLocationChanges().addListener(new epiviz.events.EventListener(function(e) {
      self._chartPropogateIcicleLocationChanges.notify(e);
    }));
  }
};

epiviz.ui.charts.ChartManager.prototype._registerChartIcicleLocationChanges = function(chart) {
   var self = this;

   self.onChartIcicleLocationChanges().addListener(new epiviz.events.EventListener(function(e) {
      if (chart.displayType() == epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) {
        chart._updateLocation(e.args.start, e.args.width);
        chart._drawAxes(chart._lastRoot);
      }
   }));
}; 

epiviz.ui.charts.ChartManager.prototype.getChartSettings = function(id) {

  var chart = this._charts[id];
  var result = {};
  //result['defs'] = chart.properties().customSettingsDefs;
  result['settings'] = chart.customSettingsValues();
  result['colorMap'] = chart.properties().colors;
  return result;

};

epiviz.ui.charts.ChartManager.prototype.setChartSettings = function(id, settings, colorMap) {

  var chart = this._charts[id];

  if(settings != null) {
    var currentSettings = chart.customSettingsValues();

    var all_keys = Object.keys(settings);

    all_keys.forEach(function(key) {
      currentSettings[key] = settings[key];
    });

    chart.setCustomSettingsValues(currentSettings);
  }

  if(colorMap != null) {
    chart.setColors(colorMap);
  }

  chart.draw();
};


// Input 90
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/22/14
 * Time: 12:58 PM
 */

goog.provide('epiviz.data.EmptyResponseDataProvider');

goog.require('epiviz.data.DataProvider');
goog.require('epiviz.data.Response');

/**
 * @constructor
 * @extends {epiviz.data.DataProvider}
 */
epiviz.data.EmptyResponseDataProvider = function () {
  epiviz.data.DataProvider.call(this, epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);
};

/**
 * Copy methods from upper class
 */
epiviz.data.EmptyResponseDataProvider.prototype = epiviz.utils.mapCopy(epiviz.data.DataProvider.prototype);
epiviz.data.EmptyResponseDataProvider.constructor = epiviz.data.EmptyResponseDataProvider;

epiviz.data.EmptyResponseDataProvider.DEFAULT_ID = 'empty';

/**
 * @param {epiviz.data.Request} request
 * @param {function(epiviz.data.Response)} callback
 * @override
 */
epiviz.data.EmptyResponseDataProvider.prototype.getData = function (request, callback) {
  var requestId = request.id();
  var action = request.get('action');

  switch (action) {
    case epiviz.data.Request.Action.GET_ROWS:
      callback(epiviz.data.Response.fromRawObject({
        data: {
          values: { id: null, start: [], end:[], strand: [], metadata:{my_metadata:[]} },
          globalStartIndex: null,
          useOffset: false
        },
        requestId: requestId
      }));
      return;

    case epiviz.data.Request.Action.GET_VALUES:
      callback(epiviz.data.Response.fromRawObject({
        data: { values: [], globalStartIndex: null },
        requestId: requestId
      }));
      return;

    case epiviz.data.Request.Action.GET_MEASUREMENTS:
      callback(epiviz.data.Response.fromRawObject({
        requestId: request.id(),
        data: { id: [], name: [], type: [], datasourceId: [], datasourceGroup: [], defaultChartType: [], annotation: [], minValue: [], maxValue: [], metadata: [] }
      }));
      return;

    case epiviz.data.Request.Action.GET_SEQINFOS:
      callback(epiviz.data.Response.fromRawObject({
        requestId: request.id(),
        data: []
      }));
      return;

    case epiviz.data.Request.Action.SEARCH:
      callback(epiviz.data.Response.fromRawObject({
        requestId: request.id(),
        data: []
      }));
      return;

    case epiviz.data.Request.Action.SAVE_WORKSPACE:
      callback(epiviz.data.Response.fromRawObject({
	  requestId: request.id(),
	  data: []
    }));
    return;  

    case epiviz.data.Request.Action.DELETE_WORKSPACE:
      callback(epiviz.data.Response.fromRawObject({
	  requestId: request.id(),
	  data: []
    }));
    return;
  
    case epiviz.data.Request.Action.GET_WORKSPACES:
      callback(epiviz.data.Response.fromRawObject({
	  requestId: request.id(),
	  data: []
    }));
    return;

    default:
      epiviz.data.DataProvider.prototype.getData.call(this, request, callback);
      break;
  }
};

// goog.inherits(epiviz.data.EmptyResponseDataProvider, epiviz.data.DataProvider);
// Input 91
/**
 * Created by: Florin Chelaru
 * Date: 10/1/13
 * Time: 1:28 PM
 */

goog.provide('epiviz.data.DataProviderFactory');

goog.require('epiviz.events.EventListener');
goog.require('epiviz.events.Event');
goog.require('epiviz.data.EmptyResponseDataProvider');
// goog.require('epiviz.utils.evaluateFullyQualifiedTypeName');
// goog.require('epiviz.utils.applyConstructor');
goog.require('epiviz.utils');

/**
 * A factory containing all the registered active data providers
 * (like EpivizR connections or PHP servers)
 * @param {epiviz.Config} config
 * @constructor
 * @implements {epiviz.utils.Iterable}
 */
epiviz.data.DataProviderFactory = function(config) {
  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {Array.<epiviz.data.DataProvider>}
   * @private
   */
  //this._providers = [];

  /**
   * @type {Object.<string, epiviz.data.DataProvider>}
   * @private
   */
  this._providers = {};

  /**
   * @type {number}
   * @private
   */
  this._size = 0;

  var tokens;
  for (var i = 0; i < this._config.dataProviders.length; ++i) {
    if (!$.isArray(this._config.dataProviders[i])) {
      tokens = this._config.dataProviders[i].split(',');
    } else {
      tokens = this._config.dataProviders[i];
    }
    /**
     * @type {?function(new:epiviz.data.DataProvider)}
     */
    var dataProviderConstructor = epiviz.utils.evaluateFullyQualifiedTypeName(tokens[0]);

    if (!dataProviderConstructor) { continue; }

    /** @type {epiviz.data.DataProvider} */
    var dataProvider = epiviz.utils.applyConstructor(dataProviderConstructor, tokens.slice(1));

    this._providers[dataProvider.id()] = dataProvider;

    ++this._size;
  }
  var emptyProvider = new epiviz.data.EmptyResponseDataProvider();
  this._providers[emptyProvider.id()] = emptyProvider;
  ++this._size;

  tokens = this._config.workspacesDataProvider.split(',');
  /**
   * @type {?function(new:epiviz.data.DataProvider)}
   */
  var wsDataProviderConstructor = epiviz.utils.evaluateFullyQualifiedTypeName(tokens[0]);

  /** @type {epiviz.data.DataProvider} */
  this._workspacesDataProvider = epiviz.utils.applyConstructor(wsDataProviderConstructor, tokens.slice(1));

};

/**
 * Iterates through all registered data providers until the function
 *   evaluates to true
 * @param {function(epiviz.data.DataProvider)} func
 */
epiviz.data.DataProviderFactory.prototype.foreach = function(func) {
  for (var id in this._providers) {
    if (!this._providers.hasOwnProperty(id)) { continue; }
    if (func(this._providers[id])) { return; }
  }
};

/**
 * @returns {boolean}
 */
epiviz.data.DataProviderFactory.prototype.isEmpty = function() {
  //return !this._providers.length;
  return !this._size;
};

/**
 * @returns {number}
 */
epiviz.data.DataProviderFactory.prototype.size = function() {
  //return this._providers.length;
  return this._size;
};

/**
 * @param {string} id
 * @returns {epiviz.data.DataProvider}
 */
epiviz.data.DataProviderFactory.prototype.get = function(id) {
  if (id in this._providers) {
    return this._providers[id];
  }

  return null;
};

/**
 * @returns {epiviz.data.DataProvider}
 */
epiviz.data.DataProviderFactory.prototype.workspacesDataProvider = function() {
  return this._workspacesDataProvider;
};

// Input 92
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/5/13
 * Time: 9:51 AM
 */

goog.provide('epiviz.data.RequestStack');

/**
 * @constructor
 */
epiviz.data.RequestStack = function() {
  /**
   * An array of requests, in the order they are made
   * @type {Array.<epiviz.data.Request>}
   * @private
   */
  this._requests = [];

  /**
   * Map of callbacks stored by request id
   * @type {Object.<number, function(*)>}
   * @private
   */
  this._callbacks = {};

  /**
   * Map of responses stored by request id
   * @type {Object.<number, *>}
   * @private
   */
  this._dataMap = {};
};

/**
 * @param {epiviz.data.Request} request
 * @param {function(*)} callback
 */
epiviz.data.RequestStack.prototype.pushRequest = function(request, callback) {
  this._requests.push(request);
  this._callbacks[request.id()] = callback;
};

/**
 * Correlates the response to a particular request; the callback corresponding to that
 * request will be called when all requests that were made before this one have been
 * served.
 *
 * @param {epiviz.data.Response<*>} response
 */
epiviz.data.RequestStack.prototype.serveData = function(response) {

  if (!this._callbacks[response.id()]) {
    return;
  }

  // Check if this request is the first request in the stack. If it is,
  // pop it. Otherwise, we'll wait, so that we execute everything in the
  // same order as it was requested.
  if (this._requests.length > 0 && this._requests[0].id() == response.id()) {
    var callback = this._callbacks[response.id()];
    delete this._callbacks[response.id()];
    this._requests = this._requests.slice(1);
    callback(response.data());

    // Serve all other responses that have already come back, and are immediately after this one
    while (this._requests.length > 0 && (this._requests[0].id() in this._dataMap)) {
      callback = this._callbacks[this._requests[0].id()];
      var data = this._dataMap[this._requests[0].id()];
      delete this._callbacks[this._requests[0].id()];
      delete this._dataMap[this._requests[0].id()];
      this._requests = this._requests.slice(1);

      // It is important we call the callback after we've already changed the stack,
      // because the callback may query the stack again
      callback(data);
    }

    return;
  }

  // If unable to serve data, then store it for later
  this._dataMap[response.id()] = response.data();
};

/**
 * Clears the entire request stack
 */
epiviz.data.RequestStack.prototype.clear = function() {
  this._requests = [];
  this._callbacks = {};
  this._dataMap = {};
};


// Input 93
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/29/13
 * Time: 12:49 PM
 */

goog.provide('epiviz.data.Cache');

goog.require('epiviz.data.RequestStack');
goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.datatypes.MeasurementGenomicDataArrayWrapper');
goog.require('epiviz.datatypes.MapGenomicData');
goog.require('epiviz.measurements.MeasurementSet');

/**
 * @param {epiviz.Config} config
 * @param {epiviz.data.DataProviderFactory} dataProviderFactory
 * @constructor
 */
epiviz.data.Cache = function(config, dataProviderFactory) {

  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {epiviz.data.DataProviderFactory}
   * @private
   */
  this._dataProviderFactory = dataProviderFactory;

  /**
   * @type {Object.<string, epiviz.datatypes.PartialSummarizedExperiment>}
   * @private
   */
  this._data = {};

  /**
   * @type {epiviz.measurements.MeasurementHashtable.<epiviz.data.RequestStack>}
   * @private
   */
  this._measurementRequestStackMap = new epiviz.measurements.MeasurementHashtable();

  /**
   * measurement -> (requestId -> range)
   * @type {epiviz.measurements.MeasurementHashtable.<Object.<number, epiviz.datatypes.GenomicRange>>}
   * @private
   */
  this._measurementPendingRequestsMap = new epiviz.measurements.MeasurementHashtable();

  /**
   * @type {epiviz.datatypes.GenomicRange}
   * @private
   */
  this._lastRequest = null;

  if (this._config.cacheUpdateIntervalMilliseconds > 0) {
    var self = this;
    this._intervalId = window.setTimeout(function() {
      self._clearUnneededData();
    }, config.cacheUpdateIntervalMilliseconds);
  }
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {function(string, epiviz.datatypes.GenomicData)} dataReadyCallback
 */
epiviz.data.Cache.prototype.getData = function(range, chartMeasurementsMap, dataReadyCallback) {
  var MeasurementType = epiviz.measurements.Measurement.Type;

  var self = this;

  this._lastRequest = epiviz.datatypes.GenomicRange.fromStartEnd(
    range.seqName(),
    range.start() - range.width(),
    range.end() + range.width());

  if (this._config.cacheUpdateIntervalMilliseconds > 0) {
    window.clearInterval(this._intervalId);
    this._intervalId = window.setTimeout(function() {
      self._clearUnneededData();
    }, this._config.cacheUpdateIntervalMilliseconds);
  }

  var computedMs = this._extractComputedMeasurements(chartMeasurementsMap);

  this._updateComputedMeasurementsData(computedMs);
  this._serveAvailableData(range, chartMeasurementsMap, dataReadyCallback);

  var requestRanges = [
    range,
    epiviz.datatypes.GenomicRange.fromStartEnd(range.seqName(), Math.max(range.start() - range.width(), 0), range.start()),
    new epiviz.datatypes.GenomicRange(range.seqName(), range.end(), range.width())
  ];

  /**
   * A map of measurements as keys and for each of them, an array of ranges needed
   * @type {epiviz.measurements.MeasurementHashtable.<Array.<epiviz.datatypes.GenomicRange>>}
   */
  var msNeededRanges = this._calcMeasurementNeededRanges(requestRanges, chartMeasurementsMap);

  msNeededRanges.foreach(function(m, ranges) {
    var requestStack = self._measurementRequestStackMap.get(m);
    if (!requestStack) {
      requestStack = new epiviz.data.RequestStack();
      self._measurementRequestStackMap.put(m, requestStack);
    }
    var request;

    if (ranges.length == 0) {
      request = epiviz.data.Request.emptyRequest();
      requestStack.pushRequest(request, function() {
        self._handleResponse(dataReadyCallback, range, chartMeasurementsMap, request, null, m, null);
      });

      // When the pending requests for this measurements come back, this will also pop out
      requestStack.serveData(new epiviz.data.Response(request.id(), {}));
      return; // continue iteration
    }

    for (var i = 0; i < ranges.length; ++i) {
      request = m.type() == MeasurementType.RANGE ?
        epiviz.data.Request.getRows(m, ranges[i]) :
        epiviz.data.Request.getValues(m, ranges[i]);
      (function(r, request) {
        requestStack.pushRequest(request,
          /** @param {{globalStartIndex: number, values: *, useOffset: ?boolean}} data */
          function(data) {
            self._handleResponse(dataReadyCallback, range, chartMeasurementsMap, request, r, m, data);
          });
      })(ranges[i], request);

      var pendingRequests = self._measurementPendingRequestsMap.get(m);
      if (!pendingRequests) {
        pendingRequests = {};
        self._measurementPendingRequestsMap.put(m, pendingRequests);
      }
      pendingRequests[request.id()] = ranges[i];

      var dataProvider = self._dataProviderFactory.get(m.dataprovider()) || self._dataProviderFactory.get(epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);
      dataProvider.getData(request, function(response) {
        requestStack.serveData(response);
      });
    }
  });
};

/**
 * @param {function(string, epiviz.datatypes.GenomicData)} chartDataReadyCallback
 * @param {epiviz.datatypes.GenomicRange} chartRequestedRange
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {epiviz.data.Request} request
 * @param {?epiviz.datatypes.GenomicRange} range A range corresponding to the current request; this can be different from the chartRequestedRange, and can also
 *   be null in case no real request to the data provider was necessary to retrieve data for this chart
 * @param {epiviz.measurements.Measurement} measurement
 * @param {?{globalStartIndex: number, values: *, useOffset: ?boolean}} rawData
 * @private
 */
epiviz.data.Cache.prototype._handleResponse = function(chartDataReadyCallback, chartRequestedRange, chartMeasurementsMap, request, range, measurement, rawData) {

  if (range) {
    var genomicArray = measurement.type() == epiviz.measurements.Measurement.Type.RANGE ?
      new epiviz.datatypes.GenomicRangeArray(measurement, range, rawData.globalStartIndex, rawData.values, rawData.useOffset) :
      new epiviz.datatypes.FeatureValueArray(measurement, range, rawData.globalStartIndex, rawData.values);
    this._mergeData(measurement, genomicArray);
  }

  var computedMs = this._extractComputedMeasurements(chartMeasurementsMap);
  this._updateComputedMeasurementsData(computedMs);

  var pendingRequests = this._measurementPendingRequestsMap.get(measurement);
  if (pendingRequests) {
    delete pendingRequests[request.id()];
  }

  this._serveAvailableData(chartRequestedRange, chartMeasurementsMap, chartDataReadyCallback);
};

/**
 * Look through charts; if there is one for which we have the whole needed data, serve it by calling
 * dataReadyCallback(chartId, data). Then, remove that particular chart from the map.
 *
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {function(string, epiviz.datatypes.GenomicData)} dataReadyCallback
 * @private
 */
epiviz.data.Cache.prototype._serveAvailableData = function(range, chartMeasurementsMap, dataReadyCallback) {
  var MeasurementType = epiviz.measurements.Measurement.Type;
  var self = this;

  var servedChartIds = [];

  for (var chartId in chartMeasurementsMap) {
    if (!chartMeasurementsMap.hasOwnProperty(chartId)) { continue; }

    var chartMeasurements = chartMeasurementsMap[chartId];
    var allDataAvailable = true;
    /** @type {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.MeasurementGenomicData>} */
    var chartData = new epiviz.measurements.MeasurementHashtable();
    (function(chartData) {
      chartMeasurements.foreach(function(m) {
        var storedData = self._data[m.datasourceGroup()];
        if (!storedData || !storedData.rowData() || (m.type() == MeasurementType.FEATURE && !storedData.values(m))) {
          allDataAvailable = false;
          return true; // Break!
        }
        var rowData = storedData.rowData();
        var valueData = (m.type() == MeasurementType.FEATURE) ? storedData.values(m) : null;
        var neededRanges = range.subtract(rowData.boundaries());
        if (neededRanges.length) {
          allDataAvailable = false;
          return true; // Break;
        }

        if (valueData) {
          neededRanges = range.subtract(valueData.boundaries());
          if (neededRanges.length) {
            allDataAvailable = false;
            return true; // Break!
          }
        }

        chartData.put(m, new epiviz.datatypes.MeasurementGenomicDataWrapper(m, self._data[m.datasourceGroup()]));

        return false;
      });
    }(chartData));

    if (allDataAvailable) {
      dataReadyCallback(chartId, new epiviz.datatypes.MapGenomicData(chartData));
      servedChartIds.push(chartId);
    }
  }

  for (var i = 0; i < servedChartIds.length; ++i) {
    delete chartMeasurementsMap[servedChartIds[i]];
  }
};

/**
 * @param {Array.<epiviz.datatypes.GenomicRange>} ranges
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @return {epiviz.measurements.MeasurementHashtable.<Array.<epiviz.datatypes.GenomicRange>>}
 * @private
 */
epiviz.data.Cache.prototype._calcMeasurementNeededRanges = function(ranges, chartMeasurementsMap) {
  var MeasurementType = epiviz.measurements.Measurement.Type;
  var self = this;

  /** @type {epiviz.measurements.MeasurementHashtable.<Array.<epiviz.datatypes.GenomicRange>>} */
  var result = new epiviz.measurements.MeasurementHashtable();

  for (var chartId in chartMeasurementsMap) {
    if (!chartMeasurementsMap.hasOwnProperty(chartId)) { continue; }

    var chartMeasurements = new epiviz.measurements.MeasurementSet();

    (function(chartMeasurements) {
      chartMeasurementsMap[chartId].foreach(function(m) {
        var compMs = m.componentMeasurements();
        compMs.foreach(function(compM) {
          chartMeasurements.add(compM);
          chartMeasurements.add(compM.datasource());
        });

        if (!m.isComputed()) {
          chartMeasurements.add(m.datasource());
        }
      });
    })(chartMeasurements);

    chartMeasurements.foreach(function(m) {
      var neededRanges = null;

      /** @type {?epiviz.datatypes.PartialSummarizedExperiment} */
      var storedData = self._data[m.datasourceGroup()];
      if (!storedData || (m.type() == MeasurementType.FEATURE && !storedData.values(m))) {
        neededRanges = ranges.slice(0); // copy array
      } else {
        /** @type {epiviz.datatypes.GenomicArray} */
        var data = (m.type() == MeasurementType.FEATURE) ? storedData.values(m) : storedData.rowData();
        if (!data) {
          neededRanges = ranges.slice(0); // copy array
        } else {
          neededRanges = [];
          var boundaries = data.boundaries();
          for (var i = 0; i < ranges.length; ++i) {
            neededRanges = neededRanges.concat(ranges[i].subtract(boundaries));
          }
        }
      }

      // Also check pending requests

      /** @type {?Object.<number, epiviz.datatypes.GenomicRange>} */
      var pendingRequests = self._measurementPendingRequestsMap.get(m);

      if (pendingRequests) {
        for (var j = 0; j < neededRanges.length; ++j) {
          for (var requestId in pendingRequests) {
            if (!pendingRequests.hasOwnProperty(requestId)) { continue; }

            /** @type {Array.<epiviz.datatypes.GenomicRange>} */
            var dif = neededRanges[j].subtract(pendingRequests[requestId]);

            // Now replace neededRanges[j] with dif
            Array.prototype.splice.apply(neededRanges, [j, 1].concat(dif));

            if (dif.length == 0) {
              --j;
              break;
            }

            if (j >= neededRanges.length) { break; }
          }
        }
      }

      // It is very important that, even if there are no needed ranges, we still put the empty
      // array in the hashtable, because there will still be a pseudo-request corresponding to it
      result.put(m, neededRanges);
    });
  }

  return result;
};

/**
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @returns {epiviz.measurements.MeasurementSet}
 * @private
 */
epiviz.data.Cache.prototype._extractComputedMeasurements = function(chartMeasurementsMap) {
  var result = new epiviz.measurements.MeasurementSet();
  for (var chartId in chartMeasurementsMap) {
    if (!chartMeasurementsMap.hasOwnProperty(chartId)) { continue; }
    chartMeasurementsMap[chartId].foreach(function(m) {
      if (m.isComputed()) { result.add(m); }
    });
  }

  return result;
};

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicArray} data
 * @private
 */
epiviz.data.Cache.prototype._mergeData = function(measurement, data) {
  var MeasurementType = epiviz.measurements.Measurement.Type;
  var storedData = this._data[measurement.datasourceGroup()];
  if (!storedData) {
    storedData = new epiviz.datatypes.PartialSummarizedExperiment();
    this._data[measurement.datasourceGroup()] = storedData;
  }

  if (measurement.type() == MeasurementType.RANGE) {
    storedData.addRowData(/** @type {epiviz.datatypes.GenomicRangeArray} */ data);
    return;
  }

  // FEATURE
  storedData.addValues(/** @type {epiviz.datatypes.FeatureValueArray} */ data);
};

/**
 * @private
 */
epiviz.data.Cache.prototype._clearUnneededData = function() {
  if (!this._lastRequest) { return; }
  console.log(sprintf('Clearing data outside of range [%7s%10s%10s]', this._lastRequest.seqName(), this._lastRequest.start(), this._lastRequest.end()));

  var self = this;
  var newData = {};
  for (var datasourceGroup in this._data) {
    if (!this._data.hasOwnProperty(datasourceGroup)) { continue; }
    var exp = this._data[datasourceGroup];
    newData[datasourceGroup] = exp.trim(self._lastRequest);
  }

  this._data = newData;
};

/**
 * @param {epiviz.measurements.MeasurementSet} computedMs
 * @private
 */
epiviz.data.Cache.prototype._updateComputedMeasurementsData = function(computedMs) {
  var self = this;
  var GenomicRange = epiviz.datatypes.GenomicRange;
  computedMs.foreach(function(cm) {
    // First, see if there is new data for all of the component measurements of m

    /** @type {?epiviz.datatypes.PartialSummarizedExperiment} */
    var storedData = self._data[cm.datasourceGroup()];
    if (!storedData) { return false; } // Continue

    /** @type {epiviz.measurements.MeasurementSet} */
    var componentMeasurements = cm.componentMeasurements();

    /** @type {?number} */
    var globalStartIndex = null;

    /** @type {?number} */
    var size = null;

    /** @type {?epiviz.datatypes.GenomicRange} */
    var  boundaries = null;

    componentMeasurements.foreach(function(m) {
      /** @type {epiviz.datatypes.FeatureValueArray} */
      var values = storedData.values(m);

      if (!values || !values.boundaries()) {
        globalStartIndex = null;
        size = null;
        boundaries = null;
        return true; // break: there is not enough data to compute the measurement
      }

      if (boundaries === null) {
        globalStartIndex = values.globalStartIndex();
        size = values.size();
        boundaries = values.boundaries();

        // if globalStartIndex === null then break:
        //   this means either that there is not enough data loaded to
        //   compute the measurement (if boundaries is also null),
        //   or the current range simply doesn't contain any data.
        // otherwise, continue iteration
        return (globalStartIndex === null);
      }

      if (values.boundaries().seqName() != boundaries.seqName()) {
        // The stored data for the component measurements belongs to different chromosomes,
        // so the computed measurement cannot be computed yet.
        size = 0;
        return true;
      }

      if (globalStartIndex < values.globalStartIndex()) {
        size -= values.globalStartIndex() - globalStartIndex;
        if (size < 0) {
          // This means that the global start index for one of the component measurements begins
          // after the end of another, which means that the computed measurement cannot be computed yet.
          size = 0;
          return true;
        }
        globalStartIndex = values.globalStartIndex();
        var start = values.boundaries().start(), end = boundaries.end();

        if (size > values.size()) {
          size = values.size();
          end = values.boundaries().end();
        }
        boundaries = GenomicRange.fromStartEnd(boundaries.seqName(), start, end);
      } else {
        var newSize = values.size() - globalStartIndex + values.globalStartIndex();
        if (size > newSize) {
          size = newSize;
          if (size <= 0) {
            size = 0;
            return true;
          }
          boundaries = GenomicRange.fromStartEnd(
            boundaries.seqName(), boundaries.start(), values.boundaries().end());
        }
      }

      if (size == 0) { return true; } // break: there is not enough data to compute the measurement

      return false;
    });

    if (boundaries === null) { return false; } // continue

    // Check if the existing stored values already contain the new values
    var existingValues = storedData.values(cm);
    if (existingValues &&
      (globalStartIndex === null ||
      (existingValues.globalStartIndex() < globalStartIndex &&
      existingValues.globalStartIndex() + existingValues.size() > globalStartIndex + size))) {
      return false; // continue
    }

    // Here, compute the actual measurement

    // Values before the currently stored start index

    /** @type {epiviz.measurements.MeasurementHashtable.<Array.<number>>} */
    var compMsVals = new epiviz.measurements.MeasurementHashtable();
    var values = null;

    if (existingValues && existingValues.size()) {
      componentMeasurements.foreach(function(m) {
        var v = storedData.values(m);
        var mVals = [];
        if (globalStartIndex !== null) {
          for (var index = globalStartIndex; index < existingValues.globalStartIndex(); ++index) {
            mVals.push(v.getByGlobalIndex(index));
          }
        }
        compMsVals.put(m, mVals);
      });

      values = new epiviz.datatypes.FeatureValueArray(cm,
        GenomicRange.fromStartEnd(boundaries.seqName(), boundaries.start(), existingValues.boundaries().start()),
        globalStartIndex,
        cm.evaluateArr(compMsVals));


      self._mergeData(cm, values);

      // Values after current global start index + size
      compMsVals = new epiviz.measurements.MeasurementHashtable();
      componentMeasurements.foreach(function(m) {
        var v = storedData.values(m);
        var mVals = [];
        if (globalStartIndex !== null) {
          for (var index = existingValues.globalStartIndex() + existingValues.size(); index < globalStartIndex + size; ++index) {
            mVals.push(v.getByGlobalIndex(index));
          }
        }
        compMsVals.put(m, mVals);
      });

      values = new epiviz.datatypes.FeatureValueArray(cm,
        GenomicRange.fromStartEnd(boundaries.seqName(), existingValues.boundaries().end(), boundaries.end()),
        existingValues.globalStartIndex() + existingValues.size(),
        cm.evaluateArr(compMsVals));

      self._mergeData(cm, values);

      return false;
    }

    compMsVals = new epiviz.measurements.MeasurementHashtable();
    componentMeasurements.foreach(function(m) {
      var v = storedData.values(m);
      var mVals = [];
      if (globalStartIndex !== null) {
        for (var index = globalStartIndex; index < globalStartIndex + size; ++index) {
          mVals.push(v.getByGlobalIndex(index));
        }
      }
      compMsVals.put(m, mVals);
    });

    values = new epiviz.datatypes.FeatureValueArray(cm,
      boundaries,
      globalStartIndex,
      cm.evaluateArr(compMsVals));

    self._mergeData(cm, values);

    return false;
  });
};

/**
 * Clears all data stored in cache
 */
epiviz.data.Cache.prototype.flush = function() {
  this._data = {};

  // Discard all pending requests
  this._measurementRequestStackMap.foreach(function(m, requestStack) { requestStack.clear(); });
  this._measurementPendingRequestsMap.clear();
};

/**
 * @param {string} datasourceGroup
 */
epiviz.data.Cache.prototype.clearDatasourceGroupCache = function(datasourceGroup) {
  delete this._data[datasourceGroup];
  this._measurementRequestStackMap.foreach(function(m, requestStack) {
    if (m.datasourceGroup() == datasourceGroup) { requestStack.clear(); }
  });

  var msToClear = [];
  this._measurementPendingRequestsMap.foreach(function(m, map) {
    if (m.datasourceGroup() == datasourceGroup) { msToClear.push(m); }
  });

  for (var i = 0; i < msToClear.length; ++i) {
    this._measurementPendingRequestsMap.put(msToClear[i], {});
  }
};

// Input 94
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/8/13
 * Time: 2:34 PM
 */

goog.provide('epiviz.datatypes.GenomicArray');

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicRange} boundaries
 * @param {number} globalStartIndex
 * @param {*} values
 * @constructor
 */
epiviz.datatypes.GenomicArray = function(measurement, boundaries, globalStartIndex, values) {
  /**
   * @type {epiviz.measurements.Measurement}
   * @private
   */
  this._measurement = measurement;

  /**
   * @type {epiviz.datatypes.GenomicRange}
   * @private
   */
  this._boundaries = boundaries;

  /**
   * @type {?number}
   * @private
   */
  this._globalStartIndex = globalStartIndex;

  /**
   * @type {*}
   * @protected
   */
  this._values = values;
};

/**
 * @returns {epiviz.datatypes.GenomicRange}
 */
epiviz.datatypes.GenomicArray.prototype.boundaries = function() { return this._boundaries; };

/**
 * @returns {?number}
 */
epiviz.datatypes.GenomicArray.prototype.globalStartIndex = function() {
  return this._globalStartIndex;
};

/**
 * @returns {epiviz.measurements.Measurement}
 */
epiviz.datatypes.GenomicArray.prototype.measurement = function() {
  return this._measurement;
};

/**
 * @param {number} index
 * @returns {*}
 */
epiviz.datatypes.GenomicArray.prototype.get = function(index) { throw Error('unimplemented abstract method'); };

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicArray.prototype.size = function() { throw Error('unimplemented abstract method'); };

/**
 * @param {number} globalIndex
 * @returns {*}
 */
epiviz.datatypes.GenomicArray.prototype.getByGlobalIndex = function(globalIndex) {
  return this.get(globalIndex - this._globalStartIndex);
};

/**
 * @param {epiviz.datatypes.GenomicArray} second
 * @param {number} secondIndex
 * @returns {*}
 */
epiviz.datatypes.GenomicArray.prototype.concatValues = function(second, secondIndex) { throw Error('unimplemented abstract method'); };

/**
 * Factory method
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicRange} boundaries
 * @param {number} globalStartIndex
 * @param {*} values
 * @returns {epiviz.datatypes.GenomicArray}
 */
epiviz.datatypes.GenomicArray.prototype.createNew = function(measurement, boundaries, globalStartIndex, values) { throw Error('unimplemented abstract method'); };

/**
 * Merges two genomic arrays together by global index, eliminating common rows (where indices match)
 * IMPORTANT: This method fails if the given arrays are not overlapping or in continuation of one another
 * @param {epiviz.datatypes.GenomicArray} arr
 * @returns {epiviz.datatypes.GenomicArray}
 */
epiviz.datatypes.GenomicArray.prototype.merge = function(arr) {
  if (!arr || arr.boundaries() == undefined) {
    return this;
  }

  if (this.boundaries().seqName() != arr.boundaries().seqName() ||
    this.boundaries().start() > arr.boundaries().end() ||
    arr.boundaries().start() > this.boundaries().end()) {
    throw Error('Two genomic arrays can only be merged if they overlap or are in continuation to one another');
  }

  var first = (this.boundaries().start() < arr.boundaries().start()) ? this : arr;
  var second = (first == this) ? arr : this;

  if (first.boundaries().end() >= second.boundaries().end()) {
    // The first array contains the given array
    return first;
  }

  // Compute the index of the first element in the second array that isn't in the first as well;
  var secondIndex = (first.globalStartIndex() != undefined && second.globalStartIndex() != undefined) ?
    first.globalStartIndex() + first.size() - second.globalStartIndex() : 0;

  var
    measurement = first.measurement(),
    globalStartIndex = (first.globalStartIndex() != undefined) ? first.globalStartIndex() : second.globalStartIndex(),
    boundaries = epiviz.datatypes.GenomicRange.fromStartEnd(
      first.boundaries().seqName(),
      first.boundaries().start(),
      second.boundaries().end()),
    values = first.concatValues(second, secondIndex);

  return this.createNew(measurement, boundaries, globalStartIndex, values);
};

// Input 95
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/1/13
 * Time: 10:26 AM
 */

goog.provide('epiviz.datatypes.GenomicRangeArray');

goog.require('epiviz.datatypes.GenomicArray');
goog.require('epiviz.datatypes.GenomicRange');
goog.require('epiviz.utils');

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicRange} boundaries
 * @param {number} globalStartIndex
 * @param {{id: Array.<string>, start: Array.<number>, end: Array.<number>, strand: Array.<string>|string, metadata: Object.<string, Array>}} values
 * @param {boolean} [useOffset] True if the values are compressed and false/undefined/null otherwise
 * @constructor
 * @implements {epiviz.utils.Iterable}
 * @extends {epiviz.datatypes.GenomicArray}
 */
epiviz.datatypes.GenomicRangeArray = function(measurement, boundaries, globalStartIndex, values, useOffset) {

  epiviz.datatypes.GenomicArray.call(this, measurement, boundaries, globalStartIndex, values);

  /**
   * @type {Array.<string>}
   * @private
   */
  this._id = values.id;

  /**
   * @type {Array.<number>}
   * @private
   */
  this._start = values.start;

  /**
   * @type {Array.<number>}
   * @private
   */
  this._end = values.end;

  /**
   * @type {Array.<string>|string}
   * @private
   */
  this._strand = values.strand || null;

  /**
   * @type {Object.<string, Array>}
   * @private
   */
  this._metadata = values.metadata;

  /**
   * @type {?number}
   * @private
   */
  this._size = null;

  // If useOffset is true, it means that the values in the start/end arrays are compressed, and each value
  // in the array (with the exception of the first) is the offset between the real value and the previous one.
  // If the values are compressed, here we decompress them:
  if (useOffset) {
    var i;
    for (i = 1; i < this._start.length; ++i) {
      this._start[i] += this._start[i - 1];

      if (this._end) { this._end[i] += this._end[i - 1]; }
    }
  }
};

/**
 * Copy methods from upper class
 */
epiviz.datatypes.GenomicRangeArray.prototype = epiviz.utils.mapCopy(epiviz.datatypes.GenomicArray.prototype);
epiviz.datatypes.GenomicRangeArray.constructor = epiviz.datatypes.GenomicRangeArray;

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicRange} boundaries
 * @param {number} globalStartIndex
 * @param {{id: Array.<string>, start: Array.<number>, end: Array.<number>, strand: Array.<string>|string, metadata: Object.<string, Array>}} values
 * @returns {epiviz.datatypes.GenomicArray}
 * @override
 */
epiviz.datatypes.GenomicRangeArray.prototype.createNew = function(measurement, boundaries, globalStartIndex, values) {
  return new epiviz.datatypes.GenomicRangeArray(measurement, boundaries, globalStartIndex, values);
};

/**
 * @param {number} i a numeric index of the row
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 * @override
 */
epiviz.datatypes.GenomicRangeArray.prototype.get = function(i) {
  if (i < 0 || i >= this.size()) { return null; }

  return new epiviz.datatypes.GenomicRangeArray.RowItemWrapper(this, i);
};

/**
 * @returns {number} the total number of items in the structure
 * @override
 */
epiviz.datatypes.GenomicRangeArray.prototype.size = function() {
  if (this._size == undefined) {
    var size = Math.max(
      this._id ? this._id.length : 0,
      this._start ? this._start.length : 0,
      this._end ? this._end.length : 0,
      (this._metadata && Object.keys(this._metadata).length) ?
        Math.max.apply(undefined, $.map(this._metadata, function(col) { return col.length; })) : 0);
    this._size = size;
  }
  return this._size;
};

/**
 * @param {epiviz.datatypes.GenomicRangeArray} second
 * @param {number} secondIndex
 * @returns {{id: Array.<string>, start: Array.<number>, end: Array.<number>, strand: Array.<string>|string, metadata: Object.<string, Array>}}
 */
epiviz.datatypes.GenomicRangeArray.prototype.concatValues = function(second, secondIndex) {
  var strand = null;
  if (!Array.isArray(this._strand) && !Array.isArray(second._strand) && this._strand == second._strand) {
    strand = this._strand;
  } else {
    var
      firstStrand = Array.isArray(this._strand) ? this._strand : epiviz.utils.fillArray(this.size(), this._strand),
      secondStrand = Array.isArray(second._strand) ? second._strand : epiviz.utils.fillArray(second.size(), second._strand);
    strand = firstStrand.concat(secondStrand.slice(secondIndex))
  }

  var
    id = this._id ? this._id.concat(second._id.slice(secondIndex)) : null,
    start = this._start.concat(second._start.slice(secondIndex)),
    end = this._end ? this._end.concat(second._end.slice(secondIndex)) : null;

  // Concatenate metadata values. We assume that both structures have the same columns
  var metadata = {};
  for (var col in this._metadata) {
    if (!this._metadata.hasOwnProperty(col)) { continue; }
    metadata[col] = this._metadata[col].concat(second._metadata[col].slice(secondIndex));
  }

  return {
    id: id,
    start: start,
    end: end,
    strand: strand,
    metadata: metadata
  };
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {?epiviz.datatypes.GenomicRangeArray}
 */
epiviz.datatypes.GenomicRangeArray.prototype.trim = function(range) {
  if (this.globalStartIndex() == undefined || !this.size() || !range || !this.boundaries() || this.boundaries().seqName() != range.seqName()) {
    return null;
  }

  var start = Math.max(this.boundaries().start(), range.start());
  var end = Math.min(this.boundaries().end(), range.end());
  if (end <= start) { return null; }
  range = epiviz.datatypes.GenomicRange.fromStartEnd(range.seqName(), start, end);

  var startIndex = -1;
  var endIndex = -1;
  for (var i = 0; i < this.size(); ++i) {
    if (startIndex < 0 && this.end(i) >= range.start()) { startIndex = i; }
    if (this._start[i] < range.end()) { endIndex = i + 1; }
  }
  if (endIndex <= startIndex) { return null; }

  var values, globalStartIndex;
  var col;

  if (startIndex >= 0 && endIndex >= startIndex) {
    values = {
      id: this._id ? this._id.slice(startIndex, endIndex) : null,
      start: this._start.slice(startIndex, endIndex),
      end: this._end ? this._end.slice(startIndex, endIndex) : null,
      strand: Array.isArray(this._strand) ? this._strand.slice(startIndex, endIndex) : this._strand,
      metadata: {}
    };
    for (col in this._metadata) {
      if (!this._metadata.hasOwnProperty(col)) { continue; }
      values.metadata[col] = this._metadata[col].slice(startIndex, endIndex);
    }
    globalStartIndex = this.globalStartIndex() + startIndex;
  } else {
    values = {
      id: this._id ? [] : null,
      start: [],
      end: this._end ? [] : null,
      strand: Array.isArray(this._strand) ? [] : this._strand,
      metadata: {}
    };
    for (col in this._metadata) {
      if (!this._metadata.hasOwnProperty(col)) { continue; }
      values.metadata[col] = [];
    }
    globalStartIndex = null;
  }

  return new epiviz.datatypes.GenomicRangeArray(this.measurement(), range, globalStartIndex, values);
};

/**
 * @returns {epiviz.datatypes.GenomicRangeArray}
 */
epiviz.datatypes.GenomicRangeArray.prototype.ranges = function() { return this; };

/**
 * Iterates through all genomic ranges until func returns something that evaluates to true
 * @param {function(epiviz.datatypes.GenomicData.RowItem)} func
 */
epiviz.datatypes.GenomicRangeArray.prototype.foreach = function(func) {
  var size = this.size();
  for (var i = 0; i < size; ++i) {
    if (func(this.get(i))) { return; }
  }
};

/**
 * @returns {Array.<string>} the names of the metadata columns associated with the epiviz.datatypes.GenomicRangeArray instance
 */
epiviz.datatypes.GenomicRangeArray.prototype.metadataColumns = function() {
  if (this._metadata) {
    return Object.keys(this._metadata);
  }

  return [];
};

/**
 * @param {number} index
 * @returns {string}
 */
epiviz.datatypes.GenomicRangeArray.prototype.id = function(index) {
  return this._id ? this._id[index] : this.globalStartIndex() + index;
};

/**
 * @param {number} index
 * @returns {number}
 */
epiviz.datatypes.GenomicRangeArray.prototype.start = function(index) {
  return this._start ? this._start[index] : undefined;
};

/**
 * @param {number} index
 * @returns {number}
 */
epiviz.datatypes.GenomicRangeArray.prototype.end = function(index) {
  return this._end ? this._end[index] : this.start(index);
};

/**
 * @param {number} index
 * @returns {string}
 */
epiviz.datatypes.GenomicRangeArray.prototype.strand = function(index) {
  return Array.isArray(this._strand) ? this._strand[index] : this._strand;
};

/**
 * @param {string} column
 * @param {number} index
 * @returns {*}
 */
epiviz.datatypes.GenomicRangeArray.prototype.metadata = function(column, index) {
  if (!this._metadata || !this._metadata[column]) { return null; }
  return this._metadata[column][index];
};

/**
 * @param {number} index
 * @returns {Object.<string, *>}
 */
epiviz.datatypes.GenomicRangeArray.prototype.rowMetadata = function(index) {
  var result = {};
  for (var column in this._metadata) {
    if (!this._metadata.hasOwnProperty(column)) { continue; }
    result[column] = this._metadata[column][index];
  }

  return result;
};

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicRangeArray.prototype.toString = function() {
  var c, s, e;
  if (this.boundaries()) {
    c = this.boundaries().seqName();
    s = this.boundaries().start();
    e = this.boundaries().end();
  } else {
    c = s = e = '*';
  }
  var header = sprintf('%25s', this.measurement().name().substr(0, 22)) + sprintf(' [%6s%10s%10s]', c, s, e);
  var id = sprintf('%10s:', 'id');
  var idx = sprintf('%10s:', 'idx');
  var chr = sprintf('%10s:', 'chr');
  var start = sprintf('%10s:', 'start');
  var end = sprintf('%10s:', 'end');

  if (this.globalStartIndex() != undefined) {
    for (var globalIndex = this.globalStartIndex(); globalIndex < this.globalStartIndex() + this.size(); ++globalIndex) {
      /** @type {epiviz.datatypes.GenomicData.RowItem} */
      var row = this.getByGlobalIndex(globalIndex);
      id += sprintf('%10s', row.id());
      idx += sprintf('%10s', globalIndex);
      chr += sprintf('%10s', row.seqName());
      start += sprintf('%10s', row.start());
      end += sprintf('%10s', row.end());
    }
  }

  return [header, id, idx, chr, start, end].join('\n');
};

// goog.inherits(epiviz.datatypes.GenomicRangeArray, epiviz.datatypes.GenomicArray);

goog.provide('epiviz.datatypes.GenomicRangeArray.RowItemWrapper');

goog.require('epiviz.datatypes.GenomicData.RowItem');

/**
 * @param {epiviz.datatypes.GenomicRangeArray} parent
 * @param {number} index
 *
 * @constructor
 * @implements {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper = function(parent, index) {
  /**
   * @type {number}
   * @private
   */
  this._index = index;

  /**
   * @type {epiviz.datatypes.GenomicRangeArray}
   * @private
   */
  this._parent = parent;
};

/**
 * @returns {epiviz.datatypes.GenomicRangeArray}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.parent = function() {
  return this._parent;
};

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.id = function() {
  return this._parent.id(this._index);
};

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.seqName = function() {
  return this._parent.boundaries() ? this._parent.boundaries().seqName() : undefined;
};

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.start = function() {
  return this._parent.start(this._index);
};

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.end = function() {
  return this._parent.end(this._index);
};

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.index = function() {
  return this._index;
};

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.globalIndex = function() {
  return this._index + this._parent.globalStartIndex();
};

/**
 * @param {epiviz.datatypes.GenomicData.RowItem} other
 * @returns {boolean}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.equals = function(other) {
  if (!other) { return false; }
  if (this == other) { return true; }

  return (other.seqName() == this.seqName() &&
    other.start() == this.start() &&
    other.end() == this.end());
};

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.strand = function() {
  return this._parent.strand(this._index);
};

/**
 * @param {string} column
 * @returns {*}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.metadata = function(column) {
  return this._parent.metadata(column, this._index);
};

/**
 * @returns {Object.<string, *>}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.rowMetadata = function() {
  return this._parent.rowMetadata(this._index);
};

/**
 * @param {epiviz.datatypes.GenomicData.RowItem} other
 * @returns {boolean}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.overlapsWith = function(other) {
  if (!other) { return false; }
  if (this == other) { return true; }
  if (this.seqName() != other.seqName()) { return false; }
  return (this.start() < other.end() && this.end() > other.start());
};
// Input 96
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/8/13
 * Time: 8:31 AM
 */

goog.provide('epiviz.datatypes.FeatureValueArray');

goog.require('epiviz.datatypes.GenomicArray');
goog.require('epiviz.datatypes.GenomicRange');
goog.require('epiviz.utils');

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicRange} boundaries
 * @param {number} globalStartIndex
 * @param {Array.<number>|Object.<string, Array.<*>>} values
 * @constructor
 * @extends {epiviz.datatypes.GenomicArray}
 */
epiviz.datatypes.FeatureValueArray = function(measurement, boundaries, globalStartIndex, values) {
  var vals = null;
  var valuesAnnotation = null;
  if (!values || $.isArray(values)) {
    vals = values;
    valuesAnnotation = {values: values};
  } else {
    vals = values.values;
    valuesAnnotation = values;
  }

  epiviz.datatypes.GenomicArray.call(this, measurement, boundaries, globalStartIndex, vals);

  /**
   * @type {Object.<string, Array.<*>>}
   * @private
   */
  this._valuesAnnotation = valuesAnnotation;
};

/**
 * Copy methods from upper class
 */
epiviz.datatypes.FeatureValueArray.prototype = epiviz.utils.mapCopy(epiviz.datatypes.GenomicArray.prototype);
epiviz.datatypes.FeatureValueArray.constructor = epiviz.datatypes.FeatureValueArray;

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicRange} boundaries
 * @param {number} globalStartIndex
 * @param {Array.<number>} values
 * @returns {epiviz.datatypes.GenomicArray}
 * @override
 */
epiviz.datatypes.FeatureValueArray.prototype.createNew = function(measurement, boundaries, globalStartIndex, values) {
  return new epiviz.datatypes.FeatureValueArray(measurement, boundaries, globalStartIndex, values);
};

/**
 * @param {number} index
 * @returns {number}
 * @override
 */
epiviz.datatypes.FeatureValueArray.prototype.get = function(index) {
  return this._values[index];
};

/**
 * @param index
 * @returns {?Object.<string, *>}
 */
epiviz.datatypes.FeatureValueArray.prototype.getAnnotation = function(index) {
  if (this._valuesAnnotation == undefined) { return null; }
  var ret = {};
  for (var col in this._valuesAnnotation) {
    if (!this._valuesAnnotation.hasOwnProperty(col)) { continue; }
    ret[col] = this._valuesAnnotation[col][index];
  }
  return ret;
};

/**
 * @returns {number}
 * @override
 */
epiviz.datatypes.FeatureValueArray.prototype.size = function() {
  return this._values ? this._values.length : 0;
};

/**
 * @param {epiviz.datatypes.FeatureValueArray} second
 * @param {number} secondIndex
 * @returns {Array.<number>|Object.<string, *>}
 */
epiviz.datatypes.FeatureValueArray.prototype.concatValues = function(second, secondIndex) {
  if (!second || !second.size()) { return this._valuesAnnotation; }
  if (!this._valuesAnnotation || !this._valuesAnnotation.values) {
    this._valuesAnnotation = {values:[]};
  }
  var ret = {};
  for (var key in this._valuesAnnotation) {
    if (!this._valuesAnnotation.hasOwnProperty(key)) { continue; }
    if (!second._valuesAnnotation.hasOwnProperty(key)) { continue; }
    ret[key] = this._valuesAnnotation[key].concat(second._valuesAnnotation[key].slice(secondIndex));
  }
  return ret;
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {number} globalStartIndex
 * @param {number} length
 * @returns {epiviz.datatypes.FeatureValueArray}
 */
epiviz.datatypes.FeatureValueArray.prototype.trim = function(range, globalStartIndex, length) {
  if (this.globalStartIndex() == undefined || !this.size() ||
    globalStartIndex == undefined || !range ||
    !this.boundaries() || this.boundaries().seqName() != range.seqName()) {
    return null;
  }

  var start = Math.max(this.boundaries().start(), range.start());
  var end = Math.min(this.boundaries().end(), range.end());
  if (end <= start) { return null; }
  range = epiviz.datatypes.GenomicRange.fromStartEnd(range.seqName(), start, end);

  var startIndex = Math.max(globalStartIndex, this.globalStartIndex()) - this.globalStartIndex();
  var endIndex = Math.min(globalStartIndex + length, this.globalStartIndex() + this.size()) - this.globalStartIndex();
  if (endIndex <= startIndex) { return null; }
  /** @type {Object.<string, Array.<*>>} */
  var values = {};
  for (var key in this._valuesAnnotation) {
    if (!this._valuesAnnotation.hasOwnProperty(key)) { continue; }
    values[key] = this._valuesAnnotation[key].slice(startIndex, endIndex);
  }
  return new epiviz.datatypes.FeatureValueArray(this.measurement(), range, startIndex + this.globalStartIndex(), values);
};

/**
 * @returns {string}
 */
epiviz.datatypes.FeatureValueArray.prototype.toString = function() {
  var c, s, e;
  if (this.boundaries()) {
    c = this.boundaries().seqName();
    s = this.boundaries().start();
    e = this.boundaries().end();
  } else {
    c = s = e = '*';
  }
  var header = sprintf('%25s', this.measurement().name().substr(0, 22)) + sprintf(' [%6s%10s%10s]', c, s, e);
  var idx = sprintf('%10s:', 'idx');
  var val = sprintf('%10s:', 'val');

  if (this.globalStartIndex() != undefined) {
    for (var globalIndex = this.globalStartIndex(); globalIndex < this.globalStartIndex() + this.size(); ++globalIndex) {
      /** @type {number} */
      var v = this.getByGlobalIndex(globalIndex);
      idx += sprintf('%10s', globalIndex);
      val += sprintf('%10s', v);
    }
  }

  return [header, idx, val].join('\n');
};

// goog.inherits(epiviz.datatypes.FeatureValueArray, epiviz.datatypes.GenomicArray);
// Input 97
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/8/13
 * Time: 12:45 PM
 */

goog.provide('epiviz.datatypes.MeasurementGenomicDataWrapper');

goog.require('epiviz.datatypes.MeasurementGenomicData');
goog.require('epiviz.datatypes.GenomicData.ValueItem');
goog.require('epiviz.measurements.Measurement.Type');


/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.PartialSummarizedExperiment} container
 * @constructor
 * @implements {epiviz.datatypes.MeasurementGenomicData}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper = function(measurement, container) {
  /**
   * @type {epiviz.measurements.Measurement}
   * @private
   */
  this._measurement = measurement;

  /**
   * @type {epiviz.datatypes.PartialSummarizedExperiment}
   * @private
   */
  this._container = container;

  /**
   * @type {?number}
   * @private
   */
  this._size = null;

  /**
   * @type {?number}
   * @private
   */
  this._globalStartIndex = null;
};

/**
 * @param {number} index
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.get = function(index) {
  var rows = this._container.rowData();
  var values = null;
  var firstGlobalIndex = this.globalStartIndex();

  var item = null;
  var value = null;
  var valueAnnotation = null;
  var globalIndex = null;

  var size = this.size();
  if (!size || index >= size || index < 0) {
    return new epiviz.datatypes.GenomicData.ValueItem(globalIndex, item, value, this._measurement, valueAnnotation);
  }

  if (firstGlobalIndex != undefined) {
    if (this._measurement.type() == epiviz.measurements.Measurement.Type.FEATURE ||
      this._measurement.type() == epiviz.measurements.Measurement.Type.UNORDERED) {
      values = this._container.values(this._measurement);
      var valueIndex = firstGlobalIndex - values.globalStartIndex() + index;
      value = values.get(valueIndex);
      valueAnnotation = values.getAnnotation(valueIndex);
    }

    var rowIndex = firstGlobalIndex - rows.globalStartIndex() + index;
    item = rows.get(rowIndex);

    globalIndex = firstGlobalIndex + index;
  }

  return new epiviz.datatypes.GenomicData.ValueItem(globalIndex, item, value, this._measurement, valueAnnotation);
};

/**
 * @param {number} index
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.getRow = function(index) {
  var rows = this._container.rowData();
  var firstGlobalIndex = this.globalStartIndex();

  var item = null;

  var size = this.size();
  if (!size || index >= size || index < 0) {
    return item;
  }

  if (firstGlobalIndex != undefined) {
    var rowIndex = firstGlobalIndex - rows.globalStartIndex() + index;
    item = rows.get(rowIndex);
  }

  return item;
};

/**
 * @returns {epiviz.measurements.Measurement}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.measurement = function() {
  return this._measurement;
};

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.globalStartIndex = function() {
  if (this._globalStartIndex !== null) { return this._globalStartIndex; }

  /**
   * @type {?epiviz.datatypes.GenomicRangeArray}
   */
  var rows = this._container.rowData();
  var values = null;
  var firstGlobalIndex = rows.globalStartIndex();

  if (firstGlobalIndex === null) { return firstGlobalIndex; }

  if (this._measurement.type() == epiviz.measurements.Measurement.Type.FEATURE ||
    this._measurement.type() == epiviz.measurements.Measurement.Type.UNORDERED) {
    values = this._container.values(this._measurement);
    if (!values.globalStartIndex()) { return values.globalStartIndex(); }
    firstGlobalIndex = Math.max(firstGlobalIndex, values.globalStartIndex());
  }

  this._globalStartIndex = firstGlobalIndex;
  return this._globalStartIndex;
};

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.globalEndIndex = function() {
  var startIndex = this.globalStartIndex();
  if (startIndex == null) { return null; }
  return startIndex + this.size();
};

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.size = function() {
  if (this._size !== null) { return this._size; }

  var firstGlobalIndex = this.globalStartIndex();
  if (firstGlobalIndex == undefined) { return 0; }

  var rows = this._container.rowData();
  var values = this._container.values(this._measurement);

  var result = rows.size() - firstGlobalIndex + rows.globalStartIndex();

  if (this._measurement.type() == epiviz.measurements.Measurement.Type.FEATURE ||
    this._measurement.type() == epiviz.measurements.Measurement.Type.UNORDERED) {
    result = Math.min(result, values.size() - firstGlobalIndex + values.globalStartIndex());
  }

  this._size = Math.max(0, result);

  return this._size;
};

/**
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.getByGlobalIndex = function(globalIndex) {
  var firstGlobalIndex = this.globalStartIndex();
  if (firstGlobalIndex == undefined) { return new epiviz.datatypes.GenomicData.ValueItem(null, null, null, this._measurement, null); }

  return this.get(globalIndex - firstGlobalIndex);
};

/**
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.getRowByGlobalIndex = function(globalIndex) {
  var firstGlobalIndex = this.globalStartIndex();
  if (firstGlobalIndex == undefined) { return null; }

  return this.getRow(globalIndex - firstGlobalIndex);
};

/**
 * Gets the first index and length of the rows that have start positions within the given range
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {{index: ?number, length: number}}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.binarySearchStarts = function(range) {

  /** @type {?epiviz.datatypes.GenomicRangeArray} */
  var rows = this._container.rowData();

  if (this.size() == 0 || !rows || rows.size() == 0 || rows.start(0) >= range.end() || rows.start(rows.size() - 1) <= range.start()) { return {index: null, length: 0}; }

  // Perform binary search to find the start row index

  var s = 0, e = rows.size() - 1;
  var m;

  var startIndex = null;

  while (s <= e) {
    m = Math.floor((s + e) * 0.5);
    if (rows.start(m) == range.start()) {
      startIndex = m;
      e = m - 1;
    } else if (rows.start(m) < range.start()) { s = m + 1; }
    else { e = m - 1; }
  }

  if (startIndex === null) { startIndex = s; }

  // Perform binary search to find the end row index

  s = 0;
  e = rows.size() - 1;

  var endIndex = null;

  while (s <= e) {
    m = Math.floor((s + e) * 0.5);
    if (rows.start(m) == range.end()) {
      endIndex = m;
      s = m + 1;
    } else if (rows.start(m) < range.end()) { s = m + 1; }
    else { e = m - 1; }
  }

  if (endIndex === null) { endIndex = s - 1; }

  var globalStartIndex = Math.max(startIndex + rows.globalStartIndex(), this.globalStartIndex());
  var globalEndIndex = Math.min(endIndex + rows.globalStartIndex(), this.globalStartIndex() + this.size() - 1);

  return {
    index: globalStartIndex - this.globalStartIndex(),
    length: globalEndIndex - globalStartIndex + 1
  };
};

// Input 98
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 7:50 PM
 */

goog.provide('epiviz.data.DataManager');

goog.require('epiviz.data.DataProvider');
goog.require('epiviz.data.DataProviderFactory');
goog.require('epiviz.measurements.MeasurementSet');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.events.EventListener');
goog.require('epiviz.data.Cache');
goog.require('epiviz.events.Event');
goog.require('epiviz.data.RequestStack');
goog.require('epiviz.datatypes.GenomicRangeArray');
goog.require('epiviz.datatypes.FeatureValueArray');
goog.require('epiviz.datatypes.MeasurementGenomicData');
goog.require('epiviz.datatypes.MeasurementGenomicDataWrapper');
goog.require('epiviz.events.EventResult');
// goog.require('epiviz.utils.arrayAppend');
// goog.require('epiviz.utils.forEach');
goog.require('epiviz.utils');


/**
 * @param {epiviz.Config} config
 * @param {epiviz.data.DataProviderFactory} dataProviderFactory
 * @constructor
 */
epiviz.data.DataManager = function(config, dataProviderFactory) {

  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._measurements = new epiviz.measurements.MeasurementSet();

  /**
   * @type {epiviz.data.DataProviderFactory}
   * @private
   */
  this._dataProviderFactory = dataProviderFactory;

  /**
   * @type {epiviz.data.Cache}
   * @private
   */
  this._cache = new epiviz.data.Cache(config, dataProviderFactory);

  /**
   * @type {Object.<string, epiviz.data.RequestStack>}
   * @private
   */
  this._combinedRequestsStacks = {};

  /**
   * @type {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestAddMeasurements = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRemoveMeasurements = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{type: string, visConfigSelection: epiviz.ui.controls.VisConfigSelection, result: epiviz.events.EventResult.<{id: string}>}>}
   * @private
   */
  this._requestAddChart = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRemoveChart = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestPrintWorkspace = new epiviz.events.Event();

    /**
   * @type {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestLoadWorkspace = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{seqInfos: Array.<epiviz.datatypes.SeqInfo>, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestAddSeqInfos = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{seqNames: Array.<string>, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRemoveSeqNames = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{range: epiviz.datatypes.GenomicRange, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestNavigate = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRedraw = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event}
   * @private
   */
  this._flushCache = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{datasourceGroup: string}>}
   * @private
   */
  this._clearDatasourceGroupCache = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestCurrentLocation = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestGetChartSettings = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestSetChartSettings = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestGetAvailableCharts = new epiviz.events.Event();


  this._registerProviderAddMeasurements();
  this._registerProviderRemoveMeasurements();
  this._registerProviderAddChart();
  this._registerProviderRemoveChart();
  this._registerProviderPrintWorkspace();
  this._registerProviderLoadWorkspace();
  this._registerProviderAddSeqInfos();
  this._registerProviderRemoveSeqNames();
  this._registerProviderNavigate();
  this._registerProviderRedraw();
  this._registerProviderFlushCache();
  this._registerProviderClearDatasourceGroupCache();
  this._registerProviderGetCurrentLocation();
  this._registerProviderGetChartSettings();
  this._registerProviderSetChartSettings();
  this._registerProviderGetAvailableCharts();

};

/**
 * @returns {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestAddMeasurements = function() { return this._requestAddMeasurements; };

/**
 * @returns {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestRemoveMeasurements = function() { return this._requestRemoveMeasurements; };

/**
 * @returns {epiviz.events.Event.<{type: string, visConfigSelection: epiviz.ui.controls.VisConfigSelection, result: epiviz.events.EventResult.<{id: string}>}>}
 */
epiviz.data.DataManager.prototype.onRequestAddChart = function() { return this._requestAddChart; };

/**
 * @returns {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestRemoveChart = function() { return this._requestRemoveChart; };

/**
 * @returns {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestPrintWorkspace = function() { return this._requestPrintWorkspace; };

/**
 * @returns {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestLoadWorkspace = function() { return this._requestLoadWorkspace; };


/**
 * @returns {epiviz.events.Event.<{seqInfos: Array.<epiviz.datatypes.SeqInfo>, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestAddSeqInfos = function() { return this._requestAddSeqInfos; };

/**
 * @returns {epiviz.events.Event.<{seqNames: Array.<string>, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestRemoveSeqNames = function() { return this._requestRemoveSeqNames; };

/**
 * @returns {epiviz.events.Event.<{range: epiviz.datatypes.GenomicRange, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestNavigate = function() { return this._requestNavigate; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestRedraw = function() { return this._requestRedraw; };

/**
 * @returns {epiviz.events.Event.<{datasourceGroup: string}>}
 */
epiviz.data.DataManager.prototype.onClearDatasourceGroupCache = function() { return this._clearDatasourceGroupCache; };

/**
 * @returns {epiviz.events.Event}
 */
epiviz.data.DataManager.prototype.onFlushCache = function() { return this._flushCache; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestCurrentLocation = function() { return this._requestCurrentLocation; };

/**
 * @returns {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestGetChartSettings = function() { return this._requestGetChartSettings; };

/**
 * @returns {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestSetChartSettings = function() { return this._requestSetChartSettings; };

/**
 * @returns {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestGetAvailableCharts = function() { return this._requestGetAvailableCharts; };


/**
 * @param {function(Array.<epiviz.datatypes.SeqInfo>)} callback
 */
epiviz.data.DataManager.prototype.getSeqInfos = function(callback) {
  var self = this;

  var nResponses = 0;

  var existingSeqNames = {};

  /** @type {Array.<epiviz.datatypes.SeqInfo>} */
  var result = [];
  this._dataProviderFactory.foreach(function(provider) {
    provider.getData(epiviz.data.Request.getSeqInfos(provider.id()),
      /**
       * @param {epiviz.data.Response.<Array.<Array>>} response Each element in the response is an array with three values:
       * the name of the sequence, the minimum and maximum values it can have
       */
      function(response) {
        var seqs = response.data();
        if (seqs) {
          if(!Array.isArray(seqs)) {
            var keys = Object.keys(seqs);
            for (var i=0; i<keys.length; i++) {
              if (!(keys[i] in existingSeqNames)) {
                result.push(epiviz.datatypes.SeqInfo.fromRawObject([keys[i], seqs[keys[i]][0], seqs[keys[i]][1]]));
                existingSeqNames[keys[i]] = true;
              }
            }
          }
          else {
            for (var i = 0; i < seqs.length; ++i) {
              if (!(seqs[i][0] in existingSeqNames)) {
                result.push(epiviz.datatypes.SeqInfo.fromRawObject(seqs[i]));
                existingSeqNames[seqs[i][0]] = true;
              }
            }
          }
        }

        if (++nResponses < self._dataProviderFactory.size()) { return; }

        callback(result.sort(epiviz.datatypes.SeqInfo.compare));
      });
  });
};

/**
 */
epiviz.data.DataManager.prototype.updateChartSettings = function(values) {
  var self = this;

  this._dataProviderFactory.foreach(function(provider) {

    if(provider.id().includes('websocket-')) {

      var colors = null;

      if(values.colorMap != null) {
        colors = values.colorMap._colors;
      }

      provider.updateChartSettings(epiviz.data.Request.createRequest({
            action: epiviz.data.Request.Action.SET_CHART_SETTINGS,
            settings: values.settings,
            colorMap: colors,
            chartId: values.chartId
      }),
          function() {
            //do nothing
          }
      );  
    }
  });
};


/**
 * @param {function(epiviz.measurements.MeasurementSet)} callback
 */
epiviz.data.DataManager.prototype.getMeasurements = function(callback) {
  var self = this;
  var result = new epiviz.measurements.MeasurementSet();

  var nResponses = 0;
  this._dataProviderFactory.foreach(function(provider) {
    provider.getData(epiviz.data.Request.getMeasurements(provider.id()),
      /**
       * @param {epiviz.data.Response.<{
       *   id: Array.<number>,
       *   name: Array.<string>,
       *   type: Array.<string>|string,
       *   datasourceId: Array.<string>|string,
       *   datasourceGroup: Array.<string>|string,
       *   defaultChartType: Array.<string>|string,
       *   annotation: Array.<Object.<string, string>>,
       *   minValue: Array.<number>|number,
       *   maxValue: Array.<number>|number,
       *   metadata: Array.<Array.<string>>|Array.<string>
       * }>} response
       */
      function(response) {
        var jsondata = response.data();

        if (jsondata) {
          var n = jsondata['id'] ? (jsondata['id'].length || 0) : 0;
          for (var i = 0; i < n; ++i) {
            result.add(new epiviz.measurements.Measurement(
              jsondata['id'][i],
              jsondata['name'][i],
              $.isArray(jsondata['type']) ? jsondata['type'][i] : jsondata['type'],
              $.isArray(jsondata['datasourceId']) ? jsondata['datasourceId'][i] : jsondata['datasourceId'],
              $.isArray(jsondata['datasourceGroup']) ? jsondata['datasourceGroup'][i] : jsondata['datasourceGroup'],
              provider.id(),
              null,
              $.isArray(jsondata['defaultChartType']) ? jsondata['defaultChartType'][i] : jsondata['defaultChartType'],
              jsondata['annotation'][i],
              $.isArray(jsondata['minValue']) ? jsondata['minValue'][i] : jsondata['minValue'],
              $.isArray(jsondata['maxValue']) ? jsondata['maxValue'][i] : jsondata['maxValue'],
              ($.isArray(jsondata['metadata']) && $.isArray(jsondata['metadata'][0])) ? jsondata['metadata'][i] : jsondata['metadata']
            ));
          }
        }

        if (++nResponses < self._dataProviderFactory.size()) { return; }

        callback(result);
      });
  });
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {function(string, epiviz.datatypes.GenomicData)} dataReadyCallback
 */
epiviz.data.DataManager.prototype.getData = function(range, chartMeasurementsMap, dataReadyCallback) {
  if (this._config.useCache) {
    this._cache.getData(range, chartMeasurementsMap, dataReadyCallback);
  } else {
    this._getDataNoCache(range, chartMeasurementsMap, dataReadyCallback);
  }
};

/**
 * TODO: Take care of computed measurements as well
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {function(string, epiviz.datatypes.GenomicData)} dataReadyCallback
 */
epiviz.data.DataManager.prototype._getDataNoCache = function(range, chartMeasurementsMap, dataReadyCallback) {
  var self = this;

  /** @type {Object.<string, epiviz.measurements.MeasurementSet>} */
  var msByDp = {};
  for (var chartId in chartMeasurementsMap) {
    if (!chartMeasurementsMap.hasOwnProperty(chartId)) { continue; }
    var chartMsByDp = chartMeasurementsMap[chartId].split(function(m) { return m.dataprovider(); });
    for (var dp in chartMsByDp) {
      if (!chartMsByDp.hasOwnProperty(dp)) { continue; }
      var dpMs = msByDp[dp];
      if (dpMs == undefined) { msByDp[dp] = chartMsByDp[dp]; }
      else { dpMs.addAll(chartMsByDp[dp]); }
    }
  }

  /**
   * @type {Object.<string, Object.<string, epiviz.datatypes.PartialSummarizedExperiment>>}
   */
  var allData = {};
  epiviz.utils.forEach(msByDp, function(dpMs, dataprovider) {
    var msByDs = dpMs.split(function(m) { return m.datasource().id(); });
    var request = epiviz.data.Request.getCombined(msByDs, range);

    var requestStack = self._combinedRequestsStacks[dataprovider];
    if (requestStack == undefined) {
      requestStack = new epiviz.data.RequestStack();
      self._combinedRequestsStacks[dataprovider] = requestStack;
    }

    requestStack.pushRequest(request, function(data) {
      var dataByDs = {};
      epiviz.utils.forEach(msByDs, function(dsMs, datasourceId) {
        var datasource = dsMs.first().datasource();
        var dsData = data[datasourceId];
        var sumExp = new epiviz.datatypes.PartialSummarizedExperiment();

        var globalStartIndex = dsData.globalStartIndex;

        if(isNaN(range._start)) {
          range._start = globalStartIndex;
        }

        if(isNaN(range._width)) {
          range._width = dsData.rows.end[dsData.rows.end.length-1] - range._start;
        }

        var rowData = new epiviz.datatypes.GenomicRangeArray(datasource, range, globalStartIndex, dsData.rows);

        sumExp.addRowData(rowData);

        dsMs.foreach(function(m) {
          var valueData = new epiviz.datatypes.FeatureValueArray(m, range, globalStartIndex, dsData.cols[m.id()]);
          sumExp.addValues(valueData);
        });

        dataByDs[datasourceId] = sumExp;
      });

      allData[dataprovider] = dataByDs;
      self._serveAvailableData(range, chartMeasurementsMap, dataReadyCallback, allData);
    });

    var dataProvider = self._dataProviderFactory.get(dataprovider) || self._dataProviderFactory.get(epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);
    dataProvider.getData(request, function(response) {
      requestStack.serveData(response);
    });
  });
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {function(string, epiviz.datatypes.GenomicData)} dataReadyCallback
 * @param {Object.<string, Object.<string, epiviz.datatypes.PartialSummarizedExperiment>>} data
 * @private
 */
epiviz.data.DataManager.prototype._serveAvailableData = function(range, chartMeasurementsMap, dataReadyCallback, data) {
  var resolvedCharts = [];
  epiviz.utils.forEach(chartMeasurementsMap, function(ms, chartId) {
    var allMsDataFetched = true;
    var msDataMap = new epiviz.measurements.MeasurementHashtable();
    ms.foreach(function(m) {
      if (!(m.dataprovider() in data)) {
        allMsDataFetched = false;
        return true; // break
      }

      var msData = new epiviz.datatypes.MeasurementGenomicDataWrapper(m, data[m.dataprovider()][m.datasource().id()]);
      msDataMap.put(m, msData);
    });

    if (allMsDataFetched) {
      var genomicData = new epiviz.datatypes.MapGenomicData(msDataMap);
      dataReadyCallback(chartId, genomicData);
      resolvedCharts.push(chartId);
    }
  });

  resolvedCharts.forEach(function(chartId) { delete chartMeasurementsMap[chartId]; });
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {function(string, *)} dataReadyCallback
 */
epiviz.data.DataManager.prototype.getPCA = function(range, chartMeasurementsMap, dataReadyCallback) {
  var self = this;

  /** @type {Object.<string, epiviz.measurements.MeasurementSet>} */
  var msByDp = {};
  for (var chartId in chartMeasurementsMap) {
    if (!chartMeasurementsMap.hasOwnProperty(chartId)) { continue; }     
    var chartMsByDp = chartMeasurementsMap[chartId].split(function(m) { return m.dataprovider(); });
    for (var dp in chartMsByDp) {
      if (!chartMsByDp.hasOwnProperty(dp)) { continue; }
      var dpMs = msByDp[dp];
      if (dpMs == undefined) { msByDp[dp] = chartMsByDp[dp]; }
      else { dpMs.addAll(chartMsByDp[dp]); }
    }
  }

  /**
   * @type {Object.<string, Object.<string, epiviz.datatypes.PartialSummarizedExperiment>>}
   */
  var allData = {};
  epiviz.utils.forEach(msByDp, function(dpMs, dataprovider) {
    var msByDs = dpMs.split(function(m) { return m.datasource().id(); });
    var request = epiviz.data.Request.getPCA(msByDs, range);
    var msName = Object.keys(msByDs)[0];

    var dataProvider = self._dataProviderFactory.get(dataprovider) || self._dataProviderFactory.get(epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);
    dataProvider.getData(request, function(response) {
      var resp = response.data();
      if(response.data().dataprovidertype == "websocket") {
        resp = resp[msName];
      }
      dataReadyCallback(chartId, resp);
    });
  });
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {function(string, *)} dataReadyCallback
 */
epiviz.data.DataManager.prototype.getDiversity = function(range, chartMeasurementsMap, dataReadyCallback) {
  var self = this;

  /** @type {Object.<string, epiviz.measurements.MeasurementSet>} */
  var msByDp = {};
  for (var chartId in chartMeasurementsMap) {
    if (!chartMeasurementsMap.hasOwnProperty(chartId)) { continue; }     
    var chartMsByDp = chartMeasurementsMap[chartId].split(function(m) { return m.dataprovider(); });
    for (var dp in chartMsByDp) {
      if (!chartMsByDp.hasOwnProperty(dp)) { continue; }
      var dpMs = msByDp[dp];
      if (dpMs == undefined) { msByDp[dp] = chartMsByDp[dp]; }
      else { dpMs.addAll(chartMsByDp[dp]); }
    }
  }

  /**
   * @type {Object.<string, Object.<string, epiviz.datatypes.PartialSummarizedExperiment>>}
   */
  var allData = {};
  epiviz.utils.forEach(msByDp, function(dpMs, dataprovider) {
    var msByDs = dpMs.split(function(m) { return m.datasource().id(); });
    var request = epiviz.data.Request.getDiversity(msByDs, range);
    var msName = Object.keys(msByDs)[0];

    var dataProvider = self._dataProviderFactory.get(dataprovider) || self._dataProviderFactory.get(epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);
    dataProvider.getData(request, function(response) {
      var resp = response.data();
      if(response.data().dataprovidertype == "websocket") {
        resp = resp[msName];
      }
      dataReadyCallback(chartId, resp);
    });
  });
};

/**
 * @param {Object.<string, epiviz.ui.controls.VisConfigSelection>} chartVisConfigSelectionMap
 * @param {function(string, *)} dataReadyCallback
 */
epiviz.data.DataManager.prototype.getHierarchy = function(chartVisConfigSelectionMap, dataReadyCallback) {
  for (var chartId in chartVisConfigSelectionMap) {
    if (!chartVisConfigSelectionMap.hasOwnProperty(chartId)) { continue; }
    var visConfigSelection = chartVisConfigSelectionMap[chartId];
  }
  var dataprovider = visConfigSelection.dataprovider;
  if (!dataprovider) {
    visConfigSelection.measurements.foreach(function(m) {
      if (m.dataprovider()) {
        dataprovider = m.dataprovider();
        return true;
      }
      return false;
    });
  }
  var datasourceGroup = visConfigSelection.datasourceGroup;
  if(!datasourceGroup) {
      visConfigSelection.measurements.foreach(function(m) {
      if (m.datasourceGroup()) {
        datasourceGroup = m.datasourceGroup();
        return true;
      }
      return false;
    });
  }
  var provider = this._dataProviderFactory.get(dataprovider) || this._dataProviderFactory.get(epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);
  provider.getData(epiviz.data.Request.getHierarchy(datasourceGroup, visConfigSelection.customData), function(response) {
    dataReadyCallback(chartId, response.data());
  });
};

/**
 * @param {Object.<string, epiviz.ui.controls.VisConfigSelection>} chartVisConfigSelectionMap
 * @param {function(string, *)} dataReadyCallback
 */
epiviz.data.DataManager.prototype.propagateHierarchyChanges = function(chartVisConfigSelectionMap, dataReadyCallback) {
  for (var chartId in chartVisConfigSelectionMap) {
    if (!chartVisConfigSelectionMap.hasOwnProperty(chartId)) { continue; }
    var visConfigSelection = chartVisConfigSelectionMap[chartId];
    var dataprovider = visConfigSelection.dataprovider;
    if (!dataprovider) {
      visConfigSelection.measurements.foreach(function(m) {
        if (m.dataprovider()) {
          dataprovider = m.dataprovider();
          return true;
        }
        return false;
      });
    }
    var provider = this._dataProviderFactory.get(dataprovider) || this._dataProviderFactory.get(epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);
    (function(chartId, provider, visConfigSelection) {
      provider.getData(epiviz.data.Request.propagateHierarchyChanges(
        visConfigSelection.datasourceGroup,
        visConfigSelection.customData.selection,
        visConfigSelection.customData.order,
        visConfigSelection.customData.selectedLevels), function(response) {

        setTimeout(function() {
          provider.onRequestClearDatasourceGroupCache().notify({
            datasourceGroup: visConfigSelection.datasourceGroup,
            result: new epiviz.events.EventResult()
          });
          provider.onRequestRedraw().notify({
            result: new epiviz.events.EventResult()
          });

          dataReadyCallback(chartId, response.data());
        }, 0);
      });
    })(chartId, provider, visConfigSelection);
  }
};


/**
 * @param {function(Array)} callback
 * @param {string} [filter]
 * @param {string} [requestWorkspaceId]
 */
epiviz.data.DataManager.prototype.getWorkspaces = function(callback, filter, requestWorkspaceId) {
  var workspaceProvider = this._dataProviderFactory.workspacesDataProvider();

  if (!workspaceProvider) { throw Error('Invalid data provider for workspaces (see Config.workspaceDataProvider)'); }

  workspaceProvider.getData(epiviz.data.Request.getWorkspaces(filter, requestWorkspaceId),
    /**
     * @param {epiviz.data.Response.<Array.<{id: string, id_v1: string, name: string, content: string}>>} response
     */
    function(response) {
      var wsRows = response.data();

      var workspaces = [];

      if (!wsRows || !wsRows.length) {
        // No workspaces in database
        callback(workspaces);
        return;
      }

      for (var i = 0; i < wsRows.length; ++i) {
        workspaces.push({
          id: wsRows[i].id,
          name: wsRows[i].name,
          content: JSON.parse(wsRows[i].content)
        });
      }
      callback(workspaces);
    });
};

/**
 * @param {epiviz.workspaces.Workspace} workspace
 * @param {epiviz.Config} config
 * @param {function(string)} callback
 */
epiviz.data.DataManager.prototype.saveWorkspace = function(workspace, config, callback) {
  var workspaceProvider = this._dataProviderFactory.workspacesDataProvider();

  if (!workspaceProvider) { throw Error('Invalid data provider for workspaces (see Config.workspaceDataProvider)'); }

  //workspaceProvider.saveWorkspace(workspace, callback);
  workspaceProvider.getData(epiviz.data.Request.saveWorkspace(workspace, config),
    /**
     * @param {epiviz.data.Response.<string>} response
     */
    function(response) {
      var workspaceId = response.data();
      callback(workspaceId);
    });
};

/**
 * @param {epiviz.workspaces.Workspace} workspace
 */
epiviz.data.DataManager.prototype.deleteWorkspace = function(workspace) {
  var workspaceProvider = this._dataProviderFactory.workspacesDataProvider();

  if (!workspaceProvider) { throw Error('Invalid data provider for workspaces (see Config.workspaceDataProvider)'); }

  workspaceProvider.getData(epiviz.data.Request.deleteWorkspace(workspace),
    /**
     * @param {epiviz.data.Response.<{success: boolean}>} response
     */
    function(response) {
      var success = response.data().success;
    });
};

/**
 * @param {function(Array)} callback
 * @param {string} query
 */
epiviz.data.DataManager.prototype.search = function(callback, query) {
  var self = this;
  var remainingResponses = this._dataProviderFactory.size();
  var results = [];
  this._dataProviderFactory.foreach(function(provider) {
    provider.getData(epiviz.data.Request.search(query, self._config.maxSearchResults),
      /**
       * @param {epiviz.data.Response.<Array.<{probe: string, gene: string, seqName: string, start: number, end: number}>>} response
       */
      function(response) {
        var providerResults = response.data();
        if (providerResults) {
          epiviz.utils.arrayAppend(results, providerResults);
        }

        --remainingResponses;

        if (!remainingResponses) {
          callback(results);
        }
      });
  });
};

/**
 * Clears all data from cache
 */
epiviz.data.DataManager.prototype.flushCache = function() {
  this._cache.flush();
  this._flushCache.notify();
};

/**
 * @param {string} datasourceGroup
 */
epiviz.data.DataManager.prototype.clearDatasourceGroupCache = function(datasourceGroup) {
  this._cache.clearDatasourceGroupCache(datasourceGroup);
  this._clearDatasourceGroupCache.notify({datasourceGroup: datasourceGroup});
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderAddMeasurements = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestAddMeasurements().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestAddMeasurements.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderRemoveMeasurements = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestRemoveMeasurements().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestRemoveMeasurements.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderAddChart = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestAddChart().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestAddChart.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderRemoveChart = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestRemoveChart().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestRemoveChart.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderPrintWorkspace = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestPrintWorkspace().addListener(new epiviz.events.EventListener(
        function(e) {
          self._requestPrintWorkspace.notify(e);
        }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderLoadWorkspace = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestLoadWorkspace().addListener(new epiviz.events.EventListener(
        function(e) {
          self._requestLoadWorkspace.notify(e);
        }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderAddSeqInfos = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestAddSeqInfos().addListener(new epiviz.events.EventListener(
      /**
       * @param {{seqInfos: Array.<Array>, result: epiviz.events.EventResult}} e
       */
      function(e) {
        var seqInfos = [];
        for (var i = 0; i < e.seqInfos.length; ++i) {
          seqInfos.push(epiviz.datatypes.SeqInfo.fromRawObject(e.seqInfos[i]));
        }
        self._requestAddSeqInfos.notify({seqInfos: seqInfos, result: e.result});
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderRemoveSeqNames = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestRemoveSeqNames().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestRemoveSeqNames.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderNavigate = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestNavigate().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestNavigate.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderRedraw = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestRedraw().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestRedraw.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderClearDatasourceGroupCache = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestClearDatasourceGroupCache().addListener(new epiviz.events.EventListener(
      function(e) {
        self.clearDatasourceGroupCache(e.datasourceGroup);
        e.result.success = true;
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderFlushCache = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestFlushCache().addListener(new epiviz.events.EventListener(
      function(e) {
        self.flushCache();
        e.result.success = true;
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderGetCurrentLocation = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestCurrentLocation().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestCurrentLocation.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderSetChartSettings = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestSetChartSettings().addListener(new epiviz.events.EventListener(
        function(e) {
          self._requestSetChartSettings.notify(e);
        }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderGetChartSettings = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestGetChartSettings().addListener(new epiviz.events.EventListener(
        function(e) {
          self._requestGetChartSettings.notify(e);
        }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderGetAvailableCharts = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestGetChartSettings().addListener(new epiviz.events.EventListener(
        function(e) {
          self._requestGetAvailableCharts.notify(e);
        }));
  });
};

// Input 99
/**
 * Created by: Florin Chelaru
 * Date: 10/4/13
 * Time: 8:52 AM
 */

goog.provide('epiviz.workspaces.Workspace');

goog.require('epiviz.measurements.MeasurementSet');
goog.require('epiviz.events.Event');
goog.require('epiviz.Config');
goog.require('epiviz.utils');
goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');
goog.require('epiviz.ui.charts.VisualizationProperties');
goog.require('epiviz.ui.charts.Visualization');
goog.require('epiviz.ui.controls.VisConfigSelection');
goog.require('epiviz.ui.charts.Margins');
goog.require('epiviz.ui.charts.ColorPalette');
goog.require('epiviz.datatypes.GenomicRange');


/**
 * @param {?string} id
 * @param {string} name
 * @param {{
 *   range: epiviz.datatypes.GenomicRange,
 *   computedMeasurements: epiviz.measurements.MeasurementSet,
 *   charts: Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<{
 *     id: string,
 *     type: epiviz.ui.charts.ChartType,
 *     properties: epiviz.ui.charts.VisualizationProperties
 *   }>>
 * }} content
 * @constructor
 */
epiviz.workspaces.Workspace = function(id, name, content) {
  /**
   * @type {?string}
   * @private
   */
  this._id = id;

  /**
   * @type {string}
   * @private
   */
  this._name = name;

  /**
   * @type {epiviz.datatypes.GenomicRange}
   * @private
   */
  this._range = content.range;

  /**
   * @type {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>}
   * @private
   */
  this._chartsOrder = {};

  /**
   * @type {Object.<string, {
   *   id: string,
   *   type: epiviz.ui.charts.ChartType,
   *   properties: epiviz.ui.charts.VisualizationProperties
   * }>}
   * @private
   */
  this._chartsById = {};
  for (var displayType in content.charts) {
    if (!content.charts.hasOwnProperty(displayType)) { continue; }

    this._chartsOrder[displayType] = [];

    for (var i = 0; i < content.charts[displayType].length; ++i) {
      this._chartsById[content.charts[displayType][i].id] = content.charts[displayType][i];

      this._chartsOrder[displayType].push(content.charts[displayType][i].id);
    }
  }

  /**
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._computedMeasurements = content.computedMeasurements || new epiviz.measurements.MeasurementSet();

  /**
   * @type {boolean}
   * @private
   */
  this._changed = false;

  /**
   * @type {epiviz.events.Event.<epiviz.workspaces.Workspace>}
   * @private
   */
  this._contentChanged = new epiviz.events.Event();
};

/**
 * @const {string}
 */
epiviz.workspaces.Workspace.DEFAULT_WORKSPACE_NAME = epiviz.Config.DEFAULT_WORKSPACE_NAME;

/**
 * @returns {string}
 */
epiviz.workspaces.Workspace.prototype.id = function() {
  return this._id;
};

/**
 * @returns {string}
 */
epiviz.workspaces.Workspace.prototype.name = function() {
  return this._name;
};

/**
 * @returns {epiviz.datatypes.GenomicRange}
 */
epiviz.workspaces.Workspace.prototype.range = function() {
  return this._range;
};

/**
 * @returns {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<{id: string, type: epiviz.ui.charts.ChartType, properties: epiviz.ui.charts.VisualizationProperties}>>}
 */
epiviz.workspaces.Workspace.prototype.charts = function() {
  var charts = {};
  for (var displayType in this._chartsOrder) {
    if (!this._chartsOrder.hasOwnProperty(displayType)) { continue; }
    charts[displayType] = [];
    for (var i = 0; i < this._chartsOrder[displayType].length; ++i) {
      charts[displayType].push(this._chartsById[this._chartsOrder[displayType][i]]);
    }
  }

  return charts;
};

/**
 * @returns {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>}
 */
epiviz.workspaces.Workspace.prototype.chartsOrder = function() {
  return this._chartsOrder;
};

/**
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.workspaces.Workspace.prototype.computedMeasurements = function() {
  return this._computedMeasurements;
};

/**
 * @param {string} id
 * @param {epiviz.ui.charts.ChartType} type
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @param {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>} chartsOrder
 */
epiviz.workspaces.Workspace.prototype.chartAdded = function(id, type, properties, chartsOrder) {
  this._chartsById[id] = {
    id: id,
    type: type,
    properties: properties.copy()
  };

  this._chartsOrder = chartsOrder;

  this._setChanged();
};

/**
 * @param {string} id
 * @param {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>} chartsOrder
 */
epiviz.workspaces.Workspace.prototype.chartRemoved = function(id, chartsOrder) {
  if (!this._chartsById[id]) { return; }
  delete this._chartsById[id];
  this._chartsOrder = chartsOrder;

  this._setChanged();
};

/**
 * @param {string} chartId
 * @param {number|string} width
 * @param {number|string} height
 */
epiviz.workspaces.Workspace.prototype.chartSizeChanged = function(chartId, width, height) {
  if (!this._chartsById[chartId]) { return; }
  if (this._chartsById[chartId].properties.width == width && this._chartsById[chartId].properties.height == height) { return; }
  this._chartsById[chartId].properties.width = width;
  this._chartsById[chartId].properties.height = height;

  this._setChanged();
};

/**
 * @param chartId
 * @param margins
 */
epiviz.workspaces.Workspace.prototype.chartMarginsChanged = function(chartId, margins) {
  if (this._chartsById[chartId].properties.margins.equals(margins)) { return; }
  this._chartsById[chartId].properties.margins = margins ? margins.copy() : margins;

  this._setChanged();
};

/**
 * @param {string} chartId
 * @param {epiviz.ui.charts.ColorPalette} colors
 */
epiviz.workspaces.Workspace.prototype.chartColorsChanged = function(chartId, colors) {
  if (this._chartsById[chartId].properties.colors.equals(colors)) { return; }
  this._chartsById[chartId].properties.colors = colors;

  this._setChanged();
};

/**
 * @param {string} chartId
 * @param {Object.<string, string>} modifiedMethods
 */
epiviz.workspaces.Workspace.prototype.chartMethodsModified = function(chartId, modifiedMethods) {
  if (epiviz.utils.mapEquals(
      this._chartsById[chartId].properties.modifiedMethods,
      modifiedMethods)) { return; }

  this._chartsById[chartId].properties.modifiedMethods = epiviz.utils.mapCombine(
    modifiedMethods,
    this._chartsById[chartId].properties.modifiedMethods);

  this._setChanged();
};

/**
 * @param {string} chartId
 */
epiviz.workspaces.Workspace.prototype.chartMethodsReset = function(chartId) {
  if (!this._chartsById[chartId].properties.modifiedMethods ||
    Object.keys(this._chartsById[chartId].properties.modifiedMethods).length == 0) { return; }

  this._chartsById[chartId].properties.modifiedMethods = {};

  this._setChanged();
};

/**
 * @param {string} chartId
 * @param {Array.<epiviz.ui.charts.markers.VisualizationMarker>} markers
 */
epiviz.workspaces.Workspace.prototype.chartMarkersModified = function(chartId, markers) {
  if (epiviz.utils.arraysEqual(
      this._chartsById[chartId].properties.chartMarkers,
      markers)) { return; }

  this._chartsById[chartId].properties.chartMarkers = markers.filter(function(marker) { return marker != null; });

  this._setChanged();
};

/**
 * @param {string} chartId
 * @param {Object<string, *>} customSettingsValues
 */
epiviz.workspaces.Workspace.prototype.chartCustomSettingsChanged = function(chartId, customSettingsValues) {
  if (epiviz.utils.mapEquals(this._chartsById[chartId].properties.customSettingsValues, customSettingsValues)) { return; }
  this._chartsById[chartId].properties.customSettingsValues = customSettingsValues ? epiviz.utils.mapCopy(customSettingsValues) : customSettingsValues;

  this._setChanged();
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 */
epiviz.workspaces.Workspace.prototype.locationChanged = function(range) {
  if (this._range.equals(range)) { return; }

  this._range = range;

  this._setChanged();
};

/**
 * @param {epiviz.measurements.MeasurementSet} measurements
 */
epiviz.workspaces.Workspace.prototype.computedMeasurementsAdded = function(measurements) {
  var sizeBefore = this._computedMeasurements.size();
  this._computedMeasurements.addAll(measurements);

  if (sizeBefore != this._computedMeasurements.size()) { this._setChanged(); }
};

/**
 * @param {epiviz.measurements.MeasurementSet} measurements
 */
epiviz.workspaces.Workspace.prototype.computedMeasurementsRemoved = function(measurements) {
  var sizeBefore = this._computedMeasurements.size();
  this._computedMeasurements.removeAll(measurements);

  if (sizeBefore != this._computedMeasurements.size()) { this._setChanged(); }
};

/**
 * @param {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>} chartsOrder
 */
epiviz.workspaces.Workspace.prototype.chartsOrderChanged = function(chartsOrder) {
  this._chartsOrder = chartsOrder;
  this._setChanged();
};

/**
 * @returns {boolean}
 */
epiviz.workspaces.Workspace.prototype.changed = function() {
  return this._changed;
};

/**
 */
epiviz.workspaces.Workspace.prototype.resetChanged = function() {
  this._changed = false;
};

/**
 * @private
 */
epiviz.workspaces.Workspace.prototype._setChanged = function() {
  this._changed = true;
  this._contentChanged.notify(this);
};

/**
 * Creates a copy of the current workspace, with a new id and new name
 * @param {string} name
 * @param {string} [id]
 */
epiviz.workspaces.Workspace.prototype.copy = function(name, id) {
  var charts = this.charts();
  return new epiviz.workspaces.Workspace(id || null, name, {
    range: this._range,
    computedMeasurements: new epiviz.measurements.MeasurementSet(this._computedMeasurements),
    charts: charts
  });
};

/**
 * @param {epiviz.Config} [config]
 * @returns {{
 *   id: ?string,
 *   name: string,
 *   content: {
 *     range: {seqName: string, start: number, width: number},
 *     measurements: Array.<{
 *       id: string,
 *       name: string,
 *       type: epiviz.measurements.Measurement.Type,
 *       datasourceId: string,
 *       datasourceGroup: string,
 *       dataprovider: string,
 *       formula: string,
 *       defaultChartType: ?string,
 *       annotation: ?Object.<string, string>,
 *       minValue: ?number,
 *       maxValue: ?number,
 *       metadata: ?Array.<string>
 *     }>,
 *     charts: Object.<string, Array.<{
 *       type: string,
 *       properties: {width: number|string, height: number|string, margins: {top: number, left: number, bottom: number, right: number},
 *         visConfigSelection: { measurements: Array.<number>, datasource: string, datasourceGroup: string, dataprovider: string,
 *           annotation: Object.<string, string>, defaultChartType: string, minSelectedMeasurements: number, customData: * },
 *        colors: Array.<string>|{id: string, name: string, colors: Array.<string>}, modifiedMethods: Object.<string, string>,
 *        chartMarkers: Array.<epiviz.ui.charts.markers.VisualizationMarker>
 *     }>>}}}
 */
epiviz.workspaces.Workspace.prototype.raw = function(config) {
  /**
   * @type {epiviz.measurements.MeasurementHashtable.<number>}
   */
  var wsMeasurements = new epiviz.measurements.MeasurementHashtable();
  var charts = {};

  this._computedMeasurements.foreach(function(m) {
    var mIndex;
    var componentMs = m.componentMeasurements();
    componentMs.foreach(function(compM) {
      var mIndex = wsMeasurements.get(compM);
      if (mIndex === null) {
        mIndex = wsMeasurements.size();
        wsMeasurements.put(compM, mIndex);
      }
    });

    var refMs = m.formula().referredMeasurements;
    for (var j in refMs) {
      if (!refMs.hasOwnProperty(j)) { continue; }
      mIndex = wsMeasurements.get(refMs[j]);
      if (mIndex === null) {
        mIndex = wsMeasurements.size();
        wsMeasurements.put(refMs[j], mIndex);
      }
    }

    mIndex = wsMeasurements.get(m);
    if (mIndex === null) {
      mIndex = wsMeasurements.size();
      wsMeasurements.put(m, mIndex);
    }
  });

  for (var displayType in this._chartsOrder) {
    if (!this._chartsOrder.hasOwnProperty(displayType)) { continue; }

    charts[displayType] = [];
    for (var i = 0; i < this._chartsOrder[displayType].length; ++i) {
      var chartData = this._chartsById[this._chartsOrder[displayType][i]];
      var props = chartData.properties;

      /** @type {Array.<number>} */
      var ms = [];

      (function(ms) {
        props.visConfigSelection.measurements.foreach(function(m) {
          var mIndex = wsMeasurements.get(m);
          if (mIndex === null) {
            mIndex = wsMeasurements.size();
            wsMeasurements.put(m, mIndex);
          }

          ms.push(mIndex);
        });
      })(ms);

      charts[displayType].push({
        id: chartData.id,
        type: chartData.type.typeName(),
        properties: {
          width: props.width,
          height: props.height,
          margins: props.margins.raw(),
          visConfigSelection: {
            measurements: ms,
            datasource: props.visConfigSelection.datasource,
            datasourceGroup: props.visConfigSelection.datasourceGroup,
            dataprovider: props.visConfigSelection.dataprovider,
            annotation: props.visConfigSelection.annotation,
            defaultChartType: props.visConfigSelection.defaultChartType,
            minSelectedMeasurements: props.visConfigSelection.minSelectedMeasurements,
            customData: props.visConfigSelection.customData
          },
          colors: props.colors.raw(config),
          modifiedMethods: epiviz.utils.mapCopy(props.modifiedMethods),
          customSettings: props.customSettingsValues || null,
          chartMarkers: props.chartMarkers.map(function(marker) { return marker.raw(); })
        }
      });
    }
  }

  var rawMs = new Array(wsMeasurements.size());
  wsMeasurements.foreach(function(m, j) {
    rawMs[j] = m.raw(wsMeasurements);
  });

  return {
    id: this._id,
    name: this._name,
    content: {
      range: this._range.raw(),
      measurements: rawMs,
      charts: charts
    }
  };
};

/**
 * @param {{
 *   id: ?string,
 *   name: string,
 *   content: {
 *     range: {seqName: string, start: number, width: number},
 *     measurements: Array,
 *     charts: Object.<string, Array.<{
 *       id: string,
 *       type: string,
 *       properties: {
 *        width: number|string,
 *        height: number|string,
 *        margins: {top: number, left: number, bottom: number, right: number},
 *        visConfigSelection: {
 *          measurements: Array.<number>,
 *          datasource: string,
 *          datasourceGroup: string,
 *          dataprovider: string,
 *          annotation: Object.<string, string>,
 *          defaultChartType: string,
 *          minSelectedMeasurements: number,
 *          customData: *
 *        },
 *        colors: Array.<string>|{id: string, name: string, colors: Array.<string>},
 *        modifiedMethods: ?Object<string, string>,
 *        customSettings: Object.<string, *>
 *      }
 *     }>>}}} o
 * @param {epiviz.ui.charts.ChartFactory} chartFactory
 * @param {epiviz.Config} config
 * @returns {epiviz.workspaces.Workspace}
 */
epiviz.workspaces.Workspace.fromRawObject = function(o, chartFactory, config) {
  var i;
  var ms = new Array(o.content.measurements.length);
  var computedMeasurements = new epiviz.measurements.MeasurementSet();

  // First, parse all non-computed measurements, as we may need them in parsing the computed measurements
  for (i = 0; i < o.content.measurements.length; ++i) {
    if (!o.content.measurements[i].formula) {
      ms[i] = epiviz.measurements.Measurement.fromRawObject(o.content.measurements[i]);
    }
  }

  // Second, parse computed measurements
  for (i = 0; i < o.content.measurements.length; ++i) {
    if (o.content.measurements[i].formula) {
      ms[i] = epiviz.measurements.Measurement.fromRawObject(o.content.measurements[i], ms);
      computedMeasurements.add(ms[i]);
    }
  }

  var charts = {};
  for (var t in o.content.charts) {
    if (!o.content.charts.hasOwnProperty(t)) { continue; }
    charts[t] = [];
    for (i = 0; i < o.content.charts[t].length; ++i) {
      /**
       * @type {{id: string, type: string, properties: {
       *        width: number|string,
       *        height: number|string,
       *        margins: {top: number, left: number, bottom: number, right: number},
       *        visConfigSelection: {
       *          measurements: Array.<number>,
       *          datasource: string,
       *          datasourceGroup: string,
       *          dataprovider: string,
       *          annotation: Object.<string, string>,
       *          defaultChartType: string,
       *          minSelectedMeasurements: number,
       *          customData: *
       *        },
       *        colors: Array.<string>|{id: string, name: string, colors: Array.<string>},
       *        modifiedMethods: ?Object.<string, string>,
       *        customSettings: Object.<string, *>,
       *        chartMarkers: Array.<{type: string, id: string, name: string, preMark: string, mark: string}>
       *      }}}
       */
      var chartInfo = o.content.charts[t][i];
      var chartMs;

      var rawVisConfigSelection = chartInfo.properties.visConfigSelection;
      var rawMs = rawVisConfigSelection ? rawVisConfigSelection.measurements : chartInfo.properties.measurements;

      if (rawMs) {
        chartMs = new epiviz.measurements.MeasurementSet();
        for (var j = 0; j < rawMs.length; ++j) {
          chartMs.add(ms[rawMs[j]]);
        }
      }
      var visConfigSelection = rawVisConfigSelection ?
        new epiviz.ui.controls.VisConfigSelection(chartMs, rawVisConfigSelection.datasource,
          rawVisConfigSelection.datasourceGroup, rawVisConfigSelection.dataprovider, rawVisConfigSelection.annotation,
          rawVisConfigSelection.defaultChartType, rawVisConfigSelection.minSelectedMeasurements, rawVisConfigSelection.customData) :
        new epiviz.ui.controls.VisConfigSelection(chartMs);
      var chartType = chartFactory.get(chartInfo.type);

      if (!chartType) { continue; }

      charts[t].push({
        id: chartInfo.id,
        type: chartType,
        properties: new epiviz.ui.charts.VisualizationProperties(
          chartInfo.properties.width,
          chartInfo.properties.height,
          epiviz.ui.charts.Margins.fromRawObject(chartInfo.properties.margins),
          visConfigSelection,
          epiviz.ui.charts.ColorPalette.fromRawObject(chartInfo.properties.colors, config),
          chartInfo.properties.modifiedMethods,
          chartInfo.properties.customSettings,
          chartType.customSettingsDefs(),
          chartInfo.properties.chartMarkers ?
            chartInfo.properties.chartMarkers.map(function(rawMarker) { return epiviz.ui.charts.markers.VisualizationMarker.fromRawObject(rawMarker); }) :
            []
        )
      });
    }
  }

  return new epiviz.workspaces.Workspace(o.id, o.name, {
    range: epiviz.datatypes.GenomicRange.fromRawObject(o.content.range),
    computedMeasurements: computedMeasurements,
    charts: charts
  });
};


/**
 * @returns {epiviz.events.Event.<epiviz.workspaces.Workspace>}
 */
epiviz.workspaces.Workspace.prototype.onContentChanged = function() { return this._contentChanged; };

// Input 100
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/20/2015
 * Time: 7:47 PM
 */

goog.provide('epiviz.localstorage.LocalStorageManager');

goog.require('epiviz.workspaces.Workspace');

/**
 * @constructor
 */
epiviz.localstorage.LocalStorageManager = function(type) {
  this._workspace = type;

  this._availStorage = (typeof(Storage) === "undefined" || localStorage == null) ? false: true;
};

/**
 * @const {string}
 */
//epiviz.localstorage.LocalStorageManager.WORKSPACE = 'workspace';

/**
 * @enum {string}
 */
epiviz.localstorage.LocalStorageManager.MODE = {
  INCOGNITO_MODE: 'incognito_workspace',
  COOKIE_MODE: 'workspace'
};

/**
 */
epiviz.localstorage.LocalStorageManager.prototype.initialize = function() {};

/**
 * @param {epiviz.ui.charts.ChartFactory} chartFactory
 * @param {epiviz.Config} config
 * @returns {epiviz.workspaces.Workspace}
 */
epiviz.localstorage.LocalStorageManager.prototype.getWorkspace = function(chartFactory, config) {
  if(this._availStorage) {
    var rawStr = localStorage.getItem(this._workspace);
    if (!rawStr) { return null; }

    return epiviz.workspaces.Workspace.fromRawObject(JSON.parse(rawStr), chartFactory, config);
  }
};

/**
 * @param {epiviz.workspaces.Workspace} workspace
 * @param {epiviz.Config} config
 */
epiviz.localstorage.LocalStorageManager.prototype.saveWorkspace = function(workspace, config) {
  if(this._availStorage) {
    var raw = workspace.raw(config);
    localStorage.setItem(this._workspace, JSON.stringify(raw));
  }
};

/**
 * clear the workspace for the current instance of localmanager
 */
epiviz.localstorage.LocalStorageManager.prototype.clearWorkspace = function() {
  if(this._availStorage) {
    localStorage.removeItem(this._workspace);
  }
};

/**
 * clears all data in localstorage
 */
epiviz.localstorage.LocalStorageManager.prototype.clearAll = function() {
  if(this._availStorage) {
    localStorage.clear();
  }
};
// TODO: Idea - create a workspace history, for undo/redo functionality!
// Input 101
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 12:58 PM
 */

goog.provide('epiviz.workspaces.WorkspaceManager');

goog.require('epiviz.workspaces.Workspace');
goog.require('epiviz.events.EventListener');
goog.require('epiviz.events.Event');
goog.require('epiviz.ui.WebArgsManager');
goog.require('epiviz.datatypes.GenomicRange');


/**
 * @param {epiviz.Config} config
 * @param {epiviz.ui.LocationManager} locationManager
 * @param {epiviz.measurements.MeasurementsManager} measurementsManager
 * @param {epiviz.ui.charts.ChartManager} chartManager
 * @param {epiviz.ui.charts.ChartFactory} chartFactory
 * @constructor
 */
epiviz.workspaces.WorkspaceManager = function(config, locationManager, measurementsManager, chartManager, chartFactory) {
  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {epiviz.ui.LocationManager}
   * @private
   */
  this._locationManager = locationManager;

  /**
   * @type {epiviz.measurements.MeasurementsManager}
   * @private
   */
  this._measurementsManager = measurementsManager;

  /**
   * @type {epiviz.ui.charts.ChartManager}
   * @private
   */
  this._chartManager = chartManager;

  /**
   * @type {epiviz.ui.charts.ChartFactory}
   * @private
   */
  this._chartFactory = chartFactory;

  /**
   * @type {?epiviz.workspaces.Workspace}
   * @private
   */
  this._activeWorkspace = null;

  /**
   * @type {?epiviz.workspaces.Workspace}
   * @private
   */
  this._unchangedActiveWorkspace = null;

  /**
   * Workspaces by id
   *
   * @type {Object.<string, epiviz.workspaces.Workspace>}
   * @private
   */
  this._workspaces = null;

  /**
   * @type {Object.<string, epiviz.workspaces.Workspace>}
   * @private
   */
  this._workspacesByName = null;

  /**
   * @type {epiviz.events.Event.<{activeWorkspace: epiviz.workspaces.Workspace, workspaces: Array.<epiviz.workspaces.Workspace>}>}
   * @private
   */
  this._workspacesLoaded = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{oldValue: epiviz.workspaces.Workspace, newValue: epiviz.workspaces.Workspace, workspaceId: string}>}
   * @private
   */
  this._activeWorkspaceChanged = new epiviz.events.Event();

  /**
   * @type {boolean}
   * @private
   */
  this._activeWorkspaceChanging = false;


  /**
   * @type {epiviz.events.Event.<{activeWorkspaceId: ?string}>}
   * @private
   */
  this._requestWorkspaces = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.workspaces.Workspace>}
   * @private
   */
  this._activeWorkspaceContentChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.workspaces.Workspace>}
   * @private
   */
  this._uiChartSettingsChanged = new epiviz.events.Event();

  var self = this;

  /**
   * @type {epiviz.events.EventListener}
   * @private
   */
  this._activeWorkspaceContentChangedListener = new epiviz.events.EventListener(function(workspace) {
    self._activeWorkspaceContentChanged.notify(workspace);
  });

  // Register for events

  this._registerLocationChanged();
  this._registerComputedMeasurementAdded();
  this._registerComputedMeasurementRemoved();
  this._registerChartAdded();
  this._registerChartRemoved();
  this._registerChartsOrderChanged();
  this._registerChartColorsChanged();
  this._registerChartMethodsModified();
  this._registerChartMethodsReset();
  this._registerChartMarkersModified();
  this._registerChartSizeChanged();
  this._registerChartMarginsChanged();
  this._registerChartCustomSettingsChanged();
};

/**
 * @returns {epiviz.events.Event}
 */
epiviz.workspaces.WorkspaceManager.prototype.onUiChartSettingsChanged = function() { return this._uiChartSettingsChanged; };

/**
 * @returns {?epiviz.workspaces.Workspace}
 */
epiviz.workspaces.WorkspaceManager.prototype.activeWorkspace = function() {
  return this._activeWorkspace || null;
};

/**
 * @param {string} id
 * @returns {?epiviz.workspaces.Workspace}
 */
epiviz.workspaces.WorkspaceManager.prototype.get = function(id) {
  return (id && this._workspaces) ? (this._workspaces[id] || null) : null;
};

/**
 * @param {string} name
 */
epiviz.workspaces.WorkspaceManager.prototype.getByName = function(name) {
  return (name && this._workspacesByName) ? (this._workspacesByName[name] || null) : null;
};

/**
 */
epiviz.workspaces.WorkspaceManager.prototype.initialize = function() {
  var requestWorkspaceId = epiviz.ui.WebArgsManager.WEB_ARGS['ws'] ||
    epiviz.ui.WebArgsManager.WEB_ARGS['workspace'] ||
    null;
  this._requestWorkspaces.notify({ activeWorkspaceId: requestWorkspaceId });
};

/**
 * @param {Array.<epiviz.workspaces.Workspace>} workspaces
 * @param {?epiviz.workspaces.Workspace} [activeWorkspace]
 * @param {?string} [activeWorkspaceId]
 * @param {?epiviz.workspaces.Workspace} [unchangedActiveWorkspace]
 */
epiviz.workspaces.WorkspaceManager.prototype.updateWorkspaces = function(workspaces, activeWorkspace, activeWorkspaceId, unchangedActiveWorkspace) {
  if (workspaces) {
    this._workspaces = {};
    this._workspacesByName = {};
    for (var i = 0; i < workspaces.length; ++i) {
      if (workspaces[i].id() === null) { continue; }
      this._workspaces[workspaces[i].id()] = workspaces[i];
      this._workspacesByName[workspaces[i].name()] = workspaces[i];
    }
  }

  if (!activeWorkspace) {
    activeWorkspace = (workspaces && workspaces.length) ?
      workspaces[0] :
      epiviz.workspaces.Workspace.fromRawObject(this._config.defaultWorkspaceSettings, this._chartFactory, this._config);
  }

  var oldActiveWorkspace = this._activeWorkspace;
  this._activeWorkspace = activeWorkspace;
  if (unchangedActiveWorkspace) {
    this._unchangedActiveWorkspace = unchangedActiveWorkspace;
  } else {
    this._unchangedActiveWorkspace = activeWorkspace ? activeWorkspace.copy(activeWorkspace.name(), activeWorkspace.id()) : null;
  }

  if (oldActiveWorkspace) {
    oldActiveWorkspace.onContentChanged().removeListener(this._activeWorkspaceContentChangedListener);
  }

  if (this._activeWorkspace) {
    this._activeWorkspace.onContentChanged().addListener(this._activeWorkspaceContentChangedListener);
  }

  var webArgs = epiviz.ui.WebArgsManager.WEB_ARGS;

  var seqName = (webArgs['seqName'] != undefined) ? webArgs['seqName'] : this._activeWorkspace.range().seqName();
  var start = null, end = null;
  if (webArgs['start'] != 'undefined') { start = parseInt(webArgs['start']) || this._activeWorkspace.range().start(); }
  if (webArgs['end'] != 'undefined') { end = parseInt(webArgs['end']) || this._activeWorkspace.range().end(); }

  this._activeWorkspace.locationChanged(epiviz.datatypes.GenomicRange.fromStartEnd(seqName, start, end));

  this._workspacesLoaded.notify({
    activeWorkspace: this._activeWorkspace,
    workspaces: workspaces
  });

  this._activeWorkspaceChanged.notify({
    oldValue: oldActiveWorkspace,
    newValue: this._activeWorkspace,
    workspaceId: this._activeWorkspace.id() || activeWorkspaceId
  });
};

/**
 * @param {epiviz.workspaces.Workspace} workspace
 */
epiviz.workspaces.WorkspaceManager.prototype.updateWorkspace = function(workspace) {
  this._workspaces[workspace.id()] = workspace;
  this._workspacesByName[workspace.name()] = workspace;
};

/**
 */
epiviz.workspaces.WorkspaceManager.prototype.deleteActiveWorkspace = function() {
  var activeWorkspace = this._activeWorkspace;
  if (!activeWorkspace || !activeWorkspace.id()) { return; }

  delete this._workspaces[activeWorkspace.id()];
  delete this._workspacesByName[activeWorkspace.name()];

  var newActiveWorkspace = null;
  for (var id in this._workspaces) {
    if (!this._workspaces.hasOwnProperty(id)) { continue; }
    newActiveWorkspace = this._workspaces[id];
    break;
  }

  if (!newActiveWorkspace) {
    newActiveWorkspace = epiviz.workspaces.Workspace.fromRawObject(this._config.defaultWorkspaceSettings, this._chartFactory, this._config);
  }

  this._activeWorkspace = newActiveWorkspace;
  this._unchangedActiveWorkspace = newActiveWorkspace ? newActiveWorkspace.copy(newActiveWorkspace.name(), newActiveWorkspace.id()) : null;

  var seqName = activeWorkspace.range().seqName();
  var start = activeWorkspace.range().start();
  var end = activeWorkspace.range().end();

  this._activeWorkspace.locationChanged(epiviz.datatypes.GenomicRange.fromStartEnd(seqName, start, end));

  this._activeWorkspaceChanged.notify({
    oldValue: activeWorkspace,
    newValue: this._activeWorkspace,
    workspaceId: this._activeWorkspace.id()
  });
};

/**
 */
epiviz.workspaces.WorkspaceManager.prototype.revertActiveWorkspace = function() {
  if (!this._unchangedActiveWorkspace) { return; }
  var oldActiveWorkspace = this._activeWorkspace;

  var seqName = oldActiveWorkspace.range().seqName();
  var start = oldActiveWorkspace.range().start();
  var end = oldActiveWorkspace.range().end();

  this._activeWorkspace = this._unchangedActiveWorkspace.copy(this._unchangedActiveWorkspace.name(), this._unchangedActiveWorkspace.id());

  this._activeWorkspace.locationChanged(epiviz.datatypes.GenomicRange.fromStartEnd(seqName, start, end));

  this._activeWorkspaceChanged.notify({
    oldValue: null,
    newValue: this._activeWorkspace,
    workspaceId: this._activeWorkspace.id()
  });
};

/**
 * @returns {epiviz.events.Event.<Array.<epiviz.workspaces.Workspace>>}
 */
epiviz.workspaces.WorkspaceManager.prototype.onWorkspacesLoaded = function() { return this._workspacesLoaded; };

/**
 * @returns {epiviz.events.Event.<{oldValue: epiviz.workspaces.Workspace, newValue: epiviz.workspaces.Workspace, workspaceId: string}>}
 */
epiviz.workspaces.WorkspaceManager.prototype.onActiveWorkspaceChanged = function() { return this._activeWorkspaceChanged; };

/**
 */
epiviz.workspaces.WorkspaceManager.prototype.startChangingActiveWorkspace = function() { this._activeWorkspaceChanging = true; };

/**
 */
epiviz.workspaces.WorkspaceManager.prototype.endChangingActiveWorkspace = function() { this._activeWorkspaceChanging = false; };

/**
 * @returns {boolean}
 */
epiviz.workspaces.WorkspaceManager.prototype.activeWorkspaceChanging = function() { return this._activeWorkspaceChanging; };

/**
 * @returns {epiviz.events.Event.<{activeWorkspaceId: ?string}>}
 */
epiviz.workspaces.WorkspaceManager.prototype.onRequestWorkspaces = function() { return this._requestWorkspaces; };

/**
 * @returns {epiviz.events.Event.<epiviz.workspaces.Workspace>}
 */
epiviz.workspaces.WorkspaceManager.prototype.onActiveWorkspaceContentChanged = function() { return this._activeWorkspaceContentChanged; };

/**
 * @param {?string} id The id of the new active workspace
 * @param {epiviz.workspaces.Workspace} [workspace] A workspace that doesn't belong to the current user,
 *   to replace the active workspace
 */
epiviz.workspaces.WorkspaceManager.prototype.changeActiveWorkspace = function(id, workspace) {
  workspace = workspace || this._workspaces[id];
  if (!workspace || workspace === this._activeWorkspace) { return; } // TODO: Show a message or throw an error

  var oldValue = this._activeWorkspace;
  this._activeWorkspace = workspace;
  this._unchangedActiveWorkspace = this._activeWorkspace ? this._activeWorkspace.copy(this._activeWorkspace.name(), this._activeWorkspace.id()) : null;
  this._activeWorkspaceChanged.notify({oldValue: oldValue, newValue: this._activeWorkspace, workspaceId: id});
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerLocationChanged = function() {
  var self = this;
  this._locationManager.onCurrentLocationChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {{oldValue: epiviz.datatypes.GenomicRange, newValue: epiviz.datatypes.GenomicRange}} e
     */
    function(e) {
      if (self._activeWorkspaceChanging) { return; }
      if (!self._activeWorkspace) { return; }
      self._activeWorkspace.locationChanged(e.newValue);
    }
  ));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartAdded = function() {
  var self = this;
  this._chartManager.onChartAdded().addListener(new epiviz.events.EventListener(
    /**
     * @param {epiviz.ui.charts.VisEventArgs.<{
     *   type: epiviz.ui.charts.ChartType,
     *   properties: epiviz.ui.charts.VisualizationProperties,
     *   chartsOrder: Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>}>} e
     */
    function(e) {
      if (self._activeWorkspaceChanging) { return; }
      if (!self._activeWorkspace) { return; }
      self._activeWorkspace.chartAdded(e.id, e.args.type, e.args.properties, e.args.chartsOrder);
    }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartRemoved = function() {
  var self = this;
  this._chartManager.onChartRemoved().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartRemoved(e.id, e.args);
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartsOrderChanged = function() {
  var self = this;
  this._chartManager.onChartsOrderChanged().addListener(new epiviz.events.EventListener(function(args) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartsOrderChanged(args);
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartColorsChanged = function() {
  var self = this;
  this._chartManager.onChartColorsChanged().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartColorsChanged(e.id, e.args);

    self.onUiChartSettingsChanged().notify({'chartId': e.id, 'colorMap': e.args});
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartMethodsModified = function() {
  var self = this;
  this._chartManager.onChartMethodsModified().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartMethodsModified(e.id, e.args);
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartMethodsReset = function() {
  var self = this;
  this._chartManager.onChartMethodsReset().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartMethodsReset(e.id);
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartMarkersModified = function() {
  var self = this;
  this._chartManager.onChartMarkersModified().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartMarkersModified(e.id, e.args);
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartCustomSettingsChanged = function() {
  var self = this;
  this._chartManager.onChartCustomSettingsChanged().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartCustomSettingsChanged(e.id, e.args);

    self.onUiChartSettingsChanged().notify({'chartId': e.id, 'settings': e.args});
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartSizeChanged = function() {
  var self = this;
  this._chartManager.onChartSizeChanged().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartSizeChanged(e.id, e.args.width, e.args.height);
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartMarginsChanged = function() {
  var self = this;
  this._chartManager.onChartMarginsChanged().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartMarginsChanged(e.id, e.args);
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerComputedMeasurementAdded = function() {
  var self = this;
  this._measurementsManager.onComputedMeasurementsAdded().addListener(new epiviz.events.EventListener(
    function(measurements) {
      if (self._activeWorkspaceChanging) { return; }
      if (!self._activeWorkspace) { return; }
      self._activeWorkspace.computedMeasurementsAdded(measurements);
    }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerComputedMeasurementRemoved = function() {
  var self = this;
  this._measurementsManager.onComputedMeasurementsRemoved().addListener(new epiviz.events.EventListener(
    function(measurements) {
      if (self._activeWorkspaceChanging) { return; }
      if (!self._activeWorkspace) { return; }
      self._activeWorkspace.computedMeasurementsRemoved(measurements);
    }));
};

// Input 102
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/15/14
 * Time: 5:01 PM
 */

goog.provide('epiviz.workspaces.UserManager');

/**
 * @param {epiviz.Config} config
 * @constructor
 */
epiviz.workspaces.UserManager = function(config) {
  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;
};

/**
 * @type {{loggedIn: boolean, name: ?string, oauthProvider: ?string}}
 */
epiviz.workspaces.UserManager.USER_STATUS = epiviz.workspaces.UserManager.USER_STATUS || {
  loggedIn: false,
  userData: null,
  oauthProvider: null
};

/**
 * Logs in if there is no user logged in or logs out the current user
 */
epiviz.workspaces.UserManager.prototype.toggleLogin = function() {
  if (!epiviz.workspaces.UserManager.USER_STATUS.loggedIn) {
    this._login();
  } else {
    this._logout();
  }
};

/**
 * Redirects to the login screen
 * @private
 */
epiviz.workspaces.UserManager.prototype._login = function() {
  var location = window.location.toString();
  if (location.length > 0) {
    location = encodeURIComponent(location);
  }

  var pathname = this._config.dataServerLocation + 'login.php';
  window.location = pathname + '?location=' + location;
};

/**
 * Logout
 * @private
 */
epiviz.workspaces.UserManager.prototype._logout = function() {
  var location = window.location.toString(); // window.location.search;
  if (location.length > 0) {
    // location = encodeURIComponent(location.substr(1));
    location = encodeURIComponent(location);
  }
  window.location = this._config.dataServerLocation + 'logout.php?logout&location=' + location;
};

// Input 103
/**
 * Created by: Florin Chelaru
 * Date: 10/2/13
 * Time: 12:46 PM
 */

goog.provide('epiviz.EpiViz');

goog.require('epiviz.ui.charts.VisualizationType');
goog.require('epiviz.workspaces.Workspace');
goog.require('epiviz.events.EventListener');
goog.require('epiviz.ui.controls.MessageDialog');
goog.require('epiviz.datatypes.GenomicRange');

/**
 * @param {epiviz.Config} config
 * @param {epiviz.ui.LocationManager} locationManager
 * @param {epiviz.measurements.MeasurementsManager} measurementsManager
 * @param {epiviz.ui.ControlManager} controlManager
 * @param {epiviz.data.DataManager} dataManager
 * @param {epiviz.ui.charts.ChartFactory} chartFactory
 * @param {epiviz.ui.charts.ChartManager} chartManager
 * @param {epiviz.workspaces.WorkspaceManager} workspaceManager
 * @param {epiviz.workspaces.UserManager} userManager
 * @param {epiviz.ui.WebArgsManager} webArgsManager
 * @param {epiviz.localstorage.LocalStorageManager} [cookieManager]
 * @constructor
 */
epiviz.EpiViz = function(config, locationManager, measurementsManager, controlManager, dataManager, chartFactory, chartManager, workspaceManager, userManager, webArgsManager, cookieManager) {
  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {epiviz.ui.LocationManager}
   * @private
   */
  this._locationManager = locationManager;

  /**
   * @type {epiviz.measurements.MeasurementsManager}
   * @private
   */
  this._measurementsManager = measurementsManager;

  /**
   * @type {epiviz.ui.ControlManager}
   * @private
   */
  this._controlManager = controlManager;

  /**
   * @type {epiviz.data.DataManager}
   * @private
   */
  this._dataManager = dataManager;

  /**
   * @type {epiviz.ui.charts.ChartFactory}
   * @private
   */
  this._chartFactory = chartFactory;

  /**
   * @type {epiviz.ui.charts.ChartManager}
   * @private
   */
  this._chartManager = chartManager;

  /**
   * @type {epiviz.workspaces.WorkspaceManager}
   * @private
   */
  this._workspaceManager = workspaceManager;

  /**
   * @type {epiviz.workspaces.UserManager}
   * @private
   */
  this._userManager = userManager;

  /**
   * @type {epiviz.ui.WebArgsManager}
   * @private
   */
  this._webArgsManager = webArgsManager;

  /**
   * @type {epiviz.localstorage.LocalStorageManager}
   * @private
   */
  this._cookieManager = cookieManager;

  // Register for UI events

  this._registerRequestSeqInfos();
  this._registerRequestMeasurements();

  this._registerUiAddChart();
  this._registerUiSaveWorkspace();
  this._registerUiDeleteActiveWorkspace();
  this._registerUiRevertActiveWorkspace();
  this._registerUiLoginLinkClicked();
  this._registerUiSearchWorkspaces();
  this._registerUiActiveWorkspaceChanged();
  this._registerUiSearch();

  this._registerChartRequestHierarchy();
  this._registerChartPropagateHierarchySelection();

  this._registerChartPropogateIcicleLocationChange();

  this._registerUiSettingsChanged();

  // Register for Data events

  this._registerDataAddMeasurements();
  this._registerDataRemoveMeasurements();
  this._registerDataAddChart();
  this._registerDataRemoveChart();
  this._registerDataAddSeqInfos();
  this._registerDataRemoveSeqNames();
  this._registerDataNavigate();
  this._registerDataRedraw();
  this._registerDataGetCurrentLocation();
  this._registerPrintWorkspace();
  this._registerLoadWorkspace();
  this._registerDataSetChartSettings();
  this._registerDataGetChartSettings();
  this._registerDataGetAvailableCharts();

  // Register for Workspace events

  this._registerRequestWorkspaces();
  this._registerWorkspacesLoaded();
  this._registerActiveWorkspaceChanged();
  this._registerActiveWorkspaceContentChanged();
  this._registerLocationChanged();

  /*
   * Prevent closing if workspace has changed
   */
  var self = this;
  // TODO: Cleanup
  /*window.onbeforeunload = function() {
    if (epiviz.workspaces.UserManager.USER_STATUS.loggedIn && self._workspaceManager.activeWorkspace().changed()) {
      return 'There are unsaved changes in the current workspace.';
    }
    return undefined;
   };*/
};

/**
 * @type {string}
 * @const
 */
epiviz.EpiViz.VERSION = '4';

epiviz.EpiViz.prototype.start = function() {
  this._cookieManager.initialize();

  this._controlManager.initialize();
  
  this._workspaceManager.initialize();

  this._measurementsManager.initialize();

  this._locationManager.initialize();
};

/**
 * @returns {epiviz.Config}
 */
epiviz.EpiViz.prototype.config = function() {
  return this._config;
};

/**
 * @param {epiviz.ui.charts.ChartType} type
 * @param {epiviz.ui.controls.VisConfigSelection} visConfigSelection
 * @param {string} [chartId] If specified, then this will be
 *   the id of the newly created chart. Otherwise, a new one
 *   will be generated.
 * @param {epiviz.ui.charts.VisualizationProperties} [chartProperties]
 * @returns {string} the id of the chart just created
 * @private
 */
epiviz.EpiViz.prototype._addChart = function(type, visConfigSelection, chartId, chartProperties) {
  chartId = this._chartManager.addChart(type, visConfigSelection, chartId, chartProperties);
  var self = this;
  // TODO: Maybe later implement hierarchical display type (see display-type.js for the start of the idea)
  if (type.typeName() == 'epiviz.plugins.charts.CustomScatterPlot'){
    var range = null;
    var chartMeasurementsMap = {};
    chartMeasurementsMap[chartId] = visConfigSelection.measurements;
    this._dataManager.getPCA(range, chartMeasurementsMap,
      function(chartId, data) {
        self._chartManager.updateCharts(range, data, [chartId]);
      });
  }
  else if (type.typeName() == 'epiviz.plugins.charts.DiversityScatterPlot'){
    var range = null;
    var chartMeasurementsMap = {};
    chartMeasurementsMap[chartId] = visConfigSelection.measurements;
    this._dataManager.getDiversity(range, chartMeasurementsMap,
      function(chartId, data) {
        self._chartManager.updateCharts(range, data, [chartId]);
      });
  }
  else if (type.chartDisplayType() == epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) {
    var chartVisConfigSelectionMap = {};
    chartVisConfigSelectionMap[chartId] = visConfigSelection;
    var range = this._workspaceManager.activeWorkspace().range();
    this._dataManager.getHierarchy(chartVisConfigSelectionMap,
      function(chartId, hierarchy) {
        self._chartManager.updateCharts(range, hierarchy, [chartId]);
      });
  } else {
    var range = this._workspaceManager.activeWorkspace().range();
    this._chartManager.dataWaitStart(chartId);
    var chartMeasurementsMap = {};
    chartMeasurementsMap[chartId] = visConfigSelection.measurements;
    this._dataManager.getData(range, chartMeasurementsMap,
      function(chartId, data) {
        self._chartManager.updateCharts(range, data, [chartId]);
      });
  }

  // if (type.chartDisplayType() != epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) {
  //   var mCount = 0;
  //   //add measurements as a new datasource
  //   var chartMs = visConfigSelection.measurements;
  //   chartMs.foreach(function(m, i) {
  //     if(m._datasourceGroup.indexOf('_plot-') == -1 ) {
  //       m._datasourceGroup = m._datasourceGroup + "_" + chartId;
  //       mCount++;
  //     }
  //   });

  //   if (mCount > 0) {
  //     this._measurementsManager.addMeasurements(chartMs);
  //   }
  // }

  return chartId;
};

/*****************************************************************************
 * UI Events                                                                 *
 *****************************************************************************/

/**
 * @private
 */
epiviz.EpiViz.prototype._registerRequestSeqInfos = function() {
  var self = this;
  this._locationManager.onRequestSeqInfos().addListener(new epiviz.events.EventListener(
    function() {
      self._dataManager.getSeqInfos(function(seqInfos) {
        self._locationManager.updateSeqInfos(seqInfos);
      });
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerRequestMeasurements = function() {
  var self = this;
  this._measurementsManager.onRequestMeasurements().addListener(new epiviz.events.EventListener(
    function() {
      self._dataManager.getMeasurements(function(measurements) {
        self._measurementsManager.addMeasurements(measurements);

        //self._workspaceManager.initialize();
      });
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerRequestWorkspaces = function() {
  var self = this;
  this._workspaceManager.onRequestWorkspaces().addListener(new epiviz.events.EventListener(
    /**
     * @param {{activeWorkspaceId: string}} e
     */
    function(e) {
      var cookieWorkspace = self._cookieManager.getWorkspace(self._chartFactory, self._config);
      self._dataManager.getWorkspaces(function(rawWorkspaces) {
        var ws = [];
        var activeWorkspace = null;
        var unchangedActiveWorkspace = null;
        for (var i = 0; i < rawWorkspaces.length; ++i) {
           var w = epiviz.workspaces.Workspace.fromRawObject(rawWorkspaces[i], self._chartFactory, self._config);

          if (w.id() === null) {
            // This is a workspace retrieved using e.activeWorkspaceId
            // and belonging to another user
            activeWorkspace = w;
            continue;
          }

          if (w.id() == e.activeWorkspaceId) {
            if (cookieWorkspace && cookieWorkspace.id() == e.activeWorkspaceId) {
              unchangedActiveWorkspace = w;
              w = cookieWorkspace;
            }
            activeWorkspace = w;
          }

          ws.push(w);
        }

        // if (!activeWorkspace && cookieWorkspace) {
        //   unchangedActiveWorkspace = self._workspaceManager.get(cookieWorkspace.id());
        //   if (!unchangedActiveWorkspace) {
        //     cookieWorkspace = cookieWorkspace.copy(cookieWorkspace.name());
        //     unchangedActiveWorkspace = epiviz.workspaces.Workspace.fromRawObject(self._config.defaultWorkspaceSettings, self._chartFactory, self._config);
        //   }
        //   activeWorkspace = cookieWorkspace;
        // }

        self._workspaceManager.updateWorkspaces(ws, activeWorkspace, e.activeWorkspaceId, unchangedActiveWorkspace);
        if (!cookieWorkspace) { self._workspaceManager.activeWorkspace().resetChanged(); }
       }, '', e.activeWorkspaceId);
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiAddChart = function() {
  var self = this;
  this._controlManager.onAddChart().addListener(new epiviz.events.EventListener(
    /** @param {{type: epiviz.ui.charts.ChartType, visConfigSelection: epiviz.ui.controls.VisConfigSelection}} e */
    function(e) {
      self._addChart(e.type, e.visConfigSelection);
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiSaveWorkspace = function() {
  var self = this;
  this._controlManager.onSaveWorkspace().addListener(new epiviz.events.EventListener(
    /**
     * @param {{name: string, id: ?string}} e
     */
    function(e) {
      // If there is a workspace with this name in the set of workspaces, overwrite it
      // Otherwise, create a copy of the active workspace with the new name, and save that.
      var workspace = self._workspaceManager.getByName(e.name);
      if (workspace) {
        workspace = self._workspaceManager.activeWorkspace().copy(e.name, workspace.id());
      } else {
        workspace = self._workspaceManager.activeWorkspace().copy(e.name);
      }

      self._dataManager.saveWorkspace(workspace, self._config, function(id) {
        workspace = workspace.copy(workspace.name(), id);
        workspace.resetChanged();

        self._workspaceManager.updateWorkspace(workspace);
        self._workspaceManager.changeActiveWorkspace(id);
      });
    }
  ));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiDeleteActiveWorkspace = function() {
  var self = this;
  this._controlManager.onDeleteActiveWorkspace().addListener(new epiviz.events.EventListener(
    function() {
      self._dataManager.deleteWorkspace(self._workspaceManager.activeWorkspace());
      self._workspaceManager.deleteActiveWorkspace();
    }
  ));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiRevertActiveWorkspace = function() {
  var self = this;
  this._controlManager.onRevertActiveWorkspace().addListener(new epiviz.events.EventListener(
    function() {
      self._workspaceManager.revertActiveWorkspace();
    }
  ));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiLoginLinkClicked = function() {
  var self = this;
  this._controlManager.onLoginLinkClicked().addListener(new epiviz.events.EventListener(function() {
    self._userManager.toggleLogin();
  }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiSearchWorkspaces = function() {
  var self = this;
  this._controlManager.onSearchWorkspaces().addListener(new epiviz.events.EventListener(
    /**
     * @param {{searchTerm: string, callback: function(Array.<epiviz.workspaces.Workspace>)}} e
     */
    function(e) {
      self._dataManager.getWorkspaces(function(workspaces) {
        e.callback(workspaces);
      }, e.searchTerm, e.searchTerm);
    }
  ))
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiActiveWorkspaceChanged = function() {
  var self = this;
  this._controlManager.onActiveWorkspaceChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {{oldValue: {id: string, name: string}, newValue: {id: string, name: string}, cancel: function}} e
     */
    function(e) {

      var doChangeActiveWorkspace = function() {
        if (e.newValue.id && !self._workspaceManager.get(e.newValue.id)) {
          // The requested workspace id belongs to another user, so it has to be retrieved
          self._dataManager.getWorkspaces(function(rawWorkspaces) {
            var result = null;
            for (var i = 0; i < rawWorkspaces.length; ++i) {
              var w = epiviz.workspaces.Workspace.fromRawObject(rawWorkspaces[i], self._chartFactory, self._config);

              if (w.id() === null) {
                // This is a workspace retrieved using e.activeWorkspaceId
                // and belonging to another user
                result = w;
                break;
              }
            }

            if (result) {
              self._workspaceManager.changeActiveWorkspace(e.newValue.id, result);
            }
          }, e.newValue.name, e.newValue.id);
        } else { self._workspaceManager.changeActiveWorkspace(e.newValue.id); }
      };

      if (epiviz.workspaces.UserManager.USER_STATUS.loggedIn && !self._workspaceManager.activeWorkspaceChanging() && self._workspaceManager.activeWorkspace().changed()) {
        var dialog = new epiviz.ui.controls.MessageDialog(
          'Discard workspace changes',
          {
            Yes: function() {
              doChangeActiveWorkspace();
            },
            No: function() {
              e.cancel();
            }
          },
          'There are unsaved changes in the current workspace. Do you wish to discard them?',
          epiviz.ui.controls.MessageDialog.Icon.QUESTION);
        dialog.show();
      } else {
        doChangeActiveWorkspace();
      }
    }
  ));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiSearch = function() {
  var self = this;
  this._controlManager.onSearch().addListener(new epiviz.events.EventListener(
    /**
     * @param {{searchTerm: string, callback: (function(Array.<{probe: string, gene: string, seqName: string, start: number, end: number}>))}} e
     */
    function(e) {
      self._dataManager.search(function(results) {
        e.callback(results);
      }, e.searchTerm);
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerChartRequestHierarchy = function() {
  var self = this;
  this._chartManager.onChartRequestHierarchy().addListener(new epiviz.events.EventListener(function(e) {
    var map = {};
    map[e.id] = e.args;
    self._dataManager.getHierarchy(map, function(chartId, data) {
      self._chartManager.updateCharts(undefined, data, [chartId]);
    })
  }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerChartPropagateHierarchySelection = function() {
  var self = this;
  this._chartManager.onChartPropagateHierarchyChanges().addListener(new epiviz.events.EventListener(function(e) {
    var map = {};
    map[e.id] = e.args;
    self._dataManager.propagateHierarchyChanges(map, function(chartId, data) {
      self._chartManager.updateCharts(undefined, data, [chartId]);
    })
  }));
};


/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiSettingsChanged = function() {
  var self = this;
  this._workspaceManager.onUiChartSettingsChanged().addListener(new epiviz.events.EventListener(
      function(e) {
        //do nothing!
        self._dataManager.updateChartSettings(e);
      }));
};

/*****************************************************************************
 * Data                                                                      *
 *****************************************************************************/

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataAddMeasurements = function() {
  var self = this;
  this._dataManager.onRequestAddMeasurements().addListener(new epiviz.events.EventListener(
    /** @param {{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}} e */
    function(e) {
      try {
        self._measurementsManager.addMeasurements(e.measurements);
        e.result.success = true;
      } catch (error) {
        e.result.success = false;
        e.result.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataRemoveMeasurements = function() {
  var self = this;
  this._dataManager.onRequestRemoveMeasurements().addListener(new epiviz.events.EventListener(
    /** @param {{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}} e */
      function(e) {
      try {
        self._measurementsManager.removeMeasurements(e.measurements);
        e.result.success = true;
      } catch (error) {
        e.result.success = false;
        e.result.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataAddChart = function() {
  var self = this;
  this._dataManager.onRequestAddChart().addListener(new epiviz.events.EventListener(
    /** @param {{type: string, visConfigSelection: epiviz.ui.controls.VisConfigSelection, result: epiviz.events.EventResult}} e */
    function(e) {
      try {
        var chartType = self._chartFactory.get(e.type);
        var chartId = self._addChart(chartType, e.visConfigSelection);
        e.result.success = true;
        e.result.value = { id: chartId };
      } catch (error) {
        e.result.success = false;
        e.result.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataRemoveChart = function() {
  var self = this;
  this._dataManager.onRequestRemoveChart().addListener(new epiviz.events.EventListener(
    /**
     * @param {{id: string, result: epiviz.events.EventResult}} e
     */
    function(e) {
      try {
        self._chartManager.removeChart(e.id);
        e.result.success = true;
      } catch (error) {
        e.result.success = false;
        e.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerPrintWorkspace = function() {
  var self = this;
  this._dataManager.onRequestPrintWorkspace().addListener(new epiviz.events.EventListener(
      /**
       * @param {{id: string, result: epiviz.events.EventResult}} e
       */
      function(e) {
        try {
          var pm = new epiviz.ui.PrintManager(e.chartId, e.fileName, e.fileType);
          pm.print();
          //self._controlManager.printWorkspace(e.chartId, e.fileName, e.fileType);
          e.result.success = true;
        } catch (error) {
          e.result.success = false;
          e.errorMessage = error.toString();
        }
      }));
};


/**
 * @private
 */
epiviz.EpiViz.prototype._registerLoadWorkspace = function() {
  var self = this;
  this._dataManager.onRequestLoadWorkspace().addListener(new epiviz.events.EventListener(
      /**
       * @param {{id: string, result: epiviz.events.EventResult}} e
       */
      function(e) {
        try {
          self._workspaceManager._requestWorkspaces.notify({ activeWorkspaceId: e.workspace });
          
        } catch (error) {
          e.result.success = false;
          e.errorMessage = error.toString();
        }
      }));
};


/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataSetChartSettings = function() {
  var self = this;
  this._dataManager.onRequestSetChartSettings().addListener(new epiviz.events.EventListener(
      /**
       * @param {{id: string, settings: Array, result: epiviz.events.EventResult}} e
       */
      function(e) {
        try {
            self._chartManager.setChartSettings(e.chartId, e.settings, e.colorMap);
            e.result.success = true;
          } catch(error) {
            e.result.success = false;
            e.result.errorMessage = error.toString();
          }
        })
  );
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataGetChartSettings = function() {
  var self = this;
  this._dataManager.onRequestGetChartSettings().addListener(new epiviz.events.EventListener(
      /**
       * @param {{id: string, settings: Array, result: epiviz.events.EventResult}} e
       */
      function(e) {
        try {
          self._chartManager.getChartSettings(e.chartId);
          e.result.success = true;
        } catch(error) {
          e.result.success = false;
          e.result.errorMessage = error.toString();
        }
      })
  );
};


/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataGetAvailableCharts = function() {
  var self = this;
  this._dataManager.onRequestGetChartSettings().addListener(new epiviz.events.EventListener(
      /**
       * @param {{id: string, settings: Array, result: epiviz.events.EventResult}} e
       */
      function(e) {
        try {
          e.result.value = [];
          self._chartFactory.foreach(function(chartName, chartType) {

            e.result.value.push({
              'chartName': chartName,
              'customSettings': chartType.customSettingsDefs(),
              'colorMap':chartType.defaultColors()._colors});
          });
          e.result.success = true;
        } catch(error) {
          e.result.success = false;
          e.result.errorMessage = error.toString();
        }
      })
  );
};



/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataAddSeqInfos = function() {
  var self = this;
  this._dataManager.onRequestAddSeqInfos().addListener(new epiviz.events.EventListener(
    /**
     * @param {{seqInfos: Array.<epiviz.datatypes.SeqInfo>, result: epiviz.events.EventResult}} e
     */
    function(e) {
      try {
        self._locationManager.addSeqInfos(e.seqInfos);
        e.result.success = true;
      } catch (error) {
        e.result.success = false;
        e.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataRemoveSeqNames = function() {
  var self = this;
  this._dataManager.onRequestRemoveSeqNames().addListener(new epiviz.events.EventListener(
    /**
     * @param {{seqNames: Array.<string>, result: epiviz.events.EventResult}} e
     */
    function(e) {
      try {
        self._locationManager.removeSeqNames(e.seqNames);
        e.result.success = true;
      } catch (error) {
        e.result.success = false;
        e.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataNavigate = function() {
  var self = this;
  this._dataManager.onRequestNavigate().addListener(new epiviz.events.EventListener(
    /**
     * @param {{range: epiviz.datatypes.GenomicRange, result: epiviz.events.EventResult}} e
     */
    function(e) {
      try {
        self._locationManager.changeCurrentLocation(e.range);
        e.result.success = true;
      } catch (error) {
        e.result.success = false;
        e.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataRedraw = function() {
  var self = this;
  this._dataManager.onRequestRedraw().addListener(new epiviz.events.EventListener(
    /**
     * @param {{result: epiviz.events.EventResult}} e
     */
    function(e) {
      try {
        var currentLocation = self._locationManager.currentLocation();
        self._locationManager.changeCurrentLocation(currentLocation);
        e.result.success = true;

        self._chartManager.updateDataStructureCharts();
      } catch (error) {
        e.result.success = false;
        e.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataGetCurrentLocation = function() {
  var self = this;
  this._dataManager.onRequestCurrentLocation().addListener(new epiviz.events.EventListener(
    /**
     * @param {{result: epiviz.events.EventResult}} e
     */
      function(e) {
      try {
        var currentLocation = self._locationManager.currentLocation();
        e.result.value = { seqName: currentLocation.seqName(), start: currentLocation.start(), end: currentLocation.end() };
        e.result.success = true;
      } catch (error) {
        e.result.success = false;
        e.errorMessage = error.toString();
      }
    }));
};

/*****************************************************************************
 * Workspaces                                                                *
 *****************************************************************************/

/**
 * @private
 */
epiviz.EpiViz.prototype._registerWorkspacesLoaded = function() {
  var self = this;
  this._workspaceManager.onWorkspacesLoaded().addListener(new epiviz.events.EventListener(
    /**
     * @param {{
     *   activeWorkspace: epiviz.workspaces.Workspace,
     *   workspaces: Array.<epiviz.workspaces.Workspace>
     * }} e
     */
    function(e) {
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerActiveWorkspaceChanged = function() {
  var self = this;
  this._workspaceManager.onActiveWorkspaceChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {{oldValue: epiviz.workspaces.Workspace, newValue: epiviz.workspaces.Workspace, workspaceId: string}} e
     */
    function(e) {
      self._workspaceManager.startChangingActiveWorkspace();

      self._controlManager.updateSelectedWorkspace({id: e.newValue.id(), name: e.newValue.name()});
      self._locationManager.changeCurrentLocation(e.newValue.range());

      self._measurementsManager.removeMeasurements(self._measurementsManager.computedMeasurements());
      self._measurementsManager.addMeasurements(e.newValue.computedMeasurements());

      self._chartManager.clear();

      /**
       * @type {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<{id: string, type: epiviz.ui.charts.ChartType, properties: epiviz.ui.charts.VisualizationProperties}>>}
       */
      var charts = e.newValue.charts();

      for (var displayType in charts) {
        if (!charts.hasOwnProperty(displayType)) { continue; }

        for (var i = 0; i < charts[displayType].length; ++i) {
          self._addChart(charts[displayType][i].type, charts[displayType][i].properties.visConfigSelection, charts[displayType][i].id, charts[displayType][i].properties.copy());
        }
      }

      self._workspaceManager.endChangingActiveWorkspace();
    }
  ));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerActiveWorkspaceContentChanged = function() {
  var self = this;
  this._workspaceManager.onActiveWorkspaceContentChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {epiviz.workspaces.Workspace} w
     */
    function(w) {
      self._cookieManager.saveWorkspace(w, self._config);
    }
  ));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerLocationChanged = function() {
  var self = this;
  this._locationManager.onCurrentLocationChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {{oldValue: epiviz.datatypes.GenomicRange, newValue: epiviz.datatypes.GenomicRange}} e
     */
    function(e) {
      self._chartManager.dataWaitStart(undefined,
        /**
         * @param {epiviz.ui.charts.Visualization} chart
         * @returns {boolean}
         */
        function(chart) {
          return chart.displayType() != epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE;
        });

      /** @type {Object.<string, epiviz.measurements.MeasurementSet>} */
      var chartMeasurementsMap = self._chartManager.chartsMeasurements();

      // TODO: update pca plots for Hierarchy Changes
      // remove PCA & alphadiversity here
      for ( var mea in chartMeasurementsMap) {
          if (mea.indexOf('pca_scatter') != -1 || mea.indexOf('diversity_scatter') != -1) {
            delete chartMeasurementsMap[mea];
          }
      } 

      self._dataManager.getData(e.newValue, chartMeasurementsMap,
        function(chartId, data) {
          self._chartManager.updateCharts(e.newValue, data, [chartId]);
        });

      if(!self._chartManager.onChartPropogateIcicleLocationChanges().isFiring()) {
          self._chartManager.onChartIcicleLocationChanges().notify();
        }
    }));
};

epiviz.EpiViz.prototype._registerChartPropogateIcicleLocationChange = function() {
  var self = this;

  self._chartManager.onChartPropogateIcicleLocationChanges().addListener(new epiviz.events.EventListener(
    function(e) {

      //console.log(e);
      var currentLocation = self._locationManager.currentLocation();
      if(currentLocation != null) {
        self._locationManager.changeCurrentLocation(
            new epiviz.datatypes.GenomicRange(currentLocation.seqName(), 
              e.start, 
              e.width));
      }
    }
  ));
};
// Input 104
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/8/13
 * Time: 2:26 PM
 */

goog.provide('epiviz.main');

goog.require('epiviz.Config');
goog.require('epiviz.ui.LocationManager');
goog.require('epiviz.measurements.MeasurementsManager');
goog.require('epiviz.ui.charts.ChartFactory');
goog.require('epiviz.ui.charts.ChartManager');
goog.require('epiviz.ui.ControlManager');
goog.require('epiviz.data.DataProviderFactory');
goog.require('epiviz.data.DataManager');
goog.require('epiviz.localstorage.LocalStorageManager');
goog.require('epiviz.workspaces.WorkspaceManager');
goog.require('epiviz.workspaces.UserManager');
goog.require('epiviz.ui.WebArgsManager');
goog.require('epiviz.EpiViz');
goog.require('epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory');


/*
 * Main entry point
 */
epiviz.main = function() {
  var config = new epiviz.Config(epiviz.Config.SETTINGS);

  /** @type {epiviz.ui.LocationManager} */
  var locationManager = new epiviz.ui.LocationManager(config);

  /** @type {epiviz.measurements.MeasurementsManager} */
  var measurementsManager = new epiviz.measurements.MeasurementsManager();

  /** @type {epiviz.ui.charts.ChartFactory} */
  var chartFactory = new epiviz.ui.charts.ChartFactory(config);

  /** @type {epiviz.ui.charts.ChartManager} */
  var chartManager = new epiviz.ui.charts.ChartManager(config);

  /** @type {epiviz.ui.ControlManager} */
  var controlManager = new epiviz.ui.ControlManager(config, chartFactory, chartManager, measurementsManager, locationManager);

  /** @type {epiviz.data.DataProviderFactory} */
  var dataProviderFactory = new epiviz.data.DataProviderFactory(config);

  /** @type {epiviz.data.DataManager} */
  var dataManager = new epiviz.data.DataManager(config, dataProviderFactory);

  /** @type {epiviz.localstorage.LocalStorageManager} */
  var localStorageManager = null;

  // if useCookie is false, create a localstorage instance [incognito mode].
  // If there was a previous incognito instance, clear the workspace data
  if(config.useCookie == "false") {
    localStorageManager = new epiviz.localstorage.LocalStorageManager(epiviz.localstorage.LocalStorageManager.MODE.INCOGNITO_MODE);
    localStorageManager.clearWorkspace();
    config.defaultWorkspaceSettings.content.charts = null;
  }
  else {
    localStorageManager = new epiviz.localstorage.LocalStorageManager(epiviz.localstorage.LocalStorageManager.MODE.COOKIE_MODE);
  }

  /** @type {epiviz.workspaces.WorkspaceManager} */
  var workspaceManager = new epiviz.workspaces.WorkspaceManager(config, locationManager, measurementsManager, chartManager, chartFactory);

  /** @type {epiviz.workspaces.UserManager} */
  var userManager = new epiviz.workspaces.UserManager(config);

  /** @type {epiviz.ui.WebArgsManager} */
  var webArgsManager = new epiviz.ui.WebArgsManager(locationManager, workspaceManager);

  /** @type {epiviz.EpiViz} */
  var epivizHandler = new epiviz.EpiViz(config, locationManager, measurementsManager, controlManager, dataManager, chartFactory, chartManager, workspaceManager, userManager, webArgsManager, localStorageManager);

  epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.initialize(config);

  epivizHandler.start();
};

goog.exportSymbol('epiviz.main', epiviz.main);

// Input 105
/**
 * Created by: Florin Chelaru
 * Date: 10/2/13
 * Time: 12:46 PM
 */

goog.provide('epiviz.EpiViz');

goog.require('epiviz.ui.charts.VisualizationType');
goog.require('epiviz.workspaces.Workspace');
goog.require('epiviz.events.EventListener');
goog.require('epiviz.ui.controls.MessageDialog');
goog.require('epiviz.datatypes.GenomicRange');

/**
 * @param {epiviz.Config} config
 * @param {epiviz.ui.LocationManager} locationManager
 * @param {epiviz.measurements.MeasurementsManager} measurementsManager
 * @param {epiviz.ui.ControlManager} controlManager
 * @param {epiviz.data.DataManager} dataManager
 * @param {epiviz.ui.charts.ChartFactory} chartFactory
 * @param {epiviz.ui.charts.ChartManager} chartManager
 * @param {epiviz.workspaces.WorkspaceManager} workspaceManager
 * @param {epiviz.workspaces.UserManager} userManager
 * @param {epiviz.ui.WebArgsManager} webArgsManager
 * @param {epiviz.localstorage.LocalStorageManager} [cookieManager]
 * @constructor
 */
epiviz.EpiViz = function(config, locationManager, measurementsManager, controlManager, dataManager, chartFactory, chartManager, workspaceManager, userManager, webArgsManager, cookieManager) {
  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {epiviz.ui.LocationManager}
   * @private
   */
  this._locationManager = locationManager;

  /**
   * @type {epiviz.measurements.MeasurementsManager}
   * @private
   */
  this._measurementsManager = measurementsManager;

  /**
   * @type {epiviz.ui.ControlManager}
   * @private
   */
  this._controlManager = controlManager;

  /**
   * @type {epiviz.data.DataManager}
   * @private
   */
  this._dataManager = dataManager;

  /**
   * @type {epiviz.ui.charts.ChartFactory}
   * @private
   */
  this._chartFactory = chartFactory;

  /**
   * @type {epiviz.ui.charts.ChartManager}
   * @private
   */
  this._chartManager = chartManager;

  /**
   * @type {epiviz.workspaces.WorkspaceManager}
   * @private
   */
  this._workspaceManager = workspaceManager;

  /**
   * @type {epiviz.workspaces.UserManager}
   * @private
   */
  this._userManager = userManager;

  /**
   * @type {epiviz.ui.WebArgsManager}
   * @private
   */
  this._webArgsManager = webArgsManager;

  /**
   * @type {epiviz.localstorage.LocalStorageManager}
   * @private
   */
  this._cookieManager = cookieManager;

  // Register for UI events

  this._registerRequestSeqInfos();
  this._registerRequestMeasurements();

  this._registerUiAddChart();
  this._registerUiSaveWorkspace();
  this._registerUiDeleteActiveWorkspace();
  this._registerUiRevertActiveWorkspace();
  this._registerUiLoginLinkClicked();
  this._registerUiSearchWorkspaces();
  this._registerUiActiveWorkspaceChanged();
  this._registerUiSearch();

  this._registerChartRequestHierarchy();
  this._registerChartPropagateHierarchySelection();

  this._registerChartPropogateIcicleLocationChange();

  this._registerUiSettingsChanged();

  // Register for Data events

  this._registerDataAddMeasurements();
  this._registerDataRemoveMeasurements();
  this._registerDataAddChart();
  this._registerDataRemoveChart();
  this._registerDataAddSeqInfos();
  this._registerDataRemoveSeqNames();
  this._registerDataNavigate();
  this._registerDataRedraw();
  this._registerDataGetCurrentLocation();
  this._registerPrintWorkspace();
  this._registerLoadWorkspace();
  this._registerDataSetChartSettings();
  this._registerDataGetChartSettings();
  this._registerDataGetAvailableCharts();

  // Register for Workspace events

  this._registerRequestWorkspaces();
  this._registerWorkspacesLoaded();
  this._registerActiveWorkspaceChanged();
  this._registerActiveWorkspaceContentChanged();
  this._registerLocationChanged();

  /*
   * Prevent closing if workspace has changed
   */
  var self = this;
  // TODO: Cleanup
  /*window.onbeforeunload = function() {
    if (epiviz.workspaces.UserManager.USER_STATUS.loggedIn && self._workspaceManager.activeWorkspace().changed()) {
      return 'There are unsaved changes in the current workspace.';
    }
    return undefined;
   };*/
};

/**
 * @type {string}
 * @const
 */
epiviz.EpiViz.VERSION = '4';

epiviz.EpiViz.prototype.start = function() {
  this._cookieManager.initialize();

  this._controlManager.initialize();
  
  this._workspaceManager.initialize();

  this._measurementsManager.initialize();

  this._locationManager.initialize();
};

/**
 * @returns {epiviz.Config}
 */
epiviz.EpiViz.prototype.config = function() {
  return this._config;
};

/**
 * @param {epiviz.ui.charts.ChartType} type
 * @param {epiviz.ui.controls.VisConfigSelection} visConfigSelection
 * @param {string} [chartId] If specified, then this will be
 *   the id of the newly created chart. Otherwise, a new one
 *   will be generated.
 * @param {epiviz.ui.charts.VisualizationProperties} [chartProperties]
 * @returns {string} the id of the chart just created
 * @private
 */
epiviz.EpiViz.prototype._addChart = function(type, visConfigSelection, chartId, chartProperties) {
  chartId = this._chartManager.addChart(type, visConfigSelection, chartId, chartProperties);
  var self = this;
  // TODO: Maybe later implement hierarchical display type (see display-type.js for the start of the idea)
  if (type.typeName() == 'epiviz.plugins.charts.CustomScatterPlot'){
    var range = null;
    var chartMeasurementsMap = {};
    chartMeasurementsMap[chartId] = visConfigSelection.measurements;
    this._dataManager.getPCA(range, chartMeasurementsMap,
      function(chartId, data) {
        self._chartManager.updateCharts(range, data, [chartId]);
      });
  }
  else if (type.typeName() == 'epiviz.plugins.charts.DiversityScatterPlot'){
    var range = null;
    var chartMeasurementsMap = {};
    chartMeasurementsMap[chartId] = visConfigSelection.measurements;
    this._dataManager.getDiversity(range, chartMeasurementsMap,
      function(chartId, data) {
        self._chartManager.updateCharts(range, data, [chartId]);
      });
  }
  else if (type.chartDisplayType() == epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) {
    var chartVisConfigSelectionMap = {};
    chartVisConfigSelectionMap[chartId] = visConfigSelection;
    var range = this._workspaceManager.activeWorkspace().range();
    this._dataManager.getHierarchy(chartVisConfigSelectionMap,
      function(chartId, hierarchy) {
        self._chartManager.updateCharts(range, hierarchy, [chartId]);
      });
  } else {
    var range = this._workspaceManager.activeWorkspace().range();
    this._chartManager.dataWaitStart(chartId);
    var chartMeasurementsMap = {};
    chartMeasurementsMap[chartId] = visConfigSelection.measurements;
    this._dataManager.getData(range, chartMeasurementsMap,
      function(chartId, data) {
        self._chartManager.updateCharts(range, data, [chartId]);
      });
  }

  // if (type.chartDisplayType() != epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) {
  //   var mCount = 0;
  //   //add measurements as a new datasource
  //   var chartMs = visConfigSelection.measurements;
  //   chartMs.foreach(function(m, i) {
  //     if(m._datasourceGroup.indexOf('_plot-') == -1 ) {
  //       m._datasourceGroup = m._datasourceGroup + "_" + chartId;
  //       mCount++;
  //     }
  //   });

  //   if (mCount > 0) {
  //     this._measurementsManager.addMeasurements(chartMs);
  //   }
  // }

  return chartId;
};

/*****************************************************************************
 * UI Events                                                                 *
 *****************************************************************************/

/**
 * @private
 */
epiviz.EpiViz.prototype._registerRequestSeqInfos = function() {
  var self = this;
  this._locationManager.onRequestSeqInfos().addListener(new epiviz.events.EventListener(
    function() {
      self._dataManager.getSeqInfos(function(seqInfos) {
        self._locationManager.updateSeqInfos(seqInfos);
      });
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerRequestMeasurements = function() {
  var self = this;
  this._measurementsManager.onRequestMeasurements().addListener(new epiviz.events.EventListener(
    function() {
      self._dataManager.getMeasurements(function(measurements) {
        self._measurementsManager.addMeasurements(measurements);

        //self._workspaceManager.initialize();
      });
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerRequestWorkspaces = function() {
  var self = this;
  this._workspaceManager.onRequestWorkspaces().addListener(new epiviz.events.EventListener(
    /**
     * @param {{activeWorkspaceId: string}} e
     */
    function(e) {
      var cookieWorkspace = self._cookieManager.getWorkspace(self._chartFactory, self._config);
      self._dataManager.getWorkspaces(function(rawWorkspaces) {
        var ws = [];
        var activeWorkspace = null;
        var unchangedActiveWorkspace = null;
        for (var i = 0; i < rawWorkspaces.length; ++i) {
           var w = epiviz.workspaces.Workspace.fromRawObject(rawWorkspaces[i], self._chartFactory, self._config);

          if (w.id() === null) {
            // This is a workspace retrieved using e.activeWorkspaceId
            // and belonging to another user
            activeWorkspace = w;
            continue;
          }

          if (w.id() == e.activeWorkspaceId) {
            if (cookieWorkspace && cookieWorkspace.id() == e.activeWorkspaceId) {
              unchangedActiveWorkspace = w;
              w = cookieWorkspace;
            }
            activeWorkspace = w;
          }

          ws.push(w);
        }

        // if (!activeWorkspace && cookieWorkspace) {
        //   unchangedActiveWorkspace = self._workspaceManager.get(cookieWorkspace.id());
        //   if (!unchangedActiveWorkspace) {
        //     cookieWorkspace = cookieWorkspace.copy(cookieWorkspace.name());
        //     unchangedActiveWorkspace = epiviz.workspaces.Workspace.fromRawObject(self._config.defaultWorkspaceSettings, self._chartFactory, self._config);
        //   }
        //   activeWorkspace = cookieWorkspace;
        // }

        self._workspaceManager.updateWorkspaces(ws, activeWorkspace, e.activeWorkspaceId, unchangedActiveWorkspace);
        if (!cookieWorkspace) { self._workspaceManager.activeWorkspace().resetChanged(); }
       }, '', e.activeWorkspaceId);
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiAddChart = function() {
  var self = this;
  this._controlManager.onAddChart().addListener(new epiviz.events.EventListener(
    /** @param {{type: epiviz.ui.charts.ChartType, visConfigSelection: epiviz.ui.controls.VisConfigSelection}} e */
    function(e) {
      self._addChart(e.type, e.visConfigSelection);
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiSaveWorkspace = function() {
  var self = this;
  this._controlManager.onSaveWorkspace().addListener(new epiviz.events.EventListener(
    /**
     * @param {{name: string, id: ?string}} e
     */
    function(e) {
      // If there is a workspace with this name in the set of workspaces, overwrite it
      // Otherwise, create a copy of the active workspace with the new name, and save that.
      var workspace = self._workspaceManager.getByName(e.name);
      if (workspace) {
        workspace = self._workspaceManager.activeWorkspace().copy(e.name, workspace.id());
      } else {
        workspace = self._workspaceManager.activeWorkspace().copy(e.name);
      }

      self._dataManager.saveWorkspace(workspace, self._config, function(id) {
        workspace = workspace.copy(workspace.name(), id);
        workspace.resetChanged();

        self._workspaceManager.updateWorkspace(workspace);
        self._workspaceManager.changeActiveWorkspace(id);
      });
    }
  ));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiDeleteActiveWorkspace = function() {
  var self = this;
  this._controlManager.onDeleteActiveWorkspace().addListener(new epiviz.events.EventListener(
    function() {
      self._dataManager.deleteWorkspace(self._workspaceManager.activeWorkspace());
      self._workspaceManager.deleteActiveWorkspace();
    }
  ));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiRevertActiveWorkspace = function() {
  var self = this;
  this._controlManager.onRevertActiveWorkspace().addListener(new epiviz.events.EventListener(
    function() {
      self._workspaceManager.revertActiveWorkspace();
    }
  ));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiLoginLinkClicked = function() {
  var self = this;
  this._controlManager.onLoginLinkClicked().addListener(new epiviz.events.EventListener(function() {
    self._userManager.toggleLogin();
  }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiSearchWorkspaces = function() {
  var self = this;
  this._controlManager.onSearchWorkspaces().addListener(new epiviz.events.EventListener(
    /**
     * @param {{searchTerm: string, callback: function(Array.<epiviz.workspaces.Workspace>)}} e
     */
    function(e) {
      self._dataManager.getWorkspaces(function(workspaces) {
        e.callback(workspaces);
      }, e.searchTerm, e.searchTerm);
    }
  ))
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiActiveWorkspaceChanged = function() {
  var self = this;
  this._controlManager.onActiveWorkspaceChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {{oldValue: {id: string, name: string}, newValue: {id: string, name: string}, cancel: function}} e
     */
    function(e) {

      var doChangeActiveWorkspace = function() {
        if (e.newValue.id && !self._workspaceManager.get(e.newValue.id)) {
          // The requested workspace id belongs to another user, so it has to be retrieved
          self._dataManager.getWorkspaces(function(rawWorkspaces) {
            var result = null;
            for (var i = 0; i < rawWorkspaces.length; ++i) {
              var w = epiviz.workspaces.Workspace.fromRawObject(rawWorkspaces[i], self._chartFactory, self._config);

              if (w.id() === null) {
                // This is a workspace retrieved using e.activeWorkspaceId
                // and belonging to another user
                result = w;
                break;
              }
            }

            if (result) {
              self._workspaceManager.changeActiveWorkspace(e.newValue.id, result);
            }
          }, e.newValue.name, e.newValue.id);
        } else { self._workspaceManager.changeActiveWorkspace(e.newValue.id); }
      };

      if (epiviz.workspaces.UserManager.USER_STATUS.loggedIn && !self._workspaceManager.activeWorkspaceChanging() && self._workspaceManager.activeWorkspace().changed()) {
        var dialog = new epiviz.ui.controls.MessageDialog(
          'Discard workspace changes',
          {
            Yes: function() {
              doChangeActiveWorkspace();
            },
            No: function() {
              e.cancel();
            }
          },
          'There are unsaved changes in the current workspace. Do you wish to discard them?',
          epiviz.ui.controls.MessageDialog.Icon.QUESTION);
        dialog.show();
      } else {
        doChangeActiveWorkspace();
      }
    }
  ));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiSearch = function() {
  var self = this;
  this._controlManager.onSearch().addListener(new epiviz.events.EventListener(
    /**
     * @param {{searchTerm: string, callback: (function(Array.<{probe: string, gene: string, seqName: string, start: number, end: number}>))}} e
     */
    function(e) {
      self._dataManager.search(function(results) {
        e.callback(results);
      }, e.searchTerm);
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerChartRequestHierarchy = function() {
  var self = this;
  this._chartManager.onChartRequestHierarchy().addListener(new epiviz.events.EventListener(function(e) {
    var map = {};
    map[e.id] = e.args;
    self._dataManager.getHierarchy(map, function(chartId, data) {
      self._chartManager.updateCharts(undefined, data, [chartId]);
    })
  }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerChartPropagateHierarchySelection = function() {
  var self = this;
  this._chartManager.onChartPropagateHierarchyChanges().addListener(new epiviz.events.EventListener(function(e) {
    var map = {};
    map[e.id] = e.args;
    self._dataManager.propagateHierarchyChanges(map, function(chartId, data) {
      self._chartManager.updateCharts(undefined, data, [chartId]);
    })
  }));
};


/**
 * @private
 */
epiviz.EpiViz.prototype._registerUiSettingsChanged = function() {
  var self = this;
  this._workspaceManager.onUiChartSettingsChanged().addListener(new epiviz.events.EventListener(
      function(e) {
        //do nothing!
        self._dataManager.updateChartSettings(e);
      }));
};

/*****************************************************************************
 * Data                                                                      *
 *****************************************************************************/

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataAddMeasurements = function() {
  var self = this;
  this._dataManager.onRequestAddMeasurements().addListener(new epiviz.events.EventListener(
    /** @param {{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}} e */
    function(e) {
      try {
        self._measurementsManager.addMeasurements(e.measurements);
        e.result.success = true;
      } catch (error) {
        e.result.success = false;
        e.result.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataRemoveMeasurements = function() {
  var self = this;
  this._dataManager.onRequestRemoveMeasurements().addListener(new epiviz.events.EventListener(
    /** @param {{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}} e */
      function(e) {
      try {
        self._measurementsManager.removeMeasurements(e.measurements);
        e.result.success = true;
      } catch (error) {
        e.result.success = false;
        e.result.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataAddChart = function() {
  var self = this;
  this._dataManager.onRequestAddChart().addListener(new epiviz.events.EventListener(
    /** @param {{type: string, visConfigSelection: epiviz.ui.controls.VisConfigSelection, result: epiviz.events.EventResult}} e */
    function(e) {
      try {
        var chartType = self._chartFactory.get(e.type);
        var chartId = self._addChart(chartType, e.visConfigSelection);
        e.result.success = true;
        e.result.value = { id: chartId };
      } catch (error) {
        e.result.success = false;
        e.result.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataRemoveChart = function() {
  var self = this;
  this._dataManager.onRequestRemoveChart().addListener(new epiviz.events.EventListener(
    /**
     * @param {{id: string, result: epiviz.events.EventResult}} e
     */
    function(e) {
      try {
        self._chartManager.removeChart(e.id);
        e.result.success = true;
      } catch (error) {
        e.result.success = false;
        e.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerPrintWorkspace = function() {
  var self = this;
  this._dataManager.onRequestPrintWorkspace().addListener(new epiviz.events.EventListener(
      /**
       * @param {{id: string, result: epiviz.events.EventResult}} e
       */
      function(e) {
        try {
          var pm = new epiviz.ui.PrintManager(e.chartId, e.fileName, e.fileType);
          pm.print();
          //self._controlManager.printWorkspace(e.chartId, e.fileName, e.fileType);
          e.result.success = true;
        } catch (error) {
          e.result.success = false;
          e.errorMessage = error.toString();
        }
      }));
};


/**
 * @private
 */
epiviz.EpiViz.prototype._registerLoadWorkspace = function() {
  var self = this;
  this._dataManager.onRequestLoadWorkspace().addListener(new epiviz.events.EventListener(
      /**
       * @param {{id: string, result: epiviz.events.EventResult}} e
       */
      function(e) {
        try {
          self._workspaceManager._requestWorkspaces.notify({ activeWorkspaceId: e.workspace });
          
        } catch (error) {
          e.result.success = false;
          e.errorMessage = error.toString();
        }
      }));
};


/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataSetChartSettings = function() {
  var self = this;
  this._dataManager.onRequestSetChartSettings().addListener(new epiviz.events.EventListener(
      /**
       * @param {{id: string, settings: Array, result: epiviz.events.EventResult}} e
       */
      function(e) {
        try {
            self._chartManager.setChartSettings(e.chartId, e.settings, e.colorMap);
            e.result.success = true;
          } catch(error) {
            e.result.success = false;
            e.result.errorMessage = error.toString();
          }
        })
  );
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataGetChartSettings = function() {
  var self = this;
  this._dataManager.onRequestGetChartSettings().addListener(new epiviz.events.EventListener(
      /**
       * @param {{id: string, settings: Array, result: epiviz.events.EventResult}} e
       */
      function(e) {
        try {
          self._chartManager.getChartSettings(e.chartId);
          e.result.success = true;
        } catch(error) {
          e.result.success = false;
          e.result.errorMessage = error.toString();
        }
      })
  );
};


/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataGetAvailableCharts = function() {
  var self = this;
  this._dataManager.onRequestGetChartSettings().addListener(new epiviz.events.EventListener(
      /**
       * @param {{id: string, settings: Array, result: epiviz.events.EventResult}} e
       */
      function(e) {
        try {
          e.result.value = [];
          self._chartFactory.foreach(function(chartName, chartType) {

            e.result.value.push({
              'chartName': chartName,
              'customSettings': chartType.customSettingsDefs(),
              'colorMap':chartType.defaultColors()._colors});
          });
          e.result.success = true;
        } catch(error) {
          e.result.success = false;
          e.result.errorMessage = error.toString();
        }
      })
  );
};



/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataAddSeqInfos = function() {
  var self = this;
  this._dataManager.onRequestAddSeqInfos().addListener(new epiviz.events.EventListener(
    /**
     * @param {{seqInfos: Array.<epiviz.datatypes.SeqInfo>, result: epiviz.events.EventResult}} e
     */
    function(e) {
      try {
        self._locationManager.addSeqInfos(e.seqInfos);
        e.result.success = true;
      } catch (error) {
        e.result.success = false;
        e.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataRemoveSeqNames = function() {
  var self = this;
  this._dataManager.onRequestRemoveSeqNames().addListener(new epiviz.events.EventListener(
    /**
     * @param {{seqNames: Array.<string>, result: epiviz.events.EventResult}} e
     */
    function(e) {
      try {
        self._locationManager.removeSeqNames(e.seqNames);
        e.result.success = true;
      } catch (error) {
        e.result.success = false;
        e.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataNavigate = function() {
  var self = this;
  this._dataManager.onRequestNavigate().addListener(new epiviz.events.EventListener(
    /**
     * @param {{range: epiviz.datatypes.GenomicRange, result: epiviz.events.EventResult}} e
     */
    function(e) {
      try {
        self._locationManager.changeCurrentLocation(e.range);
        e.result.success = true;
      } catch (error) {
        e.result.success = false;
        e.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataRedraw = function() {
  var self = this;
  this._dataManager.onRequestRedraw().addListener(new epiviz.events.EventListener(
    /**
     * @param {{result: epiviz.events.EventResult}} e
     */
    function(e) {
      try {
        var currentLocation = self._locationManager.currentLocation();
        self._locationManager.changeCurrentLocation(currentLocation);
        e.result.success = true;

        self._chartManager.updateDataStructureCharts();
      } catch (error) {
        e.result.success = false;
        e.errorMessage = error.toString();
      }
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerDataGetCurrentLocation = function() {
  var self = this;
  this._dataManager.onRequestCurrentLocation().addListener(new epiviz.events.EventListener(
    /**
     * @param {{result: epiviz.events.EventResult}} e
     */
      function(e) {
      try {
        var currentLocation = self._locationManager.currentLocation();
        e.result.value = { seqName: currentLocation.seqName(), start: currentLocation.start(), end: currentLocation.end() };
        e.result.success = true;
      } catch (error) {
        e.result.success = false;
        e.errorMessage = error.toString();
      }
    }));
};

/*****************************************************************************
 * Workspaces                                                                *
 *****************************************************************************/

/**
 * @private
 */
epiviz.EpiViz.prototype._registerWorkspacesLoaded = function() {
  var self = this;
  this._workspaceManager.onWorkspacesLoaded().addListener(new epiviz.events.EventListener(
    /**
     * @param {{
     *   activeWorkspace: epiviz.workspaces.Workspace,
     *   workspaces: Array.<epiviz.workspaces.Workspace>
     * }} e
     */
    function(e) {
    }));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerActiveWorkspaceChanged = function() {
  var self = this;
  this._workspaceManager.onActiveWorkspaceChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {{oldValue: epiviz.workspaces.Workspace, newValue: epiviz.workspaces.Workspace, workspaceId: string}} e
     */
    function(e) {
      self._workspaceManager.startChangingActiveWorkspace();

      self._controlManager.updateSelectedWorkspace({id: e.newValue.id(), name: e.newValue.name()});
      self._locationManager.changeCurrentLocation(e.newValue.range());

      self._measurementsManager.removeMeasurements(self._measurementsManager.computedMeasurements());
      self._measurementsManager.addMeasurements(e.newValue.computedMeasurements());

      self._chartManager.clear();

      /**
       * @type {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<{id: string, type: epiviz.ui.charts.ChartType, properties: epiviz.ui.charts.VisualizationProperties}>>}
       */
      var charts = e.newValue.charts();

      for (var displayType in charts) {
        if (!charts.hasOwnProperty(displayType)) { continue; }

        for (var i = 0; i < charts[displayType].length; ++i) {
          self._addChart(charts[displayType][i].type, charts[displayType][i].properties.visConfigSelection, charts[displayType][i].id, charts[displayType][i].properties.copy());
        }
      }

      self._workspaceManager.endChangingActiveWorkspace();
    }
  ));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerActiveWorkspaceContentChanged = function() {
  var self = this;
  this._workspaceManager.onActiveWorkspaceContentChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {epiviz.workspaces.Workspace} w
     */
    function(w) {
      self._cookieManager.saveWorkspace(w, self._config);
    }
  ));
};

/**
 * @private
 */
epiviz.EpiViz.prototype._registerLocationChanged = function() {
  var self = this;
  this._locationManager.onCurrentLocationChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {{oldValue: epiviz.datatypes.GenomicRange, newValue: epiviz.datatypes.GenomicRange}} e
     */
    function(e) {
      self._chartManager.dataWaitStart(undefined,
        /**
         * @param {epiviz.ui.charts.Visualization} chart
         * @returns {boolean}
         */
        function(chart) {
          return chart.displayType() != epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE;
        });

      /** @type {Object.<string, epiviz.measurements.MeasurementSet>} */
      var chartMeasurementsMap = self._chartManager.chartsMeasurements();

      // TODO: update pca plots for Hierarchy Changes
      // remove PCA & alphadiversity here
      for ( var mea in chartMeasurementsMap) {
          if (mea.indexOf('pca_scatter') != -1 || mea.indexOf('diversity_scatter') != -1) {
            delete chartMeasurementsMap[mea];
          }
      } 

      self._dataManager.getData(e.newValue, chartMeasurementsMap,
        function(chartId, data) {
          self._chartManager.updateCharts(e.newValue, data, [chartId]);
        });

      if(!self._chartManager.onChartPropogateIcicleLocationChanges().isFiring()) {
          self._chartManager.onChartIcicleLocationChanges().notify();
        }
    }));
};

epiviz.EpiViz.prototype._registerChartPropogateIcicleLocationChange = function() {
  var self = this;

  self._chartManager.onChartPropogateIcicleLocationChanges().addListener(new epiviz.events.EventListener(
    function(e) {

      //console.log(e);
      var currentLocation = self._locationManager.currentLocation();
      if(currentLocation != null) {
        self._locationManager.changeCurrentLocation(
            new epiviz.datatypes.GenomicRange(currentLocation.seqName(), 
              e.start, 
              e.width));
      }
    }
  ));
};
// Input 106
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 12:14 PM
 */

goog.provide('epiviz.Config');

goog.require('epiviz.ui.WebArgsManager');
goog.require('epiviz.data.WebsocketDataProvider');
goog.require('epiviz.data.WebServerDataProvider');

/**
 * @param {*} [settingsMap] A map of settings to override the default settings for the config.
 * @constructor
 */
epiviz.Config = function(settingsMap) {

  /**
   * The server storing all the back-end PHP scripts
   * @type {string}
   */
  this.dataServerLocation = null;

  /**
   * The path of the php script that handles chart saving, relative to dataServerLocation
   * @type {string}
   */
  this.chartSaverLocation = null;

  /**
   * A number between 0 and 1
   * @type {number}
   */
  this.zoominRatio = null;

  /**
   * A number greater than 1
   * @type {number}
   */
  this.zoomoutRatio = null;

  /**
   * A number between 0 and 1
   * @type {number}
   */
  this.navigationStepRatio = null;

  /**
   * The delay in milliseconds between a user command and the command being propagated to the data layer
   * @type {number}
   */
  this.navigationDelay = null;

  /**
   * @type {{
   *    name: string,
   *    content: {
   *      range: {seqName: string, start: number, width: number},
   *      measurements: Array.<{
            id: string, name: string, type: string, datasourceId: string,
            datasourceGroup: string, dataprovider: string, formula: null,
            defaultChartType: string, annotation: ?Object.<string, string>,
            minValue: ?number, maxValue: ?number,
            metadata: ?Array.<string>
          }>,
   *      charts: Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<{
   *        id: string,
   *        type: string,
   *        properties: {
   *          width: number, height: number, margins: { top: number, left: number, bottom: number, right: number },
   *          measurements: Array.<number>, colors: Array.<string>, customSettings: Object.<string, string>
   *        }
   *      }>>
   *    }
   * }}
   */
  this.defaultWorkspaceSettings = null;

  /**
   * An array of strings in the following format:
   *   [typename],[arguments], where typename is the name of a type that
   *   extends DataProvider, and arguments is a list of arguments used for
   *   constructing the data provider, separated by comma.
   *
   * @type {Array.<string>}
   */
  this.dataProviders = null;

  /**
   * @type {string}
   */
  this.workspacesDataProvider = null;

  /**
   * @type {boolean}
   */
  this.useCache = true;

  /**
   * @type {string}
   */
  this.useCookie = null;

  /**
   * The time interval used by the cache to clear away unneeded loaded data
   * @type {number}
   */
  this.cacheUpdateIntervalMilliseconds = 30000;

  /**
   * The maximum number of search results to show in the gene search box
   * @type {number}
   */
  this.maxSearchResults = null;

  /**
   * @type {Array.<string>}
   */
  this.chartTypes = null;

  // Default chart properties: these settings map either generic chart display types (plot or track),
  // or specific chart types (for example epiviz.plugins.charts.BlocksTrack) to corresponding
  // configurations.
  //
  // Example:
  // this.chartSettings = {
  //   plot: { width: 400, height: 100 },
  //   'epiviz.plugins.charts.GenesTrack': { height: 150 },
  //   'epiviz.plugins.charts.BlocksTrack': { width: 450, height: 190 }
  // }


  /**
   * @type {Object.<epiviz.ui.charts.VisualizationType.DisplayType|string, Object.<epiviz.Config.VisualizationPropertySettings, *>>}
   */
  this.chartSettings = null;

  /**
   * A map of chart type and settings specific to that particular chart type
   * Example:
   * this.chartCustomSettings = {
   *   'epiviz.plugins.charts.LineTrack': {
   *     maxPoints: 1000
   *   }
   * }
   * @type {Object<string, Object<string, *>>}
   */
  this.chartCustomSettings = null;

  /**
   * @type {{algorithms: Array.<string>, metrics: Array.<string>, linkages: Array.<string>}}
   */
  this.clustering = null;

  /**
   * @type {Array.<epiviz.ui.charts.ColorPalette>}
   */
  this.colorPalettes = null;

  /**
   * @type {Object.<string, epiviz.ui.charts.ColorPalette>}
   */
  this.colorPalettesMap = null;

  // Override settings included in the given object
  if (settingsMap) {
    for (var setting in settingsMap) {
      if (!settingsMap.hasOwnProperty(setting)) { continue; }
      this[setting] = settingsMap[setting];
    }

    if(settingsMap.configType != 'epivizr_standalone') {
      var socketHosts = epiviz.ui.WebArgsManager.WEB_ARGS['websocket-host'];
      if (socketHosts && socketHosts.length) {
        for (var i = 0; i < socketHosts.length; ++i) {
          this.dataProviders.push(sprintf('epiviz.data.WebsocketDataProvider,%s,%s',
              epiviz.data.WebsocketDataProvider.DEFAULT_ID + '-' + i,
              socketHosts[i]));
        }
      }
    }
  }

  var colorPalettesMap = {};
  this.colorPalettes.forEach(function(palette) {
    colorPalettesMap[palette.id()] = palette;
  });
  this.colorPalettesMap = colorPalettesMap;
  
  if(settingsMap.configType != 'default') {
    this.useCookie = epiviz.ui.WebArgsManager.WEB_ARGS.useCookie;
  }
};

/**
 * A map of settings that are used as input for the EpiViz configuration
 * @type {*}
 */
epiviz.Config.SETTINGS = {};

/**
 * @const {string}
 */
epiviz.Config.DEFAULT_DATA_PROVIDER_ID = 'umd';

/**
 * @const {string}
 */
epiviz.Config.DEFAULT_WORKSPACE_NAME = 'Default Workspace';

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.EPIVIZ_V1_COLORS = ['#025167', '#e7003e', '#ffcd00', '#057d9f', '#970026', '#ffe373', '#ff8100'];

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.COLORS_BRIGHT = ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'];

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.COLORS_LIGHT = ['#b8d2eb', '#f2aeac', '#d8e4aa', '#cccccc', '#f2d1b0', '#d4b2d3', '#ddb8a9', '#ebbfd9'];

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.COLORS_MEDIUM = ['#599ad3', '#f1595f', '#79c36a', '#727272', '#f9a65a', '#9e66ab', '#cd7058', '#d77fb3'];

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.COLORS_D3_CAT10 = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"];

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.COLORS_D3_CAT20 = ["#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896", "#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7", "#bcbd22", "#dbdb8d", "#17becf", "#9edae5"];

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.COLORS_D3_CAT20B = ["#393b79", "#5254a3", "#6b6ecf", "#9c9ede", "#637939", "#8ca252", "#b5cf6b", "#cedb9c", "#8c6d31", "#bd9e39", "#e7ba52", "#e7cb94", "#843c39", "#ad494a", "#d6616b", "#e7969c", "#7b4173", "#a55194", "#ce6dbd", "#de9ed6"];

/**
 * @type {Array.<string>}
 * @const
 */
epiviz.Config.COLORS_D3_CAT20C = ["#3182bd", "#6baed6", "#9ecae1", "#c6dbef", "#e6550d", "#fd8d3c", "#fdae6b", "#fdd0a2", "#31a354", "#74c476", "#a1d99b", "#c7e9c0", "#756bb1", "#9e9ac8", "#bcbddc", "#dadaeb", "#636363", "#969696", "#bdbdbd", "#d9d9d9"];

/**
 * @enum {string}
 */
epiviz.Config.VisualizationPropertySettings = {
  WIDTH: 'width',
  HEIGHT: 'height',
  MARGINS: 'margins',
  COLORS: 'colors',
  DECORATIONS: 'decorations'
};

// Input 107
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/27/2015
 * Time: 9:47 AM
 */

goog.provide('epiviz.caja.cajole');

goog.require('epiviz.deferred.Deferred');
// goog.require('epiviz.utils.fillArray');
goog.require('epiviz.utils');


/**
 * @param {string} funcStr
 * @param {Object.<string, *>} [args]
 * @returns {epiviz.deferred.Deferred.<function>}
 */
epiviz.caja.cajole = function(funcStr, args) {
  var deferred = new epiviz.deferred.Deferred();
  caja.load(
    undefined,  // no DOM access
    undefined,  // no network access
    function(frame) {
      frame.code(
        undefined,
        'application/javascript',
        'return (' + funcStr + ');')
        .api(args ? args : {})
        .run(function(func) {
          deferred.resolve(func);
        });
    });
  return deferred;
};

/**
 * @param {string} scriptUrl
 * @param {Object.<string, *>} [args]
 * @returns {epiviz.deferred.Deferred}
 */
epiviz.caja.run = function(scriptUrl, args) {
  var deferred = new epiviz.deferred.Deferred();
  caja.load(
    undefined,  // no DOM access
    undefined,  // no network access
    function(frame) {
      frame.code(
        scriptUrl,
        'application/javascript',
        undefined)
        .api(args ? args : {})
        .run(function() {
          deferred.resolve();
        });
    });
  return deferred;
};

/**
 * @param {Array.<string>} scriptUrls
 * @param {Array.<Object.<string, *>>|Object.<string, *>} [args]
 * @returns {epiviz.deferred.Deferred}
 */
epiviz.caja.chain = function(scriptUrls, args) {
  if (!$.isArray(args)) {
    args = epiviz.utils.fillArray(scriptUrls.length, args);
  }
  return epiviz.utils.deferredFor(scriptUrls.length, function(j) {
    return epiviz.caja.run(scriptUrls[j], args[j]);
  });
};

/**
 * @returns {Object.<string, *>}
 */
epiviz.caja.buildChartMethodContext = function() {
  return {
    epiviz: {
      ui: {
        charts: epiviz.ui.charts,
        controls: epiviz.ui.controls
      },
      utils: epiviz.utils,
      plugins: epiviz.plugins,
      measurements: epiviz.measurements,
      events: epiviz.events,
      deferred: epiviz.deferred,
      datatypes: epiviz.datatypes,
      data: {
        DataProvider: epiviz.data.DataProvider,
        Request: epiviz.data.Request,
        Response: epiviz.data.Response,
        WebServerDataProvider: {
          // TODO: In the future, restrict the access to this method, as it can be a risk factor
          // TODO: For now, it is kept here for DataProvider plugins
          makeGetRequest: epiviz.data.WebServerDataProvider.makeGetRequest
        }
      },
      Config: epiviz.Config
    },
    d3: d3,
    $: $,
    sprintf: sprintf,
    goog: goog
  };
};

// Input 108
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/27/2015
 * Time: 9:47 AM
 */

goog.provide('caja');
goog.provide('epiviz.caja');

goog.require('epiviz.deferred.Deferred');
// goog.require('epiviz.utils.fillArray');
goog.require('epiviz.utils');


caja.initialize = function() {};

/**
 * @param {string} funcStr
 * @param {Object.<string, *>} [args]
 * @returns {epiviz.deferred.Deferred.<function>}
 */
epiviz.caja.cajole = function(funcStr, args) {
  var deferred = new epiviz.deferred.Deferred();

  setTimeout(function() {
    deferred.resolve(eval('(' + funcStr + ')'));
  }, 0);

  return deferred;
};

/**
 * @param {string} scriptUrl
 * @param {Object.<string, *>} [args]
 * @returns {epiviz.deferred.Deferred}
 */
epiviz.caja.run = function(scriptUrl, args) {
  var deferred = new epiviz.deferred.Deferred();

  setTimeout(function() {
    // Adding the script tag to the head as suggested before
    var head = document.getElementsByTagName('head')[0];
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = scriptUrl;

    // Then bind the event to the callback function.
    // There are several events for cross browser compatibility.
    script.onreadystatechange = script.onload = function() {
      deferred.resolve();
    };

    // Fire the loading
    head.appendChild(script);
  }, 0);

  return deferred;
};

/**
 * @param {Array.<string>} scriptUrls
 * @param {Array.<Object.<string, *>>|Object.<string, *>} [args]
 * @returns {epiviz.deferred.Deferred}
 */
epiviz.caja.chain = function(scriptUrls, args) {
  if (!$.isArray(args)) {
    args = epiviz.utils.fillArray(scriptUrls.length, args);
  }
  return epiviz.utils.deferredFor(scriptUrls.length, function(j) {
    return epiviz.caja.run(scriptUrls[j], args[j]);
  });
};

/**
 * @returns {Object.<string, *>}
 */
epiviz.caja.buildChartMethodContext = function() {
  return {
    epiviz: {
      ui: {
        charts: epiviz.ui.charts,
        controls: epiviz.ui.controls
      },
      utils: epiviz.utils,
      plugins: epiviz.plugins,
      measurements: epiviz.measurements,
      events: epiviz.events,
      deferred: epiviz.deferred,
      datatypes: epiviz.datatypes,
      data: {
        DataProvider: epiviz.data.DataProvider,
        Request: epiviz.data.Request,
        Response: epiviz.data.Response,
        WebServerDataProvider: {
          // TODO: In the future, restrict the access to this method, as it can be a risk factor
          // TODO: For now, it is kept here for DataProvider plugins
          makeGetRequest: epiviz.data.WebServerDataProvider.makeGetRequest
        }
      },
      Config: epiviz.Config
    },
    d3: d3,
    $: $,
    sprintf: sprintf,
    goog: goog
  };
};

// Input 109
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/20/2015
 * Time: 7:47 PM
 */

goog.provide('epiviz.localstorage.LocalStorageManager');

goog.require('epiviz.workspaces.Workspace');

/**
 * @constructor
 */
epiviz.localstorage.LocalStorageManager = function(type) {
  this._workspace = type;

  this._availStorage = (typeof(Storage) === "undefined" || localStorage == null) ? false: true;
};

/**
 * @const {string}
 */
//epiviz.localstorage.LocalStorageManager.WORKSPACE = 'workspace';

/**
 * @enum {string}
 */
epiviz.localstorage.LocalStorageManager.MODE = {
  INCOGNITO_MODE: 'incognito_workspace',
  COOKIE_MODE: 'workspace'
};

/**
 */
epiviz.localstorage.LocalStorageManager.prototype.initialize = function() {};

/**
 * @param {epiviz.ui.charts.ChartFactory} chartFactory
 * @param {epiviz.Config} config
 * @returns {epiviz.workspaces.Workspace}
 */
epiviz.localstorage.LocalStorageManager.prototype.getWorkspace = function(chartFactory, config) {
  if(this._availStorage) {
    var rawStr = localStorage.getItem(this._workspace);
    if (!rawStr) { return null; }

    return epiviz.workspaces.Workspace.fromRawObject(JSON.parse(rawStr), chartFactory, config);
  }
};

/**
 * @param {epiviz.workspaces.Workspace} workspace
 * @param {epiviz.Config} config
 */
epiviz.localstorage.LocalStorageManager.prototype.saveWorkspace = function(workspace, config) {
  if(this._availStorage) {
    var raw = workspace.raw(config);
    localStorage.setItem(this._workspace, JSON.stringify(raw));
  }
};

/**
 * clear the workspace for the current instance of localmanager
 */
epiviz.localstorage.LocalStorageManager.prototype.clearWorkspace = function() {
  if(this._availStorage) {
    localStorage.removeItem(this._workspace);
  }
};

/**
 * clears all data in localstorage
 */
epiviz.localstorage.LocalStorageManager.prototype.clearAll = function() {
  if(this._availStorage) {
    localStorage.clear();
  }
};
// TODO: Idea - create a workspace history, for undo/redo functionality!
// Input 110
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 8:49 PM
 */

goog.provide('epiviz.events.EventListener');

/**
 * @param {function(T=)} updateCallback
 * @constructor
 * @template T
 */
epiviz.events.EventListener = function(updateCallback) {
  /**
   * @type {number}
   * @private
   */
  this._id = epiviz.events.EventListener._nextId++;

  /**
   * @type {function(T)}
   * @private
   */
  this._updateCallback = updateCallback;
};

epiviz.events.EventListener._nextId = 0;

/**
 * @param {T} [args]
 */
epiviz.events.EventListener.prototype.update = function(args) {
  this._updateCallback(args);
};

/**
 * @returns {number}
 */
epiviz.events.EventListener.prototype.id = function() {
  return this._id;
};

// Input 111
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 8:42 PM
 */

goog.provide('epiviz.events.Event');

/**
 * @constructor
 * @template T
 */
epiviz.events.Event = function() {
  /**
   * @type {number}
   * @private
   */
  this._count = 0;

  /**
   * @type {Object.<number, epiviz.events.EventListener.<T>>}
   * @private
   */
  this._listeners = {};

  /**
   * Set to true when in the notify() method, to avoid loops
   * @type {boolean}
   * @private
   */
  this._firing = false;
};

/**
 * @param {epiviz.events.EventListener.<T>} listener
 */
epiviz.events.Event.prototype.addListener = function(listener) {
  if (!this._listeners[listener.id()]) { ++this._count; }

  this._listeners[listener.id()] = listener;
};

/**
 * @param {epiviz.events.EventListener.<T>} listener
 */
epiviz.events.Event.prototype.removeListener = function(listener) {
  if (!this._listeners[listener.id()]) { return; }

  delete this._listeners[listener.id()];
  --this._count;
};

/**
 * @param {T} [args]
 */
epiviz.events.Event.prototype.notify = function(args) {
  if (this._firing) { return; }

  if (this._count == 0) { return; }

  this._firing = true;

  for (var id in this._listeners) {
    if (!this._listeners.hasOwnProperty(id)) { continue; }
    this._listeners[id].update(args);
  }

  this._firing = false;
};

/**
 * Returns true if the event is already firing
 * @returns {boolean}
 */
epiviz.events.Event.prototype.isFiring = function() { return this._firing; };

// Input 112
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/4/14
 * Time: 10:45 AM
 */

goog.provide('epiviz.events.EventResult');

/**
 * @constructor
 * @struct
 * @template T
 */
epiviz.events.EventResult = function() {
  /**
   * @type {?boolean}
   */
  this.success = null;

  /**
   * @type {?string}
   */
  this.errorMessage = null;

  /**
   * @type {?T}
   */
  this.value = null;
};

// Input 113
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 12:58 PM
 */

goog.provide('epiviz.workspaces.WorkspaceManager');

goog.require('epiviz.workspaces.Workspace');
goog.require('epiviz.events.EventListener');
goog.require('epiviz.events.Event');
goog.require('epiviz.ui.WebArgsManager');
goog.require('epiviz.datatypes.GenomicRange');


/**
 * @param {epiviz.Config} config
 * @param {epiviz.ui.LocationManager} locationManager
 * @param {epiviz.measurements.MeasurementsManager} measurementsManager
 * @param {epiviz.ui.charts.ChartManager} chartManager
 * @param {epiviz.ui.charts.ChartFactory} chartFactory
 * @constructor
 */
epiviz.workspaces.WorkspaceManager = function(config, locationManager, measurementsManager, chartManager, chartFactory) {
  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {epiviz.ui.LocationManager}
   * @private
   */
  this._locationManager = locationManager;

  /**
   * @type {epiviz.measurements.MeasurementsManager}
   * @private
   */
  this._measurementsManager = measurementsManager;

  /**
   * @type {epiviz.ui.charts.ChartManager}
   * @private
   */
  this._chartManager = chartManager;

  /**
   * @type {epiviz.ui.charts.ChartFactory}
   * @private
   */
  this._chartFactory = chartFactory;

  /**
   * @type {?epiviz.workspaces.Workspace}
   * @private
   */
  this._activeWorkspace = null;

  /**
   * @type {?epiviz.workspaces.Workspace}
   * @private
   */
  this._unchangedActiveWorkspace = null;

  /**
   * Workspaces by id
   *
   * @type {Object.<string, epiviz.workspaces.Workspace>}
   * @private
   */
  this._workspaces = null;

  /**
   * @type {Object.<string, epiviz.workspaces.Workspace>}
   * @private
   */
  this._workspacesByName = null;

  /**
   * @type {epiviz.events.Event.<{activeWorkspace: epiviz.workspaces.Workspace, workspaces: Array.<epiviz.workspaces.Workspace>}>}
   * @private
   */
  this._workspacesLoaded = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{oldValue: epiviz.workspaces.Workspace, newValue: epiviz.workspaces.Workspace, workspaceId: string}>}
   * @private
   */
  this._activeWorkspaceChanged = new epiviz.events.Event();

  /**
   * @type {boolean}
   * @private
   */
  this._activeWorkspaceChanging = false;


  /**
   * @type {epiviz.events.Event.<{activeWorkspaceId: ?string}>}
   * @private
   */
  this._requestWorkspaces = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.workspaces.Workspace>}
   * @private
   */
  this._activeWorkspaceContentChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.workspaces.Workspace>}
   * @private
   */
  this._uiChartSettingsChanged = new epiviz.events.Event();

  var self = this;

  /**
   * @type {epiviz.events.EventListener}
   * @private
   */
  this._activeWorkspaceContentChangedListener = new epiviz.events.EventListener(function(workspace) {
    self._activeWorkspaceContentChanged.notify(workspace);
  });

  // Register for events

  this._registerLocationChanged();
  this._registerComputedMeasurementAdded();
  this._registerComputedMeasurementRemoved();
  this._registerChartAdded();
  this._registerChartRemoved();
  this._registerChartsOrderChanged();
  this._registerChartColorsChanged();
  this._registerChartMethodsModified();
  this._registerChartMethodsReset();
  this._registerChartMarkersModified();
  this._registerChartSizeChanged();
  this._registerChartMarginsChanged();
  this._registerChartCustomSettingsChanged();
};

/**
 * @returns {epiviz.events.Event}
 */
epiviz.workspaces.WorkspaceManager.prototype.onUiChartSettingsChanged = function() { return this._uiChartSettingsChanged; };

/**
 * @returns {?epiviz.workspaces.Workspace}
 */
epiviz.workspaces.WorkspaceManager.prototype.activeWorkspace = function() {
  return this._activeWorkspace || null;
};

/**
 * @param {string} id
 * @returns {?epiviz.workspaces.Workspace}
 */
epiviz.workspaces.WorkspaceManager.prototype.get = function(id) {
  return (id && this._workspaces) ? (this._workspaces[id] || null) : null;
};

/**
 * @param {string} name
 */
epiviz.workspaces.WorkspaceManager.prototype.getByName = function(name) {
  return (name && this._workspacesByName) ? (this._workspacesByName[name] || null) : null;
};

/**
 */
epiviz.workspaces.WorkspaceManager.prototype.initialize = function() {
  var requestWorkspaceId = epiviz.ui.WebArgsManager.WEB_ARGS['ws'] ||
    epiviz.ui.WebArgsManager.WEB_ARGS['workspace'] ||
    null;
  this._requestWorkspaces.notify({ activeWorkspaceId: requestWorkspaceId });
};

/**
 * @param {Array.<epiviz.workspaces.Workspace>} workspaces
 * @param {?epiviz.workspaces.Workspace} [activeWorkspace]
 * @param {?string} [activeWorkspaceId]
 * @param {?epiviz.workspaces.Workspace} [unchangedActiveWorkspace]
 */
epiviz.workspaces.WorkspaceManager.prototype.updateWorkspaces = function(workspaces, activeWorkspace, activeWorkspaceId, unchangedActiveWorkspace) {
  if (workspaces) {
    this._workspaces = {};
    this._workspacesByName = {};
    for (var i = 0; i < workspaces.length; ++i) {
      if (workspaces[i].id() === null) { continue; }
      this._workspaces[workspaces[i].id()] = workspaces[i];
      this._workspacesByName[workspaces[i].name()] = workspaces[i];
    }
  }

  if (!activeWorkspace) {
    activeWorkspace = (workspaces && workspaces.length) ?
      workspaces[0] :
      epiviz.workspaces.Workspace.fromRawObject(this._config.defaultWorkspaceSettings, this._chartFactory, this._config);
  }

  var oldActiveWorkspace = this._activeWorkspace;
  this._activeWorkspace = activeWorkspace;
  if (unchangedActiveWorkspace) {
    this._unchangedActiveWorkspace = unchangedActiveWorkspace;
  } else {
    this._unchangedActiveWorkspace = activeWorkspace ? activeWorkspace.copy(activeWorkspace.name(), activeWorkspace.id()) : null;
  }

  if (oldActiveWorkspace) {
    oldActiveWorkspace.onContentChanged().removeListener(this._activeWorkspaceContentChangedListener);
  }

  if (this._activeWorkspace) {
    this._activeWorkspace.onContentChanged().addListener(this._activeWorkspaceContentChangedListener);
  }

  var webArgs = epiviz.ui.WebArgsManager.WEB_ARGS;

  var seqName = (webArgs['seqName'] != undefined) ? webArgs['seqName'] : this._activeWorkspace.range().seqName();
  var start = null, end = null;
  if (webArgs['start'] != 'undefined') { start = parseInt(webArgs['start']) || this._activeWorkspace.range().start(); }
  if (webArgs['end'] != 'undefined') { end = parseInt(webArgs['end']) || this._activeWorkspace.range().end(); }

  this._activeWorkspace.locationChanged(epiviz.datatypes.GenomicRange.fromStartEnd(seqName, start, end));

  this._workspacesLoaded.notify({
    activeWorkspace: this._activeWorkspace,
    workspaces: workspaces
  });

  this._activeWorkspaceChanged.notify({
    oldValue: oldActiveWorkspace,
    newValue: this._activeWorkspace,
    workspaceId: this._activeWorkspace.id() || activeWorkspaceId
  });
};

/**
 * @param {epiviz.workspaces.Workspace} workspace
 */
epiviz.workspaces.WorkspaceManager.prototype.updateWorkspace = function(workspace) {
  this._workspaces[workspace.id()] = workspace;
  this._workspacesByName[workspace.name()] = workspace;
};

/**
 */
epiviz.workspaces.WorkspaceManager.prototype.deleteActiveWorkspace = function() {
  var activeWorkspace = this._activeWorkspace;
  if (!activeWorkspace || !activeWorkspace.id()) { return; }

  delete this._workspaces[activeWorkspace.id()];
  delete this._workspacesByName[activeWorkspace.name()];

  var newActiveWorkspace = null;
  for (var id in this._workspaces) {
    if (!this._workspaces.hasOwnProperty(id)) { continue; }
    newActiveWorkspace = this._workspaces[id];
    break;
  }

  if (!newActiveWorkspace) {
    newActiveWorkspace = epiviz.workspaces.Workspace.fromRawObject(this._config.defaultWorkspaceSettings, this._chartFactory, this._config);
  }

  this._activeWorkspace = newActiveWorkspace;
  this._unchangedActiveWorkspace = newActiveWorkspace ? newActiveWorkspace.copy(newActiveWorkspace.name(), newActiveWorkspace.id()) : null;

  var seqName = activeWorkspace.range().seqName();
  var start = activeWorkspace.range().start();
  var end = activeWorkspace.range().end();

  this._activeWorkspace.locationChanged(epiviz.datatypes.GenomicRange.fromStartEnd(seqName, start, end));

  this._activeWorkspaceChanged.notify({
    oldValue: activeWorkspace,
    newValue: this._activeWorkspace,
    workspaceId: this._activeWorkspace.id()
  });
};

/**
 */
epiviz.workspaces.WorkspaceManager.prototype.revertActiveWorkspace = function() {
  if (!this._unchangedActiveWorkspace) { return; }
  var oldActiveWorkspace = this._activeWorkspace;

  var seqName = oldActiveWorkspace.range().seqName();
  var start = oldActiveWorkspace.range().start();
  var end = oldActiveWorkspace.range().end();

  this._activeWorkspace = this._unchangedActiveWorkspace.copy(this._unchangedActiveWorkspace.name(), this._unchangedActiveWorkspace.id());

  this._activeWorkspace.locationChanged(epiviz.datatypes.GenomicRange.fromStartEnd(seqName, start, end));

  this._activeWorkspaceChanged.notify({
    oldValue: null,
    newValue: this._activeWorkspace,
    workspaceId: this._activeWorkspace.id()
  });
};

/**
 * @returns {epiviz.events.Event.<Array.<epiviz.workspaces.Workspace>>}
 */
epiviz.workspaces.WorkspaceManager.prototype.onWorkspacesLoaded = function() { return this._workspacesLoaded; };

/**
 * @returns {epiviz.events.Event.<{oldValue: epiviz.workspaces.Workspace, newValue: epiviz.workspaces.Workspace, workspaceId: string}>}
 */
epiviz.workspaces.WorkspaceManager.prototype.onActiveWorkspaceChanged = function() { return this._activeWorkspaceChanged; };

/**
 */
epiviz.workspaces.WorkspaceManager.prototype.startChangingActiveWorkspace = function() { this._activeWorkspaceChanging = true; };

/**
 */
epiviz.workspaces.WorkspaceManager.prototype.endChangingActiveWorkspace = function() { this._activeWorkspaceChanging = false; };

/**
 * @returns {boolean}
 */
epiviz.workspaces.WorkspaceManager.prototype.activeWorkspaceChanging = function() { return this._activeWorkspaceChanging; };

/**
 * @returns {epiviz.events.Event.<{activeWorkspaceId: ?string}>}
 */
epiviz.workspaces.WorkspaceManager.prototype.onRequestWorkspaces = function() { return this._requestWorkspaces; };

/**
 * @returns {epiviz.events.Event.<epiviz.workspaces.Workspace>}
 */
epiviz.workspaces.WorkspaceManager.prototype.onActiveWorkspaceContentChanged = function() { return this._activeWorkspaceContentChanged; };

/**
 * @param {?string} id The id of the new active workspace
 * @param {epiviz.workspaces.Workspace} [workspace] A workspace that doesn't belong to the current user,
 *   to replace the active workspace
 */
epiviz.workspaces.WorkspaceManager.prototype.changeActiveWorkspace = function(id, workspace) {
  workspace = workspace || this._workspaces[id];
  if (!workspace || workspace === this._activeWorkspace) { return; } // TODO: Show a message or throw an error

  var oldValue = this._activeWorkspace;
  this._activeWorkspace = workspace;
  this._unchangedActiveWorkspace = this._activeWorkspace ? this._activeWorkspace.copy(this._activeWorkspace.name(), this._activeWorkspace.id()) : null;
  this._activeWorkspaceChanged.notify({oldValue: oldValue, newValue: this._activeWorkspace, workspaceId: id});
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerLocationChanged = function() {
  var self = this;
  this._locationManager.onCurrentLocationChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {{oldValue: epiviz.datatypes.GenomicRange, newValue: epiviz.datatypes.GenomicRange}} e
     */
    function(e) {
      if (self._activeWorkspaceChanging) { return; }
      if (!self._activeWorkspace) { return; }
      self._activeWorkspace.locationChanged(e.newValue);
    }
  ));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartAdded = function() {
  var self = this;
  this._chartManager.onChartAdded().addListener(new epiviz.events.EventListener(
    /**
     * @param {epiviz.ui.charts.VisEventArgs.<{
     *   type: epiviz.ui.charts.ChartType,
     *   properties: epiviz.ui.charts.VisualizationProperties,
     *   chartsOrder: Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>}>} e
     */
    function(e) {
      if (self._activeWorkspaceChanging) { return; }
      if (!self._activeWorkspace) { return; }
      self._activeWorkspace.chartAdded(e.id, e.args.type, e.args.properties, e.args.chartsOrder);
    }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartRemoved = function() {
  var self = this;
  this._chartManager.onChartRemoved().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartRemoved(e.id, e.args);
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartsOrderChanged = function() {
  var self = this;
  this._chartManager.onChartsOrderChanged().addListener(new epiviz.events.EventListener(function(args) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartsOrderChanged(args);
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartColorsChanged = function() {
  var self = this;
  this._chartManager.onChartColorsChanged().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartColorsChanged(e.id, e.args);

    self.onUiChartSettingsChanged().notify({'chartId': e.id, 'colorMap': e.args});
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartMethodsModified = function() {
  var self = this;
  this._chartManager.onChartMethodsModified().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartMethodsModified(e.id, e.args);
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartMethodsReset = function() {
  var self = this;
  this._chartManager.onChartMethodsReset().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartMethodsReset(e.id);
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartMarkersModified = function() {
  var self = this;
  this._chartManager.onChartMarkersModified().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartMarkersModified(e.id, e.args);
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartCustomSettingsChanged = function() {
  var self = this;
  this._chartManager.onChartCustomSettingsChanged().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartCustomSettingsChanged(e.id, e.args);

    self.onUiChartSettingsChanged().notify({'chartId': e.id, 'settings': e.args});
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartSizeChanged = function() {
  var self = this;
  this._chartManager.onChartSizeChanged().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartSizeChanged(e.id, e.args.width, e.args.height);
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerChartMarginsChanged = function() {
  var self = this;
  this._chartManager.onChartMarginsChanged().addListener(new epiviz.events.EventListener(function(e) {
    if (self._activeWorkspaceChanging) { return; }
    if (!self._activeWorkspace) { return; }
    self._activeWorkspace.chartMarginsChanged(e.id, e.args);
  }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerComputedMeasurementAdded = function() {
  var self = this;
  this._measurementsManager.onComputedMeasurementsAdded().addListener(new epiviz.events.EventListener(
    function(measurements) {
      if (self._activeWorkspaceChanging) { return; }
      if (!self._activeWorkspace) { return; }
      self._activeWorkspace.computedMeasurementsAdded(measurements);
    }));
};

/**
 * @private
 */
epiviz.workspaces.WorkspaceManager.prototype._registerComputedMeasurementRemoved = function() {
  var self = this;
  this._measurementsManager.onComputedMeasurementsRemoved().addListener(new epiviz.events.EventListener(
    function(measurements) {
      if (self._activeWorkspaceChanging) { return; }
      if (!self._activeWorkspace) { return; }
      self._activeWorkspace.computedMeasurementsRemoved(measurements);
    }));
};

// Input 114
/**
 * Created by: Florin Chelaru
 * Date: 10/4/13
 * Time: 8:52 AM
 */

goog.provide('epiviz.workspaces.Workspace');

goog.require('epiviz.measurements.MeasurementSet');
goog.require('epiviz.events.Event');
goog.require('epiviz.Config');
goog.require('epiviz.utils');
goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');
goog.require('epiviz.ui.charts.VisualizationProperties');
goog.require('epiviz.ui.charts.Visualization');
goog.require('epiviz.ui.controls.VisConfigSelection');
goog.require('epiviz.ui.charts.Margins');
goog.require('epiviz.ui.charts.ColorPalette');
goog.require('epiviz.datatypes.GenomicRange');


/**
 * @param {?string} id
 * @param {string} name
 * @param {{
 *   range: epiviz.datatypes.GenomicRange,
 *   computedMeasurements: epiviz.measurements.MeasurementSet,
 *   charts: Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<{
 *     id: string,
 *     type: epiviz.ui.charts.ChartType,
 *     properties: epiviz.ui.charts.VisualizationProperties
 *   }>>
 * }} content
 * @constructor
 */
epiviz.workspaces.Workspace = function(id, name, content) {
  /**
   * @type {?string}
   * @private
   */
  this._id = id;

  /**
   * @type {string}
   * @private
   */
  this._name = name;

  /**
   * @type {epiviz.datatypes.GenomicRange}
   * @private
   */
  this._range = content.range;

  /**
   * @type {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>}
   * @private
   */
  this._chartsOrder = {};

  /**
   * @type {Object.<string, {
   *   id: string,
   *   type: epiviz.ui.charts.ChartType,
   *   properties: epiviz.ui.charts.VisualizationProperties
   * }>}
   * @private
   */
  this._chartsById = {};
  for (var displayType in content.charts) {
    if (!content.charts.hasOwnProperty(displayType)) { continue; }

    this._chartsOrder[displayType] = [];

    for (var i = 0; i < content.charts[displayType].length; ++i) {
      this._chartsById[content.charts[displayType][i].id] = content.charts[displayType][i];

      this._chartsOrder[displayType].push(content.charts[displayType][i].id);
    }
  }

  /**
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._computedMeasurements = content.computedMeasurements || new epiviz.measurements.MeasurementSet();

  /**
   * @type {boolean}
   * @private
   */
  this._changed = false;

  /**
   * @type {epiviz.events.Event.<epiviz.workspaces.Workspace>}
   * @private
   */
  this._contentChanged = new epiviz.events.Event();
};

/**
 * @const {string}
 */
epiviz.workspaces.Workspace.DEFAULT_WORKSPACE_NAME = epiviz.Config.DEFAULT_WORKSPACE_NAME;

/**
 * @returns {string}
 */
epiviz.workspaces.Workspace.prototype.id = function() {
  return this._id;
};

/**
 * @returns {string}
 */
epiviz.workspaces.Workspace.prototype.name = function() {
  return this._name;
};

/**
 * @returns {epiviz.datatypes.GenomicRange}
 */
epiviz.workspaces.Workspace.prototype.range = function() {
  return this._range;
};

/**
 * @returns {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<{id: string, type: epiviz.ui.charts.ChartType, properties: epiviz.ui.charts.VisualizationProperties}>>}
 */
epiviz.workspaces.Workspace.prototype.charts = function() {
  var charts = {};
  for (var displayType in this._chartsOrder) {
    if (!this._chartsOrder.hasOwnProperty(displayType)) { continue; }
    charts[displayType] = [];
    for (var i = 0; i < this._chartsOrder[displayType].length; ++i) {
      charts[displayType].push(this._chartsById[this._chartsOrder[displayType][i]]);
    }
  }

  return charts;
};

/**
 * @returns {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>}
 */
epiviz.workspaces.Workspace.prototype.chartsOrder = function() {
  return this._chartsOrder;
};

/**
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.workspaces.Workspace.prototype.computedMeasurements = function() {
  return this._computedMeasurements;
};

/**
 * @param {string} id
 * @param {epiviz.ui.charts.ChartType} type
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @param {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>} chartsOrder
 */
epiviz.workspaces.Workspace.prototype.chartAdded = function(id, type, properties, chartsOrder) {
  this._chartsById[id] = {
    id: id,
    type: type,
    properties: properties.copy()
  };

  this._chartsOrder = chartsOrder;

  this._setChanged();
};

/**
 * @param {string} id
 * @param {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>} chartsOrder
 */
epiviz.workspaces.Workspace.prototype.chartRemoved = function(id, chartsOrder) {
  if (!this._chartsById[id]) { return; }
  delete this._chartsById[id];
  this._chartsOrder = chartsOrder;

  this._setChanged();
};

/**
 * @param {string} chartId
 * @param {number|string} width
 * @param {number|string} height
 */
epiviz.workspaces.Workspace.prototype.chartSizeChanged = function(chartId, width, height) {
  if (!this._chartsById[chartId]) { return; }
  if (this._chartsById[chartId].properties.width == width && this._chartsById[chartId].properties.height == height) { return; }
  this._chartsById[chartId].properties.width = width;
  this._chartsById[chartId].properties.height = height;

  this._setChanged();
};

/**
 * @param chartId
 * @param margins
 */
epiviz.workspaces.Workspace.prototype.chartMarginsChanged = function(chartId, margins) {
  if (this._chartsById[chartId].properties.margins.equals(margins)) { return; }
  this._chartsById[chartId].properties.margins = margins ? margins.copy() : margins;

  this._setChanged();
};

/**
 * @param {string} chartId
 * @param {epiviz.ui.charts.ColorPalette} colors
 */
epiviz.workspaces.Workspace.prototype.chartColorsChanged = function(chartId, colors) {
  if (this._chartsById[chartId].properties.colors.equals(colors)) { return; }
  this._chartsById[chartId].properties.colors = colors;

  this._setChanged();
};

/**
 * @param {string} chartId
 * @param {Object.<string, string>} modifiedMethods
 */
epiviz.workspaces.Workspace.prototype.chartMethodsModified = function(chartId, modifiedMethods) {
  if (epiviz.utils.mapEquals(
      this._chartsById[chartId].properties.modifiedMethods,
      modifiedMethods)) { return; }

  this._chartsById[chartId].properties.modifiedMethods = epiviz.utils.mapCombine(
    modifiedMethods,
    this._chartsById[chartId].properties.modifiedMethods);

  this._setChanged();
};

/**
 * @param {string} chartId
 */
epiviz.workspaces.Workspace.prototype.chartMethodsReset = function(chartId) {
  if (!this._chartsById[chartId].properties.modifiedMethods ||
    Object.keys(this._chartsById[chartId].properties.modifiedMethods).length == 0) { return; }

  this._chartsById[chartId].properties.modifiedMethods = {};

  this._setChanged();
};

/**
 * @param {string} chartId
 * @param {Array.<epiviz.ui.charts.markers.VisualizationMarker>} markers
 */
epiviz.workspaces.Workspace.prototype.chartMarkersModified = function(chartId, markers) {
  if (epiviz.utils.arraysEqual(
      this._chartsById[chartId].properties.chartMarkers,
      markers)) { return; }

  this._chartsById[chartId].properties.chartMarkers = markers.filter(function(marker) { return marker != null; });

  this._setChanged();
};

/**
 * @param {string} chartId
 * @param {Object<string, *>} customSettingsValues
 */
epiviz.workspaces.Workspace.prototype.chartCustomSettingsChanged = function(chartId, customSettingsValues) {
  if (epiviz.utils.mapEquals(this._chartsById[chartId].properties.customSettingsValues, customSettingsValues)) { return; }
  this._chartsById[chartId].properties.customSettingsValues = customSettingsValues ? epiviz.utils.mapCopy(customSettingsValues) : customSettingsValues;

  this._setChanged();
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 */
epiviz.workspaces.Workspace.prototype.locationChanged = function(range) {
  if (this._range.equals(range)) { return; }

  this._range = range;

  this._setChanged();
};

/**
 * @param {epiviz.measurements.MeasurementSet} measurements
 */
epiviz.workspaces.Workspace.prototype.computedMeasurementsAdded = function(measurements) {
  var sizeBefore = this._computedMeasurements.size();
  this._computedMeasurements.addAll(measurements);

  if (sizeBefore != this._computedMeasurements.size()) { this._setChanged(); }
};

/**
 * @param {epiviz.measurements.MeasurementSet} measurements
 */
epiviz.workspaces.Workspace.prototype.computedMeasurementsRemoved = function(measurements) {
  var sizeBefore = this._computedMeasurements.size();
  this._computedMeasurements.removeAll(measurements);

  if (sizeBefore != this._computedMeasurements.size()) { this._setChanged(); }
};

/**
 * @param {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>} chartsOrder
 */
epiviz.workspaces.Workspace.prototype.chartsOrderChanged = function(chartsOrder) {
  this._chartsOrder = chartsOrder;
  this._setChanged();
};

/**
 * @returns {boolean}
 */
epiviz.workspaces.Workspace.prototype.changed = function() {
  return this._changed;
};

/**
 */
epiviz.workspaces.Workspace.prototype.resetChanged = function() {
  this._changed = false;
};

/**
 * @private
 */
epiviz.workspaces.Workspace.prototype._setChanged = function() {
  this._changed = true;
  this._contentChanged.notify(this);
};

/**
 * Creates a copy of the current workspace, with a new id and new name
 * @param {string} name
 * @param {string} [id]
 */
epiviz.workspaces.Workspace.prototype.copy = function(name, id) {
  var charts = this.charts();
  return new epiviz.workspaces.Workspace(id || null, name, {
    range: this._range,
    computedMeasurements: new epiviz.measurements.MeasurementSet(this._computedMeasurements),
    charts: charts
  });
};

/**
 * @param {epiviz.Config} [config]
 * @returns {{
 *   id: ?string,
 *   name: string,
 *   content: {
 *     range: {seqName: string, start: number, width: number},
 *     measurements: Array.<{
 *       id: string,
 *       name: string,
 *       type: epiviz.measurements.Measurement.Type,
 *       datasourceId: string,
 *       datasourceGroup: string,
 *       dataprovider: string,
 *       formula: string,
 *       defaultChartType: ?string,
 *       annotation: ?Object.<string, string>,
 *       minValue: ?number,
 *       maxValue: ?number,
 *       metadata: ?Array.<string>
 *     }>,
 *     charts: Object.<string, Array.<{
 *       type: string,
 *       properties: {width: number|string, height: number|string, margins: {top: number, left: number, bottom: number, right: number},
 *         visConfigSelection: { measurements: Array.<number>, datasource: string, datasourceGroup: string, dataprovider: string,
 *           annotation: Object.<string, string>, defaultChartType: string, minSelectedMeasurements: number, customData: * },
 *        colors: Array.<string>|{id: string, name: string, colors: Array.<string>}, modifiedMethods: Object.<string, string>,
 *        chartMarkers: Array.<epiviz.ui.charts.markers.VisualizationMarker>
 *     }>>}}}
 */
epiviz.workspaces.Workspace.prototype.raw = function(config) {
  /**
   * @type {epiviz.measurements.MeasurementHashtable.<number>}
   */
  var wsMeasurements = new epiviz.measurements.MeasurementHashtable();
  var charts = {};

  this._computedMeasurements.foreach(function(m) {
    var mIndex;
    var componentMs = m.componentMeasurements();
    componentMs.foreach(function(compM) {
      var mIndex = wsMeasurements.get(compM);
      if (mIndex === null) {
        mIndex = wsMeasurements.size();
        wsMeasurements.put(compM, mIndex);
      }
    });

    var refMs = m.formula().referredMeasurements;
    for (var j in refMs) {
      if (!refMs.hasOwnProperty(j)) { continue; }
      mIndex = wsMeasurements.get(refMs[j]);
      if (mIndex === null) {
        mIndex = wsMeasurements.size();
        wsMeasurements.put(refMs[j], mIndex);
      }
    }

    mIndex = wsMeasurements.get(m);
    if (mIndex === null) {
      mIndex = wsMeasurements.size();
      wsMeasurements.put(m, mIndex);
    }
  });

  for (var displayType in this._chartsOrder) {
    if (!this._chartsOrder.hasOwnProperty(displayType)) { continue; }

    charts[displayType] = [];
    for (var i = 0; i < this._chartsOrder[displayType].length; ++i) {
      var chartData = this._chartsById[this._chartsOrder[displayType][i]];
      var props = chartData.properties;

      /** @type {Array.<number>} */
      var ms = [];

      (function(ms) {
        props.visConfigSelection.measurements.foreach(function(m) {
          var mIndex = wsMeasurements.get(m);
          if (mIndex === null) {
            mIndex = wsMeasurements.size();
            wsMeasurements.put(m, mIndex);
          }

          ms.push(mIndex);
        });
      })(ms);

      charts[displayType].push({
        id: chartData.id,
        type: chartData.type.typeName(),
        properties: {
          width: props.width,
          height: props.height,
          margins: props.margins.raw(),
          visConfigSelection: {
            measurements: ms,
            datasource: props.visConfigSelection.datasource,
            datasourceGroup: props.visConfigSelection.datasourceGroup,
            dataprovider: props.visConfigSelection.dataprovider,
            annotation: props.visConfigSelection.annotation,
            defaultChartType: props.visConfigSelection.defaultChartType,
            minSelectedMeasurements: props.visConfigSelection.minSelectedMeasurements,
            customData: props.visConfigSelection.customData
          },
          colors: props.colors.raw(config),
          modifiedMethods: epiviz.utils.mapCopy(props.modifiedMethods),
          customSettings: props.customSettingsValues || null,
          chartMarkers: props.chartMarkers.map(function(marker) { return marker.raw(); })
        }
      });
    }
  }

  var rawMs = new Array(wsMeasurements.size());
  wsMeasurements.foreach(function(m, j) {
    rawMs[j] = m.raw(wsMeasurements);
  });

  return {
    id: this._id,
    name: this._name,
    content: {
      range: this._range.raw(),
      measurements: rawMs,
      charts: charts
    }
  };
};

/**
 * @param {{
 *   id: ?string,
 *   name: string,
 *   content: {
 *     range: {seqName: string, start: number, width: number},
 *     measurements: Array,
 *     charts: Object.<string, Array.<{
 *       id: string,
 *       type: string,
 *       properties: {
 *        width: number|string,
 *        height: number|string,
 *        margins: {top: number, left: number, bottom: number, right: number},
 *        visConfigSelection: {
 *          measurements: Array.<number>,
 *          datasource: string,
 *          datasourceGroup: string,
 *          dataprovider: string,
 *          annotation: Object.<string, string>,
 *          defaultChartType: string,
 *          minSelectedMeasurements: number,
 *          customData: *
 *        },
 *        colors: Array.<string>|{id: string, name: string, colors: Array.<string>},
 *        modifiedMethods: ?Object<string, string>,
 *        customSettings: Object.<string, *>
 *      }
 *     }>>}}} o
 * @param {epiviz.ui.charts.ChartFactory} chartFactory
 * @param {epiviz.Config} config
 * @returns {epiviz.workspaces.Workspace}
 */
epiviz.workspaces.Workspace.fromRawObject = function(o, chartFactory, config) {
  var i;
  var ms = new Array(o.content.measurements.length);
  var computedMeasurements = new epiviz.measurements.MeasurementSet();

  // First, parse all non-computed measurements, as we may need them in parsing the computed measurements
  for (i = 0; i < o.content.measurements.length; ++i) {
    if (!o.content.measurements[i].formula) {
      ms[i] = epiviz.measurements.Measurement.fromRawObject(o.content.measurements[i]);
    }
  }

  // Second, parse computed measurements
  for (i = 0; i < o.content.measurements.length; ++i) {
    if (o.content.measurements[i].formula) {
      ms[i] = epiviz.measurements.Measurement.fromRawObject(o.content.measurements[i], ms);
      computedMeasurements.add(ms[i]);
    }
  }

  var charts = {};
  for (var t in o.content.charts) {
    if (!o.content.charts.hasOwnProperty(t)) { continue; }
    charts[t] = [];
    for (i = 0; i < o.content.charts[t].length; ++i) {
      /**
       * @type {{id: string, type: string, properties: {
       *        width: number|string,
       *        height: number|string,
       *        margins: {top: number, left: number, bottom: number, right: number},
       *        visConfigSelection: {
       *          measurements: Array.<number>,
       *          datasource: string,
       *          datasourceGroup: string,
       *          dataprovider: string,
       *          annotation: Object.<string, string>,
       *          defaultChartType: string,
       *          minSelectedMeasurements: number,
       *          customData: *
       *        },
       *        colors: Array.<string>|{id: string, name: string, colors: Array.<string>},
       *        modifiedMethods: ?Object.<string, string>,
       *        customSettings: Object.<string, *>,
       *        chartMarkers: Array.<{type: string, id: string, name: string, preMark: string, mark: string}>
       *      }}}
       */
      var chartInfo = o.content.charts[t][i];
      var chartMs;

      var rawVisConfigSelection = chartInfo.properties.visConfigSelection;
      var rawMs = rawVisConfigSelection ? rawVisConfigSelection.measurements : chartInfo.properties.measurements;

      if (rawMs) {
        chartMs = new epiviz.measurements.MeasurementSet();
        for (var j = 0; j < rawMs.length; ++j) {
          chartMs.add(ms[rawMs[j]]);
        }
      }
      var visConfigSelection = rawVisConfigSelection ?
        new epiviz.ui.controls.VisConfigSelection(chartMs, rawVisConfigSelection.datasource,
          rawVisConfigSelection.datasourceGroup, rawVisConfigSelection.dataprovider, rawVisConfigSelection.annotation,
          rawVisConfigSelection.defaultChartType, rawVisConfigSelection.minSelectedMeasurements, rawVisConfigSelection.customData) :
        new epiviz.ui.controls.VisConfigSelection(chartMs);
      var chartType = chartFactory.get(chartInfo.type);

      if (!chartType) { continue; }

      charts[t].push({
        id: chartInfo.id,
        type: chartType,
        properties: new epiviz.ui.charts.VisualizationProperties(
          chartInfo.properties.width,
          chartInfo.properties.height,
          epiviz.ui.charts.Margins.fromRawObject(chartInfo.properties.margins),
          visConfigSelection,
          epiviz.ui.charts.ColorPalette.fromRawObject(chartInfo.properties.colors, config),
          chartInfo.properties.modifiedMethods,
          chartInfo.properties.customSettings,
          chartType.customSettingsDefs(),
          chartInfo.properties.chartMarkers ?
            chartInfo.properties.chartMarkers.map(function(rawMarker) { return epiviz.ui.charts.markers.VisualizationMarker.fromRawObject(rawMarker); }) :
            []
        )
      });
    }
  }

  return new epiviz.workspaces.Workspace(o.id, o.name, {
    range: epiviz.datatypes.GenomicRange.fromRawObject(o.content.range),
    computedMeasurements: computedMeasurements,
    charts: charts
  });
};


/**
 * @returns {epiviz.events.Event.<epiviz.workspaces.Workspace>}
 */
epiviz.workspaces.Workspace.prototype.onContentChanged = function() { return this._contentChanged; };

// Input 115
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/15/14
 * Time: 5:01 PM
 */

goog.provide('epiviz.workspaces.UserManager');

/**
 * @param {epiviz.Config} config
 * @constructor
 */
epiviz.workspaces.UserManager = function(config) {
  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;
};

/**
 * @type {{loggedIn: boolean, name: ?string, oauthProvider: ?string}}
 */
epiviz.workspaces.UserManager.USER_STATUS = epiviz.workspaces.UserManager.USER_STATUS || {
  loggedIn: false,
  userData: null,
  oauthProvider: null
};

/**
 * Logs in if there is no user logged in or logs out the current user
 */
epiviz.workspaces.UserManager.prototype.toggleLogin = function() {
  if (!epiviz.workspaces.UserManager.USER_STATUS.loggedIn) {
    this._login();
  } else {
    this._logout();
  }
};

/**
 * Redirects to the login screen
 * @private
 */
epiviz.workspaces.UserManager.prototype._login = function() {
  var location = window.location.toString();
  if (location.length > 0) {
    location = encodeURIComponent(location);
  }

  var pathname = this._config.dataServerLocation + 'login.php';
  window.location = pathname + '?location=' + location;
};

/**
 * Logout
 * @private
 */
epiviz.workspaces.UserManager.prototype._logout = function() {
  var location = window.location.toString(); // window.location.search;
  if (location.length > 0) {
    // location = encodeURIComponent(location.substr(1));
    location = encodeURIComponent(location);
  }
  window.location = this._config.dataServerLocation + 'logout.php?logout&location=' + location;
};

// Input 116
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/19/2014
 * Time: 12:41 PM
 */

goog.provide('epiviz.ui.charts.tree.NodeSelectionType');

/**
 * @enum {number}
 */
epiviz.ui.charts.tree.NodeSelectionType = {
  NONE: 0,
  LEAVES: 1,
  NODE: 2
};

// Input 117
/**
 * Created by Florin Chelaru ( florin [dot] chelaru [at] gmail [dot] com )
 * Date: 7/3/2015
 * Time: 4:27 PM
 */

goog.provide('epiviz.data.EpivizApiDataProvider');
goog.provide('epiviz.data.EpivizApiDataProvider.Request');

goog.require('epiviz.data.DataProvider');
goog.require('epiviz.data.Response');
goog.require('epiviz.ui.charts.tree.NodeSelectionType');
goog.require('epiviz.utils');


/**
 * @param {string} id
 * @param {string} serverEndpoint
 * @param {Array.<string>} [measurementAnnotations]
 * @param {number} [maxDepth]
 * @param {Object.<number, number>} [selectedLevels]
 * @constructor
 * @extends epiviz.data.DataProvider
 */
epiviz.data.EpivizApiDataProvider = function(id, serverEndpoint, measurementAnnotations, maxDepth, selectedLevels) {
  epiviz.data.DataProvider.call(this, id);

  /**
   * @type {string}
   * @private
   */
  this._serverEndpoint = serverEndpoint;

  /**
   * @type {Array.<string>}
   * @private
   */
  this._measurementAnnotations = measurementAnnotations;

  /**
   * @type {Object.<string, epiviz.ui.charts.tree.NodeSelectionType>}
   * @private
   */
  this._selection = {};

  /**
   * @type {Object.<string, number>}
   * @private
   */
  this._order = {};

  /**
   * @type {Object.<number, number>}
   * @private
   */
  this._selectedLevels = selectedLevels || {6: epiviz.ui.charts.tree.NodeSelectionType.NODE, 7: epiviz.ui.charts.tree.NodeSelectionType.NODE};

  /**
   * @type {string}
   * @private
   */
  this._lastRoot = '';

  /**
   * @type {number}
   * @private
   */
  this._maxDepth = maxDepth || 2;
};

/**
 * Copy methods from upper class
 */
epiviz.data.EpivizApiDataProvider.prototype = epiviz.utils.mapCopy(epiviz.data.DataProvider.prototype);
epiviz.data.EpivizApiDataProvider.constructor = epiviz.data.EpivizApiDataProvider;

/**
 * @type {Object.<string, string>}
 */
epiviz.data.EpivizApiDataProvider.REQUEST_MAPPING = {
  getRows: 'rows',
  getValues: 'values',
  getMeasurements: 'measurements',
  getSeqInfos: 'partitions',
  getHierarchy: 'hierarchy'
};

/**
 * @param {epiviz.data.Request} request
 * @param {function(epiviz.data.Response.<*>)} callback
 */
epiviz.data.EpivizApiDataProvider.prototype.getData = function(request, callback) {
  if (request.isEmpty()) { return; }

  var self = this;
  var apiRequest = self._adaptRequest(request);
  this._send(apiRequest, function(apiData) {
    callback(self._adaptResponse(request, apiData));
  });
};

/**
 * @param {epiviz.data.EpivizApiDataProvider.Request} request
 * @param {function(epiviz.data.EpivizApiDataProvider.Response)} callback
 * @private
 */
epiviz.data.EpivizApiDataProvider.prototype._send = function(request, callback) {
  var requestHandler = $.ajax({
    type: 'post',
    url: this._serverEndpoint,
    data: request,
    dataType: 'json',
    async: true,
    cache: false,
    processData: true
  });

  // callback handler that will be called on success
  requestHandler.done(function (data, textStatus, jqXHR){
    callback(data);
  });

  // callback handler that will be called on failure
  requestHandler.fail(function (jqXHR, textStatus, errorThrown){
    console.error("The following error occured: " + textStatus, errorThrown);
  });

  // callback handler that will be called regardless
  // if the request failed or succeeded
  requestHandler.always(function () {});
};

/**
 * Adapts Epiviz requests to API requests
 * @param {epiviz.data.Request} request
 * @returns {epiviz.data.EpivizApiDataProvider.Request}
 * @private
 */
epiviz.data.EpivizApiDataProvider.prototype._adaptRequest = function(request) {
  var action = request.get('action');
  switch (action) {
    case epiviz.data.Request.Action.GET_MEASUREMENTS:
      var datasourceGroup = request.get('datasourceGroup') || this._id;
      return new epiviz.data.EpivizApiDataProvider.Request(request.id(), 'measurements', {datasource: datasourceGroup, annotation: JSON.stringify(this._measurementAnnotations)});
    case epiviz.data.Request.Action.GET_SEQINFOS:
      var datasourceGroup = request.get('datasourceGroup') || this._id;
      return new epiviz.data.EpivizApiDataProvider.Request(request.id(), 'partitions', {datasource: datasourceGroup});
    case epiviz.data.Request.Action.GET_ROWS:
      var start = request.get('start');
      var end = request.get('end');
      var partition = request.get('seqName');
      var datasourceGroup = request.get('datasourceGroup') || this._id;
      if (partition == '[NA]') { partition = ''; }
      return new epiviz.data.EpivizApiDataProvider.Request(request.id(), 'rows', {datasource: datasourceGroup, start: start, end: end, partition: JSON.stringify(partition), selection: JSON.stringify(this._selection), order: JSON.stringify(this._order), selectedLevels: JSON.stringify(this._selectedLevels)});
    case epiviz.data.Request.Action.GET_VALUES:
      var start = request.get('start');
      var end = request.get('end');
      var partition = request.get('seqName');
      var measurement = request.get('measurement');
      var datasourceGroup = request.get('datasourceGroup') || this._id;
      if (partition == '[NA]') { partition = ''; }
      return new epiviz.data.EpivizApiDataProvider.Request(request.id(), 'values', {datasource: datasourceGroup, start: start, end: end, partition: JSON.stringify(partition), measurement: JSON.stringify(measurement), selection: JSON.stringify(this._selection), order: JSON.stringify(this._order), selectedLevels: JSON.stringify(this._selectedLevels)});
    case epiviz.data.Request.Action.GET_COMBINED:
      var start = request.get('start');
      var end = request.get('end');
      var partition = request.get('seqName');
      var measurements = request.get('measurements')[this._id];
      var datasourceGroup = request.get('datasourceGroup') || this._id;
      if (partition == '[NA]') { partition = ''; }
      return new epiviz.data.EpivizApiDataProvider.Request(request.id(), 'combined', {datasource: datasourceGroup, start: start, end: end, partition: JSON.stringify(partition), measurements: JSON.stringify(measurements), selection: JSON.stringify(this._selection), order: JSON.stringify(this._order), selectedLevels: JSON.stringify(this._selectedLevels)});
    case epiviz.data.Request.Action.GET_HIERARCHY:
      var nodeId = request.get('nodeId') || '';
      var datasourceGroup = request.get('datasourceGroup') || this._id;
      this._lastRoot = nodeId;
      return new epiviz.data.EpivizApiDataProvider.Request(request.id(), 'hierarchy', {datasource: datasourceGroup, depth: this._maxDepth, nodeId: JSON.stringify(nodeId), selection: JSON.stringify(this._selection), order: JSON.stringify(this._order), selectedLevels: JSON.stringify(this._selectedLevels)});
    case epiviz.data.Request.Action.PROPAGATE_HIERARCHY_CHANGES:
      var datasourceGroup = request.get('datasourceGroup') || this._id;
      var order = request.get('order');
      var selection = request.get('selection');
      var selectedLevels = request.get('selectedLevels');

      if (selectedLevels) {
        var self = this;
        var deselectedNodeIds = [];
        $.each(this._selection, function(nodeId, selectionType) {
          var nodeDepth = self._calcNodeDepth(nodeId);
          var selectionForNodeLevel = selectedLevels[nodeDepth];
          var lastSelectionForNodeLevel = self._selectedLevels[nodeDepth];
          if (selectionForNodeLevel != undefined && selectionForNodeLevel != lastSelectionForNodeLevel) {
            deselectedNodeIds.push(nodeId);
          }
        });
        deselectedNodeIds.forEach(function(nodeId) { delete self._selection[nodeId]; });
      }

      if (selection) {
        for (var nodeId  in selection) {
          if (!selection.hasOwnProperty(nodeId)) { continue; }
          var selectionForNodeLevel = selectedLevels[self._calcNodeDepth(nodeId)];
          if (selectionForNodeLevel == undefined) { selectionForNodeLevel = epiviz.ui.charts.tree.NodeSelectionType.LEAVES; }
          // if (selection[nodeId] == epiviz.ui.charts.tree.NodeSelectionType.LEAVES) {
          if (selection[nodeId] == selectionForNodeLevel) {
            delete this._selection[nodeId];
            continue;
          }
          this._selection[nodeId] = selection[nodeId];
        }
      }

      if (order) {
        for (var nodeId in order) {
          if (!order.hasOwnProperty(nodeId)) { continue; }
          this._order[nodeId] = order[nodeId];
        }
      }

      if (selectedLevels) {
        if(Object.keys(selectedLevels).length > 0) {
          this._selectedLevels = selectedLevels;
        }
        // for (var level in selectedLevels) {
        //   if (!selectedLevels.hasOwnProperty(level)) { continue; }
        //   this._selectedLevels[level] = selectedLevels[level];
        //   if (this._selectedLevels[level] == epiviz.ui.charts.tree.NodeSelectionType.LEAVES) {
        //     delete this._selectedLevels[level];
        //   }
        // }
      }

      return new epiviz.data.EpivizApiDataProvider.Request(request.id(), 'hierarchy', {datasource: datasourceGroup, depth: this._maxDepth, nodeId: JSON.stringify(this._lastRoot), selection: JSON.stringify(this._selection), order: JSON.stringify(this._order), selectedLevels: JSON.stringify(this._selectedLevels)});
    case epiviz.data.Request.Action.SEARCH:
      var datasourceGroup = request.get('datasourceGroup') || this._id;
      var maxResults = request.get('maxResults');
      var q = request.get('q');
      return new epiviz.data.EpivizApiDataProvider.Request(request.id(), 'search', {datasource: datasourceGroup, maxResults: maxResults, q: q});
    case epiviz.data.Request.Action.GET_PCA:
      var measurements = request.get('measurements')[this._id];
      var datasourceGroup = request.get('datasourceGroup') || this._id;
      return new epiviz.data.EpivizApiDataProvider.Request(request.id(), 'pca', {datasource: datasourceGroup, measurements: JSON.stringify(measurements), selectedLevels: JSON.stringify(this._selectedLevels)});
    case epiviz.data.Request.Action.GET_DIVERSITY:
      var measurements = request.get('measurements')[this._id];
      var datasourceGroup = request.get('datasourceGroup') || this._id;
      return new epiviz.data.EpivizApiDataProvider.Request(request.id(), 'diversity', {datasource: datasourceGroup, measurements: JSON.stringify(measurements), selectedLevels: JSON.stringify(this._selectedLevels)});
  }
};

/**
 * @param {epiviz.data.Request} request
 * @param {epiviz.data.EpivizApiDataProvider.Response} data
 * @returns {epiviz.data.Response}
 * @private
 */
epiviz.data.EpivizApiDataProvider.prototype._adaptResponse = function(request, data) {
  var result = data.result;
  var action = request.get('action');
  switch (action) {
    case epiviz.data.Request.Action.GET_MEASUREMENTS:
      break;
    case epiviz.data.Request.Action.GET_SEQINFOS:
      result = result.map(function(tuple) { return tuple[0] == null ? ['[NA]'].concat(tuple.slice(1)) : tuple; });
      break;
    case epiviz.data.Request.Action.GET_ROWS:
      result.values.id = result.values.index;
      delete result.values.index;
      if (result.values.end) {
        // On the API, the resulted values are start inclusive, end exclusive
        result.values.end = result.values.end.map(function(val) { return val - 1; });
      }
      break;
    case epiviz.data.Request.Action.GET_VALUES:
      break;
    case epiviz.data.Request.Action.GET_COMBINED:
      result.rows.id = result.rows.index;
      delete result.rows.index;
      if (result.rows.end) {
        // On the API, the resulted values are start inclusive, end exclusive
        result.rows.end = result.rows.end.map(function(val) { return val - 1; });
      }

      var datasource = Object.keys(request.get('measurements'))[0];
      var ret = {};
      ret[datasource] = result;
      result = ret;
      break;
    case epiviz.data.Request.Action.GET_HIERARCHY:
      break;
    case epiviz.data.Request.Action.PROPAGATE_HIERARCHY_CHANGES:
      break;
    case epiviz.data.Request.Action.SEARCH:
      var resp = {};
      resp['nodes'] = result;
      result = resp;
      break;
    case epiviz.data.Request.Action.GET_PCA:
      break;
    case epiviz.data.Request.Action.GET_DIVERSITY:
      break;
  }
  return epiviz.data.Response.fromRawObject({
    requestId: request.id(),
    data: result
  });
};

/**
 * @param {string} nodeId
 * @returns {Number}
 * @private
 */
epiviz.data.EpivizApiDataProvider.prototype._calcNodeDepth = function(nodeId) {
  return parseInt(nodeId.split('-')[0], 16);
};

/**
 * @param {string|number} id
 * @param {string} method
 * @param {Array|Object.<string, *>} [params]
 * @constructor
 */
epiviz.data.EpivizApiDataProvider.Request = function(id, method, params) {
  /**
   * @type {string|number}
   */
  this.id = id;
  /**
   * @type {string}
   */
  this.method = method;

  /**
   * @type {Array|Object.<string, *>}
   */
  this.params = params;
};

/**
 * @param {string} id
 * @param {string} error
 * @param {*} result
 * @constructor
 */
epiviz.data.EpivizApiDataProvider.Response = function(id, error, result) {
  /**
   * @type {string}
   */
  this.id = id;

  /**
   * @type {string}
   */
  this.error = error;

  this.result = result;
};

// goog.inherits(epiviz.data.EpivizApiDataProvider, epiviz.data.DataProvider);
// Input 118
/**
 * Created by: Florin Chelaru
 * Date: 10/1/13
 * Time: 1:22 PM
 */

goog.provide('epiviz.data.WebsocketDataProvider');

goog.require('epiviz.Config');
goog.require('epiviz.utils');
goog.require('epiviz.data.DataProvider');
goog.require('epiviz.data.Response');
goog.require('epiviz.ui.WebArgsManager');
goog.require('epiviz.data.MessageType');
goog.require('epiviz.data.Request');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.measurements.MeasurementSet');
goog.require('epiviz.ui.controls.VisConfigSelection');
goog.require('epiviz.events.EventResult');
goog.require('epiviz.datatypes.GenomicRange');
goog.require('epiviz.ui.charts.ColorPalette');

/**
 * @param {?string} [id]
 * @param {string} websocketHost
 * @constructor
 * @extends {epiviz.data.DataProvider}
 */
epiviz.data.WebsocketDataProvider = function (id, websocketHost) {
  epiviz.data.DataProvider.call(this, id || epiviz.data.WebsocketDataProvider.DEFAULT_ID);

  /**
   * @type {string}
   * @private
   */
  this._websocketHost = websocketHost;

  /**
   * @type {?WebSocket}
   * @private
   */
  this._socket = null;

  /**
   * Variable used for testing. If this is set to false, then
   * events triggered by instances of this class should have no
   * UI effect
   * @type {boolean}
   * @private
   */
  this._useUI = (epiviz.ui.WebArgsManager.WEB_ARGS['websocketNoUI'] != 'true');

  /**
   * Used for testing
   * @type {boolean}
   * @private
   */
  this._debug = (epiviz.ui.WebArgsManager.WEB_ARGS['debug'] == 'true');

  /**
   * Callbacks hashtable, mapping request ids to their corresponding callbacks
   * @type {Object.<string, function>}
   * @private
   */
  this._callbacks = {};

  /**
   * Stores messages as a stack until the socket is actually open
   * @type {Array.<string>}
   * @private
   */
  this._requestsStack = [];

  this._initialize();
};

/**
 * Copy methods from upper class
 */
epiviz.data.WebsocketDataProvider.prototype = epiviz.utils.mapCopy(epiviz.data.DataProvider.prototype);
epiviz.data.WebsocketDataProvider.constructor = epiviz.data.WebsocketDataProvider;

epiviz.data.WebsocketDataProvider.DEFAULT_ID = 'websocket';

/**
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._initialize = function () {
  if (!this._websocketHost || this._websocketHost == 'None') { return; }

  try {
    this._socket = new WebSocket(this._websocketHost);
    this._log('WebSocket - status ' + this._socket.readyState);
    var self = this;
    this._socket.onopen = function () { self._onSocketOpen(); };
    this._socket.onmessage = function (msg) { self._onSocketMessage(msg); };
    this._socket.onclose = function () { self._onSocketClose(); };
  } catch (error) {
    this._log(error.toString());
    // TODO: Throw some error to be caught up in epiviz.js
  }
};

/**
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._onSocketOpen = function () {
  // Send the requests that were made before the socked was fully open.
  // Those are stored in this._requestStack
  for (var i = 0; i < this._requestsStack.length; ++i) {
    this._socket.send(this._requestsStack[i]);
  }

  this._requestsStack = [];

  this._registerAvailableCharts();
};


/**
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._onSocketClose = function () {
  this._socket = null;
};

/**
 * @param {string} message
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._sendMessage = function (message) {
  if (this.connected() && this._socket.readyState) {
    this._socket.send(message);
  } else {
    this._requestsStack.push(message);
  }
};

/**
 * @param {{data: string}} msg
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._onSocketMessage = function (msg) {
  this._log('Local Controller Received: ' + msg.data);

  /**
   * @type {{requestId: number, type: string, data: *}}
   */
  var message = JSON.parse(msg.data);
  message.data.dataprovidertype = "websocket";
  if (message['type'] == epiviz.data.MessageType.RESPONSE) {
    var response = epiviz.data.Response.fromRawObject(message);
    var callback = this._callbacks[response.id()];
    delete this._callbacks[response.id()];
    callback(response);
  } else if (message['type'] == epiviz.data.MessageType.REQUEST) {
    var Action = epiviz.data.Request.Action;
    var request = epiviz.data.Request.fromRawObject(message);

    switch (request.get('action')) {
      case Action.ADD_MEASUREMENTS:
        this._addMeasurements(request);
        break;
      case Action.REMOVE_MEASUREMENTS:
        this._removeMeasurements(request);
        break;
      case Action.ADD_SEQINFOS:
        this._addSeqInfos(request);
        break;
      case Action.REMOVE_SEQNAMES:
        this._removeSeqNames(request);
        break;
      case Action.ADD_CHART:
        this._addChart(request);
        break;
      case Action.REMOVE_CHART:
        this._removeChart(request);
        break;
      case Action.CLEAR_DATASOURCE_GROUP_CACHE:
        this._clearDatasourceGroupCache(request);
        break;
      case Action.FLUSH_CACHE:
        this._flushCache(request);
        break;
      case Action.NAVIGATE:
        this._navigate(request);
        break;
      case Action.REDRAW:
        this._redraw(request);
        break;
      case Action.GET_CURRENT_LOCATION:
        this._getCurrentLocation(request);
        break;
      case Action.WRITE_DEBUG_MSG: 
        this._writeDebugMsg(request);
        break;
      case Action.PRINT_WORKSPACE:
        this._printWorkspace(request);
        break;
      case Action.SET_CHART_SETTINGS:
        this._setChartSettings(request);
        break;
      case Action.GET_CHART_SETTINGS:
        this._getChartSettings(request);
        break;
      case Action.GET_AVAILABLE_CHARTS:
        this._getAvailableCharts(request);
        break;
      case Action.LOAD_WORKSPACE:
        this._loadWorkspace(request);
        break;
    }
  }
};

/**
 * @param {string} message
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._log = function(message) {
  if (this._debug) { console.log(message); }
};

/**
 * @param {epiviz.events.Event.<{result: epiviz.events.EventResult<*>}>} event
 * @param {{result: epiviz.events.EventResult<*>}} args
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._fireEvent = function(event, args) {
  if (!this._useUI) {
    args.result.success = true;
    return;
  }

  event.notify(args);
};

/**
 * @returns {boolean}
 */
epiviz.data.WebsocketDataProvider.prototype.connected = function () {
  return (this._socket != null);
};

/**
 * @param {epiviz.data.Request} request
 * @param {function(epiviz.data.Response)} callback
 * @override
 */
epiviz.data.WebsocketDataProvider.prototype.getData = function (request, callback) {
  var message = JSON.stringify(request.raw());
  this._callbacks[request.id()] = callback;

  this._sendMessage(message);
};

// This is the interface to the websocket

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._addMeasurements = function (request) {
  var result = new epiviz.events.EventResult();
  var measurements = new epiviz.measurements.MeasurementSet();

  /**
   * @type {Array.<{
   *   id: string,
   *   name: string,
   *   type: string,
   *   datasourceId: string,
   *   datasourceGroup: string,
   *   defaultChartType: ?string,
   *   annotation: ?Object.<string, string>,
   *   minValue: ?number,
   *   maxValue: ?number,
   *   metadata: ?Array.<string>}>}
   */
  var rawMeasurements = JSON.parse(request.get('measurements'));
  for (var i = 0; i < rawMeasurements.length; ++i) {
    measurements.add(new epiviz.measurements.Measurement(
      rawMeasurements[i]['id'],
      rawMeasurements[i]['name'],
      rawMeasurements[i]['type'],
      rawMeasurements[i]['datasourceId'],
      rawMeasurements[i]['datasourceGroup'],
      this.id(),
      null,
      rawMeasurements[i]['defaultChartType'],
      rawMeasurements[i]['annotation'],
      rawMeasurements[i]['minValue'],
      rawMeasurements[i]['maxValue'],
      rawMeasurements[i]['metadata']
    ));
  }

  this._fireEvent(this.onRequestAddMeasurements(), {measurements: measurements, result: result});

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._removeMeasurements = function (request) {
  var result = new epiviz.events.EventResult();
  var measurements = new epiviz.measurements.MeasurementSet();

  /**
   * @type {Array.<{
   *   id: string,
   *   name: string,
   *   type: string,
   *   datasourceId: string,
   *   datasourceGroup: string,
   *   defaultChartType: ?string,
   *   annotation: ?Object.<string, string>,
   *   minValue: ?number,
   *   maxValue: ?number,
   *   metadata: ?Array.<string>}>}
   */
  var rawMeasurements = JSON.parse(request.get('measurements'));
  for (var i = 0; i < rawMeasurements.length; ++i) {
    measurements.add(new epiviz.measurements.Measurement(
      rawMeasurements[i]['id'],
      rawMeasurements[i]['name'],
      rawMeasurements[i]['type'],
      rawMeasurements[i]['datasourceId'],
      rawMeasurements[i]['datasourceGroup'],
      this.id(),
      null,
      rawMeasurements[i]['defaultChartType'],
      rawMeasurements[i]['annotation'],
      rawMeasurements[i]['minValue'],
      rawMeasurements[i]['maxValue'],
      rawMeasurements[i]['metadata']
    ));
  }
  this._fireEvent(this.onRequestRemoveMeasurements(), {measurements: measurements, result: result});

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._addSeqInfos = function (request) {
  var result = new epiviz.events.EventResult();

  /**
   * @type {Array.<Array>}
   */
  var seqInfos = JSON.parse(request.get('seqInfos'));

  this._fireEvent(this.onRequestAddSeqInfos(), {seqInfos: seqInfos, result: result});

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._removeSeqNames = function (request) {
  var result = new epiviz.events.EventResult();

  /**
   * @type {Array.<string>}
   */
  var seqNames = JSON.parse(request.get('seqNames'));

  this._fireEvent(this.onRequestRemoveSeqNames(), {seqNames: seqNames, result: result});

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._addChart = function (request) {
  /** @type {epiviz.events.EventResult.<{id: string}>} */
  var result = new epiviz.events.EventResult();

  var measurements, datasource, datasourceGroup;

  if (request.get('measurements') != undefined) {
    measurements = new epiviz.measurements.MeasurementSet();

    /**
     * @type {Array.<{
     *   id: string,
     *   name: string,
     *   type: string,
     *   datasourceId: string,
     *   datasourceGroup: string,
     *   defaultChartType: ?string,
     *   annotation: ?Object.<string, string>,
     *   minValue: ?number,
     *   maxValue: ?number,
     *   metadata: ?Array.<string>}>}
     */
    var rawMeasurements = JSON.parse(request.get('measurements'));
    for (var i = 0; i < rawMeasurements.length; ++i) {
      measurements.add(new epiviz.measurements.Measurement(
        rawMeasurements[i]['id'],
        rawMeasurements[i]['name'],
        rawMeasurements[i]['type'],
        rawMeasurements[i]['datasourceId'],
        rawMeasurements[i]['datasourceGroup'],
        this.id(),
        null,
        rawMeasurements[i]['defaultChartType'],
        rawMeasurements[i]['annotation'],
        rawMeasurements[i]['minValue'],
        rawMeasurements[i]['maxValue'],
        rawMeasurements[i]['metadata']
      ));
    }
  }

  datasource = request.get('datasource');
  datasourceGroup = request.get('datasourceGroup') || datasource;

  this._fireEvent(this.onRequestAddChart(), {
    type: request.get('type'),
    visConfigSelection: new epiviz.ui.controls.VisConfigSelection(measurements, datasource, datasourceGroup),
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._removeChart = function (request) {
  var chartId = request.get('chartId');
  var result = new epiviz.events.EventResult();

  this._fireEvent(this.onRequestRemoveChart(), {
    id: chartId,
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._clearDatasourceGroupCache = function (request) {
  var result = new epiviz.events.EventResult();

  this._fireEvent(this.onRequestClearDatasourceGroupCache(), {
    datasourceGroup: request.get('datasourceGroup'),
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._flushCache = function (request) {
  var result = new epiviz.events.EventResult();
  this._fireEvent(this.onRequestFlushCache(), {
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._navigate = function (request) {
  /**
   * @type {{seqName: string, start: number, end: number}}
   */
  var range = JSON.parse(request.get('range'));
  var result = new epiviz.events.EventResult();

  this._fireEvent(this.onRequestNavigate(), {
    range: epiviz.datatypes.GenomicRange.fromStartEnd(range.seqName, range.start, range.end),
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._redraw = function (request) {
  var result = new epiviz.events.EventResult();
  this._fireEvent(this.onRequestRedraw(), {
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._getCurrentLocation = function(request) {
  var result = new epiviz.events.EventResult();
  this._fireEvent(this.onRequestCurrentLocation(), {
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._writeDebugMsg = function(request) {
    var msg = request.get('msg');
    var msgDiv = document.createElement("pre");
    msgDiv.innerHTML = msg.replace(/&/g, "&amp;").replace(/\\</g,"&lt;");
    var response = new epiviz.data.Response(request.id(), {msg: "that msg"});
    document.getElementById("chart-container").appendChild(msgDiv);
    this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._printWorkspace = function (request) {
  var contrId = request.get('chartId');
  var fName = request.get('fileName');
  var fType = request.get('fileType');
  var result = new epiviz.events.EventResult();
  this._fireEvent(this.onRequestPrintWorkspace(), {
    chartId: contrId,
    fileName: fName,
    fileType: fType,
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._setChartSettings = function (request) {
  var chartId = request.get('chartId');
  var settings = request.get('settings');
  var colorMap = request.get('colorMap');

  var colors = new epiviz.ui.charts.ColorPalette(colorMap);
  var result = new epiviz.events.EventResult();

  this._fireEvent(this.onRequestSetChartSettings(), {
    chartId: chartId,
    settings: settings,
    colorMap: colors,
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._getChartSettings = function (request) {
  var chartId = request.get('chartId');
  var result = new epiviz.events.EventResult();

  this._fireEvent(this.onRequestGetChartSettings(), {
    chartId: chartId,
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._getAvailableCharts = function (request) {
  var result = new epiviz.events.EventResult();

  this._fireEvent(this.onRequestGetChartSettings(), {
    result: result
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};


/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._registerAvailableCharts = function () {
  var result = new epiviz.events.EventResult();

  this._fireEvent(this.onRequestGetChartSettings(), {
    result: result
  });

  request = epiviz.data.Request.createRequest({
    action: epiviz.data.Request.Action.REGISTER_CHART_TYPES,
    data: result.value
  });

  var message = JSON.stringify(request.raw());

  this._callbacks[request.id()] = function (resp) {
    //do nothing
  };

  this._sendMessage(message);
};

/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype.updateChartSettings = function (request, callback) {
  var message = JSON.stringify(request.raw());
  this._callbacks[request.id()] = callback;
  this._sendMessage(message);
};


/**
 * @param {epiviz.data.Request} request
 * @private
 */
epiviz.data.WebsocketDataProvider.prototype._loadWorkspace = function (request) {
  var workspaceId = request.get('workspaceId');
  var result = new epiviz.events.EventResult();
  this._fireEvent(this.onRequestLoadWorkspace(), {
    workspace: workspaceId
  });

  var response = new epiviz.data.Response(request.id(), result);
  this._sendMessage(JSON.stringify(response.raw()));
};

// goog.inherits(epiviz.data.WebsocketDataProvider, epiviz.data.DataProvider);
// Input 119
/**
 * Created by: Florin Chelaru
 * Date: 10/2/13
 * Time: 11:20 AM
 */

goog.provide('epiviz.data.WebServerDataProvider');

goog.require('epiviz.Config');
goog.require('epiviz.utils');
goog.require('epiviz.data.DataProvider');
goog.require('epiviz.data.Response');

/**
 * @param {string} [id]
 * @param {string} [serverEndpoint]
 * @constructor
 * @extends epiviz.data.DataProvider
 */
epiviz.data.WebServerDataProvider = function(id, serverEndpoint) {
  epiviz.data.DataProvider.call(this, id || epiviz.Config.DEFAULT_DATA_PROVIDER_ID);

  /**
   * @type {string}
   * @private
   */
  this._serverEndpoint = serverEndpoint || epiviz.data.WebServerDataProvider.DEFAULT_SERVER_ENDPOINT;
};

/**
 * Copy methods from upper class
 */
epiviz.data.WebServerDataProvider.prototype = epiviz.utils.mapCopy(epiviz.data.DataProvider.prototype);
epiviz.data.WebServerDataProvider.constructor = epiviz.data.WebServerDataProvider;

/**
 * @constant
 * @type {string}
 */
epiviz.data.WebServerDataProvider.DEFAULT_SERVER_ENDPOINT = 'data/main.php';

/**
 * @param {epiviz.data.Request} request
 * @param {function(epiviz.data.Response.<*>)} callback
 */
epiviz.data.WebServerDataProvider.prototype.getData = function(request, callback) {
  if (request.isEmpty()) { return; }

  if (request.method() == epiviz.data.Request.Method.GET) {
    var query = sprintf('%s?%s', this._serverEndpoint, request.joinArgs());

    epiviz.data.WebServerDataProvider.makeGetRequest(query, function(jsondata) {
      callback(epiviz.data.Response.fromRawObject(jsondata));
    });
  } else {
    epiviz.data.WebServerDataProvider.makePostRequest(this._serverEndpoint, request.joinArgs(), function(jsondata) {
      callback(epiviz.data.Response.fromRawObject(jsondata));
    });
  }
};

/**
 *
 * @param query
 * @param callback
 */
epiviz.data.WebServerDataProvider.makeGetRequest = function(query, callback) {
  var request = $.ajax({
    type: "get",
    url: query,
    dataType: "json",
    async: true,
    cache: false,
    processData: true
  });

  // callback handler that will be called on success
  request.done(function (jsonData){
    callback(jsonData);
  });

  // callback handler that will be called on failure
  request.fail(function (jqXHR, textStatus, errorThrown){
    //console.error("The following error occured: " + textStatus, errorThrown);
  });

  // callback handler that will be called regardless
  // if the request failed or succeeded
  request.always(function () {});
};

/**
 * @param {string} query
 * @param {Object} postData
 * @param {function} callback
 */
epiviz.data.WebServerDataProvider.makePostRequest = function(query, postData, callback) {
  var request = $.ajax({
    type: "post",
    url: query,
    data: postData,
    dataType: "json",
    async: true,
    cache: false,
    processData: true
  });

  // callback handler that will be called on success
  request.done(function (data, textStatus, jqXHR){
    callback(data);
  });

  // callback handler that will be called on failure
  request.fail(function (jqXHR, textStatus, errorThrown){
    console.error("The following error occured: " + textStatus, errorThrown);
  });

  // callback handler that will be called regardless
  // if the request failed or succeeded
  request.always(function () {});
};

// goog.inherits(epiviz.data.WebServerDataProvider, epiviz.data.DataProvider);
// Input 120
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/5/13
 * Time: 9:51 AM
 */

goog.provide('epiviz.data.RequestStack');

/**
 * @constructor
 */
epiviz.data.RequestStack = function() {
  /**
   * An array of requests, in the order they are made
   * @type {Array.<epiviz.data.Request>}
   * @private
   */
  this._requests = [];

  /**
   * Map of callbacks stored by request id
   * @type {Object.<number, function(*)>}
   * @private
   */
  this._callbacks = {};

  /**
   * Map of responses stored by request id
   * @type {Object.<number, *>}
   * @private
   */
  this._dataMap = {};
};

/**
 * @param {epiviz.data.Request} request
 * @param {function(*)} callback
 */
epiviz.data.RequestStack.prototype.pushRequest = function(request, callback) {
  this._requests.push(request);
  this._callbacks[request.id()] = callback;
};

/**
 * Correlates the response to a particular request; the callback corresponding to that
 * request will be called when all requests that were made before this one have been
 * served.
 *
 * @param {epiviz.data.Response<*>} response
 */
epiviz.data.RequestStack.prototype.serveData = function(response) {

  if (!this._callbacks[response.id()]) {
    return;
  }

  // Check if this request is the first request in the stack. If it is,
  // pop it. Otherwise, we'll wait, so that we execute everything in the
  // same order as it was requested.
  if (this._requests.length > 0 && this._requests[0].id() == response.id()) {
    var callback = this._callbacks[response.id()];
    delete this._callbacks[response.id()];
    this._requests = this._requests.slice(1);
    callback(response.data());

    // Serve all other responses that have already come back, and are immediately after this one
    while (this._requests.length > 0 && (this._requests[0].id() in this._dataMap)) {
      callback = this._callbacks[this._requests[0].id()];
      var data = this._dataMap[this._requests[0].id()];
      delete this._callbacks[this._requests[0].id()];
      delete this._dataMap[this._requests[0].id()];
      this._requests = this._requests.slice(1);

      // It is important we call the callback after we've already changed the stack,
      // because the callback may query the stack again
      callback(data);
    }

    return;
  }

  // If unable to serve data, then store it for later
  this._dataMap[response.id()] = response.data();
};

/**
 * Clears the entire request stack
 */
epiviz.data.RequestStack.prototype.clear = function() {
  this._requests = [];
  this._callbacks = {};
  this._dataMap = {};
};


// Input 121
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/22/14
 * Time: 12:58 PM
 */

goog.provide('epiviz.data.EmptyResponseDataProvider');

goog.require('epiviz.data.DataProvider');
goog.require('epiviz.data.Response');

/**
 * @constructor
 * @extends {epiviz.data.DataProvider}
 */
epiviz.data.EmptyResponseDataProvider = function () {
  epiviz.data.DataProvider.call(this, epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);
};

/**
 * Copy methods from upper class
 */
epiviz.data.EmptyResponseDataProvider.prototype = epiviz.utils.mapCopy(epiviz.data.DataProvider.prototype);
epiviz.data.EmptyResponseDataProvider.constructor = epiviz.data.EmptyResponseDataProvider;

epiviz.data.EmptyResponseDataProvider.DEFAULT_ID = 'empty';

/**
 * @param {epiviz.data.Request} request
 * @param {function(epiviz.data.Response)} callback
 * @override
 */
epiviz.data.EmptyResponseDataProvider.prototype.getData = function (request, callback) {
  var requestId = request.id();
  var action = request.get('action');

  switch (action) {
    case epiviz.data.Request.Action.GET_ROWS:
      callback(epiviz.data.Response.fromRawObject({
        data: {
          values: { id: null, start: [], end:[], strand: [], metadata:{my_metadata:[]} },
          globalStartIndex: null,
          useOffset: false
        },
        requestId: requestId
      }));
      return;

    case epiviz.data.Request.Action.GET_VALUES:
      callback(epiviz.data.Response.fromRawObject({
        data: { values: [], globalStartIndex: null },
        requestId: requestId
      }));
      return;

    case epiviz.data.Request.Action.GET_MEASUREMENTS:
      callback(epiviz.data.Response.fromRawObject({
        requestId: request.id(),
        data: { id: [], name: [], type: [], datasourceId: [], datasourceGroup: [], defaultChartType: [], annotation: [], minValue: [], maxValue: [], metadata: [] }
      }));
      return;

    case epiviz.data.Request.Action.GET_SEQINFOS:
      callback(epiviz.data.Response.fromRawObject({
        requestId: request.id(),
        data: []
      }));
      return;

    case epiviz.data.Request.Action.SEARCH:
      callback(epiviz.data.Response.fromRawObject({
        requestId: request.id(),
        data: []
      }));
      return;

    case epiviz.data.Request.Action.SAVE_WORKSPACE:
      callback(epiviz.data.Response.fromRawObject({
	  requestId: request.id(),
	  data: []
    }));
    return;  

    case epiviz.data.Request.Action.DELETE_WORKSPACE:
      callback(epiviz.data.Response.fromRawObject({
	  requestId: request.id(),
	  data: []
    }));
    return;
  
    case epiviz.data.Request.Action.GET_WORKSPACES:
      callback(epiviz.data.Response.fromRawObject({
	  requestId: request.id(),
	  data: []
    }));
    return;

    default:
      epiviz.data.DataProvider.prototype.getData.call(this, request, callback);
      break;
  }
};

// goog.inherits(epiviz.data.EmptyResponseDataProvider, epiviz.data.DataProvider);
// Input 122
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 8:28 PM
 */

goog.provide('epiviz.data.DataProvider');

goog.require('epiviz.events.Event');
goog.require('epiviz.data.Response');

/**
 * @param {string} id
 * @constructor
 */
epiviz.data.DataProvider = function(id) {
  /**
   * @type {string}
   * @private
   */
  this._id = id;

  /**
   * seqInfos: an array of raw seqInfos, which consist of 3-element arrays: name, min and max
   * @type {epiviz.events.Event.<{seqInfos: Array.<Array>, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestAddSeqInfos = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{seqNames: Array.<string>, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRemoveSeqNames = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestAddMeasurements = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRemoveMeasurements = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{type: string, visConfigSelection: epiviz.ui.controls.VisConfigSelection, result: epiviz.events.EventResult.<{id: string}>}>}
   * @private
   */
  this._requestAddChart = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRemoveChart = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestFlushCache = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{datasourceGroup: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestClearDatasourceGroupCache = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{range: epiviz.datatypes.GenomicRange, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestNavigate = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRedraw = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestCurrentLocation = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestPrintWorkspace = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestSetChartSettings = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestGetChartSettings = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestGetAvailableCharts = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestLoadWorkspace = new epiviz.events.Event();

};

/**
 * @returns {string}
 */
epiviz.data.DataProvider.prototype.id = function() { return this._id; };

/**
 * @param {epiviz.data.Request} request
 * @param {function(epiviz.data.Response<*>)} callback
 */
epiviz.data.DataProvider.prototype.getData = function(request, callback) {
  callback(epiviz.data.Response.fromRawObject({
    requestId: request.id(),
    data: null
  }));
};

/**
 * seqInfos: an array of raw seqInfos, which consist of 3-element arrays: name, min and max
 * @returns {epiviz.events.Event.<{seqInfos: Array.<Array>, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestAddSeqInfos = function() { return this._requestAddSeqInfos; };

/**
 * @returns {epiviz.events.Event.<{seqNames: Array.<string>, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestRemoveSeqNames = function() { return this._requestRemoveSeqNames; };

/**
 * Fired whenever the data provider requests the UI to add new measurements
 * @returns {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestAddMeasurements = function() { return this._requestAddMeasurements; };

/**
 * Fired whenever the data provider requests the UI to remove measurements
 * @returns {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestRemoveMeasurements = function() { return this._requestRemoveMeasurements; };

/**
 * The type argument is a string denoting the complete class name of the chart to be used.
 * For example: 'epiviz.plugins.charts.BlocksTrack'.
 * @returns {epiviz.events.Event.<{type: string, visConfigSelection: epiviz.ui.controls.VisConfigSelection, result: epiviz.events.EventResult.<{id: string}>}>}
 */
epiviz.data.DataProvider.prototype.onRequestAddChart = function() { return this._requestAddChart; };

/**
 * @returns {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestRemoveChart = function() { return this._requestRemoveChart; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestFlushCache = function() { return this._requestFlushCache; };

/**
 * @returns {epiviz.events.Event.<{datasourceGroup: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestClearDatasourceGroupCache = function() { return this._requestClearDatasourceGroupCache; };

/**
 * @returns {epiviz.events.Event.<{range: epiviz.datatypes.GenomicRange, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestNavigate = function() { return this._requestNavigate; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestRedraw = function() { return this._requestRedraw; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestCurrentLocation = function() { return this._requestCurrentLocation; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestPrintWorkspace = function() { return this._requestPrintWorkspace; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestGetChartSettings = function() { return this._requestGetChartSettings; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestSetChartSettings = function() { return this._requestSetChartSettings; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestGetAvailableCharts = function() { return this._requestGetAvailableCharts; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataProvider.prototype.onRequestLoadWorkspace = function() { return this._requestLoadWorkspace; };

// Input 123
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/29/13
 * Time: 12:49 PM
 */

goog.provide('epiviz.data.Cache');

goog.require('epiviz.data.RequestStack');
goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.datatypes.MeasurementGenomicDataArrayWrapper');
goog.require('epiviz.datatypes.MapGenomicData');
goog.require('epiviz.measurements.MeasurementSet');

/**
 * @param {epiviz.Config} config
 * @param {epiviz.data.DataProviderFactory} dataProviderFactory
 * @constructor
 */
epiviz.data.Cache = function(config, dataProviderFactory) {

  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {epiviz.data.DataProviderFactory}
   * @private
   */
  this._dataProviderFactory = dataProviderFactory;

  /**
   * @type {Object.<string, epiviz.datatypes.PartialSummarizedExperiment>}
   * @private
   */
  this._data = {};

  /**
   * @type {epiviz.measurements.MeasurementHashtable.<epiviz.data.RequestStack>}
   * @private
   */
  this._measurementRequestStackMap = new epiviz.measurements.MeasurementHashtable();

  /**
   * measurement -> (requestId -> range)
   * @type {epiviz.measurements.MeasurementHashtable.<Object.<number, epiviz.datatypes.GenomicRange>>}
   * @private
   */
  this._measurementPendingRequestsMap = new epiviz.measurements.MeasurementHashtable();

  /**
   * @type {epiviz.datatypes.GenomicRange}
   * @private
   */
  this._lastRequest = null;

  if (this._config.cacheUpdateIntervalMilliseconds > 0) {
    var self = this;
    this._intervalId = window.setTimeout(function() {
      self._clearUnneededData();
    }, config.cacheUpdateIntervalMilliseconds);
  }
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {function(string, epiviz.datatypes.GenomicData)} dataReadyCallback
 */
epiviz.data.Cache.prototype.getData = function(range, chartMeasurementsMap, dataReadyCallback) {
  var MeasurementType = epiviz.measurements.Measurement.Type;

  var self = this;

  this._lastRequest = epiviz.datatypes.GenomicRange.fromStartEnd(
    range.seqName(),
    range.start() - range.width(),
    range.end() + range.width());

  if (this._config.cacheUpdateIntervalMilliseconds > 0) {
    window.clearInterval(this._intervalId);
    this._intervalId = window.setTimeout(function() {
      self._clearUnneededData();
    }, this._config.cacheUpdateIntervalMilliseconds);
  }

  var computedMs = this._extractComputedMeasurements(chartMeasurementsMap);

  this._updateComputedMeasurementsData(computedMs);
  this._serveAvailableData(range, chartMeasurementsMap, dataReadyCallback);

  var requestRanges = [
    range,
    epiviz.datatypes.GenomicRange.fromStartEnd(range.seqName(), Math.max(range.start() - range.width(), 0), range.start()),
    new epiviz.datatypes.GenomicRange(range.seqName(), range.end(), range.width())
  ];

  /**
   * A map of measurements as keys and for each of them, an array of ranges needed
   * @type {epiviz.measurements.MeasurementHashtable.<Array.<epiviz.datatypes.GenomicRange>>}
   */
  var msNeededRanges = this._calcMeasurementNeededRanges(requestRanges, chartMeasurementsMap);

  msNeededRanges.foreach(function(m, ranges) {
    var requestStack = self._measurementRequestStackMap.get(m);
    if (!requestStack) {
      requestStack = new epiviz.data.RequestStack();
      self._measurementRequestStackMap.put(m, requestStack);
    }
    var request;

    if (ranges.length == 0) {
      request = epiviz.data.Request.emptyRequest();
      requestStack.pushRequest(request, function() {
        self._handleResponse(dataReadyCallback, range, chartMeasurementsMap, request, null, m, null);
      });

      // When the pending requests for this measurements come back, this will also pop out
      requestStack.serveData(new epiviz.data.Response(request.id(), {}));
      return; // continue iteration
    }

    for (var i = 0; i < ranges.length; ++i) {
      request = m.type() == MeasurementType.RANGE ?
        epiviz.data.Request.getRows(m, ranges[i]) :
        epiviz.data.Request.getValues(m, ranges[i]);
      (function(r, request) {
        requestStack.pushRequest(request,
          /** @param {{globalStartIndex: number, values: *, useOffset: ?boolean}} data */
          function(data) {
            self._handleResponse(dataReadyCallback, range, chartMeasurementsMap, request, r, m, data);
          });
      })(ranges[i], request);

      var pendingRequests = self._measurementPendingRequestsMap.get(m);
      if (!pendingRequests) {
        pendingRequests = {};
        self._measurementPendingRequestsMap.put(m, pendingRequests);
      }
      pendingRequests[request.id()] = ranges[i];

      var dataProvider = self._dataProviderFactory.get(m.dataprovider()) || self._dataProviderFactory.get(epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);
      dataProvider.getData(request, function(response) {
        requestStack.serveData(response);
      });
    }
  });
};

/**
 * @param {function(string, epiviz.datatypes.GenomicData)} chartDataReadyCallback
 * @param {epiviz.datatypes.GenomicRange} chartRequestedRange
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {epiviz.data.Request} request
 * @param {?epiviz.datatypes.GenomicRange} range A range corresponding to the current request; this can be different from the chartRequestedRange, and can also
 *   be null in case no real request to the data provider was necessary to retrieve data for this chart
 * @param {epiviz.measurements.Measurement} measurement
 * @param {?{globalStartIndex: number, values: *, useOffset: ?boolean}} rawData
 * @private
 */
epiviz.data.Cache.prototype._handleResponse = function(chartDataReadyCallback, chartRequestedRange, chartMeasurementsMap, request, range, measurement, rawData) {

  if (range) {
    var genomicArray = measurement.type() == epiviz.measurements.Measurement.Type.RANGE ?
      new epiviz.datatypes.GenomicRangeArray(measurement, range, rawData.globalStartIndex, rawData.values, rawData.useOffset) :
      new epiviz.datatypes.FeatureValueArray(measurement, range, rawData.globalStartIndex, rawData.values);
    this._mergeData(measurement, genomicArray);
  }

  var computedMs = this._extractComputedMeasurements(chartMeasurementsMap);
  this._updateComputedMeasurementsData(computedMs);

  var pendingRequests = this._measurementPendingRequestsMap.get(measurement);
  if (pendingRequests) {
    delete pendingRequests[request.id()];
  }

  this._serveAvailableData(chartRequestedRange, chartMeasurementsMap, chartDataReadyCallback);
};

/**
 * Look through charts; if there is one for which we have the whole needed data, serve it by calling
 * dataReadyCallback(chartId, data). Then, remove that particular chart from the map.
 *
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {function(string, epiviz.datatypes.GenomicData)} dataReadyCallback
 * @private
 */
epiviz.data.Cache.prototype._serveAvailableData = function(range, chartMeasurementsMap, dataReadyCallback) {
  var MeasurementType = epiviz.measurements.Measurement.Type;
  var self = this;

  var servedChartIds = [];

  for (var chartId in chartMeasurementsMap) {
    if (!chartMeasurementsMap.hasOwnProperty(chartId)) { continue; }

    var chartMeasurements = chartMeasurementsMap[chartId];
    var allDataAvailable = true;
    /** @type {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.MeasurementGenomicData>} */
    var chartData = new epiviz.measurements.MeasurementHashtable();
    (function(chartData) {
      chartMeasurements.foreach(function(m) {
        var storedData = self._data[m.datasourceGroup()];
        if (!storedData || !storedData.rowData() || (m.type() == MeasurementType.FEATURE && !storedData.values(m))) {
          allDataAvailable = false;
          return true; // Break!
        }
        var rowData = storedData.rowData();
        var valueData = (m.type() == MeasurementType.FEATURE) ? storedData.values(m) : null;
        var neededRanges = range.subtract(rowData.boundaries());
        if (neededRanges.length) {
          allDataAvailable = false;
          return true; // Break;
        }

        if (valueData) {
          neededRanges = range.subtract(valueData.boundaries());
          if (neededRanges.length) {
            allDataAvailable = false;
            return true; // Break!
          }
        }

        chartData.put(m, new epiviz.datatypes.MeasurementGenomicDataWrapper(m, self._data[m.datasourceGroup()]));

        return false;
      });
    }(chartData));

    if (allDataAvailable) {
      dataReadyCallback(chartId, new epiviz.datatypes.MapGenomicData(chartData));
      servedChartIds.push(chartId);
    }
  }

  for (var i = 0; i < servedChartIds.length; ++i) {
    delete chartMeasurementsMap[servedChartIds[i]];
  }
};

/**
 * @param {Array.<epiviz.datatypes.GenomicRange>} ranges
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @return {epiviz.measurements.MeasurementHashtable.<Array.<epiviz.datatypes.GenomicRange>>}
 * @private
 */
epiviz.data.Cache.prototype._calcMeasurementNeededRanges = function(ranges, chartMeasurementsMap) {
  var MeasurementType = epiviz.measurements.Measurement.Type;
  var self = this;

  /** @type {epiviz.measurements.MeasurementHashtable.<Array.<epiviz.datatypes.GenomicRange>>} */
  var result = new epiviz.measurements.MeasurementHashtable();

  for (var chartId in chartMeasurementsMap) {
    if (!chartMeasurementsMap.hasOwnProperty(chartId)) { continue; }

    var chartMeasurements = new epiviz.measurements.MeasurementSet();

    (function(chartMeasurements) {
      chartMeasurementsMap[chartId].foreach(function(m) {
        var compMs = m.componentMeasurements();
        compMs.foreach(function(compM) {
          chartMeasurements.add(compM);
          chartMeasurements.add(compM.datasource());
        });

        if (!m.isComputed()) {
          chartMeasurements.add(m.datasource());
        }
      });
    })(chartMeasurements);

    chartMeasurements.foreach(function(m) {
      var neededRanges = null;

      /** @type {?epiviz.datatypes.PartialSummarizedExperiment} */
      var storedData = self._data[m.datasourceGroup()];
      if (!storedData || (m.type() == MeasurementType.FEATURE && !storedData.values(m))) {
        neededRanges = ranges.slice(0); // copy array
      } else {
        /** @type {epiviz.datatypes.GenomicArray} */
        var data = (m.type() == MeasurementType.FEATURE) ? storedData.values(m) : storedData.rowData();
        if (!data) {
          neededRanges = ranges.slice(0); // copy array
        } else {
          neededRanges = [];
          var boundaries = data.boundaries();
          for (var i = 0; i < ranges.length; ++i) {
            neededRanges = neededRanges.concat(ranges[i].subtract(boundaries));
          }
        }
      }

      // Also check pending requests

      /** @type {?Object.<number, epiviz.datatypes.GenomicRange>} */
      var pendingRequests = self._measurementPendingRequestsMap.get(m);

      if (pendingRequests) {
        for (var j = 0; j < neededRanges.length; ++j) {
          for (var requestId in pendingRequests) {
            if (!pendingRequests.hasOwnProperty(requestId)) { continue; }

            /** @type {Array.<epiviz.datatypes.GenomicRange>} */
            var dif = neededRanges[j].subtract(pendingRequests[requestId]);

            // Now replace neededRanges[j] with dif
            Array.prototype.splice.apply(neededRanges, [j, 1].concat(dif));

            if (dif.length == 0) {
              --j;
              break;
            }

            if (j >= neededRanges.length) { break; }
          }
        }
      }

      // It is very important that, even if there are no needed ranges, we still put the empty
      // array in the hashtable, because there will still be a pseudo-request corresponding to it
      result.put(m, neededRanges);
    });
  }

  return result;
};

/**
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @returns {epiviz.measurements.MeasurementSet}
 * @private
 */
epiviz.data.Cache.prototype._extractComputedMeasurements = function(chartMeasurementsMap) {
  var result = new epiviz.measurements.MeasurementSet();
  for (var chartId in chartMeasurementsMap) {
    if (!chartMeasurementsMap.hasOwnProperty(chartId)) { continue; }
    chartMeasurementsMap[chartId].foreach(function(m) {
      if (m.isComputed()) { result.add(m); }
    });
  }

  return result;
};

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicArray} data
 * @private
 */
epiviz.data.Cache.prototype._mergeData = function(measurement, data) {
  var MeasurementType = epiviz.measurements.Measurement.Type;
  var storedData = this._data[measurement.datasourceGroup()];
  if (!storedData) {
    storedData = new epiviz.datatypes.PartialSummarizedExperiment();
    this._data[measurement.datasourceGroup()] = storedData;
  }

  if (measurement.type() == MeasurementType.RANGE) {
    storedData.addRowData(/** @type {epiviz.datatypes.GenomicRangeArray} */ data);
    return;
  }

  // FEATURE
  storedData.addValues(/** @type {epiviz.datatypes.FeatureValueArray} */ data);
};

/**
 * @private
 */
epiviz.data.Cache.prototype._clearUnneededData = function() {
  if (!this._lastRequest) { return; }
  console.log(sprintf('Clearing data outside of range [%7s%10s%10s]', this._lastRequest.seqName(), this._lastRequest.start(), this._lastRequest.end()));

  var self = this;
  var newData = {};
  for (var datasourceGroup in this._data) {
    if (!this._data.hasOwnProperty(datasourceGroup)) { continue; }
    var exp = this._data[datasourceGroup];
    newData[datasourceGroup] = exp.trim(self._lastRequest);
  }

  this._data = newData;
};

/**
 * @param {epiviz.measurements.MeasurementSet} computedMs
 * @private
 */
epiviz.data.Cache.prototype._updateComputedMeasurementsData = function(computedMs) {
  var self = this;
  var GenomicRange = epiviz.datatypes.GenomicRange;
  computedMs.foreach(function(cm) {
    // First, see if there is new data for all of the component measurements of m

    /** @type {?epiviz.datatypes.PartialSummarizedExperiment} */
    var storedData = self._data[cm.datasourceGroup()];
    if (!storedData) { return false; } // Continue

    /** @type {epiviz.measurements.MeasurementSet} */
    var componentMeasurements = cm.componentMeasurements();

    /** @type {?number} */
    var globalStartIndex = null;

    /** @type {?number} */
    var size = null;

    /** @type {?epiviz.datatypes.GenomicRange} */
    var  boundaries = null;

    componentMeasurements.foreach(function(m) {
      /** @type {epiviz.datatypes.FeatureValueArray} */
      var values = storedData.values(m);

      if (!values || !values.boundaries()) {
        globalStartIndex = null;
        size = null;
        boundaries = null;
        return true; // break: there is not enough data to compute the measurement
      }

      if (boundaries === null) {
        globalStartIndex = values.globalStartIndex();
        size = values.size();
        boundaries = values.boundaries();

        // if globalStartIndex === null then break:
        //   this means either that there is not enough data loaded to
        //   compute the measurement (if boundaries is also null),
        //   or the current range simply doesn't contain any data.
        // otherwise, continue iteration
        return (globalStartIndex === null);
      }

      if (values.boundaries().seqName() != boundaries.seqName()) {
        // The stored data for the component measurements belongs to different chromosomes,
        // so the computed measurement cannot be computed yet.
        size = 0;
        return true;
      }

      if (globalStartIndex < values.globalStartIndex()) {
        size -= values.globalStartIndex() - globalStartIndex;
        if (size < 0) {
          // This means that the global start index for one of the component measurements begins
          // after the end of another, which means that the computed measurement cannot be computed yet.
          size = 0;
          return true;
        }
        globalStartIndex = values.globalStartIndex();
        var start = values.boundaries().start(), end = boundaries.end();

        if (size > values.size()) {
          size = values.size();
          end = values.boundaries().end();
        }
        boundaries = GenomicRange.fromStartEnd(boundaries.seqName(), start, end);
      } else {
        var newSize = values.size() - globalStartIndex + values.globalStartIndex();
        if (size > newSize) {
          size = newSize;
          if (size <= 0) {
            size = 0;
            return true;
          }
          boundaries = GenomicRange.fromStartEnd(
            boundaries.seqName(), boundaries.start(), values.boundaries().end());
        }
      }

      if (size == 0) { return true; } // break: there is not enough data to compute the measurement

      return false;
    });

    if (boundaries === null) { return false; } // continue

    // Check if the existing stored values already contain the new values
    var existingValues = storedData.values(cm);
    if (existingValues &&
      (globalStartIndex === null ||
      (existingValues.globalStartIndex() < globalStartIndex &&
      existingValues.globalStartIndex() + existingValues.size() > globalStartIndex + size))) {
      return false; // continue
    }

    // Here, compute the actual measurement

    // Values before the currently stored start index

    /** @type {epiviz.measurements.MeasurementHashtable.<Array.<number>>} */
    var compMsVals = new epiviz.measurements.MeasurementHashtable();
    var values = null;

    if (existingValues && existingValues.size()) {
      componentMeasurements.foreach(function(m) {
        var v = storedData.values(m);
        var mVals = [];
        if (globalStartIndex !== null) {
          for (var index = globalStartIndex; index < existingValues.globalStartIndex(); ++index) {
            mVals.push(v.getByGlobalIndex(index));
          }
        }
        compMsVals.put(m, mVals);
      });

      values = new epiviz.datatypes.FeatureValueArray(cm,
        GenomicRange.fromStartEnd(boundaries.seqName(), boundaries.start(), existingValues.boundaries().start()),
        globalStartIndex,
        cm.evaluateArr(compMsVals));


      self._mergeData(cm, values);

      // Values after current global start index + size
      compMsVals = new epiviz.measurements.MeasurementHashtable();
      componentMeasurements.foreach(function(m) {
        var v = storedData.values(m);
        var mVals = [];
        if (globalStartIndex !== null) {
          for (var index = existingValues.globalStartIndex() + existingValues.size(); index < globalStartIndex + size; ++index) {
            mVals.push(v.getByGlobalIndex(index));
          }
        }
        compMsVals.put(m, mVals);
      });

      values = new epiviz.datatypes.FeatureValueArray(cm,
        GenomicRange.fromStartEnd(boundaries.seqName(), existingValues.boundaries().end(), boundaries.end()),
        existingValues.globalStartIndex() + existingValues.size(),
        cm.evaluateArr(compMsVals));

      self._mergeData(cm, values);

      return false;
    }

    compMsVals = new epiviz.measurements.MeasurementHashtable();
    componentMeasurements.foreach(function(m) {
      var v = storedData.values(m);
      var mVals = [];
      if (globalStartIndex !== null) {
        for (var index = globalStartIndex; index < globalStartIndex + size; ++index) {
          mVals.push(v.getByGlobalIndex(index));
        }
      }
      compMsVals.put(m, mVals);
    });

    values = new epiviz.datatypes.FeatureValueArray(cm,
      boundaries,
      globalStartIndex,
      cm.evaluateArr(compMsVals));

    self._mergeData(cm, values);

    return false;
  });
};

/**
 * Clears all data stored in cache
 */
epiviz.data.Cache.prototype.flush = function() {
  this._data = {};

  // Discard all pending requests
  this._measurementRequestStackMap.foreach(function(m, requestStack) { requestStack.clear(); });
  this._measurementPendingRequestsMap.clear();
};

/**
 * @param {string} datasourceGroup
 */
epiviz.data.Cache.prototype.clearDatasourceGroupCache = function(datasourceGroup) {
  delete this._data[datasourceGroup];
  this._measurementRequestStackMap.foreach(function(m, requestStack) {
    if (m.datasourceGroup() == datasourceGroup) { requestStack.clear(); }
  });

  var msToClear = [];
  this._measurementPendingRequestsMap.foreach(function(m, map) {
    if (m.datasourceGroup() == datasourceGroup) { msToClear.push(m); }
  });

  for (var i = 0; i < msToClear.length; ++i) {
    this._measurementPendingRequestsMap.put(msToClear[i], {});
  }
};

// Input 124
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 8:35 PM
 */

goog.provide('epiviz.data.Request');

goog.require('epiviz.data.MessageType');
goog.require('epiviz.utils');

/**
 * @param {number} id
 * @param {Object.<string, string>} args
 * @param {epiviz.data.Request.Method} [method]
 * @constructor
 */
epiviz.data.Request = function(id, args, method) {
  /**
   * @type {number}
   * @private
   */
  this._id = id;

  /**
   * @type {Object.<string, string>}
   * @private
   */
  this._args = args;

  /**
   * @type {epiviz.data.Request.Method}
   * @private
   */
  this._method = method;
};

/**
 * @enum {string}
 */
epiviz.data.Request.Method = {
  GET: 'get',
  POST: 'post'
};

/**
 * @enum {string}
 */
epiviz.data.Request.Action = {
  // Server actions
  GET_ROWS: 'getRows',
  GET_VALUES: 'getValues',
  GET_COMBINED: 'getCombined',
  GET_MEASUREMENTS: 'getMeasurements',
  SEARCH: 'search',
  GET_SEQINFOS: 'getSeqInfos',
  SAVE_WORKSPACE: 'saveWorkspace',
  DELETE_WORKSPACE: 'deleteWorkspace',
  GET_WORKSPACES: 'getWorkspaces',

  GET_HIERARCHY: 'getHierarchy',
  PROPAGATE_HIERARCHY_CHANGES: 'propagateHierarchyChanges',

  GET_PCA: 'getPCA',
  GET_DIVERSITY: 'getDiversity',

  GET_CHART_SETTINGS: 'getChartSettings',
  SET_CHART_SETTINGS: 'setChartSettings',
  GET_AVAILABLE_CHARTS: 'getAvailableCharts',

  // UI actions
  ADD_MEASUREMENTS: 'addMeasurements',
  REMOVE_MEASUREMENTS: 'removeMeasurements',
  ADD_SEQINFOS: 'addSeqInfos',
  REMOVE_SEQNAMES: 'removeSeqNames',
  ADD_CHART: 'addChart',
  REMOVE_CHART: 'removeChart',
  CLEAR_DATASOURCE_GROUP_CACHE: 'clearDatasourceGroupCache',
  FLUSH_CACHE: 'flushCache',
  NAVIGATE: 'navigate',
  REDRAW: 'redraw',
  GET_CURRENT_LOCATION: 'getCurrentLocation',
  WRITE_DEBUG_MSG: 'writeMsg',
  PRINT_WORKSPACE: 'printWorkspace',
  LOAD_WORKSPACE: 'loadWorkspace',
  REGISTER_CHART_TYPES: 'registerChartTypes'
};

/**
 * @param {Object.<string, string>} args A map with the arguments for the request
 * @param {epiviz.data.Request.Method} [method]
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.createRequest = function(args, method) {
  return new epiviz.data.Request(
    epiviz.data.Request._nextId++,
    args,
    method || epiviz.data.Request.Method.GET
  );
};

/**
 * @param {{requestId: number, type: string, data: Object.<string, string>}} o
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.fromRawObject = function(o) {
  return new epiviz.data.Request(o.requestId, o.data);
};

/**
 * @type {number}
 * @private
 */
epiviz.data.Request._nextId = 0;

/**
 * @returns {number}
 */
epiviz.data.Request.prototype.id = function() { return this._id; };

/**
 * @returns {epiviz.data.MessageType}
 */
epiviz.data.Request.prototype.type = function() { return epiviz.data.MessageType.REQUEST; };

/**
 * @returns {epiviz.data.Request.Method}
 */
epiviz.data.Request.prototype.method = function() { return this._method; };

/**
 * Concatenates all arguments in the request into one string. By default, the result will have the following format:
 *   <key1>=<val1>&<key2>=<val2>...
 * @param {string} [keyValGlue] The token used to join keys and values; by default, this is '='
 * @param {string} [argGlue] The token used to join different arguments together; by default, this is '&'
 * @returns {string}
 */
epiviz.data.Request.prototype.joinArgs = function(keyValGlue, argGlue) {
  keyValGlue = keyValGlue || '=';
  argGlue = argGlue || '&';

  var result = sprintf('requestId%s%s', keyValGlue, this._id);
  for (var arg in this._args) {
    if (!this._args.hasOwnProperty(arg)) { continue; }
    if (!Array.isArray(this._args[arg])) {
      result += sprintf('%s%s%s%s', argGlue, arg, keyValGlue, this._args[arg] || '');
    } else {
      for (var i = 0; i < this._args[arg].length; ++i) {
        result += sprintf('%s%s[]%s%s', argGlue, arg, keyValGlue, this._args[arg][i]);
      }
    }
  }

  return result;
};

/**
 * @returns {boolean}
 */
epiviz.data.Request.prototype.isEmpty = function() {
  for (var arg in this._args) {
    if (!this._args.hasOwnProperty(arg)) { continue; }
    return false;
  }

  return true;
};

/**
 * @param arg
 * @returns {?string}
 */
epiviz.data.Request.prototype.get = function(arg) {
  return (arg in this._args) ? this._args[arg] : null;
};

/**
 * @returns {{requestId: number, type: string, data: Object.<string, string>}}
 */
epiviz.data.Request.prototype.raw = function() {
  return {
    requestId: this._id,
    type: this.type(),
    data: epiviz.utils.mapCopy(this._args)
  };
};

/**
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.emptyRequest = function() {
  return epiviz.data.Request.createRequest({});
};

/**
 * @param {epiviz.measurements.Measurement} datasource
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getRows = function(datasource, range) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_ROWS,
    datasource: datasource.id(),
    seqName: range ? range.seqName() : undefined,
    start: range ? range.start() : undefined,
    end: range ? range.end() : undefined,
    metadata: datasource.metadata()
  });
};

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getValues = function(measurement, range) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_VALUES,
    datasource: measurement.datasource().id(),
    measurement: measurement.id(),
    seqName: range ? range.seqName() : undefined,
    start: range ? range.start() : undefined,
    end: range ? range.end() : undefined
  });
};

/**
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} measurementsByDatasource
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getCombined = function(measurementsByDatasource, range) {
  var rawMsByDs = {};
  for (var ds in measurementsByDatasource) {
    if (!measurementsByDatasource.hasOwnProperty(ds)) { continue; }
    rawMsByDs[ds] = (function() {
      var ms = [];
      measurementsByDatasource[ds].foreach(function(m) {
        ms.push(m.id());
      });
      return ms;
    })();
  }
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_COMBINED,
    seqName: range ? range.seqName() : undefined,
    start: range ? range.start() : undefined,
    end: range ? range.end() : undefined,
    measurements: rawMsByDs
  });
};

/**
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getMeasurements = function(datasourceGroup) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_MEASUREMENTS,
    datasourceGroup: datasourceGroup
  });
};

/**
 * @param {string} query
 * @param {number} maxResults
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.search = function(query, maxResults) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.SEARCH,
    q: query || '',
    maxResults: maxResults
  });
};

/**
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getSeqInfos = function(datasourceGroup) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_SEQINFOS,
    datasourceGroup: datasourceGroup
  });
};

/**
 * @param {epiviz.workspaces.Workspace} workspace
 * @param {epiviz.Config} config
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.saveWorkspace = function(workspace, config) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.SAVE_WORKSPACE,
    id: workspace.id(),
    name: workspace.name(),
    content: encodeURIComponent(JSON.stringify(workspace.raw(config).content))
  },
  epiviz.data.Request.Method.POST);
};

/**
 * @param {epiviz.workspaces.Workspace} workspace
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.deleteWorkspace = function(workspace) {
  return epiviz.data.Request.createRequest({
      version: epiviz.EpiViz.VERSION,
      action: epiviz.data.Request.Action.DELETE_WORKSPACE,
      id: workspace.id()
    },
    epiviz.data.Request.Method.POST);
};

/**
 * @param filter
 * @param requestWorkspaceId
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getWorkspaces = function(filter, requestWorkspaceId) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_WORKSPACES,
    q: filter || '',
    ws: requestWorkspaceId
  });
};

/**
 * @param {string} datasourceGroup
 * @param {string} [nodeId]
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getHierarchy = function(datasourceGroup, nodeId) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_HIERARCHY,
    datasourceGroup: datasourceGroup,
    nodeId: nodeId
  });
};

/**
 * @param {string} datasourceGroup
 * @param {Object.<string, epiviz.ui.charts.tree.NodeSelectionType>} [selection]
 * @param {Object.<string, number>} [order]
 * @param {Object.<number, number>} [selectedLevels]
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.propagateHierarchyChanges = function(datasourceGroup, selection, order, selectedLevels) {
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.PROPAGATE_HIERARCHY_CHANGES,
    datasourceGroup: datasourceGroup,
    selection: selection,
    order: order,
    selectedLevels: selectedLevels
  });
};

/**
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} measurementsByDatasource
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getPCA = function(measurementsByDatasource, range) {
  var rawMsByDs = {};
  for (var ds in measurementsByDatasource) {
    if (!measurementsByDatasource.hasOwnProperty(ds)) { continue; }
    rawMsByDs[ds] = (function() {
      var ms = [];
      measurementsByDatasource[ds].foreach(function(m) {
        ms.push(m.id());
      });
      return ms;
    })();
  }
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_PCA,
    measurements: rawMsByDs
  });
};


/**
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} measurementsByDatasource
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {epiviz.data.Request}
 */
epiviz.data.Request.getDiversity = function(measurementsByDatasource, range) {
  var rawMsByDs = {};
  for (var ds in measurementsByDatasource) {
    if (!measurementsByDatasource.hasOwnProperty(ds)) { continue; }
    rawMsByDs[ds] = (function() {
      var ms = [];
      measurementsByDatasource[ds].foreach(function(m) {
        ms.push(m.id());
      });
      return ms;
    })();
  }
  return epiviz.data.Request.createRequest({
    version: epiviz.EpiViz.VERSION,
    action: epiviz.data.Request.Action.GET_DIVERSITY,
    measurements: rawMsByDs
  });
};



// Input 125
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 8:36 PM
 */

goog.provide('epiviz.data.Response');

goog.require('epiviz.data.MessageType');

/**
 * @param {number} requestId
 * @param {T} data
 * @constructor
 * @template T
 */
epiviz.data.Response = function(requestId, data) {
  /**
   * @type {number}
   * @private
   */
  this._id = requestId;

  /**
   * @type {T}
   * @private
   */
  this._data = data;
};

/**
 * @returns {number}
 */
epiviz.data.Response.prototype.id = function() { return this._id; };

/**
 * @returns {T}
 */
epiviz.data.Response.prototype.data = function() {

  var data = this._data;

  // for getMeasurements and getSeqInfo response!
  var all_keys = Object.keys(data);
  if(all_keys.length > 0) {
    if (all_keys.indexOf('success') != -1) {
      all_keys.splice(all_keys.indexOf('success'), 1);
      delete data['success'];
      //for SeqInfo response
/*      if(all_keys.indexOf("") != -1) {
        return data[all_keys[0]];
      }*/
    }
  }
  return data;
};

/**
 * @returns {epiviz.data.MessageType}
 */
epiviz.data.Response.prototype.type = function() { return epiviz.data.MessageType.RESPONSE; };

/**
 * @returns {{requestId: number, type: epiviz.data.MessageType, data: T}}
 */
epiviz.data.Response.prototype.raw = function() {
  return {
    requestId: this._id,
    type: this.type(),
    data: this._data
  };
};

/**
 * @param {{requestId: number, data: T}} o
 * @constructor
 * @template T
 * @returns {epiviz.data.Response.<T>}
 */
epiviz.data.Response.fromRawObject = function(o) {
  return new epiviz.data.Response(o.requestId, o.data);
};

// Input 126
/**
 * Created by: Florin Chelaru
 * Date: 10/1/13
 * Time: 1:28 PM
 */

goog.provide('epiviz.data.DataProviderFactory');

goog.require('epiviz.events.EventListener');
goog.require('epiviz.events.Event');
goog.require('epiviz.data.EmptyResponseDataProvider');
// goog.require('epiviz.utils.evaluateFullyQualifiedTypeName');
// goog.require('epiviz.utils.applyConstructor');
goog.require('epiviz.utils');

/**
 * A factory containing all the registered active data providers
 * (like EpivizR connections or PHP servers)
 * @param {epiviz.Config} config
 * @constructor
 * @implements {epiviz.utils.Iterable}
 */
epiviz.data.DataProviderFactory = function(config) {
  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {Array.<epiviz.data.DataProvider>}
   * @private
   */
  //this._providers = [];

  /**
   * @type {Object.<string, epiviz.data.DataProvider>}
   * @private
   */
  this._providers = {};

  /**
   * @type {number}
   * @private
   */
  this._size = 0;

  var tokens;
  for (var i = 0; i < this._config.dataProviders.length; ++i) {
    if (!$.isArray(this._config.dataProviders[i])) {
      tokens = this._config.dataProviders[i].split(',');
    } else {
      tokens = this._config.dataProviders[i];
    }
    /**
     * @type {?function(new:epiviz.data.DataProvider)}
     */
    var dataProviderConstructor = epiviz.utils.evaluateFullyQualifiedTypeName(tokens[0]);

    if (!dataProviderConstructor) { continue; }

    /** @type {epiviz.data.DataProvider} */
    var dataProvider = epiviz.utils.applyConstructor(dataProviderConstructor, tokens.slice(1));

    this._providers[dataProvider.id()] = dataProvider;

    ++this._size;
  }
  var emptyProvider = new epiviz.data.EmptyResponseDataProvider();
  this._providers[emptyProvider.id()] = emptyProvider;
  ++this._size;

  tokens = this._config.workspacesDataProvider.split(',');
  /**
   * @type {?function(new:epiviz.data.DataProvider)}
   */
  var wsDataProviderConstructor = epiviz.utils.evaluateFullyQualifiedTypeName(tokens[0]);

  /** @type {epiviz.data.DataProvider} */
  this._workspacesDataProvider = epiviz.utils.applyConstructor(wsDataProviderConstructor, tokens.slice(1));

};

/**
 * Iterates through all registered data providers until the function
 *   evaluates to true
 * @param {function(epiviz.data.DataProvider)} func
 */
epiviz.data.DataProviderFactory.prototype.foreach = function(func) {
  for (var id in this._providers) {
    if (!this._providers.hasOwnProperty(id)) { continue; }
    if (func(this._providers[id])) { return; }
  }
};

/**
 * @returns {boolean}
 */
epiviz.data.DataProviderFactory.prototype.isEmpty = function() {
  //return !this._providers.length;
  return !this._size;
};

/**
 * @returns {number}
 */
epiviz.data.DataProviderFactory.prototype.size = function() {
  //return this._providers.length;
  return this._size;
};

/**
 * @param {string} id
 * @returns {epiviz.data.DataProvider}
 */
epiviz.data.DataProviderFactory.prototype.get = function(id) {
  if (id in this._providers) {
    return this._providers[id];
  }

  return null;
};

/**
 * @returns {epiviz.data.DataProvider}
 */
epiviz.data.DataProviderFactory.prototype.workspacesDataProvider = function() {
  return this._workspacesDataProvider;
};

// Input 127
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/15/14
 * Time: 1:50 PM
 */

goog.provide('epiviz.data.MessageType');

/**
 * @enum {string}
 */
epiviz.data.MessageType = {
  REQUEST: 'request',
  RESPONSE: 'response'
};

// Input 128
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/31/2014
 * Time: 11:56 AM
 */

goog.provide('epiviz.data.MetagenomicsDataProvider');

/**
 * @constructor
 * @extends {epiviz.data.DataProvider}
 */
epiviz.data.MetagenomicsDataProvider = function () {
  epiviz.data.DataProvider.call(this, 'metagenomics-provider');

  /**
   * @type {Array.<Array.<number>>}
   * @private
   */
  this._values = [[1.431779586,1.192413264,0,0,5.246275888,0,0,0,0,0,0,0,0,0,5.176956182,0,0,0,5.155970401,6.190149838,0,0,0,0,0,0,0,0,3.698665367,0,2.13227898,0,2.211623187,2.367619226,1.61041097,0,5.385994425,4.139182844,4.372482843,0,0,2.878908183,2.91052254,2.301374909,0,2.952062239,0,0,0,0,0,0,0,0,0,0,6.122190562,0,3.358854664,0,1.385653692,2.766109149,6.099454438,4.340878996,5.939634652,2.959707294,0,3.380142709,0,5.795596951,5.937850648,4.856588768,0,0,1.674904626,2.854876154,0,1.191371277,4.270740369,0,1.586888663,0,0,0,0,2.897552731,0,0,0,0,3.332623469,0,0,0,0,0,0,0,0,1.284976959,0,0,0,0,0,2.479401066,0,0,0,0,1.377092695,0,0,0,3.135561463],
    [3.483719988,1.836204539,0,1.992995304,5.402734039,1.569736026,0,0,4.371867824,0,0,0,1.262193429,3.863871272,6.051516389,0,0,0,3.64974824,7.298095577,0,0,0,0,0,0,0,0,5.042530097,0,4.52334967,0,3.417546061,3.220604739,0,0,3.583640746,4.911014295,2.672729483,0,0,1.640918907,4.057049171,0,0,4.87292166,0,0,0,2.555337332,0,0,0,0,0,0,2.801189549,4.326546321,5.672425342,0,7.342433164,4.708466901,8.38125063,4.943561744,5.69886844,5.914613168,1.935406473,4.545532356,0,5.568781432,5.770864453,5.786486697,0,0,1.674904626,5.633094879,0,2.891124637,6.337477197,0,3.703106027,0,3.658543633,3.635588574,0,5.110546454,0,2.348450405,0,3.883764286,5.793023474,0,0,1.461730735,0,0,0,0,4.110953646,5.759180328,0,0,0,4.066891048,0,6.762235684,0,0,2.184629194,1.844254505,4.444055644,0,5.116207142,3.834609931,6.918120174],
    [1.431779586,1.192413264,0,0,6.594730277,0,0,0,0,0,0,0,0,0,6.105158342,0,0,0,5.401020298,5.531926921,0,0,0,0,0,0,0,0,2.661346394,0,2.13227898,0,2.211623187,0,1.61041097,0,2.513383648,4.444642108,0,1.322794318,0,1.640918907,2.635783143,1.567855244,0,5.224508802,0,0,0,0,3.273593502,0,0,0,0,0,6.122190562,1.450539436,5.956779471,0,0,1.5529849,5.710154873,6.253733669,7.33429437,4.628121119,0,4.470957872,0,6.318097687,5.364607625,5.424856331,0,0,0,3.879285317,1.255175933,1.834870601,5.412691363,0,3.172492646,0,1.554826783,0,0,4.042983171,0,0,0,1.338596694,5.221012467,0,0,1.461730735,0,0,1.797115738,0,3.658543633,1.953661285,0,0,0,2.405446283,0,3.880683284,0,0,0,0,2.885530704,0,2.381429107,0,4.299507612],
    [0,0,0,1.316327062,3.811828399,0,0,0,0,0,0,0,0,0,3.761584641,0,0,0,1.406082194,3.945166829,0,0,0,0,0,0,0,0,4.085653677,0,1.4287038,0,1.144473079,3.220604739,0,0,0,2.986448755,1.481358206,1.322794318,0,1.640918907,3.141217906,0,0,1.231253532,0,0,0,0,0,0,0,0,0,0,1.994606741,0,3.598259323,0,4.559531286,3.861920818,7.326065032,3.286373665,4.443256343,2.959707294,0,2.179323699,0,2.819792025,4.006780657,3.522245428,0,0,0,2.24508439,1.916065792,1.191371277,2.93651056,0,2.324239181,0,2.285688951,1.94753258,0,1.195550809,0,0,0,0,4.509606186,0,0,3.526859546,0,0,0,0,0,3.032789935,0,0,0,2.405446283,0,2.975444667,0,0,3.016531724,0,0,0,4.46287892,0,4.780297015],
    [3.687570256,0,0,2.451788443,2.911066272,0,0,0,0,0,0,0,0,2.134165238,4.216294965,0,0,0,0,1.612405897,0,0,0,0,0,0,0,0,0,0,0,0,1.774547779,0,0,0,0,0,0,0,0,0,0,0,0,2.334318467,0,0,0,0,0,0,0,0,0,0,0,3.893829897,2.712718048,0,2.079226691,4.202270685,4.808746813,2.644765483,0,4.296021802,1.935406473,2.512450001,0,1.594645054,4.279876905,3.284108206,1.590756464,0,0,1.804782814,1.255175933,1.191371277,2.93651056,0,1.586888663,0,2.285688951,0,0,3.797347749,0,1.241386551,0,1.338596694,4.389821626,0,0,1.461730735,0,0,0,0,3.902410173,3.266140317,0,0,0,0,0,5.045993892,0,1.358928018,5.557633431,3.132909221,2.885530704,0,3.526859546,0,4.511395522],
    [0,6.16378224,0,1.316327062,1.666262603,3.149587113,0,0,5.651369874,4.243152632,0,0,0,3.155361395,6.66537163,1.554826783,2.992869351,0,0,6.344241104,0,0,0,0,2.350033433,0,0,0,4.390486707,0,4.413090928,0,5.591424995,3.596422408,0,2.212993723,5.679071268,4.021076095,5.775141191,1.322794318,0,3.98463569,3.939376164,0,0,2.952062239,0,0,0,0,0,0,0,0,0,0,1.994606741,3.272846047,3.358854664,0,3.797347749,3.127128728,6.619079845,2.170766959,0,3.481491606,0,3.010569242,0,2.819792025,4.707393819,1.458514165,0,0,0,2.854876154,0,0,2.113629503,0,2.324239181,0,1.554826783,0,0,1.840219556,0,0,0,1.338596694,0,0,0,0,0,0,0,0,0,1.953661285,0,0,0,0,1.864734062,1.717354877,0,0,0,0,0,0,1.634715536,1.410544518,1.354808925],
    [4.168154907,4.247537068,0,1.316327062,5.609580256,1.569736026,0,0,0,0,1.28620039,0,1.262193429,2.733293055,5.814457673,0,0,0,4.686639201,5.397538194,0,0,0,0,0,0,0,0,0,0,2.603155617,0,2.546614229,0,0,0,3.919218828,5.314013565,1.481358206,1.322794318,0,0,4.361537796,2.785322386,0,5.418830035,0,0,0,1.781999348,0,0,0,0,0,0,8.323743779,2.159049313,6.157253354,0,3.18023001,0,4.808746813,4.460464862,5.203555779,3.244061423,0,3.674088391,0,5.143370329,4.509413633,4.45805522,0,0,1.674904626,3.084284864,0,1.834870601,4.140691561,0,0,0,3.864522096,0,0,4.744508356,0,0,0,1.338596694,4.259183612,0,0,0,0,0,0,0,1.733606582,2.408805546,0,0,0,1.950591407,0,1.717354877,0,2.046103514,0,0,2.885530704,1.614406279,0,1.410544518,0],
    [0,1.192413264,0,0,4.019469864,2.303636946,0,0,0,0,0,0,0,0,3.093845517,0,0,0,0,1.612405897,0,0,0,0,0,0,0,0,2.32039045,0,0,0,0,0,0,0,0,1.914596325,0,0,0,0,2.635783143,2.301374909,0,1.885737479,0,0,0,0,0,0,0,0,0,0,0,1.450539436,1.511899039,0,4.09837174,5.162542291,5.175330384,1.46012053,0,4.165843825,0,3.207157908,0,1.594645054,4.149781155,3.726587359,0,0,0,2.24508439,0,1.834870601,2.93651056,0,4.250663922,0,1.554826783,0,0,1.195550809,0,1.241386551,0,1.338596694,3.776543493,0,0,2.172734535,0,0,0,0,1.733606582,2.408805546,0,0,0,1.950591407,1.214748986,3.637105643,0,0,3.016531724,0,2.068632354,0,4.59442283,0,3.37097252],
    [0,0,0,1.316327062,0,0,0,0,0,0,0,0,0,0,0,4.204912301,1.731263898,5.895075687,2.104447385,0,0,0,2.065128811,0,0,0,4.998802577,4.985265729,0,1.969178823,0,0,0,2.98819618,0,5.973110282,0,1.254014401,1.481358206,0,0,0,0,0,6.783920221,0,4.485860075,7.116079322,6.455458592,6.009316582,4.902157249,7.090579488,8.457444348,4.308067937,0,9.670062403,0,0,0,0,0,0,0,0,0,0,4.560645878,0,7.26890038,0,2.590991323,0,1.590756464,3.152109798,6.398031074,0,4.022952592,1.191371277,0,1.377092695,0,5.109341881,0,0,0,0,2.632106894,3.199364361,3.679313849,2.83110867,0,3.533813815,4.660580583,0,5.325751405,4.401509522,0,2.963977331,0,0,0,2.68589141,4.656100179,0,0,0,0,0,0,0,0,0,1.634715536,0,0],
    [0,0,2.558261645,0,0,0,3.37097252,0,0,0,0,0,0,0,0,1.554826783,0,0,0,0,0,4.717893295,3.780189712,2.998738351,0,0,4.783910899,5.646155588,1.221294271,4.318348466,0,0,0,1.916065792,0,4.26166757,0,1.254014401,0,2.808592225,0,0,0,0,2.754273197,0,4.485860075,5.206648839,3.877609802,5.488721907,3.650844232,4.926557629,7.621145557,3.3791203,0,6.894968358,0,0,0,0,0,0,0,0,0,0,0,0,3.711139607,0,0,0,1.590756464,0,3.580737915,0,1.255175933,1.834870601,0,0,0,3.605634704,0,0,0,0,4.326546321,4.750653296,2.303636946,1.338596694,0,1.866117748,5.226402442,0,4.545126266,2.122906148,0,2.963977331,0,0,0,0,3.046826728,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2.285688951,0,4.919116898,1.406082194,0,0,0,2.8815524,0,0,0,2.439564301,3.350844299,0,1.969178823,0,0,0,1.255175933,0,4.512111935,0,1.254014401,0,0,0,0,0,0,5.365618534,0,2.02080583,6.186981576,5.395607493,3.056075924,4.408114953,5.586729427,5.85052519,3.3791203,0,8.827870296,0,0,0,2.172734535,0,0,0,0,0,0,1.935406473,0,6.977279923,0,0,0,2.814800039,3.681934901,6.06154884,0,4.84495056,1.834870601,0,1.377092695,0,3.810996399,0,0,0,1.195550809,3.510786446,2.348450405,4.370515798,0,0,2.653290576,6.039518498,0,6.088292283,5.584357216,0,2.137949557,0,0,3.437769124,3.569195185,3.046826728,0,0,0,0,0,0,0,0,0,0,0,0],
    [7.166058622,5.562929062,0,0,0,1.569736026,0,0,0,3.317392333,0,0,0,0,0,0,2.495790119,0,3.64974824,7.94166956,4.09837174,0,0,4.45805522,0,0,0,0,3.83951414,0,3.241876309,2.894869795,5.662114442,1.255175933,5.529025621,0,1.361689044,10.31811713,5.399808132,0,0,0,5.766993135,0,0,10.35642231,0,0,0,3.056075924,3.273593502,0,0,0,0,0,0,7.886927515,6.57658932,0,6.068864939,0,0,5.742529189,0,0,0,3.207157908,0,0,0,7.683313658,0,0,0,4.472293286,2.711021318,1.191371277,1.413536412,0,7.18277747,0,0,3.934112064,0,9.499010008,0,0,3.438628157,11.3419642,7.453095073,0,0,0,3.605634704,0,0,0,9.323133332,9.025457813,0,0,0,6.063989916,10.09991753,0,0,1.358928018,0,3.132909221,0,0,6.339850003,5.962545954,6.5132172],
    [2.607242384,1.192413264,0,0,2.418952549,5.335214496,0,0,0,0,4.896125461,0,4.45805522,1.090815163,3.466007268,0,4.451650978,0,1.406082194,0,0,0,0,0,0,0,0,0,2.32039045,3.662411471,2.957578397,4.620888419,2.211623187,6.048481206,0,0,0,1.914596325,0,1.322794318,2.017487427,1.640918907,1.851024161,2.301374909,0,3.383215216,0,0,0,0,0,0,0,0,3.96333911,0,0,0,2.233797185,0,0,0,0,2.170766959,3.383215216,0,0,3.010569242,0,1.594645054,0,2.998738351,0,0,0,1.167924869,0,0,1.413536412,1.377092695,1.586888663,0,5.165257592,5.25334101,5.189186904,0,0,5.796241065,2.303636946,6.60481673,0,0,0,0,0,0,0,0,0,3.643192729,0,0,0,0,2.926952007,7.290999429,0,3.141551507,0,5.115980262,6.055178464,0,6.448170658,0,3.37097252],
    [0,4.247537068,0,7.627324571,4.638829373,0,0,0,0,0,0,0,3.764198849,1.090815163,9.297238893,0,0,0,1.406082194,0,0,0,0,0,0,0,0,0,3.542563074,0,5.0508891,4.852847605,7.502930506,0,1.61041097,2.212993723,8.139575446,0,2.196679237,4.555970876,0,5.753981571,4.533829712,0,0,8.115201432,0,0,0,0,0,0,0,0,0,0,3.99325527,4.052930578,8.251263226,0,3.797347749,1.5529849,0,1.46012053,1.529467388,5.598651855,1.935406473,7.59947533,0,4.537434131,4.279876905,8.078048143,0,0,2.429204831,3.45615723,2.711021318,3.494361381,6.276852113,0,0,0,6.641505703,0,0,4.812332598,0,0,0,0,6.461304882,0,0,0,0,0,0,0,1.733606582,3.466949588,0,0,0,4.066891048,3.532071506,6.531898878,0,1.358928018,0,0,2.534144363,0,1.634715536,0,2.040985264],
    [4.417752244,4.430656786,0,6.590662342,5.161186664,2.787748346,0,0,0,0,0,0,1.262193429,3.155361395,10.02054726,0,0,0,4.940306328,3.945166829,0,0,0,0,0,0,0,0,2.936928025,0,6.171246663,2.40377094,5.943281103,1.255175933,3.494023898,0,0,5.314013565,2.196679237,3.088736519,0,2.388819979,8.095345442,1.567855244,0,7.35819207,0,0,0,2.555337332,3.273593502,0,0,0,0,0,5.20245281,4.75470228,9.430220215,0,2.545649577,3.127128728,6.658211483,7.210528482,11.02122881,6.173655965,2.733293055,6.960342713,0,10.04653152,6.735083971,7.155915068,0,1.571621765,0,6.013261752,3.220604739,4.245781516,5.761407417,1.377092695,2.809830944,0,3.418179486,3.934112064,0,7.222911731,0,0,0,0,9.867046044,0,0,0,0,0,0,0,5.06859083,6.373240186,0,0,0,4.066891048,3.357133596,8.094400839,0,3.579495955,3.540808171,1.844254505,6.524413414,0,6.943748633,8.296608074,4.40933806],
    [2.136055426,4.037748079,6.262933358,0,3.811828399,6.919801759,0,0,0,2.455308789,6.188686675,2.926124712,5.998580568,6.127768499,5.748563718,0,3.655458089,0,0,0,0,0,0,0,0,0,0,0,3.83951414,6.290193531,3.683059916,8.256071986,2.211623187,4.84495056,2.35241283,0,3.583640746,0,3.759667491,3.524879916,3.879657956,3.535209466,0,2.301374909,0,4.937796138,0,0,0,1.781999348,3.273593502,0,0,0,0,0,0,3.272846047,2.712718048,0,0,1.5529849,1.888578717,0,1.529467388,2.134165238,0,1.121990524,2.331205908,0,3.84803047,0,0,0,0,1.804782814,0,1.834870601,0,0,2.324239181,0,3.418179486,0,2.079226691,1.840219556,0,8.13274431,1.569736026,8.882484137,1.493074462,0,0,0,0,0,1.797115738,0,0,3.643192729,0,0,0,4.294594419,7.783238308,11.1138092,0,3.756976488,2.184629194,9.208657654,0,0,4.46287892,0,5.202634978],
    [2.136055426,6.715798815,0,6.374469421,3.277337944,2.787748346,0,0,1.792044962,3.317392333,0,0,0,1.704821959,8.698957643,0,0,0,7.159005373,4.794362379,0,0,2.065128811,0,5.243564207,0,0,0,5.355676609,0,3.683059916,0,6.79661711,4.69851443,2.839992687,4.26166757,8.225319066,9.567229277,5.203290985,1.322794318,0,8.827786737,7.798586914,0,0,5.418830035,0,0,0,4.175777728,3.949615895,0,0,0,0,0,4.636949199,2.632106894,5.672425342,0,2.545649577,4.907541568,7.726632416,6.604697646,4.443256343,3.863871272,1.935406473,4.12685628,0,8.766010155,7.439035579,6.112321025,0,0,0,1.167924869,3.220604739,3.319889474,6.307483081,1.377092695,4.95699151,0,0,0,0,6.512899724,0,0,0,3.111909342,2.688101136,0,0,0,0,0,1.797115738,0,3.902410173,4.584271389,0,0,0,3.02915668,0,0,0,2.046103514,3.016531724,2.62792129,1.377092695,1.614406279,1.634715536,1.410544518,2.50408572],
    [0,8.24954917,0,3.079218485,7.152835931,0,0,0,0,0,7.074815273,0,1.262193429,6.031368279,0,0,0,0,2.104447385,5.4662968,0,0,0,0,6.374469421,0,0,0,5.761878745,0,3.683059916,3.5520836,9.072883619,0,1.61041097,0,0,4.248348124,8.733798954,0,0,0,7.798586914,0,0,4.87292166,0,0,0,3.427082841,0,0,0,0,4.517137731,0,0,2.632106894,5.17732725,0,5.760907699,0,0,1.46012053,2.735603919,8.297188307,1.935406473,3.010569242,0,0,6.223071923,7.120101904,0,0,3.823534849,5.596384969,2.98819618,3.121377237,8.006968945,1.377092695,9.662880605,0,0,0,1.385653692,4.598472787,0,0,0,7.161906168,0,0,0,0,0,0,0,0,1.733606582,4.894120843,0,0,0,0,2.926952007,0,0,0,3.016531724,0,0,0,8.858471847,0,3.573305055],
    [0,0,0,1.992995304,4.200951897,0,0,0,0,0,0,0,4.710107996,1.090815163,4.399205452,0,0,0,3.446387271,0,0,0,0,0,0,0,0,0,1.873071327,0,0,0,2.546614229,0,1.61041097,0,0,0,1.481358206,0,0,0,2.29611755,0,0,6.57500401,0,0,0,0,0,0,0,0,0,0,1.994606741,3.893829897,4.286771649,0,3.955696773,0,3.562036104,2.170766959,3.8285856,5.993490151,0,5.084964667,0,3.472619051,2.121043177,4.064733345,0,0,0,3.282169857,2.711021318,1.191371277,7.920439558,0,0,0,7.031714558,0,0,3.656828487,0,0,0,0,3.571590925,0,0,1.461730735,0,0,6.874509697,0,1.733606582,4.962197967,0,0,0,5.593292122,0,5.547406345,0,2.046103514,0,0,0,1.614406279,0,2.109945405,2.040985264],
    [3.866150632,3.920180613,0,5.312815342,6.422613285,3.679313849,0,0,0,0,0,0,0,4.924980206,7.658247372,0,0,0,2.104447385,4.562776343,2.079226691,0,0,0,0,0,0,0,1.221294271,0,1.4287038,0,6.442220582,5.709224853,2.839992687,0,0,3.418903812,4.602735444,1.322794318,0,2.388819979,1.204003557,1.567855244,0,6.037602452,0,0,0,0,0,0,0,0,0,0,2.801189549,8.63619108,4.648124521,0,8.475079652,7.514265748,7.529694344,4.859026111,0,7.745232773,5.003307476,6.460395665,0,4.26166757,7.879619164,7.991502025,0,2.305904344,2.921997488,6.790846122,4.141069016,3.918449926,6.337477197,2.068632354,6.269637347,0,4.204912301,0,0,6.553102814,0,2.348450405,0,4.485860075,9.83873207,0,0,1.461730735,0,0,0,0,2.995800011,8.415814604,0,0,0,6.442278134,1.864734062,9.185459486,0,5.209209265,11.75590855,5.219920851,6.420626178,5.087025329,7.474453122,1.410544518,3.573305055],
    [6.965078686,2.618564793,0,1.992995304,10.59290385,0,0,0,0,0,3.802156015,0,1.924937051,5.300785568,5.995802653,0,1.731263898,1.871675903,5.955501257,5.531926921,2.897552731,0,0,0,0,0,0,0,2.661346394,0,7.611655227,2.40377094,5.02134636,0,3.735557761,0,0,5.038083001,5.45978414,0,0,1.640918907,4.057049171,0,0,8.594118334,0,0,0,3.056075924,1.959834467,0,0,0,0,0,5.516523261,7.356774251,8.013503616,0,3.18023001,0,5.376448084,8.188430789,5.939634652,6.96265097,1.935406473,6.674919197,0,7.363139212,4.279876905,6.183453199,0,0,2.429204831,6.401581783,3.596422408,4.666202349,8.657004791,0,5.730754292,0,7.010186538,0,0,7.409664666,0,0,0,5.993020597,8.605052591,1.866117748,0,7.573447879,0,0,6.325672809,0,8.570120461,7.461785195,0,0,2.546614229,5.755117139,3.828838673,7.111654959,0,5.841420387,2.184629194,5.920900463,6.249442918,2.845102004,3.976074161,2.932344535,4.511395522],
    [1.431779586,7.359653593,0,3.991238804,2.418952549,1.569736026,0,0,0,0,1.28620039,0,0,4.489859297,8.791850058,0,0,0,7.175568077,6.062717992,0,0,0,0,0,0,0,0,0,0,6.136969432,2.40377094,5.517092631,1.255175933,5.529025621,0,1.361689044,9.483173757,6.110621289,0,0,0,7.550290267,6.661015065,0,4.804992012,0,0,0,1.781999348,1.959834467,0,0,0,0,0,9.46245649,7.278413221,6.923272455,0,3.797347749,6.102201637,9.088107781,6.604697646,4.008481477,5.598651855,0,5.550973073,0,3.182820685,4.961195168,6.750115474,0,0,0,4.105131291,2.367619226,2.617013534,3.220247532,0,3.703106027,0,1.554826783,1.94753258,0,7.036971196,0,0,0,5.641825282,4.908722257,0,0,0,0,0,0,0,4.454849206,4.962197967,0,0,0,0,2.311215911,4.271024917,0,3.377078116,0,0,4.731134649,0,0,1.410544518,1.354808925],
    [0,4.146452518,0,0,1.666262603,1.569736026,4.051052201,0,7.830362992,11.88636471,0,0,0,0,0,9.472289399,7.988117903,0,10.08368995,1.612405897,0,0,0,0,2.350033433,0,0,0,3.168216406,1.297324055,0,4.001933649,0,0,9.149074161,2.212993723,3.381165997,6.572629376,4.09837174,0,0,10.10958722,0,6.383958854,0,2.334318467,0,0,0,10.82625781,4.197003578,0,4.041235755,2.047816235,0,0,0,0,8.36096898,0,0,7.483410394,0,1.46012053,0,0,0,1.121990524,2.331205908,0,0,4.568474378,0,0,2.921997488,3.084284864,4.141069016,8.966817321,1.413536412,6.711961034,0,0,0,3.635588574,4.228198043,3.127952731,0,0,0,4.980986765,6.731497682,0,0,6.755121839,0,0,0,2.137949557,10.22161522,8.378930116,2.097168659,0,9.661273435,0,1.864734062,0,5.475028474,2.046103514,0,3.506233059,2.068632354,5.171989239,3.976074161,10.3926218,6.411293182],
    [6.480349619,5.814292081,0,5.078391452,5.161186664,0,0,0,0,0,0,0,0,3.620520142,8.990210888,0,0,0,2.573009698,3.738300805,0,0,0,0,0,0,0,0,3.168216406,0,4.811098905,0,4.510440908,1.255175933,2.35241283,0,0,4.843020605,3.316228807,3.524879916,0,0,5.83447311,1.567855244,0,7.234536645,0,0,0,0,1.959834467,0,0,0,0,0,8.875462831,2.159049313,8.660722242,0,3.619450877,2.283469031,8.194224446,5.694548476,10.57152012,6.818446775,0,4.8696392,0,8.064293677,8.303360081,5.740051978,0,0,1.674904626,6.707238628,2.711021318,3.918449926,4.602558379,2.068632354,0,0,5.837982345,2.74723393,0,5.68152181,0,0,0,1.338596694,7.866072799,0,0,0,0,0,1.797115738,0,4.293124066,5.314446514,0,0,0,2.405446283,0,6.213863305,0,2.046103514,0,0,4.334091189,0,6.139012732,5.800288227,5.262402246],
    [6.70826126,3.920180613,0,3.991238804,2.418952549,2.303636946,0,0,0,0,0,0,6.500013095,7.714517186,0,0,1.731263898,0,2.573009698,0,0,0,0,0,0,0,0,0,1.221294271,0,0,0,1.774547779,1.255175933,3.203757507,0,0,0,0,0,0,0,2.29611755,0,0,4.658711917,0,0,0,4.175777728,0,0,0,0,0,0,0,2.987759068,7.324263903,0,8.461941458,0,0,4.340878996,0,3.481491606,0,5.655688553,0,7.815334773,4.509413633,7.457997842,1.590756464,1.571621765,2.921997488,4.696976195,4.250242561,3.121377237,5.295339188,0,0,0,7.073830195,8.05915129,0,7.452805838,0,5.647119718,3.149587113,8.324504005,6.461304882,0,0,0,0,0,2.573009698,0,6.723164835,7.147760499,3.81913209,0,0,4.39624901,3.957082868,10.12927417,0,0,9.203721128,0,6.279421452,3.741049922,3.768880774,1.410544518,6.488403286],
    [5.650649495,7.786559409,0,6.209947215,7.130626517,3.149587113,0,0,0,3.317392333,3.645101145,0,6.204126486,7.722257608,8.561801236,0,1.731263898,0,2.573009698,7.677393395,3.416491096,0,0,2.168803591,5.3917542,0,0,0,4.085653677,0,7.055062168,3.5520836,7.782201014,8.218248321,4.28395827,3.958420896,1.361689044,8.082591378,5.399808132,0,0,6.190494334,6.886797487,0,0,7.58777499,0,0,0,4.666202349,3.949615895,0,0,0,0,0,7.111797466,5.352665029,8.930846828,0,9.64856054,5.444706535,9.066452874,7.416817859,9.900439642,6.902605057,5.237378775,7.013856313,2.331205908,8.29522395,7.997779953,7.353917933,1.590756464,2.790179778,4.519153412,8.29447179,4.446549919,4.036007806,8.293756619,2.534144363,4.646629049,0,7.903111157,7.588179213,0,9.364275888,0,6.783201494,3.149587113,7.114936233,9.579439147,0,0,2.172734535,0,0,0,0,7.651051691,7.777359249,0,0,0,6.989530728,4.183728784,9.613989597,0,4.30592258,7.122029412,2.62792129,6.711961034,2.357189199,8.934932351,7.080320379,8.011279515],
    [1.431779586,6.084022716,0,6.18060584,5.672425342,1.569736026,0,0,6.362483709,0,0,0,5.866479193,1.090815163,9.320103183,0,0,0,1.406082194,0,0,0,0,2.998738351,2.350033433,0,0,0,3.698665367,0,3.241876309,0,7.001336624,0,2.839992687,0,4.420089118,3.2188198,7.603985209,0,0,3.244061423,5.278343442,2.785322386,0,7.536333628,0,0,0,1.781999348,0,0,0,0,0,0,6.800223825,0,5.563655308,0,6.769037991,4.708466901,0,1.46012053,0,6.363800668,0,6.208306093,0,3.713829095,4.149781155,4.766795293,0,2.305904344,3.288643503,5.956457634,0,2.278309285,3.997747783,0,1.586888663,0,4.204912301,1.94753258,0,4.151712198,0,0,0,3.54885136,5.695345148,0,0,0,0,0,0,0,3.902410173,6.036836768,2.097168659,0,0,4.491209918,3.15801765,3.880683284,0,0,0,0,5.789549269,1.614406279,4.15721395,0,2.50408572],
    [5.323702816,6.850447992,0,3.991238804,0,1.569736026,0,0,0,0,0,0,0,3.155361395,9.661858648,0,0,0,6.135595009,6.959501133,0,0,0,0,3.201119623,0,0,0,2.936928025,0,5.491636093,3.260581391,5.438721383,2.98819618,5.081263325,0,9.658046096,8.856748825,5.517366013,0,0,6.876829072,6.80505227,2.785322386,0,4.804992012,0,0,0,3.427082841,1.959834467,0,0,0,0,0,6.636732821,3.272846047,5.868079443,0,0,3.127128728,9.275935723,5.304835782,0,4.723762163,0,3.801280408,0,8.238452992,8.927073162,4.671039943,0,0,0,1.167924869,2.711021318,1.834870601,4.500203927,0,2.324239181,0,0,1.94753258,0,7.222911731,0,0,0,2.482114093,0,0,0,0,0,0,0,0,3.902410173,3.032789935,0,0,0,3.796388312,0,0,0,0,0,2.62792129,0,0,2.871013559,0,1.354808925],
    [2.607242384,6.401691178,0,4.120471603,8.745710856,1.569736026,0,2.408805546,0,0,3.034610959,2.926124712,1.924937051,6.421993474,10.23423974,0,0,0,6.265054094,8.56049796,2.079226691,0,0,2.168803591,3.201119623,0,0,0,3.542563074,0,5.378828463,2.40377094,4.96653862,0,4.428536445,0,3.919218828,7.876959032,3.554918875,4.249294997,0,1.640918907,5.960643883,7.957358652,0,6.765756326,0,0,0,0,1.959834467,0,0,0,0,0,8.427453574,7.754250701,7.165837518,0,4.228198043,4.477456875,8.855373588,7.26081863,4.87292166,7.369874558,0,5.13412428,0,4.768852641,7.245588536,7.457997842,0,0,2.429204831,6.38014525,1.916065792,2.891124637,6.582585057,0,5.360369907,0,1.554826783,1.94753258,0,7.398674744,0,0,0,4.02596074,4.389821626,0,0,7.106872831,0,0,0,0,5.341092099,6.92706272,0,0,0,6.124491676,1.214748986,6.458718649,0,3.141551507,2.184629194,0,6.877908857,0,3.235888264,0,4.511395522],
    [2.136055426,2.618564793,0,1.316327062,0,0,0,0,0,0,0,0,1.924937051,2.134165238,4.216294965,0,0,0,0,1.612405897,0,0,0,0,0,0,0,0,3.698665367,0,0,2.40377094,2.546614229,2.367619226,0,0,0,3.751182392,1.481358206,0,0,1.640918907,2.29611755,0,0,1.885737479,0,0,0,0,0,0,0,0,0,0,0,0,4.537434131,0,1.385653692,0,4.941563173,0,1.529467388,1.430239906,0,1.121990524,0,1.594645054,0,2.168803591,0,0,1.674904626,1.804782814,0,0,1.413536412,0,0,0,1.554826783,3.258734268,0,4.744508356,0,1.241386551,0,2.02080583,4.509606186,0,0,0,0,0,0,0,1.733606582,3.466949588,0,0,0,1.950591407,0,5.142615319,3.154638024,0,3.016531724,0,1.377092695,0,3.976074161,0,6.972814312],
    [2.961840268,9.52399021,0,0,0,4.226241501,0,0,10.7586622,8.738122561,0,0,1.924937051,7.197341658,9.648371133,3.658543633,6.141710064,1.871675903,0,8.95078088,2.897552731,0,0,0,7.292208467,0,0,0,3.83951414,1.297324055,8.310216768,5.714304486,9.890175932,9.146901396,2.839992687,3.958420896,8.481225984,5.781795617,6.961807519,0,0,6.952815269,7.927797274,0,0,4.733705155,0,0,0,3.056075924,4.902157249,0,0,0,0,0,5.419236999,4.326546321,5.563655308,0,4.828801899,0,9.198411857,3.000947168,0,2.605196984,0,2.179323699,0,5.94500038,5.530636702,3.284108206,0,1.571621765,0,3.282169857,1.916065792,2.278309285,2.93651056,3.784457154,0,2.719532226,0,1.94753258,0,4.435972646,0,0,0,2.02080583,0,0,0,0,0,0,0,0,4.732344934,2.408805546,0,0,0,0,3.957082868,0,2.308177125,0,2.184629194,0,0,0,2.871013559,0,1.354808925],
    [3.687570256,2.279780641,0,0,3.277337944,2.303636946,0,0,5.502552596,2.455308789,0,0,0,0,3.093845517,0,6.23354183,0,1.406082194,0,0,0,0,2.168803591,0,0,0,0,0,1.969178823,1.4287038,1.653483243,2.211623187,1.255175933,2.839992687,0,3.14556229,3.594588248,3.759667491,0,2.017487427,3.535209466,2.29611755,3.676698353,0,0,0,0,0,0,0,0,0,2.047816235,3.96333911,0,4.947233483,1.450539436,0,0,0,1.5529849,0,1.46012053,0,3.244061423,0,1.745427173,0,0,0,0,0,0,0,0,0,0,2.113629503,1.377092695,0,0,2.285688951,0,0,0,0,3.199364361,0,1.338596694,3.046059362,0,0,1.461730735,0,0,1.797115738,0,0,2.754273197,0,0,0,1.282537517,3.357133596,2.975444667,3.154638024,0,4.227317234,0,0,1.614406279,3.235888264,0,4.051052201],
    [0,0,0,0,0,0,6.740374481,3.266140317,0,3.317392333,1.28620039,2.104447385,0,0,0,3.418179486,0,2.659730269,0,1.612405897,4.347299885,0,0,4.208089373,0,0,2.439564301,3.730089796,0,1.297324055,1.4287038,0,0,0,3.203757507,0,0,1.254014401,0,0,0,1.640918907,0,0,0,2.334318467,2.83110867,0,2.476695351,0,5.157127848,0,2.621674279,0,0,0,2.801189549,0,0,2.172734535,0,2.283469031,0,0,1.529467388,0,0,0,2.331205908,0,0,0,2.328878064,0,0,0,4.022952592,1.191371277,0,2.885530704,0,7.96886519,0,0,0,0,3.510786446,0,0,2.02080583,0,0,0,0,3.605634704,6.225458174,4.378648964,0,0,0,3.437769124,4.113062664,3.417546061,0,0,0,0,0,0,0,0,0,0,0,0],
    [6.141790552,6.42345892,0,1.316327062,8.180557832,0,0,0,0,0,0,0,1.262193429,3.620520142,5.176956182,0,0,0,5.221244134,4.794362379,0,0,0,0,0,0,0,0,1.221294271,0,6.065870567,0,3.046826728,0,2.839992687,0,0,5.209885343,5.45978414,0,0,0,2.91052254,0,0,6.205085147,0,0,0,0,0,0,0,0,0,0,8.938262967,5.084444573,6.33323819,0,1.385653692,1.5529849,2.679289883,8.477825594,6.292017702,4.977668006,0,4.545532356,0,4.26166757,2.94488983,4.338479271,0,0,0,5.309371451,2.367619226,2.617013534,5.46797168,2.068632354,2.809830944,0,4.814129086,1.94753258,0,5.915397533,0,0,0,5.727587442,5.793023474,0,0,5.173436064,0,0,3.446387271,0,5.767876484,5.206312682,0,0,0,3.639384767,0,5.142615319,0,3.141551507,0,2.62792129,4.215048346,0,3.526859546,2.109945405,4.780297015],
    [4.528027849,0,0,1.316327062,9.957796024,0,0,0,0,2.455308789,0,0,2.377347064,6.514050916,0,0,0,0,5.456290025,0,0,0,0,0,0,0,0,0,0,0,4.413090928,1.653483243,0,0,2.35241283,0,0,2.709327299,2.196679237,0,0,0,0,0,0,5.549117811,0,0,0,0,0,0,0,0,0,0,0,3.510786446,8.103676361,0,6.32250971,0,0,8.657504609,4.563250245,7.309495623,0,2.179323699,0,2.819792025,0,1.458514165,0,0,2.429204831,5.166422948,2.98819618,2.617013534,6.113109407,1.377092695,0,0,3.129602515,1.94753258,0,5.752299708,0,0,0,3.54885136,0,1.866117748,0,0,0,0,5.974556572,0,5.06859083,0,0,0,3.417546061,7.837903493,0,7.928150758,0,1.358928018,0,1.844254505,8.616084908,1.614406279,0,0,4.511395522],
    [0,1.192413264,5.640960842,0,3.277337944,5.999822492,0,0,0,0,4.072735074,3.827953141,5.377104329,5.38121297,3.093845517,0,4.729119939,1.871675903,0,0,0,0,0,0,0,0,0,0,2.32039045,4.208884861,2.13227898,8.344448314,0,2.711021318,1.61041097,0,2.049532294,1.254014401,0,0,1.335934953,1.640918907,0,1.567855244,0,3.558472286,0,0,0,1.781999348,0,0,0,0,3.052984456,0,0,0,1.511899039,0,0,0,0,1.46012053,0,0,0,1.121990524,0,0,1.419561476,0,0,0,0,1.167924869,0,1.191371277,0,0,0,0,2.7684921,0,0,0,0,6.486660821,0,7.80891007,0,0,0,0,0,0,0,0,0,2.408805546,0,0,0,2.750747772,7.269000032,9.073492069,0,3.914995645,3.016531724,7.028278272,2.885530704,1.614406279,5.745010823,0,3.908687227],
    [7.513047234,1.836204539,0,1.316327062,7.666571366,0,0,0,0,0,1.95520039,0,0,6.956101292,9.018444845,0,0,0,2.573009698,4.897559156,0,0,0,0,0,0,0,0,3.36749764,0,0,0,1.774547779,0,3.203757507,0,0,3.2188198,3.030063897,2.001082698,0,0,1.204003557,0,0,4.102028745,0,0,0,3.056075924,0,0,0,0,0,0,1.994606741,5.727731737,7.029338358,0,8.129449216,8.398987583,9.596139378,7.488916433,0,7.111533576,4.376707911,4.748587514,0,3.920428048,7.978746384,5.591044963,0,3.888178831,3.823534849,2.581961262,1.916065792,4.245781516,7.220006033,2.534144363,5.360369907,0,6.524898516,0,0,7.247621306,0,0,0,4.383889211,7.295354359,0,0,10.07439971,0,0,0,0,6.59019535,5.720391696,0,0,0,3.796388312,2.926952007,8.8977624,0,2.509654215,4.477456875,6.390625634,7.637226708,0,8.871499998,0,5.834781143],
    [4.980037718,3.321557174,0,4.3486622,0,10.36836037,0,2.408805546,9.472405736,0,0,3.446387271,0,5.787570587,0,0,7.24614264,0,2.926124712,8.883234114,4.09837174,0,2.8815524,0,9.092973707,0,0,0,4.920973241,1.297324055,8.71640022,6.995591271,9.720440958,2.711021318,4.791503894,3.573991383,9.895324406,9.311405547,9.851653902,2.001082698,0,8.562695176,9.407195738,0,0,5.17154437,2.02080583,0,0,3.056075924,4.408114953,0,0,2.047816235,3.96333911,0,0,0,3.358854664,0,0,0,0,5.099082918,0,6.633795685,0,4.748587514,0,0,0,4.856588768,0,0,4.212869647,5.115442623,2.711021318,2.617013534,1.413536412,0,0,0,0,0,0,0,1.450539436,0,0,0,0,0,0,0,2.719532226,0,0,0,0,1.953661285,0,0,0,0,0,0,0,0,0,0,0,0,0,2.109945405,2.50408572],
    [4.417752244,4.430656786,0,2.799346774,3.811828399,4.501664819,0,0,6.805259412,2.455308789,0,0,4.15244441,3.327622416,6.735083971,0,0,0,0,0,0,0,0,0,0,0,0,0,1.221294271,0,0,0,4.510440908,0,3.494023898,0,2.049532294,5.545547456,5.821596845,0,0,2.388819979,2.635783143,0,0,2.334318467,0,0,0,0,0,0,0,0,0,0,1.994606741,3.893829897,4.142957954,0,6.201254421,5.082447626,5.851917827,4.067107018,1.529467388,6.682220941,4.870295053,3.674088391,0,5.223562965,5.679515464,5.168523102,0,0,0,3.282169857,2.367619226,4.144704051,4.390029428,1.377092695,4.757668911,0,7.134784472,1.94753258,0,3.32657446,0,5.480788824,1.569736026,4.754560657,5.884505736,0,0,0,3.605634704,0,0,0,7.823885596,2.408805546,0,0,0,6.620897252,0,3.880683284,0,5.01341333,10.86866387,7.489899942,0,5.400439335,7.253412105,0,6.053557998],
    [3.687570256,5.97031664,0,5.013309151,4.759526397,4.932040333,0,0,5.149046272,0,0,0,0,4.165843825,7.778688025,1.554826783,0,0,1.406082194,3.945166829,0,0,0,0,0,0,0,0,4.642010819,0,2.13227898,1.653483243,7.168493046,4.446549919,2.35241283,0,0,3.594588248,8.709300025,0,0,0,2.91052254,1.567855244,0,3.383215216,0,0,0,0,0,0,0,0,0,0,3.315453761,6.640777491,3.983204757,0,7.004718846,6.256165336,7.251258487,3.524550291,3.095446785,6.583688373,3.918795874,5.272286719,0,4.96823042,7.180442304,6.112321025,0,0,0,5.215663106,1.255175933,2.617013534,3.997747783,0,6.231668497,1.517123172,4.480124818,3.258734268,0,6.19491568,0,0,0,5.502792276,8.093984257,0,0,2.172734535,0,0,0,0,1.733606582,5.261392475,0,0,0,4.491209918,3.15801765,7.352894406,0,4.057402811,9.810833675,4.441310078,4.895011416,0,6.516114704,0,5.711546368],
    [0,1.192413264,0,0,2.911066272,0,0,0,0,0,0,0,0,1.090815163,3.093845517,0,0,0,1.406082194,3.738300805,0,0,0,0,0,0,0,0,1.873071327,0,2.957578397,0,2.818292015,1.255175933,1.61041097,0,0,1.254014401,2.672729483,0,0,1.640918907,8.220436663,2.785322386,0,1.231253532,0,0,0,0,0,0,0,0,0,0,0,0,3.358854664,0,2.897552731,1.5529849,5.782776899,2.170766959,4.443256343,1.430239906,0,3.380142709,0,1.594645054,0,2.168803591,0,0,0,2.854876154,1.255175933,1.834870601,0,0,1.586888663,0,1.554826783,0,0,1.840219556,0,0,0,1.338596694,2.210938675,0,0,0,0,0,0,0,1.733606582,2.408805546,0,0,0,1.950591407,0,0,0,0,0,0,0,0,3.235888264,2.109945405,2.50408572],
    [0,1.192413264,0,4.718927108,6.777362535,0,0,0,0,0,0,0,0,5.077600277,3.761584641,0,0,1.871675903,4.686639201,6.017610364,0,0,0,0,0,0,0,0,2.936928025,0,1.4287038,0,1.144473079,0,2.35241283,0,0,1.914596325,1.481358206,0,0,0,2.29611755,3.436052901,0,3.383215216,0,0,0,0,1.959834467,0,0,0,0,0,4.947233483,5.774158984,2.233797185,0,0,0,4.105696197,4.340878996,2.25507312,6.477929732,0,2.782901878,0,0,2.121043177,4.338479271,0,0,0,2.854876154,1.255175933,1.191371277,3.997747783,0,3.462057566,0,0,0,0,4.042983171,0,0,0,2.02080583,0,0,0,4.46287892,0,0,0,0,2.498547749,3.266140317,0,0,2.546614229,4.185230436,0,5.475028474,0,0,2.184629194,0,7.566041877,0,6.787558938,0,3.750720028],
    [3.687570256,5.305985521,0,1.992995304,7.727032551,1.569736026,0,0,0,0,2.410489481,0,4.45805522,4.754283611,4.839868457,0,0,1.871675903,6.619995957,8.70975751,0,0,0,0,0,0,0,0,3.168216406,0,6.300749355,0,6.557966617,1.255175933,4.428536445,0,0,7.893860328,3.316228807,1.322794318,0,1.640918907,7.856545239,0,0,6.835514181,0,0,0,1.781999348,2.76135907,0,0,0,0,0,4.452563965,8.382648374,9.24449598,0,8.070077652,4.042109164,7.442719388,6.253733669,2.25507312,8.132684881,3.918795874,5.621620971,0,4.768852641,6.865150378,4.856588768,0,0,0,6.636678857,2.98819618,3.494361381,7.497456681,0,6.34270266,0,3.864522096,3.635588574,0,7.132934991,0,3.199364361,0,6.060679408,7.360534445,0,0,3.731259476,0,0,0,0,5.497805431,8.12049114,0,0,3.046826728,7.269548707,1.214748986,7.038203308,0,0,0,1.844254505,7.398586627,2.845102004,7.386429788,8.413487598,3.37097252],
    [7.113963214,2.279780641,0,1.992995304,0,7.993997007,0,0,5.849254867,0,1.95520039,0,1.262193429,2.464609202,7.067873466,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2.211623187,0,3.494023898,0,0,3.751182392,2.672729483,0,0,0,4.361537796,0,0,1.231253532,0,0,0,1.781999348,2.76135907,0,0,0,0,0,0,4.052930578,4.417540006,0,4.654982428,7.828489476,0,1.46012053,0,5.648250932,4.165843825,3.801280408,0,6.281098735,6.96524287,2.998738351,0,0,1.674904626,4.472293286,1.916065792,3.649991709,2.582960703,0,7.142419168,0,5.241142513,0,0,1.840219556,0,0,0,4.834050577,8.265451259,0,0,0,0,0,0,0,0,5.314446514,0,0,0,4.491209918,2.311215911,3.637105643,0,0,0,0,1.377092695,2.357189199,7.422286123,0,0],
    [2.136055426,8.315062227,0,1.316327062,1.666262603,4.065919631,0,0,9.757443382,7.303330271,1.95520039,0,2.377347064,6.363800668,7.827378613,2.285688951,6.093504883,0,3.209582046,8.112283967,0,0,0,0,6.573833402,0,0,0,3.542563074,2.772076473,8.756463191,5.143016366,8.138894678,8.39508396,4.428536445,3.958420896,9.466456685,7.207643056,9.417421538,0,0,10.37654851,7.49922223,0,0,2.676004571,0,0,0,2.555337332,3.650844232,0,3.499434968,0,3.052984456,0,4.947233483,7.070913857,5.383384298,0,4.228198043,1.5529849,8.438567099,5.540217969,2.735603919,3.685313026,0,2.179323699,0,5.299531819,4.961195168,3.284108206,0,0,0,4.829414324,0,1.834870601,4.787761347,0,0,1.517123172,2.285688951,2.74723393,0,4.042983171,0,0,0,2.02080583,2.210938675,0,0,0,0,0,0,0,2.995800011,4.0707841,0,0,0,3.639384767,3.688072423,0,2.308177125,0,2.184629194,3.132909221,0,0,1.634715536,0,4.299507612],
    [1.431779586,0,0,1.316327062,3.277337944,3.149587113,0,0,0,0,2.410489481,0,4.924604901,6.150894666,0,0,0,0,1.406082194,0,0,0,0,0,4.677517484,0,0,0,3.698665367,1.969178823,4.020451209,0,6.359552821,0,1.61041097,0,0,5.262888697,1.481358206,4.555970876,6.353899882,0,1.204003557,1.567855244,0,6.57500401,0,0,0,0,0,0,0,0,0,0,0,6.135947076,3.983204757,0,3.797347749,0,0,3.728921218,3.383215216,3.244061423,0,3.010569242,0,3.182820685,0,0,0,0,1.674904626,5.115442623,1.255175933,1.191371277,4.951871382,0,2.809830944,0,5.085158479,1.94753258,1.385653692,2.897552731,0,6.274231146,0,3.72600458,7.511659395,0,0,0,0,0,0,0,0,1.284976959,0,0,0,1.950591407,4.845042531,0,0,2.85992601,0,0,0,0,5.025868086,0,1.354808925],
    [7.041440688,1.192413264,0,4.873613724,0,0,0,0,0,0,1.28620039,0,5.051712816,1.704821959,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2.32039045,0,0,0,0,1.916065792,1.61041097,0,0,4.911014295,0,0,0,0,2.635783143,0,0,6.066901519,0,0,0,0,0,0,0,0,0,0,0,1.450539436,3.358854664,0,4.744508356,0,1.888578717,2.644765483,2.25507312,0,0,3.534588978,0,0,0,5.096632231,0,0,0,3.751552406,2.98819618,2.617013534,1.413536412,1.377092695,0,0,5.241142513,0,0,2.623232518,0,5.994484645,1.569736026,5.957962862,6.872243316,0,0,0,0,0,1.797115738,0,6.280662885,4.298523491,0,0,0,3.262431434,0,6.495772719,0,0,9.390626345,0,2.068632354,2.845102004,7.76713902,0,1.354808925],
    [3.246250636,5.258332895,0,1.316327062,0,6.085958554,0,0,4.371867824,0,0,0,0,4.870295053,6.39084947,0,0,0,1.406082194,4.794362379,0,0,0,0,0,0,0,0,2.936928025,0,0,1.653483243,5.074147944,2.367619226,1.61041097,0,2.863826449,2.709327299,6.688607531,0,0,0,2.635783143,0,0,0,0,0,0,0,1.959834467,0,0,0,0,0,0,1.450539436,3.358854664,0,4.559531286,5.379168854,7.199141747,2.170766959,0,6.882021243,0,3.380142709,0,5.896898074,6.405177105,3.522245428,0,0,0,0,2.711021318,1.191371277,3.220247532,0,3.909586503,0,0,1.94753258,0,3.32657446,0,0,0,1.338596694,0,0,0,0,0,0,0,0,3.658543633,4.49516583,0,0,0,1.282537517,0,0,0,0,0,0,0,0,3.976074161,0,1.354808925],
    [0,4.247537068,0,0,2.911066272,0,4.299507612,0,6.273416669,12.8008047,0,0,0,0,0,9.111984814,8.817354675,0,10.41191995,2.354798077,0,0,0,0,0,1.962937906,0,0,0,0,0,4.183278629,0,1.255175933,10.35651976,3.573991383,2.049532294,6.370119833,4.891119492,0,1.335934953,9.688517039,0,6.916988055,0,0,0,0,0,4.798531072,4.755505094,0,3.499434968,0,0,0,0,0,4.537434131,0,0,7.483410394,0,0,0,0,0,0,0,3.472619051,0,4.064733345,0,2.305904344,1.674904626,1.167924869,3.753033567,5.048429162,0,4.334091189,0,0,0,3.635588574,3.18023001,0,0,0,0,4.754560657,5.149046272,0,0,5.487346431,0,0,0,0,6.443714578,3.466949588,2.097168659,0,7.371984904,1.282537517,0,0,0,0,0,2.62792129,0,4.128858007,0,7.885630615,5.794861186],
    [6.176069411,5.562929062,0,0,3.811828399,0,0,0,0,0,0,0,1.262193429,3.327622416,1.812524025,0,0,0,0,4.431364327,0,0,0,0,2.350033433,0,0,0,2.661346394,0,5.378828463,5.384482695,3.83967659,7.658993826,0,0,0,5.411129491,5.727139723,0,0,2.388819979,3.340058983,0,0,2.334318467,0,0,0,2.555337332,0,0,0,0,0,0,0,1.450539436,3.598259323,0,4.347299885,0,6.905915472,3.286373665,0,2.605196984,0,3.801280408,0,3.472619051,2.590991323,5.096632231,0,0,0,1.804782814,1.916065792,2.278309285,4.787761347,0,0,0,0,0,0,4.744508356,0,0,0,0,0,0,0,0,0,0,0,0,0,1.953661285,0,0,0,3.262431434,1.214748986,2.479401066,0,0,0,0,4.215048346,0,1.634715536,0,4.511395522],
    [3.687570256,5.814292081,0,1.316327062,1.666262603,3.149587113,0,0,2.56708501,2.455308789,0,0,0,4.813455122,5.450009229,0,0,0,0,5.397538194,0,0,0,0,2.350033433,0,0,0,1.221294271,0,3.683059916,2.40377094,4.510440908,5.50407377,0,0,0,4.349831029,6.110621289,0,0,3.535209466,3.340058983,0,0,2.334318467,0,0,0,0,2.76135907,0,0,0,0,0,5.20245281,2.159049313,5.317915032,0,5.626062257,2.283469031,5.633682545,4.210477304,6.326344685,4.022743956,1.935406473,3.207157908,0,3.920428048,5.24225651,4.064733345,0,0,0,5.703825922,2.367619226,1.191371277,4.140691561,0,1.586888663,0,2.7684921,1.94753258,0,5.445615649,0,0,0,2.02080583,5.149046272,0,0,1.461730735,0,0,0,0,0,4.584271389,0,0,0,0,0,5.398826835,0,1.358928018,3.016531724,3.132909221,0,0,4.46287892,3.834609931,1.354808925],
    [5.87590186,2.279780641,0,0,5.609580256,1.569736026,0,0,0,0,3.267999173,0,0,5.028499229,7.843250355,0,0,0,1.406082194,4.12605646,0,0,0,0,0,0,0,0,3.168216406,0,0,0,1.774547779,0,2.35241283,0,0,1.914596325,2.672729483,0,0,0,3.141217906,2.785322386,0,2.952062239,0,0,0,0,0,0,0,0,0,0,0,3.893829897,4.936856017,0,6.293137868,6.917940459,6.804915877,5.36737841,0,4.296021802,2.733293055,4.616440732,2.331205908,4.101113517,5.530636702,5.642443069,0,0,0,2.581961262,1.255175933,2.278309285,5.412691363,0,5.78419553,0,4.71115338,0,0,6.061915528,0,0,0,3.883764286,5.793023474,0,0,7.904462971,0,0,0,0,4.600258688,3.266140317,0,0,0,1.282537517,1.214748986,6.731497682,0,1.358928018,3.924517728,4.25812051,4.444055644,0,6.702628384,0,5.794861186],
    [2.607242384,0,0,1.316327062,0,1.569736026,0,0,0,0,6.99569599,0,5.168523102,3.863871272,4.399205452,0,0,0,2.104447385,0,0,0,0,0,0,0,0,0,0,9.153585267,3.683059916,0,3.712214701,4.250242561,1.61041097,0,3.14556229,1.254014401,0,3.524879916,4.576876036,0,0,0,0,5.059399127,0,0,0,3.056075924,2.76135907,0,0,0,0,0,0,4.556449605,3.803533211,0,1.385653692,0,1.888578717,0,1.529467388,3.685313026,0,4.026279325,0,5.058456442,2.590991323,2.168803591,0,0,0,3.996623167,0,1.191371277,6.702676902,0,0,0,4.600258688,0,2.079226691,1.195550809,0,5.016937469,1.569736026,0,6.400616031,0,0,0,0,0,0,0,0,1.953661285,0,0,0,3.02915668,5.478749586,1.717354877,0,3.579495955,0,0,0,0,2.871013559,0,4.511395522],
    [5.383601619,2.279780641,1.784498863,0,3.277337944,4.370515798,0,0,0,2.455308789,3.943779694,0,3.43165101,0,3.466007268,0,4.729119939,1.871675903,1.406082194,0,0,0,0,5.020970229,0,0,0,0,1.873071327,2.772076473,2.957578397,4.620888419,0,5.58966543,0,0,2.863826449,3.418903812,3.030063897,0,2.017487427,3.777352843,2.29611755,3.436052901,0,3.183685535,0,0,0,0,0,0,0,0,4.517137731,0,0,0,3.598259323,0,0,0,0,0,2.735603919,0,0,1.121990524,0,1.594645054,0,1.458514165,0,0,0,0,0,0,0,0,0,0,6.430809089,4.392317423,3.797347749,0,0,2.690869819,1.569736026,4.274159055,3.571590925,0,0,0,0,0,0,0,0,3.643192729,0,0,0,1.950591407,0,5.918781383,0,0,0,2.62792129,3.784457154,0,5.905624518,0,2.85410132],
    [3.246250636,5.105134247,0,1.992995304,6.04913827,0,0,0,0,6.931638542,0,0,2.721242624,5.171056616,3.093845517,0,1.731263898,0,5.087602875,7.316835547,2.079226691,0,0,0,0,0,0,0,3.542563074,0,3.861596037,0,4.723762163,0,2.35241283,0,3.583640746,5.952842061,3.030063897,1.322794318,0,0,5.867065253,0,0,5.590057368,0,0,0,1.781999348,1.959834467,0,0,0,0,0,3.693798993,6.536898672,6.923272455,0,7.26890038,2.283469031,4.941563173,5.170977372,1.529467388,4.897896718,0,3.380142709,0,2.333539385,3.228850911,3.284108206,0,0,0,3.996623167,1.916065792,2.891124637,7.137165915,0,1.586888663,0,1.554826783,0,0,4.744508356,0,0,0,4.581096904,3.046059362,0,0,0,0,0,0,0,3.658543633,5.553883032,0,0,0,4.185230436,0,4.577929995,0,0,0,0,3.606691969,0,4.46287892,6.240826923,3.135561463],
    [4.168154907,0,0,1.316327062,0,2.787748346,0,0,0,2.455308789,6.70869935,0,5.424856331,4.336928853,4.839868457,0,0,0,1.406082194,0,0,0,0,2.168803591,2.350033433,0,0,0,3.36749764,8.746754231,5.191128124,0,6.154168349,2.98819618,2.839992687,0,0,4.771663215,2.672729483,4.358925044,7.172854332,0,0,0,0,6.447138937,0,0,0,0,1.959834467,0,0,0,0,0,0,6.33490259,3.803533211,0,1.385653692,0,0,0,4.168411949,2.959707294,1.935406473,4.220876189,0,5.143370329,3.84803047,0,0,0,0,4.696976195,1.255175933,1.834870601,6.834720806,1.377092695,0,0,9.044754155,0,2.079226691,1.840219556,0,7.985201254,1.569736026,3.346859325,8.290754801,0,0,0,0,0,0,0,1.733606582,1.284976959,0,0,0,4.185230436,7.231446308,0,0,6.02597568,0,0,2.068632354,0,3.526859546,0,4.180621815],
    [0,0,0,0,0,0,0,0,0,0,0,0,2.721242624,2.134165238,0,1.554826783,0,0,0,0,0,0,0,0,0,0,0,0,3.542563074,5.226629855,7.765415827,2.894869795,4.26001107,4.773589639,0,0,2.049532294,2.366007313,2.196679237,5.477144427,4.576876036,0,0,0,0,1.231253532,0,0,0,0,2.76135907,0,0,0,0,0,0,4.196215359,0,0,4.828801899,0,1.888578717,4.943561744,1.529467388,2.605196984,0,5.784442396,0,1.594645054,1.419561476,0,0,0,1.674904626,4.105131291,2.711021318,2.278309285,3.220247532,0,3.462057566,0,4.044732979,1.94753258,2.545649577,3.925386939,0,0,4.621878817,6.156566334,4.509606186,0,0,0,0,2.122906148,0,0,0,3.032789935,0,0,0,0,0,1.717354877,0,3.579495955,0,0,0,0,6.841522968,2.109945405,1.354808925],
    [8.593947481,3.321557174,3.430278729,8.661332089,4.362134417,5.758878943,0,0,0,0,5.87169476,2.104447385,4.785206658,6.239861435,5.364607625,0,5.49452847,0,2.926124712,1.612405897,0,3.771698401,0,0,0,0,0,0,3.83951414,3.051133618,3.683059916,1.653483243,6.154168349,6.675932571,4.28395827,5.075843758,6.572761196,5.154860176,4.372482843,7.007056739,2.827323338,0,5.460243622,2.785322386,0,5.706335436,0,0,0,1.781999348,3.273593502,0,0,0,3.96333911,0,1.994606741,5.470131927,0,6.471176049,4.09837174,5.625150633,1.888578717,2.170766959,3.623018727,1.430239906,1.935406473,2.512450001,0,2.333539385,1.419561476,1.458514165,0,0,2.921997488,4.105131291,0,2.617013534,3.839067509,2.885530704,0,0,7.501698346,1.94753258,2.079226691,3.127952731,0,8.291929194,0,5.049199103,8.7580297,0,0,6.471176049,0,0,4.686639201,0,6.51881324,5.462819554,0,0,0,3.796388312,7.353001114,3.637105643,4.627339227,4.613188524,0,3.506233059,4.215048346,0,1.634715536,6.108385753,5.262402246],
    [0,1.192413264,1.784498863,0,1.666262603,2.303636946,0,0,3.068526802,0,0,0,1.262193429,0,0,0,4.729119939,0,0,0,0,0,0,0,0,0,0,0,0,1.297324055,2.603155617,2.40377094,1.144473079,0,0,0,2.863826449,3.751182392,3.030063897,1.322794318,4.666202349,3.535209466,0,1.567855244,0,0,0,0,0,3.427082841,0,0,0,0,0,0,3.99325527,1.450539436,1.511899039,0,2.079226691,0,0,1.46012053,3.623018727,0,0,3.380142709,0,0,0,0,0,0,0,2.24508439,0,1.191371277,2.113629503,0,1.586888663,0,1.554826783,0,0,0,0,3.39914311,0,2.02080583,3.046059362,0,0,2.172734535,0,0,0,0,0,2.754273197,0,0,0,4.066891048,2.65168682,1.717354877,3.154638024,0,2.184629194,4.25812051,0,1.614406279,1.634715536,0,2.040985264],
    [4.630469553,2.279780641,0,3.991238804,0,0,0,0,0,0,0,0,1.924937051,1.704821959,0,0,0,0,1.406082194,0,0,0,0,0,0,0,0,0,4.085653677,0,0,0,0,0,3.203757507,0,1.361689044,5.097652814,1.481358206,0,0,0,1.204003557,0,0,5.059399127,0,0,0,1.781999348,0,0,0,0,0,0,0,0,6.299716816,0,6.769037991,0,0,3.728921218,0,0,3.244061423,4.748587514,0,0,0,7.045692847,0,0,0,6.291064457,3.220604739,3.319889474,2.113629503,0,0,0,8.458509941,0,0,5.528611646,0,4.423836784,1.569736026,6.156566334,9.774413392,0,0,0,0,0,0,0,4.454849206,6.068067857,0,0,0,6.534350268,0,8.998019113,0,1.358928018,6.74662152,5.003965693,6.055178464,4.565622299,5.854048158,0,2.50408572],
    [10.2981365,1.192413264,0,6.778640249,1.666262603,3.679313849,0,0,0,3.317392333,3.802156015,4.12941905,2.998738351,0,4.399205452,0,0,0,2.926124712,2.354798077,3.797347749,0,0,0,2.350033433,0,0,0,4.390486707,0,3.479267335,5.932766017,2.818292015,5.986713889,4.559936483,0,1.361689044,1.254014401,2.672729483,0,1.335934953,0,0,9.523119018,0,0,0,0,0,3.966628542,3.273593502,0,5.400439335,0,0,0,0,0,0,10.17415916,0,0,0,2.644765483,0,0,1.935406473,0,0,0,0,0,0,1.571621765,1.674904626,0,2.367619226,3.918449926,2.113629503,0,2.324239181,0,7.662137036,2.74723393,7.914819105,3.925386939,2.159049313,5.292751623,0,3.72600458,7.953171845,0,0,0,0,0,5.252805925,0,4.454849206,0,0,0,5.221862105,3.639384767,1.864734062,0,8.601220263,0,8.354210299,3.802541477,2.534144363,0,1.634715536,8.092616913,2.50408572],
    [0,3.123017576,0,0,1.666262603,2.787748346,0,0,0,2.455308789,5.0292177,2.926124712,2.377347064,1.090815163,1.812524025,0,7.352378887,0,1.406082194,2.842544351,0,2.383886536,3.780189712,2.998738351,0,0,0,0,1.221294271,5.169340701,2.603155617,5.932766017,0,4.619316948,0,2.212993723,0,3.2188198,3.759667491,2.460612703,2.47849835,4.723762163,2.91052254,4.619156995,0,2.334318467,0,0,0,0,2.76135907,0,0,2.047816235,0,0,0,0,0,0,0,3.127128728,0,0,3.8285856,2.134165238,0,2.512450001,0,0,0,0,0,0,0,3.45615723,0,1.191371277,0,0,2.324239181,0,3.129602515,6.288042101,4.828801899,0,0,7.172396808,1.569736026,4.834050577,2.688101136,0,0,0,0,0,1.797115738,0,6.323185711,6.098637164,0,0,0,1.282537517,2.311215911,6.879029412,3.154638024,2.85992601,0,6.200434909,5.297875843,1.614406279,0,3.834609931,3.135561463],
    [8.090889725,0,0,5.605554037,0,1.569736026,0,0,0,2.455308789,0,3.827953141,4.15244441,0,0,0,0,0,3.209582046,1.612405897,4.09837174,0,0,0,3.201119623,0,0,0,2.936928025,0,2.957578397,0,3.244061423,1.255175933,4.28395827,0,0,0,4.705403237,0,9.465143294,0,0,10.0118341,0,1.885737479,0,0,0,2.555337332,1.959834467,0,6.087681547,3.3791203,0,0,0,0,0,13.00158412,0,1.5529849,0,2.170766959,0,0,0,0,0,0,0,0,0,0,0,0,2.367619226,3.790456203,2.113629503,0,0,0,3.418179486,0,6.851950493,4.25281801,3.272846047,3.199364361,1.569736026,0,1.493074462,0,0,0,0,0,0,0,2.498547749,3.800230488,0,0,0,0,3.357133596,0,9.705618729,0,8.021619905,6.672938248,0,0,0,8.534565827,2.50408572],
    [8.345531382,1.192413264,0,4.718927108,1.666262603,1.569736026,0,0,0,2.455308789,0,2.104447385,0,0,3.093845517,0,0,0,2.104447385,2.354798077,0,0,0,0,0,0,0,0,1.873071327,0,0,4.489236399,0,3.89429641,0,0,0,0,1.481358206,0,2.017487427,0,0,6.794671193,0,0,0,0,0,3.056075924,0,0,4.041235755,0,0,0,0,0,0,7.861576702,0,0,0,0,0,0,0,0,0,1.594645054,0,0,0,0,0,1.167924869,1.255175933,2.278309285,0,0,1.586888663,0,6.669242158,0,5.424098546,1.195550809,1.450539436,3.199364361,0,2.482114093,7.155433513,0,0,0,0,0,1.797115738,0,4.110953646,2.408805546,0,0,1.774547779,0,0,0,5.597853824,0,6.16836095,1.844254505,0,0,0,6.108385753,2.040985264],
    [0,2.279780641,4.361761497,2.799346774,0,0,6.781809081,2.408805546,1.792044962,0,0,2.104447385,1.262193429,1.090815163,0,5.683348282,4.961735045,8.513181606,3.446387271,0,4.559531286,6.485549112,4.890564418,4.671039943,0,1.962937906,9.582116997,8.031969643,1.873071327,6.393868842,0,1.653483243,0,5.365339588,2.35241283,8.984288982,0,4.248348124,1.481358206,2.808592225,1.335934953,0,0,0,9.547138303,0,7.478729426,9.692349264,9.762514772,8.470286863,7.94640769,10.07343277,11.02477554,7.844486875,0,5.258031942,3.693798993,0,0,3.003160341,0,4.042109164,0,0,3.095446785,0,5.237378775,1.121990524,7.377840238,1.594645054,0,0,2.328878064,5.862927691,6.731497682,0,6.926779189,1.834870601,0,0,2.324239181,7.05762372,2.7684921,0,0,1.840219556,3.714983524,7.731045772,6.96596603,4.383889211,0,3.830611616,7.38363434,0,9.683396535,7.587028641,4.540847341,7.418426334,0,2.408805546,6.056881974,6.162938571,7.285066294,0,0,0,3.154638024,0,0,3.802541477,5.984140876,6.31016769,3.235888264,0,2.50408572],
    [0,0,2.558261645,2.451788443,0,0,4.299507612,0,1.792044962,0,0,2.104447385,0,0,0,1.554826783,1.731263898,0,2.104447385,0,3.797347749,5.690219044,4.080961764,0,2.350033433,0,4.22489809,5.457620072,0,0,0,1.653483243,0,0,0,0,0,2.709327299,0,0,0,2.388819979,0,0,3.643192729,0,5.34891761,0,0,3.966628542,0,2.782901878,0,2.047816235,0,0,1.994606741,0,0,0,0,0,0,0,0,0,0,0,0,0,2.121043177,0,4.256154097,1.571621765,4.519153412,0,0,1.834870601,0,1.377092695,0,4.150541524,1.554826783,0,2.545649577,0,2.159049313,0,0,0,0,1.866117748,2.335878518,0,3.605634704,5.479753142,3.741600477,0,0,1.284976959,0,0,5.125085065,0,0,0,0,0,0,0,4.085292151,2.357189199,0,0,0],
    [0,1.192413264,5.492166606,0,0,0,6.182912545,3.266140317,1.792044962,0,0,2.926124712,1.924937051,0,0,0,1.731263898,2.659730269,0,0,0,6.098254231,3.780189712,0,3.201119623,0,9.539862209,5.353228024,0,3.051133618,0,0,1.144473079,4.250242561,0,7.425502029,0,4.248348124,1.481358206,2.001082698,1.335934953,0,0,0,7.987966359,0,5.641825282,8.201698417,8.150280528,5.565032398,6.714880751,8.205146382,7.461542736,6.191805688,0,5.002518037,3.315453761,0,0,4.212869647,0,0,0,0,1.529467388,0,0,1.121990524,5.055632307,0,1.419561476,0,0,0,4.986490777,1.167924869,2.367619226,1.191371277,0,0,1.586888663,0,1.554826783,1.94753258,2.079226691,0,2.632106894,4.596479618,6.043533271,3.54885136,0,3.533813815,5.061286461,0,8.214753251,6.349381428,3.074803839,4.982411585,0,3.032789935,2.917885603,4.113062664,5.696201342,0,0,0,3.154638024,0,0,3.132909221,5.564557384,6.151840409,2.381429107,0,1.354808925],
    [7.857357954,3.920180613,7.93957203,8.165610958,4.019469864,7.19642303,0,0,0,0,5.835800508,4.591099532,4.45805522,6.74435877,4.839868457,0,9.848800824,4.294034089,3.827953141,1.612405897,0,4.717893295,0,0,5.243564207,0,0,0,4.295856043,3.485952495,5.645856511,4.741524853,6.316371941,7.50227595,4.559936483,7.330916878,6.499558063,4.61739878,4.372482843,5.859399538,5.988684687,6.148024087,6.184041275,6.417504392,0,4.658711917,0,0,0,2.555337332,0,0,0,4.868546822,5.892249192,0,3.99325527,5.578750391,5.02154553,7.343438992,4.347299885,6.917940459,4.499630447,0,5.047689826,2.134165238,3.620520142,3.380142709,0,2.333539385,0,2.642645028,0,0,0,5.520038125,2.367619226,3.121377237,4.698129705,2.534144363,0,0,6.104954231,0,4.09837174,4.042983171,0,8.839285436,3.149587113,7.362895574,7.899354181,0,0,7.178511976,0,0,4.195877697,0,5.941695955,6.157898619,0,0,0,6.318254678,8.880432722,5.863151442,5.475028474,6.495085564,5.444706535,3.802541477,3.16787499,0,4.59442283,5.800288227,5.711546368],
    [1.431779586,5.940432498,6.626431996,7.25750026,3.811828399,4.835876343,0,0,1.792044962,0,0,0,1.924937051,3.481491606,0,0,7.974873692,2.659730269,0,3.206401401,0,4.465781641,0,0,0,0,0,0,0,0,0,3.260581391,0,8.142379729,3.494023898,5.075843758,1.361689044,5.154860176,2.196679237,1.322794318,5.723265523,4.938333643,7.550290267,2.785322386,0,0,0,0,0,0,3.273593502,0,0,5.271184915,0,0,0,4.052930578,0,6.527134005,0,6.060998989,0,0,4.168411949,0,0,2.782901878,0,0,0,1.458514165,0,0,0,0,1.255175933,0,1.413536412,0,5.288216512,0,0,1.94753258,7.159220301,0,0,8.966701177,2.787748346,5.957962862,9.197725102,0,0,0,0,0,0,0,0,1.284976959,0,0,0,4.185230436,7.398893325,7.660872996,4.627339227,0,0,3.132909221,0,0,1.634715536,4.495623046,3.573305055],
    [10.02243611,6.189418066,7.507232477,7.214717226,5.070762648,6.988505781,2.85410132,0,0,2.455308789,5.0292177,5.749675863,1.924937051,4.415419518,3.761584641,0,8.802437647,4.083847062,2.926124712,3.738300805,0,5.119160024,0,0,2.350033433,0,3.835351761,0,4.562943583,6.785674076,2.957578397,5.384482695,7.093742069,7.209629115,2.839992687,8.451585789,4.706958126,5.817665772,3.759667491,8.001437781,5.498484395,5.03472903,7.262493039,6.844849094,8.883450879,4.733705155,0,0,0,4.919735396,0,0,0,4.059526708,4.517137731,0,3.315453761,3.893829897,4.537434131,6.222731361,3.416491096,8.156501226,3.859324912,0,5.409711144,4.723762163,0,1.745427173,0,0,2.121043177,2.168803591,0,1.571621765,3.823534849,2.581961262,1.255175933,3.319889474,3.220247532,4.5462288,5.132088854,0,4.600258688,3.258734268,7.855772737,0,0,7.953791502,5.649977479,7.478729426,9.827249035,0,0,7.213040249,0,0,5.658352903,0,6.191661802,7.729327733,0,0,0,4.958191223,7.589056155,7.08758421,4.627339227,7.132166813,4.477456875,4.603837708,6.972699994,2.357189199,5.687237536,7.655805104,4.051052201],
    [0,0,0,0,0,0,7.076349438,2.408805546,0,0,0,0,1.262193429,0,0,0,0,0,0,0,0,0,0,0,2.350033433,0,0,5.962310557,0,0,0,0,0,2.367619226,0,7.19430916,0,0,1.481358206,0,0,0,0,0,6.242462339,1.231253532,7.146418815,3.697779146,4.267898313,4.175777728,6.454590515,7.848070572,0,7.742586624,10.54114609,0,0,0,0,3.003160341,0,0,0,0,0,0,0,0,5.844275491,0,1.419561476,0,0,3.681934901,0,0,6.636252534,0,0,0,0,1.517123172,0,0,0,0,2.159049313,0,5.532179496,2.83110867,0,0,3.185417178,0,2.719532226,6.288749972,3.074803839,6.368640084,0,3.466949588,5.907284721,5.717825408,0,0,1.214748986,0,0,0,0,3.506233059,0,5.771046951,1.634715536,0,1.354808925],
    [0,0,1.784498863,0,0,0,0,0,0,0,0,0,0,0,0,1.554826783,0,4.083847062,1.406082194,0,0,0,3.399737138,0,0,0,5.351310615,4.83831456,0,1.969178823,0,0,0,2.367619226,0,5.973110282,0,1.254014401,0,0,0,0,0,0,6.624994981,0,4.02596074,6.683646032,6.598281987,3.056075924,5.470946812,6.658211483,5.566564109,5.920320184,0,4.691797695,0,0,0,2.172734535,0,0,0,0,0,0,0,0,5.739290647,0,0,0,2.328878064,1.571621765,5.621923334,0,4.446549919,0,0,0,1.586888663,2.719532226,1.554826783,0,0,0,2.159049313,1.241386551,4.621878817,2.02080583,0,5.145332406,2.335878518,0,6.202137508,4.152063608,0,3.485952495,0,0,2.917885603,2.68589141,4.656100179,0,0,0,0,0,0,0,1.377092695,0,2.381429107,0,0],
    [4.528027849,0,0,0,0,0,11.27474825,2.408805546,0,2.455308789,0,2.104447385,0,1.090815163,0,0,0,3.166510337,0,1.612405897,0,2.383886536,0,0,0,2.764919656,4.22489809,0,3.36749764,0,0,0,0,0,4.123261,8.580515542,0,0,1.481358206,0,0,0,0,0,2.754273197,0,5.957962862,9.692349264,4.267898313,4.919735396,4.197003578,0,6.193080749,2.047816235,0,13.65665317,1.994606741,0,0,0,0,2.766109149,0,0,0,2.134165238,3.918795874,0,9.173959161,0,0,0,2.328878064,0,0,0,2.367619226,4.869937275,0,0,0,2.719532226,0,2.74723393,2.079226691,1.840219556,9.833857474,1.241386551,2.303636946,4.485860075,0,0,14.14226438,3.003160341,4.150541524,9.549442283,0,3.868434131,0,4.747498523,0,0,3.417546061,0,0,0,0,0,3.924517728,3.506233059,0,1.614406279,0,0,2.50408572],
    [0,3.920180613,10.22177323,6.120069803,4.019469864,3.885528248,11.07881379,9.053036413,6.805259412,2.455308789,2.410489481,6.864329183,5.75880559,2.464609202,0,7.742668471,7.006861355,10.66474986,4.776242999,1.612405897,7.159220301,11.16247897,9.310062776,7.719664052,7.046005769,1.962937906,15.07231383,11.49866875,5.48997353,9.030297144,2.957578397,3.5520836,1.144473079,10.53089601,5.818683874,12.90639527,2.513383648,8.90339786,5.055632307,6.902298152,4.829800069,4.326810316,0,3.88288323,13.77679107,2.676004571,11.51097734,14.04722138,13.9249527,10.91822696,12.4368033,14.10529712,13.10581572,11.920207,5.485285785,10.10378464,8.884603388,0,0,8.208170172,0,3.655971809,2.679289883,0,5.409711144,2.605196984,7.63473928,2.512450001,12.40524442,0,6.255064165,0,7.524334779,8.029867113,11.77625986,4.551140085,8.942469768,6.896031158,0,4.444055644,3.909586503,8.082248174,6.462858902,5.019193565,6.658211483,4.598472787,7.928573538,10.14113656,12.32721446,9.707121629,3.776543493,11.23861009,10.90081487,3.91026138,14.12364955,12.55098721,9.078428271,12.00963584,3.902410173,7.617668006,9.823236711,10.11594834,12.29357811,3.46318473,2.65168682,5.805290094,6.803122871,2.046103514,4.227317234,7.550966038,10.36511003,10.67053762,7.71026267,2.932344535,5.075116721],
    [0,0,5.492166606,4.120471603,0,0,10.56215027,6.214821539,0,0,1.95520039,2.926124712,3.764198849,0,0,1.554826783,0,2.659730269,1.406082194,0,3.416491096,5.803545321,0,0,4.120471603,0,2.439564301,10.21446067,2.661346394,1.297324055,0,2.40377094,0,7.668860402,3.942394077,11.1760031,3.14556229,1.254014401,5.203290985,3.088736519,3.342887714,2.878908183,0,0,10.90729647,2.334318467,11.23528784,8.65176068,8.894471732,6.511656246,11.18819934,12.07045642,0,11.66562412,14.97337823,0,3.315453761,0,0,5.745010823,0,1.5529849,0,0,0,2.605196984,0,2.179323699,10.8293647,2.333539385,3.84803047,0,1.590756464,6.423117983,3.823534849,6.291064457,9.338345408,4.591353102,0,4.970459698,0,2.240129526,3.129602515,2.74723393,2.897552731,3.127952731,5.224779162,0,10.60008118,8.834968693,0,7.714209168,8.927274144,2.64689025,5.829492438,11.07595916,7.581909019,10.92167398,3.902410173,6.51597166,10.24957978,9.792578128,0,0,3.828838673,3.880683284,0,0,3.540808171,9.041403812,5.410529243,9.940230335,6.301857155,0,2.85410132],
    [2.607242384,0,3.725189149,1.316327062,1.666262603,0,5.911452658,3.266140317,0,2.455308789,0,0,0,0,0,1.554826783,0,4.083847062,1.406082194,0,0,3.238606292,5.785030695,0,0,1.962937906,5.351310615,4.674679689,1.221294271,3.819620521,1.4287038,0,0,0,2.35241283,5.795596951,0,2.366007313,0,0,0,0,0,0,4.189142917,0,2.02080583,8.444208985,5.678869408,4.666202349,5.562021792,2.782901878,6.771455434,3.3791203,0,11.49023737,3.315453761,0,0,3.526859546,0,0,0,0,0,0,6.682220941,0,3.18023001,0,0,0,0,1.571621765,2.429204831,0,1.916065792,0,0,0,1.586888663,2.240129526,0,1.94753258,1.385653692,0,10.29832866,3.199364361,4.501664819,3.111909342,0,5.679889633,4.103861162,5.880066808,2.719532226,4.401509522,0,7.298865258,1.733606582,2.408805546,0,4.113062664,4.510440908,0,0,2.479401066,0,0,0,0,3.16787499,1.614406279,2.381429107,0,2.040985264],
    [2.961840268,1.192413264,7.182436851,0,0,4.370515798,0,0,0,0,0,0,0,1.090815163,1.812524025,0,0,3.540808171,2.573009698,1.612405897,0,0,0,0,0,0,0,0,1.221294271,4.982411585,0,2.894869795,5.517092631,6.1646071,1.61041097,6.522135663,1.361689044,3.2188198,3.316228807,3.323227235,3.342887714,3.777352843,3.514784765,5.466692498,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3.526859546,0,0,0,0,3.623018727,0,0,1.121990524,0,0,0,0,0,0,0,0,2.367619226,0,0,0,0,0,0,1.94753258,7.253733135,1.195550809,0,5.607300033,0,6.411050936,4.993357104,0,0,3.526859546,0,0,0,0,4.600258688,3.032789935,0,0,0,2.750747772,6.606342866,0,0,4.057402811,3.016531724,0,0,0,1.634715536,3.656338884,0],
    [0,0,3.430278729,2.799346774,0,0,4.696111716,0,1.792044962,0,0,0,0,0,0,1.554826783,0,3.166510337,0,0,2.079226691,5.567226054,3.399737138,2.168803591,3.201119623,0,6.165840811,5.731922848,0,3.819620521,0,0,0,2.711021318,0,4.725443724,0,1.254014401,0,1.322794318,1.335934953,0,0,0,7.118225095,0,4.834050577,3.697779146,4.827679842,4.358409986,2.76135907,4.616440732,5.400439335,4.704781788,0,0,0,0,0,0,0,1.5529849,0,0,0,0,0,0,3.18023001,0,0,0,2.814800039,1.571621765,5.684779374,1.167924869,1.255175933,0,0,1.377092695,0,3.605634704,0,0,0,0,2.159049313,4.423836784,3.438628157,0,0,4.286771649,2.335878518,0,5.513892971,6.714614328,3.074803839,4.818179987,0,0,2.917885603,4.113062664,6.380668075,0,0,1.717354877,0,1.358928018,0,1.844254505,4.444055644,3.741049922,0,0,1.354808925],
    [1.431779586,0,0,0,0,0,0,0,0,0,3.943779694,0,1.924937051,0,0,0,5.824881237,0,1.406082194,0,0,2.383886536,3.399737138,0,2.350033433,0,0,0,0,4.842817613,0,4.956192292,0,2.711021318,0,2.212993723,0,2.986448755,0,2.460612703,1.335934953,0,1.851024161,1.567855244,0,1.885737479,0,0,0,0,0,0,0,0,0,0,0,0,1.511899039,0,0,1.5529849,0,0,2.735603919,0,0,0,0,0,1.419561476,0,0,0,0,2.24508439,0,1.191371277,0,1.377092695,2.324239181,0,0,3.934112064,2.079226691,0,0,4.889930328,1.569736026,3.883764286,2.210938675,0,0,0,0,0,0,0,4.600258688,4.0707841,0,0,0,0,1.214748986,5.318374759,0,1.358928018,0,5.791922011,4.215048346,0,1.634715536,2.109945405,2.50408572],
    [0,1.192413264,0,0,0,1.569736026,0,0,0,0,0,0,0,0,0,2.7684921,0,6.382784969,2.573009698,0,0,0,2.065128811,2.168803591,0,0,6.744089636,3.350844299,0,1.969178823,0,0,0,2.367619226,0,5.075843758,0,1.254014401,0,1.322794318,0,0,0,0,4.894120843,0,3.346859325,5.423449347,5.915538363,2.555337332,4.592240978,5.181663838,4.742717456,4.059526708,0,0,0,0,0,0,0,0,0,0,2.25507312,0,2.733293055,0,9.203861059,0,2.94488983,0,4.400587408,4.228932508,7.783314196,1.804782814,4.912947454,0,0,2.885530704,0,3.605634704,0,0,1.385653692,0,1.450539436,2.348450405,3.438628157,2.02080583,0,4.076645958,2.335878518,0,5.513892971,5.110908034,3.074803839,3.868434131,0,0,2.097168659,3.194114467,4.348406658,0,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,1.784498863,0,0,1.569736026,2.040985264,0,1.792044962,0,0,0,0,0,0,4.814129086,0,7.685009678,2.104447385,1.612405897,0,0,3.399737138,0,0,0,6.48374445,5.11862266,0,1.297324055,0,0,0,3.420716548,0,5.357552005,0,0,0,1.322794318,2.017487427,0,0,0,5.553883032,0,4.02596074,4.951406876,6.020745326,3.966628542,4.408114953,7.372481007,6.087681547,4.308067937,0,3.746566479,0,0,0,0,0,0,0,0,2.25507312,0,4.376707911,0,8.729236982,0,2.94488983,0,4.400587408,4.373221247,7.351210478,1.167924869,6.27207808,2.278309285,0,2.068632354,0,4.944631639,1.554826783,0,1.385653692,0,1.450539436,3.730999452,5.335214496,2.83110867,0,5.34633784,4.103861162,0,6.886531074,6.225458174,2.573009698,5.498815294,0,0,2.917885603,2.68589141,5.397879187,0,0,0,2.308177125,0,0,1.844254505,2.068632354,0,1.634715536,0,0],
    [0,0,2.558261645,1.316327062,0,1.569736026,5.140284292,0,0,0,0,0,1.262193429,2.134165238,0,5.627887308,0,4.083847062,1.406082194,1.612405897,0,0,0,0,0,0,0,5.11862266,1.873071327,0,0,0,0,1.255175933,0,5.697915317,0,1.914596325,0,0,0,0,0,0,4.189142917,0,5.957962862,3.697779146,6.29692668,2.555337332,5.157127848,5.753315082,0,6.420204441,8.51555597,0,0,0,0,0,0,0,0,0,1.529467388,0,0,0,6.611381826,0,0,0,2.328878064,4.373221247,3.823534849,1.167924869,7.154516178,1.191371277,0,0,0,1.517123172,0,0,0,0,1.450539436,0,5.469465561,3.883764286,0,3.533813815,4.408909843,0,0,4.799379421,0,5.263596571,0,0,5.078391452,4.113062664,0,0,1.214748986,1.717354877,0,0,2.184629194,0,2.068632354,5.087025329,1.634715536,1.410544518,0],
    [0,0,4.923142205,0,0,2.787748346,5.668012347,0,2.56708501,0,0,0,1.262193429,1.090815163,0,5.837982345,2.495790119,8.369759748,3.827953141,0,2.897552731,5.43276212,3.780189712,3.522245428,2.350033433,0,7.984204186,5.889527292,0,2.425775589,0,1.653483243,0,4.351732608,0,7.651051691,0,3.594588248,0,1.322794318,0,0,0,0,7.739062817,1.231253532,6.436743374,8.110870074,8.345187499,5.232099142,6.356229318,8.393579734,8.392538732,6.570521936,0,5.979837894,2.801189549,0,0,3.003160341,0,1.5529849,0,0,3.095446785,0,4.560645878,0,6.930355824,1.594645054,1.419561476,0,2.814800039,4.934790051,5.338912275,0,7.037541242,0,0,0,1.586888663,6.048255997,0,1.94753258,0,1.195550809,1.450539436,4.954831076,6.420308393,4.383889211,0,5.249332964,5.061286461,0,8.011133534,6.888130301,3.074803839,5.878311629,0,0,3.437769124,5.475028474,6.748696434,0,0,0,0,0,0,3.506233059,4.085292151,4.686067264,1.634715536,0,0],
    [0,0,3.969926522,0,0,0,6.697714591,2.408805546,0,0,0,0,1.262193429,0,0,0,1.731263898,2.659730269,0,0,0,4.465781641,2.8815524,0,0,0,8.507128066,4.985265729,0,1.297324055,0,0,0,2.98819618,0,6.734093742,0,1.914596325,0,2.460612703,0,0,0,0,6.92706272,0,4.980986765,6.59706008,7.10838124,4.358409986,5.647687167,7.21002666,6.837969244,6.062439534,0,7.850584827,1.994606741,0,0,0,0,0,0,0,0,0,2.733293055,0,2.331205908,0,0,0,0,1.571621765,4.212869647,0,2.711021318,0,0,0,0,0,0,0,1.385653692,0,2.987759068,3.39914311,5.335214496,1.338596694,0,4.778998396,7.48492479,0,5.829492438,5.584357216,0,3.868434131,0,0,2.917885603,3.866607,5.31255337,0,0,0,0,0,0,0,3.606691969,4.686067264,2.381429107,0,0],
    [0,0,0,0,0,0,0,0,0,0,3.267999173,0,9.497209808,0,4.561513432,0,0,0,0,0,0,0,0,0,0,0,0,0,4.856125012,4.318348466,5.740211665,0,1.144473079,2.98819618,3.735557761,0,0,0,0,5.52497401,3.1080144,0,4.361537796,0,0,5.506982492,0,0,0,1.781999348,1.959834467,0,0,0,0,0,0,7.245836901,4.750924052,0,1.385653692,0,0,0,5.409711144,2.134165238,0,3.010569242,0,1.594645054,2.121043177,0,0,0,1.674904626,1.167924869,1.255175933,1.191371277,4.500203927,0,0,0,8.573059998,1.94753258,3.955696773,3.50113091,0,1.898600356,0,6.411050936,4.259183612,0,0,0,0,0,0,0,0,2.754273197,0,0,0,4.491209918,7.353001114,5.475028474,0,6.808785458,0,4.603837708,0,0,5.687237536,0,4.780297015],
    [0,1.192413264,4.361761497,0,0,0,5.262402246,2.408805546,1.792044962,0,1.28620039,0,1.262193429,0,0,4.480124818,1.731263898,7.419646466,2.104447385,1.612405897,0,4.465781641,4.329717796,2.998738351,0,0,9.192467398,4.985265729,0,2.772076473,0,0,0,4.535518061,0,6.632003768,0,3.892431393,0,1.322794318,0,0,0,0,7.987966359,0,5.885183269,7.980122471,8.054415379,4.666202349,6.714880751,7.884439905,6.962448848,6.310520191,0,2.850235379,3.315453761,0,0,3.526859546,0,0,0,0,1.529467388,0,4.165843825,0,7.691011772,0,2.590991323,0,3.708455948,5.337986896,6.43506707,0,6.297739898,2.278309285,0,0,1.586888663,4.545126266,0,1.94753258,1.385653692,0,2.987759068,4.596479618,6.516506593,3.72600458,0,3.533813815,5.374546744,0,7.136117589,6.159261819,1.797115738,6.036192306,0,0,3.81913209,3.194114467,4.909566239,0,0,0,0,0,0,2.62792129,5.410529243,4.996742825,0,0,0],
    [1.431779586,1.192413264,7.880923178,5.25768292,0,2.787748346,9.542157984,5.462819554,4.679792075,3.317392333,0,3.446387271,4.924604901,1.090815163,0,5.78825675,5.161999879,8.937702497,3.64974824,2.354798077,4.908441047,9.346046121,7.004372567,4.856588768,4.425714633,2.764919656,12.38547351,9.607591278,3.542563074,7.267359987,0,0,1.144473079,8.277485709,3.735557761,10.5845355,2.863826449,6.65424923,4.241927639,6.769614506,3.721932779,1.640918907,0,0,10.93720469,0,9.287373505,11.17889217,11.33366338,8.647458426,10.02038587,11.53987154,11.64940898,9.985186151,0,9.531635732,6.35044447,0,0,6.412959757,0,3.655971809,1.888578717,0,3.8285856,1.430239906,6.21812878,0,10.06278604,1.594645054,3.84803047,1.458514165,6.15830744,6.046332965,9.315070092,2.24508439,8.211513698,4.428889598,0,1.377092695,2.324239181,6.792720629,4.480124818,5.545791903,4.744508356,3.127952731,6.424955845,8.41235756,10.18535347,8.179863449,1.493074462,10.97411484,9.712624461,2.172734535,11.26391502,10.90723852,6.643999024,9.896908992,2.995800011,5.149046272,8.963938347,9.392737401,9.695379979,3.02915668,2.311215911,2.479401066,4.071271565,0,3.016531724,5.219920851,7.465312124,8.258116734,6.301857155,3.99325527,2.85410132],
    [0,0,6.216253721,3.31351837,1.666262603,2.787748346,8.719596731,5.833762524,3.439917863,0,0,2.926124712,3.764198849,0,0,0,0,1.871675903,1.406082194,0,2.079226691,6.265837555,0,2.168803591,5.649049992,0,0,8.718517118,3.168216406,0,0,2.40377094,0,5.21183093,3.203757507,9.025139562,2.049532294,2.366007313,3.759667491,6.161294576,3.721932779,1.640918907,0,0,8.968666793,1.231253532,9.214980013,7.291756619,9.382984205,5.488721907,9.16303155,9.888832766,0,9.604422513,12.19448952,0,3.99325527,0,0,3.526859546,0,0,2.679289883,0,3.095446785,0,1.935406473,0,9.583325451,0,2.121043177,0,4.400587408,3.888178831,8.884143735,3.879285317,8.20474749,3.319889474,0,2.534144363,0,0,1.554826783,2.74723393,2.079226691,2.623232518,4.052930578,3.574592237,10.30242304,6.872926631,1.493074462,8.882335744,8.045256717,1.461730735,5.325751405,9.378142081,5.343548546,9.219744746,2.995800011,2.408805546,7.869050191,8.175142711,0,0,4.28496235,2.975444667,0,0,2.184629194,8.133361856,7.299661556,8.286974483,5.564249792,5.022772646,2.040985264],
    [0,0,1.784498863,0,0,0,0,0,0,0,0,0,0,0,0,3.129602515,0,5.829115441,0,0,0,0,2.065128811,0,0,0,4.22489809,3.730089796,0,1.969178823,0,0,0,3.220604739,1.61041097,3.048363022,0,0,0,1.322794318,1.335934953,0,0,0,2.754273197,0,2.83110867,2.804884553,4.267898313,1.781999348,3.273593502,4.616440732,4.434198304,3.3791203,0,3.746566479,1.994606741,0,0,0,0,0,0,0,2.25507312,0,3.918795874,1.745427173,5.626062257,0,1.419561476,0,2.328878064,3.152109798,4.650925763,0,4.69851443,0,0,0,0,3.078744666,0,0,0,0,1.450539436,1.898600356,4.370515798,3.111909342,0,3.533813815,3.716524438,0,5.513892971,4.152063608,0,3.868434131,0,0,3.81913209,3.194114467,3.95678572,0,0,0,0,0,0,1.844254505,0,0,0,0,0],
    [0,0,0,0,0,0,0,0,0,0,1.95520039,0,8.118541821,1.090815163,6.206805768,0,0,0,0,0,0,0,0,0,0,0,0,0,3.542563074,3.819620521,5.256446193,0,0,3.89429641,1.61041097,0,0,1.254014401,0,4.130643992,4.829800069,0,5.278343442,0,0,4.733705155,0,0,0,0,0,0,0,0,0,0,0,7.38696452,3.358854664,2.172734535,1.385653692,0,0,1.46012053,5.800045187,3.244061423,1.935406473,1.121990524,0,0,0,0,0,0,3.580737915,0,0,1.834870601,4.140691561,0,0,0,7.422423382,0,3.797347749,1.840219556,0,1.241386551,1.569736026,6.461986259,3.332623469,0,0,0,0,0,0,0,0,0,0,0,0,3.02915668,5.478749586,3.343879368,0,6.788505178,0,1.844254505,0,0,3.768880774,0,3.37097252],
    [0,0,1.784498863,1.316327062,0,2.303636946,0,0,0,0,0,2.104447385,0,0,0,3.864522096,2.992869351,3.540808171,0,0,0,3.238606292,2.065128811,0,0,0,4.783910899,2.024136906,0,1.297324055,0,0,0,2.367619226,0,0,0,2.709327299,0,0,0,0,0,0,0,0,0,0,4.267898313,0,1.959834467,4.926557629,5.715519796,4.059526708,0,3.746566479,0,0,0,2.172734535,0,1.5529849,0,0,0,0,1.935406473,1.121990524,0,0,0,0,0,1.571621765,2.429204831,0,2.367619226,0,0,0,0,3.366110529,0,1.94753258,1.385653692,0,1.450539436,2.348450405,3.438628157,2.02080583,0,3.830611616,4.408909843,0,3.605634704,5.366967571,0,2.963977331,0,0,0,0,3.417546061,1.282537517,0,0,0,0,0,0,0,0,0,0,0],
    [0,0,0,2.451788443,0,0,0,0,0,0,1.95520039,0,1.924937051,0,0,4.044732979,7.974873692,0,3.64974824,0,3.416491096,6.098254231,0,0,0,1.962937906,5.757485889,0,0,0,2.13227898,0,0,1.255175933,4.123261,0,0,6.345758458,2.672729483,0,0,5.03472903,0,1.567855244,0,0,0,0,0,2.555337332,0,0,0,0,0,0,4.636949199,0,0,3.526859546,0,0,0,0,0,0,0,0,0,0,1.419561476,0,0,0,0,1.167924869,1.255175933,1.191371277,0,10.54246637,0,6.341176101,0,3.635588574,0,0,10.83717288,0,0,6.461986259,4.389821626,1.866117748,5.061286461,0,8.91123296,11.75686132,9.875163881,4.632822139,8.017585323,6.036836768,10.63586677,6.107160206,1.774547779,0,0,0,4.841368559,0,2.184629194,4.25812051,9.985528256,7.203511989,0,1.410544518,0],
    [2.607242384,2.279780641,0,0,1.666262603,0,0,0,0,2.455308789,2.410489481,0,3.764198849,3.620520142,0,0,3.361872552,0,1.406082194,2.842544351,0,0,0,0,0,0,0,0,0,0,0,4.489236399,1.774547779,4.250242561,0,4.512111935,0,2.986448755,0,3.701772154,3.54482311,3.777352843,3.340058983,5.647196877,2.754273197,2.952062239,0,0,0,0,3.650844232,0,0,0,0,0,0,1.450539436,2.712718048,0,0,0,1.888578717,0,0,0,0,1.121990524,0,0,0,0,0,0,2.429204831,0,0,0,0,0,0,0,0,4.57634937,0,0,0,7.327489844,1.569736026,5.23638729,2.210938675,0,0,0,0,0,0,0,1.733606582,0,0,0,0,0,3.15801765,1.717354877,0,3.579495955,4.227317234,3.802541477,0,0,0,6.891718222,4.051052201],
    [0,0,0,0,5.609580256,0,0,0,0,0,3.267999173,0,4.547056303,5.028499229,3.093845517,0,0,0,0,0,2.897552731,0,0,0,6.854919464,0,0,0,5.689276823,6.804610833,3.479267335,3.794471647,2.211623187,0,0,0,0,2.986448755,0,0,5.498484395,0,0,0,0,3.85569963,0,0,0,2.555337332,0,0,3.499434968,2.047816235,0,0,0,0,2.233797185,0,0,0,0,1.46012053,2.25507312,1.430239906,1.935406473,2.179323699,0,4.101113517,2.590991323,3.284108206,0,0,4.650925763,0,0,2.617013534,0,0,0,0,6.897446821,8.605744063,0,3.50113091,0,5.292751623,4.501664819,4.383889211,4.259183612,0,0,0,0,0,0,0,8.672343107,4.49516583,0,0,0,3.02915668,2.65168682,2.479401066,0,10.12313979,0,4.603837708,7.224602755,0,6.548923282,0,8.266100547],
    [0,1.192413264,6.01278502,4.873613724,1.666262603,0,7.577664117,4.189142917,3.439917863,0,0,0,4.15244441,0,0,6.021335104,3.899283315,7.228204647,2.573009698,0,5.311418736,7.638886473,4.329717796,2.998738351,3.201119623,3.65468791,9.826675029,8.065395484,0,5.169340701,0,2.40377094,0,6.27207808,4.123261,8.495855027,1.361689044,4.843020605,2.672729483,4.460809457,4.021826362,0,0,3.147069949,8.935181988,0,7.551087933,9.213868199,9.291333673,5.488721907,8.290658139,9.547007911,9.835057386,10.6963653,0,7.549479764,3.693798993,0,0,4.212869647,0,0,0,0,3.623018727,0,5.980639838,0,8.475079652,0,2.94488983,0,5.13771792,4.624606221,7.853391641,1.167924869,6.733478455,2.891124637,0,0,1.586888663,6.202137508,0,5.712281331,2.897552731,0,4.928973727,7.277622004,10.2728869,6.872926631,2.210938675,8.176720638,9.46240706,1.461730735,8.614935993,9.792637462,3.98654611,8.997755545,3.364898134,1.284976959,7.889142362,7.206908181,7.512527651,1.950591407,0,0,2.308177125,1.358928018,0,3.802541477,5.984140876,6.151840409,3.526859546,2.109945405,1.354808925],
    [0,3.920180613,3.725189149,7.285333305,0,1.569736026,11.27111573,0,0,6.271148941,0,0,1.262193429,0,0,6.494212166,1.731263898,7.007415012,1.406082194,0,13.12184158,5.284465404,7.004372567,9.508335009,0,10.59425698,5.185796394,7.326512203,3.698665367,0,0,5.714304486,0,0,7.600050267,4.512111935,0,8.319941023,2.672729483,0,0,7.629603593,0,2.301374909,2.754273197,0,12.11181266,0,3.877609802,4.666202349,5.157127848,0,8.392538732,3.3791203,0,0,5.314912919,0,0,0,0,0,0,0,0,0,0,0,2.331205908,0,0,0,0,6.002620862,0,1.167924869,4.84495056,7.125561025,0,0,0,8.701375844,0,0,0,0,1.450539436,0,0,0,0,0,0,0,0,0,0,0,0,1.953661285,0,0,0,0,0,0,0,0,3.540808171,1.844254505,0,1.614406279,0,0,2.50408572],
    [0,1.836204539,3.969926522,5.365918206,0,2.787748346,3.750720028,0,0,3.317392333,1.28620039,2.926124712,1.262193429,0,0,5.736755885,5.49452847,4.083847062,0,0,8.308926148,6.00654801,4.541824162,7.173493692,0,9.407821936,7.324558932,4.278349686,1.221294271,0,0,6.946234867,0,0,4.990992123,0,0,5.781795617,0,0,0,5.125085065,0,0,0,0,7.376234936,3.697779146,2.476695351,3.056075924,2.76135907,0,2.621674279,5.149046272,3.96333911,0,4.636949199,0,0,3.526859546,0,1.5529849,0,0,0,0,0,0,0,2.819792025,1.419561476,0,7.357357291,6.550010548,0,1.167924869,3.420716548,9.668140814,0,10.39108571,1.586888663,7.365214591,1.554826783,1.94753258,0,0,9.869041819,0,1.569736026,5.34891761,4.259183612,0,4.103861162,0,6.886531074,10.42362357,8.158122222,2.963977331,5.63915138,3.466949588,8.693886794,5.287009679,7.968060061,0,2.311215911,0,3.154638024,0,3.016531724,0,7.705063709,5.715519796,0,0,0],
    [0,0,0,2.451788443,0,0,0,3.800230488,6.128572155,0,8.978988168,6.135595009,0,4.415419518,5.073105416,5.313234601,0,3.166510337,0,0,0,0,0,0,0,5.039316437,2.439564301,0,3.83951414,1.969178823,0,2.40377094,2.818292015,1.255175933,0,0,0,2.366007313,0,2.808592225,2.47849835,0,1.851024161,0,2.754273197,5.372648029,2.02080583,0,0,2.555337332,0,0,0,4.059526708,0,0,0,2.987759068,5.723882117,0,1.385653692,0,0,3.000947168,2.735603919,0,0,1.745427173,3.18023001,0,4.149781155,2.998738351,0,0,7.550004155,3.084284864,3.420716548,3.121377237,0,0,0,0,2.285688951,1.94753258,2.079226691,0,1.450539436,2.690869819,3.149587113,0,0,0,0,0,0,0,0,0,0,1.953661285,0,0,0,0,0,0,0,6.126344967,0,0,0,1.614406279,0,0,0],
    [0,0,2.558261645,5.466596974,0,0,0,7.118225095,0,0,0,2.104447385,0,0,0,1.554826783,0,0,0,0,2.079226691,2.383886536,0,0,2.350033433,7.245311565,3.300058915,6.539539444,1.221294271,3.819620521,0,0,0,6.322953225,2.839992687,0,0,1.914596325,0,3.088736519,0,0,0,0,0,1.231253532,0,11.10237258,3.340906893,4.798531072,1.959834467,0,0,0,0,0,0,0,0,0,0,4.042109164,0,0,1.529467388,0,11.9548966,0,0,0,0,0,5.736439364,0,0,0,1.255175933,2.278309285,0,0,0,1.517123172,0,3.258734268,4.228198043,1.195550809,5.946229733,2.348450405,3.679313849,3.72600458,2.210938675,0,0,2.172734535,0,0,0,11.2281929,0,3.466949588,5.984021501,8.188642594,3.95678572,0,1.214748986,0,2.308177125,0,2.184629194,3.132909221,3.606691969,4.289591121,0,0,1.354808925],
    [0,0,3.059175851,5.691272871,0,1.569736026,2.040985264,7.574821861,0,0,0,0,1.924937051,0,0,0,0,0,1.406082194,0,2.897552731,0,0,2.168803591,0,8.140366707,0,4.985265729,2.936928025,5.740877225,0,0,0,4.141069016,1.61041097,0,1.361689044,0,1.481358206,0,1.335934953,0,0,0,0,0,0,11.30716331,2.476695351,4.175777728,2.76135907,3.674088391,0,0,0,0,4.241111619,0,0,2.172734535,0,4.907541568,1.888578717,0,3.095446785,0,11.69951119,0,0,0,0,0,6.578446731,1.571621765,0,1.167924869,2.98819618,1.834870601,0,0,0,1.517123172,1.554826783,1.94753258,3.619450877,0,6.424955845,0,2.787748346,3.54885136,0,0,0,0,2.719532226,0,0,12.34003742,1.733606582,4.189142917,7.828006386,9.687147433,4.348406658,0,0,1.717354877,0,2.046103514,0,3.132909221,3.403903641,3.741049922,1.634715536,0,2.040985264],
    [1.431779586,2.618564793,9.572494082,8.354815942,1.666262603,3.679313849,0,4.49516583,4.371867824,6.271148941,0,11.93608274,0,0,0,1.554826783,2.992869351,4.919116898,2.104447385,4.286771649,2.079226691,13.96359004,13.13382633,4.45805522,14.25761366,12.14205617,0,11.50019731,5.48997353,5.281730688,0,10.54964422,4.510440908,1.916065792,5.166217225,0,0,1.914596325,2.672729483,0,0,0,1.204003557,2.301374909,0,5.17154437,2.02080583,0,6.84743639,6.062934608,4.902157249,0,0,0,3.96333911,6.458718649,0,0,2.712718048,0,0,2.283469031,1.888578717,1.46012053,0,2.134165238,3.918795874,0,2.331205908,0,2.121043177,1.458514165,3.177645127,8.223182989,1.674904626,0,3.89429641,5.256528169,0,4.444055644,3.172492646,10.35753767,6.966142118,3.934112064,6.911150334,1.195550809,11.21392444,3.574592237,4.226241501,4.754560657,8.514876907,9.974831857,5.947870554,10.72769658,0,0,2.573009698,9.674768755,8.704868748,6.51597166,11.89091832,0,1.774547779,7.282882644,9.458968628,3.637105643,0,2.509654215,2.184629194,5.981308477,1.377092695,3.499434968,0,5.923660085,5.834781143],
    [1.431779586,1.192413264,0,4.718927108,0,4.501664819,0,7.162304506,1.792044962,0,3.943779694,0,2.377347064,2.134165238,2.590991323,0,7.543919978,7.007415012,0,0,2.897552731,4.160084164,0,0,0,0,0,0,1.873071327,4.982411585,2.13227898,0,0,4.141069016,2.35241283,0,0,2.986448755,0,0,0,0,0,1.567855244,0,1.231253532,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.121990524,0,0,0,2.168803591,0,1.571621765,1.674904626,1.167924869,0,1.191371277,0,0,2.324239181,0,4.044732979,0,0,0,0,1.241386551,5.705455517,3.111909342,0,5.679889633,0,0,0,0,1.797115738,3.485952495,0,0,0,0,0,2.405446283,0,0,0,4.613188524,0,1.844254505,2.068632354,4.434198304,0,2.109945405,1.354808925],
    [0,0,5.411588681,2.451788443,1.666262603,3.679313849,0,9.005430964,3.068526802,0,4.191103607,2.104447385,3.231372253,2.134165238,0,0,6.898806526,3.837728571,0,0,0,0,0,0,5.762313958,0,0,0,0,5.529493161,2.603155617,0,0,5.746973142,3.494023898,0,0,4.533604761,1.481358206,0,2.017487427,3.244061423,0,0,0,0,0,0,2.476695351,0,0,0,0,0,0,0,0,0,2.233797185,0,0,0,0,0,2.735603919,2.605196984,0,0,0,0,0,0,0,3.152109798,2.921997488,0,1.255175933,1.834870601,0,0,1.586888663,0,8.630626934,0,1.385653692,0,0,1.241386551,2.787748346,0,0,4.911716941,0,0,0,0,2.573009698,8.093332221,2.995800011,1.953661285,0,0,9.072883619,0,1.214748986,3.343879368,0,6.867969916,0,0,3.784457154,7.054835054,0,2.578968745,0],
    [0,1.836204539,6.916529204,5.560705844,0,1.569736026,0,2.408805546,1.792044962,3.317392333,1.95520039,9.176317176,0,1.090815163,0,0,1.731263898,3.540808171,0,4.12605646,0,11.27729476,9.962628962,0,11.68474144,11.33517187,0,9.624509553,3.36749764,3.819620521,1.4287038,8.548400241,3.417546061,0,2.35241283,0,0,0,0,0,0,0,0,0,0,3.558472286,0,0,2.476695351,3.056075924,2.76135907,0,0,0,3.052984456,4.691797695,0,0,1.511899039,0,0,1.5529849,2.679289883,0,1.529467388,0,1.935406473,0,3.18023001,0,2.94488983,0,4.256154097,5.957542834,0,0,3.220604739,3.790456203,0,4.334091189,1.586888663,8.642088679,5.570208734,0,3.797347749,0,8.857167078,2.967405176,1.569736026,2.83110867,5.839489603,7.343191592,3.716524438,8.802884779,0,0,0,7.133972209,6.323185711,3.032789935,9.919180826,0,0,5.36157935,7.486517574,2.975444667,0,1.358928018,0,2.62792129,1.377092695,2.357189199,0,4.693521631,2.85410132],
    [0,0,0,3.691813713,0,0,0,4.189142917,1.792044962,3.317392333,0,0,0,0,0,2.7684921,6.440401912,7.0658601,1.406082194,0,0,2.383886536,8.199641089,2.168803591,0,4.412094224,7.511087906,7.555483079,1.221294271,0,0,0,0,0,5.166217225,3.048363022,0,2.366007313,2.196679237,0,0,4.165843825,0,2.301374909,0,0,2.02080583,0,5.042796229,1.781999348,2.76135907,0,5.85052519,0,0,2.850235379,0,0,0,2.172734535,0,4.042109164,0,0,1.529467388,0,0,0,0,0,0,0,0,3.681934901,0,0,5.630629399,0,0,5.909423458,1.586888663,0,0,0,6.201254421,0,0,0,0,2.482114093,0,3.533813815,3.185417178,2.172734535,0,8.073907914,0,0,0,0,0,2.68589141,4.909566239,0,1.864734062,0,3.154638024,0,3.924517728,0,0,0,0,4.136170705,0],
    [1.431779586,0,0,6.209947215,0,2.303636946,0,7.401762269,6.178487015,3.853288573,0,0,0,1.704821959,1.812524025,4.480124818,6.621287,5.759994393,2.104447385,0,6.747543328,4.160084164,8.215185177,0,0,0,5.757485889,8.251155639,2.32039045,0,0,0,0,1.916065792,5.246445546,0,0,2.366007313,2.196679237,1.322794318,0,5.438721383,0,0,4.584271389,0,0,0,3.340906893,6.259456223,4.592240978,0,6.193080749,3.3791203,3.052984456,3.746566479,0,2.987759068,0,2.172734535,1.385653692,5.50739594,1.888578717,1.46012053,2.735603919,0,0,0,0,0,0,0,1.590756464,7.05690755,0,0,4.773589639,3.121377237,0,6.473452899,1.586888663,0,1.554826783,3.635588574,6.293137868,0,0,0,3.149587113,1.338596694,0,3.830611616,0,5.963555245,0,7.399044894,8.778467531,0,0,0,5.984021501,5.070762648,8.335541755,0,2.311215911,0,2.308177125,2.509654215,4.227317234,2.62792129,8.204227363,1.614406279,0,2.578968745,0],
    [0,0,0,0,0,0,0,0,0,3.853288573,0,0,0,1.704821959,0,3.418179486,1.731263898,0,0,0,6.033778214,3.771698401,0,2.168803591,2.350033433,0,2.439564301,0,0,1.297324055,0,0,0,3.420716548,0,0,0,0,0,1.322794318,2.017487427,2.388819979,0,0,0,0,2.83110867,4.24519686,2.476695351,1.781999348,8.95192476,4.220876189,6.701726243,0,0,0,4.636949199,0,4.142957954,4.675895148,0,1.5529849,0,0,0,0,0,0,3.18023001,0,0,0,0,1.571621765,0,0,3.753033567,1.191371277,0,2.068632354,1.586888663,1.517123172,3.129602515,1.94753258,0,0,2.159049313,1.241386551,2.787748346,2.482114093,0,3.533813815,0,2.172734535,5.829492438,3.850281247,2.573009698,4.170470135,0,0,0,0,0,0,0,0,0,0,0,0,0,2.357189199,0,0,0],
    [0,0,0,2.799346774,0,1.569736026,2.040985264,6.214821539,8.661567508,0,1.28620039,2.104447385,0,0,1.812524025,1.554826783,0,0,0,0,0,0,2.065128811,0,0,0,0,0,1.221294271,0,1.4287038,2.40377094,1.144473079,2.367619226,0,0,0,1.914596325,1.481358206,2.001082698,4.021826362,0,1.851024161,0,0,1.885737479,0,0,0,0,0,0,0,4.308067937,0,0,0,2.159049313,1.511899039,0,0,2.766109149,0,0,3.095446785,0,0,1.121990524,0,0,2.121043177,0,2.814800039,7.495752552,0,0,1.916065792,5.99777011,0,1.377092695,6.602771375,0,0,1.94753258,6.968016407,1.195550809,0,1.898600356,0,0,3.332623469,0,0,10.08142504,0,0,0,0,0,3.266140317,0,0,0,0,5.196414538,0,0,4.517857264,0,0,0,1.614406279,0,2.109945405,0],
    [0,0,0,5.605554037,0,0,0,7.699722019,5.786261579,0,0,5.456290025,0,1.090815163,0,0,0,6.018584933,0,0,0,3.238606292,0,0,0,0,0,0,1.873071327,1.297324055,0,1.653483243,0,0,1.61041097,2.212993723,0,0,0,3.088736519,0,4.471606333,2.29611755,2.301374909,3.643192729,1.885737479,0,0,3.340906893,0,0,0,0,0,0,0,0,0,3.358854664,0,2.079226691,1.5529849,0,0,0,1.430239906,0,0,0,0,1.419561476,0,0,6.283978741,0,0,0,1.834870601,0,4.895011416,3.703106027,0,1.554826783,1.94753258,4.559531286,0,0,1.241386551,1.569736026,0,0,0,0,4.0694851,3.605634704,0,0,0,0,3.032789935,0,0,0,0,1.214748986,0,3.684561532,3.756976488,0,0,6.420626178,3.947945664,0,1.410544518,0],
    [0,0,0,9.404294507,0,0,0,7.246617758,8.713280691,0,1.95520039,0,1.262193429,1.704821959,4.399205452,0,0,5.04066863,0,0,0,0,0,0,2.350033433,0,0,0,1.221294271,0,0,4.001933649,0,1.916065792,2.839992687,0,0,3.594588248,2.196679237,1.322794318,3.1080144,0,1.851024161,2.301374909,0,1.885737479,0,0,0,0,1.959834467,0,0,0,5.892249192,0,0,4.326546321,4.417540006,0,0,2.283469031,2.679289883,2.644765483,4.776898533,2.959707294,0,0,0,0,3.466007268,0,0,8.402065998,0,2.24508439,2.711021318,4.245781516,0,6.308789707,5.557415738,0,2.285688951,4.181329765,7.191417465,0,0,1.898600356,4.065919631,3.54885136,0,4.286771649,0,7.279712389,0,0,0,0,0,0,0,0,0,1.950591407,4.630991991,0,0,7.284750801,0,1.844254505,5.830624043,2.845102004,0,6.419153128,2.50408572],
    [0,0,0,2.451788443,0,0,0,6.821059191,6.836687811,2.455308789,1.95520039,0,1.262193429,0,2.590991323,0,0,5.353803769,0,0,0,3.238606292,0,0,0,0,0,0,1.221294271,1.297324055,0,2.894869795,0,3.753033567,1.61041097,0,0,1.914596325,0,1.322794318,0,0,1.204003557,1.567855244,0,2.676004571,0,0,0,0,1.959834467,0,2.621674279,0,0,0,0,1.450539436,3.358854664,0,1.385653692,1.5529849,0,0,2.25507312,1.430239906,0,0,0,0,0,1.458514165,0,6.246991173,0,0,0,0,0,5.564557384,2.324239181,0,0,3.258734268,5.055632307,1.195550809,0,3.39914311,0,2.482114093,0,0,0,6.003554897,0,0,0,0,0,0,0,0,1.774547779,1.282537517,2.65168682,0,0,4.41577813,0,0,0,0,0,0,1.354808925],
    [0,1.836204539,0,6.979411351,1.666262603,0,7.320832174,13.47752713,6.955971935,2.455308789,0,4.378648964,1.924937051,0,0,3.658543633,1.731263898,3.540808171,0,0,5.626062257,3.771698401,0,0,0,3.953521681,0,3.730089796,1.221294271,1.297324055,0,0,0,3.89429641,1.61041097,0,0,0,0,0,0,0,0,0,0,0,4.670434283,5.206648839,3.340906893,2.555337332,8.934986157,4.220876189,0,2.861874491,0,2.850235379,3.315453761,0,0,0,0,0,1.888578717,1.46012053,1.529467388,0,8.884937958,1.745427173,4.654982428,0,2.590991323,2.168803591,0,2.305904344,0,1.167924869,4.773589639,1.834870601,0,0,0,2.240129526,7.662137036,0,5.672425342,0,6.171070535,4.118615362,3.438628157,3.72600458,4.389821626,3.533813815,0,3.288643503,6.405973351,4.152063608,3.446387271,3.485952495,5.995274152,1.284976959,4.120471603,0,0,1.282537517,2.926952007,3.880683284,0,1.358928018,0,7.240877818,0,3.209051333,1.634715536,10.84429719,0],
    [0,0,3.059175851,1.316327062,0,0,0,2.408805546,0,2.455308789,1.95520039,0,0,1.704821959,0,0,1.731263898,3.166510337,2.104447385,0,8.035020769,4.160084164,2.065128811,6.347303882,2.350033433,2.764919656,0,6.27960346,1.221294271,0,0,0,0,0,1.61041097,0,0,0,0,0,0,2.388819979,0,0,2.754273197,0,4.02596074,0,2.476695351,2.555337332,0,0,3.499434968,0,0,0,0,0,0,3.003160341,0,2.283469031,0,0,0,0,0,0,0,0,0,0,0,0,1.674904626,0,5.986713889,2.617013534,0,7.384863039,0,5.513892971,0,0,0,0,7.431097422,1.898600356,0,3.346859325,0,0,0,0,3.605634704,8.09176372,0,0,1.733606582,0,6.056881974,0,0,0,0,0,0,0,0,1.844254505,3.16787499,5.087025329,0,0,2.040985264],
    [2.961840268,1.192413264,3.430278729,9.853300258,0,0,0,8.302205581,4.5340297,0,2.410489481,0,0,0,2.590991323,0,2.992869351,0,0,0,0,0,5.510518515,0,0,0,0,4.674679689,1.221294271,6.418663992,0,6.367110049,1.144473079,4.022952592,3.494023898,0,0,2.709327299,0,0,2.017487427,0,0,2.301374909,0,1.885737479,0,0,0,4.358409986,4.408114953,0,2.621674279,2.861874491,0,0,1.994606741,2.159049313,0,8.444470042,0,0,0,1.46012053,4.168411949,0,0,0,0,0,0,2.642645028,0,1.571621765,1.674904626,0,0,2.278309285,0,7.478294727,4.250663922,0,2.285688951,4.739539538,7.466027109,3.127952731,7.646067294,0,0,1.338596694,2.688101136,2.653290576,0,4.675895148,0,0,5.585854981,0,0,4.584271389,2.917885603,9.788150887,9.154836494,4.066891048,3.15801765,0,8.754319795,3.756976488,0,4.603837708,2.068632354,9.59270747,0,3.99325527,1.354808925],
    [2.136055426,0,0,8.845541465,0,0,0,5.720391696,1.792044962,0,1.95520039,0,0,0,0,0,2.992869351,0,0,0,0,0,2.8815524,0,0,0,0,4.030108559,1.221294271,4.318348466,0,4.741524853,0,1.255175933,2.35241283,0,0,0,0,0,0,1.640918907,0,2.301374909,0,0,0,0,3.340906893,1.781999348,0,0,4.041235755,0,0,0,0,0,1.511899039,6.910471793,1.385653692,0,0,1.46012053,3.095446785,0,0,0,0,0,0,2.642645028,0,0,0,0,0,0,0,5.238068927,2.809830944,1.517123172,0,4.57634937,4.828801899,0,4.928973727,0,0,0,1.493074462,1.866117748,0,2.172734535,0,0,0,0,0,0,4.582003125,5.717825408,7.371984904,3.02915668,2.65168682,0,6.172852405,2.046103514,0,2.62792129,0,4.797226964,0,2.109945405,0]];

  /**
   * @type {Array.<Array.<number>>}
   * @private
   */
  this._selectedValues = this._values;

  /**
   * @type {Array.<string>}
   * @private
   */
  this._cols = ['100365', '100403', '100476', '100489', '100618', '100636', '100704', '100716', '100722', '100749', '100759', '100782', '100798', '100855', '100857', '100889', '102020', '102025', '102027', '102037', '102105', '102106', '102132', '102133', '102158', '102174', '102184', '102209', '102421', '200069', '200079', '200108', '200127', '200134', '200140', '200154', '200158', '200160', '200161', '200165', '200167', '200169', '200170', '200172', '200196', '200235', '200244', '200314', '200327', '200328', '200330', '200331', '200347', '200365', '200367', '200381', '200392', '400555', '401017', '401201', '401593', '401596', '401600', '401601', '401605', '401609', '401704', '401705', '401727', '401728', '401732', '401736', '401739', '401740', '401754', '401757', '401760', '401764', '401796', '401856', '401869', '401884', '600620', '600627', '600646', '600654', '600683', '600710', '600761', '600763', '600765', '600776', '600782', '600789', '600803', '600807', '600813', '600819', '600901', '600909', '600917', '600967', '600970', '600984', '601007', '601017', '601021', '601036', '601045', '601046', '601053', '601160', '601186', '601208', '602054'];

  this._observationType = ['Control','Control','Case','Control','Control','Case','Case','Case','Control','Case','Case','Control','Control','Case','Control','Case','Control','Control','Case','Control','Case','Case','Control','Control','Case','Case','Case','Control','Control','Case','Case','Case','Control','Case','Case','Case','Control','Control','Control','Control','Control','Control','Control','Control','Case','Control','Case','Case','Case','Case','Case','Case','Case','Case','Case','Case','Case','Control','Control','Control','Control','Case','Control','Case','Case','Case','Case','Case','Case','Control','Control','Control','Case','Case','Case','Case','Case','Control','Control','Case','Case','Case','Case','Control','Case','Control','Case','Case','Case','Control','Control','Case','Case','Control','Case','Case','Case','Case','Control','Control','Control','Control','Case','Case','Control','Control','Control','Case','Case','Case','Case','Case','Control','Case','Case'];
  //this._ageRange = ["[12,18)","[12,18)","[6,12)", "[18,24)","[12,18)","[24,60)","[12,18)","[18,24)","[18,24)","[12,18)","[24,60)","[24,60)","[24,60)","[18,24)","[24,60)","[6,12)", "[12,18)","[6,12)", "[6,12)", "[18,24)","[0,6)",  "[6,12)", "[6,12)", "[0,6)",  "[18,24)","[6,12)", "[0,6)",  "[0,6)",  "[18,24)","[24,60)","[24,60)","[6,12)", "[24,60)","[24,60)","[12,18)","[6,12)", "[12,18)","[12,18)","[12,18)","[18,24)","[24,60)","[6,12)", "[24,60)","[12,18)","[6,12)", "[24,60)","[6,12)", "[6,12)", "[6,12)", "[6,12)", "[0,6)",  "[6,12)", "[6,12)", "[6,12)", "[6,12)", "[0,6)",  "[0,6)",  "[24,60)","[24,60)","[6,12)", "[24,60)","[6,12)", "[6,12)", "[24,60)","[24,60)","[24,60)","[0,6)",  "[24,60)","[0,6)",  "[24,60)","[18,24)","[24,60)","[6,12)", "[6,12)", "[24,60)","[24,60)","[6,12)", "[6,12)", "[24,60)","[12,18)","[18,24)","[0,6)",  "[24,60)","[24,60)","[24,60)","[24,60)","[6,12)", "[24,60)","[24,60)","[24,60)","[24,60)","[18,24)","[6,12)", "[24,60)","[0,6)",  "[6,12)", "[12,18)","[18,24)","[18,24)","[18,24)","[6,12)", "[6,12)", "[12,18)","[24,60)","[24,60)","[12,18)","[18,24)","[24,60)","[6,12)", "[12,18)","[12,18)","[24,60)","[24,60)","[24,60)","[18,24)"];
  this._ageRange = ["12 - 18", "12 - 18", "6 - 12", "18 - 24", "12 - 18", "24 - 60", "12 - 18", "18 - 24", "18 - 24", "12 - 18", "24 - 60", "24 - 60", "24 - 60", "18 - 24", "24 - 60", "6 - 12", "12 - 18", "6 - 12", "6 - 12", "18 - 24", "0 - 6", "6 - 12", "6 - 12", "0 - 6", "18 - 24", "6 - 12", "0 - 6", "0 - 6", "18 - 24", "24 - 60", "24 - 60", "6 - 12", "24 - 60", "24 - 60", "12 - 18", "6 - 12", "12 - 18", "12 - 18", "12 - 18", "18 - 24", "24 - 60", "6 - 12", "24 - 60", "12 - 18", "6 - 12", "24 - 60", "6 - 12", "6 - 12", "6 - 12", "6 - 12", "0 - 6", "6 - 12", "6 - 12", "6 - 12", "6 - 12", "0 - 6", "0 - 6", "24 - 60", "24 - 60", "6 - 12", "24 - 60", "6 - 12", "6 - 12", "24 - 60", "24 - 60", "24 - 60", "0 - 6", "24 - 60", "0 - 6", "24 - 60", "18 - 24", "24 - 60", "6 - 12", "6 - 12", "24 - 60", "24 - 60", "6 - 12", "6 - 12", "24 - 60", "12 - 18", "18 - 24", "0 - 6", "24 - 60", "24 - 60", "24 - 60", "24 - 60", "6 - 12", "24 - 60", "24 - 60", "24 - 60", "24 - 60", "18 - 24", "6 - 12", "24 - 60", "0 - 6", "6 - 12", "12 - 18", "18 - 24", "18 - 24", "18 - 24", "6 - 12", "6 - 12", "12 - 18", "24 - 60", "24 - 60", "12 - 18", "18 - 24", "24 - 60", "6 - 12", "12 - 18", "12 - 18", "24 - 60", "24 - 60", "24 - 60", "18 - 24"];
  this._country = ['Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Gambia','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Mali','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Kenya','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh','Bangladesh'];

  /**
   * @type {Array.<string>}
   * @private
   */
  this._rows = ['316', '319', '327', '396', '397', '411', '440', '2552', '3384', '5052', '7349', '10433', '11630', '12245', '12817', '13083', '13536', '13604', '13661', '13803', '13871', '13930', '14782', '15438', '15597', '16252', '16382', '17138', '17411', '19129', '19270', '20986', '21611', '21695', '21761', '22185', '22345', '22439', '22475', '23063', '23209', '23249', '23294', '23652', '24034', '24342', '25124', '25350', '26067', '26436', '27295', '27589', '29214', '29323', '30331', '31069', '36412', '41738', '41965', '43072', '43449', '44327', '49450', '55106', '58381', '58640', '59842', '62910', '62990', '62991', '63503', '63551', '64795', '64796', '64986', '64988', '66023', '70246', '71135', '71612', '71624', '71660', '71687', '71691', '74643', '75427', '80484', '80563', '80645', '83740', '89655', '91091', '92355', '92969', '100517', '102968', '106895', '108037', '110457', '121102', '123236', '134492', '137811', '142181', '142560', '153986', '154352', '154508', '162189', '162210', '162397', '170809', '172372', '182738', '196401'];

  /**
   * @type {Array.<string>}
   * @private
   */
  this._selectedRows = this._rows;

  /**
   * rowIndex -> [start, length]
   * @type {Array.<Array.<number>>}
   * @private
   */
  this._selectedRowsRanges = this._rows.map(function(row, i) { return [i, 1]; });

  var self = this;
  var measurements = [];
  this._cols.forEach(function(col, i) {
    var m = new epiviz.measurements.Measurement(
      col, // id
      self._cols[i], // name
      epiviz.measurements.Measurement.Type.FEATURE,
      'metagenomics', // datasource
      'metagenomics', // datasource group
      self.id(), // data provider
      null, // formula
      'heatmap',
      {observationType: self._observationType[i], ageRange: self._ageRange[i], country: self._country[i]}, // annotation
      0, 15,
      ['colLabel', 'bacteria', 'ancestors', 'lineage'].concat(epiviz.data.MetagenomicsDataProvider.LEVEL_NAMES));
    measurements.push(m);
  });

  /**
   * @type {Array.<epiviz.measurements.Measurement>}
   * @private
   */
  this._measurements = measurements;

  var colsIndices = {};
  this._cols.forEach(function(col, i) {
    colsIndices[col] = i;
  });

  /**
   * @type {Object.<string, number>}
   * @private
   */
  this._colsIndices = colsIndices;

  var rowIndices = {};
  this._rows.forEach(function(col, i) {
    rowIndices[col] = i;
  });

  /**
   * @type {Object.<string, number>}
   * @private
   */
  this._rowIndices = rowIndices;

  /**
   * @type {epiviz.ui.charts.tree.Node}
   * @private
   */
  this._hierarchy = null;

  /**
   * node.name -> path string of node ids on the path to the root
   * @type {Object.<string, string>}
   * @private
   */
  this._hierarchyPathsMap = {};

  this._ancestryMap = {};

  /**
   * node name -> taxonomy level -> value (for all hierarchy)
   * @type {Object.<string, Object.<string, string>>}
   * @private
   */
  this._taxonomyMap = {};

  /**
   * @type {Array.<string>}
   * @private
   */
  this._selectedPaths = [];

  /**
   * Same as selectedPaths, but with node names
   * @type {Array.<string>}
   * @private
   */
  this._selectedAncestry = [];

  /**
   * Same purpose as ancestry
   * taxonomy level -> value for each selected row
   * @type {Object.<string, Array.<string>>}
   * @private
   */
  this._selectedTaxonomy = {};

  var levelNames = epiviz.data.MetagenomicsDataProvider.LEVEL_NAMES;

  this._nodeMap = {};
  this._nodeNameMap = {};
  this._nodeRangeMap = {};
  this._maxDepth = 5;
  this._lastRootId = null;
  d3.json("tree.json",
    /**
     * @param error
     * @param {epiviz.ui.charts.tree.Node} root
     */
    function(error, root) {
      self._hierarchy = root;
      epiviz.ui.charts.tree.Node.dfs(root, function(node) { self._nodeMap[node.id] = node; self._nodeNameMap[node.name] = node; });
      epiviz.ui.charts.tree.Node.dfs(root, function(node) {
        node.depth = node.globalDepth;
        node.taxonomy = levelNames[node.globalDepth];
        if (!node.parentId) { self._hierarchyPathsMap[node.name] = node.id; self._ancestryMap[node.name] = ''; return; } // TODO: Should use id. In the future, rows should store node id and that will fix everything
        var parent = self._nodeMap[node.parentId];
        var path = node.id;//parent.id;
        //parent = self._nodeMap[parent.parentId];
        var ancestry = '';
        var taxonomy = {};
        taxonomy[levelNames[node.globalDepth]] = node.name;
        while (parent) {
          path += ',' + parent.id;
          ancestry += ',' + parent.name;
          taxonomy[levelNames[parent.globalDepth]] = parent.name;
          parent = self._nodeMap[parent.parentId];
        }
        self._hierarchyPathsMap[node.name] = path;
        self._taxonomyMap[node.name] = taxonomy;

        if (ancestry.length > 0) { ancestry = ancestry.substring(1); }
        self._ancestryMap[node.name] = ancestry;
      });

      levelNames.forEach(function(level) {
        self._selectedTaxonomy[level] = [];
      });

      self._selectedRows.forEach(function(nodeName, i) {
        self._selectedPaths.push(self._hierarchyPathsMap[nodeName]);
        self._selectedAncestry.push(self._ancestryMap[nodeName]);
        levelNames.forEach(function(level) {
          self._selectedTaxonomy[level].push(self._taxonomyMap[nodeName][level] || '<NA>');
        });
      });
      self._updateOrder();
      self._updateSelection();
    });
};

/**
 * Copy methods from upper class
 */
epiviz.data.MetagenomicsDataProvider.prototype = epiviz.utils.mapCopy(epiviz.data.DataProvider.prototype);
epiviz.data.MetagenomicsDataProvider.constructor = epiviz.data.MetagenomicsDataProvider;

/**
 * @type {Array.<string>}
 */
epiviz.data.MetagenomicsDataProvider.LEVEL_NAMES = ['Kingdom', 'Phylum', 'Class', 'Order', 'Family', 'Genus', 'Species', 'OTU'];

/**
 * @param {epiviz.data.Request} request
 * @param {function(epiviz.data.Response)} callback
 * @override
 */
epiviz.data.MetagenomicsDataProvider.prototype.getData = function (request, callback) {
  var self = this;
  var requestId = request.id();
  var action = request.get('action');
  var seqName = request.get('seqName');
  var start = parseInt(request.get('start'));
  var end = parseInt(request.get('end'));
  var datasource = request.get('datasource');
  var measurement = request.get('measurement');

  var levelNames = epiviz.data.MetagenomicsDataProvider.LEVEL_NAMES;

  var startIndex, endIndex;
  if (seqName == 'metagenomics' && !isNaN(start) && !isNaN(end)) {
    this._selectedRowsRanges.forEach(function(range, i) {
      if (range[0] <= end && range[0] + range[1] > start) {
        if (startIndex == undefined) { startIndex = i; }
        endIndex = i;
      }
    });
  }

  switch (action) {
    case epiviz.data.Request.Action.GET_ROWS:
      var data;
      if (seqName != 'metagenomics') {
        // Nothing to return
        data = {
          globalStartIndex: null,
            values: {
            id: [], start: [], end: [],
              metadata: { colLabel: [], bacteria: [], ancestors: [], 'lineage': [] } } };

        levelNames.forEach(function(level) { data.values.metadata[level] = []; });
        callback(epiviz.data.Response.fromRawObject({
          data: data,
          requestId: requestId
        }));
        return;
      }

      data = {
        globalStartIndex: start,
        values: {
          id: epiviz.utils.range(endIndex - startIndex + 1, start),
          start: self._selectedRowsRanges.map(function(range) { return range[0]; }).slice(startIndex, endIndex + 1),
          end: self._selectedRowsRanges.map(function(range) { return range[0] + range[1] - 1; }).slice(startIndex, endIndex + 1),
          metadata: {
            colLabel: this._selectedRows.slice(startIndex, endIndex + 1),
            bacteria: this._selectedRows.slice(startIndex, endIndex + 1),
            ancestors: this._selectedAncestry.slice(startIndex, endIndex + 1),
            lineage: this._selectedPaths.slice(startIndex, endIndex + 1)
          }
        }
      };
      levelNames.forEach(function(level) {
        data.values.metadata[level] = self._selectedTaxonomy[level].slice(startIndex, endIndex + 1)
          .map(function(name) { return name.length <= 15 ? name : (name.substr(0, 12) + '...'); });
      });
      callback(epiviz.data.Response.fromRawObject({
        data: data,
        requestId: requestId
      }));

      return;

    case epiviz.data.Request.Action.GET_VALUES:
      var colIndex = this._colsIndices[measurement];
      if (seqName != 'metagenomics' || colIndex == undefined) {
        // Nothing to return
        callback(epiviz.data.Response.fromRawObject({
          data: { values: [] },
          requestId: requestId
        }));
        return;
      }

      var values = this._selectedValues.map(function(row, i) { return row[colIndex]; });

      callback(epiviz.data.Response.fromRawObject({
        data: { globalStartIndex: start, values: values.slice(startIndex, endIndex + 1) },
        requestId: requestId
      }));

      return;

    case epiviz.data.Request.Action.GET_MEASUREMENTS:
      callback(epiviz.data.Response.fromRawObject({
        requestId: request.id(),
        data: {
          id: this._cols,
          name: this._cols,
          type: this._measurements.map(function(m) { return m.type(); }),
          datasourceId: this._measurements.map(function(m) { return m.datasourceId(); }),
          datasourceGroup: this._measurements.map(function(m) { return m.datasourceGroup(); }),
          defaultChartType: this._measurements.map(function(m) { return m.defaultChartType(); }),
          annotation: this._measurements.map(function(m) { return m.annotation(); }),
          minValue: this._measurements.map(function(m) { return m.minValue(); }),
          maxValue: this._measurements.map(function(m) { return m.maxValue(); }),
          metadata: this._measurements.map(function(m) { return m.metadata(); })
        }
      }));
      return;

    case epiviz.data.Request.Action.GET_SEQINFOS:
      callback(epiviz.data.Response.fromRawObject({
        requestId: request.id(),
        data: [['metagenomics', 0, this._rows.length]]
      }));
      return;

    case epiviz.data.Request.Action.GET_HIERARCHY:
      var datasourceGroup = request.get('datasourceGroup');
      var nodeId = request.get('nodeId') || this._hierarchy.id;
      this._lastRootId = nodeId;
      var originalNode = this._nodeMap[nodeId];
      var parent = originalNode.parentId ? this._nodeMap[originalNode.parentId] : originalNode;
      var newRoot = epiviz.ui.charts.tree.Node.filter(parent,
        function(node) {
          return (node.globalDepth != originalNode.globalDepth || node == originalNode) &&
          node.globalDepth - parent.globalDepth < self._maxDepth;
        });

      callback(epiviz.data.Response.fromRawObject({
        requestId: request.id(),
        data: newRoot
      }));
      return;

    case epiviz.data.Request.Action.PROPAGATE_HIERARCHY_CHANGES:
      var datasourceGroup = request.get('datasourceGroup');

      /**
       * @type {Object.<string, number>}
       */
      var selection = request.get('selection');

      /**
       * @type {Object.<string, number>}
       */
      var order = request.get('order');

      if (!selection && !order) { return; }

      if (selection) {
        for (var id in selection) {
          if (!selection.hasOwnProperty(id)) { continue; }
          if (!(id in this._nodeMap)) { continue; }
          this._nodeMap[id].selectionType = selection[id];
        }
      }

      if (order) {
        for (var id in order) {
          if (!order.hasOwnProperty(id)) { continue; }
          if (!(id in this._nodeMap)) { continue; }
          this._nodeMap[id].order = order[id];
        }
      }

      this._updateOrder();
      this._updateSelection();

      var originalNode = this._nodeMap[this._lastRootId];
      var parent = originalNode.parentId ? this._nodeMap[originalNode.parentId] : originalNode;
      var newRoot = epiviz.ui.charts.tree.Node.filter(parent,
        function(node) {
          return (node.globalDepth != originalNode.globalDepth || node == originalNode) &&
          node.globalDepth - parent.globalDepth < self._maxDepth;
        });

      callback(epiviz.data.Response.fromRawObject({
        requestId: request.id(),
        data: newRoot
      }));
      return;

    default:
      epiviz.data.DataProvider.prototype.getData.call(this, request, callback);
      break;
  }
};

/**
 * @private
 */
epiviz.data.MetagenomicsDataProvider.prototype._updateOrder = function() {
  epiviz.ui.charts.tree.Node.dfs(this._hierarchy, function(node) {
    if (!node.nchildren) { return; }
    node.children.sort(function(node1, node2) { return node1.order - node2.order; });
  });
};

epiviz.data.MetagenomicsDataProvider.prototype._updateSelection = function() {
  /**
   * @type {epiviz.ui.charts.tree.Node}
   */
  var root = this._hierarchy;

  var selection = this._getNodeSelection(root);

  var self = this;
  var levelNames = epiviz.data.MetagenomicsDataProvider.LEVEL_NAMES;
  this._nodeRangeMap = {};
  var depthLastEnd = {};
  epiviz.ui.charts.tree.Node.bfs(root, function(node) {
    var lastEnd = depthLastEnd[node.globalDepth] || 0;
    depthLastEnd[node.globalDepth] = lastEnd + node.nleaves;
    self._nodeRangeMap[node.name] = lastEnd;
  });

  this._selectedRows = selection.rows;
  this._selectedValues = selection.values;

  this._selectedPaths = [];
  this._selectedAncestry = [];
  this._selectedRowsRanges = [];
  this._selectedTaxonomy = {};
  levelNames.forEach(function(level) {
    self._selectedTaxonomy[level] = [];
  });
  var lastEnd = 0;
  this._selectedRows.forEach(function(nodeName) {
    self._selectedPaths.push(self._hierarchyPathsMap[nodeName]);
    self._selectedAncestry.push(self._ancestryMap[nodeName]);
    levelNames.forEach(function(level) {
      self._selectedTaxonomy[level].push(self._taxonomyMap[nodeName][level] || '<NA>');
    });
    //self._selectedRowsRanges.push([lastEnd, self._nodeNameMap[nodeName].nleaves]);
    self._selectedRowsRanges.push([self._nodeRangeMap[nodeName], self._nodeNameMap[nodeName].nleaves]);
    lastEnd += self._nodeNameMap[nodeName].nleaves;
  });
};

/**
 * @param {epiviz.ui.charts.tree.Node} node
 * @returns {{rows: Array.<string>, values: Array.<Array.<number>>}}
 * @private
 */
epiviz.data.MetagenomicsDataProvider.prototype._getNodeSelection = function(node) {
  var NodeSelectionType = epiviz.ui.charts.tree.NodeSelectionType;
  if (node.selectionType == NodeSelectionType.NONE) {
    return {rows: [], values: []};
  }
  if (!node.nchildren) {
    return {rows: [node.name], values: [this._values[this._rowIndices[node.name]]]}; // TODO: Use id instead
  }
  var self = this;
  var result = {rows:[], values: []};
  if (node.selectionType == NodeSelectionType.LEAVES) {
    node.children.forEach(function(child, i) {
      var childResult = self._getNodeSelection(child);
      result.rows = result.rows.concat(childResult.rows);
      result.values = result.values.concat(childResult.values);
    });
    return result;
  }

  if (node.selectionType == NodeSelectionType.NODE) {
    result.rows = [node.name]; // TODO: should use id
    var values = [];
    node.children.forEach(function(child, i) {
      var childResult = self._getNodeSelection(child);
      values = values.concat(childResult.values);
    });
    result.values = [values.reduce(function(v1, v2) {
      var ret = [];
      for (var i = 0; i < self._cols.length; ++i) {
        ret.push(v1[i] + v2[i]);
      }
      return ret;
    }).map(function(v) { return v / values.length; })];
    return result;
  }
};

// Input 129
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/3/14
 * Time: 12:35 PM
 */

goog.provide('epiviz.data.MockDataProvider');

/**
 * @param {?string} [id]
 * @constructor
 * @extends {epiviz.data.DataProvider}
 */
epiviz.data.MockDataProvider = function(id) {
  epiviz.data.DataProvider.call(this, id || epiviz.data.MockDataProvider.DEFAULT_ID);

  /**
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._measurements = new epiviz.measurements.MeasurementSet();

  /**
   * @type {epiviz.measurements.Measurement}
   * @private
   */
  this._m1 = null;

  /**
   * @type {epiviz.measurements.Measurement}
   * @private
   */
  this._m2 = null;

  /**
   * @type {epiviz.measurements.MeasurementHashtable}
   * @private
   */
  this._values = new epiviz.measurements.MeasurementHashtable();

  /**
   * @type {epiviz.datatypes.GenomicRange}
   * @private
   */
  this._coveredRegions = [
    epiviz.datatypes.GenomicRange.fromStartEnd('chr6', 103839409, 107422589),
    epiviz.datatypes.GenomicRange.fromStartEnd('myChr', 103839409, 107422589)];

  this._addSeqnamesButton = $('#button-mock-add-seqnames');
  this._removeSeqnamesButton = $('#button-mock-remove-seqnames');
  this._addMeasurementsButton = $('#button-mock-add-measurements');
  this._removeMeasurementsButton = $('#button-mock-remove-measurements');
  this._addChartButton = $('#button-mock-add-chart');
  this._removeChartButton = $('#button-mock-remove-chart');
  this._clearCacheButton = $('#button-mock-clear-cache');
  this._navigateButton = $('#button-mock-navigate');

  this._initialize();

  this._initializeButtonHandlers();
};

/**
 * Copy methods from upper class
 */
epiviz.data.MockDataProvider.prototype = epiviz.utils.mapCopy(epiviz.data.DataProvider.prototype);
epiviz.data.MockDataProvider.constructor = epiviz.data.MockDataProvider;

epiviz.data.MockDataProvider.DEFAULT_ID = 'mock-provider';

/**
 * Helper method; not necessary in real implementations.
 * @private
 */
epiviz.data.MockDataProvider.prototype._initialize = function() {
  var m1 = new epiviz.measurements.Measurement(
    'column_1_feature', // The column in the data source table that contains the values for this feature measurement
    'Mock Feature Measurement 1', // A name not containing any special characters (only alphanumeric and underscores)
    epiviz.measurements.Measurement.Type.FEATURE,
    'mock_gene_expression', // Data source: the table/data frame containing the data
    'affymetrix_probeset', // The same data source group id as one of the measurements coming from the PHP server
    this.id(), // Data provider
    null, // Formula
    'Scatter Plot', // Default chart type filter
    null, // Annotation: example: {tissue_type: string, tissue_subtype: string}
    -5, // Min Value
    25, // Max Value
    ['probe'] // Metadata
  );

  var m2 = new epiviz.measurements.Measurement(
    'table_2_range', // The data source table that contains the ranges for this range measurement. Usually the same as the data source.
    'Mock Range Measurement 2', // A name not containing any special characters (only alphanumeric and underscores)
    epiviz.measurements.Measurement.Type.RANGE,
    'table_2_range', // Data source: the table/data frame containing the data
    'some_datasource_group', // A new data source group
    this.id(), // Data provider
    null, // Formula
    'Blocks Track', // Default chart type filter
    null, // Annotation
    null, null, // Min and max values (does not apply)
    null // No metadata associated with this measurement
  );

  this._m1 = m1;
  this._m2 = m2;

  this._measurements.add(m1);

  this._values.put(m1, {
    chr6: {
      values: [-1.8223838498414,-0.61258676716977,-0.47866833545712,-0.054737753101232,-0.17442192545694,-0.40962816952573,3.1485057281967,3.4216926668387,1.2040975523491,6.1801932225364,6.2102197272821,2.884041505725,4.5749627572691,12.327818860502,2.1696605100473,1.6726685919334,1.3730964627525,2.572793075785,0.66402453937773,0.29669898727439,3.1745684364685,2.0365248658682],
      globalStartIndex: 25879
    }
  });
  this._values.put(m1.datasource(), {
    chr6: {
      values: {
        id: [25879,25880,25881,25882,25883,25884,25885,25886,25887,25888,25889,25890,25891,25892,25893,25894,25895,25896,25897,25898,25899,25900],
        start: [105175968,105404923,105544697,105544697,105585562,105606155,105725440,105725440,106534195,106534195,106632351,106632351,106632351,106959730,107019846,107019846,107077453,107077453,107077453,107077489,107349417,107386386],
        end: [105307794,105531207,105585049,105585049,105617820,105627735,105850959,105850959,106557813,106557813,106773666,106773666,106773666,107018326,107077362,107077362,107116292,107116292,107116292,107101698,107372546,107436473],
        strand: "*",
        metadata: {
          probe: ["227471_at","229349_at","223853_at","228783_at","232492_at","219926_at","204117_at","37950_at","217192_s_at","228964_at","202511_s_at","202512_s_at","210639_s_at","212543_at","1555679_a_at","224509_s_at","218948_at","218949_s_at","241933_at","233089_at","223576_at","227920_at"]
        }
      },
      globalStartIndex: 25879
    }
  });
  this._values.put(m2, {
    chr6: {
      values:{
        id: [10693,10694,10695,10696,10697,10698,10699,10700,10701,10702],
        start: [101857270,105250651,105309133,105411671,105596427,105627861,105856970,105962958,106046989,106105087],
        end: [105211359,105271461,105383016,105571044,105627384,105719343,105932269,105994851,106071935,106148917],
        strand: "*"
      },
      globalStartIndex: 10693
    },
    myChr: {
      values:{
        id: [10703,10704,10705,10706,10707,10708,10709,10710,10711],
        start: [106196924,106299261,106341705,106458601,106568336,106773852,107067335,107303124,107374709],
        end: [106234848,106319337,106416368,106529963,106596204,106803274,107077437,107342199,107384388],
        strand: "*"
      },
      globalStartIndex: 10703
    }
  });
};

/**
 * Helper method, used in conjunction with the mock buttons in index.php, that will later on be deleted.
 * @private
 */
epiviz.data.MockDataProvider.prototype._initializeButtonHandlers = function() {
  var self = this;

  this._addSeqnamesButton.button().click(function() {
    var result = new epiviz.events.EventResult();
    self.onRequestAddSeqInfos().notify({seqInfos: [['otherChr', 1, 1000000000], ['andYetAnotherChr', 1, 1000000000]], result: result});
    alert('Adding seqnames was ' + (result.success ? 'successful!' : 'unsuccessful. Error: ' + result.errorMessage));
  });

  this._removeSeqnamesButton.button().click(function() {
    var result = new epiviz.events.EventResult();
    self.onRequestRemoveSeqNames().notify({seqNames: ['chr1', 'andYetAnotherChr'], result: result});
    alert('Removing seqnames was ' + (result.success ? 'successful!' : 'unsuccessful. Error: ' + result.errorMessage));
  });

  this._addMeasurementsButton.button().click(function() {
    var result = new epiviz.events.EventResult();
    var newMs = new epiviz.measurements.MeasurementSet();
    newMs.add(self._m2);
    self._measurements.add(self._m2);
    self.onRequestAddMeasurements().notify({measurements: newMs, result: result});
    alert('Adding measurements was ' + (result.success ? 'successful!' : 'unsuccessful. Error: ' + result.errorMessage));
  });

  this._removeMeasurementsButton.button().click(function() {
    var result = new epiviz.events.EventResult();
    var rmMs = new epiviz.measurements.MeasurementSet();
    rmMs.add(self._m2);
    self._measurements.remove(self._m2);
    self.onRequestRemoveMeasurements().notify({measurements: rmMs, result: result});
    alert('Removing measurements was ' + result.success ? 'successful!' : 'unsuccessful. Error: ' + result.errorMessage);
  });

  var chartIds = [];

  this._addChartButton.button().click(function() {
    /** @type {epiviz.events.EventResult.<{id: string}>} */
    var result = new epiviz.events.EventResult();
    var ms = new epiviz.measurements.MeasurementSet();
    ms.add(self._m2);
    self.onRequestAddChart().notify({
      type: 'epiviz.plugins.charts.BlocksTrack',
      visConfigSelection: new epiviz.ui.controls.VisConfigSelection(ms),
      result: result
    });

    alert('Adding chart was ' + (result.success ? 'successful! Chart id is: ' + result.value.id : 'unsuccessful. Error: ' + result.errorMessage));
    if (result.success) {
      chartIds.push(result.value.id);
    }
  });

  this._removeChartButton.button().click(function() {
    if (!chartIds.length) { return; }

    var chartId = chartIds.pop();
    var result = new epiviz.events.EventResult();
    self.onRequestRemoveChart().notify({
      id: chartId,
      result: result
    });

    alert('Removing chart was ' + (result.success ? 'successful!' : 'unsuccessful. Error: ' + result.errorMessage));
  });

  this._clearCacheButton.button().click(function() {
    // TODO
  });

  this._navigateButton.button().click(function() {
    var result = new epiviz.events.EventResult();
    self.onRequestNavigate().notify({
      range: epiviz.datatypes.GenomicRange.fromStartEnd('chr6', 103839409, 107422589),
      result: result
    });

    alert('Navigate was ' + (result.success ? 'successful!' : 'unsuccessful. Error: ' + result.errorMessage));
  });
};

/**
 * @returns {boolean}
 * @override
 */
epiviz.data.MockDataProvider.prototype.connected = function() { return true; };

/**
 * @param {epiviz.data.Request} request
 * @param {function(epiviz.data.Response.<*>)} callback
 * @override
 */
epiviz.data.MockDataProvider.prototype.getData = function(request, callback) {
  var requestId = request.id();
  var action = request.get('action');
  var seqName = request.get('chr');
  var start = request.get('start');
  var end = request.get('end');
  var datasource = request.get('datasource');

  /** @type {epiviz.measurements.Measurement} */
  var m, d;
  var data;

  switch (action) {
    case epiviz.data.Request.Action.GET_ROWS:
      m = this._measurements.subset(function(/** @type {epiviz.measurements.Measurement} */ m) {
        return m.datasource().datasourceId() == datasource;
      }).first();

      if (!m) { return; }

      d = m.datasource();
      data = this._values.get(d)[seqName];

      if (!data ||
        (seqName != this._coveredRegions[0].seqName() && seqName != this._coveredRegions[1].seqName()) ||
        start > this._coveredRegions[0].end() || end < this._coveredRegions[0].start()) {
        callback(epiviz.data.Response.fromRawObject({
          data: {
            values:{ id: [],  start: [], end: [], strand: "*", metadata:{ probe: [] }},
            globalStartIndex: null
          },
          requestId: requestId
        }));
        return;
      }

      callback(epiviz.data.Response.fromRawObject({
        requestId: request.id(),
        data: data
      }));
      return;

    case epiviz.data.Request.Action.GET_VALUES:
      m = this._measurements.subset(function(/** @type {epiviz.measurements.Measurement} */ m) {
        return m.datasource().datasourceId() == datasource;
      }).first();

      if (!m) { return; }
      data = this._values.get(m)[seqName];

      if (!data ||
        (seqName != this._coveredRegions[0].seqName() && seqName != this._coveredRegions[1].seqName()) ||
        start > this._coveredRegions[0].end() || end < this._coveredRegions[0].start()) {
        callback(epiviz.data.Response.fromRawObject({
          data: {
            values: [],
            globalStartIndex: null
          },
          requestId: requestId
        }));
        return;
      }

      data['requestId'] = requestId;
      callback(epiviz.data.Response.fromRawObject({
        requestId: request.id(),
        data: data
      }));
      return;

    case epiviz.data.Request.Action.GET_MEASUREMENTS:
      callback(epiviz.data.Response.fromRawObject({
        requestId: request.id(),
        type: epiviz.data.MessageType.RESPONSE,
        data: {
          id: [this._m1.id(), this._m2.id()],
          name: [this._m1.name(), this._m2.name()],
          type: [this._m1.type(), this._m2.type()],
          datasourceId: [this._m1.datasourceId(), this._m2.datasourceId()],
          datasourceGroup: [this._m1.datasourceGroup(), this._m2.datasourceGroup()],
          defaultChartType: [this._m1.defaultChartType(), this._m2.defaultChartType()],
          annotation: [this._m1.annotation(), this._m2.annotation()],
          minValue: [this._m1.minValue(), this._m2.minValue()],
          maxValue: [this._m1.maxValue(), this._m2.maxValue()],
          metadata: [this._m1.metadata(), this._m2.metadata()]
        }
      }));
      return;

    case epiviz.data.Request.Action.GET_SEQINFOS:
      callback(epiviz.data.Response.fromRawObject({
        requestId: request.id(),
        data: [['chr1', 1, 248956422], ['chr11', 1, 135086622], ['myChr', 1, 1000000000]]
      }));
      return;

    default:
      epiviz.data.DataProvider.prototype.getData.call(this, request, callback);
      break;
  }
};

// Input 130
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 7:50 PM
 */

goog.provide('epiviz.data.DataManager');

goog.require('epiviz.data.DataProvider');
goog.require('epiviz.data.DataProviderFactory');
goog.require('epiviz.measurements.MeasurementSet');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.events.EventListener');
goog.require('epiviz.data.Cache');
goog.require('epiviz.events.Event');
goog.require('epiviz.data.RequestStack');
goog.require('epiviz.datatypes.GenomicRangeArray');
goog.require('epiviz.datatypes.FeatureValueArray');
goog.require('epiviz.datatypes.MeasurementGenomicData');
goog.require('epiviz.datatypes.MeasurementGenomicDataWrapper');
goog.require('epiviz.events.EventResult');
// goog.require('epiviz.utils.arrayAppend');
// goog.require('epiviz.utils.forEach');
goog.require('epiviz.utils');


/**
 * @param {epiviz.Config} config
 * @param {epiviz.data.DataProviderFactory} dataProviderFactory
 * @constructor
 */
epiviz.data.DataManager = function(config, dataProviderFactory) {

  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._measurements = new epiviz.measurements.MeasurementSet();

  /**
   * @type {epiviz.data.DataProviderFactory}
   * @private
   */
  this._dataProviderFactory = dataProviderFactory;

  /**
   * @type {epiviz.data.Cache}
   * @private
   */
  this._cache = new epiviz.data.Cache(config, dataProviderFactory);

  /**
   * @type {Object.<string, epiviz.data.RequestStack>}
   * @private
   */
  this._combinedRequestsStacks = {};

  /**
   * @type {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestAddMeasurements = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRemoveMeasurements = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{type: string, visConfigSelection: epiviz.ui.controls.VisConfigSelection, result: epiviz.events.EventResult.<{id: string}>}>}
   * @private
   */
  this._requestAddChart = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRemoveChart = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestPrintWorkspace = new epiviz.events.Event();

    /**
   * @type {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestLoadWorkspace = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{seqInfos: Array.<epiviz.datatypes.SeqInfo>, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestAddSeqInfos = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{seqNames: Array.<string>, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRemoveSeqNames = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{range: epiviz.datatypes.GenomicRange, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestNavigate = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestRedraw = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event}
   * @private
   */
  this._flushCache = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{datasourceGroup: string}>}
   * @private
   */
  this._clearDatasourceGroupCache = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestCurrentLocation = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestGetChartSettings = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestSetChartSettings = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
   * @private
   */
  this._requestGetAvailableCharts = new epiviz.events.Event();


  this._registerProviderAddMeasurements();
  this._registerProviderRemoveMeasurements();
  this._registerProviderAddChart();
  this._registerProviderRemoveChart();
  this._registerProviderPrintWorkspace();
  this._registerProviderLoadWorkspace();
  this._registerProviderAddSeqInfos();
  this._registerProviderRemoveSeqNames();
  this._registerProviderNavigate();
  this._registerProviderRedraw();
  this._registerProviderFlushCache();
  this._registerProviderClearDatasourceGroupCache();
  this._registerProviderGetCurrentLocation();
  this._registerProviderGetChartSettings();
  this._registerProviderSetChartSettings();
  this._registerProviderGetAvailableCharts();

};

/**
 * @returns {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestAddMeasurements = function() { return this._requestAddMeasurements; };

/**
 * @returns {epiviz.events.Event.<{measurements: epiviz.measurements.MeasurementSet, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestRemoveMeasurements = function() { return this._requestRemoveMeasurements; };

/**
 * @returns {epiviz.events.Event.<{type: string, visConfigSelection: epiviz.ui.controls.VisConfigSelection, result: epiviz.events.EventResult.<{id: string}>}>}
 */
epiviz.data.DataManager.prototype.onRequestAddChart = function() { return this._requestAddChart; };

/**
 * @returns {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestRemoveChart = function() { return this._requestRemoveChart; };

/**
 * @returns {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestPrintWorkspace = function() { return this._requestPrintWorkspace; };

/**
 * @returns {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestLoadWorkspace = function() { return this._requestLoadWorkspace; };


/**
 * @returns {epiviz.events.Event.<{seqInfos: Array.<epiviz.datatypes.SeqInfo>, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestAddSeqInfos = function() { return this._requestAddSeqInfos; };

/**
 * @returns {epiviz.events.Event.<{seqNames: Array.<string>, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestRemoveSeqNames = function() { return this._requestRemoveSeqNames; };

/**
 * @returns {epiviz.events.Event.<{range: epiviz.datatypes.GenomicRange, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestNavigate = function() { return this._requestNavigate; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestRedraw = function() { return this._requestRedraw; };

/**
 * @returns {epiviz.events.Event.<{datasourceGroup: string}>}
 */
epiviz.data.DataManager.prototype.onClearDatasourceGroupCache = function() { return this._clearDatasourceGroupCache; };

/**
 * @returns {epiviz.events.Event}
 */
epiviz.data.DataManager.prototype.onFlushCache = function() { return this._flushCache; };

/**
 * @returns {epiviz.events.Event.<{result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestCurrentLocation = function() { return this._requestCurrentLocation; };

/**
 * @returns {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestGetChartSettings = function() { return this._requestGetChartSettings; };

/**
 * @returns {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestSetChartSettings = function() { return this._requestSetChartSettings; };

/**
 * @returns {epiviz.events.Event.<{id: string, result: epiviz.events.EventResult}>}
 */
epiviz.data.DataManager.prototype.onRequestGetAvailableCharts = function() { return this._requestGetAvailableCharts; };


/**
 * @param {function(Array.<epiviz.datatypes.SeqInfo>)} callback
 */
epiviz.data.DataManager.prototype.getSeqInfos = function(callback) {
  var self = this;

  var nResponses = 0;

  var existingSeqNames = {};

  /** @type {Array.<epiviz.datatypes.SeqInfo>} */
  var result = [];
  this._dataProviderFactory.foreach(function(provider) {
    provider.getData(epiviz.data.Request.getSeqInfos(provider.id()),
      /**
       * @param {epiviz.data.Response.<Array.<Array>>} response Each element in the response is an array with three values:
       * the name of the sequence, the minimum and maximum values it can have
       */
      function(response) {
        var seqs = response.data();
        if (seqs) {
          if(!Array.isArray(seqs)) {
            var keys = Object.keys(seqs);
            for (var i=0; i<keys.length; i++) {
              if (!(keys[i] in existingSeqNames)) {
                result.push(epiviz.datatypes.SeqInfo.fromRawObject([keys[i], seqs[keys[i]][0], seqs[keys[i]][1]]));
                existingSeqNames[keys[i]] = true;
              }
            }
          }
          else {
            for (var i = 0; i < seqs.length; ++i) {
              if (!(seqs[i][0] in existingSeqNames)) {
                result.push(epiviz.datatypes.SeqInfo.fromRawObject(seqs[i]));
                existingSeqNames[seqs[i][0]] = true;
              }
            }
          }
        }

        if (++nResponses < self._dataProviderFactory.size()) { return; }

        callback(result.sort(epiviz.datatypes.SeqInfo.compare));
      });
  });
};

/**
 */
epiviz.data.DataManager.prototype.updateChartSettings = function(values) {
  var self = this;

  this._dataProviderFactory.foreach(function(provider) {

    if(provider.id().includes('websocket-')) {

      var colors = null;

      if(values.colorMap != null) {
        colors = values.colorMap._colors;
      }

      provider.updateChartSettings(epiviz.data.Request.createRequest({
            action: epiviz.data.Request.Action.SET_CHART_SETTINGS,
            settings: values.settings,
            colorMap: colors,
            chartId: values.chartId
      }),
          function() {
            //do nothing
          }
      );  
    }
  });
};


/**
 * @param {function(epiviz.measurements.MeasurementSet)} callback
 */
epiviz.data.DataManager.prototype.getMeasurements = function(callback) {
  var self = this;
  var result = new epiviz.measurements.MeasurementSet();

  var nResponses = 0;
  this._dataProviderFactory.foreach(function(provider) {
    provider.getData(epiviz.data.Request.getMeasurements(provider.id()),
      /**
       * @param {epiviz.data.Response.<{
       *   id: Array.<number>,
       *   name: Array.<string>,
       *   type: Array.<string>|string,
       *   datasourceId: Array.<string>|string,
       *   datasourceGroup: Array.<string>|string,
       *   defaultChartType: Array.<string>|string,
       *   annotation: Array.<Object.<string, string>>,
       *   minValue: Array.<number>|number,
       *   maxValue: Array.<number>|number,
       *   metadata: Array.<Array.<string>>|Array.<string>
       * }>} response
       */
      function(response) {
        var jsondata = response.data();

        if (jsondata) {
          var n = jsondata['id'] ? (jsondata['id'].length || 0) : 0;
          for (var i = 0; i < n; ++i) {
            result.add(new epiviz.measurements.Measurement(
              jsondata['id'][i],
              jsondata['name'][i],
              $.isArray(jsondata['type']) ? jsondata['type'][i] : jsondata['type'],
              $.isArray(jsondata['datasourceId']) ? jsondata['datasourceId'][i] : jsondata['datasourceId'],
              $.isArray(jsondata['datasourceGroup']) ? jsondata['datasourceGroup'][i] : jsondata['datasourceGroup'],
              provider.id(),
              null,
              $.isArray(jsondata['defaultChartType']) ? jsondata['defaultChartType'][i] : jsondata['defaultChartType'],
              jsondata['annotation'][i],
              $.isArray(jsondata['minValue']) ? jsondata['minValue'][i] : jsondata['minValue'],
              $.isArray(jsondata['maxValue']) ? jsondata['maxValue'][i] : jsondata['maxValue'],
              ($.isArray(jsondata['metadata']) && $.isArray(jsondata['metadata'][0])) ? jsondata['metadata'][i] : jsondata['metadata']
            ));
          }
        }

        if (++nResponses < self._dataProviderFactory.size()) { return; }

        callback(result);
      });
  });
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {function(string, epiviz.datatypes.GenomicData)} dataReadyCallback
 */
epiviz.data.DataManager.prototype.getData = function(range, chartMeasurementsMap, dataReadyCallback) {
  if (this._config.useCache) {
    this._cache.getData(range, chartMeasurementsMap, dataReadyCallback);
  } else {
    this._getDataNoCache(range, chartMeasurementsMap, dataReadyCallback);
  }
};

/**
 * TODO: Take care of computed measurements as well
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {function(string, epiviz.datatypes.GenomicData)} dataReadyCallback
 */
epiviz.data.DataManager.prototype._getDataNoCache = function(range, chartMeasurementsMap, dataReadyCallback) {
  var self = this;

  /** @type {Object.<string, epiviz.measurements.MeasurementSet>} */
  var msByDp = {};
  for (var chartId in chartMeasurementsMap) {
    if (!chartMeasurementsMap.hasOwnProperty(chartId)) { continue; }
    var chartMsByDp = chartMeasurementsMap[chartId].split(function(m) { return m.dataprovider(); });
    for (var dp in chartMsByDp) {
      if (!chartMsByDp.hasOwnProperty(dp)) { continue; }
      var dpMs = msByDp[dp];
      if (dpMs == undefined) { msByDp[dp] = chartMsByDp[dp]; }
      else { dpMs.addAll(chartMsByDp[dp]); }
    }
  }

  /**
   * @type {Object.<string, Object.<string, epiviz.datatypes.PartialSummarizedExperiment>>}
   */
  var allData = {};
  epiviz.utils.forEach(msByDp, function(dpMs, dataprovider) {
    var msByDs = dpMs.split(function(m) { return m.datasource().id(); });
    var request = epiviz.data.Request.getCombined(msByDs, range);

    var requestStack = self._combinedRequestsStacks[dataprovider];
    if (requestStack == undefined) {
      requestStack = new epiviz.data.RequestStack();
      self._combinedRequestsStacks[dataprovider] = requestStack;
    }

    requestStack.pushRequest(request, function(data) {
      var dataByDs = {};
      epiviz.utils.forEach(msByDs, function(dsMs, datasourceId) {
        var datasource = dsMs.first().datasource();
        var dsData = data[datasourceId];
        var sumExp = new epiviz.datatypes.PartialSummarizedExperiment();

        var globalStartIndex = dsData.globalStartIndex;

        if(isNaN(range._start)) {
          range._start = globalStartIndex;
        }

        if(isNaN(range._width)) {
          range._width = dsData.rows.end[dsData.rows.end.length-1] - range._start;
        }

        var rowData = new epiviz.datatypes.GenomicRangeArray(datasource, range, globalStartIndex, dsData.rows);

        sumExp.addRowData(rowData);

        dsMs.foreach(function(m) {
          var valueData = new epiviz.datatypes.FeatureValueArray(m, range, globalStartIndex, dsData.cols[m.id()]);
          sumExp.addValues(valueData);
        });

        dataByDs[datasourceId] = sumExp;
      });

      allData[dataprovider] = dataByDs;
      self._serveAvailableData(range, chartMeasurementsMap, dataReadyCallback, allData);
    });

    var dataProvider = self._dataProviderFactory.get(dataprovider) || self._dataProviderFactory.get(epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);
    dataProvider.getData(request, function(response) {
      requestStack.serveData(response);
    });
  });
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {function(string, epiviz.datatypes.GenomicData)} dataReadyCallback
 * @param {Object.<string, Object.<string, epiviz.datatypes.PartialSummarizedExperiment>>} data
 * @private
 */
epiviz.data.DataManager.prototype._serveAvailableData = function(range, chartMeasurementsMap, dataReadyCallback, data) {
  var resolvedCharts = [];
  epiviz.utils.forEach(chartMeasurementsMap, function(ms, chartId) {
    var allMsDataFetched = true;
    var msDataMap = new epiviz.measurements.MeasurementHashtable();
    ms.foreach(function(m) {
      if (!(m.dataprovider() in data)) {
        allMsDataFetched = false;
        return true; // break
      }

      var msData = new epiviz.datatypes.MeasurementGenomicDataWrapper(m, data[m.dataprovider()][m.datasource().id()]);
      msDataMap.put(m, msData);
    });

    if (allMsDataFetched) {
      var genomicData = new epiviz.datatypes.MapGenomicData(msDataMap);
      dataReadyCallback(chartId, genomicData);
      resolvedCharts.push(chartId);
    }
  });

  resolvedCharts.forEach(function(chartId) { delete chartMeasurementsMap[chartId]; });
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {function(string, *)} dataReadyCallback
 */
epiviz.data.DataManager.prototype.getPCA = function(range, chartMeasurementsMap, dataReadyCallback) {
  var self = this;

  /** @type {Object.<string, epiviz.measurements.MeasurementSet>} */
  var msByDp = {};
  for (var chartId in chartMeasurementsMap) {
    if (!chartMeasurementsMap.hasOwnProperty(chartId)) { continue; }     
    var chartMsByDp = chartMeasurementsMap[chartId].split(function(m) { return m.dataprovider(); });
    for (var dp in chartMsByDp) {
      if (!chartMsByDp.hasOwnProperty(dp)) { continue; }
      var dpMs = msByDp[dp];
      if (dpMs == undefined) { msByDp[dp] = chartMsByDp[dp]; }
      else { dpMs.addAll(chartMsByDp[dp]); }
    }
  }

  /**
   * @type {Object.<string, Object.<string, epiviz.datatypes.PartialSummarizedExperiment>>}
   */
  var allData = {};
  epiviz.utils.forEach(msByDp, function(dpMs, dataprovider) {
    var msByDs = dpMs.split(function(m) { return m.datasource().id(); });
    var request = epiviz.data.Request.getPCA(msByDs, range);
    var msName = Object.keys(msByDs)[0];

    var dataProvider = self._dataProviderFactory.get(dataprovider) || self._dataProviderFactory.get(epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);
    dataProvider.getData(request, function(response) {
      var resp = response.data();
      if(response.data().dataprovidertype == "websocket") {
        resp = resp[msName];
      }
      dataReadyCallback(chartId, resp);
    });
  });
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartMeasurementsMap
 * @param {function(string, *)} dataReadyCallback
 */
epiviz.data.DataManager.prototype.getDiversity = function(range, chartMeasurementsMap, dataReadyCallback) {
  var self = this;

  /** @type {Object.<string, epiviz.measurements.MeasurementSet>} */
  var msByDp = {};
  for (var chartId in chartMeasurementsMap) {
    if (!chartMeasurementsMap.hasOwnProperty(chartId)) { continue; }     
    var chartMsByDp = chartMeasurementsMap[chartId].split(function(m) { return m.dataprovider(); });
    for (var dp in chartMsByDp) {
      if (!chartMsByDp.hasOwnProperty(dp)) { continue; }
      var dpMs = msByDp[dp];
      if (dpMs == undefined) { msByDp[dp] = chartMsByDp[dp]; }
      else { dpMs.addAll(chartMsByDp[dp]); }
    }
  }

  /**
   * @type {Object.<string, Object.<string, epiviz.datatypes.PartialSummarizedExperiment>>}
   */
  var allData = {};
  epiviz.utils.forEach(msByDp, function(dpMs, dataprovider) {
    var msByDs = dpMs.split(function(m) { return m.datasource().id(); });
    var request = epiviz.data.Request.getDiversity(msByDs, range);
    var msName = Object.keys(msByDs)[0];

    var dataProvider = self._dataProviderFactory.get(dataprovider) || self._dataProviderFactory.get(epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);
    dataProvider.getData(request, function(response) {
      var resp = response.data();
      if(response.data().dataprovidertype == "websocket") {
        resp = resp[msName];
      }
      dataReadyCallback(chartId, resp);
    });
  });
};

/**
 * @param {Object.<string, epiviz.ui.controls.VisConfigSelection>} chartVisConfigSelectionMap
 * @param {function(string, *)} dataReadyCallback
 */
epiviz.data.DataManager.prototype.getHierarchy = function(chartVisConfigSelectionMap, dataReadyCallback) {
  for (var chartId in chartVisConfigSelectionMap) {
    if (!chartVisConfigSelectionMap.hasOwnProperty(chartId)) { continue; }
    var visConfigSelection = chartVisConfigSelectionMap[chartId];
  }
  var dataprovider = visConfigSelection.dataprovider;
  if (!dataprovider) {
    visConfigSelection.measurements.foreach(function(m) {
      if (m.dataprovider()) {
        dataprovider = m.dataprovider();
        return true;
      }
      return false;
    });
  }
  var datasourceGroup = visConfigSelection.datasourceGroup;
  if(!datasourceGroup) {
      visConfigSelection.measurements.foreach(function(m) {
      if (m.datasourceGroup()) {
        datasourceGroup = m.datasourceGroup();
        return true;
      }
      return false;
    });
  }
  var provider = this._dataProviderFactory.get(dataprovider) || this._dataProviderFactory.get(epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);
  provider.getData(epiviz.data.Request.getHierarchy(datasourceGroup, visConfigSelection.customData), function(response) {
    dataReadyCallback(chartId, response.data());
  });
};

/**
 * @param {Object.<string, epiviz.ui.controls.VisConfigSelection>} chartVisConfigSelectionMap
 * @param {function(string, *)} dataReadyCallback
 */
epiviz.data.DataManager.prototype.propagateHierarchyChanges = function(chartVisConfigSelectionMap, dataReadyCallback) {
  for (var chartId in chartVisConfigSelectionMap) {
    if (!chartVisConfigSelectionMap.hasOwnProperty(chartId)) { continue; }
    var visConfigSelection = chartVisConfigSelectionMap[chartId];
    var dataprovider = visConfigSelection.dataprovider;
    if (!dataprovider) {
      visConfigSelection.measurements.foreach(function(m) {
        if (m.dataprovider()) {
          dataprovider = m.dataprovider();
          return true;
        }
        return false;
      });
    }
    var provider = this._dataProviderFactory.get(dataprovider) || this._dataProviderFactory.get(epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);
    (function(chartId, provider, visConfigSelection) {
      provider.getData(epiviz.data.Request.propagateHierarchyChanges(
        visConfigSelection.datasourceGroup,
        visConfigSelection.customData.selection,
        visConfigSelection.customData.order,
        visConfigSelection.customData.selectedLevels), function(response) {

        setTimeout(function() {
          provider.onRequestClearDatasourceGroupCache().notify({
            datasourceGroup: visConfigSelection.datasourceGroup,
            result: new epiviz.events.EventResult()
          });
          provider.onRequestRedraw().notify({
            result: new epiviz.events.EventResult()
          });

          dataReadyCallback(chartId, response.data());
        }, 0);
      });
    })(chartId, provider, visConfigSelection);
  }
};


/**
 * @param {function(Array)} callback
 * @param {string} [filter]
 * @param {string} [requestWorkspaceId]
 */
epiviz.data.DataManager.prototype.getWorkspaces = function(callback, filter, requestWorkspaceId) {
  var workspaceProvider = this._dataProviderFactory.workspacesDataProvider();

  if (!workspaceProvider) { throw Error('Invalid data provider for workspaces (see Config.workspaceDataProvider)'); }

  workspaceProvider.getData(epiviz.data.Request.getWorkspaces(filter, requestWorkspaceId),
    /**
     * @param {epiviz.data.Response.<Array.<{id: string, id_v1: string, name: string, content: string}>>} response
     */
    function(response) {
      var wsRows = response.data();

      var workspaces = [];

      if (!wsRows || !wsRows.length) {
        // No workspaces in database
        callback(workspaces);
        return;
      }

      for (var i = 0; i < wsRows.length; ++i) {
        workspaces.push({
          id: wsRows[i].id,
          name: wsRows[i].name,
          content: JSON.parse(wsRows[i].content)
        });
      }
      callback(workspaces);
    });
};

/**
 * @param {epiviz.workspaces.Workspace} workspace
 * @param {epiviz.Config} config
 * @param {function(string)} callback
 */
epiviz.data.DataManager.prototype.saveWorkspace = function(workspace, config, callback) {
  var workspaceProvider = this._dataProviderFactory.workspacesDataProvider();

  if (!workspaceProvider) { throw Error('Invalid data provider for workspaces (see Config.workspaceDataProvider)'); }

  //workspaceProvider.saveWorkspace(workspace, callback);
  workspaceProvider.getData(epiviz.data.Request.saveWorkspace(workspace, config),
    /**
     * @param {epiviz.data.Response.<string>} response
     */
    function(response) {
      var workspaceId = response.data();
      callback(workspaceId);
    });
};

/**
 * @param {epiviz.workspaces.Workspace} workspace
 */
epiviz.data.DataManager.prototype.deleteWorkspace = function(workspace) {
  var workspaceProvider = this._dataProviderFactory.workspacesDataProvider();

  if (!workspaceProvider) { throw Error('Invalid data provider for workspaces (see Config.workspaceDataProvider)'); }

  workspaceProvider.getData(epiviz.data.Request.deleteWorkspace(workspace),
    /**
     * @param {epiviz.data.Response.<{success: boolean}>} response
     */
    function(response) {
      var success = response.data().success;
    });
};

/**
 * @param {function(Array)} callback
 * @param {string} query
 */
epiviz.data.DataManager.prototype.search = function(callback, query) {
  var self = this;
  var remainingResponses = this._dataProviderFactory.size();
  var results = [];
  this._dataProviderFactory.foreach(function(provider) {
    provider.getData(epiviz.data.Request.search(query, self._config.maxSearchResults),
      /**
       * @param {epiviz.data.Response.<Array.<{probe: string, gene: string, seqName: string, start: number, end: number}>>} response
       */
      function(response) {
        var providerResults = response.data();
        if (providerResults) {
          epiviz.utils.arrayAppend(results, providerResults);
        }

        --remainingResponses;

        if (!remainingResponses) {
          callback(results);
        }
      });
  });
};

/**
 * Clears all data from cache
 */
epiviz.data.DataManager.prototype.flushCache = function() {
  this._cache.flush();
  this._flushCache.notify();
};

/**
 * @param {string} datasourceGroup
 */
epiviz.data.DataManager.prototype.clearDatasourceGroupCache = function(datasourceGroup) {
  this._cache.clearDatasourceGroupCache(datasourceGroup);
  this._clearDatasourceGroupCache.notify({datasourceGroup: datasourceGroup});
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderAddMeasurements = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestAddMeasurements().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestAddMeasurements.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderRemoveMeasurements = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestRemoveMeasurements().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestRemoveMeasurements.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderAddChart = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestAddChart().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestAddChart.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderRemoveChart = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestRemoveChart().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestRemoveChart.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderPrintWorkspace = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestPrintWorkspace().addListener(new epiviz.events.EventListener(
        function(e) {
          self._requestPrintWorkspace.notify(e);
        }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderLoadWorkspace = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestLoadWorkspace().addListener(new epiviz.events.EventListener(
        function(e) {
          self._requestLoadWorkspace.notify(e);
        }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderAddSeqInfos = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestAddSeqInfos().addListener(new epiviz.events.EventListener(
      /**
       * @param {{seqInfos: Array.<Array>, result: epiviz.events.EventResult}} e
       */
      function(e) {
        var seqInfos = [];
        for (var i = 0; i < e.seqInfos.length; ++i) {
          seqInfos.push(epiviz.datatypes.SeqInfo.fromRawObject(e.seqInfos[i]));
        }
        self._requestAddSeqInfos.notify({seqInfos: seqInfos, result: e.result});
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderRemoveSeqNames = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestRemoveSeqNames().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestRemoveSeqNames.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderNavigate = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestNavigate().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestNavigate.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderRedraw = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestRedraw().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestRedraw.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderClearDatasourceGroupCache = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestClearDatasourceGroupCache().addListener(new epiviz.events.EventListener(
      function(e) {
        self.clearDatasourceGroupCache(e.datasourceGroup);
        e.result.success = true;
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderFlushCache = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestFlushCache().addListener(new epiviz.events.EventListener(
      function(e) {
        self.flushCache();
        e.result.success = true;
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderGetCurrentLocation = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestCurrentLocation().addListener(new epiviz.events.EventListener(
      function(e) {
        self._requestCurrentLocation.notify(e);
      }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderSetChartSettings = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestSetChartSettings().addListener(new epiviz.events.EventListener(
        function(e) {
          self._requestSetChartSettings.notify(e);
        }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderGetChartSettings = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestGetChartSettings().addListener(new epiviz.events.EventListener(
        function(e) {
          self._requestGetChartSettings.notify(e);
        }));
  });
};

/**
 * @private
 */
epiviz.data.DataManager.prototype._registerProviderGetAvailableCharts = function() {
  var self = this;
  this._dataProviderFactory.foreach(function(/** @type {epiviz.data.DataProvider} */ provider) {
    provider.onRequestGetChartSettings().addListener(new epiviz.events.EventListener(
        function(e) {
          self._requestGetAvailableCharts.notify(e);
        }));
  });
};

// Input 131
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/31/14
 * Time: 10:16 AM
 */

goog.provide('epiviz.utils.IterableArray');

/**
 * @param {Array.<T>} array
 * @constructor
 * @implements {epiviz.utils.Iterable.<T>}
 * @template T
 */
epiviz.utils.IterableArray = function(array) {
  /**
   * @type {Array.<T>}
   * @private
   */
  this._array = array;
};

/**
 * @param {function(T)} iteration
 */
epiviz.utils.IterableArray.prototype.foreach = function(iteration) {
  for (var i = 0; i < this._array.length; ++i) {
    if (iteration(this._array[i])) { return; }
  }
};

// Input 132
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/15/13
 * Time: 11:14 AM
 */

goog.provide('epiviz.utils.Iterator');

/**
 * @interface
 * @template T
 */
epiviz.utils.Iterator = function() {};

/**
 * @returns {?T}
 */
epiviz.utils.Iterator.prototype.first = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {?T}
 */
epiviz.utils.Iterator.prototype.next = function() { throw Error('unimplemented abstract method'); };

// Input 133
/**
 * Created by: Florin Chelaru
 * Date: 10/4/13
 * Time: 11:19 AM
 */

goog.provide('epiviz.utils');
// goog.provide('epiviz.utils.capitalizeFirstLetter');
// goog.provide('epiviz.utils.fillArray');
// goog.provide('epiviz.utils.mapCopy');
// goog.provide('epiviz.utils.evaluateFullyQualifiedTypeName');
// goog.provide('epiviz.utils.generatePseudoGUID');
// goog.provide('epiviz.utils.stringContains');
// goog.provide('epiviz.utils.stringStartsWith');
// goog.provide('epiviz.utils.stringEndsWith');
// goog.provide('epiviz.utils.indexOf');
// goog.provide('epiviz.utils.arraysEqual');
// goog.provide('epiviz.utils.elementsEqual');
// goog.provide('epiviz.utils.range');
// goog.provide('epiviz.utils.arrayAppend');
// goog.provide('epiviz.utils.arrayFlip');
// goog.provide('epiviz.utils.indexOfMin');
// goog.provide('epiviz.utils.arrayIntersection');
// goog.provide('epiviz.utils.asyncFor');
// goog.provide('epiviz.utils.deferredFor');
// goog.provide('epiviz.utils.mapEquals');
// goog.provide('epiviz.utils.mapCombine');
// goog.provide('epiviz.utils.mapJoin');
// goog.provide('epiviz.utils.mapKeyIntersection');
// goog.provide('epiviz.utils.forEach');
// goog.provide('epiviz.utils.applyConstructor');
// goog.provide('epiviz.utils.getInternetExplorerVersion');
// goog.provide('epiviz.utils.colorize');
// goog.provide('epiviz.utils.colorizeBinary');
// goog.provide('epiviz.utils.sign');

goog.require('epiviz.deferred.Deferred');


epiviz.utils = function() {};

// String

/**
 * @param {string} str
 * @returns {string}
 */
epiviz.utils.capitalizeFirstLetter = function(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
};

/**
 * @param {string} str
 * @param {string} substr
 * @returns {boolean}
 */
epiviz.utils.stringContains = function(str, substr) {
  return str.indexOf(substr) != -1;
};

/**
 * @param {string} str
 * @param {string} prefix
 * @returns {boolean}
 */
epiviz.utils.stringStartsWith = function(str, prefix) {
  return str.indexOf(prefix) == 0;
};

/**
 * @param {string} str
 * @param {string} suffix
 * @returns {boolean}
 */
epiviz.utils.stringEndsWith = function(str, suffix) {
  return str.lastIndexOf(suffix) == str.length - suffix.length;
};

// Array

/**
 * Creates an array of length n filled with value
 * @param {number} n
 * @param {T} value
 * @returns {Array.<T>}
 * @template T
 */
epiviz.utils.fillArray = function(n, value) {
  n = n || 0;
  var result = new Array(n);
  for (var i = 0; i < n; ++i) {
    result[i] = value;
  }
  return result;
};

/**
 * @param {Array.<T>} arr
 * @param {function(T): boolean} predicate
 * @returns {number}
 * @template T
 */
epiviz.utils.indexOf = function(arr, predicate) {
  for (var i = 0; i < arr.length; ++i) {
    if (predicate(arr[i])) { return i; }
  }
  return -1;
};

/**
 * @param {Array} arr1
 * @param {Array} arr2
 * @returns {boolean}
 */
epiviz.utils.arraysEqual = function(arr1, arr2) {
  if (arr1 == arr2) { return true; }

  if (!arr1 || !arr2) { return false; }

  if (arr1.length != arr2.length) { return false; }

  if (arr1 < arr2 || arr2 < arr1) { return false; }

  // The previous check doesn't work when the elements of the array are complex objects
  for (var i = 0; i < arr1.length; ++i) {
    if (arr1[i] != arr2[i]) { return false; }
  }
  return true;
};

/**
 * Compares the two given arrays ignoring the order of their elements;
 * for example [1, 2, 1, 3] and [2, 1, 1, 3] will be considered equal.
 * @param {Array.<string|number>} arr1
 * @param {Array.<string|number>} arr2
 * @returns {boolean}
 */
epiviz.utils.elementsEqual = function(arr1, arr2) {
  if (arr1 == arr2) { return true; }

  if (!arr1 || !arr2) { return false; }

  if (arr1.length != arr2.length) { return false; }

  var valueMap = {};

  var i;
  for (i = 0; i < arr1.length; ++i) {
    if (!(arr1[i] in valueMap)) { valueMap[arr1[i]] = 0; }
    ++valueMap[arr1[i]];
  }

  for (i = 0; i < arr2.length; ++i) {
    if (!valueMap[arr2[i]]) { return false; }
    --valueMap[arr2[i]];
  }

  return true;
};

/**
 * Generates an array of consecutive numbers starting from startIndex
 * (or 0 if it's not defined)
 * @param {number} n
 * @param {number} [startIndex]
 */
epiviz.utils.range = function(n, startIndex) {
  startIndex = startIndex || 0;
  n = n || 0;

  var result = new Array(n);
  for (var i = 0; i < n; ++i) {
    result[i] = i + startIndex;
  }

  return result;
};

/**
 * Append an array to another in place
 * @param {Array} self
 * @param {Array} arr
 */
epiviz.utils.arrayAppend = function(self, arr) {
  self.push.apply(self, arr);
};

/**
 * @param {Array.<string|number>} arr
 * @returns {Object.<string|number, number>}
 */
epiviz.utils.arrayFlip = function(arr) {
  var result = {};
  for (var i = 0; i < arr.length; ++i) {
    result[arr[i]] = i;
  }

  return result;
};

/**
 * Gets the minimum value in the matrix, along with the i, j indices where this value is located
 * @param {Array.<Array.<number>>} matrix
 * @param {boolean} [isSymmetrical]
 * @returns {{min: number, index: Array}}
 */
epiviz.utils.indexOfMin = function(matrix, isSymmetrical) {
  var ret = null;
  var min = null;
  for (var i = 0; i < matrix.length; ++i) {
    for (var j = isSymmetrical ? (i + 1) : 0; j < matrix[i].length; ++j) {
      if (min == null || matrix[i][j] < min) {
        min = matrix[i][j];
        ret = [i, j];
      }
    }
  }

  return {min: min, index: ret};
};

/**
 * @param {Array.<number|string>} arr1
 * @param {Array.<number|string>} arr2
 * @returns {Array.<number|string>}
 */
epiviz.utils.arrayIntersection = function(arr1, arr2) {
  var arr1Map = {};
  arr1.forEach(function(e) { arr1Map[e] = e; });

  var ret = [];
  arr2.forEach(function(e) { if (e in arr1Map) { ret.push(e); }});

  return ret;
};

/**
 * @param {number} n
 * @param {function(number, function(boolean))} iterationCallback The callback parameter will be true if should break
 * @param {function} finishedCallback
 */
epiviz.utils.asyncFor = function(n, iterationCallback, finishedCallback) {
  if (!n) {
    if (finishedCallback) { finishedCallback(); }
    return;
  }

  var iteration = function(i) {
    if (i >= n) {
      if (finishedCallback) { finishedCallback(); }
      return;
    }

    iterationCallback(i, function(result) {
      if (result) {
        if (finishedCallback) { finishedCallback(); }
      }
      else {
        iteration(i + 1);
      }
    });
  };

  iteration(0);
};

/**
 * @param {number} n
 * @param {function(number): epiviz.deferred.Deferred} deferredIteration
 * @returns {epiviz.deferred.Deferred}
 */
epiviz.utils.deferredFor = function(n, deferredIteration) {
  var initial = new epiviz.deferred.Deferred();
  var ret = new epiviz.deferred.Deferred();
  var p = initial.promise();
  for (var i = 0; i < n; ++i) {
    (function(i) {
      p = p.then(function () {
        var promise = deferredIteration(i);
        if (i == n - 1) {
          promise.then(function () { ret.resolve(); });
        }
        return promise;
      });
    })(i);
  }

  initial.resolve();
  return ret;
};

// Object (Hashtable)

/**
 * Creates a copy of the given map
 * @param {Object.<K, V>} map
 * @returns {Object.<K, V>}
 * @template K, V
 */
epiviz.utils.mapCopy = function(map) {
  var result = {};
  for (var key in map) {
    if (!map.hasOwnProperty(key)) { continue; }
    result[key] = map[key];
  }

  return result;
};

/**
 * @param {Object.<K, V>} m1
 * @param {Object.<K, V>} m2
 * @returns {boolean}
 * @template K, V
 */
epiviz.utils.mapEquals = function(m1, m2) {
  if (m1 == m2) { return true; }
  if (!m1 || !m2) { return false; }

  var k;
  for (k in m1) {
    if (!m1.hasOwnProperty(k)) { continue; }
    if (!m2.hasOwnProperty(k)) { return false; }
    if (m1[k] != m2[k]) { return false; }
  }

  for (k in m2) {
    if (!m2.hasOwnProperty(k)) { continue; }
    if (!m1.hasOwnProperty(k)) { return false; }
  }

  return true;
};

/**
 * Creates a new map that contains the keys of both m1 and m2.
 * If one key is in both maps, then the value from m1 will be used.
 * @param {Object<*,*>} m1
 * @param {Object<*,*>} m2
 * @param {boolean} [combineArrayVals] specifies that array values should also be combined
 * @returns {Object<*,*>}
 */
epiviz.utils.mapCombine = function(m1, m2, combineArrayVals) {
  var result = {};

  var key;

  if (m2) {
    for (key in m2) {
      if (!m2.hasOwnProperty(key)) { continue; }
      result[key] = m2[key];
    }
  }

  if (m1) {
    for (key in m1) {
      if (!m1.hasOwnProperty(key)) { continue; }
      if (combineArrayVals &&
        result[key] && $.isArray(result[key]) &&
        m1[key] && $.isArray(m1[key])) {
        result[key] = result[key].concat(m1[key]);
      } else {
        result[key] = m1[key];
      }
    }
  }

  return result;
};

/**
 * @param {Object.<*, *>} map
 * @param {string} [keyValueSep] Default: ':'
 * @param {string} [separator] Default: ','
 */
epiviz.utils.mapJoin = function(map, keyValueSep, separator) {
  if (!keyValueSep && keyValueSep !== '') { keyValueSep = ':'; }
  if (!separator && separator !== '') { separator = ','; }
  var result = '';
  for (var key in map) {
    if (!map.hasOwnProperty(key)) { continue; }
    if (result) { result += separator; }
    result += key + keyValueSep + map[key];
  }

  return result;
};

/**
 * Gets the keys that are in both maps
 * @param {Object.<*, *>} m1
 * @param {Object.<*, *>} m2
 * @returns {Array.<*>}
 */
epiviz.utils.mapKeyIntersection = function(m1, m2) {
  var result = [];

  if (!m1 || !m2) { return result; }

  for (var key in m1) {
    if (!m1.hasOwnProperty(key)) { continue; }
    if (key in m2) { result.push(key); }
  }

  return result;
};

/**
 * Loops through all the elements of an object or until callback returns something that evaluates to true
 * @param {Object.<string|number, T>} obj
 * @param {function(T=, string|number=, Object.<string|number, T>=)} callback
 * @template T
 */
epiviz.utils.forEach = function(obj, callback) {
  for (var key in obj) {
    if (!obj.hasOwnProperty(key)) { continue; }
    if (callback(obj[key], key, obj)) { break; }
  }
};

// Reflection

/**
 * Evaluates the given string into a constructor for a type
 * @param {string} typeName
 * @returns {?function(new: T)}
 * @template T
 */
epiviz.utils.evaluateFullyQualifiedTypeName = function(typeName) {
  try {
    var namespaces = typeName.split('.');
    var func = namespaces.pop();
    var context = window;
    for (var i = 0; i < namespaces.length; ++i) {
      context = context[namespaces[i]];
    }

    var result = context[func];
    if (typeof(result) !== 'function') {
      console.error('Unknown type name: ' + typeName);
      return null;
    }

    return result;
  } catch (error) {
    console.error('Unknown type name: ' + typeName);
    return null;
  }
};

/**
 * Applies the given constructor to the given parameters and creates
 * a new instance of the class it defines
 * @param {function(new: T)} ctor
 * @param {Array} params
 * @returns {T}
 * @template T
 */
epiviz.utils.applyConstructor = function(ctor, params) {
  var obj;

  // Use a fake constructor function with the target constructor's
  // `prototype` property to create the object with the right prototype
  var fakeCtor = function() {};
  fakeCtor.prototype = ctor.prototype;

  /** @type {T} */
  obj = new fakeCtor();

  // Set the object's `constructor`
  obj.constructor = ctor;

  // Call the constructor function
  ctor.apply(obj, params);

  return obj;
};

// Misc

/**
 * @const
 * @type {number}
 */
epiviz.utils.RAD_TO_DEG = 180 / Math.PI;

/**
 * @const
 * @type {number}
 */
epiviz.utils.DEG_TO_RAD = Math.PI / 180;

/**
 * @returns {number} The version of Internet Explorer or -1 (indicating the use of another browser).
 */
epiviz.utils.getInternetExplorerVersion = function() {
  var rv = -1; // Return value assumes failure.
  if (navigator.appName == 'Microsoft Internet Explorer') {
    var ua = navigator.userAgent;
    var re  = new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");
    var match = re.exec(ua);
    if (match != null)
      rv = parseFloat(match[1]);
  }
  return rv;
};

/**
 * @param {number} size
 * @returns {string}
 */
epiviz.utils.generatePseudoGUID = function(size) {
  var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
  var result = '';

  for (var i = 0; i < size; ++i) {
    result += chars[Math.round(Math.random() * (chars.length - 1))];
  }

  return result;
};

/**
 * This function will take a set of 3 "increasing" colors and
 * return a color scale that fills in intensities between the
 * colors. For use in turning each column of the observation
 * matrix into a heatmap.
 * @param {number} min
 * @param {number} max
 * @param {number} median
 * @param {string} colorMin
 * @param {string} colorMax
 * @param {string} colorMedian
 * @returns {function(number): string} A function that takes in a number and returns a color
 */
epiviz.utils.colorize = function(min, max, median, colorMin, colorMax, colorMedian){
  return d3.scale.linear()
    .domain([min, median, max])
    .range([colorMin, colorMedian, colorMax]);
};

/**
 * @param {number} min
 * @param {number} max
 * @param {string} colorMin
 * @param {string} colorMax
 * @returns {function(number): string}
 */
epiviz.utils.colorizeBinary = function(min, max, colorMin, colorMax){
  return d3.scale.linear()
    .domain([min, max])
    .range([colorMin, colorMax]);
};

// Math

/**
 * @param {number} val
 * @returns {number}
 */
epiviz.utils.sign = function(val) { return val < 0 ? -1 : (val == 0 ? 0 : 1); };

// Input 134
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/31/14
 * Time: 10:12 AM
 */

goog.provide('epiviz.utils.Iterable');

/**
 * @interface
 * @template T
 */
epiviz.utils.Iterable = function() {};

/**
 * @param {function(T)} iteration A function that is called for every iteration;
 * if the function returns something that evaluates to true, iteration should break.
 */
epiviz.utils.Iterable.prototype.foreach = function(iteration) {};

// Input 135
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/25/14
 * Time: 10:37 PM
 */

/*
 Based on ndef.parser, by Raphael Graf(r@undefined.ch)
 http://www.undefined.ch/mparser/index.html

 Ported to JavaScript and modified by Matthew Crumley (email@matthewcrumley.com, http://silentmatt.com/)

 You are free to use and modify this code in anyway you find useful. Please leave this comment in the code
 to acknowledge its original source. If you feel like it, I enjoy hearing about projects that use my code,
 but don't feel like you have to let me know or ask permission.
 */

//  Added by stlsmiths 6/13/2011
//  re-define Array.indexOf, because IE doesn't know it ...
//
//  from http://stellapower.net/content/javascript-support-and-arrayindexof-ie
if (!Array.indexOf) {
  Array.prototype.indexOf = function (obj, start) {
    for (var i = (start || 0); i < this.length; i++) {
      if (this[i] === obj) {
        return i;
      }
    }
    return -1;
  }
}

goog.provide('epiviz.utils.ExpressionParser');

epiviz.utils.ExpressionParser = (function (scope) {
  function object(o) {
    function F() {}
    F.prototype = o;
    return new F();
  }

  var TNUMBER = 0;
  var TOP1 = 1;
  var TOP2 = 2;
  var TVAR = 3;
  var TFUNCALL = 4;

  function Token(type_, index_, prio_, number_) {
    this.type_ = type_;
    this.index_ = index_ || 0;
    this.prio_ = prio_ || 0;
    this.number_ = (number_ !== undefined && number_ !== null) ? number_ : 0;
    this.toString = function () {
      switch (this.type_) {
        case TNUMBER:
          return this.number_;
        case TOP1:
        case TOP2:
        case TVAR:
          return this.index_;
        case TFUNCALL:
          return "CALL";
        default:
          return "Invalid Token";
      }
    };
  }

  function Expression(tokens, ops1, ops2, functions) {
    this.tokens = tokens;
    this.ops1 = ops1;
    this.ops2 = ops2;
    this.functions = functions;
  }

  // Based on http://www.json.org/json2.js
  var cx = /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
    escapable = /[\\\'\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
    meta = {    // table of character substitutions
      '\b': '\\b',
      '\t': '\\t',
      '\n': '\\n',
      '\f': '\\f',
      '\r': '\\r',
      "'" : "\\'",
      '\\': '\\\\'
    };

  function escapeValue(v) {
    if (typeof v === "string") {
      escapable.lastIndex = 0;
      return escapable.test(v) ?
        "'" + v.replace(escapable, function (a) {
          var c = meta[a];
          return typeof c === 'string' ? c :
            '\\u' + ('0000' + a.charCodeAt(0).toString(16)).slice(-4);
        }) + "'" :
        "'" + v + "'";
    }
    return v;
  }

  Expression.prototype = {
    simplify: function (values) {
      values = values || {};
      var nstack = [];
      var newexpression = [];
      var n1;
      var n2;
      var f;
      var L = this.tokens.length;
      var item;
      var i = 0;
      for (i = 0; i < L; i++) {
        item = this.tokens[i];
        var type_ = item.type_;
        if (type_ === TNUMBER) {
          nstack.push(item);
        }
        else if (type_ === TVAR && (item.index_ in values)) {
          item = new Token(TNUMBER, 0, 0, values[item.index_]);
          nstack.push(item);
        }
        else if (type_ === TOP2 && nstack.length > 1) {
          n2 = nstack.pop();
          n1 = nstack.pop();
          f = this.ops2[item.index_];
          item = new Token(TNUMBER, 0, 0, f(n1.number_, n2.number_));
          nstack.push(item);
        }
        else if (type_ === TOP1 && nstack.length > 0) {
          n1 = nstack.pop();
          f = this.ops1[item.index_];
          item = new Token(TNUMBER, 0, 0, f(n1.number_));
          nstack.push(item);
        }
        else {
          while (nstack.length > 0) {
            newexpression.push(nstack.shift());
          }
          newexpression.push(item);
        }
      }
      while (nstack.length > 0) {
        newexpression.push(nstack.shift());
      }

      return new Expression(newexpression, object(this.ops1), object(this.ops2), object(this.functions));
    },

    substitute: function (variable, expr) {
      if (!(expr instanceof Expression)) {
        expr = new Parser().parse(String(expr));
      }
      var newexpression = [];
      var L = this.tokens.length;
      var item;
      var i = 0;
      for (i = 0; i < L; i++) {
        item = this.tokens[i];
        var type_ = item.type_;
        if (type_ === TVAR && item.index_ === variable) {
          for (var j = 0; j < expr.tokens.length; j++) {
            var expritem = expr.tokens[j];
            var replitem = new Token(expritem.type_, expritem.index_, expritem.prio_, expritem.number_);
            newexpression.push(replitem);
          }
        }
        else {
          newexpression.push(item);
        }
      }

      var ret = new Expression(newexpression, object(this.ops1), object(this.ops2), object(this.functions));
      return ret;
    },

    /**
     * @param {Object.<string, number>} values
     * @returns {number}
     */
    evaluate: function (values) {
      values = values || {};
      var nstack = [];
      var n1;
      var n2;
      var f;
      var L = this.tokens.length;
      var item;
      var i = 0;
      for (i = 0; i < L; i++) {
        item = this.tokens[i];
        var type_ = item.type_;
        if (type_ === TNUMBER) {
          nstack.push(item.number_);
        }
        else if (type_ === TOP2) {
          n2 = nstack.pop();
          n1 = nstack.pop();
          f = this.ops2[item.index_];
          nstack.push(f(n1, n2));
        }
        else if (type_ === TVAR) {
          if (item.index_ in values) {
            nstack.push(values[item.index_]);
          }
          else if (item.index_ in this.functions) {
            nstack.push(this.functions[item.index_]);
          }
          else {
            throw new Error("undefined variable: " + item.index_);
          }
        }
        else if (type_ === TOP1) {
          n1 = nstack.pop();
          f = this.ops1[item.index_];
          nstack.push(f(n1));
        }
        else if (type_ === TFUNCALL) {
          n1 = nstack.pop();
          f = nstack.pop();
          if (f.apply && f.call) {
            if (Object.prototype.toString.call(n1) == "[object Array]") {
              nstack.push(f.apply(undefined, n1));
            }
            else {
              nstack.push(f.call(undefined, n1));
            }
          }
          else {
            throw new Error(f + " is not a function");
          }
        }
        else {
          throw new Error("invalid Expression");
        }
      }
      if (nstack.length > 1) {
        throw new Error("invalid Expression (parity)");
      }
      return nstack[0];
    },

    /**
     * Evaluates the expression for each of the tuple of values in the given arrays
     * @param {Object.<string, Array.<number>>} values
     * @returns {Array.<number>}
     */
    evaluateArr: function(values) {
      var result = [];
      var finished = false;
      while (!finished) {
        var tuple = {};
        for (var v in values) {
          if (!values.hasOwnProperty(v)) { continue; }
          if (result.length >= values[v].length) {
            finished = true;
            break;
          }

          tuple[v] = values[v][result.length];
        }

        if (!finished) {
          result.push(this.evaluate(tuple));
        }
      }

      return result;
    },

    toString: function (toJS) {
      var nstack = [];
      var n1;
      var n2;
      var f;
      var L = this.tokens.length;
      var item;
      var i = 0;
      for (i = 0; i < L; i++) {
        item = this.tokens[i];
        var type_ = item.type_;
        if (type_ === TNUMBER) {
          nstack.push(escapeValue(item.number_));
        }
        else if (type_ === TOP2) {
          n2 = nstack.pop();
          n1 = nstack.pop();
          f = item.index_;
          if (toJS && f == "^") {
            nstack.push("Math.pow(" + n1 + "," + n2 + ")");
          }
          else {
            nstack.push("(" + n1 + f + n2 + ")");
          }
        }
        else if (type_ === TVAR) {
          nstack.push(item.index_);
        }
        else if (type_ === TOP1) {
          n1 = nstack.pop();
          f = item.index_;
          if (f === "-") {
            nstack.push("(" + f + n1 + ")");
          }
          else {
            nstack.push(f + "(" + n1 + ")");
          }
        }
        else if (type_ === TFUNCALL) {
          n1 = nstack.pop();
          f = nstack.pop();
          nstack.push(f + "(" + n1 + ")");
        }
        else {
          throw new Error("invalid Expression");
        }
      }
      if (nstack.length > 1) {
        throw new Error("invalid Expression (parity)");
      }
      return nstack[0];
    },

    variables: function () {
      var L = this.tokens.length;
      var vars = [];
      for (var i = 0; i < L; i++) {
        var item = this.tokens[i];
        if (item.type_ === TVAR && (vars.indexOf(item.index_) == -1)) {
          vars.push(item.index_);
        }
      }

      return vars;
    },

    toJSFunction: function (param, variables) {
      var f = new Function(param, "with(Parser.values) { return " + this.simplify(variables).toString(true) + "; }");
      return f;
    }
  };

  function add(a, b) {
    return Number(a) + Number(b);
  }
  function sub(a, b) {
    return a - b;
  }
  function mul(a, b) {
    return a * b;
  }
  function div(a, b) {
    return a / b;
  }
  function mod(a, b) {
    return a % b;
  }
  function concat(a, b) {
    return "" + a + b;
  }

  function neg(a) {
    return -a;
  }

  function random(a) {
    return Math.random() * (a || 1);
  }
  function fac(a) { //a!
    a = Math.floor(a);
    var b = a;
    while (a > 1) {
      b = b * (--a);
    }
    return b;
  }

  // TODO: use hypot that doesn't overflow
  function pyt(a, b) {
    return Math.sqrt(a * a + b * b);
  }

  function append(a, b) {
    if (Object.prototype.toString.call(a) != "[object Array]") {
      return [a, b];
    }
    a = a.slice();
    a.push(b);
    return a;
  }

  function Parser() {
    this.success = false;
    this.errormsg = "";
    this.expression = "";

    this.pos = 0;

    this.tokennumber = 0;
    this.tokenprio = 0;
    this.tokenindex = 0;
    this.tmpprio = 0;

    this.ops1 = {
      "sin": Math.sin,
      "cos": Math.cos,
      "tan": Math.tan,
      "asin": Math.asin,
      "acos": Math.acos,
      "atan": Math.atan,
      "sqrt": Math.sqrt,
      "log": Math.log,
      "abs": Math.abs,
      "ceil": Math.ceil,
      "floor": Math.floor,
      "round": Math.round,
      "-": neg,
      "exp": Math.exp
    };

    this.ops2 = {
      "+": add,
      "-": sub,
      "*": mul,
      "/": div,
      "%": mod,
      "^": Math.pow,
      ",": append,
      "||": concat
    };

    this.functions = {
      "random": random,
      "fac": fac,
      "min": Math.min,
      "max": Math.max,
      "pyt": pyt,
      "pow": Math.pow,
      "atan2": Math.atan2
    };

    this.consts = {
      "E": Math.E,
      "PI": Math.PI
    };
  }

  Parser.parse = function (expr) {
    return new Parser().parse(expr);
  };

  Parser.evaluate = function (expr, variables) {
    return Parser.parse(expr).evaluate(variables);
  };

  Parser.Expression = Expression;

  Parser.values = {
    sin: Math.sin,
    cos: Math.cos,
    tan: Math.tan,
    asin: Math.asin,
    acos: Math.acos,
    atan: Math.atan,
    sqrt: Math.sqrt,
    log: Math.log,
    abs: Math.abs,
    ceil: Math.ceil,
    floor: Math.floor,
    round: Math.round,
    random: random,
    fac: fac,
    exp: Math.exp,
    min: Math.min,
    max: Math.max,
    pyt: pyt,
    pow: Math.pow,
    atan2: Math.atan2,
    E: Math.E,
    PI: Math.PI
  };

  var PRIMARY      = 1 << 0;
  var OPERATOR     = 1 << 1;
  var FUNCTION     = 1 << 2;
  var LPAREN       = 1 << 3;
  var RPAREN       = 1 << 4;
  var COMMA        = 1 << 5;
  var SIGN         = 1 << 6;
  var CALL         = 1 << 7;
  var NULLARY_CALL = 1 << 8;

  Parser.prototype = {
    parse: function (expr) {
      this.errormsg = "";
      this.success = true;
      var operstack = [];
      var tokenstack = [];
      this.tmpprio = 0;
      var expected = (PRIMARY | LPAREN | FUNCTION | SIGN);
      var noperators = 0;
      this.expression = expr;
      this.pos = 0;

      while (this.pos < this.expression.length) {
        if (this.isOperator()) {
          if (this.isSign() && (expected & SIGN)) {
            if (this.isNegativeSign()) {
              this.tokenprio = 2;
              this.tokenindex = "-";
              noperators++;
              this.addfunc(tokenstack, operstack, TOP1);
            }
            expected = (PRIMARY | LPAREN | FUNCTION | SIGN);
          }
          else if (this.isComment()) {

          }
          else {
            if ((expected & OPERATOR) === 0) {
              this.error_parsing(this.pos, "unexpected operator");
            }
            noperators += 2;
            this.addfunc(tokenstack, operstack, TOP2);
            expected = (PRIMARY | LPAREN | FUNCTION | SIGN);
          }
        }
        else if (this.isNumber()) {
          if ((expected & PRIMARY) === 0) {
            this.error_parsing(this.pos, "unexpected number");
          }
          var token = new Token(TNUMBER, 0, 0, this.tokennumber);
          tokenstack.push(token);

          expected = (OPERATOR | RPAREN | COMMA);
        }
        else if (this.isString()) {
          if ((expected & PRIMARY) === 0) {
            this.error_parsing(this.pos, "unexpected string");
          }
          var token = new Token(TNUMBER, 0, 0, this.tokennumber);
          tokenstack.push(token);

          expected = (OPERATOR | RPAREN | COMMA);
        }
        else if (this.isLeftParenth()) {
          if ((expected & LPAREN) === 0) {
            this.error_parsing(this.pos, "unexpected \"(\"");
          }

          if (expected & CALL) {
            noperators += 2;
            this.tokenprio = -2;
            this.tokenindex = -1;
            this.addfunc(tokenstack, operstack, TFUNCALL);
          }

          expected = (PRIMARY | LPAREN | FUNCTION | SIGN | NULLARY_CALL);
        }
        else if (this.isRightParenth()) {
          if (expected & NULLARY_CALL) {
            var token = new Token(TNUMBER, 0, 0, []);
            tokenstack.push(token);
          }
          else if ((expected & RPAREN) === 0) {
            this.error_parsing(this.pos, "unexpected \")\"");
          }

          expected = (OPERATOR | RPAREN | COMMA | LPAREN | CALL);
        }
        else if (this.isComma()) {
          if ((expected & COMMA) === 0) {
            this.error_parsing(this.pos, "unexpected \",\"");
          }
          this.addfunc(tokenstack, operstack, TOP2);
          noperators += 2;
          expected = (PRIMARY | LPAREN | FUNCTION | SIGN);
        }
        else if (this.isConst()) {
          if ((expected & PRIMARY) === 0) {
            this.error_parsing(this.pos, "unexpected constant");
          }
          var consttoken = new Token(TNUMBER, 0, 0, this.tokennumber);
          tokenstack.push(consttoken);
          expected = (OPERATOR | RPAREN | COMMA);
        }
        else if (this.isOp2()) {
          if ((expected & FUNCTION) === 0) {
            this.error_parsing(this.pos, "unexpected function");
          }
          this.addfunc(tokenstack, operstack, TOP2);
          noperators += 2;
          expected = (LPAREN);
        }
        else if (this.isOp1()) {
          if ((expected & FUNCTION) === 0) {
            this.error_parsing(this.pos, "unexpected function");
          }
          this.addfunc(tokenstack, operstack, TOP1);
          noperators++;
          expected = (LPAREN);
        }
        else if (this.isVar()) {
          if ((expected & PRIMARY) === 0) {
            this.error_parsing(this.pos, "unexpected variable");
          }
          var vartoken = new Token(TVAR, this.tokenindex, 0, 0);
          tokenstack.push(vartoken);

          expected = (OPERATOR | RPAREN | COMMA | LPAREN | CALL);
        }
        else if (this.isWhite()) {
        }
        else {
          if (this.errormsg === "") {
            this.error_parsing(this.pos, "unknown character");
          }
          else {
            this.error_parsing(this.pos, this.errormsg);
          }
        }
      }
      if (this.tmpprio < 0 || this.tmpprio >= 10) {
        this.error_parsing(this.pos, "unmatched \"()\"");
      }
      while (operstack.length > 0) {
        var tmp = operstack.pop();
        tokenstack.push(tmp);
      }
      if (noperators + 1 !== tokenstack.length) {
        //print(noperators + 1);
        //print(tokenstack);
        this.error_parsing(this.pos, "parity");
      }

      return new Expression(tokenstack, object(this.ops1), object(this.ops2), object(this.functions));
    },

    evaluate: function (expr, variables) {
      return this.parse(expr).evaluate(variables);
    },

    error_parsing: function (column, msg) {
      this.success = false;
      this.errormsg = "parse error [column " + (column) + "]: " + msg;
      throw new Error(this.errormsg);
    },

//\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\

    addfunc: function (tokenstack, operstack, type_) {
      var operator = new Token(type_, this.tokenindex, this.tokenprio + this.tmpprio, 0);
      while (operstack.length > 0) {
        if (operator.prio_ <= operstack[operstack.length - 1].prio_) {
          tokenstack.push(operstack.pop());
        }
        else {
          break;
        }
      }
      operstack.push(operator);
    },

    isNumber: function () {
      var r = false;
      var str = "";
      while (this.pos < this.expression.length) {
        var code = this.expression.charCodeAt(this.pos);
        if ((code >= 48 && code <= 57) || code === 46) {
          str += this.expression.charAt(this.pos);
          this.pos++;
          this.tokennumber = parseFloat(str);
          r = true;
        }
        else {
          break;
        }
      }
      return r;
    },

    // Ported from the yajjl JSON parser at http://code.google.com/p/yajjl/
    unescape: function(v, pos) {
      var buffer = [];
      var escaping = false;

      for (var i = 0; i < v.length; i++) {
        var c = v.charAt(i);

        if (escaping) {
          switch (c) {
            case "'":
              buffer.push("'");
              break;
            case '\\':
              buffer.push('\\');
              break;
            case '/':
              buffer.push('/');
              break;
            case 'b':
              buffer.push('\b');
              break;
            case 'f':
              buffer.push('\f');
              break;
            case 'n':
              buffer.push('\n');
              break;
            case 'r':
              buffer.push('\r');
              break;
            case 't':
              buffer.push('\t');
              break;
            case 'u':
              // interpret the following 4 characters as the hex of the unicode code point
              var codePoint = parseInt(v.substring(i + 1, i + 5), 16);
              buffer.push(String.fromCharCode(codePoint));
              i += 4;
              break;
            default:
              throw this.error_parsing(pos + i, "Illegal escape sequence: '\\" + c + "'");
          }
          escaping = false;
        } else {
          if (c == '\\') {
            escaping = true;
          } else {
            buffer.push(c);
          }
        }
      }

      return buffer.join('');
    },

    isString: function () {
      var r = false;
      var str = "";
      var startpos = this.pos;
      if (this.pos < this.expression.length && this.expression.charAt(this.pos) == "'") {
        this.pos++;
        while (this.pos < this.expression.length) {
          var code = this.expression.charAt(this.pos);
          if (code != "'" || str.slice(-1) == "\\") {
            str += this.expression.charAt(this.pos);
            this.pos++;
          }
          else {
            this.pos++;
            this.tokennumber = this.unescape(str, startpos);
            r = true;
            break;
          }
        }
      }
      return r;
    },

    isConst: function () {
      var str;
      for (var i in this.consts) {
        if (true) {
          var L = i.length;
          str = this.expression.substr(this.pos, L);
          if (i === str) {
            this.tokennumber = this.consts[i];
            this.pos += L;
            return true;
          }
        }
      }
      return false;
    },

    isOperator: function () {
      var code = this.expression.charCodeAt(this.pos);
      if (code === 43) { // +
        this.tokenprio = 0;
        this.tokenindex = "+";
      }
      else if (code === 45) { // -
        this.tokenprio = 0;
        this.tokenindex = "-";
      }
      else if (code === 124) { // |
        if (this.expression.charCodeAt(this.pos + 1) === 124) {
          this.pos++;
          this.tokenprio = 0;
          this.tokenindex = "||";
        }
        else {
          return false;
        }
      }
      else if (code === 42) { // *
        this.tokenprio = 1;
        this.tokenindex = "*";
      }
      else if (code === 47) { // /
        this.tokenprio = 2;
        this.tokenindex = "/";
      }
      else if (code === 37) { // %
        this.tokenprio = 2;
        this.tokenindex = "%";
      }
      else if (code === 94) { // ^
        this.tokenprio = 3;
        this.tokenindex = "^";
      }
      else {
        return false;
      }
      this.pos++;
      return true;
    },

    isSign: function () {
      var code = this.expression.charCodeAt(this.pos - 1);
      if (code === 45 || code === 43) { // -
        return true;
      }
      return false;
    },

    isPositiveSign: function () {
      var code = this.expression.charCodeAt(this.pos - 1);
      if (code === 43) { // -
        return true;
      }
      return false;
    },

    isNegativeSign: function () {
      var code = this.expression.charCodeAt(this.pos - 1);
      if (code === 45) { // -
        return true;
      }
      return false;
    },

    isLeftParenth: function () {
      var code = this.expression.charCodeAt(this.pos);
      if (code === 40) { // (
        this.pos++;
        this.tmpprio += 10;
        return true;
      }
      return false;
    },

    isRightParenth: function () {
      var code = this.expression.charCodeAt(this.pos);
      if (code === 41) { // )
        this.pos++;
        this.tmpprio -= 10;
        return true;
      }
      return false;
    },

    isComma: function () {
      var code = this.expression.charCodeAt(this.pos);
      if (code === 44) { // ,
        this.pos++;
        this.tokenprio = -1;
        this.tokenindex = ",";
        return true;
      }
      return false;
    },

    isWhite: function () {
      var code = this.expression.charCodeAt(this.pos);
      if (code === 32 || code === 9 || code === 10 || code === 13) {
        this.pos++;
        return true;
      }
      return false;
    },

    isOp1: function () {
      var str = "";
      for (var i = this.pos; i < this.expression.length; i++) {
        var c = this.expression.charAt(i);
        if (c.toUpperCase() === c.toLowerCase()) {
          if (i === this.pos || (c != '_' && (c < '0' || c > '9'))) {
            break;
          }
        }
        str += c;
      }
      if (str.length > 0 && (str in this.ops1)) {
        this.tokenindex = str;
        this.tokenprio = 5;
        this.pos += str.length;
        return true;
      }
      return false;
    },

    isOp2: function () {
      var str = "";
      for (var i = this.pos; i < this.expression.length; i++) {
        var c = this.expression.charAt(i);
        if (c.toUpperCase() === c.toLowerCase()) {
          if (i === this.pos || (c != '_' && (c < '0' || c > '9'))) {
            break;
          }
        }
        str += c;
      }
      if (str.length > 0 && (str in this.ops2)) {
        this.tokenindex = str;
        this.tokenprio = 5;
        this.pos += str.length;
        return true;
      }
      return false;
    },

    isVar: function () {
      var str = "";
      for (var i = this.pos; i < this.expression.length; i++) {
        var c = this.expression.charAt(i);
        if (c.toUpperCase() === c.toLowerCase()) {
          if (i === this.pos || (c != '_' && (c < '0' || c > '9'))) {
            break;
          }
        }
        str += c;
      }

      // Added by Florin Chelaru, on 2/25/2014:
      // Support variables in the form {0}
      var start = this.pos, end = this.expression.indexOf('}', this.pos);
      if (this.expression.charAt(start) == '{' && end > start) {
        str = this.expression.substring(start, end + 1);
      }

      if (str.length > 0) {
        this.tokenindex = str;
        this.tokenprio = 4;
        this.pos += str.length;
        return true;
      }
      return false;
    },

    isComment: function () {
      var code = this.expression.charCodeAt(this.pos - 1);
      if (code === 47 && this.expression.charCodeAt(this.pos) === 42) {
        this.pos = this.expression.indexOf("*/", this.pos) + 2;
        if (this.pos === 1) {
          this.pos = this.expression.length;
        }
        return true;
      }
      return false;
    }
  };

  scope.Parser = Parser;
  return Parser
})(typeof exports === 'undefined' ? {} : exports);


// Input 136
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 11:55 PM
 */

goog.provide('epiviz.plugins.charts.DiversityScatterPlotType');

goog.require('epiviz.plugins.charts.DiversityScatterPlot');
goog.require('epiviz.ui.charts.PlotType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.PlotType}
 * @constructor
 */
epiviz.plugins.charts.DiversityScatterPlotType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.PlotType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.PlotType.prototype);
epiviz.plugins.charts.DiversityScatterPlotType.constructor = epiviz.plugins.charts.DiversityScatterPlotType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.ScatterPlot}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.DiversityScatterPlot(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.DiversityScatterPlot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.chartName = function() {
  return 'Diversity Scatter Plot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.chartHtmlAttributeName = function() {
  return 'diversity_scatter';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.measurementsFilter = function() { return function(m) { return epiviz.measurements.Measurement.Type.hasValues(m.type()); }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * Gets the minimum number of measurements that must be selected for the chart to be displayed
 * @returns {number}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.minSelectedMeasurements = function() { return 2; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.DiversityScatterPlotType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.PlotType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.DiversityScatterPlotType.CustomSettings.CIRCLE_RADIUS_RATIO,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      0.015,
      'Circle radius ratio'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_ANNOTATION,
      'name',
      'Row labels'),
      
    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.X_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min X'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.X_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max X'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max Y')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.DiversityScatterPlotType.CustomSettings = {
  CIRCLE_RADIUS_RATIO: 'circleRadiusRatio'
};

// goog.inherits(epiviz.plugins.charts.DiversityScatterPlotType, epiviz.ui.charts.PlotType);

// Input 137
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 11:55 PM
 */

goog.provide('epiviz.plugins.charts.CustomScatterPlotType');

goog.require('epiviz.plugins.charts.CustomScatterPlot');
goog.require('epiviz.ui.charts.PlotType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.PlotType}
 * @constructor
 */
epiviz.plugins.charts.CustomScatterPlotType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.PlotType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.PlotType.prototype);
epiviz.plugins.charts.CustomScatterPlotType.constructor = epiviz.plugins.charts.CustomScatterPlotType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.ScatterPlot}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.CustomScatterPlot(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.CustomScatterPlot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.chartName = function() {
  return 'PCA Scatter Plot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.chartHtmlAttributeName = function() {
  return 'pca_scatter';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.measurementsFilter = function() { return function(m) { return epiviz.measurements.Measurement.Type.hasValues(m.type()); }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * Gets the minimum number of measurements that must be selected for the chart to be displayed
 * @returns {number}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.minSelectedMeasurements = function() { return 2; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.CustomScatterPlotType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.PlotType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.CustomScatterPlotType.CustomSettings.CIRCLE_RADIUS_RATIO,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      0.015,
      'Circle radius ratio'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.X_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min X'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.X_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max X'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.CustomScatterPlotType.CustomSettings.COLOR_BY,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_ANNOTATION,
      'name',
      'Color By')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.CustomScatterPlotType.CustomSettings = {
  CIRCLE_RADIUS_RATIO: 'circleRadiusRatio',
  COLOR_BY: 'colorBy'
};

// goog.inherits(epiviz.plugins.charts.CustomScatterPlotType, epiviz.ui.charts.PlotType);

// Input 138
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/1/14
 * Time: 5:56 PM
 */

goog.provide('epiviz.plugins.charts.HeatmapPlot');

goog.require('epiviz.ui.charts.Plot');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory');
goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.datatypes.MapGenomicData');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Plot}
 * @constructor
 */
epiviz.plugins.charts.HeatmapPlot = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Plot.call(this, id, container, properties);

  /**
   * D3 chart container
   * @type {*}
   * @private
   */
  this._chartContent = null;

  /**
   * @type {number}
   * @private
   */
  this._min = this.measurements().first().minValue();

  /**
   * @type {number}
   * @private
   */
  this._max = this.measurements().first().maxValue();

  /**
   * @type {function(number): string}
   * @private
   */
  this._colorScale = epiviz.utils.colorizeBinary(this._min, this._max, '#ffffff', this.colors().getByKey('Max'));

  /**
   * @type {Array.<string>}
   * @private
   */
  this._colorLabels = [];

  /**
   * @type {number}
   * @private
   */
  this._dendrogramRatio = 0.1;

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.HeatmapPlot.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Plot.prototype);
epiviz.plugins.charts.HeatmapPlot.constructor = epiviz.plugins.charts.HeatmapPlot;

/**
 * @protected
 */
epiviz.plugins.charts.HeatmapPlot.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Plot.prototype._initialize.call(this);
  this._svg.classed('heatmap-plot', true);
  this._chartContent = this._svg.append('g').attr('class', 'chart-content');
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {epiviz.datatypes.GenomicData} [data]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.HeatmapPlot.prototype.draw = function(range, data) {

  epiviz.ui.charts.Plot.prototype.draw.call(this, range, data);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  var cluster = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTER];

  var pair = this._applyClustering(range, data);

  /** @type {epiviz.datatypes.GenomicData} */
  var orderedData = pair.data;
  var colOrder = pair.columnOrder;

  return this._drawCells(range, orderedData, colOrder);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @returns {{data:epiviz.datatypes.GenomicData, columnOrder:Array.<number>}}
 * @private
 */
epiviz.plugins.charts.HeatmapPlot.prototype._applyClustering = function(range, data) {
  // TODO: This might not be needed anymore
  // TODO: Search for all usages of this method
  var dataHasGenomicLocation = epiviz.measurements.Measurement.Type.isOrdered(this.measurements().first().type());

  // Apply clustering
  var cluster = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTER];
  var showDendrogram = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_DENDROGRAM];
  var clusteringAlgFactory = epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.instance();
  var clusterer = clusteringAlgFactory.algorithm(
    this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTERING_ALG]);
  var metric = clusteringAlgFactory.metric(
    this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTERING_METRIC]);
  var linkage = clusteringAlgFactory.linkage(
    this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTERING_LINKAGE]);
  var maxColumns = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.MAX_COLUMNS];

  var firstGlobalIndex = data.firstSeries().globalStartIndex();
  var lastGlobalIndex = data.firstSeries().size() + firstGlobalIndex;

  data.foreach(function(measurement, series) {
    var firstIndex = series.globalStartIndex();
    var lastIndex = series.globalEndIndex();

    if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
  });
  var nEntries = lastGlobalIndex - firstGlobalIndex;

  var clusterRows = (cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.ROWS || cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.BOTH);
  var clusterCols = (cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.COLS || cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.BOTH);
  var dendrogramRatio = showDendrogram * this._dendrogramRatio;
  var dendrogramCols = (showDendrogram && clusterCols && maxColumns >= nEntries);

  var population, dendrogram, indexOrder, top, left, height, width;

  var svg = this._svg;
  ['dendrogram-horizontal', 'dendrogram-vertical'].forEach(function(dendClass) { svg.select('.' + dendClass).remove(); });

  /** @type {epiviz.datatypes.GenomicData} */
  var orderedData = data;

  if (clusterRows) {
    population = [];
    data.foreach(function(measurement, series) {
      var row = [];
      for (var j = 0; j < nEntries; ++j) {
        var globalIndex = j + firstGlobalIndex;
        var item = series.getByGlobalIndex(globalIndex);
        var rowInfo = item.rowItem;

        if (!dataHasGenomicLocation ||
            (range.start() == undefined || range.end() == undefined) ||
            rowInfo.start() < range.end() && rowInfo.end() >= range.start()) {
          row.push(item.value);
        }
      }
      population.push(row);
    });
    dendrogram = clusterer.cluster(population, metric, linkage);
    indexOrder = dendrogram.root().data();
    var measurements = [];
    data.foreach(function(measurement) { measurements.push(measurement); });
    var orderedMs = [];
    var i;
    for (i = 0; i < indexOrder.length; ++i) {
      orderedMs[i] = measurements[indexOrder[i]];
    }

    var ordered = new epiviz.measurements.MeasurementHashtable();
    for (i = 0; i < orderedMs.length; ++i) {
      ordered.put(orderedMs[i], data.getSeries(orderedMs[i]));
    }
    orderedData = new epiviz.datatypes.MapGenomicData(ordered);

    if (dendrogramRatio) {
      width = (this.width()) * dendrogramRatio;
      height = this.height() * (1 - dendrogramRatio * dendrogramCols) - this.margins().sumAxis(epiviz.ui.charts.Axis.Y);
      top = this.margins().top();
      left = this.width() - width - this.margins().right();
      this._drawDendrogram(dendrogram, top, left, height, width);
    }
  }

  // Column clustering
  indexOrder = null;
  if (clusterCols) {
    population = [];
    data.foreach(function(measurement, series) {
      for (var j = 0, row = 0; j < nEntries; ++j) {
        var globalIndex = j + firstGlobalIndex;
        var item = series.getByGlobalIndex(globalIndex);
        var rowInfo = item.rowItem;
        if (!dataHasGenomicLocation ||
            (range.start() == undefined || range.end() == undefined) ||
            rowInfo.start() < range.end() && rowInfo.end() >= range.start()) {
          if (population.length <= row) {
            population.push([]);
          }
          population[row].push(item.value);
          ++row;
        }
      }
    });

    if (population.length == 0) {
      return {data: orderedData, columnOrder: []};
    }

    dendrogram = clusterer.cluster(population, metric, linkage);
    indexOrder = dendrogram.root().data();

    if (dendrogramCols) {
      var rowLabelsAsColors = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_COLORS_FOR_ROW_LABELS];
      var rowLabelColorWidth = rowLabelsAsColors ? 20 : 0; // TODO: Customize
      left = this.margins().left();
      top = this.height() * (1 - dendrogramRatio) - this.margins().bottom();
      width = this.height() * dendrogramRatio;
      height = this.width() * (1 - dendrogramRatio * clusterRows) - this.margins().left() - this.margins().right() - rowLabelColorWidth;
      this._drawDendrogram(dendrogram, top, left, height, width, true);
    }
  }

  return {data: orderedData, columnOrder: indexOrder};
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {Array.<number>} [colOrder]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.HeatmapPlot.prototype._drawCells = function(range, data, colOrder) {
  var self = this;
  var Axis = epiviz.ui.charts.Axis;

  var maxColumns = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.MAX_COLUMNS];

  var firstGlobalIndex = data.firstSeries().globalStartIndex();
  var lastGlobalIndex = data.firstSeries().size() + firstGlobalIndex;
  var rows = [];

  // TODO: This might not be needed anymore
  // TODO: Search for all usages of this method
  var dataHasGenomicLocation = epiviz.measurements.Measurement.Type.isOrdered(this.measurements().first().type());

  data.foreach(function(measurement, series) {
    var firstIndex = series.globalStartIndex();
    var lastIndex = series.globalEndIndex();

    if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }

    rows.push(measurement);
  });

  var nEntries = lastGlobalIndex - firstGlobalIndex;

  var colLabel = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.COL_LABEL];

  //var dendrogramRatio = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.DENDROGRAM_RATIO];
  var cluster = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTER];
  var clusterRows = (cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.ROWS || cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.BOTH);
  var clusterCols = ((cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.COLS || cluster == epiviz.plugins.charts.HeatmapPlotType.Cluster.BOTH)
                     && maxColumns >= nEntries);

  var dendrogramRatio = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_DENDROGRAM] * this._dendrogramRatio;
  var rowLabelsAsColors = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_COLORS_FOR_ROW_LABELS];
  var rowLabelColorWidth = rowLabelsAsColors ? 20 : 0; // TODO: Customize


  var width = this.width() * (1 - dendrogramRatio * clusterRows) - rowLabelColorWidth;
  var height = this.height() * (1 - dendrogramRatio * clusterCols);

  var globalIndices = [];
  var colnames = [];
  var i, globalIndex;

  for (i = 0; i < nEntries; ++i) {
    globalIndex = i + firstGlobalIndex;

    // Find a defined row item for the data
    var item;
    data.foreach(function(m, series) {
      item = series.getRowByGlobalIndex(globalIndex);
      return item; // break if item is defined
    });

    if (!item) { continue; }

    if (!dataHasGenomicLocation ||
      (range.start() == undefined || range.end() == undefined) ||
      item.start() < range.end() && item.end() >= range.start()) {
      globalIndices.push(globalIndex);
      var label = item.metadata(colLabel) || '' + item.id();
      colnames.push(label);
    }
  }

  if (colOrder) {
    var unorderedGlobalIndices = globalIndices;
    var unorderedColnames = colnames;
    globalIndices = new Array(globalIndices.length);
    colnames = new Array(colnames.length);
    for (i = 0; i < globalIndices.length; ++i) {
      globalIndices[i] = unorderedGlobalIndices[colOrder[i]];
      colnames[i] = unorderedColnames[colOrder[i]];
      // TODO: Columnmap seems to have same functionality as globalIndices!
      //columnMap[i] = globalIndices[i];
    }
  }

  /** @type {Array.<epiviz.ui.charts.ChartObject>} */
  var items = [];
  var colIndex = {};
  data.foreach(function(m, series, seriesIndex) {
    var nextCellsPerCol = Math.ceil(colnames.length / maxColumns), cellsPerCol = 0;
    var colsLeft = maxColumns;
    for (var i = 0; i < colnames.length; ++i) {
      globalIndex = globalIndices[i];

      var cell = series.getByGlobalIndex(globalIndex);
      if (!cell) { continue; }
      var uiObj = null;
      if (cellsPerCol == 0) {
        var classes = sprintf('item data-series-%s', seriesIndex);

        uiObj = new epiviz.ui.charts.ChartObject(
          sprintf('heatmap_%s_%s', seriesIndex, globalIndex),
          cell.rowItem.start(),
          cell.rowItem.end(),
          [cell.value],
          seriesIndex,
          [[cell]], // valueItems one for each measurement
          [m], // measurements
          classes);
        items.push(uiObj);

        nextCellsPerCol = Math.ceil((colnames.length - i) / colsLeft);
        cellsPerCol = nextCellsPerCol;
        --colsLeft;
      } else {
        uiObj = items[items.length - 1];
        uiObj.id += '_' + globalIndex;
        if (epiviz.measurements.Measurement.Type.isOrdered(series.measurement().type())) {
          uiObj.start = Math.min(uiObj.start, cell.rowItem.start());
          uiObj.end = Math.max(uiObj.end, cell.rowItem.end());
        }
        uiObj.values[0] = (uiObj.values[0] * uiObj.valueItems[0].length + cell.value) / (uiObj.valueItems[0].length + 1);
        uiObj.valueItems[0].push(cell);
      }

      if (seriesIndex == 0) {
        colIndex[globalIndex] = items.length - 1;
      }

      --cellsPerCol;
    }
  });

  var colorLabelsMap;
  var colorScales;
  this._min = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MIN];
  this._max = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MAX];
  var CustomSetting = epiviz.ui.charts.CustomSetting;
  if (this._min == CustomSetting.DEFAULT) { this._min = data.measurements()[0].minValue(); }
  if (this._max == CustomSetting.DEFAULT) { this._max = data.measurements()[0].maxValue(); }
  if (this._globalIndexColorLabels) {
    colorLabelsMap = {};
    for (var j = firstGlobalIndex; j < lastGlobalIndex; ++j) {
      colorLabelsMap[this._globalIndexColorLabels[j]] = this._globalIndexColorLabels[j];
    }
    this._colorLabels = Object.keys(colorLabelsMap);
    colorScales = {};
    this._colorLabels.forEach(function(label, i) {
      var color = self.colors().getByKey(label);
      colorScales[label] = epiviz.utils.colorizeBinary(self._min, self._max, '#ffffff', color);
    });
  } else {
    this._colorLabels = [
      sprintf('Max', data.firstSeries().measurement().maxValue())
    ];
    this._colorScale = epiviz.utils.colorizeBinary(this._min, this._max, '#ffffff', this.colors().getByKey('Max'));
  }

  var nCols = Math.min(colnames.length, maxColumns);
  var cellWidth = nCols ? (width - this.margins().sumAxis(Axis.X)) / nCols : 0;
  var cellHeight = (height - this.margins().sumAxis(Axis.Y)) / data.measurements().length;

  var itemsGroup = this._chartContent.select('.items');

  if (itemsGroup.empty()) {
    itemsGroup = this._chartContent.append('g')
      .attr('class', 'items');
    var selectedGroup = itemsGroup.append('g').attr('class', 'selected');
    itemsGroup.append('g').attr('class', 'hovered');
    selectedGroup.append('g').attr('class', 'hovered');
  }

  itemsGroup.attr('transform', 'translate(' + this.margins().left() + ', ' + this.margins().top() + ')');

  var selection = itemsGroup.selectAll('rect').data(items, function(d) { return d.id; });

  selection
    .enter()
    .append('rect')
    .attr('id', function (d) {
      return sprintf('%s-item-%s-%s', self.id(), d.seriesIndex, d.valueItems[0][0].globalIndex);
    })
    .attr('class', function(d) { return d.cssClasses; })
    .style('opacity', 0)
    .style('fill-opacity', 0)
    .attr('x', function(d) { return cellWidth * colIndex[d.valueItems[0][0].globalIndex]; })
    .attr('y', function(d) { return cellHeight * d.seriesIndex; })
    .attr('width', cellWidth)
    .attr('height', cellHeight)
    .style('fill', function(d, i) {
      if (!self._globalIndexColorLabels) { return self._colorScale(d.values[0]); }
      return colorScales[self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]](d.values[0]);
    });

  selection
    .transition()
    .duration(1000)
    .style('fill-opacity', null)
    .style('opacity', null)
    .attr('x', function(d) {
      return cellWidth * colIndex[d.valueItems[0][0].globalIndex];
    })
    .attr('y', function(d) { return cellHeight * d.seriesIndex; })
    .attr('width', cellWidth)
    .attr('height', cellHeight)
    .style('fill', function(d) {
      if (!self._globalIndexColorLabels) { return self._colorScale(d.values[0]); }
      return colorScales[self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]](d.values[0]);
    });

  selection
    .exit()
    .transition()
    .duration(1000)
    .style('opacity', 0)
    .remove();

  selection
    .on('mouseover', function (d) {
      self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
    })
    .on('mouseout', function () {
      self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
    })
    .on('click', function (d) {
      self._deselect.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
      self._select.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));

      d3.event.stopPropagation();
    });

  this._drawLabels(itemsGroup, colnames, globalIndices, nCols, rows, cellWidth, cellHeight, firstGlobalIndex, width);

  return items;
};

/**
 * @param {epiviz.ui.charts.transform.clustering.ClusterTree} dendrogram
 * @param {number} top
 * @param {number} left
 * @param {number} height
 * @param {number} width
 * @param {boolean} [horizontal]
 * @private
 */
epiviz.plugins.charts.HeatmapPlot.prototype._drawDendrogram = function(dendrogram, top, left, height, width, horizontal) {
  var dendClass = horizontal ? 'dendrogram-horizontal' : 'dendrogram-vertical';
  var showLabels = false;

  var dendContainer = this._svg.append('g').attr('class', dendClass);

  if (!horizontal) {
    dendContainer.attr('transform', 'translate(' + left + ',' + top + ')');
    this._drawSubDendrogram(this._svg.select('.' + dendClass), dendrogram.root(), 0, 0, width, height, showLabels);
  } else {
    dendContainer.attr('transform', 'translate(' + left + ',' + top + ')scale(-1, 1)rotate(90, 0, 0)');
    this._drawSubDendrogram(this._svg.select('.' + dendClass), dendrogram.root(), 0, 0, width, height, showLabels);
  }
};

/**
 * @param svg
 * @param {epiviz.ui.charts.transform.clustering.ClusterNode} node
 * @param {number} top
 * @param {number} left
 * @param {number} width
 * @param {number} height
 * @param {boolean} showLabels
 * @private
 */
epiviz.plugins.charts.HeatmapPlot.prototype._drawSubDendrogram = function(svg, node, top, left, width, height, showLabels) {
  var children = node.children();
  if (children.length == 0) {
    return top + height * 0.5;
  }

  var xScale = d3.scale.linear()
    .domain([0, node.distance()])
    .range([0, width]);
  var nextTop = 0;
  var firstY, lastY;
  for (var i = 0; i < children.length; ++i) {
    var childTop = top + nextTop;
    var childHeight = (height / node.weight()) * children[i].weight();
    var childWidth = xScale(children[i].distance());

    var yCenter = this._drawSubDendrogram(
      svg,
      children[i],
      childTop,
      left,
      childWidth,
      childHeight,
      showLabels);

    svg.append('line')
      .attr('x1', left + childWidth)
      .attr('x2', left + width)
      .attr('y1', yCenter)
      .attr('y2', yCenter)
      .style('stroke', '#555555')
      .style('stroke-width', 1)
      .style('shape-rendering', 'auto');

    if (i == 0 && showLabels) {
      svg.append('text')
        .attr('class', 'row-text')
        .attr('x', Math.max(left + 10, left + (childWidth + width) * 0.5))
        .attr('y', yCenter - 10)
        .style('text-anchor', 'middle')
        .text(Globalize.format(node.distance(), 'n2'));
    }

    if (firstY == undefined || firstY > yCenter) {
      firstY = yCenter;
    }

    if (lastY == undefined || lastY < yCenter) {
      lastY = yCenter;
    }

    nextTop += (height / node.weight()) * children[i].weight();
  }

  svg.append('line')
    .attr('x1', left + width)
    .attr('x2', left + width)
    .attr('y1', firstY)
    .attr('y2', lastY)
    .style('stroke', '#555555')
    .style('stroke-width', 1)
    .style('shape-rendering', 'auto');

  return (firstY + lastY) * 0.5;
};

/**
 * @param itemsGroup D3 selection
 * @param {Array.<string>} colnames
 * @param {Object.<number, number>} columnMap
 * @param {number} nCols
 * @param {Array.<epiviz.measurements.Measurement>} rows
 * @param {number} cellWidth
 * @param {number} cellHeight
 * @param {number} firstGlobalIndex
 * @param {number} width
 * @private
 */
epiviz.plugins.charts.HeatmapPlot.prototype._drawLabels = function(itemsGroup, colnames, columnMap, nCols, rows, cellWidth, cellHeight, firstGlobalIndex, width) {

  var self = this;

  var mapCol = function(i, centered) {
    return i * cellWidth + ((centered) ? 0.5 * cellWidth : 0);
  };

  var mapRow = function(i, centered) {
    return i * cellHeight + ((centered) ? cellHeight * 0.5 : 0);
  };

  var measurementLabel = function(m) {
    var label;
    if (rowLabel == 'name') { label = m.name(); }
    else {
      var anno = m.annotation();
      if (!anno || !(rowLabel in anno)) { label = '<NA>'; }
      else { label = anno[rowLabel]; }
    }
    rowLabelMap[label] = label;
    return label;
  };

  // Column names
  var colSelection = itemsGroup.selectAll('.col-text');

  var maxColSize = 0;
  if (colnames.length > nCols) {
    colSelection
      .transition()
      .duration(500)
      .style('opacity', 0)
      .remove();
  } else {
    colSelection = colSelection
      .data(colnames, function(d, i) { return d + columnMap[i]; });

    colSelection
      .enter()
      .append('text')
      .attr('class', 'col-text')
      .style('opacity', '0')
      .attr('x', 0)
      .attr('y', 0)
      .attr('transform', function(d, i){
        return 'translate(' + (mapCol(i, true))  + ',' + (-5) + ')rotate(-60)';
      })
      .text(function(d){ return d; });

    colSelection
      .transition()
      .duration(500)
      .attr('x', 0)
      .attr('y', 0)
      .attr('transform', function(d, i){
        return 'translate(' + (mapCol(i, true))  + ',' + (-5) + ')rotate(-60)';
      })
      .style('opacity', null)
      .attr('fill', function(colName, i) {
        var globalIndex = i + firstGlobalIndex;
        if (!self._globalIndexColorLabels) { return '#000000'; }
        return self.colors().getByKey(self._globalIndexColorLabels[globalIndex]);
      });

    colSelection
      .exit()
      .transition()
      .duration(500)
      .style('opacity', 0)
      .remove();

    $('#' + this.id() + ' .col-text')
      .each(function(i) {
        var textWidth = this.getBBox().width;
        if (maxColSize < textWidth) { maxColSize = textWidth; }
      });
  }

  // Row names

  var rowLabel = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL];
  var rowLabelsAsColors = this.customSettingsValues()[epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_COLORS_FOR_ROW_LABELS];

  if (!rowLabelsAsColors) {
    itemsGroup.selectAll('.row-color-label').remove();
    var rowSelection = itemsGroup.selectAll('.row-text')
      .data(rows, function(m) { return m.id(); });

    rowSelection
      .enter()
      .append('text')
      .attr('class', 'row-text')
      .attr('x', 0)
      .attr('y', 0)
      .attr('transform', function(d, i){
        return 'translate(' + (-5) + ',' + (mapRow(i, true)) + ')rotate(30)';
      });

    rowSelection
      .text(function(m){
        if (rowLabel == 'name') { return m.name(); }
        var anno = m.annotation();
        if (!anno || !(rowLabel in anno)) { return '<NA>'; }
        return anno[rowLabel];
      });

    rowSelection
      .transition()
      .duration(500)
      .attr('x', 0)
      .attr('y', 0)
      .attr('transform', function(d, i){
        return 'translate(' + (-5) + ',' + (mapRow(i, true)) + ')rotate(30)';
      });

    rowSelection.exit().remove();
  }

  var rowLabelCat;
  if (rowLabelsAsColors) {
    itemsGroup.selectAll('.row-text').remove();
    var rowLabelMap = {};
    rows.forEach(function(m) {
      var label = measurementLabel(m);
      rowLabelMap[label] = label;
    });
    rowLabelCat = Object.keys(rowLabelMap);

    var rowColorLabels = itemsGroup.selectAll('.row-color-label')
      .data(rows, function(m) { return m.id(); });

    rowColorLabels
      .enter()
      .append('rect')
      .attr('class', 'row-color-label')
      .attr('x', width - self.margins().sumAxis(epiviz.ui.charts.Axis.X))
      .attr('y', -cellHeight*0.5)
      .attr('width', 20)// TODO: Use a custom variable
      .attr('height', cellHeight)
      .attr('transform', function(d, i){
        return 'translate(' + (0) + ',' + (mapRow(i, true)) + ')';
      });

    rowColorLabels
      .style('fill', function(m) {
        var label = measurementLabel(m);
        return self.colors().getByKey(label);
      });

    rowColorLabels
      .transition()
      .duration(500)
      .attr('x', width - self.margins().sumAxis(epiviz.ui.charts.Axis.X))
      .attr('y', -cellHeight*0.5)
      .attr('height', cellHeight)
      .attr('transform', function(d, i){
        return 'translate(' + (0) + ',' + (mapRow(i, true)) + ')';
      });

    rowColorLabels.exit().remove();
  }

  // Legend
  this._svg.selectAll('.chart-title').remove();
  this._svg.selectAll('.chart-title-color ').remove();
  var titleEntries = this._svg
    .selectAll('.chart-title')
    .data(['Min'].concat(this._colorLabels));
  titleEntries
    .enter()
    .append('text')
    .attr('class', 'chart-title')
    .attr('font-weight', 'bold')
    .attr('y', self.margins().top() - 5 - maxColSize);
  titleEntries
    .attr('fill', function(label, i) {
      if (i == 0) { return '#000000'; }
      return self.colors().getByKey(label);
    })
    .text(function(label) { return label; });
  var textLength = 0;
  var titleEntriesStartPosition = [];

  $('#' + this.id() + ' .chart-title')
    .each(function(i) {
      titleEntriesStartPosition.push(textLength);
      textLength += this.getBBox().width + 15;
    });

  titleEntries.attr('x', function(column, i) {
    return self.margins().left() + 10 + titleEntriesStartPosition[i];
  });

  var colorEntries = this._svg
    .selectAll('.chart-title-color')
    .data(['Min'].concat(this._colorLabels))
    .enter()
    .append('circle')
    .attr('class', 'chart-title-color')
    .attr('cx', function(column, i) { return self.margins().left() + 4 + titleEntriesStartPosition[i]; })
    .attr('cy', self.margins().top() - 9 - maxColSize)
    .attr('r', 4)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .attr('fill', function(label, i) {
      if (i == 0) { return '#ffffff'; }
      return self.colors().getByKey(label);
    })
    .style('stroke-width', function(label, i) { return i ? 0 : 1; })
    .style('stroke', '#000000');

  // Row labels legend

  this._svg.selectAll('.row-legend').remove();
  this._svg.selectAll('.row-legend-color').remove();
  if (rowLabelsAsColors) {
    // TODO: Make this optional
    //rowLabelCat.sort();
    var textEntries = this._svg
      .selectAll('.row-legend')
      .data(rowLabelCat);
    textEntries
      .enter()
      .append('text')
      .attr('class', 'row-legend')
      .attr('font-weight', 'bold')
      .attr('x', -20);
    textEntries
      .attr('fill', function(label) {
        return self.colors().getByKey(label);
      })
      .text(function(label) { return label; })
      .attr('transform', function(d, i){
        return 'translate(' + (self.margins().left()) + ',' + (self.margins().top()) + ')';
      });

    textEntries.attr('y', function(label, i) {
      return 10 + i * 15;
    });

    this._svg
      .selectAll('.row-legend-color')
      .data(rowLabelCat)
      .enter()
      .append('rect')
      .attr('class', 'chart-title-color')
      .attr('x', -18)
      .attr('y', function(label, i) { return 2 + i * 15})
      .attr('width', 10)
      .attr('height', 10)
      .style('shape-rendering', 'auto')
      .style('stroke-width', '0')
      .attr('fill', function(label) { return self.colors().getByKey(label); })
      .style('stroke-width', 0)
      .attr('transform', function(d, i){
        return 'translate(' + (self.margins().left()) + ',' + (self.margins().top()) + ')';
      });

    this._colorLabels = this._colorLabels.concat(rowLabelCat)
  }
};

/**
 * @returns {Array.<{name: string, color: string}>}
 */
epiviz.plugins.charts.HeatmapPlot.prototype.colorLabels = function() {
  return this._colorLabels;
};

// goog.inherits(epiviz.plugins.charts.HeatmapPlot, epiviz.ui.charts.Plot);

// Input 139
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/1/14
 * Time: 5:56 PM
 */

goog.provide('epiviz.plugins.charts.HeatmapPlotType');

goog.require('epiviz.plugins.charts.HeatmapPlot');
goog.require('epiviz.ui.charts.PlotType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');
goog.require('epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.PlotType}
 * @constructor
 */
epiviz.plugins.charts.HeatmapPlotType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.PlotType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.HeatmapPlotType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.PlotType.prototype);
epiviz.plugins.charts.HeatmapPlotType.constructor = epiviz.plugins.charts.HeatmapPlotType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.HeatmapPlot}
 */
epiviz.plugins.charts.HeatmapPlotType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.HeatmapPlot(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.HeatmapPlotType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.HeatmapPlot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.HeatmapPlotType.prototype.chartName = function() {
  return 'Heatmap';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.HeatmapPlotType.prototype.chartHtmlAttributeName = function() {
  return 'heatmap';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.HeatmapPlotType.prototype.measurementsFilter = function() { return function(m) { return epiviz.measurements.Measurement.Type.hasValues(m.type()); }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.plugins.charts.HeatmapPlotType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.HeatmapPlotType.prototype.customSettingsDefs = function() {
  var clusteringFactory = epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.instance();

  return epiviz.ui.charts.PlotType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.COL_LABEL,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_METADATA,
      'colLabel',
      'Columns labels'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_ANNOTATION,
      'name',
      'Row labels'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_COLORS_FOR_ROW_LABELS,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      false,
      'Row labels as colors'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.MAX_COLUMNS,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      40,
      'Max columns'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min Value'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max Value'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTER,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'rows',
      'Cluster',
      Object.keys(epiviz.plugins.charts.HeatmapPlotType.Cluster).map(function(key) { return epiviz.plugins.charts.HeatmapPlotType.Cluster[key]; })),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTERING_ALG,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      clusteringFactory.algorithms()[0],
      'Clustering Algorithm',
      clusteringFactory.algorithms()),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTERING_METRIC,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      clusteringFactory.metrics()[0],
      'Clustering Metric',
      clusteringFactory.metrics()),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.CLUSTERING_LINKAGE,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      clusteringFactory.linkages()[0],
      'Clustering Linkage',
      clusteringFactory.linkages()),

    // TODO: Maybe add back later
    /*new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.DENDROGRAM_RATIO,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      0,
      'Dendrogram Ratio'),*/

    /*new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_DENDROGRAM_LABELS,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      false,
      'Show Dendrogram Labels')*/
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.HeatmapPlotType.CustomSettings.SHOW_DENDROGRAM,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      true,
      'Show Dendrogram')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.HeatmapPlotType.Cluster = {
  NONE: 'none',
  ROWS: 'rows',
  COLS: 'columns',
  BOTH: 'both'
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.HeatmapPlotType.CustomSettings = {
  MAX_COLUMNS: 'maxColumns',
  CLUSTER: 'cluster',
  CLUSTERING_ALG: 'clusteringAlg',
  CLUSTERING_METRIC: 'clusteringMetric',
  CLUSTERING_LINKAGE: 'clusteringLinkage',
  // TODO: Maybe add back later
  //DENDROGRAM_RATIO: 'dendrogramRatio',
  //SHOW_DENDROGRAM_LABELS: 'showDendrogramLabels',
  SHOW_DENDROGRAM: 'showDendrogram',
  SHOW_COLORS_FOR_ROW_LABELS: 'showColorsForRowLabels'
};

// goog.inherits(epiviz.plugins.charts.HeatmapPlotType, epiviz.ui.charts.PlotType);

// Input 140
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/18/13
 * Time: 7:33 PM
 */

goog.provide('epiviz.plugins.charts.GenesTrack');

goog.require('epiviz.ui.charts.Track');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Track}
 * @constructor
 */
epiviz.plugins.charts.GenesTrack = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Track.call(this, id, container, properties);

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.GenesTrack.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Track.prototype);
epiviz.plugins.charts.GenesTrack.constructor = epiviz.plugins.charts.GenesTrack;

/**
 * @protected
 */
epiviz.plugins.charts.GenesTrack.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Track.prototype._initialize.call(this);

  this._svg.classed('genes-track', true);
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.GenesTrack.prototype.draw = function(range, data, slide, zoom) {
  epiviz.ui.charts.Track.prototype.draw.call(this, range, data, slide, zoom);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  slide = slide || this._slide;
  zoom = zoom || this._zoom;
  this._slide = 0;
  this._zoom = 1;

  return this._drawGenes(range, data, slide || 0, zoom || 1);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {number} slide
 * @param {number} zoom
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.GenesTrack.prototype._drawGenes = function(range, data, slide, zoom) {
  var Axis = epiviz.ui.charts.Axis;

  /** @type {number} */
  var start = range.start();

  /** @type {number} */
  var end = range.end();

  /** @type {number} */
  var width = this.width();

  /** @type {number} */
  var height = this.height();

  /** @type {epiviz.ui.charts.Margins} */
  var margins = this.margins();

  var xScale = d3.scale.linear()
    .domain([start, end])
    .range([0, width - margins.sumAxis(Axis.X)]);
  var delta = slide * (width - margins.sumAxis(Axis.X)) / (end - start);

  this._clearAxes();
  this._drawAxes(xScale, null, 10, 5);

  var self = this;
  /** @type {epiviz.datatypes.MeasurementGenomicData} */
  var series = data.firstSeries();

  var indices = epiviz.utils.range(series.size());

  /** @type {Array.<epiviz.ui.charts.ChartObject>} */
  var dataItems = indices
    .map(function(i) {
    var cell = series.get(i);
    var item = cell.rowItem;
    var classes = sprintf('item gene-%s', item.metadata('gene'));

    return new epiviz.ui.charts.ChartObject(
      item.metadata('gene'),
      item.start(),
      item.end(),
      null,
      0,
      [[cell]],
      [series.measurement()],
      classes);
  });

  if (zoom) {
    this._svg.select('.items').remove();
    this._svg.select('defs').select('#clip-' + this.id()).remove();
  }

  var items = this._svg.select('.items');
  var selected = items.select('.selected');

  if (items.empty()) {
    var defs = this._svg.select('defs');
    defs.append('clipPath')
      .attr('id', 'clip-' + this.id())
      .append('rect')
      .attr('x', 0)
      .attr('y', 0)
      .attr('width', width - margins.sumAxis(Axis.X))
      .attr('height', height - margins.sumAxis(Axis.Y));

    items = this._svg.append('g')
      .attr('class', 'items')
      .attr('transform', 'translate(' + margins.left() + ', ' + margins.top() + ')')
      .attr('id', this.id() + '-gene-content')
      .attr('clip-path', 'url(#clip-' + this.id() + ')');

    selected = items.append('g').attr('class', 'selected');
    items.append('g').attr('class', 'hovered');
    selected.append('g').attr('class', 'hovered');
  }

  var selection = items.selectAll('.item')
    .data(dataItems, function(d) { return d.id; });

  selection
    .enter()
    .insert('g', ':first-child')
    .on('mouseout', function () {
      self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
    })
    .on('mouseover', function (d) {
      self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
    })
    .on('click', function(d) {
      self._deselect.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
      self._select.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
      d3.event.stopPropagation();
    })
    .attr('transform', 'translate(' + (delta) + ', 0) scale(1, 1)')
    .each(function(d) {
      self._drawGene(this, d, xScale);
    });

  if (delta) {
    selection.each(function(d) {
      self._translateGene(this, d, delta);
    });
  }

  selection
    .exit()
    .transition()
    .duration(500)
    .style('opacity', 0)
    .remove();

  return dataItems;
};

/**
 * @param elem
 * @param {epiviz.ui.charts.ChartObject} d
 * @param delta
 * @private
 */
epiviz.plugins.charts.GenesTrack.prototype._translateGene = function(elem, d, delta) {
  var gene = d3.select(elem);
  var transform = gene.attr('transform');
  var translateRx = new RegExp('translate\\\([\\\d\\\.\\\-]+[\\\,\\\s]+[\\\d\\\.\\\-]+\\\)', 'g');
  var numberRx = new RegExp('[\\\d\\\.\\\-]+', 'g');
  var translate = transform.match(translateRx)[0];
  var x = parseFloat(translate.match(numberRx)[0]);

  transform = transform.replace(translateRx, 'translate(' + (x-delta) + ', 0)');
  gene
    .transition()
    .duration(500)
    .attr('transform', transform);
};

/**
 * @param elem
 * @param {epiviz.ui.charts.ChartObject} d
 * @param {function(number): number} xScale
 * @private
 */
epiviz.plugins.charts.GenesTrack.prototype._drawGene = function(elem, d, xScale) {
  var Axis = epiviz.ui.charts.Axis;
  var self = this;
  var rowItem = d.valueItems[0][0].rowItem;
  var geneStart = xScale(d.start);
  var geneEnd = xScale(d.end);
  var or = (rowItem.strand() == '+') ? 1 : -1;
  var offset = - or * (this.height() - this.margins().sumAxis(Axis.Y)) * 0.25;

  var exonStarts = rowItem.metadata('exon_starts').split(',').map(function(s) { return parseInt(s); });
  var exonEnds = rowItem.metadata('exon_ends').split(',').map(function(s) { return parseInt(s); });
  var exonCount = exonStarts.length;
  var exonIndices = d3.range(0, exonCount);

  var geneHeight = this.height() * 0.08;
  var exonHeight = this.height() * 0.16;
  var h = geneHeight * Math.sqrt(3) * 0.5;

  var gene = d3.select(elem);
  gene.attr('class', d.cssClasses);

  gene.append('polygon')
    .attr('class', 'gene-body')
    .style('fill', this.colors().get(0))
    .attr('points', function() {
      var xs = null, ys;
      var y0 = (self.height() - self.margins().sumAxis(Axis.Y) - geneHeight) * 0.5 + offset;
      ys = [y0, y0, y0 + geneHeight * 0.5, y0 + geneHeight, y0 + geneHeight];
      if (rowItem.strand() == '+') {
        xs = [geneStart, geneEnd, geneEnd + h, geneEnd, geneStart];
      } else {
        xs = [geneEnd, geneStart, geneStart - h, geneStart, geneEnd];
      }

      return sprintf('%s,%s %s,%s %s,%s %s,%s %s,%s', xs[0], ys[0], xs[1], ys[1], xs[2], ys[2], xs[3], ys[3], xs[4], ys[4]);
    });

  var exons = gene.append('g')
    .attr('class', 'exons')
    .style('fill', this.colors().get(1));

  exons.selectAll('rect')
    .data(exonIndices)
    .enter()
    .append('rect')
    .attr('x', function(j) {
      return xScale(exonStarts[j]);
    })
    .attr('y', (self.height() - exonHeight - self.margins().sumAxis(Axis.Y)) * 0.5 + offset)
    .attr('width', function(j) {
      return xScale(exonEnds[j]) - xScale(exonStarts[j]);
    })
    .attr('height', exonHeight);

  gene
    .append('text')
    .attr('class', 'gene-name')
    .attr('x', geneStart + 2)
    .attr('y', (self.height() - self.margins().sumAxis(Axis.Y)) * 0.5 + offset - or * (geneHeight + 2))
    .style('dominant-baseline', 'central')
    .text(d.id); //Gene
};

/**
 * @returns {Array.<{name: string, color: string}>}
 */
epiviz.plugins.charts.GenesTrack.prototype.colorLabels = function() {
  return ['Genes', 'Exons'];
};

/**
 * @param xScale D3 linear scale for the x axis
 * @param yScale D3 linear scale for the y axis
 * @param {number} [xTicks]
 * @param {number} [yTicks]
 * @param [svg] D3 svg container for the axes
 * @param {number} [width]
 * @param {number} [height]
 * @param {epiviz.ui.charts.Margins} [margins]
 * @protected
 */
epiviz.plugins.charts.GenesTrack.prototype._drawAxes = function(xScale, yScale, xTicks, yTicks, svg, width, height, margins) {
  epiviz.ui.charts.Track.prototype._drawAxes.call(this, xScale, yScale, xTicks, yTicks, svg, width, height, margins);

  var Axis = epiviz.ui.charts.Axis;
  var axesGroup = this._svg.select('.axes');
  axesGroup
    .append('g')
    .attr('class', 'xAxis')
    .append('line')
    .attr('x1', this.margins().left())
    .attr('x2', this.width() - this.margins().left())
    .attr('y1', this.margins().top() + (this.height() - this.margins().sumAxis(Axis.Y)) * 0.5)
    .attr('y2', this.margins().top() + (this.height() - this.margins().sumAxis(Axis.Y)) * 0.5)
    .style('stroke', '#555555')
    .style('shape-rendering', 'crispEdges');
};

// goog.inherits(epiviz.plugins.charts.GenesTrack, epiviz.plugins.charts.Track);
// Input 141
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/8/2014
 * Time: 1:32 PM
 */


goog.provide('epiviz.plugins.charts.StackedLineTrackType');

goog.require('epiviz.plugins.charts.StackedLineTrack');
goog.require('epiviz.ui.charts.TrackType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.TrackType}
 * @constructor
 */
epiviz.plugins.charts.StackedLineTrackType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.TrackType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.StackedLineTrackType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.TrackType.prototype);
epiviz.plugins.charts.StackedLineTrackType.constructor = epiviz.plugins.charts.StackedLineTrackType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.StackedLineTrack}
 */
epiviz.plugins.charts.StackedLineTrackType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.StackedLineTrack(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.StackedLineTrackType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.StackedLineTrack';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.StackedLineTrackType.prototype.chartName = function() {
  return 'Stacked Track';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.StackedLineTrackType.prototype.chartHtmlAttributeName = function() {
  return 'stacked-lines';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.StackedLineTrackType.prototype.measurementsFilter = function() { return function(m) { return m.type() == epiviz.measurements.Measurement.Type.FEATURE; }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.plugins.charts.StackedLineTrackType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.StackedLineTrackType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.TrackType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLineTrackType.CustomSettings.STEP,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      1,
      'Step'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLineTrackType.CustomSettings.OFFSET,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'zero',
      'Offset',
      ['zero', 'wiggle']),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLineTrackType.CustomSettings.INTERPOLATION,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'basis',
      'Interpolation',
      ['linear', 'step-before', 'step-after', 'basis', 'basis-open', 'basis-closed', 'bundle', 'cardinal', 'cardinal-open', 'monotone']),
    
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLineTrackType.CustomSettings.ABS_LINE_VAL,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Draw abline')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.StackedLineTrackType.CustomSettings = {
  STEP: 'step',
  OFFSET: 'offset',
  INTERPOLATION: 'interpolation',
  ABS_LINE_VAL: 'abLine'
};

// goog.inherits(epiviz.plugins.charts.StackedLineTrackType, epiviz.ui.charts.TrackType);

// Input 142
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 9:30 AM
 */

goog.provide('epiviz.plugins.charts.LineTrack');

goog.require('epiviz.ui.charts.Track');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.datatypes.GenomicRange');
goog.require('epiviz.ui.charts.CustomSetting');


/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Track}
 * @constructor
 */
epiviz.plugins.charts.LineTrack = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Track.call(this, id, container, properties);

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.LineTrack.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Track.prototype);
epiviz.plugins.charts.LineTrack.constructor = epiviz.plugins.charts.LineTrack;

/**
 * @protected
 */
epiviz.plugins.charts.LineTrack.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Track.prototype._initialize.call(this);
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.LineTrack.prototype.draw = function(range, data, slide, zoom) {
  epiviz.ui.charts.Track.prototype.draw.call(this, range, data, slide, zoom);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  slide = slide || this._slide || 0;
  zoom = zoom || this._zoom || 1;
  this._slide = 0;
  this._zoom = 1;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  var CustomSetting = epiviz.ui.charts.CustomSetting;
  var minY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MIN];
  var maxY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MAX];

  if (minY == CustomSetting.DEFAULT) {
    minY = null;
    this.measurements().foreach(function(m) {
      if (m === null) { return; }
      if (minY === null || m.minValue() < minY) { minY = m.minValue(); }
    });
  }

  if (maxY == CustomSetting.DEFAULT) {
    maxY = null;
    this.measurements().foreach(function(m) {
      if (m === null) { return; }
      if (maxY === null || m.maxValue() > maxY) { maxY = m.maxValue(); }
    });
  }

  if (minY === null && maxY === null) { minY = -1; maxY = 1; }
  if (minY === null) { minY = maxY - 1; }
  if (maxY === null) { maxY = minY + 1; }

  var Axis = epiviz.ui.charts.Axis;
  var xScale = d3.scale.linear()
    .domain([range.start(), range.end()])
    .range([0, this.width() - this.margins().sumAxis(Axis.X)]);
  var yScale = d3.scale.linear()
    .domain([minY, maxY])
    .range([this.height() - this.margins().sumAxis(Axis.Y), 0]);

  this._clearAxes();
  this._drawAxes(xScale, yScale, 10, 5);

  var delta = slide * (this.width() - this.margins().sumAxis(Axis.X)) / range.width();
  var linesGroup = this._svg.selectAll('.lines');

  if (linesGroup.empty()) {
    linesGroup = this._svg.append('g')
      .attr('class', 'lines')
      .attr('transform', 'translate(' + this.margins().left() + ', ' + this.margins().top() + ')');
  }

  data.measurements().forEach(function(m, i) {
    var lineSeries = linesGroup.selectAll('.line-series-index-' + i);
    var pointSeries = linesGroup.selectAll('.point-series-index-' + i);

    if (lineSeries.empty()) { linesGroup.append('g').attr('class', 'line-series-index-' + i); }
    if (pointSeries.empty()) { linesGroup.append('g').attr('class', 'point-series-index-' + i); }
  });

  for (var i = data.measurements().length;; ++i) {
    var lineSeries = linesGroup.selectAll('.line-series-index-' + i);
    var pointSeries = linesGroup.selectAll('.point-series-index-' + i);
    if (lineSeries.empty()) { break; }
    lineSeries.remove();
    pointSeries.remove();
  }

  return this._drawLines(range, data, delta, zoom, xScale, yScale);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {number} delta
 * @param {number} zoom
 * @param {function} xScale D3 linear scale
 * @param {function} yScale D3 linear scale
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.LineTrack.prototype._drawLines = function(range, data, delta, zoom, xScale, yScale) {
  /** @type {epiviz.ui.charts.ColorPalette} */
  var colors = this.colors();

  /** @type {number} */
  var step = parseInt(this.customSettingsValues()[epiviz.plugins.charts.LineTrackType.CustomSettings.STEP]);

  /** @type {boolean} */
  var showPoints = this.customSettingsValues()[epiviz.plugins.charts.LineTrackType.CustomSettings.SHOW_POINTS];

  /** @type {boolean} */
  var showLines = this.customSettingsValues()[epiviz.plugins.charts.LineTrackType.CustomSettings.SHOW_LINES];

  /** @type {boolean} */
  var showErrorBars = this.customSettingsValues()[epiviz.plugins.charts.LineTrackType.CustomSettings.SHOW_ERROR_BARS];

  /** @type {number} */
  var pointRadius = this.customSettingsValues()[epiviz.plugins.charts.LineTrackType.CustomSettings.POINT_RADIUS];

  /** @type {number} */
  var lineThickness = this.customSettingsValues()[epiviz.plugins.charts.LineTrackType.CustomSettings.LINE_THICKNESS];

  var interpolation = this.customSettingsValues()[epiviz.plugins.charts.LineTrackType.CustomSettings.INTERPOLATION];

  var self = this;

  var invXScale = d3.scale.linear()
    .domain([0, this.width() - this.margins().sumAxis(epiviz.ui.charts.Axis.X)])
    .range([range.start(), range.end()]);
  var deltaInBp = invXScale(delta) - range.start();
  var extendedRange = epiviz.datatypes.GenomicRange.fromStartEnd(
    range.seqName(),
    Math.min(range.start(), range.start() + deltaInBp),
    Math.max(range.end(), range.end() + deltaInBp));

  var graph = this._svg.select('.lines');

  /** @type {Array.<epiviz.ui.charts.ChartObject>} */
  var items = [];

  data.foreach(function(m, series, i) {
    var color = self._measurementColorLabels ? colors.getByKey(self._measurementColorLabels.get(m)) : colors.get(i);

    /** @type {{index: ?number, length: number}} */
    var drawBoundaries = series.binarySearchStarts(extendedRange);
    if (drawBoundaries.length == 0) { return; }

    // TODO: In the future, use global index to align steps:
    //var globalIndex = series.get(drawBoundaries.index).globalIndex;
    //globalIndex = Math.ceil(globalIndex / step) * step;
    var index = Math.ceil(drawBoundaries.index / step) * step;
    drawBoundaries.length = Math.max(0, drawBoundaries.length - index + drawBoundaries.index);
    drawBoundaries.index = index;

    var indices = epiviz.utils.range(drawBoundaries.length, drawBoundaries.index)
      .filter(function(i) {
        return !step || step <= 1 || ((i - drawBoundaries.index) % step == 0);
      });

    for (var k = 0; k < indices.length; ++k) {
      var cell = series.get(indices[k]);
      items.push(new epiviz.ui.charts.ChartObject(sprintf('line_%s_%s', i, cell.globalIndex), cell.rowItem.start(), cell.rowItem.end(), [cell.value], i, [[cell]], [m], sprintf('item data-series-%s', i)));
    }

    var x = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      return xScale(cell.rowItem.start());
    };

    var y = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      return yScale(cell.value);
    };

    var errMinus = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      var v = cell.valueAnnotation ? cell.valueAnnotation['errMinus'] : null;
      return v != undefined ? yScale(v) : null;
    };

    var errPlus = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      var v = cell.valueAnnotation ? cell.valueAnnotation['errPlus'] : null;
      return v != undefined ? yScale(v) : null;
    };

    if (showLines) {
      var line = d3.svg.line()
        .x(x).y(y)
        .interpolate(interpolation);

      var lines = graph.select('.line-series-index-' + i)
        .selectAll('path')
        .data([indices]);

      lines.enter()
        .append('path')
        .attr('d', line)
        .style('shape-rendering', 'auto')
        .style('stroke-opacity', '0.8')
        .on('mouseover', function() { self._captureMouseHover(); })
        .on('mousemove', function() { self._captureMouseHover(); })
        .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });

      lines
        .attr('d', line)
        .style('stroke', color)
        .style('stroke-width', lineThickness)
        .attr('transform', 'translate(' + (+delta) + ')')
        .transition()
        .duration(500)
        .attr('transform', 'translate(' + (0) + ')');
    } else {
      graph.select('.line-series-index-' + i)
        .selectAll('path').remove();
    }

    graph.select('.point-series-index-' + i)
      .selectAll('circle').remove();
    graph.select('.point-series-index-' + i)
      .selectAll('.error-bar').remove();
    if (showPoints) {
      var points = graph.select('.point-series-index-' + i)
        .selectAll('circle')
        .data(indices);
      points.enter()
        .append('circle')
        .attr('class', 'point-series-index-' + i)
        .attr('r', pointRadius)
        .attr('cx', x)
        .attr('cy', y)
        .attr('fill', color)
        .attr('stroke', color)
        .attr('transform', 'translate(' + (+delta) + ')')
        .transition()
        .duration(500)
        .attr('transform', 'translate(' + (0) + ')');

      points
        .on('mouseover', function() { self._captureMouseHover(); })
        .on('mousemove', function() { self._captureMouseHover(); })
        .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });

      points.exit()
        .transition()
        .duration(500)
        .style('opacity', 0)
        .remove();

      if (showErrorBars) {
        var errorBars = graph.select('.point-series-index-' + i)
          .selectAll('.error-bar')
          .data(indices);
        errorBars.enter()
          .append('g')
          .attr('class', 'error-bar')
          .each(function(j) {
            var m = errMinus(j), p = errPlus(j);
            if (m == null || p == null) { return; }
            d3.select(this).append('line')
              .attr('x1', x(j)).attr('x2', x(j)).attr('y1', m).attr('y2', p)
              .style('stroke', color)
              .style('shape-rendering', 'auto');
            d3.select(this).append('line')
              .attr('x1', x(j) - 2).attr('x2', x(j) + 2).attr('y1', m).attr('y2', m)
              .style('stroke', color)
              .style('shape-rendering', 'auto');
            d3.select(this).append('line')
              .attr('x1', x(j) - 2).attr('x2', x(j) + 2).attr('y1', p).attr('y2', p)
              .style('stroke', color)
              .style('shape-rendering', 'auto');
          })
          .attr('transform', 'translate(' + (+delta) + ')')
          .transition()
          .duration(500)
          .attr('transform', 'translate(' + (0) + ')');

        errorBars
          .on('mouseover', function() { self._captureMouseHover(); })
          .on('mousemove', function() { self._captureMouseHover(); })
          .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });

        errorBars.exit()
          .transition()
          .duration(500)
          .style('opacity', 0)
          .remove();
      }
    }
  });

  // show baseline
  if(absLine != epiviz.ui.charts.CustomSetting.DEFAULT) {

    graph.selectAll('.abLine').remove();

    graph.append("svg:line")
          .attr("class", "abLine")
          .attr("x1", 0)
          .attr("x2", self.width() - self.margins().sumAxis(epiviz.ui.charts.Axis.X))
          .attr("y1", yScale(absLine))
          .attr("y2", yScale(absLine))
          .style("stroke", "black")
          .style("stroke-dasharray", ("5, 5")) ;
  }

  return items;
};

// goog.inherits(epiviz.plugins.charts.LineTrack, epiviz.plugins.charts.Track);
// Input 143
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/16/13
 * Time: 9:35 AM
 */

goog.provide('epiviz.plugins.charts.BlocksTrack');

goog.require('epiviz.ui.charts.Track');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.ui.charts.Visualization');


/**
 * @param id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Track}
 * @constructor
 */
epiviz.plugins.charts.BlocksTrack = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Track.call(this, id, container, properties);

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.BlocksTrack.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Track.prototype);
epiviz.plugins.charts.BlocksTrack.constructor = epiviz.plugins.charts.BlocksTrack;

/**
 * @protected
 */
epiviz.plugins.charts.BlocksTrack.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Track.prototype._initialize.call(this);

  this._svg.classed('blocks-track', true);
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.BlocksTrack.prototype.draw = function(range, data, slide, zoom) {

  epiviz.ui.charts.Track.prototype.draw.call(this, range, data, slide, zoom);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  // If data is not defined, there is nothing to draw
  if (!data || !range || !data.isReady()) { return []; }

  return this._drawBlocks(range, data, slide || 0, zoom || 1);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {number} slide
 * @param {number} zoom
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.BlocksTrack.prototype._drawBlocks = function(range, data, slide, zoom) {
  var Axis = epiviz.ui.charts.Axis;

  /** @type {number} */
  var start = range.start();

  /** @type {number} */
  var end = range.end();

  /** @type {number} */
  var width = this.width();

  /** @type {number} */
  var height = this.height();

  /** @type {epiviz.ui.charts.Margins} */
  var margins = this.margins();

  /** @type {epiviz.measurements.MeasurementSet} */
  var measurements = this.measurements();

  /** @type {epiviz.ui.charts.ColorPalette} */
  var colors = this.colors();

  var minBlockDistance = this.customSettingsValues()[epiviz.plugins.charts.BlocksTrackType.CustomSettings.MIN_BLOCK_DISTANCE];

  var colorLabel = this.customSettingsValues()[epiviz.plugins.charts.BlocksTrackType.CustomSettings.BLOCK_COLOR_BY];

  var useColorBy = this.customSettingsValues()[epiviz.plugins.charts.BlocksTrackType.CustomSettings.USE_COLOR_BY];

  var colorBy = function(row) {
    if(data.measurements().length > 1) {
      return colors.get(row.seriesIndex);
    }

    return useColorBy ? colors.getByKey(row.values) : colors.get(row.seriesIndex);
  };

  var xScale = d3.scale.linear()
    .domain([start, end])
    .range([0, width - margins.sumAxis(Axis.X)]);
  var delta = slide * (width - margins.sumAxis(Axis.X)) / (end - start);

  this._clearAxes();
  this._drawAxes(xScale, null, 10, 5);

  var self = this;
  /** @type {Array.<epiviz.ui.charts.ChartObject>} */
  var blocks = [];

  var i = 0;

  data.foreach(function(m, series, seriesIndex) {
    var seriesBlocks = [];

    for (var j = 0; j < series.size(); ++j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);

      if (cell.rowItem.start() > range.end() || cell.rowItem.end() < range.start()) { continue; }

      var classes = sprintf('item data-series-%s', i);


      if (minBlockDistance !== null && seriesBlocks.length > 0) {
        var lastBlock = seriesBlocks[seriesBlocks.length - 1];
        var start = xScale(cell.rowItem.start());
        var lastEnd = xScale(lastBlock.end);

        if (start - lastEnd < minBlockDistance) {
          lastBlock.end = Math.max(lastBlock.end, cell.rowItem.end());
          lastBlock.valueItems[0].push(cell);
          lastBlock.id = sprintf('b-%s-%s-%s', i, lastBlock.start, lastBlock.end);
          continue;
        }
      }

      seriesBlocks.push(new epiviz.ui.charts.ChartObject(
        sprintf('b-%s-%s-%s', i, cell.rowItem.start(), cell.rowItem.end()),
        cell.rowItem.start(),
        cell.rowItem.end(),
        cell.rowItem.metadata(colorLabel),
        i, // seriesIndex
        [[cell]], // valueItems
        [m], // measurements
        classes));
    }

    blocks = blocks.concat(seriesBlocks);
    ++i;
  });

  var items = this._svg.select('.items');
  var selected = items.select('.selected');
  var clipPath = this._svg.select('#clip-' + this.id());

  if (items.empty()) {
    if (clipPath.empty()) {
      this._svg.select('defs')
        .append('clipPath')
        .attr('id', 'clip-' + this.id())
        .append('rect')
        .attr('class', 'clip-path-rect');
    }

    items = this._svg.append('g')
      .attr('class', 'items')
      .attr('id', this.id() + '-gene-content')
      .attr('clip-path', 'url(#clip-' + this.id() + ')');

    selected = items.append('g').attr('class', 'selected');
    items.append('g').attr('class', 'hovered');
    selected.append('g').attr('class', 'hovered');
  }

  items.attr('transform', 'translate(' + margins.left() + ', ' + margins.top() + ')');

  this._svg.select('.clip-path-rect')
    .attr('x', 0)
    .attr('y', 0)
    .attr('width', width - margins.sumAxis(Axis.X))
    .attr('height', height - margins.sumAxis(Axis.Y));

  items.selectAll('.item').remove();

  var selection = items.selectAll('.item')
    .data(blocks, function(b) { return b.id; });

  selection
    .enter()
    .insert('rect', ':first-child')
    .attr('class', function(b) { return b.cssClasses; })
    .style('fill', function(b) { return colorBy(b); })
    .attr('x', function(b) {
      return xScale(b.start) / zoom + delta;
    })
    .attr('width', function(b) {
      // We're using b.end + 1 since b.end is the index of the last covered bp
      return zoom * (xScale(b.end + 1) - xScale(b.start));
    })
    .on('mouseout', function () {
      self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
    })
    .on('mouseover', function (b) {
      self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), b));
    })
    .on('click', function(b) {
      self._deselect.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
      self._select.notify(new epiviz.ui.charts.VisEventArgs(self.id(), b));
      d3.event.stopPropagation();
    });

  selection
    .attr('class', function(b) { return b.cssClasses; })
    .attr('height', height - margins.sumAxis(Axis.Y))
    .attr('y', 0)
    .transition()
    .duration(500)
    .attr('x', function(b) { return xScale(b.start); })
    .attr('width', function(b) { return xScale(b.end + 1) - xScale(b.start); });

  selection
    .exit()
    .transition()
    .duration(500)
    .attr('x', function(b) { return xScale(b.start); })
    .remove();

  return blocks;
};

/**
 * @param {epiviz.ui.charts.ColorPalette} colors
 */
epiviz.plugins.charts.BlocksTrack.prototype.setColors = function(colors) {
  this.container().find('.items').remove();
  epiviz.ui.charts.Visualization.prototype.setColors.call(this, colors);
};

// goog.inherits(epiviz.plugins.charts.BlocksTrack, epiviz.plugins.charts.Track);
// Input 144
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 9:30 AM
 */

goog.provide('epiviz.plugins.charts.LineTrackType');

goog.require('epiviz.plugins.charts.LineTrack');
goog.require('epiviz.ui.charts.TrackType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.TrackType}
 * @constructor
 */
epiviz.plugins.charts.LineTrackType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.TrackType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.LineTrackType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.TrackType.prototype);
epiviz.plugins.charts.LineTrackType.constructor = epiviz.plugins.charts.LineTrackType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.LineTrack}
 */
epiviz.plugins.charts.LineTrackType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.LineTrack(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LineTrackType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.LineTrack';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LineTrackType.prototype.chartName = function() {
  return 'Line Track';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LineTrackType.prototype.chartHtmlAttributeName = function() {
  return 'lines';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.LineTrackType.prototype.measurementsFilter = function() { return function(m) { return m.type() == epiviz.measurements.Measurement.Type.FEATURE; }; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.LineTrackType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.TrackType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.STEP,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      50,
      'Step'),
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.SHOW_POINTS,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      false,
      'Show points'),
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.SHOW_LINES,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      true,
      'Show lines'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.SHOW_ERROR_BARS,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      true,
      'Show error bars'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.POINT_RADIUS,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      1,
      'Point radius'),
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.LINE_THICKNESS,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      1,
      'Line thickness'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.INTERPOLATION,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'linear',
      'Interpolation',
      ['linear', 'step-before', 'step-after', 'basis', 'basis-open', 'basis-closed', 'bundle', 'cardinal', 'cardinal-open', 'monotone']),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackType.CustomSettings.ABS_LINE_VAL,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Draw abline')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.LineTrackType.CustomSettings = {
  STEP: 'step',
  SHOW_POINTS: 'showPoints',
  SHOW_ERROR_BARS: 'showErrorBars',
  SHOW_LINES: 'showLines',
  POINT_RADIUS: 'pointRadius',
  LINE_THICKNESS: 'lineThickness',
  INTERPOLATION: 'interpolation',
  ABS_LINE_VAL: 'abLine'
};

// goog.inherits(epiviz.plugins.charts.LineTrackType, epiviz.ui.charts.TrackType);

// Input 145
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 9:30 AM
 */

goog.provide('epiviz.plugins.charts.LineTrackCustom');

goog.require('epiviz.ui.charts.Track');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.datatypes.GenomicRange');
goog.require('epiviz.ui.charts.CustomSetting');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Track}
 * @constructor
 */
epiviz.plugins.charts.LineTrackCustom = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Track.call(this, id, container, properties);

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.LineTrackCustom.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Track.prototype);
epiviz.plugins.charts.LineTrackCustom.constructor = epiviz.plugins.charts.LineTrackCustom;

/**
 * @protected
 */
epiviz.plugins.charts.LineTrackCustom.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Track.prototype._initialize.call(this);
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.LineTrackCustom.prototype.draw = function(range, data, slide, zoom) {
  epiviz.ui.charts.Track.prototype.draw.call(this, range, data, slide, zoom);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  slide = slide || this._slide || 0;
  zoom = zoom || this._zoom || 1;
  this._slide = 0;
  this._zoom = 1;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  var CustomSetting = epiviz.ui.charts.CustomSetting;
  var minY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MIN];
  var maxY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MAX];

  if (minY == CustomSetting.DEFAULT) {
    minY = null;
    this.measurements().foreach(function(m) {
      if (m === null) { return; }
      if (minY === null || m.minValue() < minY) { minY = m.minValue(); }
    });
  }

  if (maxY == CustomSetting.DEFAULT) {
    maxY = null;
    this.measurements().foreach(function(m) {
      if (m === null) { return; }
      if (maxY === null || m.maxValue() > maxY) { maxY = m.maxValue(); }
    });
  }

  if (minY === null && maxY === null) { minY = -1; maxY = 1; }
  if (minY === null) { minY = maxY - 1; }
  if (maxY === null) { maxY = minY + 1; }

  var Axis = epiviz.ui.charts.Axis;
  var xScale = d3.scale.linear()
    .domain([range.start(), range.end()])
    .range([0, this.width() - this.margins().sumAxis(Axis.X)]);
  var yScale = d3.scale.linear()
    .domain([minY, maxY])
    .range([this.height() - this.margins().sumAxis(Axis.Y), 0]);

  this._clearAxes();
  this._drawAxes(xScale, yScale, 10, 5);

  var delta = slide * (this.width() - this.margins().sumAxis(Axis.X)) / range.width();
  var linesGroup = this._svg.selectAll('.lines');

  if (linesGroup.empty()) {
    linesGroup = this._svg.append('g')
      .attr('class', 'lines')
      .attr('transform', 'translate(' + this.margins().left() + ', ' + this.margins().top() + ')');
  }

  data.measurements().forEach(function(m, i) {
    var lineSeries = linesGroup.selectAll('.line-series-index-' + i);
    var pointSeries = linesGroup.selectAll('.point-series-index-' + i);

    if (lineSeries.empty()) { linesGroup.append('g').attr('class', 'line-series-index-' + i); }
    if (pointSeries.empty()) { linesGroup.append('g').attr('class', 'point-series-index-' + i); }
  });

  for (var i = data.measurements().length;; ++i) {
    var lineSeries = linesGroup.selectAll('.line-series-index-' + i);
    var pointSeries = linesGroup.selectAll('.point-series-index-' + i);
    if (lineSeries.empty()) { break; }
    lineSeries.remove();
    pointSeries.remove();
  }

  return this._drawLines(range, data, delta, zoom, xScale, yScale);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {number} delta
 * @param {number} zoom
 * @param {function} xScale D3 linear scale
 * @param {function} yScale D3 linear scale
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.LineTrackCustom.prototype._drawLines = function(range, data, delta, zoom, xScale, yScale) {
  /** @type {epiviz.ui.charts.ColorPalette} */
  var colors = this.colors();

  /** @type {number} */
  var step = parseInt(this.customSettingsValues()[epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.STEP]);

  /** @type {boolean} */
  var showPoints = this.customSettingsValues()[epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.SHOW_POINTS];

  /** @type {boolean} */
  var showLines = this.customSettingsValues()[epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.SHOW_LINES];

  /** @type {boolean} */
  var showErrorBars = this.customSettingsValues()[epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.SHOW_ERROR_BARS];

  /** @type {number} */
  var pointRadius = this.customSettingsValues()[epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.POINT_RADIUS];

  /** @type {number} */
  var lineThickness = this.customSettingsValues()[epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.LINE_THICKNESS];

  var interpolation = this.customSettingsValues()[epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.INTERPOLATION];

  var self = this;

  var invXScale = d3.scale.linear()
    .domain([0, this.width() - this.margins().sumAxis(epiviz.ui.charts.Axis.X)])
    .range([range.start(), range.end()]);
  var deltaInBp = invXScale(delta) - range.start();
  var extendedRange = epiviz.datatypes.GenomicRange.fromStartEnd(
    range.seqName(),
    Math.min(range.start(), range.start() + deltaInBp),
    Math.max(range.end(), range.end() + deltaInBp));

  var graph = this._svg.select('.lines');

  /** @type {Array.<epiviz.ui.charts.ChartObject>} */
  var items = [];

  data.foreach(function(m, series, i) {
    var color = self._measurementColorLabels ? colors.getByKey(self._measurementColorLabels.get(m)) : colors.get(i);

    /** @type {{index: ?number, length: number}} */
    var drawBoundaries = series.binarySearchStarts(extendedRange);
    if (drawBoundaries.length == 0) { return; }

    // TODO: In the future, use global index to align steps:
    //var globalIndex = series.get(drawBoundaries.index).globalIndex;
    //globalIndex = Math.ceil(globalIndex / step) * step;
    var index = Math.ceil(drawBoundaries.index / step) * step;
    drawBoundaries.length = Math.max(0, drawBoundaries.length - index + drawBoundaries.index);
    drawBoundaries.index = index;

    var indices = epiviz.utils.range(drawBoundaries.length, drawBoundaries.index)
      .filter(function(i) {
        return !step || step <= 1 || ((i - drawBoundaries.index) % step == 0);
      });

    for (var k = 0; k < indices.length; ++k) {
      var cell = series.get(indices[k]);
      items.push(new epiviz.ui.charts.ChartObject(sprintf('line_%s_%s', i, cell.globalIndex), cell.rowItem.start(), cell.rowItem.end(), [cell.value], i, [[cell]], [m], sprintf('item data-series-%s', i)));
    }

    var x = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      return xScale(cell.rowItem.start());
    };

    var y = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      return yScale(cell.value);
    };

    var errMinus = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      var v = cell.valueAnnotation ? cell.valueAnnotation['errMinus'] : null;
      return v != undefined ? yScale(v) : null;
    };

    var errPlus = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      var v = cell.valueAnnotation ? cell.valueAnnotation['errPlus'] : null;
      return v != undefined ? yScale(v) : null;
    };

    if (showLines) {
      var line = d3.svg.line()
        .x(x).y(y)
        .interpolate(interpolation);

      var lines = graph.select('.line-series-index-' + i)
        .selectAll('path')
        .data([indices]);

      lines.enter()
        .append('path')
        .attr('d', line)
        .style('shape-rendering', 'auto')
        .style('stroke-opacity', '0.8')
        .on('mouseover', function() { self._captureMouseHover(); })
        .on('mousemove', function() { self._captureMouseHover(); })
        .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });

      lines
        .attr('d', line)
        .style('stroke', color)
        .style('stroke-width', lineThickness)
        .attr('transform', 'translate(' + (+delta) + ')')
        .transition()
        .duration(500)
        .attr('transform', 'translate(' + (0) + ')');
    } else {
      graph.select('.line-series-index-' + i)
        .selectAll('path').remove();
    }

    graph.select('.point-series-index-' + i)
      .selectAll('circle').remove();
    graph.select('.point-series-index-' + i)
      .selectAll('.error-bar').remove();
    if (showPoints) {
      var points = graph.select('.point-series-index-' + i)
        .selectAll('circle')
        .data(indices);
      points.enter()
        .append('circle')
        .attr('class', 'point-series-index-' + i)
        .attr('r', pointRadius)
        .attr('cx', x)
        .attr('cy', y)
        .attr('fill', color)
        .attr('stroke', color)
        .attr('transform', 'translate(' + (+delta) + ')')
        .transition()
        .duration(500)
        .attr('transform', 'translate(' + (0) + ')');

      points
        .on('mouseover', function() { self._captureMouseHover(); })
        .on('mousemove', function() { self._captureMouseHover(); })
        .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });

      points.exit()
        .transition()
        .duration(500)
        .style('opacity', 0)
        .remove();

      if (showErrorBars) {
        var errorBars = graph.select('.point-series-index-' + i)
          .selectAll('.error-bar')
          .data(indices);
        errorBars.enter()
          .append('g')
          .attr('class', 'error-bar')
          .each(function(j) {
            var m = errMinus(j), p = errPlus(j);
            if (m == null || p == null) { return; }
            d3.select(this).append('line')
              .attr('x1', x(j)).attr('x2', x(j)).attr('y1', m).attr('y2', p)
              .style('stroke', color)
              .style('shape-rendering', 'auto');
            d3.select(this).append('line')
              .attr('x1', x(j) - 2).attr('x2', x(j) + 2).attr('y1', m).attr('y2', m)
              .style('stroke', color)
              .style('shape-rendering', 'auto');
            d3.select(this).append('line')
              .attr('x1', x(j) - 2).attr('x2', x(j) + 2).attr('y1', p).attr('y2', p)
              .style('stroke', color)
              .style('shape-rendering', 'auto');
          })
          .attr('transform', 'translate(' + (+delta) + ')')
          .transition()
          .duration(500)
          .attr('transform', 'translate(' + (0) + ')');

        errorBars
          .on('mouseover', function() { self._captureMouseHover(); })
          .on('mousemove', function() { self._captureMouseHover(); })
          .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });

        errorBars.exit()
          .transition()
          .duration(500)
          .style('opacity', 0)
          .remove();
      }
    }
  });

  return items;
};

// goog.inherits(epiviz.plugins.charts.LineTrackCustom, epiviz.plugins.charts.Track);
// Input 146
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 9:30 AM
 */

goog.provide('epiviz.plugins.charts.LineTrackTypeCustom');

goog.require('epiviz.plugins.charts.LineTrackCustom');
goog.require('epiviz.ui.charts.TrackType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.TrackType}
 * @constructor
 */
epiviz.plugins.charts.LineTrackTypeCustom = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.TrackType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.LineTrackTypeCustom.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.TrackType.prototype);
epiviz.plugins.charts.LineTrackTypeCustom.constructor = epiviz.plugins.charts.LineTrackTypeCustom;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.LineTrackCustom}
 */
epiviz.plugins.charts.LineTrackTypeCustom.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.LineTrackCustom(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LineTrackTypeCustom.prototype.typeName = function() {
  return 'epiviz.plugins.charts.LineTrackCustom';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LineTrackTypeCustom.prototype.chartName = function() {
  return 'Line Track Custom';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LineTrackTypeCustom.prototype.chartHtmlAttributeName = function() {
  return 'lines-custom';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.LineTrackTypeCustom.prototype.measurementsFilter = function() { return function(m) { return m.type() == epiviz.measurements.Measurement.Type.FEATURE; }; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.LineTrackTypeCustom.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.TrackType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.STEP,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      50,
      'Step'),
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.SHOW_POINTS,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      false,
      'Show points'),
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.SHOW_LINES,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      true,
      'Show lines'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.SHOW_ERROR_BARS,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      true,
      'Show error bars'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.POINT_RADIUS,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      1,
      'Point radius'),
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.LINE_THICKNESS,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      1,
      'Line thickness'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.INTERPOLATION,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'linear',
      'Interpolation',
      ['linear', 'step-before', 'step-after', 'basis', 'basis-open', 'basis-closed', 'bundle', 'cardinal', 'cardinal-open', 'monotone'])
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings = {
  STEP: 'step',
  SHOW_POINTS: 'showPoints',
  SHOW_ERROR_BARS: 'showErrorBars',
  SHOW_LINES: 'showLines',
  POINT_RADIUS: 'pointRadius',
  LINE_THICKNESS: 'lineThickness',
  INTERPOLATION: 'interpolation'
};

// goog.inherits(epiviz.plugins.charts.LineTrackTypeCustom, epiviz.ui.charts.TrackType);

// Input 147
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 11:55 PM
 */

goog.provide('epiviz.plugins.charts.ScatterPlotType');

goog.require('epiviz.plugins.charts.ScatterPlot');
goog.require('epiviz.ui.charts.PlotType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.PlotType}
 * @constructor
 */
epiviz.plugins.charts.ScatterPlotType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.PlotType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.ScatterPlotType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.PlotType.prototype);
epiviz.plugins.charts.ScatterPlotType.constructor = epiviz.plugins.charts.ScatterPlotType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.ScatterPlot}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.ScatterPlot(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.ScatterPlot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.chartName = function() {
  return 'Scatter Plot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.chartHtmlAttributeName = function() {
  return 'scatter';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.measurementsFilter = function() { return function(m) { return epiviz.measurements.Measurement.Type.hasValues(m.type()); }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * Gets the minimum number of measurements that must be selected for the chart to be displayed
 * @returns {number}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.minSelectedMeasurements = function() { return 2; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.ScatterPlotType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.PlotType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.ScatterPlotType.CustomSettings.CIRCLE_RADIUS_RATIO,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      0.015,
      'Circle radius ratio'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.X_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min X'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.X_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max X'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.ScatterPlotType.CustomSettings.ABS_LINE_VAL,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Draw abline')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.ScatterPlotType.CustomSettings = {
  CIRCLE_RADIUS_RATIO: 'circleRadiusRatio',
  ABS_LINE_VAL: 'abLine'
};

// goog.inherits(epiviz.plugins.charts.ScatterPlotType, epiviz.ui.charts.PlotType);

// Input 148
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 9:30 AM
 */

goog.provide('epiviz.plugins.charts.LineTrackCustom');

goog.require('epiviz.ui.charts.Track');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.datatypes.GenomicRange');
goog.require('epiviz.ui.charts.CustomSetting');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Track}
 * @constructor
 */
epiviz.plugins.charts.LineTrackCustom = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Track.call(this, id, container, properties);

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.LineTrackCustom.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Track.prototype);
epiviz.plugins.charts.LineTrackCustom.constructor = epiviz.plugins.charts.LineTrackCustom;

/**
 * @protected
 */
epiviz.plugins.charts.LineTrackCustom.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Track.prototype._initialize.call(this);
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.LineTrackCustom.prototype.draw = function(range, data, slide, zoom) {
  epiviz.ui.charts.Track.prototype.draw.call(this, range, data, slide, zoom);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  slide = slide || this._slide || 0;
  zoom = zoom || this._zoom || 1;
  this._slide = 0;
  this._zoom = 1;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  var CustomSetting = epiviz.ui.charts.CustomSetting;
  var minY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MIN];
  var maxY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MAX];

  if (minY == CustomSetting.DEFAULT) {
    minY = null;
    this.measurements().foreach(function(m) {
      if (m === null) { return; }
      if (minY === null || m.minValue() < minY) { minY = m.minValue(); }
    });
  }

  if (maxY == CustomSetting.DEFAULT) {
    maxY = null;
    this.measurements().foreach(function(m) {
      if (m === null) { return; }
      if (maxY === null || m.maxValue() > maxY) { maxY = m.maxValue(); }
    });
  }

  if (minY === null && maxY === null) { minY = -1; maxY = 1; }
  if (minY === null) { minY = maxY - 1; }
  if (maxY === null) { maxY = minY + 1; }

  var Axis = epiviz.ui.charts.Axis;
  var xScale = d3.scale.linear()
    .domain([range.start(), range.end()])
    .range([0, this.width() - this.margins().sumAxis(Axis.X)]);
  var yScale = d3.scale.linear()
    .domain([minY, maxY])
    .range([this.height() - this.margins().sumAxis(Axis.Y), 0]);

  this._clearAxes();
  this._drawAxes(xScale, yScale, 10, 5);

  var delta = slide * (this.width() - this.margins().sumAxis(Axis.X)) / range.width();
  var linesGroup = this._svg.selectAll('.lines');

  if (linesGroup.empty()) {
    linesGroup = this._svg.append('g')
      .attr('class', 'lines')
      .attr('transform', 'translate(' + this.margins().left() + ', ' + this.margins().top() + ')');
  }

  data.measurements().forEach(function(m, i) {
    var lineSeries = linesGroup.selectAll('.line-series-index-' + i);
    var pointSeries = linesGroup.selectAll('.point-series-index-' + i);

    if (lineSeries.empty()) { linesGroup.append('g').attr('class', 'line-series-index-' + i); }
    if (pointSeries.empty()) { linesGroup.append('g').attr('class', 'point-series-index-' + i); }
  });

  for (var i = data.measurements().length;; ++i) {
    var lineSeries = linesGroup.selectAll('.line-series-index-' + i);
    var pointSeries = linesGroup.selectAll('.point-series-index-' + i);
    if (lineSeries.empty()) { break; }
    lineSeries.remove();
    pointSeries.remove();
  }

  return this._drawLines(range, data, delta, zoom, xScale, yScale);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {number} delta
 * @param {number} zoom
 * @param {function} xScale D3 linear scale
 * @param {function} yScale D3 linear scale
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.LineTrackCustom.prototype._drawLines = function(range, data, delta, zoom, xScale, yScale) {
  /** @type {epiviz.ui.charts.ColorPalette} */
  var colors = this.colors();

  /** @type {number} */
  var step = parseInt(this.customSettingsValues()[epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.STEP]);

  /** @type {boolean} */
  var showPoints = this.customSettingsValues()[epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.SHOW_POINTS];

  /** @type {boolean} */
  var showLines = this.customSettingsValues()[epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.SHOW_LINES];

  /** @type {boolean} */
  var showErrorBars = this.customSettingsValues()[epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.SHOW_ERROR_BARS];

  /** @type {number} */
  var pointRadius = this.customSettingsValues()[epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.POINT_RADIUS];

  /** @type {number} */
  var lineThickness = this.customSettingsValues()[epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.LINE_THICKNESS];

  var interpolation = this.customSettingsValues()[epiviz.plugins.charts.LineTrackTypeCustom.CustomSettings.INTERPOLATION];

  var self = this;

  var invXScale = d3.scale.linear()
    .domain([0, this.width() - this.margins().sumAxis(epiviz.ui.charts.Axis.X)])
    .range([range.start(), range.end()]);
  var deltaInBp = invXScale(delta) - range.start();
  var extendedRange = epiviz.datatypes.GenomicRange.fromStartEnd(
    range.seqName(),
    Math.min(range.start(), range.start() + deltaInBp),
    Math.max(range.end(), range.end() + deltaInBp));

  var graph = this._svg.select('.lines');

  /** @type {Array.<epiviz.ui.charts.ChartObject>} */
  var items = [];

  data.foreach(function(m, series, i) {
    var color = self._measurementColorLabels ? colors.getByKey(self._measurementColorLabels.get(m)) : colors.get(i);

    /** @type {{index: ?number, length: number}} */
    var drawBoundaries = series.binarySearchStarts(extendedRange);
    if (drawBoundaries.length == 0) { return; }

    // TODO: In the future, use global index to align steps:
    //var globalIndex = series.get(drawBoundaries.index).globalIndex;
    //globalIndex = Math.ceil(globalIndex / step) * step;
    var index = Math.ceil(drawBoundaries.index / step) * step;
    drawBoundaries.length = Math.max(0, drawBoundaries.length - index + drawBoundaries.index);
    drawBoundaries.index = index;

    var indices = epiviz.utils.range(drawBoundaries.length, drawBoundaries.index)
      .filter(function(i) {
        return !step || step <= 1 || ((i - drawBoundaries.index) % step == 0);
      });

    for (var k = 0; k < indices.length; ++k) {
      var cell = series.get(indices[k]);
      items.push(new epiviz.ui.charts.ChartObject(sprintf('line_%s_%s', i, cell.globalIndex), cell.rowItem.start(), cell.rowItem.end(), [cell.value], i, [[cell]], [m], sprintf('item data-series-%s', i)));
    }

    var x = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      return xScale(cell.rowItem.start());
    };

    var y = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      return yScale(cell.value);
    };

    var errMinus = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      var v = cell.valueAnnotation ? cell.valueAnnotation['errMinus'] : null;
      return v != undefined ? yScale(v) : null;
    };

    var errPlus = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.get(j);
      var v = cell.valueAnnotation ? cell.valueAnnotation['errPlus'] : null;
      return v != undefined ? yScale(v) : null;
    };

    if (showLines) {
      var line = d3.svg.line()
        .x(x).y(y)
        .interpolate(interpolation);

      var lines = graph.select('.line-series-index-' + i)
        .selectAll('path')
        .data([indices]);

      lines.enter()
        .append('path')
        .attr('d', line)
        .style('shape-rendering', 'auto')
        .style('stroke-opacity', '0.8')
        .on('mouseover', function() { self._captureMouseHover(); })
        .on('mousemove', function() { self._captureMouseHover(); })
        .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });

      lines
        .attr('d', line)
        .style('stroke', color)
        .style('stroke-width', lineThickness)
        .attr('transform', 'translate(' + (+delta) + ')')
        .transition()
        .duration(500)
        .attr('transform', 'translate(' + (0) + ')');
    } else {
      graph.select('.line-series-index-' + i)
        .selectAll('path').remove();
    }

    graph.select('.point-series-index-' + i)
      .selectAll('circle').remove();
    graph.select('.point-series-index-' + i)
      .selectAll('.error-bar').remove();
    if (showPoints) {
      var points = graph.select('.point-series-index-' + i)
        .selectAll('circle')
        .data(indices);
      points.enter()
        .append('circle')
        .attr('class', 'point-series-index-' + i)
        .attr('r', pointRadius)
        .attr('cx', x)
        .attr('cy', y)
        .attr('fill', color)
        .attr('stroke', color)
        .attr('transform', 'translate(' + (+delta) + ')')
        .transition()
        .duration(500)
        .attr('transform', 'translate(' + (0) + ')');

      points
        .on('mouseover', function() { self._captureMouseHover(); })
        .on('mousemove', function() { self._captureMouseHover(); })
        .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });

      points.exit()
        .transition()
        .duration(500)
        .style('opacity', 0)
        .remove();

      if (showErrorBars) {
        var errorBars = graph.select('.point-series-index-' + i)
          .selectAll('.error-bar')
          .data(indices);
        errorBars.enter()
          .append('g')
          .attr('class', 'error-bar')
          .each(function(j) {
            var m = errMinus(j), p = errPlus(j);
            if (m == null || p == null) { return; }
            d3.select(this).append('line')
              .attr('x1', x(j)).attr('x2', x(j)).attr('y1', m).attr('y2', p)
              .style('stroke', color)
              .style('shape-rendering', 'auto');
            d3.select(this).append('line')
              .attr('x1', x(j) - 2).attr('x2', x(j) + 2).attr('y1', m).attr('y2', m)
              .style('stroke', color)
              .style('shape-rendering', 'auto');
            d3.select(this).append('line')
              .attr('x1', x(j) - 2).attr('x2', x(j) + 2).attr('y1', p).attr('y2', p)
              .style('stroke', color)
              .style('shape-rendering', 'auto');
          })
          .attr('transform', 'translate(' + (+delta) + ')')
          .transition()
          .duration(500)
          .attr('transform', 'translate(' + (0) + ')');

        errorBars
          .on('mouseover', function() { self._captureMouseHover(); })
          .on('mousemove', function() { self._captureMouseHover(); })
          .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });

        errorBars.exit()
          .transition()
          .duration(500)
          .style('opacity', 0)
          .remove();
      }
    }
  });

  return items;
};

// goog.inherits(epiviz.plugins.charts.LineTrackCustom, epiviz.plugins.charts.Track);
// Input 149
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/2/2015
 * Time: 3:50 PM
 */

goog.provide('epiviz.plugins.charts.StackedLinePlot');

goog.require('epiviz.ui.charts.Plot');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');
goog.require('epiviz.measurements.MeasurementHashtable');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Plot}
 * @constructor
 */
epiviz.plugins.charts.StackedLinePlot = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Plot.call(this, id, container, properties);

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.StackedLinePlot.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Plot.prototype);
epiviz.plugins.charts.StackedLinePlot.constructor = epiviz.plugins.charts.StackedLinePlot;

/**
 * @protected
 */
epiviz.plugins.charts.StackedLinePlot.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Plot.prototype._initialize.call(this);

  this._svg.classed('stacked-line-plot', true);
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.StackedLinePlot.prototype.draw = function(range, data, slide, zoom) {
  epiviz.ui.charts.Plot.prototype.draw.call(this, range, data, slide, zoom);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  var groupBy = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.ROW_GROUP_BY];
  var useGroupBy = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.USE_GROUP_BY];

  var self = this;

  var removeMarker = function() {

    for(var k=0; k < self._markers.length; k ++) {
      if (self._markers[k]._type == epiviz.ui.charts.markers.VisualizationMarker.Type.GROUP_BY_MEASUREMENTS) {
        // remove existing groupby marker.
        var old_mId = self._markers[k].id(); 
        delete self._markersMap[old_mId];
        delete self._markersIndices[old_mId];
        delete self._markers[k];

        self._markers.length--;
      }
    }
  };

  var checkMarker = function(marker) {

    // marker is empty!
    if (!marker) { return null; }
      var i;
      if (marker.id() in self._markersMap) {
        i = self._markersIndices[marker.id()];
        var oldMarker = self._markers[i];
        if (oldMarker == marker ||
            (oldMarker.type() == marker.type() &&
            oldMarker.preMarkStr() == marker.preMarkStr() &&
            oldMarker.markStr() == marker.markStr())) {
          // Marker not modified
          return null;
        }
        self._markers[i] = marker;
        self._markersMap[marker.id()] = marker;
      } 
      else {
        // remove if the marker type already exists
        removeMarker();

        // add the new marker
        i = self._markers.length;
        self._markers.push(marker);
        self._markersIndices[marker.id()] = i;
        self._markersMap[marker.id()] = marker;
      }
  };

  var transformPlotData = function() {
    self.transformData(self._lastRange, self._unalteredData).done(function() {
       self._drawPlot(self._lastRange, self._lastData, slide, zoom);
    });

    self._markersModified.notify(new epiviz.ui.charts.VisEventArgs(self._id, self._markers));
  };

  if(useGroupBy) {
    var marker = new epiviz.ui.charts.markers.VisualizationMarker(epiviz.ui.charts.markers.VisualizationMarker.Type.GROUP_BY_MEASUREMENTS, null, null, 'function(data){return null}', "function(m, data, preMarkResult) {return m.annotation()['" + groupBy + "'];}");
    var value = checkMarker(marker);

    //if(value != null) {
    //  this._drawPlot(range, data, slide, zoom);
    //}
  }
  else {
    removeMarker();
  }

  transformPlotData();
  
};

epiviz.plugins.charts.StackedLinePlot.prototype._drawPlot = function(range, data, slide, zoom) {

  var rowLabel = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL];

  var interpolation = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.INTERPOLATION];
  var xBound = interpolation.indexOf('step') == 0 ? data.measurements().length : data.measurements().length - 1;

  var Axis = epiviz.ui.charts.Axis;
  var xScale = d3.scale.linear()
    .domain([0, xBound])
    .range([0, this.width() - this.margins().sumAxis(Axis.X)]);

  this._clearAxes();
  this._drawAxes(xScale, undefined, data.measurements().length, 5,
    undefined, undefined, undefined, undefined, undefined, undefined,
    data.measurements().map(function(m) {
      if (rowLabel == 'name') { return m.name(); }
      var anno = m.annotation();
      if (!anno || !(rowLabel in anno)) { return '<NA>'; }
      return anno[rowLabel];
    }), undefined, interpolation.indexOf('step') == 0);

  var linesGroup = this._svg.selectAll('.lines');

  if (linesGroup.empty()) {
    linesGroup = this._svg.append('g')
      .attr('class', 'lines items');

    var selectedGroup = linesGroup.append('g').attr('class', 'selected');
    linesGroup.append('g').attr('class', 'hovered');
    selectedGroup.append('g').attr('class', 'hovered');
  }
  linesGroup
    .attr('transform', 'translate(' + this.margins().left() + ', ' + this.margins().top() + ')');
  return this._drawLines(range, data, xScale);
}

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {function} xScale D3 linear scale
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.StackedLinePlot.prototype._drawLines = function(range, data, xScale) {
  var Axis = epiviz.ui.charts.Axis;

  /** @type {epiviz.ui.charts.ColorPalette} */
  var colors = this.colors();

  var interpolation = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.INTERPOLATION];

  var colLabel = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.COL_LABEL];

  /** @type {string} */
  var offset = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.OFFSET];

  /** @type {boolean} */
  var scaleToPercent = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.SCALE_TO_PERCENT];

  var hoverOpacity = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.HOVER_OPACITY];
  
  var self = this;

  var graph = this._svg.select('.lines');

  var firstGlobalIndex = data.firstSeries().globalStartIndex();
  var lastGlobalIndex = data.firstSeries().globalEndIndex();

  data.foreach(function(measurement, series) {
    var firstIndex = series.globalStartIndex();
    var lastIndex = series.globalEndIndex();

    if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
  });

  var nEntries = lastGlobalIndex - firstGlobalIndex;

  // TODO: This might not be needed anymore
  // TODO: Search for all usages of this method
  var dataHasGenomicLocation = epiviz.measurements.Measurement.Type.isOrdered(this.measurements().first().type());
  var firstIndex, lastIndex;
  for (var i = 0; i < nEntries; ++i) {
    var globalIndex = i + firstGlobalIndex;
    var item = data.firstSeries().getRowByGlobalIndex(globalIndex);
    if (!item) { continue; }
    if (!dataHasGenomicLocation ||
      (range.start() == undefined || range.end() == undefined) ||
      item.start() < range.end() && item.end() >= range.start()) {
      if (firstIndex == undefined) { firstIndex = globalIndex; }
      lastIndex = globalIndex + 1;
    }
  }

  firstGlobalIndex = firstIndex;
  lastGlobalIndex = lastIndex;
  nEntries = lastIndex - firstIndex;
  var indices = epiviz.utils.range(nEntries, firstGlobalIndex);

  if (indices.length == 0) { return []; }

  /** @type {epiviz.measurements.MeasurementHashtable.<number>} */
  var msSums = null;
  if (scaleToPercent) {
    msSums = new epiviz.measurements.MeasurementHashtable();

    data.measurements().forEach(function(m) {
      var sum = indices
        .filter(function(i) {
          return data.getByGlobalIndex(m, i); // filter out undefined items
        })
        .map(function(i) { return data.getByGlobalIndex(m, i).value; })
        .reduce(function(v1, v2) { return v1 + v2; });
      msSums.put(m, sum);
    });
  }

  /**
   * @param {epiviz.datatypes.GenomicData.RowItem} row
   * @returns {string|number}
   */
  var colorBy = function(row) {
    return self._globalIndexColorLabels ? self._globalIndexColorLabels[row.globalIndex()] : row.metadata(colLabel);
  };

  var valuesForIndex = function(index) {
    var ret = [];
    if (interpolation == 'step-before') {
      ret.push({ x: 0, y: 0 })
    }
    var ms = data.measurements();
    ret = ret.concat(ms.map(function(m, i) {
      var div = scaleToPercent ? msSums.get(m) : 1;
      div = div || 1; // Prevent division by 0
      var item = data.getByGlobalIndex(m, index);
      return { x: ret.length + i, y: item ? item.value / div : null };
    }));

    if (interpolation == 'step-after') {
      ret.push({ x: ret.length, y: 0 });
    }
    return ret.filter(function(o) {
      return o.y !== null;
    });
  };

  var lineItems;

  lineItems = indices
    .filter(function(index) { return data.firstSeries().getRowByGlobalIndex(index); })
    .map(function(index) {
    var rowItem = data.firstSeries().getRowByGlobalIndex(index);
    var measurements = data.measurements();
    return new epiviz.ui.charts.ChartObject(
      sprintf('line-series-%s', index),
      rowItem.start(),
      rowItem.end(),
      valuesForIndex(index),
      index,
      measurements.map(function(m, i) { return [data.getByGlobalIndex(m, index)]; }), // valueItems one for each measurement
      measurements, // measurements
      '');
  });

  var seriesAreas = indices.map(function(index) { return valuesForIndex(index); });
  var stack = d3.layout.stack().offset(offset);
  var layers = stack(seriesAreas);

  var yScale = d3.scale.linear()
    .domain([
      Math.min(0, d3.min(layers, function(layer) { return d3.min(layer, function(d) { return d.y0 + d.y; }); })),
      d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y0 + d.y; }); })])
    .range([this.height() - this.margins().sumAxis(Axis.Y), 0]);

  var area = d3.svg.area()
    .x(function(d) { return xScale(d.x); })
    .y0(function(d) { return yScale(d.y0); })
    .y1(function(d) { return yScale(d.y0 + d.y); })
    .interpolate(interpolation);

  var lines = graph
    .selectAll('.line-series')
    .data(lineItems, function(d) { return d.seriesIndex; });

  lines.enter()
    .insert('path', ':first-child').attr('class', 'line-series item')
    .attr('d', function(d, i) { return area(layers[i]); })
    .style('opacity', '0')
    .style('shape-rendering', 'auto')
    .style('fill', function(d, i) { return colors.getByKey(colorBy(data.firstSeries().getRowByGlobalIndex(d.seriesIndex))); })
    .on('mouseover', function(d, i) {
      self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));

      graph.selectAll(".item")
      .style("opacity", 1 - hoverOpacity);

      graph.selectAll(".hovered .item")
      .style("opacity", hoverOpacity);

    })
    .on('mouseout', function () {
      self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));



    });

  lines
    .transition()
    .duration(500)
    .style('opacity', '0.7')
    .attr('d', function(d, i) { return area(layers[i]); })
    .style('fill', function(d, i) { return colors.getByKey(colorBy(data.firstSeries().getRowByGlobalIndex(d.seriesIndex))); });

  lines
    .exit()
    .transition()
    .duration(500)
    .style('opacity', '0')
    .remove();

  // Draw legend
  var title = '';

  var labels = {};
  indices.forEach(function(index) {
    if (!data.firstSeries().getByGlobalIndex(index)) { return; }
    var label = colorBy(data.firstSeries().getRowByGlobalIndex(index));
    labels[label] = label;
  });

  this._svg.selectAll('.chart-title').remove();
  this._svg.selectAll('.chart-title-color ').remove();
  var titleEntries = this._svg
    .selectAll('.chart-title')
    .data(Object.keys(labels));
  titleEntries
    .enter()
    .append('text')
    .attr('class', 'chart-title')
    .attr('font-weight', 'bold')
    .attr('y', self.margins().top() - 5);
  titleEntries
    .attr('fill', function(label) { return colors.getByKey(label); })
    .text(function(label) { return label; });
  var textLength = 0;
  var titleEntriesStartPosition = [];

  $('#' + this.id() + ' .chart-title')
    .each(function(i) {
      titleEntriesStartPosition.push(textLength);
      textLength += this.getBBox().width + 15;
    });

  titleEntries.attr('x', function(column, i) {
    return self.margins().left() + 10 + titleEntriesStartPosition[i];
  });

  var colorEntries = this._svg
    .selectAll('.chart-title-color')
    .data(Object.keys(labels))
    .enter()
    .append('circle')
    .attr('class', 'chart-title-color')
    .attr('cx', function(column, i) { return self.margins().left() + 4 + titleEntriesStartPosition[i]; })
    .attr('cy', self.margins().top() - 9)
    .attr('r', 4)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .attr('fill', function(label) { return colors.getByKey(label); });

  return lineItems;
};

/**
 * @returns {Array.<string>}
 */
epiviz.plugins.charts.StackedLinePlot.prototype.colorLabels = function() {
  var labels = [];
  for (var i = 0; i < this.colors().size() && i < 20; ++i) {
    labels.push('Color ' + (i + 1));
  }
  return labels;
};


epiviz.plugins.charts.StackedLinePlot.prototype.doHover = function(selectedObject) {

    var hoverOpacity = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.HOVER_OPACITY];


  var itemsGroup = this._container.find('.items');
  var unselectedHoveredGroup = itemsGroup.find('> .hovered');
  var selectedGroup = itemsGroup.find('> .selected');
  var selectedHoveredGroup = selectedGroup.find('> .hovered');

  var filter = function() {
    return selectedObject.overlapsWith(d3.select(this).data()[0]);
  };
  var selectItems = itemsGroup.find('> .item').filter(filter);
  unselectedHoveredGroup.append(selectItems);

  selectItems = selectedGroup.find('> .item').filter(filter);
  selectedHoveredGroup.append(selectItems);

        this._svg.selectAll(".item")
      .style("opacity", 1 - hoverOpacity);

      this._svg.selectAll(".hovered .item")
      .style("opacity", hoverOpacity);
};

/**
 */
epiviz.plugins.charts.StackedLinePlot.prototype.doUnhover = function() {

    var hoverOpacity = this.customSettingsValues()[epiviz.plugins.charts.StackedLinePlotType.CustomSettings.HOVER_OPACITY];


  var itemsGroup = this._container.find('.items');
  var unselectedHoveredGroup = itemsGroup.find('> .hovered');
  var selectedGroup = itemsGroup.find('> .selected');
  var selectedHoveredGroup = selectedGroup.find('> .hovered');

  itemsGroup.prepend(unselectedHoveredGroup.children());

  selectedGroup.prepend(selectedHoveredGroup.children());

        this._svg.selectAll(".item")
      .style("opacity", 1);

      this._svg.selectAll(".hovered .item")
      .style("opacity", 1);
};

// goog.inherits(epiviz.plugins.charts.StackedLinePlot, epiviz.ui.charts.Plot);

// Input 150
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/9/2014
 * Time: 1:09 AM
 */

goog.provide('epiviz.plugins.charts.LinePlotType');

goog.require('epiviz.plugins.charts.LinePlot');
goog.require('epiviz.ui.charts.PlotType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.PlotType}
 * @constructor
 */
epiviz.plugins.charts.LinePlotType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.PlotType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.LinePlotType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.PlotType.prototype);
epiviz.plugins.charts.LinePlotType.constructor = epiviz.plugins.charts.LinePlotType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.LinePlot}
 */
epiviz.plugins.charts.LinePlotType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.LinePlot(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LinePlotType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.LinePlot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LinePlotType.prototype.chartName = function() {
  return 'Line Plot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.LinePlotType.prototype.chartHtmlAttributeName = function() {
  return 'line-plot';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.LinePlotType.prototype.measurementsFilter = function() { return function(m) { return m.type() == epiviz.measurements.Measurement.Type.FEATURE; }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.plugins.charts.LinePlotType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.LinePlotType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.PlotType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.COL_LABEL,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_METADATA,
      'colLabel',
      'Columns labels'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_ANNOTATION,
      'name',
      'Row labels'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LinePlotType.CustomSettings.SHOW_POINTS,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      false,
      'Show points'),
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LinePlotType.CustomSettings.SHOW_LINES,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      true,
      'Show lines'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LinePlotType.CustomSettings.SHOW_ERROR_BARS,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      true,
      'Show error bars'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LinePlotType.CustomSettings.POINT_RADIUS,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      4,
      'Point radius'),
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LinePlotType.CustomSettings.LINE_THICKNESS,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      3,
      'Line thickness'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MIN,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Min Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.Y_MAX,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Max Y'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LinePlotType.CustomSettings.INTERPOLATION,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'basis',
      'Interpolation',
      ['linear', 'step-before', 'step-after', 'basis', 'basis-open', 'basis-closed', 'bundle', 'cardinal', 'cardinal-open', 'monotone']),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.LinePlotType.CustomSettings.ABS_LINE_VAL,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      epiviz.ui.charts.CustomSetting.DEFAULT,
      'Draw abline')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.LinePlotType.CustomSettings = {
  SHOW_POINTS: 'showPoints',
  SHOW_ERROR_BARS: 'showErrorBars',
  SHOW_LINES: 'showLines',
  POINT_RADIUS: 'pointRadius',
  LINE_THICKNESS: 'lineThickness',
  INTERPOLATION: 'interpolation',
  ABS_LINE_VAL: 'abLine'
};

// goog.inherits(epiviz.plugins.charts.LinePlotType, epiviz.ui.charts.PlotType);

// Input 151
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 11:55 PM
 */

goog.provide('epiviz.plugins.charts.CustomScatterPlot');

goog.require('epiviz.ui.charts.Plot');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.ChartIndexObject');
goog.require('epiviz.deferred.Deferred');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Plot}
 * @constructor
 */
epiviz.plugins.charts.CustomScatterPlot = function(id, container, properties) {
    // Call superclass constructor
    epiviz.ui.charts.Plot.call(this, id, container, properties);

    // this._dispatch = d3.dispatch("hover", "click");

    /**
     * D3 chart container
     * @type {*}
     * @private
     */
    this._chartContent = null;

    /**
     * D3 legend container
     * @type {*}
     * @private
     */
    this._legend = null;

    /**
     * @type {Array.<epiviz.measurements.Measurement>}
     * @private
     */
    this._measurementsX = [];

    /**
     * @type {Array.<epiviz.measurements.Measurement>}
     * @private
     */
    this._measurementsY = [];

    var self = this;
    this.measurements().foreach(function(m, i) {
        if (i % 2 == 0) { self._measurementsX.push(m); } else { self._measurementsY.push(m); }
    });

    /**
     * @type {string}
     * @private
     */
    this._xLabel = '';

    /**
     * @type {string}
     * @private
     */
    this._yLabel = '';

    for (var i = 0; i < Math.min(this._measurementsX.length, this._measurementsY.length); ++i) {
        if (i > 0) {
            this._xLabel += ', ';
            this._yLabel += ', ';
        }
        this._xLabel += this._measurementsX[i].name();
        this._yLabel += this._measurementsY[i].name();
    }

    /**
     * @type {Array.<string>}
     * @private
     */
    this._colorLabels = [];

    this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.CustomScatterPlot.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Plot.prototype);
epiviz.plugins.charts.CustomScatterPlot.constructor = epiviz.plugins.charts.CustomScatterPlot;

/**
 * @protected
 */
epiviz.plugins.charts.CustomScatterPlot.prototype._initialize = function() {
    // Call super
    epiviz.ui.charts.Plot.prototype._initialize.call(this);

    this._svg.classed('scatter-plot', true);

    this._chartContent = this._svg.append('g').attr('class', 'chart-content');
    this._legend = this._svg.append('g').attr('class', 'chart-legend');
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */

epiviz.plugins.charts.CustomScatterPlot.prototype.draw = function() {
    epiviz.ui.charts.Plot.prototype.draw.call(this, undefined, undefined);
    var self = this;
    self._variance_labels = self._lastData.pca_variance_explained;
    // self._variance_labels = [0.9, 0.1];
    self.drawScatter(self._lastRange, self._lastData.data, "sample_id", "PC1", "PC2");
};



epiviz.plugins.charts.CustomScatterPlot.prototype.drawScatter = function(range, data, key, dimx, dimy) {

    // epiviz.ui.charts.Plot.prototype.draw.call(this, range, data);

    // If data is defined, then the base class sets this._lastData to data.
    // If it isn't, then we'll use the data from the last draw call
    // data = this._lastData;
    //range = this._lastRange;

    // If data is not defined, there is nothing to draw
    // if (!data || !range) {
    //     return [];
    // }

    // group data by keys

    // var keysList = Objects.keys(tempData);

    // var groupData = d3.nest().key(function(d) { return d[key]; }).entries(data);

    // collapse data points -> dataX, dataY (assume same length dataX, and dataY)

    // joint dataX, dataY on common keys -> data (array of objects)

    return this._drawCircles(data, dimx, dimy, key);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.CustomScatterPlot.prototype._drawCircles = function(data, dimx, dimy, key) {
    var self = this;
    var Axis = epiviz.ui.charts.Axis;
    var circleRadius = Math.max(1, this.customSettingsValues()[epiviz.plugins.charts.CustomScatterPlotType.CustomSettings.CIRCLE_RADIUS_RATIO] * Math.min(this.width(), this.height()));
    var gridSquareSize = Math.max(Math.floor(circleRadius), 1);
    // var nSeries = Math.min(this._measurementsX.length, this._measurementsY.length);

    // var firstGlobalIndex = data.firstSeries().globalStartIndex();
    // var lastGlobalIndex = data.firstSeries().globalEndIndex();
    // data.foreach(function(measurement, series) {

    //     var firstIndex = series.globalStartIndex();
    //     var lastIndex = series.globalEndIndex();

    //     if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    //     if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
    // });

    // var nItems = lastGlobalIndex - firstGlobalIndex;

    var margins = this.margins();
    var width = this.width();
    var height = this.height();

    var CustomSetting = epiviz.ui.charts.CustomSetting;
    var minY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MIN];
    var maxY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MAX];
    var minX = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.X_MIN];
    var maxX = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.X_MAX];

    var colorbylabel = this.customSettingsValues()[epiviz.plugins.charts.CustomScatterPlotType.CustomSettings.COLOR_BY];

    if (minX == CustomSetting.DEFAULT) { minX = this._measurementsX[0].minValue(); }
    if (minY == CustomSetting.DEFAULT) { minY = this._measurementsY[0].minValue(); }
    if (maxX == CustomSetting.DEFAULT) { maxX = this._measurementsX[0].maxValue(); }
    if (maxY == CustomSetting.DEFAULT) { maxY = this._measurementsY[0].maxValue(); }

    // if (minX == CustomSetting.DEFAULT) {
    //     minX = d3.min(data, function(d) {
    //         return d[dimx];
    //     });
    // }
    // if (minY == CustomSetting.DEFAULT) {
    //     minY = d3.min(data, function(d) {
    //         return d[dimy];
    //     });
    // }
    // if (maxX == CustomSetting.DEFAULT) {
    //     maxX = d3.max(data, function(d) {
    //         return d[dimx];
    //     });
    // }
    // if (maxY == CustomSetting.DEFAULT) {
    //     maxY = d3.max(data, function(d) {
    //         return d[dimy];
    //     });
    // }
    
    // var padding = 2*this.customSettingsValues()[epiviz.plugins.charts.CustomScatterPlotType.CustomSettings.CIRCLE_RADIUS_RATIO];
    // minX = minX - padding;
    // maxX = maxX + padding;
    // minY = minY - padding;
    // maxY = maxY + padding;

    // var dataHasGenomicLocation = epiviz.measurements.Measurement.Type.isOrdered(this._measurementsX[0].type());

    var xScale = d3.scale.linear()
        .domain([minX, maxX])
        .range([0, width - margins.sumAxis(Axis.X)])
        .nice();
    var yScale = d3.scale.linear()
        .domain([minY, maxY])
        .range([height - margins.sumAxis(Axis.Y), 0])
        .nice();

    this._clearAxes(this._chartContent);
    this._drawAxes(xScale, yScale, 15, 15, this._chartContent);

    // var i, index;
    // var indices = []; //epiviz.utils.range(nSeries * nItems);
    // for (i = 0; i < nItems; ++i) {
    //     index = i + firstGlobalIndex;
    //     var item = data.getSeries(this._measurementsX[0]).getRowByGlobalIndex(index);
    //     if (!item) {
    //         continue;
    //     }
    //     if (!dataHasGenomicLocation ||
    //         (range.start() == undefined || range.end() == undefined) ||
    //         (item.start() < range.end() && item.end() > range.start())) {

    //         for (var j = 0; j < nSeries; ++j) {
    //             indices.push(j * nItems + i);
    //         }
    //     }
    // }

    // var grid = {};
    // var items = [];
    // var maxGroupItems = 1;
    // for (i = 0; i < indices.length; ++i) {
    //     index = indices[i] % nItems;
    //     var globalIndex = index + firstGlobalIndex;
    //     var seriesIndex = Math.floor(indices[i] / nItems);
    //     var mX = self._measurementsX[seriesIndex];
    //     var mY = self._measurementsY[seriesIndex];
    //     var cellX = data.getSeries(mX).getByGlobalIndex(globalIndex);
    //     var cellY = data.getSeries(mY).getByGlobalIndex(globalIndex);

    //     if (!cellX || !cellY) {
    //         continue;
    //     }

    //     var classes = sprintf('item data-series-%s', seriesIndex);

    //     var x = xScale(cellX.value);
    //     var y = yScale(cellY.value);
    //     var gridX = Math.floor(x / gridSquareSize) * gridSquareSize;
    //     var gridY = Math.floor(y / gridSquareSize) * gridSquareSize;

    //     var uiObj = null;
    //     if (grid[gridY] && grid[gridY][gridX]) {
    //         uiObj = grid[gridY][gridX];
    //         uiObj.id += '_' + cellX.globalIndex;
    //         uiObj.start = Math.min(uiObj.start, cellX.rowItem.start());
    //         uiObj.end = Math.max(uiObj.end, cellX.rowItem.end());
    //         uiObj.values[0] = (uiObj.values[0] * uiObj.valueItems[0].length + cellX.value) / (uiObj.valueItems[0].length + 1);
    //         uiObj.values[1] = (uiObj.values[1] * uiObj.valueItems[1].length + cellY.value) / (uiObj.valueItems[1].length + 1);
    //         uiObj.valueItems[0].push(cellX);
    //         uiObj.valueItems[1].push(cellY);

    //         if (uiObj.valueItems[0].length > maxGroupItems) {
    //             maxGroupItems = uiObj.valueItems[0].length;
    //         }

    //         continue;
    //     }


    //     uiObj = new epiviz.ui.charts.ChartObject(
    //         sprintf('scatter_%s_%s', seriesIndex, cellX.globalIndex),
    //         cellX.rowItem.start(),
    //         cellX.rowItem.end(), [cellX.value, cellY.value],
    //         seriesIndex, [
    //             [cellX],
    //             [cellY]
    //         ], // valueItems one for each measurement
    //         [mX, mY], // measurements
    //         classes);

    //     if (!grid[gridY]) { grid[gridY] = {}; }
    //     grid[gridY][gridX] = uiObj;

    //     items.push(uiObj);
    // }





    var grid = {};
    var items = [];
    var maxGroupItems = 1;
    var seriesIndex = 0; // Assume only 1 pair of datax and datay
    for (var i = 0; i < data.length; ++i) {

        //index = indices[i] % nItems;
        //var globalIndex = index + firstGlobalIndex;
        //var seriesIndex = Math.floor(indices[i] / nItems);
        //var mX = self._measurementsX[seriesIndex];
        //var mY = self._measurementsY[seriesIndex];
        //var cellX = data.getSeries(mX).getByGlobalIndex(globalIndex);
        //var cellY = data.getSeries(mY).getByGlobalIndex(globalIndex);
        var cellX = data[i][dimx];
        var cellY = data[i][dimy];
        if (!cellX || !cellY) {
            continue;
        }

        var classes = sprintf('item data-series-%s', seriesIndex);

        var x = xScale(cellX);
        var y = yScale(cellY);

        var gridX = Math.floor(x / gridSquareSize) * gridSquareSize;
        var gridY = Math.floor(y / gridSquareSize) * gridSquareSize;

        var uiObj = null;
        if (grid[gridY] && grid[gridY][gridX]) {
            uiObj = grid[gridY][gridX];
            uiObj.id += '_' + data[i][key];
            uiObj.values[0] = (uiObj.values[0] * uiObj.valueItems[0].length + cellX) / (uiObj.valueItems[0].length + 1);
            uiObj.values[1] = (uiObj.values[1] * uiObj.valueItems[1].length + cellY) / (uiObj.valueItems[1].length + 1);
            uiObj.valueItems[0].push(data[i]);
            uiObj.valueItems[1].push(data[i]);
            if (uiObj.valueItems[0].length > maxGroupItems) {
                maxGroupItems = uiObj.valueItems[0].length;
            }
            continue;
        }

        uiObj = new epiviz.ui.charts.ChartIndexObject(
            sprintf('scatter_%s_%s_%s_%s', cellX, cellY, seriesIndex, data[i][key]), [key],
            data[i][key], [cellX, cellY], [
                [data[i]],
                [data[i]]
            ], // valueItems one for each measurement
            [dimx, dimy], // measurements
            seriesIndex,
            classes);

        if (!grid[gridY]) { grid[gridY] = {}; }
        grid[gridY][gridX] = uiObj;

        items.push(uiObj);
    }

    var itemsGroup = this._chartContent.select('.items');

    if (itemsGroup.empty()) {
        itemsGroup = this._chartContent.append('g').attr('class', 'items');
        var selectedGroup = itemsGroup.append('g').attr('class', 'selected');
        itemsGroup.append('g').attr('class', 'hovered');
        selectedGroup.append('g').attr('class', 'hovered');
    }

    var selection = itemsGroup.selectAll('circle').data(items, function(d) {
        return d.id;
    });

    // selection
    //     .enter()
    //     .insert('circle', ':first-child')
    //     .attr('id', function(d) {
    //         return sprintf('%s-item-%s-%s', self.id(), d.seriesIndex, d.valueItems[0][0].globalIndex);
    //     })
    //     .style('opacity', 0)
    //     .style('fill-opacity', 0)
    //     .attr('r', 0);
    // selection
    //     .each(
    //         /**
    //          * @param {epiviz.ui.charts.ChartObject} d
    //          */
    //         function(d) {
    //             var circle = d3.select(this);

    //             var fill;
    //             if (!self._globalIndexColorLabels) { fill = self.colors().get(d.seriesIndex); } else {
    //                 fill = self.colors().getByKey(self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]);
    //             }
    //             circle
    //                 .attr('cx', margins.left() + (d.values[0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    //                 .attr('cy', height - margins.bottom() - ((d.values[1] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
    //                 .attr('class', d.cssClasses)
    //                 .style('fill', fill);
    //         });

    selection
        .enter()
        .insert('circle', ':first-child')
        .attr('id', function(d) {
            return sprintf('%s-item-%s', self.id(), d.seriesIndex);
        })
        .style('opacity', 0)
        .style('fill-opacity', 0)
        .attr('r', 0);
    selection
        .each(
            /**
             * @param {epiviz.ui.charts.ChartObject} d
             */
            function(d) {
                var circle = d3.select(this);

                //var fill = self.colors().get(d.seriesIndex);
                var fill = self.colors().getByKey(d.valueItems[0][0][colorbylabel]);
                if(self._globalIndexColorLabels != null && self._globalIndexColorLabels.indexOf(d.valueItems[0][0][colorbylabel]) == -1){
                    self._globalIndexColorLabels.push(d.valueItems[0][0][colorbylabel]);
                }
                // if (!self._globalIndexColorLabels) { fill = self.colors().get(d.seriesIndex); } else {
                //     fill = self.colors().getByKey(self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]);
                // }
                circle
                    .attr('cx', margins.left() + (d.values[0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
                    .attr('cy', height - margins.bottom() - ((d.values[1] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
                    .attr('class', d.cssClasses)
                    .style('fill', fill);
            });


    selection
        .transition()
        .duration(1000)
        .style('fill-opacity', function(d) {
            //return Math.max(0.3, d.valueItems[0].length / maxGroupItems);
            return Math.max(0.6, d.valueItems[0].length / maxGroupItems);
        })
        .style('opacity', null)
        .attr('r', circleRadius);

    selection
        .exit()
        .transition()
        .duration(1000)
        .style('opacity', 0)
        .attr('r', 0)
        .remove();

    selection
        //.on('mouseover', function(d) {
        //    console.log("mouseover");
        //    console.log(d);
        //    self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
        //    self._dispatch.hover(self.id(), d);
        //})
        //.on('mouseout', function() {
        //    self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
        //    self._dispatch.hover(self.id(), null);
        //
        //})
        .on('click', function(d) {
            console.log("click");
            self._deselect.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
            self._select.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
            // self._dispatch.click(self.id(), null);

            d3.event.stopPropagation();
        });

    // Draw legend if necessary
    if (this._globalIndexColorLabels) {
        var colorLabelsMap = {};
        for (j = firstGlobalIndex; j < lastGlobalIndex; ++j) {
            colorLabelsMap[this._globalIndexColorLabels[j]] = this._globalIndexColorLabels[j];
        }
        this._colorLabels = Object.keys(colorLabelsMap);

        this._svg.selectAll('.chart-title').remove();
        this._svg.selectAll('.chart-title-color ').remove();
        var titleEntries = this._svg
            .selectAll('.chart-title')
            .data(this._colorLabels);
        titleEntries
            .enter()
            .append('text')
            .attr('class', 'chart-title')
            .attr('font-weight', 'bold')
            .attr('y', self.margins().top() - 5);
        titleEntries
            .attr('fill', function(label, i) {
                return self.colors().getByKey(label);
            })
            .text(function(label) {
                return label;
            });
        var textLength = 0;
        var titleEntriesStartPosition = [];

        $('#' + this.id() + ' .chart-title')
            .each(function(i) {
                titleEntriesStartPosition.push(textLength);
                textLength += this.getBBox().width + 15;
            });

        titleEntries.attr('x', function(column, i) {
            return self.margins().left() + 10 + titleEntriesStartPosition[i];
        });

        var colorEntries = this._svg
            .selectAll('.chart-title-color')
            .data(this._colorLabels)
            .enter()
            .append('circle')
            .attr('class', 'chart-title-color')
            .attr('cx', function(column, i) {
                return self.margins().left() + 4 + titleEntriesStartPosition[i];
            })
            .attr('cy', self.margins().top() - 9)
            .attr('r', 4)
            .style('shape-rendering', 'auto')
            .style('stroke-width', '0')
            .attr('fill', function(label, i) {
                return self.colors().getByKey(label);
            })
            .style('stroke-width', 0)
    } else {
        var n = Math.min(this._measurementsX.length, this._measurementsY.length);
        var colors = new Array(n);

        for (j = 0; j < n; ++j) {
            colors[j] = sprintf('%s vs %s', this._measurementsX[j].name(), this._measurementsY[j].name());
        }

        this._colorLabels = colors;
    }
    this._colorLabels = [];
    //this._colorLabels = Object.keys(self.colors()._keyIndices);
    
    Object.keys(self.colors()._keyIndices).forEach(function(m) {if (!(m == "undefined" || m == "Max")) {self._colorLabels.push(m)};})
    //console.log(this._colorLabels);
    this._svg.selectAll('.chart-title').remove();
    this._svg.selectAll('.chart-title-color ').remove();
    var titleEntries = this._svg
      .selectAll('.chart-title')
      .data(this._colorLabels);
    titleEntries
      .enter()
      .append('text')
      .attr('class', 'chart-title')
      .attr('font-weight', 'bold')
      .attr('y', self.margins().top() - 5);
    titleEntries
      .attr('fill', function(label, i) {
        return self.colors().getByKey(label);
      })
      .text(function(label) { return label; });
    var textLength = 0;
    var titleEntriesStartPosition = [];

    $('#' + this.id() + ' .chart-title')
      .each(function(i) {
        titleEntriesStartPosition.push(textLength);
        textLength += this.getBBox().width + 15;
      });

    titleEntries.attr('x', function(column, i) {
      return self.margins().left() + 10 + titleEntriesStartPosition[i];
    });

    var colorEntries = this._svg
      .selectAll('.chart-title-color')
      .data(this._colorLabels)
      .enter()
      .append('circle')
      .attr('class', 'chart-title-color')
      .attr('cx', function(column, i) { return self.margins().left() + 4 + titleEntriesStartPosition[i]; })
      .attr('cy', self.margins().top() - 9)
      .attr('r', 4)
      .style('shape-rendering', 'auto')
      .style('stroke-width', '0')
      .attr('fill', function(label, i) {
        return self.colors().getByKey(label);
      })
      .style('stroke-width', 0)

    var title = '';


    return items;
};

/**
 * @returns {Array.<{name: string, color: string}>}
 */
epiviz.plugins.charts.CustomScatterPlot.prototype.colorLabels = function() {
    return this._colorLabels;
};

/**
 * @param xScale D3 linear scale for the x axis
 * @param yScale D3 linear scale for the y axis
 * @param {number} [xTicks]
 * @param {number} [yTicks]
 * @param [svg] D3 svg container for the axes
 * @param {number} [width]
 * @param {number} [height]
 * @param {epiviz.ui.charts.Margins} [margins]
 * @protected
 */
epiviz.plugins.charts.CustomScatterPlot.prototype._drawAxes = function(xScale, yScale, xTicks, yTicks, svg, width, height, margins) {
    epiviz.ui.charts.Plot.prototype._drawAxes.call(this, xScale, yScale, xTicks, yTicks, svg, width, height, margins);
    var self = this;
    this._legend.selectAll('text').remove();

    var xMeasurements = ['pca1'];
    var self = this;
    this._legend.selectAll('.x-measurement').remove();
    this._legend.selectAll('.x-measurement-color').remove();
    
    var xEntries = this._legend
        .selectAll('.x-measurement')
        .data(xMeasurements)
        .enter()
        .append('text')
        .attr('class', 'x-measurement')
        .attr('font-weight', 'bold')
        .attr('fill', function(m, i) {
            return self._globalIndexColorLabels ?
                "#000000" : self.colors().get(i);
        })
        .attr('y', (this.height() - this.margins().bottom() + 35))
        .text(function(m, i) {
            return m + " (% Variance Explained = " + self._variance_labels[0] + ")";
        });

    var xTextLength = 0;
    var xTitleEntriesStartPosition = [];

    $('#' + this.id() + ' .x-measurement')
        .each(function(i) {
            xTitleEntriesStartPosition.push(xTextLength);
            xTextLength += this.getBBox().width + 15;
        });

    xEntries.attr('x', function(column, i) {
        return (self.width() - xTextLength) * 0.5 + 7 + xTitleEntriesStartPosition[i];
    });

    var yMeasurements = ['pca2'];
    this._legend.selectAll('.y-measurement').remove();
    this._legend.selectAll('.y-measurement-color').remove();

    var yEntries = this._legend
        .selectAll('.y-measurement')
        .data(yMeasurements)
        .enter()
        .append('text')
        .attr('class', 'y-measurement')
        .attr('font-weight', 'bold')
        .attr('fill', function(m, i) {
            return self._globalIndexColorLabels ?
                "#000000" : self.colors().get(i);
        })
        .attr('y', (this.margins().left() - 35))
        .attr('transform', 'rotate(-90)')
        .text(function(m, i) {
            return m  + " (% Variance Explained = " + self._variance_labels[1] + ")";
        });

    var yTextLength = 0;
    var yTitleEntriesStartPosition = [];

    $('#' + this.id() + ' .y-measurement')
        .each(function(i) {
            yTitleEntriesStartPosition.push(yTextLength);
            yTextLength += this.getBBox().width + 15;
        });

    yEntries.attr('x', function(column, i) {
        return -self.height() + (self.height() - yTextLength) * 0.5 + 12 + self.margins().top() + yTitleEntriesStartPosition[i];
    });
};

epiviz.plugins.charts.CustomScatterPlot.prototype.transformData = function(range, data) {
  var lastRange = this._lastRange;

  if (range != undefined) {
    this._lastRange = range;
  }
  if (data != undefined) {
    this._lastData = data;
    this._unalteredData = data;
  }

  var deferred = new epiviz.deferred.Deferred();
  deferred.resolve();
  return deferred;
};

// goog.inherits(epiviz.plugins.charts.CustomScatterPlot, epiviz.ui.charts.Plot);

// Input 152
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/2/2015
 * Time: 4:43 PM
 */

goog.provide('epiviz.plugins.charts.StackedLinePlotType');

goog.require('epiviz.plugins.charts.StackedLinePlot');
goog.require('epiviz.ui.charts.PlotType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.Visualization');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.PlotType}
 * @constructor
 */
epiviz.plugins.charts.StackedLinePlotType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.PlotType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.StackedLinePlotType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.PlotType.prototype);
epiviz.plugins.charts.StackedLinePlotType.constructor = epiviz.plugins.charts.StackedLinePlotType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.StackedLinePlot}
 */
epiviz.plugins.charts.StackedLinePlotType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.StackedLinePlot(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.StackedLinePlotType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.StackedLinePlot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.StackedLinePlotType.prototype.chartName = function() {
  return 'Stacked Plot';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.StackedLinePlotType.prototype.chartHtmlAttributeName = function() {
  return 'stacked-line-plot';
};

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.StackedLinePlotType.prototype.measurementsFilter = function() { return function(m) { return m.type() == epiviz.measurements.Measurement.Type.FEATURE; }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.plugins.charts.StackedLinePlotType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.StackedLinePlotType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.PlotType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.COL_LABEL,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_METADATA,
      'colLabel',
      'Color by'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_ANNOTATION,
      'name',
      'Labels'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLinePlotType.CustomSettings.OFFSET,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'zero',
      'Offset',
      ['zero', 'wiggle']),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLinePlotType.CustomSettings.INTERPOLATION,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      'step-after',
      'Interpolation',
      ['linear', 'step-before', 'step-after', 'basis', 'basis-open', 'basis-closed', 'bundle', 'cardinal', 'cardinal-open', 'monotone']),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLinePlotType.CustomSettings.SCALE_TO_PERCENT,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      true,
      'Scale to Percent'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLinePlotType.CustomSettings.USE_GROUP_BY,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      false,
      'Use Group by'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLinePlotType.CustomSettings.ROW_GROUP_BY,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_ANNOTATION,
      'name',
      'Group By'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.StackedLinePlotType.CustomSettings.HOVER_OPACITY,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      0.6,
      'Hover Opacity')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.StackedLinePlotType.CustomSettings = {
  INTERPOLATION: 'interpolation',
  OFFSET: 'offset',
  SCALE_TO_PERCENT: 'scaleToPercent',
  ROW_GROUP_BY: 'groupBy',
  USE_GROUP_BY: 'useGroupBy',
  HOVER_OPACITY: 'hoverOpacity'
};

// goog.inherits(epiviz.plugins.charts.StackedLinePlotType, epiviz.ui.charts.PlotType);

// Input 153
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 11:55 PM
 */

goog.provide('epiviz.plugins.charts.ScatterPlot');

goog.require('epiviz.ui.charts.Plot');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.measurements.Measurement');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Plot}
 * @constructor
 */
epiviz.plugins.charts.ScatterPlot = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Plot.call(this, id, container, properties);

  /**
   * D3 chart container
   * @type {*}
   * @private
   */
  this._chartContent = null;

  /**
   * D3 legend container
   * @type {*}
   * @private
   */
  this._legend = null;

  /**
   * @type {Array.<epiviz.measurements.Measurement>}
   * @private
   */
  this._measurementsX = [];

  /**
   * @type {Array.<epiviz.measurements.Measurement>}
   * @private
   */
  this._measurementsY = [];

  var self = this;
  this.measurements().foreach(function(m, i) {
    if (i % 2 == 0) { self._measurementsX.push(m); }
    else { self._measurementsY.push(m); }
  });

  /**
   * @type {string}
   * @private
   */
  this._xLabel = '';

  /**
   * @type {string}
   * @private
   */
  this._yLabel = '';

  for (var i = 0; i < Math.min(this._measurementsX.length, this._measurementsY.length); ++i) {
    if (i > 0) {
      this._xLabel += ', ';
      this._yLabel += ', ';
    }
    this._xLabel += this._measurementsX[i].name();
    this._yLabel += this._measurementsY[i].name();
  }

  /**
   * @type {Array.<string>}
   * @private
   */
  this._colorLabels = [];

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.ScatterPlot.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Plot.prototype);
epiviz.plugins.charts.ScatterPlot.constructor = epiviz.plugins.charts.ScatterPlot;

/**
 * @protected
 */
epiviz.plugins.charts.ScatterPlot.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Plot.prototype._initialize.call(this);

  this._svg.classed('scatter-plot', true);

  this._chartContent = this._svg.append('g').attr('class', 'chart-content');
  this._legend = this._svg.append('g').attr('class', 'chart-legend');
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.ScatterPlot.prototype.draw = function(range, data) {

  epiviz.ui.charts.Plot.prototype.draw.call(this, range, data);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  return this._drawCircles(range, data);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.ScatterPlot.prototype._drawCircles = function(range, data) {
  var self = this;
  var Axis = epiviz.ui.charts.Axis;
  var circleRadius = Math.max(1,this.customSettingsValues()[epiviz.plugins.charts.ScatterPlotType.CustomSettings.CIRCLE_RADIUS_RATIO] * Math.min(this.width(), this.height()));
  var gridSquareSize = Math.max(Math.floor(circleRadius), 1);
  var nSeries = Math.min(this._measurementsX.length, this._measurementsY.length);

  var absLine = this.customSettingsValues()[epiviz.plugins.charts.ScatterPlotType.CustomSettings.ABS_LINE_VAL];

  var firstGlobalIndex = data.firstSeries().globalStartIndex();
  var lastGlobalIndex = data.firstSeries().globalEndIndex();
  data.foreach(function(measurement, series) {

    var firstIndex = series.globalStartIndex();
    var lastIndex = series.globalEndIndex();

    if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
  });

  var nItems = lastGlobalIndex - firstGlobalIndex;

  var margins = this.margins();
  var width = this.width();
  var height = this.height();

  var CustomSetting = epiviz.ui.charts.CustomSetting;
  var minY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MIN];
  var maxY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MAX];
  var minX = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.X_MIN];
  var maxX = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.X_MAX];

  if (minX == CustomSetting.DEFAULT) { minX = this._measurementsX[0].minValue(); }
  if (minY == CustomSetting.DEFAULT) { minY = this._measurementsY[0].minValue(); }
  if (maxX == CustomSetting.DEFAULT) { maxX = this._measurementsX[0].maxValue(); }
  if (maxY == CustomSetting.DEFAULT) { maxY = this._measurementsY[0].maxValue(); }

  var dataHasGenomicLocation = epiviz.measurements.Measurement.Type.isOrdered(this._measurementsX[0].type());

  var xScale = d3.scale.linear()
    .domain([minX, maxX])
    .range([0, width - margins.sumAxis(Axis.X)]);
  var yScale = d3.scale.linear()
    .domain([minY, maxY])
    .range([height - margins.sumAxis(Axis.Y), 0]);

  this._clearAxes(this._chartContent);
  this._drawAxes(xScale, yScale, 15, 15, this._chartContent);

  var i, index;
  var indices = []; //epiviz.utils.range(nSeries * nItems);
  for (i = 0; i < nItems; ++i) {
    index = i + firstGlobalIndex;
    var item = data.getSeries(this._measurementsX[0]).getRowByGlobalIndex(index);
    if (!item) { continue; }
    if (!dataHasGenomicLocation ||
      (range.start() == undefined || range.end() == undefined) ||
      (item.start() < range.end() && item.end() > range.start())) {

      for (var j = 0; j < nSeries; ++j) {
        indices.push(j * nItems + i);
      }
    }
  }

  var grid = {};
  var items = [];
  var maxGroupItems = 1;
  for (i = 0; i < indices.length; ++i) {
    index = indices[i] % nItems;
    var globalIndex = index + firstGlobalIndex;
    var seriesIndex = Math.floor(indices[i] / nItems);
    var mX = self._measurementsX[seriesIndex];
    var mY = self._measurementsY[seriesIndex];
    var cellX = data.getSeries(mX).getByGlobalIndex(globalIndex);
    var cellY = data.getSeries(mY).getByGlobalIndex(globalIndex);

    if (!cellX || !cellY) { continue; }

    var classes = sprintf('item data-series-%s', seriesIndex);

    var x = xScale(cellX.value);
    var y = yScale(cellY.value);
    var gridX = Math.floor(x / gridSquareSize) * gridSquareSize;
    var gridY = Math.floor(y / gridSquareSize) * gridSquareSize;

    var uiObj = null;
    if (grid[gridY] && grid[gridY][gridX]) {
      uiObj = grid[gridY][gridX];
      uiObj.id += '_' + cellX.globalIndex;
      uiObj.start = Math.min(uiObj.start, cellX.rowItem.start());
      uiObj.end = Math.max(uiObj.end, cellX.rowItem.end());
      uiObj.values[0] = (uiObj.values[0] * uiObj.valueItems[0].length + cellX.value) / (uiObj.valueItems[0].length + 1);
      uiObj.values[1] = (uiObj.values[1] * uiObj.valueItems[1].length + cellY.value) / (uiObj.valueItems[1].length + 1);
      uiObj.valueItems[0].push(cellX);
      uiObj.valueItems[1].push(cellY);

      if (uiObj.valueItems[0].length > maxGroupItems) {
        maxGroupItems = uiObj.valueItems[0].length;
      }

      continue;
    }

    uiObj = new epiviz.ui.charts.ChartObject(
      sprintf('scatter_%s_%s', seriesIndex, cellX.globalIndex),
      cellX.rowItem.start(),
      cellX.rowItem.end(),
      [cellX.value, cellY.value],
      seriesIndex,
      [[cellX], [cellY]], // valueItems one for each measurement
      [mX, mY], // measurements
      classes);

    if (!grid[gridY]) { grid[gridY] = {}; }
    grid[gridY][gridX] = uiObj;

    items.push(uiObj);
  }

  var itemsGroup = this._chartContent.select('.items');

  if (itemsGroup.empty()) {
    itemsGroup = this._chartContent.append('g').attr('class', 'items');
    var selectedGroup = itemsGroup.append('g').attr('class', 'selected');
    itemsGroup.append('g').attr('class', 'hovered');
    selectedGroup.append('g').attr('class', 'hovered');
  }

  var selection = itemsGroup.selectAll('circle').data(items, function(d) { return d.id; });

  selection
    .enter()
    .insert('circle', ':first-child')
    .attr('id', function (d) {
      return sprintf('%s-item-%s-%s', self.id(), d.seriesIndex, d.valueItems[0][0].globalIndex);
    })
    .style('opacity', 0)
    .style('fill-opacity', 0)
    .attr('r', 0);
  selection
    .each(
      /**
       * @param {epiviz.ui.charts.ChartObject} d
       */
      function(d) {
        var circle = d3.select(this);

        var fill;
        if (!self._globalIndexColorLabels) { fill = self.colors().get(d.seriesIndex); }
        else {
          fill = self.colors().getByKey(self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]);
        }
        circle
          .attr('cx', margins.left() + (d.values[0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
          .attr('cy', height - margins.bottom() - ((d.values[1] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
          .attr('class', d.cssClasses)
          .style('fill', fill);
      });

  selection
    .transition()
    .duration(1000)
    .style('fill-opacity', function(d) {
      //return Math.max(0.3, d.valueItems[0].length / maxGroupItems);
      return Math.max(0.6, d.valueItems[0].length / maxGroupItems);
    })
    .style('opacity', null)
    .attr('r', circleRadius);

  selection
    .exit()
    .transition()
    .duration(1000)
    .style('opacity', 0)
    .attr('r', 0)
    .remove();

  selection
    .on('mouseover', function (d) {
      self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
    })
    .on('mouseout', function () {
      self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
    })
    .on('click', function (d) {
      self._deselect.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
      self._select.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));

      d3.event.stopPropagation();
    });

  // Draw legend if necessary
  if (this._globalIndexColorLabels) {
    var colorLabelsMap = {};
    for (j = firstGlobalIndex; j < lastGlobalIndex; ++j) {
      colorLabelsMap[this._globalIndexColorLabels[j]] = this._globalIndexColorLabels[j];
    }
    this._colorLabels = Object.keys(colorLabelsMap);

    this._svg.selectAll('.chart-title').remove();
    this._svg.selectAll('.chart-title-color ').remove();
    var titleEntries = this._svg
      .selectAll('.chart-title')
      .data(this._colorLabels);
    titleEntries
      .enter()
      .append('text')
      .attr('class', 'chart-title')
      .attr('font-weight', 'bold')
      .attr('y', self.margins().top() - 5);
    titleEntries
      .attr('fill', function(label, i) {
        return self.colors().getByKey(label);
      })
      .text(function(label) { return label; });
    var textLength = 0;
    var titleEntriesStartPosition = [];

    $('#' + this.id() + ' .chart-title')
      .each(function(i) {
        titleEntriesStartPosition.push(textLength);
        textLength += this.getBBox().width + 15;
      });

    titleEntries.attr('x', function(column, i) {
      return self.margins().left() + 10 + titleEntriesStartPosition[i];
    });

    var colorEntries = this._svg
      .selectAll('.chart-title-color')
      .data(this._colorLabels)
      .enter()
      .append('circle')
      .attr('class', 'chart-title-color')
      .attr('cx', function(column, i) { return self.margins().left() + 4 + titleEntriesStartPosition[i]; })
      .attr('cy', self.margins().top() - 9)
      .attr('r', 4)
      .style('shape-rendering', 'auto')
      .style('stroke-width', '0')
      .attr('fill', function(label, i) {
        return self.colors().getByKey(label);
      })
      .style('stroke-width', 0)
  } else {
    var n = Math.min(this._measurementsX.length, this._measurementsY.length);
    var colors = new Array(n);

    for (j = 0; j < n; ++j) {
      colors[j] = sprintf('%s vs %s', this._measurementsX[j].name(), this._measurementsY[j].name());
    }

    this._colorLabels = colors;
  }

  // Draw abline
  if(absLine != epiviz.ui.charts.CustomSetting.DEFAULT) {

    itemsGroup.selectAll(".abLine").remove();

    itemsGroup.append("svg:line")
          .attr("class", "abLine")
          .attr("x1", margins.left() + (minX - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
          .attr("x2", margins.left() + (maxX - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
          .attr("y1", height - margins.bottom() - ((absLine - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
          .attr("y2", height - margins.bottom() - ((absLine - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
          .style("stroke", "black")
          .style("stroke-dasharray", ("5, 5")) ;
  }

  return items;
};

/**
 * @returns {Array.<{name: string, color: string}>}
 */
epiviz.plugins.charts.ScatterPlot.prototype.colorLabels = function() {
  return this._colorLabels;
};

/**
 * @param xScale D3 linear scale for the x axis
 * @param yScale D3 linear scale for the y axis
 * @param {number} [xTicks]
 * @param {number} [yTicks]
 * @param [svg] D3 svg container for the axes
 * @param {number} [width]
 * @param {number} [height]
 * @param {epiviz.ui.charts.Margins} [margins]
 * @protected
 */
epiviz.plugins.charts.ScatterPlot.prototype._drawAxes = function(xScale, yScale, xTicks, yTicks, svg, width, height, margins) {
  epiviz.ui.charts.Plot.prototype._drawAxes.call(this, xScale, yScale, xTicks, yTicks, svg, width, height, margins);

  this._legend.selectAll('text').remove();

  var xMeasurements = this._measurementsX;
  var self = this;
  this._legend.selectAll('.x-measurement').remove();
  this._legend.selectAll('.x-measurement-color').remove();

  var xEntries = this._legend
    .selectAll('.x-measurement')
    .data(xMeasurements)
    .enter()
    .append('text')
    .attr('class', 'x-measurement')
    .attr('font-weight', 'bold')
    .attr('fill', function(m, i) {
      return self._globalIndexColorLabels ?
        "#000000" : self.colors().get(i);
    })
    .attr('y', (this.height() - this.margins().bottom() + 35))
    .text(function(m, i) { return m.name(); });

  var xTextLength = 0;
  var xTitleEntriesStartPosition = [];

  $('#' + this.id() + ' .x-measurement')
    .each(function(i) {
      xTitleEntriesStartPosition.push(xTextLength);
      xTextLength += this.getBBox().width + 15;
    });

  xEntries.attr('x', function(column, i) {
    return (self.width() - xTextLength) * 0.5 + 7 + xTitleEntriesStartPosition[i];
  });

  var xColorEntries = this._legend
    .selectAll('.x-measurement-color')
    .data(xMeasurements)
    .enter()
    .append('circle')
    .attr('class', 'x-measurement-color')
    .attr('cx', function(column, i) { return (self.width() - xTextLength) * 0.5 + 1 + xTitleEntriesStartPosition[i]; })
    .attr('cy', (this.height() - this.margins().bottom() + 31))
    .attr('r', 4)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .style('fill', function(m, i) {
      return self._globalIndexColorLabels ?
        "#ffffff" : self.colors().get(i);
    });


  var yMeasurements = this._measurementsY;
  this._legend.selectAll('.y-measurement').remove();
  this._legend.selectAll('.y-measurement-color').remove();

  var yEntries = this._legend
    .selectAll('.y-measurement')
    .data(yMeasurements)
    .enter()
    .append('text')
    .attr('class', 'y-measurement')
    .attr('font-weight', 'bold')
    .attr('fill', function(m, i) {
      return self._globalIndexColorLabels ?
        "#000000" : self.colors().get(i);
    })
    .attr('y', (this.margins().left() - 35))
    .attr('transform', 'rotate(-90)')
    .text(function(m, i) { return m.name(); });

  var yTextLength = 0;
  var yTitleEntriesStartPosition = [];

  $('#' + this.id() + ' .y-measurement')
    .each(function(i) {
      yTitleEntriesStartPosition.push(yTextLength);
      yTextLength += this.getBBox().width + 15;
    });

  yEntries.attr('x', function(column, i) {
    return - self.height() + (self.height() - yTextLength) * 0.5 + 12 + self.margins().top() + yTitleEntriesStartPosition[i];
  });

  var yColorEntries = this._legend
    .selectAll('.y-measurement-color')
    .data(yMeasurements)
    .enter()
    .append('circle')
    .attr('class', 'y-measurement-color')
    .attr('cx', function(column, i) { return - self.height() + (self.height() - yTextLength) * 0.5 + 6 + self.margins().top() + yTitleEntriesStartPosition[i]; })
    .attr('cy', (this.margins().left() - 39))
    .attr('transform', 'rotate(-90)')
    .attr('r', 4)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .style('fill', function(m, i) {
      return self._globalIndexColorLabels ?
        "#ffffff" : self.colors().get(i);
    });
};

// goog.inherits(epiviz.plugins.charts.ScatterPlot, epiviz.ui.charts.Plot);

// Input 154
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/8/2014
 * Time: 1:32 PM
 */


goog.provide('epiviz.plugins.charts.StackedLineTrack');

goog.require('epiviz.ui.charts.Track');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.datatypes.GenomicRange');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Track}
 * @constructor
 */
epiviz.plugins.charts.StackedLineTrack = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Track.call(this, id, container, properties);

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.StackedLineTrack.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Track.prototype);
epiviz.plugins.charts.StackedLineTrack.constructor = epiviz.plugins.charts.StackedLineTrack;

/**
 * @protected
 */
epiviz.plugins.charts.StackedLineTrack.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Track.prototype._initialize.call(this);
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.StackedLineTrack.prototype.draw = function(range, data, slide, zoom) {
  epiviz.ui.charts.Track.prototype.draw.call(this, range, data, slide, zoom);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;
  slide = slide || this._slide;
  zoom = zoom || this._zoom;
  this._slide = 0;
  this._zoom = 1;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  var Axis = epiviz.ui.charts.Axis;
  slide = slide || 0;
  var delta = slide * (this.width() - this.margins().sumAxis(Axis.X)) / range.width();
  return this._drawLines(range, data, delta, zoom || 1);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {number} delta
 * @param {number} zoom
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.StackedLineTrack.prototype._drawLines = function(range, data, delta, zoom) {
  var Axis = epiviz.ui.charts.Axis;

  /** @type {epiviz.ui.charts.ColorPalette} */
  var colors = this.colors();

  /** @type {number} */
  var step = this.customSettingsValues()[epiviz.plugins.charts.StackedLineTrackType.CustomSettings.STEP];

  /** @type {string} */
  var interpolation = this.customSettingsValues()[epiviz.plugins.charts.StackedLineTrackType.CustomSettings.INTERPOLATION];

  /** @type {string} */
  var offset = this.customSettingsValues()[epiviz.plugins.charts.StackedLineTrackType.CustomSettings.OFFSET];

  var self = this;

  var invXScale = d3.scale.linear()
    .domain([0, this.width() - this.margins().sumAxis(Axis.X)])
    .range([range.start(), range.end()]);
  var deltaInBp = invXScale(delta) - range.start();

  // TODO: Re-introduce extendedRange (this is what we need to draw to make the track look continuous on navigation transition)
  var extendedRange = epiviz.datatypes.GenomicRange.fromStartEnd(
    range.seqName(),
    Math.min(range.start(), range.start() + deltaInBp),
    Math.max(range.end(), range.end() + deltaInBp));

  /** @type {Array.<epiviz.ui.charts.ChartObject>} */
  var items = [];

  var seriesAreas = [];

  var firstGlobalIndex = data.firstSeries().globalStartIndex();
  var lastGlobalIndex = data.firstSeries().globalEndIndex();

  data.foreach(function(measurement, series) {
    var firstIndex = series.globalStartIndex();
    var lastIndex = series.globalEndIndex();

    if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
  });

  firstGlobalIndex = Math.ceil(firstGlobalIndex / step) * step;
  lastGlobalIndex = Math.floor(lastGlobalIndex / step) * step;

  // TODO: Continue getting the labels on the x axis
  /** @type {Array.<string>} */
  var labels;

  data.foreach(function(m, series, i) {
    var indices = epiviz.utils.range((lastGlobalIndex - firstGlobalIndex) / step)
      .map(function(i) { return i * step + firstGlobalIndex; })
      .filter(function(globalIndex) {
        return series.getByGlobalIndex(globalIndex);
      });

    for (var k = 0; k < indices.length; ++k) {
      var cell = series.getByGlobalIndex(indices[k]);
      items.push(new epiviz.ui.charts.ChartObject(sprintf('line_%s_%s', i, cell.globalIndex), cell.rowItem.start(), cell.rowItem.end(), [cell.value], i, [[cell]], [m], sprintf('item data-series-%s', i)));
    }

    var x = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.getByGlobalIndex(j);
      return cell.rowItem.start();
    };

    var y = function(j) {
      /** @type {epiviz.datatypes.GenomicData.ValueItem} */
      var cell = series.getByGlobalIndex(j);
      return cell.value;
    };

    var areas = [];
    indices.forEach(function(j) { areas.push({x: x(j), y: y(j)}); });
    seriesAreas.push(areas);
    if (!labels) {
      labels = [];
      indices.forEach(function(j) {
        /** @type {epiviz.datatypes.GenomicData.ValueItem} */
        var cell = series.getByGlobalIndex(j);
        labels.push(cell.rowItem.metadata('bacteria')); // TODO: Change to something more generic
      });
    }
  });

  var xScale = d3.scale.linear()
    .domain([range.start(), range.end()])
    .range([0, this.width() - this.margins().sumAxis(Axis.X)]);

  this._clearAxes();

  this._drawAxes(xScale, undefined, 10);
  // TODO: Add option for labels on tracks
  /* this._drawAxes(
    xScale, undefined, // scales
    labels.length, undefined, // ticks
    undefined, undefined, undefined, undefined, undefined, undefined, labels, undefined);*/

  var graph = this._svg.select('.lines');
  if (graph.empty()) {
    graph = this._svg.append('g')
      .attr('class', 'lines')
      .attr('transform', 'translate(' + this.margins().left() + ', ' + this.margins().top() + ')');
  }

  var stack = d3.layout.stack().offset(offset);
  var layers = stack(seriesAreas);

  var yScale = d3.scale.linear()
    .domain([
      Math.min(0, d3.min(layers, function(layer) { return d3.min(layer, function(d) { return d.y0 + d.y; }); })),
      d3.max(layers, function(layer) { return d3.max(layer, function(d) { return d.y0 + d.y; }); })])
    .range([this.height() - this.margins().sumAxis(Axis.Y), 0]);

  var area = d3.svg.area()
    .x(function(d) { return xScale(d.x); })
    .y0(function(d) { return yScale(d.y0); })
    .y1(function(d) { return yScale(d.y0 + d.y); })
    .interpolate(interpolation);

  var lines = graph
    .selectAll('path')
    .data(layers);

  lines.enter()
    .append('path')
    .attr('d', area)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .style('fill', function(d, i) { return colors.get(i); })
    .on('mouseover', function() { self._captureMouseHover(); })
    .on('mousemove', function() { self._captureMouseHover(); })
    .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });

  lines
    .attr('d', area)
    .style('fill', function(d, i) { return colors.get(i); })
    .attr('transform', 'translate(' + (+delta) + ')')
    .transition()
    .duration(500)
    .attr('transform', 'translate(' + (0) + ')');

  // show baseline
  if(absLine != epiviz.ui.charts.CustomSetting.DEFAULT) {

    graph.selectAll('.abLine').remove();

    graph.append("svg:line")
          .attr("class", "abLine")
          .attr("x1", 0)
          .attr("x2", self.width() - self.margins().sumAxis(epiviz.ui.charts.Axis.X))
          .attr("y1", yScale(absLine))
          .attr("y2", yScale(absLine))
          .style("stroke", "black")
          .style("stroke-dasharray", ("5, 5")) ;
  }



  return items;
};

// goog.inherits(epiviz.plugins.charts.StackedLineTrack, epiviz.plugins.charts.Track);
// Input 155
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/9/2014
 * Time: 1:09 AM
 */

goog.provide('epiviz.plugins.charts.LinePlot');

goog.require('epiviz.ui.charts.Plot');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.utils');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.measurements.Measurement');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Plot}
 * @constructor
 */
epiviz.plugins.charts.LinePlot = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Plot.call(this, id, container, properties);

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.LinePlot.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Plot.prototype);
epiviz.plugins.charts.LinePlot.constructor = epiviz.plugins.charts.LinePlot;

/**
 * @protected
 */
epiviz.plugins.charts.LinePlot.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Plot.prototype._initialize.call(this);

  this._svg.classed('line-plot', true);
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.plugins.charts.LinePlot.prototype.draw = function(range, data, slide, zoom) {
  epiviz.ui.charts.Plot.prototype.draw.call(this, range, data, slide, zoom);

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  data = this._lastData;
  range = this._lastRange;

  // If data is not defined, there is nothing to draw
  if (!data || !range) { return []; }

  var CustomSetting = epiviz.ui.charts.CustomSetting;
  var minY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MIN];
  var maxY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MAX];

  var rowLabel = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL];

  if (minY == CustomSetting.DEFAULT) {
    minY = null;
    data.measurements().forEach(function(m) {
      if (m === null) { return; }
      if (minY === null || m.minValue() < minY) { minY = m.minValue(); }
    });
  }

  if (maxY == CustomSetting.DEFAULT) {
    maxY = null;
    data.measurements().forEach(function(m) {
      if (m === null) { return; }
      if (maxY === null || m.maxValue() > maxY) { maxY = m.maxValue(); }
    });
  }

  if (minY === null && maxY === null) { minY = -1; maxY = 1; }
  if (minY === null) { minY = maxY - 1; }
  if (maxY === null) { maxY = minY + 1; }

  var Axis = epiviz.ui.charts.Axis;
  var xScale = d3.scale.linear()
    .domain([0, data.measurements().length - 1])
    .range([0, this.width() - this.margins().sumAxis(Axis.X)]);
  var yScale = d3.scale.linear()
    .domain([minY, maxY])
    .range([this.height() - this.margins().sumAxis(Axis.Y), 0]);

  this._clearAxes();
  this._drawAxes(xScale, yScale, data.measurements().length, 5,
    undefined, undefined, undefined, undefined, undefined, undefined,
    data.measurements().map(function(m) {
      if (rowLabel == 'name') { return m.name(); }
      var anno = m.annotation();
      if (!anno || !(rowLabel in anno)) { return '<NA>'; }
      return anno[rowLabel];
    }));

  var linesGroup = this._svg.selectAll('.lines');

  if (linesGroup.empty()) {
    linesGroup = this._svg.append('g')
      .attr('class', 'lines items');

    var selectedGroup = linesGroup.append('g').attr('class', 'selected');
    linesGroup.append('g').attr('class', 'hovered');
    selectedGroup.append('g').attr('class', 'hovered');
  }
  linesGroup.attr('transform', 'translate(' + this.margins().left() + ', ' + this.margins().top() + ')');
  return this._drawLines(range, data, xScale, yScale);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {function} xScale D3 linear scale
 * @param {function} yScale D3 linear scale
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.LinePlot.prototype._drawLines = function(range, data, xScale, yScale) {
  /** @type {epiviz.ui.charts.ColorPalette} */
  var colors = this.colors();

  /** @type {boolean} */
  var showPoints = this.customSettingsValues()[epiviz.plugins.charts.LinePlotType.CustomSettings.SHOW_POINTS];

  /** @type {boolean} */
  var showLines = this.customSettingsValues()[epiviz.plugins.charts.LinePlotType.CustomSettings.SHOW_LINES];

  /** @type {boolean} */
  var showErrorBars = this.customSettingsValues()[epiviz.plugins.charts.LinePlotType.CustomSettings.SHOW_ERROR_BARS];

  /** @type {number} */
  var pointRadius = this.customSettingsValues()[epiviz.plugins.charts.LinePlotType.CustomSettings.POINT_RADIUS];

  /** @type {number} */
  var lineThickness = this.customSettingsValues()[epiviz.plugins.charts.LinePlotType.CustomSettings.LINE_THICKNESS];

  var interpolation = this.customSettingsValues()[epiviz.plugins.charts.LinePlotType.CustomSettings.INTERPOLATION];

  var colLabel = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.COL_LABEL];

  var absLine = this.customSettingsValues()[epiviz.plugins.charts.LinePlotType.CustomSettings.ABS_LINE_VAL];

  var self = this;

  var graph = this._svg.select('.lines');

  var firstGlobalIndex = data.firstSeries().globalStartIndex();
  var lastGlobalIndex = data.firstSeries().globalEndIndex();

  data.foreach(function(measurement, series) {
    var firstIndex = series.globalStartIndex();
    var lastIndex = series.globalEndIndex();

    if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
  });

  var nEntries = lastGlobalIndex - firstGlobalIndex;

  // TODO: This might not be needed anymore
  // TODO: Search for all usages of this method
  var dataHasGenomicLocation = epiviz.measurements.Measurement.Type.isOrdered(data.measurements()[0].type());
  var firstIndex, lastIndex;
  for (var i = 0; i < nEntries; ++i) {
    var globalIndex = i + firstGlobalIndex;
    var item = data.firstSeries().getRowByGlobalIndex(globalIndex);
    if (!dataHasGenomicLocation ||
      (range.start() == undefined || range.end() == undefined) ||
      item.start() < range.end() && item.end() >= range.start()) {
      if (firstIndex == undefined) { firstIndex = globalIndex; }
      lastIndex = globalIndex + 1;
    }
  }

  firstGlobalIndex = firstIndex;
  lastGlobalIndex = lastIndex;
  nEntries = lastIndex - firstIndex;

  var width = this.width();

  var lineFunc = d3.svg.line()
    .x(function(d) {
      return xScale(d.x);
    })
    .y(function(d) {
      return yScale(d.y);
    })
    .interpolate(interpolation);

  /**
   * @param {epiviz.datatypes.GenomicData.RowItem} row
   * @returns {string|number}
   */
  var colorBy = function(row) {
    return self._globalIndexColorLabels ? self._globalIndexColorLabels[row.globalIndex()] : row.metadata(colLabel);
  };


  var valuesForIndex = function(index) {
    return data.measurements()
      .map(function(m, i) {
        var item = data.getByGlobalIndex(m, index);
        return {
          x: i,
          y: item ? item.value : null,
          errMinus: (item && item.valueAnnotation) ? item.valueAnnotation['errMinus'] : null,
          errPlus: (item && item.valueAnnotation) ? item.valueAnnotation['errPlus'] : null
        };
      })
      .filter(function(o) {
        return o.y !== null;
      });
  };

  var indices = epiviz.utils.range(nEntries, firstGlobalIndex);

  var lineItems;
  if (!showLines) {
    graph.selectAll('.line-series').remove();
  } else {
    lineItems = indices.map(function(index) {
      var rowItem = data.firstSeries().getRowByGlobalIndex(index);
      return new epiviz.ui.charts.ChartObject(
        sprintf('line-series-%s', index),
        rowItem.start(),
        rowItem.end(),
        valuesForIndex(index),
        index,
        data.measurements().map(function(m, i) { return [data.getByGlobalIndex(m, index)]; }), // valueItems one for each measurement
        data.measurements(), // measurements
        '');
    });
    var lines = graph.selectAll('.line-series')
      .data(lineItems, function(d) { return d.id; });

    lines
      .enter()
      .insert('g', ':first-child').attr('class', 'line-series item')
      .style('opacity', '0')
      .on('mouseover', function(d) {
        self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
      })
      .on('mouseout', function () {
        self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
      })
      .each(function(d) {
        d3.select(this)
          .append('path').attr('class', 'bg-line')
          .attr('d', lineFunc(d.values))
          .style('shape-rendering', 'auto')
          .style('stroke-width', 10)
          .style('stroke', '#dddddd')
          .style('stroke-opacity', '0.1');
        d3.select(this)
          .append('path').attr('class', 'main-line')
          .attr('d', lineFunc(d.values))
          .style('shape-rendering', 'auto');
      });

    lines
      .transition()
      .duration(500)
      .style('opacity', '0.7')
      .each(function(d) {
        var color = colors.getByKey(colorBy(data.firstSeries().getRowByGlobalIndex(d.seriesIndex)));
        d3.select(this)
          .selectAll('.bg-line')
          .attr('d', lineFunc(d.values));
        d3.select(this).selectAll('.main-line')
          .attr('d', lineFunc(d.values))
          .style('stroke', color)
          .style('stroke-width', lineThickness);
      });

    lines
      .exit()
      .transition()
      .duration(500)
      .style('opacity', '0')
      .remove();
  }

  if (!showPoints) {
    graph.selectAll('.points').remove();
  } else {
    var points = graph.selectAll('.points')
      .data(lineItems, function(d) { return d.id; });

    points
      .enter()
      .append('g').attr('class', 'points')
      .style('opacity', '0');

    points
      .each(function(d) {
        d3.select(this).selectAll('.data-point').remove();
        var selection = d3.select(this).selectAll('.data-point').data(d.values);
        selection.enter().append('g').attr('class', 'data-point')
          .each(function(dataPoint) {
            d3.select(this).append('circle')
              .attr('cx', function(d) { return xScale(d.x); })
              .attr('cy', function(d) { return yScale(d.y); })
              .attr('r', pointRadius)
              .style('stroke-width', 2)
              .attr('fill', 'none')
              .attr('stroke', colors.getByKey(colorBy(data.firstSeries().getRowByGlobalIndex(d.seriesIndex))));
            d3.select(this).selectAll('.error-bar').remove();
            if (showErrorBars && dataPoint.errMinus != undefined && dataPoint.errPlus != undefined) {
              d3.select(this)
                .append('line').attr('x1', xScale(dataPoint.x)).attr('x2', xScale(dataPoint.x)).attr('y1', yScale(dataPoint.errMinus)).attr('y2', yScale(dataPoint.errPlus))
                .style('stroke', colors.getByKey(colorBy(data.firstSeries().getRowByGlobalIndex(d.seriesIndex))))
                .style('stroke-width', 2)
                .attr('class', 'error-bar');

              d3.select(this)
                .append('line').attr('x1', xScale(dataPoint.x) - 4).attr('x2', xScale(dataPoint.x) + 4).attr('y1', yScale(dataPoint.errMinus)).attr('y2', yScale(dataPoint.errMinus))
                .style('stroke', colors.getByKey(colorBy(data.firstSeries().getRowByGlobalIndex(d.seriesIndex))))
                .style('stroke-width', 2)
                .attr('class', 'error-bar');

              d3.select(this)
                .append('line').attr('x1', xScale(dataPoint.x) - 4).attr('x2', xScale(dataPoint.x) + 4).attr('y1', yScale(dataPoint.errPlus)).attr('y2', yScale(dataPoint.errPlus))
                .style('stroke', colors.getByKey(colorBy(data.firstSeries().getRowByGlobalIndex(d.seriesIndex))))
                .style('stroke-width', 2)
                .attr('class', 'error-bar');
            }
          });
        selection.exit().remove();
      })
      .transition()
      .duration(500)
      .style('opacity', '1');

    points
      .exit()
      .transition()
      .duration(500)
      .style('opacity', '0')
      .remove();
  }

  // Draw legend
  var title = '';

  var labels = {};
  indices.forEach(function(index) {
    var label = colorBy(data.firstSeries().getRowByGlobalIndex(index));
    labels[label] = label;
  });

  this._svg.selectAll('.chart-title').remove();
  this._svg.selectAll('.chart-title-color').remove();
  var titleEntries = this._svg
    .selectAll('.chart-title')
    .data(Object.keys(labels));
  titleEntries
    .enter()
    .append('text')
    .attr('class', 'chart-title')
    .attr('font-weight', 'bold')
    .attr('y', self.margins().top() - 5);
  titleEntries
    .attr('fill', function(label) { return colors.getByKey(label); })
    .text(function(label) { return label; });

  var textLength = 0;
  var titleEntriesStartPosition = [];

  $('#' + this.id() + ' .chart-title')
    .each(function(i) {
      titleEntriesStartPosition.push(textLength);
      textLength += this.getBBox().width + 15;
    });

  titleEntries.attr('x', function(column, i) {
    return self.margins().left() + 10 + titleEntriesStartPosition[i];
  });

  var colorEntries = this._svg
    .selectAll('.chart-title-color')
    .data(Object.keys(labels))
    .enter()
    .append('circle')
    .attr('class', 'chart-title-color')
    .attr('cx', function(column, i) { return self.margins().left() + 4 + titleEntriesStartPosition[i]; })
    .attr('cy', self.margins().top() - 9)
    .attr('r', 4)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .style('fill', function(label) { return colors.getByKey(label); });


// show baseline
if(absLine != epiviz.ui.charts.CustomSetting.DEFAULT) {

  graph.selectAll('.abLine').remove();

  graph.append("svg:line")
        .attr("class", "abLine")
        .attr("x1", 0)
        .attr("x2", self.width() - self.margins().sumAxis(epiviz.ui.charts.Axis.X))
        .attr("y1", yScale(absLine))
        .attr("y2", yScale(absLine))
        .style("stroke", "black")
        .style("stroke-dasharray", ("5, 5")) ;
}

  return lineItems;
};

/**
 * @returns {Array.<string>}
 */
epiviz.plugins.charts.LinePlot.prototype.colorLabels = function() {
  var labels = [];
  for (var i = 0; i < this.colors().size() && i < 20; ++i) {
    labels.push('Color ' + (i + 1));
  }
  return labels;
};

// goog.inherits(epiviz.plugins.charts.LinePlot, epiviz.ui.charts.Plot);

// Input 156
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/18/13
 * Time: 7:34 PM
 */

goog.provide('epiviz.plugins.charts.GenesTrackType');

goog.require('epiviz.plugins.charts.GenesTrack');
goog.require('epiviz.ui.charts.TrackType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');


/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.TrackType}
 * @constructor
 */
epiviz.plugins.charts.GenesTrackType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.TrackType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.GenesTrackType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.TrackType.prototype);
epiviz.plugins.charts.GenesTrackType.constructor = epiviz.plugins.charts.GenesTrackType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.GenesTrack}
 */
epiviz.plugins.charts.GenesTrackType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.GenesTrack(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.GenesTrackType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.GenesTrack';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.GenesTrackType.prototype.chartName = function() {
  return 'Genes Track';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.GenesTrackType.prototype.chartHtmlAttributeName = function() {
  return 'genes';
};

/**
 * @returns {epiviz.measurements.Measurement.Type}
 */
/*epiviz.plugins.charts.GenesTrackType.prototype.chartContentType = function() {
  return epiviz.measurements.Measurement.Type.RANGE;
};*/

/**
 * @returns {boolean}
 */
epiviz.plugins.charts.GenesTrackType.prototype.isRestrictedToRangeMeasurements = function() { return true; };

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.GenesTrackType.prototype.measurementsFilter = function() { return function(m) { return m.type() == epiviz.measurements.Measurement.Type.RANGE; }; };

// goog.inherits(epiviz.plugins.charts.GenesTrackType, epiviz.ui.charts.TrackType);

// Input 157
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/16/13
 * Time: 9:36 AM
 */

goog.provide('epiviz.plugins.charts.BlocksTrackType');

goog.require('epiviz.plugins.charts.BlocksTrack');
goog.require('epiviz.ui.charts.TrackType');
goog.require('epiviz.measurements.Measurement.Type');
goog.require('epiviz.ui.charts.CustomSetting');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.TrackType}
 * @constructor
 */
epiviz.plugins.charts.BlocksTrackType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.TrackType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.BlocksTrackType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.TrackType.prototype);
epiviz.plugins.charts.BlocksTrackType.constructor = epiviz.plugins.charts.BlocksTrackType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.plugins.charts.BlocksTrack}
 */
epiviz.plugins.charts.BlocksTrackType.prototype.createNew = function(id, container, properties) {
  return new epiviz.plugins.charts.BlocksTrack(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.BlocksTrackType.prototype.typeName = function() {
  return 'epiviz.plugins.charts.BlocksTrack';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.BlocksTrackType.prototype.chartName = function() {
  return 'Blocks Track';
};

/**
 * @returns {string}
 */
epiviz.plugins.charts.BlocksTrackType.prototype.chartHtmlAttributeName = function() {
  return 'blocks';
};

/**
 * @returns {epiviz.measurements.Measurement.Type}
 */
/*epiviz.plugins.charts.BlocksTrackType.prototype.chartContentType = function() {
  return epiviz.measurements.Measurement.Type.RANGE;
};*/

/**
 * @returns {boolean}
 */
epiviz.plugins.charts.BlocksTrackType.prototype.isRestrictedToRangeMeasurements = function() { return true; };

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.plugins.charts.BlocksTrackType.prototype.measurementsFilter = function() { return function(m) { return m.type() == epiviz.measurements.Measurement.Type.RANGE; }; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.plugins.charts.BlocksTrackType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.TrackType.prototype.customSettingsDefs.call(this).concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.BlocksTrackType.CustomSettings.MIN_BLOCK_DISTANCE,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      5,
      'Minimum block distance'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.BlocksTrackType.CustomSettings.USE_COLOR_BY,
      epiviz.ui.charts.CustomSetting.Type.BOOLEAN,
      false,
      'Use Block Color by'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.plugins.charts.BlocksTrackType.CustomSettings.BLOCK_COLOR_BY,
      epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_METADATA,
      'colLabel',
      'Block color by')
  ]);
};

/**
 * @enum {string}
 */
epiviz.plugins.charts.BlocksTrackType.CustomSettings = {
  MIN_BLOCK_DISTANCE: 'minBlockDistance',
  BLOCK_COLOR_BY: 'blockColorBy',
  USE_COLOR_BY: 'useColorBy'
};

// goog.inherits(epiviz.plugins.charts.BlocksTrackType, epiviz.ui.charts.TrackType);

// Input 158
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/14/13
 * Time: 11:55 PM
 */

goog.provide('epiviz.plugins.charts.DiversityScatterPlot');

goog.require('epiviz.ui.charts.Plot');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.ui.charts.Visualization');
goog.require('epiviz.utils');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.charts.ChartIndexObject');
goog.require('epiviz.deferred.Deferred');


/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Plot}
 * @constructor
 */
epiviz.plugins.charts.DiversityScatterPlot = function(id, container, properties) {
    // Call superclass constructor
    epiviz.ui.charts.Plot.call(this, id, container, properties);

    this._dispatch = d3.dispatch("hover", "click");

    /**
     * D3 chart container
     * @type {*}
     * @private
     */
    this._chartContent = null;

    /**
     * D3 legend container
     * @type {*}
     * @private
     */
    this._legend = null;

    /**
     * @type {Array.<epiviz.measurements.Measurement>}
     * @private
     */
    this._measurementsX = [];

    /**
     * @type {Array.<epiviz.measurements.Measurement>}
     * @private
     */
    this._measurementsY = [];

    var self = this;
    this.measurements().foreach(function(m, i) {
        if (i % 2 == 0) { self._measurementsX.push(m); } else { self._measurementsY.push(m); }
    });

    /**
     * @type {string}
     * @private
     */
    this._xLabel = '';

    /**
     * @type {string}
     * @private
     */
    this._yLabel = '';

    for (var i = 0; i < Math.min(this._measurementsX.length, this._measurementsY.length); ++i) {
        if (i > 0) {
            this._xLabel += ', ';
            this._yLabel += ', ';
        }
        this._xLabel += this._measurementsX[i].name();
        this._yLabel += this._measurementsY[i].name();
    }

    /**
     * @type {Array.<string>}
     * @private
     */
    this._colorLabels = [];

    this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.plugins.charts.DiversityScatterPlot.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Plot.prototype);
epiviz.plugins.charts.DiversityScatterPlot.constructor = epiviz.plugins.charts.DiversityScatterPlot;

/**
 * @protected
 */
epiviz.plugins.charts.DiversityScatterPlot.prototype._initialize = function() {
    // Call super
    epiviz.ui.charts.Plot.prototype._initialize.call(this);

    this._svg.classed('scatter-plot', true);

    this._chartContent = this._svg.append('g').attr('class', 'chart-content');
    this._legend = this._svg.append('g').attr('class', 'chart-legend');
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {?epiviz.datatypes.GenomicData} [data]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */

epiviz.plugins.charts.DiversityScatterPlot.prototype.draw = function() {
    epiviz.ui.charts.Plot.prototype.draw.call(this, undefined, undefined);
    var self = this;

    self.drawScatter(self._lastRange, self._lastData.data, "sample_id", self._xLabel, "alphaDiversity");
};

epiviz.plugins.charts.DiversityScatterPlot.prototype.drawScatter = function(range, data, key, dimx, dimy) {

    // epiviz.ui.charts.Plot.prototype.draw.call(this, range, data);

    // If data is defined, then the base class sets this._lastData to data.
    // If it isn't, then we'll use the data from the last draw call
    // data = this._lastData;
    //range = this._lastRange;

    // If data is not defined, there is nothing to draw
    // if (!data || !range) {
    //     return [];
    // }

    // group data by keys

    // var keysList = Objects.keys(tempData);

    // var groupData = d3.nest().key(function(d) { return d[key]; }).entries(data);

    // collapse data points -> dataX, dataY (assume same length dataX, and dataY)

    // joint dataX, dataY on common keys -> data (array of objects)

    this.xTag = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.ROW_LABEL];
    // if (this.xTag == "name"){
    //     var keys = Object.keys(data[0]);
    //     for(k = 0; k < keys.length; k++){
    //         var key = keys[k];
    //         var values = data.map(function(i) {return i[key];});
    //         if (values.length > 2){
    //             this.xTag = key;
    //             break;
    //         }
    //     }
    // }
    var old_x_axis = this._measurementsX[0];
    var tempAnnotation = old_x_axis.annotation();
    this._measurementsX = [];
    var new_x_axis = new epiviz.measurements.Measurement(this.xTag, this.xTag, 'feature', 'ihmp', 'ihmp',
                                           'ihmp', null, null, tempAnnotation,
                                           -1, 1,[]);
    this._measurementsX.push(new_x_axis);
    return this._drawCircles(data, this.xTag, dimy, key);
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 * @private
 */
epiviz.plugins.charts.DiversityScatterPlot.prototype._drawCircles = function(data, dimx, dimy, key) {
    var self = this;
    var Axis = epiviz.ui.charts.Axis;
    var circleRadius = Math.max(1, this.customSettingsValues()[epiviz.plugins.charts.DiversityScatterPlotType.CustomSettings.CIRCLE_RADIUS_RATIO] * Math.min(this.width(), this.height()));
    var gridSquareSize = Math.max(Math.floor(circleRadius), 1);
    // var nSeries = Math.min(this._measurementsX.length, this._measurementsY.length);

    // var firstGlobalIndex = data.firstSeries().globalStartIndex();
    // var lastGlobalIndex = data.firstSeries().globalEndIndex();
    // data.foreach(function(measurement, series) {

    //     var firstIndex = series.globalStartIndex();
    //     var lastIndex = series.globalEndIndex();

    //     if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
    //     if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
    // });

    // var nItems = lastGlobalIndex - firstGlobalIndex;

    var margins = this.margins();
    var width = this.width();
    var height = this.height();

    var CustomSetting = epiviz.ui.charts.CustomSetting;
    var minY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MIN];
    var maxY = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.Y_MAX];
    var minX = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.X_MIN];
    var maxX = this.customSettingsValues()[epiviz.ui.charts.Visualization.CustomSettings.X_MAX];

    // if (minX == CustomSetting.DEFAULT) { minX = this._measurementsX[0].minValue(); }
    if (minY == CustomSetting.DEFAULT) { minY = this._measurementsY[0].minValue(); }
    // if (maxX == CustomSetting.DEFAULT) { maxX = this._measurementsX[0].maxValue(); }
    if (maxY == CustomSetting.DEFAULT) { maxY = this._measurementsY[0].maxValue(); }



    var allValues = []
    data.forEach(function(m) { allValues.push(m[dimx]);});

    var uniqueValues = [];

    allValues.forEach(function(m) {
        if(uniqueValues.indexOf(m) == -1) {
            uniqueValues.push(m);
        }
    });

    console.log(uniqueValues);
    this.xTickValues = uniqueValues;
    data.forEach(function(n) {
        var index = uniqueValues.indexOf(n[dimx]);
        n._xVal = index+1;
    } );

    var count= 0;
    var plotData = [];
    uniqueValues.forEach(function(m) {
        plotData[count] = [];
        plotData[count][0] = count;
        plotData[count][1] = [];
        count++;
    });

    data.forEach(function(d) {
        var ind = uniqueValues.indexOf(d[dimx]);

        plotData[ind][1].push(d[dimy]);
    });

    if (minX == CustomSetting.DEFAULT) {
        minX = 0;
    }
    if (maxX == CustomSetting.DEFAULT) {
        maxX = uniqueValues.length+1;
    }
    
    // if (minY == CustomSetting.DEFAULT) {
    //     minY = d3.min(data, function(d) {
    //         return d[dimy];
    //     });
    // }
    // if (maxY == CustomSetting.DEFAULT) {
    //     maxY = d3.max(data, function(d) {
    //         return d[dimy];
    //     });
    // }

    // var dataHasGenomicLocation = epiviz.measurements.Measurement.Type.isOrdered(this._measurementsX[0].type());

    var xScale = d3.scale.linear()
        .domain([minX, maxX])
        .range([0, width - margins.sumAxis(Axis.X)]);
    var yScale = d3.scale.linear()
        .domain([minY, maxY])
        .range([height - margins.sumAxis(Axis.Y), 0]);

    this._clearAxes(this._chartContent);
    //this._drawAxes(xScale, yScale, 15, 15, this._chartContent);
    //this._drawAxes(xScale, yScale, uniqueValues.length, 15, this._chartContent);
    //this._drawAxes(xScale, yScale, xTicks, yTicks, svg, width, height, margins, undefined, undefined,this.xTickValues, undefined, undefined)
    xLabelsPadded = [""];
    uniqueValues.forEach(function(n) {xLabelsPadded.push(n);});
    console.log(xLabelsPadded);
    this._drawAxes(xScale, yScale, xLabelsPadded.length, 15, this._chartContent, width, height, margins, undefined, undefined,xLabelsPadded, undefined, undefined)

    // var i, index;
    // var indices = []; //epiviz.utils.range(nSeries * nItems);
    // for (i = 0; i < nItems; ++i) {
    //     index = i + firstGlobalIndex;
    //     var item = data.getSeries(this._measurementsX[0]).getRowByGlobalIndex(index);
    //     if (!item) {
    //         continue;
    //     }
    //     if (!dataHasGenomicLocation ||
    //         (range.start() == undefined || range.end() == undefined) ||
    //         (item.start() < range.end() && item.end() > range.start())) {

    //         for (var j = 0; j < nSeries; ++j) {
    //             indices.push(j * nItems + i);
    //         }
    //     }
    // }

    // var grid = {};
    // var items = [];
    // var maxGroupItems = 1;
    // for (i = 0; i < indices.length; ++i) {
    //     index = indices[i] % nItems;
    //     var globalIndex = index + firstGlobalIndex;
    //     var seriesIndex = Math.floor(indices[i] / nItems);
    //     var mX = self._measurementsX[seriesIndex];
    //     var mY = self._measurementsY[seriesIndex];
    //     var cellX = data.getSeries(mX).getByGlobalIndex(globalIndex);
    //     var cellY = data.getSeries(mY).getByGlobalIndex(globalIndex);

    //     if (!cellX || !cellY) {
    //         continue;
    //     }

    //     var classes = sprintf('item data-series-%s', seriesIndex);

    //     var x = xScale(cellX.value);
    //     var y = yScale(cellY.value);
    //     var gridX = Math.floor(x / gridSquareSize) * gridSquareSize;
    //     var gridY = Math.floor(y / gridSquareSize) * gridSquareSize;

    //     var uiObj = null;
    //     if (grid[gridY] && grid[gridY][gridX]) {
    //         uiObj = grid[gridY][gridX];
    //         uiObj.id += '_' + cellX.globalIndex;
    //         uiObj.start = Math.min(uiObj.start, cellX.rowItem.start());
    //         uiObj.end = Math.max(uiObj.end, cellX.rowItem.end());
    //         uiObj.values[0] = (uiObj.values[0] * uiObj.valueItems[0].length + cellX.value) / (uiObj.valueItems[0].length + 1);
    //         uiObj.values[1] = (uiObj.values[1] * uiObj.valueItems[1].length + cellY.value) / (uiObj.valueItems[1].length + 1);
    //         uiObj.valueItems[0].push(cellX);
    //         uiObj.valueItems[1].push(cellY);

    //         if (uiObj.valueItems[0].length > maxGroupItems) {
    //             maxGroupItems = uiObj.valueItems[0].length;
    //         }

    //         continue;
    //     }


    //     uiObj = new epiviz.ui.charts.ChartObject(
    //         sprintf('scatter_%s_%s', seriesIndex, cellX.globalIndex),
    //         cellX.rowItem.start(),
    //         cellX.rowItem.end(), [cellX.value, cellY.value],
    //         seriesIndex, [
    //             [cellX],
    //             [cellY]
    //         ], // valueItems one for each measurement
    //         [mX, mY], // measurements
    //         classes);

    //     if (!grid[gridY]) { grid[gridY] = {}; }
    //     grid[gridY][gridX] = uiObj;

    //     items.push(uiObj);
    // }





    var grid = {};
    var items = [];
    var maxGroupItems = 1;
    var seriesIndex = 0; // Assume only 1 pair of datax and datay
    for (var i = 0; i < data.length; ++i) {

        console.log(data[i]);
        //index = indices[i] % nItems;
        //var globalIndex = index + firstGlobalIndex;
        //var seriesIndex = Math.floor(indices[i] / nItems);
        //var mX = self._measurementsX[seriesIndex];
        //var mY = self._measurementsY[seriesIndex];
        //var cellX = data.getSeries(mX).getByGlobalIndex(globalIndex);
        //var cellY = data.getSeries(mY).getByGlobalIndex(globalIndex);
        var cellX = data[i]["_xVal"];
        var cellY = data[i][dimy];
        if (!cellX || !cellY) {
            continue;
        }

        var classes = sprintf('item data-series-%s', seriesIndex);

        var x = xScale(cellX);
        var y = yScale(cellY);

        var gridX = Math.floor(x / gridSquareSize) * gridSquareSize;
        var gridY = Math.floor(y / gridSquareSize) * gridSquareSize;

        var uiObj = null;
        if (grid[gridY] && grid[gridY][gridX]) {
            uiObj = grid[gridY][gridX];
            uiObj.id += '_' + data[i][key];
            uiObj.values[0] = (uiObj.values[0] * uiObj.valueItems[0].length + cellX) / (uiObj.valueItems[0].length + 1);
            uiObj.values[1] = (uiObj.values[1] * uiObj.valueItems[1].length + cellY) / (uiObj.valueItems[1].length + 1);
            uiObj.valueItems[0].push(data[i]);
            uiObj.valueItems[1].push(data[i]);
            if (uiObj.valueItems[0].length > maxGroupItems) {
                maxGroupItems = uiObj.valueItems[0].length;
            }
            continue;
        }

        uiObj = new epiviz.ui.charts.ChartIndexObject(
            sprintf('scatter_%s_%s_%s_%s', cellX, cellY, seriesIndex, data[i][key]), [key],
            data[i][key], [cellX, cellY], [
                [data[i]],
                [data[i]]
            ], // valueItems one for each measurement
            ["_xVal", dimy], // measurements
            seriesIndex,
            classes);

        if (!grid[gridY]) { grid[gridY] = {}; }
        grid[gridY][gridX] = uiObj;

        items.push(uiObj);
    }

    console.log("after loop");


    var itemsGroup = this._chartContent.select('.items');

    if (itemsGroup.empty()) {
        itemsGroup = this._chartContent.append('g').attr('class', 'items');
        var selectedGroup = itemsGroup.append('g').attr('class', 'selected');
        itemsGroup.append('g').attr('class', 'hovered');
        selectedGroup.append('g').attr('class', 'hovered');
    }



    var selection = itemsGroup.selectAll('circle').data(items, function(d) {
        return d.id;
    });

    // selection
    //     .enter()
    //     .insert('circle', ':first-child')
    //     .attr('id', function(d) {
    //         return sprintf('%s-item-%s-%s', self.id(), d.seriesIndex, d.valueItems[0][0].globalIndex);
    //     })
    //     .style('opacity', 0)
    //     .style('fill-opacity', 0)
    //     .attr('r', 0);
    // selection
    //     .each(
    //         /**
    //          * @param {epiviz.ui.charts.ChartObject} d
    //          */
    //         function(d) {
    //             var circle = d3.select(this);

    //             var fill;
    //             if (!self._globalIndexColorLabels) { fill = self.colors().get(d.seriesIndex); } else {
    //                 fill = self.colors().getByKey(self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]);
    //             }
    //             circle
    //                 .attr('cx', margins.left() + (d.values[0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    //                 .attr('cy', height - margins.bottom() - ((d.values[1] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
    //                 .attr('class', d.cssClasses)
    //                 .style('fill', fill);
    //         });

    selection
        .enter()
        .insert('circle', ':first-child')
        .attr('id', function(d) {
            return sprintf('%s-item-%s', self.id(), d.seriesIndex);
        })
        .style('opacity', 0)
        .style('fill-opacity', 0)
        .attr('r', 0);
    selection
        .each(
            /**
             * @param {epiviz.ui.charts.ChartObject} d
             */
            function(d) {
                var circle = d3.select(this);

                var fill = self.colors().get(d.seriesIndex);
                // if (!self._globalIndexColorLabels) { fill = self.colors().get(d.seriesIndex); } else {
                //     fill = self.colors().getByKey(self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]);
                // }
                circle
                    .attr('cx', margins.left() + (d.values[0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
                    .attr('cy', height - margins.bottom() - ((d.values[1] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
                    .attr('class', d.cssClasses)
                    .style('fill', fill);
            });


    selection
        .transition()
        .duration(1000)
        .style('fill-opacity', function(d) {
            //return Math.max(0.3, d.valueItems[0].length / maxGroupItems);
            return Math.max(0.6, d.valueItems[0].length / maxGroupItems);
        })
        .style('opacity', null)
        .attr('r', circleRadius);

    selection
        .exit()
        .transition()
        .duration(1000)
        .style('opacity', 0)
        .attr('r', 0)
        .remove();

    selection
        //.on('mouseover', function(d) {
        //    console.log("mouseover");
        //    console.log(d);
        //    self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
        //    self._dispatch.hover(self.id(), d);
        //})
        //.on('mouseout', function() {
        //    self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
        //    self._dispatch.hover(self.id(), null);
        //
        //})
        .on('click', function(d) {
            console.log("click");
            console.log(d);
            self._deselect.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
            self._select.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
            self._dispatch.click(self.id(), null);

            d3.event.stopPropagation();
        });

    // Draw legend if necessary
    if (this._globalIndexColorLabels) {
        var colorLabelsMap = {};
        for (j = firstGlobalIndex; j < lastGlobalIndex; ++j) {
            colorLabelsMap[this._globalIndexColorLabels[j]] = this._globalIndexColorLabels[j];
        }
        this._colorLabels = Object.keys(colorLabelsMap);

        this._svg.selectAll('.chart-title').remove();
        this._svg.selectAll('.chart-title-color ').remove();
        var titleEntries = this._svg
            .selectAll('.chart-title')
            .data(this._colorLabels);
        titleEntries
            .enter()
            .append('text')
            .attr('class', 'chart-title')
            .attr('font-weight', 'bold')
            .attr('y', self.margins().top() - 5);
        titleEntries
            .attr('fill', function(label, i) {
                return self.colors().getByKey(label);
            })
            .text(function(label) {
                return label;
            });
        var textLength = 0;
        var titleEntriesStartPosition = [];

        $('#' + this.id() + ' .chart-title')
            .each(function(i) {
                titleEntriesStartPosition.push(textLength);
                textLength += this.getBBox().width + 15;
            });

        titleEntries.attr('x', function(column, i) {
            return self.margins().left() + 10 + titleEntriesStartPosition[i];
        });

        var colorEntries = this._svg
            .selectAll('.chart-title-color')
            .data(this._colorLabels)
            .enter()
            .append('circle')
            .attr('class', 'chart-title-color')
            .attr('cx', function(column, i) {
                return self.margins().left() + 4 + titleEntriesStartPosition[i];
            })
            .attr('cy', self.margins().top() - 9)
            .attr('r', 4)
            .style('shape-rendering', 'auto')
            .style('stroke-width', '0')
            .attr('fill', function(label, i) {
                return self.colors().getByKey(label);
            })
            .style('stroke-width', 0)
    } else {
        var n = Math.min(this._measurementsX.length, this._measurementsY.length);
        var colors = new Array(n);

        for (j = 0; j < n; ++j) {
            colors[j] = sprintf('%s vs %s', this._measurementsX[j].name(), this._measurementsY[j].name());
        }

        this._colorLabels = colors;
    }

    var rectBox = itemsGroup;
    
    console.log(uniqueValues);

    rectBox.selectAll('.iqr-range').remove();
    rectBox.selectAll('.whisker').remove();
    for(i = 0; i < plotData.length; i++){
        var findIQR = plotData[i][1];
        console.log(findIQR);
        var lower_upper = [];
        lower_upper = quartiles(findIQR);
        console.log(lower_upper);  
        
        var iqr_result = lower_upper[1] - lower_upper[0];
        var iqr_15 = iqr_result * 1.5;

        var whisker_lower_index = 0;
        var whisker_upper_index = findIQR.length-1;
        for(j = 0; j < findIQR.length; j++){
            if(findIQR[j] < lower_upper[0] - iqr_15) {
                whisker_lower_index = j;
            }
            else {
                break;
            }
        }
        for(k = findIQR.length-1; k > 0; k--){
            if(findIQR[k] > (lower_upper[1] + iqr_15)) {
                whisker_upper_index = k;
            }
            else {
                break;
            }
        }
    rectBox.append("rect")
    //.attr('id', function(d) {console.log(d[0]); return d[0];})
    .attr('id', "0")
    .attr('class', 'iqr-range')
    .style('opacity', 1)
    .style('fill-opacity', 0.2)
    //.attr('x', xScale(.6))
    //.attr('y', yScale(1-.2))
    .attr('x', margins.left() + (0.6 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y', height - margins.bottom() - ((lower_upper[1] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
    //.attr('y', function(d) { d = plotData[i]; console.log(d[1][0]); return height + 2*(margins._bottom) - margins._top - yScale(.25); })
    .attr('width', xScale(.8))
    .attr('height', Math.abs((yScale(lower_upper[1])-yScale(lower_upper[0]))))
    //.attr('height', Math.abs(((yScale(.3)-yScale(.25)))))
    //.attr('height', lower_upper[1]-lower_upper[0])
    //.attr('height', Math.abs(yScale(.5)))
    .attr('fill', '#1E90FF');


     rectBox.append("line")
    .style("stroke", "gray")
    .attr('class', 'whisker')
    .attr("x1", margins.left() + (1 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y1', height - margins.bottom() - ((lower_upper[1] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
    .attr("x2", margins.left() + (1 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y2', (height - margins.bottom() - ((findIQR[whisker_upper_index] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY))));

    rectBox.append("line")
    .style("stroke", "gray")
    .attr('class', 'whisker')
    .attr("x1", margins.left() + (1 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y1', height - margins.bottom() - ((lower_upper[0] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
    .attr("x2", margins.left() + (1 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y2', (height - margins.bottom() - ((findIQR[whisker_lower_index] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY))));

     rectBox.append("line")
    .style("stroke", "gray")
    .attr('class', 'whisker')
    .attr("x1", margins.left() + (0.6 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y1', height - margins.bottom() - ((findIQR[whisker_upper_index] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
    .attr("x2", margins.left() + (1.4 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y2', (height - margins.bottom() - ((findIQR[whisker_upper_index] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY))));

    rectBox.append("line")
    .style("stroke", "gray")
    .attr('class', 'whisker')
    .attr("x1", margins.left() + (0.6 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y1', height - margins.bottom() - ((findIQR[whisker_lower_index] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY)))
    .attr("x2", margins.left() + (1.4 + plotData[i][0] - minX) * (width - margins.sumAxis(Axis.X)) / (maxX - minX))
    .attr('y2', (height - margins.bottom() - ((findIQR[whisker_lower_index] - minY) * (height - margins.sumAxis(Axis.Y)) / (maxY - minY))));

    }
    // .style('fill', function(d, i) {
    //   if (!self._globalIndexColorLabels) { return self._colorScale(d.values[0]); }
    //   return colorScales[self._globalIndexColorLabels[d.valueItems[0][0].globalIndex]](d.values[0]);
    // });

    function quartiles(d) {
        d.sort(d3.ascending);
        var q1 = d3.quantile(d, .25);
        var q3 = d3.quantile(d, .75);
        return [q1, q3];
    };



    return items;
};



/**
 * @returns {Array.<{name: string, color: string}>}
 */
epiviz.plugins.charts.DiversityScatterPlot.prototype.colorLabels = function() {
    return this._colorLabels;
};

/**
 * @param xScale D3 linear scale for the x axis
 * @param yScale D3 linear scale for the y axis
 * @param {number} [xTicks]
 * @param {number} [yTicks]
 * @param [svg] D3 svg container for the axes
 * @param {number} [width]
 * @param {number} [height]
 * @param {epiviz.ui.charts.Margins} [margins]
 * @protected
 */
epiviz.plugins.charts.DiversityScatterPlot.prototype._drawAxesOld = function(xScale, yScale, xTicks, yTicks, svg, width, height, margins) {
    epiviz.ui.charts.Plot.prototype._drawAxes(xScale, yScale, xTicks, yTicks,
    svg, width, height, margins, undefined, undefined,
    this.xTickValues, undefined, undefined);
    //epiviz.ui.charts.Plot.prototype._drawAxes.call(this, xScale, yScale, xTicks, yTicks, svg, width, height, margins);

    this._legend.selectAll('text').remove();

    var xMeasurements = this._measurementsX;
    var self = this;
    this._legend.selectAll('.x-measurement').remove();
    this._legend.selectAll('.x-measurement-color').remove();

    var xEntries = this._legend
        .selectAll('.x-measurement')
        .data(xMeasurements)
        .enter()
        .append('text')
        .attr('class', 'x-measurement')
        .attr('font-weight', 'bold')
        .attr('fill', function(m, i) {
            return self._globalIndexColorLabels ?
                "#000000" : self.colors().get(i);
        })
        .attr('y', (this.height() - this.margins().bottom() + 35))
        .text(function(m, i) {
            return m.name();
        });

    var xTextLength = 0;
    var xTitleEntriesStartPosition = [];

    $('#' + this.id() + ' .x-measurement')
        .each(function(i) {
            xTitleEntriesStartPosition.push(xTextLength);
            xTextLength += this.getBBox().width + 15;
        });

    xEntries.attr('x', function(column, i) {
        return (self.width() - xTextLength) * 0.5 + 7 + xTitleEntriesStartPosition[i];
    });

    var xColorEntries = this._legend
        .selectAll('.x-measurement-color')
        .data(xMeasurements)
        .enter()
        .append('circle')
        .attr('class', 'x-measurement-color')
        .attr('cx', function(column, i) {
            return (self.width() - xTextLength) * 0.5 + 1 + xTitleEntriesStartPosition[i];
        })
        .attr('cy', (this.height() - this.margins().bottom() + 31))
        .attr('r', 4)
        .style('shape-rendering', 'auto')
        .style('stroke-width', '0')
        .style('fill', function(m, i) {
            return self._globalIndexColorLabels ?
                "#ffffff" : self.colors().get(i);
        });


    var yMeasurements = ['alphaDiversity'];
    this._legend.selectAll('.y-measurement').remove();
    this._legend.selectAll('.y-measurement-color').remove();

    var yEntries = this._legend
        .selectAll('.y-measurement')
        .data(yMeasurements)
        .enter()
        .append('text')
        .attr('class', 'y-measurement')
        .attr('font-weight', 'bold')
        .attr('fill', function(m, i) {
            return self._globalIndexColorLabels ?
                "#000000" : self.colors().get(i);
        })
        .attr('y', (this.margins().left() - 35))
        .attr('transform', 'rotate(-90)')
        .text(function(m, i) {
            return m;
        });

    var yTextLength = 0;
    var yTitleEntriesStartPosition = [];

    $('#' + this.id() + ' .y-measurement')
        .each(function(i) {
            yTitleEntriesStartPosition.push(yTextLength);
            yTextLength += this.getBBox().width + 15;
        });

    yEntries.attr('x', function(column, i) {
        return -self.height() + (self.height() - yTextLength) * 0.5 + 12 + self.margins().top() + yTitleEntriesStartPosition[i];
    });

    var yColorEntries = this._legend
        .selectAll('.y-measurement-color')
        .data(yMeasurements)
        .enter()
        .append('circle')
        .attr('class', 'y-measurement-color')
        .attr('cx', function(column, i) {
            return -self.height() + (self.height() - yTextLength) * 0.5 + 6 + self.margins().top() + yTitleEntriesStartPosition[i];
        })
        .attr('cy', (this.margins().left() - 39))
        .attr('transform', 'rotate(-90)')
        .attr('r', 4)
        .style('shape-rendering', 'auto')
        .style('stroke-width', '0')
        .style('fill', function(m, i) {
            return self._globalIndexColorLabels ?
                "#ffffff" : self.colors().get(i);
        });
};

epiviz.plugins.charts.DiversityScatterPlot.prototype.transformData = function(range, data) {
  var lastRange = this._lastRange;

  if (range != undefined) {
    this._lastRange = range;
  }
  if (data != undefined) {
    this._lastData = data;
    this._unalteredData = data;
  }

  var deferred = new epiviz.deferred.Deferred();
  deferred.resolve();
  return deferred;
};


// goog.inherits(epiviz.plugins.charts.DiversityScatterPlot, epiviz.ui.charts.Plot);

// Input 159
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/26/2015
 * Time: 9:45 AM
 */

goog.provide('epiviz.deferred.Promise');

goog.require('epiviz.deferred.Deferred');

/**
 * Wrapper around JQuery Promise
 * @param {Promise} promise
 * @constructor
 * @template T The type of result
 */
epiviz.deferred.Promise = function(promise) {
  /**
   * @type {Promise}
   * @private
   */
  this._promise = promise;
};

/**
 * @param {function(T)} doneFilter
 * @param {function} [failFilter]
 * @param {function} [progressFilter]
 * @returns {epiviz.deferred.Promise.<T>}
 */
epiviz.deferred.Promise.prototype.then = function(doneFilter, failFilter, progressFilter) {
  return new epiviz.deferred.Promise(this._promise.then(doneFilter, failFilter, progressFilter));
};

/**
 * @param {function(T)|Array.<function(T)>} doneCallbacks
 * @param {function(T)|Array.<function(T)>} [moreDoneCallbacks]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Promise.prototype.done = function(doneCallbacks, moreDoneCallbacks) {
  return new epiviz.deferred.Deferred(this._promise.done(doneCallbacks, moreDoneCallbacks));
};

/**
 * @param {function|Array.<function>} failCallbacks
 * @param {function|Array.<function>} [moreFailCallbacks]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Promise.prototype.fail = function(failCallbacks, moreFailCallbacks) {
  return new epiviz.deferred.Deferred(this._promise.fail(failCallbacks, moreFailCallbacks));
};

/**
 * @param {function|Array.<function>} alwaysCallbacks
 * @param {function|Array.<function>} [moreAlwaysCallbacks]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Promise.prototype.always = function(alwaysCallbacks, moreAlwaysCallbacks) {
  return new epiviz.deferred.Deferred(this._promise.always(alwaysCallbacks, moreAlwaysCallbacks));
};

/**
 * @returns {string}
 */
epiviz.deferred.Promise.prototype.state = function() {
  return this._promise.state();
};

// Input 160
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/26/2015
 * Time: 9:41 AM
 */

goog.provide('epiviz.deferred.Deferred');

goog.require('epiviz.deferred.Promise');

/**
 * Wrapper around JQuery Deferred
 * @param {Deferred} [deferred]
 * @constructor
 * @template T
 */
epiviz.deferred.Deferred = function(deferred) {
  /**
   * @type {Deferred}
   * @private
   */
  this._deferred = deferred || $.Deferred();
};

/**
 * @enum {string}
 */
epiviz.deferred.Deferred.State = {
  PENDING: 'pending',
  RESOLVED: 'resolved',
  REJECTED: 'rejected'
};

/**
 * @param {function(T)} doneFilter
 * @param {function} [failFilter]
 * @param {function} [progressFilter]
 * @returns {epiviz.deferred.Promise.<T>}
 */
epiviz.deferred.Deferred.prototype.then = function(doneFilter, failFilter, progressFilter) {
  return new epiviz.deferred.Promise(this._deferred.then(doneFilter, failFilter, progressFilter));
};

/**
 * @param {function(T)|Array.<function(T)>} doneCallbacks
 * @param {function(T)|Array.<function(T)>} [moreDoneCallbacks]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.done = function(doneCallbacks, moreDoneCallbacks) {
  return new epiviz.deferred.Deferred(this._deferred.done(doneCallbacks, moreDoneCallbacks));
};

/**
 * @param {function|Array.<function>} failCallbacks
 * @param {function|Array.<function>} [moreFailCallbacks]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.fail = function(failCallbacks, moreFailCallbacks) {
  return new epiviz.deferred.Deferred(this._deferred.fail(failCallbacks, moreFailCallbacks));
};

/**
 * @param {function|Array.<function>} alwaysCallbacks
 * @param {function|Array.<function>} [moreAlwaysCallbacks]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.always = function(alwaysCallbacks, moreAlwaysCallbacks) {
  return new epiviz.deferred.Deferred(this._deferred.always(alwaysCallbacks, moreAlwaysCallbacks));
};

/**
 * @returns {string}
 */
epiviz.deferred.Deferred.prototype.state = function() {
  return this._deferred.state();
};

/**
 * @param {Object} [args]
 * @retuns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.notify = function(args) {
  return new epiviz.deferred.Deferred(this._deferred.notify(args));
};

/**
 * @param {Object} context
 * @param {Array} [args]
 * @retuns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.notifyWith = function(context, args) {
  return new epiviz.deferred.Deferred(this._deferred.notifyWith(context, args));
};

/**
 * @param {function|Array.<function>} progressCallbacks
 * @param {function|Array.<function>} [moreProgressCallbacks]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.progress = function(progressCallbacks, moreProgressCallbacks) {
  return new epiviz.deferred.Deferred(this._deferred.progress(progressCallbacks, moreProgressCallbacks));
};

/**
 * @param {Object} [target]
 * @returns {epiviz.deferred.Promise.<T>}
 */
epiviz.deferred.Deferred.prototype.promise = function(target) {
  return new epiviz.deferred.Promise(this._deferred.promise(target));
};

/**
 * @param {*} [args]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.reject = function(args) {
  return new epiviz.deferred.Deferred(this._deferred.reject(args));
};

/**
 * @param {Object} context
 * @param {Array} [args]
 * @retuns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.rejectWith = function(context, args) {
  return new epiviz.deferred.Deferred(this._deferred.rejectWith(context, args));
};

/**
 * @param {*} [args]
 * @returns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.resolve = function(args) {
  return new epiviz.deferred.Deferred(this._deferred.resolve(args));
};

/**
 * @param {Object} context
 * @param {Array} [args]
 * @retuns {epiviz.deferred.Deferred.<T>}
 */
epiviz.deferred.Deferred.prototype.resolveWith = function(context, args) {
  return new epiviz.deferred.Deferred(this._deferred.resolveWith(context, args));
};

// Input 161
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/27/14
 * Time: 9:18 AM
 */

goog.provide('epiviz.datatypes.SeqInfo');

goog.require('epiviz.utils');

/**
 * @param {string} seqName
 * @param {number} min Minimum location covered inclusive
 * @param {number} max Maximum location covered exclusive
 * @constructor
 * @struct
 */
epiviz.datatypes.SeqInfo = function(seqName, min, max) {
  /**
   * @type {string}
   */
  this.seqName = seqName;

  /**
   * @type {number}
   */
  this.min = min;

  /**
   * @type {number}
   */
  this.max = max;
};

/**
 * @returns {Array} [seqName, min, max]
 */
epiviz.datatypes.SeqInfo.prototype.raw = function() { return [this.seqName, this.min, this.max]; };

/**
 * @param {Array} o [seqName, min, max]
 * @returns {epiviz.datatypes.SeqInfo}
 */
epiviz.datatypes.SeqInfo.fromRawObject = function(o) { return new epiviz.datatypes.SeqInfo(o[0], parseFloat(o[1]), parseFloat(o[2])); };

/**
 * @param {epiviz.datatypes.SeqInfo} s1
 * @param {epiviz.datatypes.SeqInfo} s2
 * @returns {number}
 */
epiviz.datatypes.SeqInfo.compare = function(s1, s2) {
  if (s1.seqName == s2.seqName) { return 0; }
  if (s1.seqName == undefined) { return -1; }
  if (s2.seqName == undefined) { return 1; }

  var n1str = s1.seqName.replace(/\D/g, '');
  var n2str = s2.seqName.replace(/\D/g, '');

  if (n1str == '' || n2str == '' ||
    (!epiviz.utils.stringStartsWith(s1.seqName, n1str) && !epiviz.utils.stringEndsWith(s1.seqName, n1str)) ||
    (!epiviz.utils.stringStartsWith(s2.seqName, n2str) && !epiviz.utils.stringEndsWith(s2.seqName, n2str))) {
    return (s1.seqName < s2.seqName) ? -1 : ((s1.seqName > s2.seqName) ? 1 : 0);
  }

  return parseInt(n1str) - parseInt(n2str);
};

// Input 162
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/8/13
 * Time: 8:31 AM
 */

goog.provide('epiviz.datatypes.FeatureValueArray');

goog.require('epiviz.datatypes.GenomicArray');
goog.require('epiviz.datatypes.GenomicRange');
goog.require('epiviz.utils');

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicRange} boundaries
 * @param {number} globalStartIndex
 * @param {Array.<number>|Object.<string, Array.<*>>} values
 * @constructor
 * @extends {epiviz.datatypes.GenomicArray}
 */
epiviz.datatypes.FeatureValueArray = function(measurement, boundaries, globalStartIndex, values) {
  var vals = null;
  var valuesAnnotation = null;
  if (!values || $.isArray(values)) {
    vals = values;
    valuesAnnotation = {values: values};
  } else {
    vals = values.values;
    valuesAnnotation = values;
  }

  epiviz.datatypes.GenomicArray.call(this, measurement, boundaries, globalStartIndex, vals);

  /**
   * @type {Object.<string, Array.<*>>}
   * @private
   */
  this._valuesAnnotation = valuesAnnotation;
};

/**
 * Copy methods from upper class
 */
epiviz.datatypes.FeatureValueArray.prototype = epiviz.utils.mapCopy(epiviz.datatypes.GenomicArray.prototype);
epiviz.datatypes.FeatureValueArray.constructor = epiviz.datatypes.FeatureValueArray;

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicRange} boundaries
 * @param {number} globalStartIndex
 * @param {Array.<number>} values
 * @returns {epiviz.datatypes.GenomicArray}
 * @override
 */
epiviz.datatypes.FeatureValueArray.prototype.createNew = function(measurement, boundaries, globalStartIndex, values) {
  return new epiviz.datatypes.FeatureValueArray(measurement, boundaries, globalStartIndex, values);
};

/**
 * @param {number} index
 * @returns {number}
 * @override
 */
epiviz.datatypes.FeatureValueArray.prototype.get = function(index) {
  return this._values[index];
};

/**
 * @param index
 * @returns {?Object.<string, *>}
 */
epiviz.datatypes.FeatureValueArray.prototype.getAnnotation = function(index) {
  if (this._valuesAnnotation == undefined) { return null; }
  var ret = {};
  for (var col in this._valuesAnnotation) {
    if (!this._valuesAnnotation.hasOwnProperty(col)) { continue; }
    ret[col] = this._valuesAnnotation[col][index];
  }
  return ret;
};

/**
 * @returns {number}
 * @override
 */
epiviz.datatypes.FeatureValueArray.prototype.size = function() {
  return this._values ? this._values.length : 0;
};

/**
 * @param {epiviz.datatypes.FeatureValueArray} second
 * @param {number} secondIndex
 * @returns {Array.<number>|Object.<string, *>}
 */
epiviz.datatypes.FeatureValueArray.prototype.concatValues = function(second, secondIndex) {
  if (!second || !second.size()) { return this._valuesAnnotation; }
  if (!this._valuesAnnotation || !this._valuesAnnotation.values) {
    this._valuesAnnotation = {values:[]};
  }
  var ret = {};
  for (var key in this._valuesAnnotation) {
    if (!this._valuesAnnotation.hasOwnProperty(key)) { continue; }
    if (!second._valuesAnnotation.hasOwnProperty(key)) { continue; }
    ret[key] = this._valuesAnnotation[key].concat(second._valuesAnnotation[key].slice(secondIndex));
  }
  return ret;
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {number} globalStartIndex
 * @param {number} length
 * @returns {epiviz.datatypes.FeatureValueArray}
 */
epiviz.datatypes.FeatureValueArray.prototype.trim = function(range, globalStartIndex, length) {
  if (this.globalStartIndex() == undefined || !this.size() ||
    globalStartIndex == undefined || !range ||
    !this.boundaries() || this.boundaries().seqName() != range.seqName()) {
    return null;
  }

  var start = Math.max(this.boundaries().start(), range.start());
  var end = Math.min(this.boundaries().end(), range.end());
  if (end <= start) { return null; }
  range = epiviz.datatypes.GenomicRange.fromStartEnd(range.seqName(), start, end);

  var startIndex = Math.max(globalStartIndex, this.globalStartIndex()) - this.globalStartIndex();
  var endIndex = Math.min(globalStartIndex + length, this.globalStartIndex() + this.size()) - this.globalStartIndex();
  if (endIndex <= startIndex) { return null; }
  /** @type {Object.<string, Array.<*>>} */
  var values = {};
  for (var key in this._valuesAnnotation) {
    if (!this._valuesAnnotation.hasOwnProperty(key)) { continue; }
    values[key] = this._valuesAnnotation[key].slice(startIndex, endIndex);
  }
  return new epiviz.datatypes.FeatureValueArray(this.measurement(), range, startIndex + this.globalStartIndex(), values);
};

/**
 * @returns {string}
 */
epiviz.datatypes.FeatureValueArray.prototype.toString = function() {
  var c, s, e;
  if (this.boundaries()) {
    c = this.boundaries().seqName();
    s = this.boundaries().start();
    e = this.boundaries().end();
  } else {
    c = s = e = '*';
  }
  var header = sprintf('%25s', this.measurement().name().substr(0, 22)) + sprintf(' [%6s%10s%10s]', c, s, e);
  var idx = sprintf('%10s:', 'idx');
  var val = sprintf('%10s:', 'val');

  if (this.globalStartIndex() != undefined) {
    for (var globalIndex = this.globalStartIndex(); globalIndex < this.globalStartIndex() + this.size(); ++globalIndex) {
      /** @type {number} */
      var v = this.getByGlobalIndex(globalIndex);
      idx += sprintf('%10s', globalIndex);
      val += sprintf('%10s', v);
    }
  }

  return [header, idx, val].join('\n');
};

// goog.inherits(epiviz.datatypes.FeatureValueArray, epiviz.datatypes.GenomicArray);
// Input 163
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/8/13
 * Time: 12:45 PM
 */

goog.provide('epiviz.datatypes.MeasurementGenomicDataWrapper');

goog.require('epiviz.datatypes.MeasurementGenomicData');
goog.require('epiviz.datatypes.GenomicData.ValueItem');
goog.require('epiviz.measurements.Measurement.Type');


/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.PartialSummarizedExperiment} container
 * @constructor
 * @implements {epiviz.datatypes.MeasurementGenomicData}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper = function(measurement, container) {
  /**
   * @type {epiviz.measurements.Measurement}
   * @private
   */
  this._measurement = measurement;

  /**
   * @type {epiviz.datatypes.PartialSummarizedExperiment}
   * @private
   */
  this._container = container;

  /**
   * @type {?number}
   * @private
   */
  this._size = null;

  /**
   * @type {?number}
   * @private
   */
  this._globalStartIndex = null;
};

/**
 * @param {number} index
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.get = function(index) {
  var rows = this._container.rowData();
  var values = null;
  var firstGlobalIndex = this.globalStartIndex();

  var item = null;
  var value = null;
  var valueAnnotation = null;
  var globalIndex = null;

  var size = this.size();
  if (!size || index >= size || index < 0) {
    return new epiviz.datatypes.GenomicData.ValueItem(globalIndex, item, value, this._measurement, valueAnnotation);
  }

  if (firstGlobalIndex != undefined) {
    if (this._measurement.type() == epiviz.measurements.Measurement.Type.FEATURE ||
      this._measurement.type() == epiviz.measurements.Measurement.Type.UNORDERED) {
      values = this._container.values(this._measurement);
      var valueIndex = firstGlobalIndex - values.globalStartIndex() + index;
      value = values.get(valueIndex);
      valueAnnotation = values.getAnnotation(valueIndex);
    }

    var rowIndex = firstGlobalIndex - rows.globalStartIndex() + index;
    item = rows.get(rowIndex);

    globalIndex = firstGlobalIndex + index;
  }

  return new epiviz.datatypes.GenomicData.ValueItem(globalIndex, item, value, this._measurement, valueAnnotation);
};

/**
 * @param {number} index
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.getRow = function(index) {
  var rows = this._container.rowData();
  var firstGlobalIndex = this.globalStartIndex();

  var item = null;

  var size = this.size();
  if (!size || index >= size || index < 0) {
    return item;
  }

  if (firstGlobalIndex != undefined) {
    var rowIndex = firstGlobalIndex - rows.globalStartIndex() + index;
    item = rows.get(rowIndex);
  }

  return item;
};

/**
 * @returns {epiviz.measurements.Measurement}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.measurement = function() {
  return this._measurement;
};

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.globalStartIndex = function() {
  if (this._globalStartIndex !== null) { return this._globalStartIndex; }

  /**
   * @type {?epiviz.datatypes.GenomicRangeArray}
   */
  var rows = this._container.rowData();
  var values = null;
  var firstGlobalIndex = rows.globalStartIndex();

  if (firstGlobalIndex === null) { return firstGlobalIndex; }

  if (this._measurement.type() == epiviz.measurements.Measurement.Type.FEATURE ||
    this._measurement.type() == epiviz.measurements.Measurement.Type.UNORDERED) {
    values = this._container.values(this._measurement);
    if (!values.globalStartIndex()) { return values.globalStartIndex(); }
    firstGlobalIndex = Math.max(firstGlobalIndex, values.globalStartIndex());
  }

  this._globalStartIndex = firstGlobalIndex;
  return this._globalStartIndex;
};

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.globalEndIndex = function() {
  var startIndex = this.globalStartIndex();
  if (startIndex == null) { return null; }
  return startIndex + this.size();
};

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.size = function() {
  if (this._size !== null) { return this._size; }

  var firstGlobalIndex = this.globalStartIndex();
  if (firstGlobalIndex == undefined) { return 0; }

  var rows = this._container.rowData();
  var values = this._container.values(this._measurement);

  var result = rows.size() - firstGlobalIndex + rows.globalStartIndex();

  if (this._measurement.type() == epiviz.measurements.Measurement.Type.FEATURE ||
    this._measurement.type() == epiviz.measurements.Measurement.Type.UNORDERED) {
    result = Math.min(result, values.size() - firstGlobalIndex + values.globalStartIndex());
  }

  this._size = Math.max(0, result);

  return this._size;
};

/**
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.getByGlobalIndex = function(globalIndex) {
  var firstGlobalIndex = this.globalStartIndex();
  if (firstGlobalIndex == undefined) { return new epiviz.datatypes.GenomicData.ValueItem(null, null, null, this._measurement, null); }

  return this.get(globalIndex - firstGlobalIndex);
};

/**
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.getRowByGlobalIndex = function(globalIndex) {
  var firstGlobalIndex = this.globalStartIndex();
  if (firstGlobalIndex == undefined) { return null; }

  return this.getRow(globalIndex - firstGlobalIndex);
};

/**
 * Gets the first index and length of the rows that have start positions within the given range
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {{index: ?number, length: number}}
 */
epiviz.datatypes.MeasurementGenomicDataWrapper.prototype.binarySearchStarts = function(range) {

  /** @type {?epiviz.datatypes.GenomicRangeArray} */
  var rows = this._container.rowData();

  if (this.size() == 0 || !rows || rows.size() == 0 || rows.start(0) >= range.end() || rows.start(rows.size() - 1) <= range.start()) { return {index: null, length: 0}; }

  // Perform binary search to find the start row index

  var s = 0, e = rows.size() - 1;
  var m;

  var startIndex = null;

  while (s <= e) {
    m = Math.floor((s + e) * 0.5);
    if (rows.start(m) == range.start()) {
      startIndex = m;
      e = m - 1;
    } else if (rows.start(m) < range.start()) { s = m + 1; }
    else { e = m - 1; }
  }

  if (startIndex === null) { startIndex = s; }

  // Perform binary search to find the end row index

  s = 0;
  e = rows.size() - 1;

  var endIndex = null;

  while (s <= e) {
    m = Math.floor((s + e) * 0.5);
    if (rows.start(m) == range.end()) {
      endIndex = m;
      s = m + 1;
    } else if (rows.start(m) < range.end()) { s = m + 1; }
    else { e = m - 1; }
  }

  if (endIndex === null) { endIndex = s - 1; }

  var globalStartIndex = Math.max(startIndex + rows.globalStartIndex(), this.globalStartIndex());
  var globalEndIndex = Math.min(endIndex + rows.globalStartIndex(), this.globalStartIndex() + this.size() - 1);

  return {
    index: globalStartIndex - this.globalStartIndex(),
    length: globalEndIndex - globalStartIndex + 1
  };
};

// Input 164
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/8/13
 * Time: 2:34 PM
 */

goog.provide('epiviz.datatypes.GenomicArray');

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicRange} boundaries
 * @param {number} globalStartIndex
 * @param {*} values
 * @constructor
 */
epiviz.datatypes.GenomicArray = function(measurement, boundaries, globalStartIndex, values) {
  /**
   * @type {epiviz.measurements.Measurement}
   * @private
   */
  this._measurement = measurement;

  /**
   * @type {epiviz.datatypes.GenomicRange}
   * @private
   */
  this._boundaries = boundaries;

  /**
   * @type {?number}
   * @private
   */
  this._globalStartIndex = globalStartIndex;

  /**
   * @type {*}
   * @protected
   */
  this._values = values;
};

/**
 * @returns {epiviz.datatypes.GenomicRange}
 */
epiviz.datatypes.GenomicArray.prototype.boundaries = function() { return this._boundaries; };

/**
 * @returns {?number}
 */
epiviz.datatypes.GenomicArray.prototype.globalStartIndex = function() {
  return this._globalStartIndex;
};

/**
 * @returns {epiviz.measurements.Measurement}
 */
epiviz.datatypes.GenomicArray.prototype.measurement = function() {
  return this._measurement;
};

/**
 * @param {number} index
 * @returns {*}
 */
epiviz.datatypes.GenomicArray.prototype.get = function(index) { throw Error('unimplemented abstract method'); };

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicArray.prototype.size = function() { throw Error('unimplemented abstract method'); };

/**
 * @param {number} globalIndex
 * @returns {*}
 */
epiviz.datatypes.GenomicArray.prototype.getByGlobalIndex = function(globalIndex) {
  return this.get(globalIndex - this._globalStartIndex);
};

/**
 * @param {epiviz.datatypes.GenomicArray} second
 * @param {number} secondIndex
 * @returns {*}
 */
epiviz.datatypes.GenomicArray.prototype.concatValues = function(second, secondIndex) { throw Error('unimplemented abstract method'); };

/**
 * Factory method
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicRange} boundaries
 * @param {number} globalStartIndex
 * @param {*} values
 * @returns {epiviz.datatypes.GenomicArray}
 */
epiviz.datatypes.GenomicArray.prototype.createNew = function(measurement, boundaries, globalStartIndex, values) { throw Error('unimplemented abstract method'); };

/**
 * Merges two genomic arrays together by global index, eliminating common rows (where indices match)
 * IMPORTANT: This method fails if the given arrays are not overlapping or in continuation of one another
 * @param {epiviz.datatypes.GenomicArray} arr
 * @returns {epiviz.datatypes.GenomicArray}
 */
epiviz.datatypes.GenomicArray.prototype.merge = function(arr) {
  if (!arr || arr.boundaries() == undefined) {
    return this;
  }

  if (this.boundaries().seqName() != arr.boundaries().seqName() ||
    this.boundaries().start() > arr.boundaries().end() ||
    arr.boundaries().start() > this.boundaries().end()) {
    throw Error('Two genomic arrays can only be merged if they overlap or are in continuation to one another');
  }

  var first = (this.boundaries().start() < arr.boundaries().start()) ? this : arr;
  var second = (first == this) ? arr : this;

  if (first.boundaries().end() >= second.boundaries().end()) {
    // The first array contains the given array
    return first;
  }

  // Compute the index of the first element in the second array that isn't in the first as well;
  var secondIndex = (first.globalStartIndex() != undefined && second.globalStartIndex() != undefined) ?
    first.globalStartIndex() + first.size() - second.globalStartIndex() : 0;

  var
    measurement = first.measurement(),
    globalStartIndex = (first.globalStartIndex() != undefined) ? first.globalStartIndex() : second.globalStartIndex(),
    boundaries = epiviz.datatypes.GenomicRange.fromStartEnd(
      first.boundaries().seqName(),
      first.boundaries().start(),
      second.boundaries().end()),
    values = first.concatValues(second, secondIndex);

  return this.createNew(measurement, boundaries, globalStartIndex, values);
};

// Input 165
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/15/2015
 * Time: 4:52 PM
 */

goog.provide('epiviz.datatypes.MapGenomicData');

goog.require('epiviz.datatypes.GenomicData');
goog.require('epiviz.deferred.Deferred');


/**
 * @param {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.MeasurementGenomicData>} [map]
 * @constructor
 * @implements {epiviz.datatypes.GenomicData}
 */
epiviz.datatypes.MapGenomicData = function(map) {
  /**
   * @type {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.MeasurementGenomicData>}
   * @private
   */
  this._map = map;

  /**
   * @type {Array.<epiviz.measurements.Measurement>}
   * @private
   */
  this._measurements = map ? map.keys() : null;

  /**
   * @type {epiviz.deferred.Deferred}
   * @private
   */
  this._mapLoaded = new epiviz.deferred.Deferred();

  if (this._map) { this._mapLoaded.resolve(); }
};

/**
 * @param {function} callback
 */
epiviz.datatypes.MapGenomicData.prototype.ready = function(callback) {
  this._mapLoaded.done(callback);
};

/**
 * @returns {boolean}
 */
epiviz.datatypes.MapGenomicData.prototype.isReady = function() {
  return this._mapLoaded.state() == epiviz.deferred.Deferred.State.RESOLVED;
};

/**
 * @param {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.MeasurementGenomicData>} map
 * @protected
 */
epiviz.datatypes.MapGenomicData.prototype._setMap = function(map) {
  if (this._map) { throw Error('MapGenomicData is immutable'); }
  this._map = map;
  if (!map) { return; }
  this._measurements = map.keys();
  this._mapLoaded.resolve();
};

/**
 * @returns {epiviz.datatypes.MeasurementGenomicData}
 */
epiviz.datatypes.MapGenomicData.prototype.firstSeries = function() {
  if (this._map.size() == 0) { return null; }
  return this._map.first().value;
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {epiviz.datatypes.MeasurementGenomicData}
 */
epiviz.datatypes.MapGenomicData.prototype.getSeries = function(m) {
  return this._map.get(m);
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} i
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MapGenomicData.prototype.get = function(m, i) {
  var mItems = this._map.get(m);
  if (!mItems) { return null; }
  return mItems.get(i);
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} i
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MapGenomicData.prototype.getRow = function(m, i) {
  var mItems = this._map.get(m);
  if (!mItems) { return null; }
  return mItems.getRow(i);
};

/**
 * @returns {Array.<epiviz.measurements.Measurement>}
 */
epiviz.datatypes.MapGenomicData.prototype.measurements = function() {
  return this._measurements;
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {number}
 */
epiviz.datatypes.MapGenomicData.prototype.globalStartIndex = function(m) {
  var mItems = this._map.get(m);
  if (!mItems) { return null; }
  return mItems.globalStartIndex();
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {number}
 */
epiviz.datatypes.MapGenomicData.prototype.globalEndIndex = function(m) {
  var mItems = this._map.get(m);
  if (!mItems) { return null; }
  return mItems.globalEndIndex();
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {number}
 */
epiviz.datatypes.MapGenomicData.prototype.size = function(m) {
  var mItems = this._map.get(m);
  if (!mItems) { return null; }
  return mItems.size();
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MapGenomicData.prototype.getByGlobalIndex = function(m, globalIndex) {
  var mItems = this._map.get(m);
  if (!mItems) { return null; }
  return mItems.getByGlobalIndex(globalIndex);
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MapGenomicData.prototype.getRowByGlobalIndex = function(m, globalIndex) {
  var mItems = this._map.get(m);
  if (!mItems) { return null; }
  return mItems.getRowByGlobalIndex(globalIndex);
};

/**
 * Gets the first index and length of the rows that have start positions within the given range
 * @param {epiviz.measurements.Measurement} m
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {{index: ?number, length: number}}
 */
epiviz.datatypes.MapGenomicData.prototype.binarySearchStarts = function(m, range) {
  var mItems = this._map.get(m);
  if (!mItems) { return {index:null, length:0}; }
  return mItems.binarySearchStarts(range);
};

/**
 * Iterates through all pairs in the map, or until the given function returns something that
 * evaluates to true.
 * @param {function(epiviz.measurements.Measurement, epiviz.datatypes.MeasurementGenomicData, number=)} callback
 */
epiviz.datatypes.MapGenomicData.prototype.foreach = function(callback) {
  this._map.foreach(function(m, series, seriesIndex) {
    callback(m, series, seriesIndex);
  });
};


// Input 166
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/15/2015
 * Time: 5:42 PM
 */

goog.provide('epiviz.datatypes.MeasurementOrderedGenomicData');

goog.require('epiviz.datatypes.MapGenomicData');
goog.require('epiviz.deferred.Deferred');
goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.utils');

/**
 * @param {epiviz.datatypes.GenomicData} data
 * @param {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.measurements.Measurement, string|number>} order
 * @constructor
 * @extends {epiviz.datatypes.MapGenomicData}
 */
epiviz.datatypes.MeasurementOrderedGenomicData = function(data, order) {
  epiviz.datatypes.MapGenomicData.call(this);

  /**
   * @type {epiviz.datatypes.GenomicData}
   * @private
   */
  this._data = data;

  /**
   * @type {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.measurements.Measurement, string|number>}
   * @private
   */
  this._order = order;

  /**
   * @type {epiviz.deferred.Deferred}
   * @private
   */
  this._deferredInit = null;

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.datatypes.MeasurementOrderedGenomicData.prototype = epiviz.utils.mapCopy(epiviz.datatypes.MapGenomicData.prototype);
epiviz.datatypes.MeasurementOrderedGenomicData.constructor = epiviz.datatypes.MeasurementOrderedGenomicData;

/**
 * @returns {epiviz.deferred.Deferred}
 * @private
 */
epiviz.datatypes.MeasurementOrderedGenomicData.prototype._initialize = function() {

  if (this._deferredInit) { return this._deferredInit; }

  this._deferredInit = new epiviz.deferred.Deferred();

  var self = this;

  /** @type {epiviz.datatypes.GenomicData} */
  var data = this._data;

  /** @type {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.datatypes.GenomicData.ValueItem, boolean>} */
  var order = this._order;

  data.ready(function() {
    order.preMark()(data).done(function(preOrderVars) {
      /** @type {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.MeasurementGenomicData>} */
      var map = new epiviz.measurements.MeasurementHashtable();

      var measurements = data.measurements();
      var measurementLabels = new epiviz.measurements.MeasurementHashtable();
      epiviz.utils.deferredFor(measurements.length, function(j) {
        var mDeferredIteration = new epiviz.deferred.Deferred();
        var m = measurements[j];
        order.mark()(m, data, preOrderVars).done(function(label) {
          measurementLabels.put(m, label);
          mDeferredIteration.resolve();
        });
        return mDeferredIteration;
      }).done(function() {
        measurements.sort(function(m1, m2) {
          var v1 = measurementLabels.get(m1);
          var v2 = measurementLabels.get(m2);
          return (v1 == v2) ? 0 : (v1 < v2 ? -1 : 1);
        });

        measurements.forEach(function(m) {
          map.put(m, data.getSeries(m));
        });

        self._setMap(map);
        self._deferredInit.resolve();
      });
    });
  });

  return this._deferredInit;
};

// Input 167
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 6:01 PM
 */

goog.provide('epiviz.datatypes.GenomicRange');

/**
 * A genomic range to be used within EpiViz for requesting and displaying data.
 * IMPORTANT: Not to be confused with epiviz.datatypes.GenomicRanges.Row (an element
 * of GenomicRanges)
 * @param {string} seqname
 * @param {number} start
 * @param {number} width
 * @constructor
 * @implements {epiviz.datatypes.Range}
 */
epiviz.datatypes.GenomicRange = function(seqname, start, width) {

  if (width != undefined && width < 0) {
    width = -width;
    if (start != undefined) {
      start -= width;
    }
  }

  /**
   * @type {string}
   * @private
   */
  this._seqname = seqname;

  /**
   * @type {number}
   * @private
   */
  this._start = start;

  /**
   * @type {number}
   * @private
   */
  this._width = width;
};

/**
 * @param {string} seqname
 * @param {number} start
 * @param {number} end
 * @returns {epiviz.datatypes.GenomicRange}
 */
epiviz.datatypes.GenomicRange.fromStartEnd = function(seqname, start, end) {
  return new epiviz.datatypes.GenomicRange(seqname, start, (start != undefined && end != undefined) ? end - start : undefined);
};

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicRange.prototype.seqName = function() { return this._seqname; };

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicRange.prototype.start = function() { return this._start; };

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicRange.prototype.width = function() { return this._width; };

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicRange.prototype.end = function() { return (this._start != undefined && this._width != undefined) ? this._start + this._width : undefined; };

/**
 * @returns {boolean}
 */
epiviz.datatypes.GenomicRange.prototype.isEmpty = function() { return this._width <= 0; };

/**
 * @param {epiviz.datatypes.GenomicRange} other
 * @returns {Array.<epiviz.datatypes.GenomicRange>}
 */
epiviz.datatypes.GenomicRange.prototype.subtract = function(other) {
  if (!other || other.seqName() != this._seqname || other.isEmpty()
      || other.start() >= this.end() || this._start >= other.end()) {
    return [this];
  }

  if (other.start() <= this._start && other.end() >= this.end()) {
    return [];
  }

  if (other.start() > this._start && other.end() < this.end()) {
    return [
      epiviz.datatypes.GenomicRange.fromStartEnd(this._seqname, this._start, other.start()),
      epiviz.datatypes.GenomicRange.fromStartEnd(this._seqname, other.end(), this.end())
    ];
  }

  if (other.start() > this._start) {
    return [epiviz.datatypes.GenomicRange.fromStartEnd(this._seqname, this._start, other.start())];
  }

  // other.end() < this.end()
  return [epiviz.datatypes.GenomicRange.fromStartEnd(this._seqname, other.end(), this.end())];
};

/**
 * @param {epiviz.datatypes.GenomicRange} other
 * @returns {boolean}
 */
epiviz.datatypes.GenomicRange.prototype.equals = function(other) {
  if (!other) { return false; }

  if (other == this) { return true; }

  return (this._seqname == other._seqname && this._start == other._start && this._width == other._width);
};

/**
 * @param {epiviz.datatypes.GenomicRange} other
 * @returns {boolean}
 */
epiviz.datatypes.GenomicRange.prototype.overlapsWith = function(other) {
  if (!other) { return false; }
  if (this == other) { return true; }
  if (this.seqName() != other.seqName()) { return false; }
  return (this.start() < other.end() && this.end() > other.start());
};

/**
 * @returns {{seqName: string, start: number, width: number}}
 */
epiviz.datatypes.GenomicRange.prototype.raw = function() {
  return {
    seqName: this._seqname,
    start: this._start,
    width: this._width
  };
};

/**
 * @param {{seqName: string, start: number, width: number}} o
 * @returns {epiviz.datatypes.GenomicRange}
 */
epiviz.datatypes.GenomicRange.fromRawObject = function(o) {
  return new epiviz.datatypes.GenomicRange(o.seqName, o.start, o.width);
};

// Input 168
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/15/2015
 * Time: 2:20 PM
 */

goog.provide('epiviz.datatypes.GenomicData');

/**
 * @interface
 */
epiviz.datatypes.GenomicData = function() {};

/**
 * @param {function} callback Called when data is fully initialized and ready to be manipulated
 */
epiviz.datatypes.GenomicData.prototype.ready = function(callback) { throw Error('unimplemented abstract method'); };

/**
 * @returns {boolean}
 */
epiviz.datatypes.GenomicData.prototype.isReady = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {epiviz.datatypes.MeasurementGenomicData}
 */
epiviz.datatypes.GenomicData.prototype.firstSeries = function() { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {epiviz.datatypes.MeasurementGenomicData}
 */
epiviz.datatypes.GenomicData.prototype.getSeries = function(m) { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} i
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.GenomicData.prototype.get = function(m, i) { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} i
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.GenomicData.prototype.getRow = function(m, i) { throw Error('unimplemented abstract method'); };

/**
 * @returns {Array.<epiviz.measurements.Measurement>}
 */
epiviz.datatypes.GenomicData.prototype.measurements = function() { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {number}
 */
epiviz.datatypes.GenomicData.prototype.globalStartIndex = function(m) { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {number}
 */
epiviz.datatypes.GenomicData.prototype.globalEndIndex = function(m) { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {number}
 */
epiviz.datatypes.GenomicData.prototype.size = function(m) { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.GenomicData.prototype.getByGlobalIndex = function(m, globalIndex) { throw Error('unimplemented abstract method'); };

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.GenomicData.prototype.getRowByGlobalIndex = function(m, globalIndex) { throw Error('unimplemented abstract method'); };

/**
 * Gets the first index and length of the rows that have start positions within the given range
 * @param {epiviz.measurements.Measurement} m
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {{index: ?number, length: number}}
 */
epiviz.datatypes.GenomicData.prototype.binarySearchStarts = function(m, range) { throw Error('unimplemented abstract method'); };

/**
 * Iterates through all pairs in the map, or until the given function returns something that
 * evaluates to true.
 * @param {function(epiviz.measurements.Measurement, epiviz.datatypes.MeasurementGenomicData, number=)} callback
 */
epiviz.datatypes.GenomicData.prototype.foreach = function(callback) { throw Error('unimplemented abstract method'); };


goog.provide('epiviz.datatypes.GenomicData.ValueItem');


/**
 * @param {number} globalIndex
 * @param {epiviz.datatypes.GenomicData.RowItem} rowItem
 * @param {?number} [value]
 * @param {epiviz.measurements.Measurement} measurement
 * @param {Object.<string, *>} [valueAnnotation]
 * @constructor
 * @struct
 */
epiviz.datatypes.GenomicData.ValueItem = function(globalIndex, rowItem, value, measurement, valueAnnotation) {
  /**
   * @type {number}
   */
  this.globalIndex = globalIndex;

  /**
   * @type {epiviz.datatypes.GenomicData.RowItem}
   */
  this.rowItem = rowItem;

  /**
   * @type {number}
   */
  this.value = (value === 0 || value) ? value : null;

  /**
   * @type {epiviz.measurements.Measurement}
   */
  this.measurement = measurement;

  /**
   * @type {?Object.<string, *>}
   */
  this.valueAnnotation = valueAnnotation;
};


goog.provide('epiviz.datatypes.GenomicData.RowItem');

/**
 * @interface
 */
epiviz.datatypes.GenomicData.RowItem = function() {};

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.id = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.seqName = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.start = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.end = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.globalIndex = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.strand = function() { throw Error('unimplemented abstract method'); };

/**
 * @param {string} column
 * @returns {*}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.metadata = function(column) { throw Error('unimplemented abstract method'); };

/**
 * @returns {Object.<string, *>}
 */
epiviz.datatypes.GenomicData.RowItem.prototype.rowMetadata = function() { throw Error('unimplemented abstract method'); };

// Input 169
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/15/2015
 * Time: 1:32 PM
 */

goog.provide('epiviz.datatypes.MeasurementGenomicData');

/**
 * @interface
 */
epiviz.datatypes.MeasurementGenomicData = function() {};

/**
 * @param {number} index
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.get = function(index) { throw Error('unimplemented abstract method'); };

/**
 * @param {number} index
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.getRow = function(index) { throw Error('unimplemented abstract method'); };

/**
 * @returns {epiviz.measurements.Measurement}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.measurement = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.globalStartIndex = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.globalEndIndex = function() { throw Error('unimplemented abstract method'); };


/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.size = function() { throw Error('unimplemented abstract method'); };

/**
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.getByGlobalIndex = function(globalIndex) { throw Error('unimplemented abstract method'); };

/**
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.getRowByGlobalIndex = function(globalIndex) { throw Error('unimplemented abstract method'); };

/**
 * Gets the first index and length of the rows that have start positions within the given range
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {{index: ?number, length: number}}
 */
epiviz.datatypes.MeasurementGenomicData.prototype.binarySearchStarts = function(range) { throw Error('unimplemented abstract method'); };

// Input 170
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/16/2015
 * Time: 1:12 PM
 */

goog.provide('epiviz.datatypes.RowItemImpl');

/**
 * @param {string} id
 * @param {string} seqName
 * @param {number} start
 * @param {number} end
 * @param {number} globalIndex
 * @param {string} strand
 * @param {Object.<string, *>} rowMetadata
 * @constructor
 * @implements {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.RowItemImpl = function(id, seqName, start, end, globalIndex, strand, rowMetadata) {
  /**
   * @type {string}
   * @private
   */
  this._id = id;

  /**
   * @type {string}
   * @private
   */
  this._seqName = seqName;

  /**
   * @type {number}
   * @private
   */
  this._start = start;

  /**
   * @type {number}
   * @private
   */
  this._end = end;

  /**
   * @type {number}
   * @private
   */
  this._globalIndex = globalIndex;

  /**
   * @type {string}
   * @private
   */
  this._strand = strand;

  /**
   * @type {Object.<string, *>}
   * @private
   */
  this._rowMetadata = rowMetadata;
};

/**
 * @returns {string}
 */
epiviz.datatypes.RowItemImpl.prototype.id = function() { return this._id; };

/**
 * @returns {string}
 */
epiviz.datatypes.RowItemImpl.prototype.seqName = function() { return this._seqName; };

/**
 * @returns {number}
 */
epiviz.datatypes.RowItemImpl.prototype.start = function() { return this._start; };

/**
 * @returns {number}
 */
epiviz.datatypes.RowItemImpl.prototype.end = function() { return this._end; };

/**
 * @returns {number}
 */
epiviz.datatypes.RowItemImpl.prototype.globalIndex = function() { return this._globalIndex; };

/**
 * @returns {string}
 */
epiviz.datatypes.RowItemImpl.prototype.strand = function() { return this._strand; };

/**
 * @param {string} column
 * @returns {*}
 */
epiviz.datatypes.RowItemImpl.prototype.metadata = function(column) {
  var ret = this._rowMetadata[column];
  if (ret == undefined) { return null; }
  return ret;
};

/**
 * @returns {Object.<string, *>}
 */
epiviz.datatypes.RowItemImpl.prototype.rowMetadata = function() { return this._rowMetadata; };


// Input 171
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/2/2014
 * Time: 5:31 PM
 */

goog.provide('epiviz.datatypes.Range');

/**
 * @interface
 */
epiviz.datatypes.Range = function() {};

// Input 172
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/1/13
 * Time: 12:05 PM
 */

goog.provide('epiviz.datatypes.PartialSummarizedExperiment');

goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.measurements.Measurement.Type');

/**
 * @constructor
 */
epiviz.datatypes.PartialSummarizedExperiment = function() {
  /**
   * @type {?epiviz.datatypes.GenomicRangeArray}
   * @private
   */
  this._rowData = null;

  /**
   * @type {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.FeatureValueArray>}
   * @private
   */
  this._values = new epiviz.measurements.MeasurementHashtable();

};

/**
 * @returns {epiviz.datatypes.GenomicRangeArray}
 */
epiviz.datatypes.PartialSummarizedExperiment.prototype.ranges = function() { return this.rowData(); };

/**
 * @returns {?epiviz.datatypes.GenomicRangeArray}
 */
epiviz.datatypes.PartialSummarizedExperiment.prototype.rowData = function() {
  return this._rowData;
};

/**
 * @param {epiviz.datatypes.GenomicRangeArray} rowData
 */
epiviz.datatypes.PartialSummarizedExperiment.prototype.addRowData = function(rowData) {
  if (!rowData) {
    return;
  }
  if (!this._rowData ||
    this._rowData.boundaries().seqName() != rowData.boundaries().seqName() ||
    this._rowData.boundaries().start() > rowData.boundaries().end() ||
    this._rowData.boundaries().end() < rowData.boundaries().start() ||
    rowData.measurement().type() == epiviz.measurements.Measurement.Type.UNORDERED) {
    this._rowData = rowData;
    return;
  }

  this._rowData = this._rowData.merge(rowData);
};

/**
 * @param {epiviz.datatypes.FeatureValueArray} values
 */
epiviz.datatypes.PartialSummarizedExperiment.prototype.addValues = function(values) {
  if (!values) {
    return;
  }
  var currentValues = this._values.get(values.measurement());
  if (!currentValues ||
    currentValues.boundaries().seqName() != values.boundaries().seqName() ||
    currentValues.boundaries().start() > values.boundaries().end() ||
    currentValues.boundaries().end() < values.boundaries().start() ||
    values.measurement().type() == epiviz.measurements.Measurement.Type.UNORDERED) {
    this._values.put(values.measurement(), values);
    return;
  }

  this._values.put(values.measurement(), currentValues.merge(values));
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {epiviz.datatypes.PartialSummarizedExperiment}
 */
epiviz.datatypes.PartialSummarizedExperiment.prototype.trim = function (range) {
  var result = new epiviz.datatypes.PartialSummarizedExperiment();
  if (this._rowData) {
    result.addRowData(this._rowData.trim(range));
  }

  if (result.rowData()) {
    this._values.foreach(function (m, featureValueArray) {
      result.addValues(featureValueArray.trim(range, result.rowData().globalStartIndex(), result.rowData().size()));
    });
  }

  return result;
};

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @returns {epiviz.datatypes.FeatureValueArray}
 */
epiviz.datatypes.PartialSummarizedExperiment.prototype.values = function(measurement) {
  return this._values.get(measurement);
};

/**
 * Gets the first global index contained in either the rows or one of the value
 * columns loaded so far (inclusive)
 * @returns {?number}
 */
epiviz.datatypes.PartialSummarizedExperiment.prototype.calcMinGlobalIndex = function() {
  var minGlobalIndex = this._rowData ? this._rowData.globalStartIndex() : null;

  if (this._values) {
    this._values.foreach(function(m, valuesArray) {
      if (valuesArray && valuesArray.globalStartIndex() != undefined && (minGlobalIndex == undefined || minGlobalIndex > valuesArray.globalStartIndex())) {
        minGlobalIndex = valuesArray.globalStartIndex();
      }
    });
  }

  return minGlobalIndex;
};

/**
 * Gets the last global index contained in either the rows or one of the value
 * columns loaded so far (exclusive)
 * @returns {?number}
 */
epiviz.datatypes.PartialSummarizedExperiment.prototype.calcMaxGlobalIndex = function() {
  var maxGlobalIndex = (this._rowData && this._rowData.globalStartIndex() != undefined) ? this._rowData.globalStartIndex() + this._rowData.size() : null;

  if (this._values) {
    this._values.foreach(function(m, valuesArray) {
      if (valuesArray && valuesArray.globalStartIndex() != undefined && (maxGlobalIndex == undefined || maxGlobalIndex < valuesArray.globalStartIndex() + valuesArray.size())) {
        maxGlobalIndex = valuesArray.globalStartIndex() + valuesArray.size();
      }
    });
  }

  return maxGlobalIndex;
};

/**
 * @returns {string}
 */
epiviz.datatypes.PartialSummarizedExperiment.prototype.toString = function() {

  var result = '';
  var minGlobalIndex = this.calcMinGlobalIndex();
  var maxGlobalIndex = this.calcMaxGlobalIndex();

  result += sprintf('%25s', this._rowData && this._rowData.measurement() ? this._rowData.measurement().name().substr(0, 22) : '[undefined datasource]');
  var chr, start, end, rowGlobalIndex, rowSize;
  if (this._rowData && this._rowData.boundaries()) {
    chr = this._rowData.boundaries().seqName();
    start = this._rowData.boundaries().start();
    end = this._rowData.boundaries().end();
    rowGlobalIndex = this._rowData.globalStartIndex() != undefined ? this._rowData.globalStartIndex() : '*';
    rowSize = this._rowData.size();
  } else {
    chr = start = end = rowGlobalIndex = '*';
    rowSize = 0;
  }
  result += sprintf(' [%6s%10s%10s] [globalStartIndex: %10s] [size: %7s]\n', chr, start, end, rowGlobalIndex, rowSize);

  var header = sprintf('%15s%15s%15s%15s%15s', 'id', 'idx', 'chr', 'start', 'end');
  if (this._values) {
    this._values.foreach(function(m, valuesArray) {
      result += sprintf('%25s', m.name().substr(0, 22));
      if (valuesArray && valuesArray.boundaries()) {
        chr = valuesArray.boundaries().seqName();
        start = valuesArray.boundaries().start();
        end = valuesArray.boundaries().end();
      } else {
        chr = start = end = '*';
      }
      result += sprintf(' [%6s%10s%10s] [globalStartIndex: %10s] [size: %7s]\n', chr, start, end, valuesArray.globalStartIndex() != undefined ? valuesArray.globalStartIndex() : '*', valuesArray.size());
      header += sprintf('%25s', m.name().substr(0, 22));
    });
  }
  result += header + '\n';

  for (var globalIndex = minGlobalIndex; globalIndex < maxGlobalIndex; ++globalIndex) {
    var id;
    if (this._rowData && this._rowData.globalStartIndex() != undefined && this._rowData.globalStartIndex() <= globalIndex && this._rowData.globalStartIndex() + this._rowData.size() > globalIndex) {
      var row = this._rowData.getByGlobalIndex(globalIndex);

      id = row.id();
      chr = row.seqName();
      start = row.start();
      end = row.end();
    } else {
      id = chr = start = end = '*';
    }
    result += sprintf('%15s%15s%15s%15s%15s', id, globalIndex, chr, start, end);
    if (this._values) {
      this._values.foreach(function(m, valuesArray) {
        if (valuesArray && valuesArray.globalStartIndex() != undefined && valuesArray.globalStartIndex() <= globalIndex && valuesArray.globalStartIndex() + valuesArray.size() > globalIndex) {
          result += sprintf('%25s', valuesArray.getByGlobalIndex(globalIndex));
        } else {
          result += sprintf('%25s', '*');
        }
      });
    }

    result += '\n';
  }

  return result;
};

// Input 173
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/16/2015
 * Time: 10:56 AM
 */

goog.provide('epiviz.datatypes.MeasurementAggregatedGenomicData');

goog.require('epiviz.datatypes.MapGenomicData');
goog.require('epiviz.deferred.Deferred');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.utils');
goog.require('epiviz.datatypes.MeasurementGenomicDataArrayWrapper');
goog.require('epiviz.datatypes.GenomicData.ValueItem');
goog.require('epiviz.datatypes.RowItemImpl');

/**
 * @param {epiviz.datatypes.GenomicData} data
 * @param {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.measurements.Measurement, string>} groupByMarker
 * @param {epiviz.ui.charts.markers.MeasurementAggregator} aggregator
 * @constructor
 * @extends {epiviz.datatypes.MapGenomicData}
 */
epiviz.datatypes.MeasurementAggregatedGenomicData = function(data, groupByMarker, aggregator) {
  epiviz.datatypes.MapGenomicData.call(this);

  /**
   * @type {epiviz.datatypes.GenomicData}
   * @private
   */
  this._data = data;

  /**
   * @type {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.measurements.Measurement, string>}
   * @private
   */
  this._groupByMarker = groupByMarker;

  /**
   * @type {epiviz.ui.charts.markers.MeasurementAggregator}
   * @private
   */
  this._aggregator = aggregator;

  /**
   * @type {epiviz.deferred.Deferred}
   * @private
   */
  this._deferredInit = null;

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.datatypes.MeasurementAggregatedGenomicData.prototype = epiviz.utils.mapCopy(epiviz.datatypes.MapGenomicData.prototype);
epiviz.datatypes.MeasurementAggregatedGenomicData.constructor = epiviz.datatypes.MeasurementAggregatedGenomicData;

/**
 * @returns {epiviz.deferred.Deferred}
 * @private
 */
epiviz.datatypes.MeasurementAggregatedGenomicData.prototype._initialize = function() {
  if (this._deferredInit) { return this._deferredInit; }

  this._deferredInit = new epiviz.deferred.Deferred();

  var self = this;

  /** @type {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.measurements.Measurement, string>} */
  var groupBy = this._groupByMarker;

  /** @type {epiviz.datatypes.GenomicData} */
  var data = this._data;

  data.ready(function() {
    groupBy.preMark()(data).done(function(preGroupVars) {
      /** @type {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.MeasurementGenomicData>} */
      var map = new epiviz.measurements.MeasurementHashtable();

      /** @type {Object.<string, Array.<epiviz.measurements.Measurement>>} */
      var grouped = {};

      var measurements = data.measurements();

      epiviz.utils.deferredFor(measurements.length, function(j) {
        var mDeferredIteration = new epiviz.deferred.Deferred();
        var m = measurements[j];
        groupBy.mark()(m, data, preGroupVars).done(function(groupLabel) {
          if (!(groupLabel in grouped)) {
            grouped[groupLabel] = [];
          }
          grouped[groupLabel].push(m);
          mDeferredIteration.resolve();
        });
        return mDeferredIteration;
      }).done(function() {
        var labelMeasurements = {};
        var label;
        /** @type {Array.<epiviz.measurements.Measurement>} */
        var ms;
        for (label in grouped) {
          if (!grouped.hasOwnProperty(label)) { continue; }

          ms = grouped[label];
          var id = label + '-group',
            name = label,
            type = ms[0].type(),
            datasourceId = ms[0].datasourceId(),
            datasourceGroup = ms[0].datasourceGroup(),
            dataprovider = ms[0].dataprovider(),
            defaultChartType = ms[0].defaultChartType(),
            annotation = epiviz.utils.mapCopy(ms[0].annotation()),
            minValue = ms[0].minValue(),
            maxValue = ms[0].maxValue(),
            metadata = ms[0].metadata();
          var metadataColsMap = {};
          metadata.forEach(function(c) { metadataColsMap[c] = c; });
          grouped[label].forEach(function(m) {
            if (datasourceId != m.datasourceId()) { datasourceId = '*'; }
            if (datasourceGroup != m.datasourceGroup()) { datasourceGroup = '*'; }
            if (dataprovider != m.dataprovider()) { dataprovider = '*'; }
            if (defaultChartType != m.defaultChartType()) { defaultChartType = '*'; }

            var mAnno = m.annotation();
            if (annotation != mAnno) {
              if (annotation == undefined) { annotation = epiviz.utils.mapCopy(mAnno); }
              else if (mAnno != undefined) {
                for (var k in mAnno) {
                  if (!mAnno.hasOwnProperty(k)) { continue; }
                  if (!(k in annotation)) { annotation[k] = mAnno[k]; continue; }
                  if (annotation[k] != mAnno[k]) { annotation[k] = '*'; }
                }
              }
            }
            minValue = Math.min(minValue, m.minValue());
            maxValue = Math.max(maxValue, m.maxValue());

            m.metadata().forEach(function(c) {
              if (!(c in metadataColsMap)) {
                metadataColsMap[c] = c;
                metadata.push(c);
              }
            });
          });
          labelMeasurements[label] = new epiviz.measurements.Measurement(id, name, type, datasourceId, datasourceGroup, dataprovider, null, defaultChartType, annotation, minValue, maxValue, metadata);
        }

        for (label in grouped) {
          if (!grouped.hasOwnProperty(label)) { continue; }
          var m = labelMeasurements[label];
          var items = [];
          var itemsByGlobalIndex = {};
          ms = grouped[label];
          var globalStartIndex = Math.min.apply(undefined, ms.map(function(m) { return data.globalStartIndex(m); }));
          var globalEndIndex = Math.max.apply(undefined, ms.map(function(m) { return data.globalEndIndex(m); }));
          for (var globalIndex = globalStartIndex; globalIndex < globalEndIndex; ++globalIndex) {
            /** @type {Array.<epiviz.datatypes.GenomicData.ValueItem>} */
            var indexItems = ms
              .map(function(m) { return data.getByGlobalIndex(m, globalIndex); })
              .filter(function(item) { return item; });
            if (!indexItems.length) { continue; }
            var values = indexItems
              .map(function(item) { return item.value; });
            var aggregation = self._aggregator.aggregate(label, ms, values);
            var row = indexItems[0].rowItem;
            var aggRow = new epiviz.datatypes.RowItemImpl(row.id(), row.seqName(), row.start(), row.end(), row.globalIndex(), row.strand(),
              row.rowMetadata() || {});
            var item = new epiviz.datatypes.GenomicData.ValueItem(globalIndex, aggRow, aggregation.value, m, {errMinus:aggregation.errMinus, errPlus:aggregation.errPlus});
            items.push(item);
            itemsByGlobalIndex[globalIndex] = item;
          }
          var series = new epiviz.datatypes.MeasurementGenomicDataArrayWrapper(m, items, itemsByGlobalIndex);
          map.put(m, series);
        }

        self._setMap(map);
        self._deferredInit.resolve();
      });
    });
  });

  return this._deferredInit;
};

// goog.inherits(epiviz.datatypes.MeasurementAggregatedGenomicData, epiviz.datatypes.MapGenomicData);

// Input 174
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/15/2015
 * Time: 1:56 PM
 */

goog.provide('epiviz.datatypes.ItemFilteredGenomicData');

goog.require('epiviz.datatypes.MapGenomicData');
goog.require('epiviz.utils');
goog.require('epiviz.deferred.Deferred');
goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.datatypes.MeasurementGenomicDataArrayWrapper');

/**
 * @param {epiviz.datatypes.GenomicData} data
 * @param {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.datatypes.GenomicData.ValueItem, boolean>} filter
 * @constructor
 * @extends {epiviz.datatypes.MapGenomicData}
 */
epiviz.datatypes.ItemFilteredGenomicData = function(data, filter) {
  epiviz.datatypes.MapGenomicData.call(this);

  /**
   * @type {epiviz.datatypes.GenomicData}
   * @private
   */
  this._data = data;

  /**
   * @type {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.datatypes.GenomicData.ValueItem, boolean>}
   * @private
   */
  this._filter = filter;

  /**
   * @type {epiviz.deferred.Deferred}
   * @private
   */
  this._deferredInit = null;

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.datatypes.ItemFilteredGenomicData.prototype = epiviz.utils.mapCopy(epiviz.datatypes.MapGenomicData.prototype);
epiviz.datatypes.ItemFilteredGenomicData.constructor = epiviz.datatypes.ItemFilteredGenomicData;

/**
 * @returns {epiviz.deferred.Deferred}
 * @private
 */
epiviz.datatypes.ItemFilteredGenomicData.prototype._initialize = function() {

  if (this._deferredInit) { return this._deferredInit; }

  this._deferredInit = new epiviz.deferred.Deferred();

  var self = this;

  /** @type {epiviz.ui.charts.markers.VisualizationMarker.<epiviz.datatypes.GenomicData, *, epiviz.datatypes.GenomicData.ValueItem, boolean>} */
  var filter = this._filter;

  /** @type {epiviz.datatypes.GenomicData} */
  var data = this._data;

  data.ready(function() {
    filter.preMark()(data).done(function(preFilterVars) {
      /** @type {epiviz.measurements.MeasurementHashtable.<epiviz.datatypes.MeasurementGenomicData>} */
      var map = new epiviz.measurements.MeasurementHashtable();

      var measurements = data.measurements();

      epiviz.utils.deferredFor(measurements.length, function(j) {
        var mDeferredIteration = new epiviz.deferred.Deferred();
        var m = measurements[j];
        var mItems = [];
        var mItemsByGlobalIndex = {};

        epiviz.utils.deferredFor(data.size(m), function(i) {
          var dataDeferredIteration = new epiviz.deferred.Deferred();
          var item = data.get(m, i);
          filter.mark()(item, data, preFilterVars).done(function(markResult) {
            if (markResult) {
              mItems.push(item);
              mItemsByGlobalIndex[item.globalIndex] = item;
            }
            dataDeferredIteration.resolve();
          });
          return dataDeferredIteration;
        }).done(function() {
          map.put(m, new epiviz.datatypes.MeasurementGenomicDataArrayWrapper(m, mItems, mItemsByGlobalIndex));
          mDeferredIteration.resolve();
        });

        return mDeferredIteration;
      }).done(function() {
        self._setMap(map);
        self._deferredInit.resolve();
      });
    });
  });

  return this._deferredInit;
};

// goog.inherits(epiviz.datatypes.ItemFilteredGenomicData, epiviz.datatypes.MapGenomicData);

// Input 175
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/15/2015
 * Time: 3:05 PM
 */

goog.provide('epiviz.datatypes.MeasurementGenomicDataArrayWrapper');

goog.require('epiviz.datatypes.MeasurementGenomicData');

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {Array.<epiviz.datatypes.GenomicData.ValueItem>} items
 * @param {Object.<number, epiviz.datatypes.GenomicData.ValueItem>} itemsByGlobalIndex
 * @constructor
 * @implements {epiviz.datatypes.MeasurementGenomicData}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper = function(measurement, items, itemsByGlobalIndex) {
  /**
   * @type {epiviz.measurements.Measurement}
   * @private
   */
  this._measurement = measurement;

  /**
   * @type {Array.<epiviz.datatypes.GenomicData.ValueItem>}
   * @private
   */
  this._items = items;

  /**
   * @type {Object.<number, epiviz.datatypes.GenomicData.ValueItem>}
   * @private
   */
  this._itemsByGlobalIndex = itemsByGlobalIndex;
};

/**
 * @param {number} index
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.get = function(index) {
  return (this._items && index >= 0 && index < this._items.length) ? this._items[index] : null;
};

/**
 * @param {number} index
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.getRow = function(index) {
  return (this._items && index >= 0 && index < this._items.length) ? this._items[index].rowItem : null;
};

/**
 * @returns {epiviz.measurements.Measurement}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.measurement = function() {
  return this._measurement;
};

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.globalStartIndex = function() {
  return (this._items && this._items.length) ? this._items[0].globalIndex : null;
};

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.globalEndIndex = function() {
  return (this._items && this._items.length) ? this._items[this._items.length - 1].globalIndex + 1 : null;
};

/**
 * @returns {number}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.size = function() {
  return (this._items) ? this._items.length : 0;
};

/**
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.ValueItem}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.getByGlobalIndex = function(globalIndex) {
  return (this._itemsByGlobalIndex && (globalIndex in this._itemsByGlobalIndex)) ? this._itemsByGlobalIndex[globalIndex] : null;
};

/**
 * @param {number} globalIndex
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.getRowByGlobalIndex = function(globalIndex) {
  return (this._itemsByGlobalIndex && (globalIndex in this._itemsByGlobalIndex)) ? this._itemsByGlobalIndex[globalIndex].rowItem : null;
};

/**
 * TODO: Test to check correctness
 * Gets the first index and length of the rows that have start positions within the given range
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {{index: ?number, length: number}}
 */
epiviz.datatypes.MeasurementGenomicDataArrayWrapper.prototype.binarySearchStarts = function(range) {
  if (!this._items || !this._items.length ||
      this._items[0].rowItem.start() > range.end() ||
      this._items[this._items.length - 1].rowItem.start() < range.start()) {
    return {index:null, length:0};
  }

  // Perform binary search to find the start row index

  var s = 0, e = this._items.length - 1;
  var m;

  var startIndex = null;

  while (s <= e) {
    m = Math.floor((s + e) * 0.5);
    if (this._items[m].rowItem.start() == range.start()) {
      startIndex = m;
      e = m - 1;
    } else if (this._items[m].rowItem.start() < range.start()) { s = m + 1; }
    else { e = m - 1; }
  }

  if (startIndex === null) { startIndex = s; }

  // Perform binary search to find the end row index

  s = 0;
  e = this._items.length - 1;

  var endIndex = null;

  while (s <= e) {
    m = Math.floor((s + e) * 0.5);
    if (this._items[m].rowItem.start() == range.end()) {
      endIndex = m;
      s = m + 1;
    } else if (this._items[m].rowItem.start() < range.end()) { s = m + 1; }
    else { e = m - 1; }
  }

  if (endIndex === null) { endIndex = s - 1; }

  return {
    index: startIndex,
    length: endIndex + 1 - startIndex
  };
};


// Input 176
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/1/13
 * Time: 10:26 AM
 */

goog.provide('epiviz.datatypes.GenomicRangeArray');

goog.require('epiviz.datatypes.GenomicArray');
goog.require('epiviz.datatypes.GenomicRange');
goog.require('epiviz.utils');

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicRange} boundaries
 * @param {number} globalStartIndex
 * @param {{id: Array.<string>, start: Array.<number>, end: Array.<number>, strand: Array.<string>|string, metadata: Object.<string, Array>}} values
 * @param {boolean} [useOffset] True if the values are compressed and false/undefined/null otherwise
 * @constructor
 * @implements {epiviz.utils.Iterable}
 * @extends {epiviz.datatypes.GenomicArray}
 */
epiviz.datatypes.GenomicRangeArray = function(measurement, boundaries, globalStartIndex, values, useOffset) {

  epiviz.datatypes.GenomicArray.call(this, measurement, boundaries, globalStartIndex, values);

  /**
   * @type {Array.<string>}
   * @private
   */
  this._id = values.id;

  /**
   * @type {Array.<number>}
   * @private
   */
  this._start = values.start;

  /**
   * @type {Array.<number>}
   * @private
   */
  this._end = values.end;

  /**
   * @type {Array.<string>|string}
   * @private
   */
  this._strand = values.strand || null;

  /**
   * @type {Object.<string, Array>}
   * @private
   */
  this._metadata = values.metadata;

  /**
   * @type {?number}
   * @private
   */
  this._size = null;

  // If useOffset is true, it means that the values in the start/end arrays are compressed, and each value
  // in the array (with the exception of the first) is the offset between the real value and the previous one.
  // If the values are compressed, here we decompress them:
  if (useOffset) {
    var i;
    for (i = 1; i < this._start.length; ++i) {
      this._start[i] += this._start[i - 1];

      if (this._end) { this._end[i] += this._end[i - 1]; }
    }
  }
};

/**
 * Copy methods from upper class
 */
epiviz.datatypes.GenomicRangeArray.prototype = epiviz.utils.mapCopy(epiviz.datatypes.GenomicArray.prototype);
epiviz.datatypes.GenomicRangeArray.constructor = epiviz.datatypes.GenomicRangeArray;

/**
 * @param {epiviz.measurements.Measurement} measurement
 * @param {epiviz.datatypes.GenomicRange} boundaries
 * @param {number} globalStartIndex
 * @param {{id: Array.<string>, start: Array.<number>, end: Array.<number>, strand: Array.<string>|string, metadata: Object.<string, Array>}} values
 * @returns {epiviz.datatypes.GenomicArray}
 * @override
 */
epiviz.datatypes.GenomicRangeArray.prototype.createNew = function(measurement, boundaries, globalStartIndex, values) {
  return new epiviz.datatypes.GenomicRangeArray(measurement, boundaries, globalStartIndex, values);
};

/**
 * @param {number} i a numeric index of the row
 * @returns {epiviz.datatypes.GenomicData.RowItem}
 * @override
 */
epiviz.datatypes.GenomicRangeArray.prototype.get = function(i) {
  if (i < 0 || i >= this.size()) { return null; }

  return new epiviz.datatypes.GenomicRangeArray.RowItemWrapper(this, i);
};

/**
 * @returns {number} the total number of items in the structure
 * @override
 */
epiviz.datatypes.GenomicRangeArray.prototype.size = function() {
  if (this._size == undefined) {
    var size = Math.max(
      this._id ? this._id.length : 0,
      this._start ? this._start.length : 0,
      this._end ? this._end.length : 0,
      (this._metadata && Object.keys(this._metadata).length) ?
        Math.max.apply(undefined, $.map(this._metadata, function(col) { return col.length; })) : 0);
    this._size = size;
  }
  return this._size;
};

/**
 * @param {epiviz.datatypes.GenomicRangeArray} second
 * @param {number} secondIndex
 * @returns {{id: Array.<string>, start: Array.<number>, end: Array.<number>, strand: Array.<string>|string, metadata: Object.<string, Array>}}
 */
epiviz.datatypes.GenomicRangeArray.prototype.concatValues = function(second, secondIndex) {
  var strand = null;
  if (!Array.isArray(this._strand) && !Array.isArray(second._strand) && this._strand == second._strand) {
    strand = this._strand;
  } else {
    var
      firstStrand = Array.isArray(this._strand) ? this._strand : epiviz.utils.fillArray(this.size(), this._strand),
      secondStrand = Array.isArray(second._strand) ? second._strand : epiviz.utils.fillArray(second.size(), second._strand);
    strand = firstStrand.concat(secondStrand.slice(secondIndex))
  }

  var
    id = this._id ? this._id.concat(second._id.slice(secondIndex)) : null,
    start = this._start.concat(second._start.slice(secondIndex)),
    end = this._end ? this._end.concat(second._end.slice(secondIndex)) : null;

  // Concatenate metadata values. We assume that both structures have the same columns
  var metadata = {};
  for (var col in this._metadata) {
    if (!this._metadata.hasOwnProperty(col)) { continue; }
    metadata[col] = this._metadata[col].concat(second._metadata[col].slice(secondIndex));
  }

  return {
    id: id,
    start: start,
    end: end,
    strand: strand,
    metadata: metadata
  };
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @returns {?epiviz.datatypes.GenomicRangeArray}
 */
epiviz.datatypes.GenomicRangeArray.prototype.trim = function(range) {
  if (this.globalStartIndex() == undefined || !this.size() || !range || !this.boundaries() || this.boundaries().seqName() != range.seqName()) {
    return null;
  }

  var start = Math.max(this.boundaries().start(), range.start());
  var end = Math.min(this.boundaries().end(), range.end());
  if (end <= start) { return null; }
  range = epiviz.datatypes.GenomicRange.fromStartEnd(range.seqName(), start, end);

  var startIndex = -1;
  var endIndex = -1;
  for (var i = 0; i < this.size(); ++i) {
    if (startIndex < 0 && this.end(i) >= range.start()) { startIndex = i; }
    if (this._start[i] < range.end()) { endIndex = i + 1; }
  }
  if (endIndex <= startIndex) { return null; }

  var values, globalStartIndex;
  var col;

  if (startIndex >= 0 && endIndex >= startIndex) {
    values = {
      id: this._id ? this._id.slice(startIndex, endIndex) : null,
      start: this._start.slice(startIndex, endIndex),
      end: this._end ? this._end.slice(startIndex, endIndex) : null,
      strand: Array.isArray(this._strand) ? this._strand.slice(startIndex, endIndex) : this._strand,
      metadata: {}
    };
    for (col in this._metadata) {
      if (!this._metadata.hasOwnProperty(col)) { continue; }
      values.metadata[col] = this._metadata[col].slice(startIndex, endIndex);
    }
    globalStartIndex = this.globalStartIndex() + startIndex;
  } else {
    values = {
      id: this._id ? [] : null,
      start: [],
      end: this._end ? [] : null,
      strand: Array.isArray(this._strand) ? [] : this._strand,
      metadata: {}
    };
    for (col in this._metadata) {
      if (!this._metadata.hasOwnProperty(col)) { continue; }
      values.metadata[col] = [];
    }
    globalStartIndex = null;
  }

  return new epiviz.datatypes.GenomicRangeArray(this.measurement(), range, globalStartIndex, values);
};

/**
 * @returns {epiviz.datatypes.GenomicRangeArray}
 */
epiviz.datatypes.GenomicRangeArray.prototype.ranges = function() { return this; };

/**
 * Iterates through all genomic ranges until func returns something that evaluates to true
 * @param {function(epiviz.datatypes.GenomicData.RowItem)} func
 */
epiviz.datatypes.GenomicRangeArray.prototype.foreach = function(func) {
  var size = this.size();
  for (var i = 0; i < size; ++i) {
    if (func(this.get(i))) { return; }
  }
};

/**
 * @returns {Array.<string>} the names of the metadata columns associated with the epiviz.datatypes.GenomicRangeArray instance
 */
epiviz.datatypes.GenomicRangeArray.prototype.metadataColumns = function() {
  if (this._metadata) {
    return Object.keys(this._metadata);
  }

  return [];
};

/**
 * @param {number} index
 * @returns {string}
 */
epiviz.datatypes.GenomicRangeArray.prototype.id = function(index) {
  return this._id ? this._id[index] : this.globalStartIndex() + index;
};

/**
 * @param {number} index
 * @returns {number}
 */
epiviz.datatypes.GenomicRangeArray.prototype.start = function(index) {
  return this._start ? this._start[index] : undefined;
};

/**
 * @param {number} index
 * @returns {number}
 */
epiviz.datatypes.GenomicRangeArray.prototype.end = function(index) {
  return this._end ? this._end[index] : this.start(index);
};

/**
 * @param {number} index
 * @returns {string}
 */
epiviz.datatypes.GenomicRangeArray.prototype.strand = function(index) {
  return Array.isArray(this._strand) ? this._strand[index] : this._strand;
};

/**
 * @param {string} column
 * @param {number} index
 * @returns {*}
 */
epiviz.datatypes.GenomicRangeArray.prototype.metadata = function(column, index) {
  if (!this._metadata || !this._metadata[column]) { return null; }
  return this._metadata[column][index];
};

/**
 * @param {number} index
 * @returns {Object.<string, *>}
 */
epiviz.datatypes.GenomicRangeArray.prototype.rowMetadata = function(index) {
  var result = {};
  for (var column in this._metadata) {
    if (!this._metadata.hasOwnProperty(column)) { continue; }
    result[column] = this._metadata[column][index];
  }

  return result;
};

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicRangeArray.prototype.toString = function() {
  var c, s, e;
  if (this.boundaries()) {
    c = this.boundaries().seqName();
    s = this.boundaries().start();
    e = this.boundaries().end();
  } else {
    c = s = e = '*';
  }
  var header = sprintf('%25s', this.measurement().name().substr(0, 22)) + sprintf(' [%6s%10s%10s]', c, s, e);
  var id = sprintf('%10s:', 'id');
  var idx = sprintf('%10s:', 'idx');
  var chr = sprintf('%10s:', 'chr');
  var start = sprintf('%10s:', 'start');
  var end = sprintf('%10s:', 'end');

  if (this.globalStartIndex() != undefined) {
    for (var globalIndex = this.globalStartIndex(); globalIndex < this.globalStartIndex() + this.size(); ++globalIndex) {
      /** @type {epiviz.datatypes.GenomicData.RowItem} */
      var row = this.getByGlobalIndex(globalIndex);
      id += sprintf('%10s', row.id());
      idx += sprintf('%10s', globalIndex);
      chr += sprintf('%10s', row.seqName());
      start += sprintf('%10s', row.start());
      end += sprintf('%10s', row.end());
    }
  }

  return [header, id, idx, chr, start, end].join('\n');
};

// goog.inherits(epiviz.datatypes.GenomicRangeArray, epiviz.datatypes.GenomicArray);

goog.provide('epiviz.datatypes.GenomicRangeArray.RowItemWrapper');

goog.require('epiviz.datatypes.GenomicData.RowItem');

/**
 * @param {epiviz.datatypes.GenomicRangeArray} parent
 * @param {number} index
 *
 * @constructor
 * @implements {epiviz.datatypes.GenomicData.RowItem}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper = function(parent, index) {
  /**
   * @type {number}
   * @private
   */
  this._index = index;

  /**
   * @type {epiviz.datatypes.GenomicRangeArray}
   * @private
   */
  this._parent = parent;
};

/**
 * @returns {epiviz.datatypes.GenomicRangeArray}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.parent = function() {
  return this._parent;
};

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.id = function() {
  return this._parent.id(this._index);
};

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.seqName = function() {
  return this._parent.boundaries() ? this._parent.boundaries().seqName() : undefined;
};

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.start = function() {
  return this._parent.start(this._index);
};

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.end = function() {
  return this._parent.end(this._index);
};

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.index = function() {
  return this._index;
};

/**
 * @returns {number}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.globalIndex = function() {
  return this._index + this._parent.globalStartIndex();
};

/**
 * @param {epiviz.datatypes.GenomicData.RowItem} other
 * @returns {boolean}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.equals = function(other) {
  if (!other) { return false; }
  if (this == other) { return true; }

  return (other.seqName() == this.seqName() &&
    other.start() == this.start() &&
    other.end() == this.end());
};

/**
 * @returns {string}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.strand = function() {
  return this._parent.strand(this._index);
};

/**
 * @param {string} column
 * @returns {*}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.metadata = function(column) {
  return this._parent.metadata(column, this._index);
};

/**
 * @returns {Object.<string, *>}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.rowMetadata = function() {
  return this._parent.rowMetadata(this._index);
};

/**
 * @param {epiviz.datatypes.GenomicData.RowItem} other
 * @returns {boolean}
 */
epiviz.datatypes.GenomicRangeArray.RowItemWrapper.prototype.overlapsWith = function(other) {
  if (!other) { return false; }
  if (this == other) { return true; }
  if (this.seqName() != other.seqName()) { return false; }
  return (this.start() < other.end() && this.end() > other.start());
};
// Input 177
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 6:47 PM
 */

goog.provide('epiviz.measurements.Measurement');
goog.provide('epiviz.measurements.Measurement.Type');

goog.require('epiviz.utils');

/**
 * @param {string} id
 * @param {string} name
 * @param {epiviz.measurements.Measurement.Type} type
 * @param {string} datasourceId
 * @param {string} datasourceGroup
 * @param {string} dataprovider
 * @param {{referredMeasurements: Object.<number, epiviz.measurements.Measurement>, expression: epiviz.utils.ExpressionParser.Expression}} [formula]
 * @param {string} [defaultChartType]
 * @param {Object.<string, string>} [annotation]
 * @param {number} [minValue]
 * @param {number} [maxValue]
 * @param {Array.<string>} [metadata]
 * @constructor
 */
epiviz.measurements.Measurement = function(id, name, type, datasourceId, datasourceGroup,
                                           dataprovider, formula, defaultChartType, annotation,
                                           minValue, maxValue, metadata) {

  var MeasurementType = epiviz.measurements.Measurement.Type;

  /**
   * @type {string}
   * @private
   */
  this._id = id;

  /**
   * @type {string}
   * @private
   */
  this._name = name;

  /**
   * @type {epiviz.measurements.Measurement.Type}
   * @private
   */
  this._type = type;

  /**
   * @type {epiviz.measurements.Measurement}
   * @private
   */
  this._datasource = type == (MeasurementType.RANGE) ? this :
    new epiviz.measurements.Measurement(
      datasourceId, // id
      datasourceId, // name
      MeasurementType.RANGE, // type
      datasourceId, // datasource
      datasourceGroup, // datasourceGroup
      dataprovider, // dataprovider
      null, // formula
      'Blocks Track', // defaultChartType
      null, null, null, // annotation, minValue, maxValue
      metadata); // metadata

  /**
   * @type {string}
   * @private
   */
  this._datasourceGroup = datasourceGroup;

  /**
   * @type {string}
   * @private
   */
  this._dataprovider = dataprovider;

  /**
   * @type {?{referredMeasurements: Object.<number, epiviz.measurements.Measurement>, expression: epiviz.utils.ExpressionParser.Expression}}
   * @private
   */
  this._formula = formula || null;

  /**
   * @type {?string}
   * @private
   */
  this._defaultChartType = defaultChartType || null;

  /**
   * @type {?Object.<string, string>}
   * @private
   */
  this._annotation = annotation || null;

  /**
   * @type {?number}
   * @private
   */
  this._minValue = (minValue || minValue === 0) ? minValue : null;

  /**
   * @type {?number}
   * @private
   */
  this._maxValue = (maxValue || maxValue === 0) ? maxValue : null;

  /**
   * @type {?Array.<string>}
   * @private
   */
  this._metadata = metadata || null;
};

/**
 * @enum {string}
 */
epiviz.measurements.Measurement.Type = {
  FEATURE: 'feature',
  RANGE: 'range',
  UNORDERED: 'unordered'
};

/**
 * @param {epiviz.measurements.Measurement.Type} type
 * @returns {boolean}
 */
epiviz.measurements.Measurement.Type.isOrdered = function(type) {
  return type == epiviz.measurements.Measurement.Type.FEATURE || type == epiviz.measurements.Measurement.Type.RANGE;
};

/**
 * @param {epiviz.measurements.Measurement.Type} type
 * @returns {boolean}
 */
epiviz.measurements.Measurement.Type.hasValues = function(type) {
  return type == epiviz.measurements.Measurement.Type.FEATURE || type == epiviz.measurements.Measurement.Type.UNORDERED;
};


/**
 * @returns {string}
 */
epiviz.measurements.Measurement.prototype.id = function() {
  return this._id;
};

/**
 * @returns {string}
 */
epiviz.measurements.Measurement.prototype.name = function() {
  return this._name;
};

/**
 * @returns {epiviz.measurements.Measurement.Type}
 */
epiviz.measurements.Measurement.prototype.type = function() {
  return this._type;
};

/**
 * @returns {epiviz.measurements.Measurement}
 */
epiviz.measurements.Measurement.prototype.datasource = function() {
  return this._datasource;
};

/**
 * @returns {string}
 */
epiviz.measurements.Measurement.prototype.datasourceId = function() {
  return this._datasource.id();
};

/**
 * @returns {string}
 */
epiviz.measurements.Measurement.prototype.datasourceGroup = function() {
  return this._datasourceGroup;
};

/**
 * @returns {string}
 */
epiviz.measurements.Measurement.prototype.dataprovider = function() {
  return this._dataprovider;
};

/**
 * @returns {?{referredMeasurements: Object.<number, epiviz.measurements.Measurement>, expression: epiviz.utils.ExpressionParser.Expression}}
 */
epiviz.measurements.Measurement.prototype.formula = function() {
  return this._formula;
};

/**
 * @returns {string}
 */
epiviz.measurements.Measurement.prototype.formulaStr = function() {
  if (!this._formula) { return ''; }
  var referredMs = this._formula.referredMeasurements;
  var expression = this._formula.expression.toString();

  for (var formulaIndex in referredMs) {
    if (!referredMs.hasOwnProperty(formulaIndex)) { continue; }

    expression = expression.replace(
      new RegExp('\\{' + formulaIndex + '\\}', 'g'),
      ' {' + referredMs[formulaIndex].name()  + '} ');
  }

  return expression;
};

/**
 * @param {epiviz.measurements.MeasurementHashtable.<number>} values A map between
 *   each of the component measurements and their corresponding values. See
 *   epiviz.measurements.Measurement.prototype.componentMeasurements() for more.
 */
epiviz.measurements.Measurement.prototype.evaluate = function(values) {
  var tuple = {};
  for (var i in this._formula.referredMeasurements) {
    if (!this._formula.referredMeasurements.hasOwnProperty(i)) { continue; }

    var m = this._formula.referredMeasurements[i];
    tuple['{' + i + '}'] = m.isComputed() ?
      m.evaluate(values) : values.get(m);
  }

  return this._formula.expression.evaluate(tuple);
};

/*
 *@param {epiviz.measurements.MeasurementHashtable.<Array.<number>>} values A map between
 *   each of the component measurements and an array of their corresponding values. See
 *   epiviz.measurements.Measurement.prototype.componentMeasurements() for more.
 */
epiviz.measurements.Measurement.prototype.evaluateArr = function(values) {
  /** @type {Object.<string, Array.<number>>} */
  var tuple = {};
  for (var i in this._formula.referredMeasurements) {
    if (!this._formula.referredMeasurements.hasOwnProperty(i)) { continue; }

    var m = this._formula.referredMeasurements[i];
    tuple['{' + i + '}'] = m.isComputed() ?
      m.evaluateArr(values) : values.get(m);
  }

  return this._formula.expression.evaluateArr(tuple);
};

/**
 * @returns {?string}
 */
epiviz.measurements.Measurement.prototype.defaultChartType = function() {
  return this._defaultChartType;
};

/**
 * @returns {?Object.<string, string>}
 */
epiviz.measurements.Measurement.prototype.annotation = function() {
  return this._annotation;
};

/**
 * @returns {?number}
 */
epiviz.measurements.Measurement.prototype.minValue = function() {
  return this._minValue;
};

/**
 * @returns {?number}
 */
epiviz.measurements.Measurement.prototype.maxValue = function() {
  return this._maxValue;
};

/**
 * @returns {Array.<string>}
 */
epiviz.measurements.Measurement.prototype.metadata = function() {
  return this._metadata || [];
};

/**
 * Gets a set of all independent measurements needed to compute this measurement. If the measurement is independent,
 * then the returned set contains this measurement only.
 *
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.measurements.Measurement.prototype.componentMeasurements = function() {
  var result = new epiviz.measurements.MeasurementSet();

  if (!this._formula) {
    result.add(this);
    return result;
  }

  for (var i in this._formula.referredMeasurements) {
    if (!this._formula.referredMeasurements.hasOwnProperty(i)) { continue; }

    result.addAll(this._formula.referredMeasurements[i].componentMeasurements());
  }

  return result;
};

/**
 * @returns {boolean}
 */
epiviz.measurements.Measurement.prototype.isComputed = function() { return (this._formula) ? true : false; };

/**
 *
 * @param {epiviz.measurements.MeasurementHashtable.<number>} measurementsIndexMap
 * @returns {{id: string, name: string, type: epiviz.measurements.Measurement.Type, datasourceId: string, datasourceGroup: string, dataprovider: string, formula: {expression: (string), referredMeasurements: Object.<number, number>}, defaultChartType: ?string, annotation: ?Object.<string, string>, minValue: ?number, maxValue: ?number, metadata: ?Array.<string>}}
 */
epiviz.measurements.Measurement.prototype.raw = function(measurementsIndexMap) {

  if (this._formula) {
    /** @type {Object.<number, epiviz.measurements.Measurement>} */
    var referredMeasurements = this._formula.referredMeasurements;

    /** @type {Object.<number, number>} */
    var rawReferredMeasurements = {};

    for (var formulaIndex in referredMeasurements) {
      if (!referredMeasurements.hasOwnProperty(formulaIndex)) { continue; }

      rawReferredMeasurements[formulaIndex] = measurementsIndexMap.get(referredMeasurements[formulaIndex]);
    }
  }

  return {
    id: this._id,
    name: this._name,
    type: this._type,
    datasourceId: this._datasource._id,
    datasourceGroup: this._datasourceGroup,
    dataprovider: this._dataprovider,
    formula: this._formula ?
      {expression: this._formula.expression.toString(), referredMeasurements: rawReferredMeasurements} :
      null,
    defaultChartType: this._defaultChartType,
    annotation: this._annotation,
    minValue: this._minValue,
    maxValue: this._maxValue,
    metadata: this._metadata
  };
};

/**
 * @returns {string}
 */
epiviz.measurements.Measurement.prototype.toString = function() {
  return this.name();
};

/**
 * @param {{
 *   id: string,
 *   name: string,
 *   type: string,
 *   datasourceId: string,
 *   datasourceGroup: string,
 *   dataprovider: string,
 *   formula: ?{expression: string, referredMeasurements: Object.<number, number>},
 *   defaultChartType: ?string,
 *   annotation: ?Object.<string, string>,
 *   minValue: ?number,
 *   maxValue: ?number,
 *   metadata: ?Array.<string>}} o
 * @param {Array.<epiviz.measurements.Measurement>} [measurements] This argument is used in conjunction
 *   with o.formula. If that is null, then this parameter is ignored.
 * @returns {epiviz.measurements.Measurement}
 */
epiviz.measurements.Measurement.fromRawObject = function(o, measurements) {
  var formula = null;
  if (o.formula) {
    var expr = epiviz.utils.ExpressionParser.parse(o.formula.expression);
    var refMs = {};

    var vars = expr.variables();
    for (var i = 0; i < vars.length; ++i) {
      if (!epiviz.utils.stringStartsWith(vars[i], '{') || !epiviz.utils.stringEndsWith(vars[i], '}')) {
        // This means that the variable is something else than a measurement
        continue;
      }
      var formulaIndex = parseInt(vars[i].substring(1, vars[i].length - 1));
      var index = o.formula.referredMeasurements[formulaIndex];
      refMs[formulaIndex] = measurements[index];
    }
    formula = {expression: expr, referredMeasurements: refMs};
  }

  return new epiviz.measurements.Measurement(o.id, o.name, o.type, o.datasourceId, o.datasourceGroup, o.dataprovider,
    formula, o.defaultChartType, o.annotation, o.minValue, o.maxValue, o.metadata);
};

// Input 178
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/28/14
 * Time: 12:04 PM
 */

goog.provide('epiviz.measurements.MeasurementsManager');

goog.require('epiviz.events.Event');
goog.require('epiviz.measurements.MeasurementSet');

/**
 * @constructor
 */
epiviz.measurements.MeasurementsManager = function() {
  /**
   * @type {epiviz.events.Event}
   * @private
   */
  this._requestMeasurements = new epiviz.events.Event();

  /**
   * Fires when new measurements are added in a data provider or
   * a computed measurement is created.
   * @type {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
   * @private
   */
  this._measurementsAdded = new epiviz.events.Event();

  /**
   * Fires when a data provider removes a measurement or a computed
   * measurement is removed.
   * @type {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
   * @private
   */
  this._measurementsRemoved = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
   * @private
   */
  this._computedMeasurementsAdded = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
   * @private
   */
  this._computedMeasurementsRemoved = new epiviz.events.Event();

  /**
   * Contains all measurements, including computed ones
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._measurements = new epiviz.measurements.MeasurementSet();

  /**
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._computedMeasurements = new epiviz.measurements.MeasurementSet();
};

/**
 */
epiviz.measurements.MeasurementsManager.prototype.initialize = function() {
  this._requestMeasurements.notify();
};

/**
 * @returns {epiviz.events.Event}
 */
epiviz.measurements.MeasurementsManager.prototype.onRequestMeasurements = function() { return this._requestMeasurements; };

/**
 * @returns {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
 */
epiviz.measurements.MeasurementsManager.prototype.onMeasurementsAdded = function() { return this._measurementsAdded; };

/**
 * @returns {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
 */
epiviz.measurements.MeasurementsManager.prototype.onMeasurementsRemoved = function() { return this._measurementsRemoved; };

/**
 * @returns {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
 */
epiviz.measurements.MeasurementsManager.prototype.onComputedMeasurementsAdded = function() { return this._computedMeasurementsAdded; };

/**
 * @returns {epiviz.events.Event.<epiviz.measurements.MeasurementSet>}
 */
epiviz.measurements.MeasurementsManager.prototype.onComputedMeasurementsRemoved = function() { return this._computedMeasurementsRemoved; };

/**
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.measurements.MeasurementsManager.prototype.measurements = function() { return this._measurements; };

/**
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.measurements.MeasurementsManager.prototype.computedMeasurements = function() { return this._computedMeasurements; };

/**
 * @param {epiviz.measurements.MeasurementSet} measurements
 */
epiviz.measurements.MeasurementsManager.prototype.addMeasurements = function(measurements) {
  if (!measurements || !measurements.size()) { return; } // No measurements to add

  var self = this;
  this._measurements.addAll(measurements);

  var computedMeasurements = new epiviz.measurements.MeasurementSet();

  measurements.foreach(function(m) {
    if (m.isComputed()) {
      computedMeasurements.add(m);
      self._computedMeasurements.add(m);
    }
  });

  this._measurementsAdded.notify(measurements);

  if (computedMeasurements.size() > 0) {
    this._computedMeasurementsAdded.notify(computedMeasurements);
  }
};

/**
 * @param {epiviz.measurements.MeasurementSet} measurements
 */
epiviz.measurements.MeasurementsManager.prototype.removeMeasurements = function(measurements) {
  var self = this;
  this._measurements.removeAll(measurements);

  var computedMeasurements = new epiviz.measurements.MeasurementSet();
  measurements.foreach(function(m) {
    if (m.isComputed()) {
      computedMeasurements.add(m);
      self._computedMeasurements.remove(m);
    }
  });

  this._measurementsRemoved.notify(measurements);

  if (computedMeasurements.size() > 0) {
    this._computedMeasurementsRemoved.notify(computedMeasurements);
  }
};

/**
 * @param {epiviz.measurements.Measurement} measurement
 */
epiviz.measurements.MeasurementsManager.prototype.addMeasurement = function(measurement) {
  var measurements = new epiviz.measurements.MeasurementSet();
  measurements.add(measurement);

  this.addMeasurements(measurements);
};

/**
 * @param {epiviz.measurements.Measurement} measurement
 */
epiviz.measurements.MeasurementsManager.prototype.removeMeasurement = function(measurement) {
  var measurements = new epiviz.measurements.MeasurementSet();
  measurements.add(measurement);

  this.removeMeasurements(measurements);
};

// Input 179
/**
 * Created by: Florin Chelaru
 * Date: 9/30/13
 * Time: 7:19 PM
 */

goog.provide('epiviz.measurements.MeasurementSet');

goog.require('epiviz.utils.Iterable');
goog.require('epiviz.utils.Iterator');


/**
 * A collection of measurements, where each item is stored only once,
 * and iteration is done in the insertion order.
 *
 * @param {epiviz.measurements.MeasurementSet} [other]
 * @constructor
 * @implements {epiviz.utils.Iterable}
 */
epiviz.measurements.MeasurementSet = function(other) {
  /**
   * A map containing measurements in a tree structure, by the following levels:
   *   dataprovider, type, datasourceGroup, datasource, id
   * @type {Object.<string, Object.<string, Object.<string, Object.<string, Object.<string, {measurement: epiviz.measurements.Measurement, index: number}>>>>>}
   * @private
   */
  this._measurementTree = {};

  /**
   * @type {number}
   * @private
   */
  this._size = 0;

  /**
   * @type {Array.<{measurement: epiviz.measurements.Measurement, contained: boolean}>}
   * @private
   */
  this._order = [];

  if (other) {
    this.addAll(other);
  }
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {boolean} true if the measurement was successfully added to the collection and
 *   false if there was already a measurement with this id in the collection
 */
epiviz.measurements.MeasurementSet.prototype.add = function(m) {
  if (!(m.dataprovider() in this._measurementTree)) {
    this._measurementTree[m.dataprovider()] = {};
  }

  if (!(m.type() in this._measurementTree[m.dataprovider()])) {
    this._measurementTree[m.dataprovider()][m.type()] = {};
  }

  if (!(m.datasourceGroup() in this._measurementTree[m.dataprovider()][m.type()])) {
    this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()] = {};
  }

  if (!(m.datasource().id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()])) {
    this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()] = {};
  }

  if (m.id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()]) {
    return false;
  }

  this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()] = {
    measurement: m,
    index: this._order.length
  };

  this._order.push({
    measurement: m,
    contained: true
  });

  ++this._size;

  return true;
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {boolean} true if the measurement was in the collection and
 *   false if there was no measurement with this id in the collection
 */
epiviz.measurements.MeasurementSet.prototype.remove = function(m) {
  if (!(m.dataprovider() in this._measurementTree)) {
    return false;
  }

  if (!(m.type() in this._measurementTree[m.dataprovider()])) {
    return false;
  }

  if (!(m.datasourceGroup() in this._measurementTree[m.dataprovider()][m.type()])) {
    return false;
  }

  if (!(m.datasource().id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()])) {
    return false;
  }

  if (!(m.id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()])) {
    return false;
  }

  this._order[this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()].index].contained = false;

  delete this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()];
  --this._size;
  return true;
};

/**
 * Returns true if any new measurements were added and false if
 * all measurements were already in the collection.
 * @param {?epiviz.measurements.MeasurementSet} measurements
 * @returns {boolean}
 */
epiviz.measurements.MeasurementSet.prototype.addAll = function(measurements) {
  if (!measurements || !measurements.size()) { return false; }
  var newMeasurementsAdded = false;
  var self = this;
  measurements.foreach(
    /**
     * @param {epiviz.measurements.Measurement} m
     * @returns {boolean}
     */
    function(m) {
      if (self.add(m)) {
        newMeasurementsAdded = true;
      }
      return false;
    });

  return newMeasurementsAdded;
};

/**
 * @param {epiviz.measurements.MeasurementSet} measurements
 * @returns {boolean}
 */
epiviz.measurements.MeasurementSet.prototype.removeAll = function(measurements) {
  var someMeasurementsRemoved = false;
  var self = this;
  measurements.foreach(
    /**
     * @param {epiviz.measurements.Measurement} m
     * @returns {boolean}
     */
    function(m) {
      if (self.remove(m)) {
        someMeasurementsRemoved = true;
      }
      return false;
    });

  return someMeasurementsRemoved;
};

/**
 * Iterates through all items stored in this collection, in the order they were added.
 *
 * @param {function(epiviz.measurements.Measurement, number=)} func A function called
 *   for each measurement matching the given filters. Iteration
 *   is stopped if the function returns something that evaluates to true.
 * @param {function(epiviz.measurements.Measurement): boolean} [predicate]
 */
epiviz.measurements.MeasurementSet.prototype.foreach = function(func, predicate) {
  var iter = this.iterator();
  for (var m = iter.first(), i = 0; m !== null; m = iter.next(), ++i) {
    if (predicate && !predicate(m)) { continue; }
    if (func(m, i)) { return; }
  }
};

/**
 * @returns {epiviz.utils.Iterator.<epiviz.measurements.Measurement>}
 */
epiviz.measurements.MeasurementSet.prototype.iterator = function() {
  return new epiviz.measurements.MeasurementSet.Iterator(this);
};

/**
 * @param {function(epiviz.measurements.Measurement): boolean} [predicate]
 *
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.measurements.MeasurementSet.prototype.subset = function(predicate) {
  var measurements = new epiviz.measurements.MeasurementSet();
  this.foreach(function(m) { measurements.add(m); }, predicate);

  return measurements;
};

/**
 * @param {function(epiviz.measurements.Measurement): epiviz.measurements.Measurement} transformer
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.measurements.MeasurementSet.prototype.map = function(transformer) {
  var ret = new epiviz.measurements.MeasurementSet();
  this.foreach(function(m) {
    ret.add(transformer(m));
  });
  return ret;
};

/**
 * @returns {number}
 */
epiviz.measurements.MeasurementSet.prototype.size = function() { return this._size; };

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {boolean}
 */
epiviz.measurements.MeasurementSet.prototype.contains = function(m) {
  if (!(m.dataprovider() in this._measurementTree)) {
    return false;
  }

  if (!(m.type() in this._measurementTree[m.dataprovider()])) {
    return false;
  }

  if (!(m.datasourceGroup() in this._measurementTree[m.dataprovider()][m.type()])) {
    return false;
  }

  if (!(m.datasource().id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()])) {
    return false;
  }

  return (m.id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()]);
};

/**
 * @returns {?epiviz.measurements.Measurement}
 */
epiviz.measurements.MeasurementSet.prototype.first = function() {
  return this.iterator().first();
};

/**
 * Gets measurement at the given index. This method performs in O(n) time, so
 * it's not appropriate for iteration.
 * @param index
 * @returns {epiviz.measurements.Measurement}
 */
epiviz.measurements.MeasurementSet.prototype.get = function(index) {
  if (index >= this._size || index < 0) { return null; }
  if (this._size == this._order.length) {
    return this._order[index].measurement;
  }

  var result = null;
  this.foreach(function(m, i) {
    if (i == index) {
      result = m;
      return true;
    }
    return false;
  });

  return result;
};

/**
 * @returns {Array.<epiviz.measurements.Measurement>}
 */
epiviz.measurements.MeasurementSet.prototype.toArray = function() {
  var result = new Array(this._size);
  this.foreach(function(m, i) {
    result[i] = m;
  });

  return result;
};

/**
 * @param {function(epiviz.measurements.Measurement, epiviz.measurements.Measurement): number} comparer
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.measurements.MeasurementSet.prototype.sorted = function(comparer) {
  /** @type {Array.<epiviz.measurements.Measurement>} */
  var msArr = this.toArray().sort(comparer);
  var ret = new epiviz.measurements.MeasurementSet();
  msArr.forEach(function(m) { ret.add(m); });
  return ret;
};

/**
 * @returns {Array.<{id: string, name: string, type: epiviz.measurements.Measurement.Type, datasourceId: string, datasourceGroup: string, dataprovider: string, formula: null, defaultChartType: ?string, annotation: ?Object.<string, string>, minValue: ?number, maxValue: ?number, metadata: ?Array.<string>}>}
 */
epiviz.measurements.MeasurementSet.prototype.raw = function() {
  var result = new Array(this._size);
  this.foreach(function(m, i) {
    result[i] = m.raw();
  });

  return result;
};

/**
 * @param {function(epiviz.measurements.Measurement): number|string} criterion
 * @returns {Object.<string, epiviz.measurements.MeasurementSet>}
 */
epiviz.measurements.MeasurementSet.prototype.split = function(criterion) {
  var ret = {};
  this.foreach(function(m, i) {
    var key = criterion(m);
    var group = ret[key];
    if (group == undefined) {
      group = new epiviz.measurements.MeasurementSet();
      ret[key] = group;
    }
    group.add(m);
  });

  return ret;
};

/**
 *
 * @param {epiviz.measurements.MeasurementSet} measurementSet
 * @constructor
 * @implements {epiviz.utils.Iterator}
 */
epiviz.measurements.MeasurementSet.Iterator = function(measurementSet) {
  /**
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._parent = measurementSet;

  /**
   * @type {number}
   * @private
   */
  this._lastIndex = null;
};

/**
 * @returns {?epiviz.measurements.Measurement}
 */
epiviz.measurements.MeasurementSet.Iterator.prototype.first = function() {
  if (this._parent.size() == 0) {
    return null;
  }

  for (var i = 0; i < this._parent._order.length; ++i) {
    if (this._parent._order[i].contained) {
      this._lastIndex = i;
      return this._parent._order[i].measurement;
    }
  }

  // Should never be reached!
  throw Error('Inconsistent MeasurementSet with size() > 0 and no first element');
};

/**
 * @returns {?epiviz.measurements.Measurement}
 */
epiviz.measurements.MeasurementSet.Iterator.prototype.next = function() {
  if (this._lastIndex === null) {
    throw Error('Iterator.next() called before calling Iterator.first()');
  }

  for (var i = this._lastIndex + 1; i < this._parent._order.length; ++i) {
    if (this._parent._order[i].contained) {
      this._lastIndex = i;
      return this._parent._order[i].measurement;
    }
  }

  this._lastIndex = this._parent._order.length;
  return null;
};

// Input 180
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/13
 * Time: 3:45 PM
 */

goog.provide('epiviz.measurements.MeasurementHashtable');

goog.require('epiviz.utils.Iterable');
goog.require('epiviz.utils.Iterator');


/**
 * @constructor
 * @implements {epiviz.utils.Iterable}
 * @template T
 */
epiviz.measurements.MeasurementHashtable = function() {
  /**
   * @type {number}
   * @private
   */
  this._size = 0;

  /**
   * A map containing measurement values in a tree structure, by the following levels:
   *   dataprovider, type, datasourceGroup, datasource, id
   * @type {Object.<string, Object.<string, Object.<string, Object.<string, Object.<string, {key: epiviz.measurements.Measurement, value: T, index: number}>>>>>}
   * @private
   */
  this._measurementTree = {};

  /**
   * @type {Array.<{key: epiviz.measurements.Measurement, value: T, contained: boolean}>}
   * @private
   */
  this._order = [];
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @param {T} value
 */
epiviz.measurements.MeasurementHashtable.prototype.put = function(m, value) {
  if (this.contains(m)) {
    var existingItem = this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()];
    this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()] = {key: m, value: value, index: existingItem.index};
    this._order[existingItem.index] = {key: m, value: value, contained: true};
    return;
  }

  if (!(m.dataprovider() in this._measurementTree)) {
    this._measurementTree[m.dataprovider()] = {};
  }

  if (!(m.type() in this._measurementTree[m.dataprovider()])) {
    this._measurementTree[m.dataprovider()][m.type()] = {};
  }

  if (!(m.datasourceGroup() in this._measurementTree[m.dataprovider()][m.type()])) {
    this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()] = {};
  }

  if (!(m.datasource().id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()])) {
    this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()] = {};
  }

  this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()] = {key: m, value: value, index: this._order.length};
  this._order.push({key: m, value: value, contained: true});

  ++this._size;
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {?T}
 */
epiviz.measurements.MeasurementHashtable.prototype.get = function(m) {
  if (!this.contains(m)) { return null; }

  return this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()].value;
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {boolean} true if the measurement was in the data structure and was removed
 *   and false if the measurement was not in the collection
 */
epiviz.measurements.MeasurementHashtable.prototype.remove = function(m) {
  if (!this.contains(m)) {
    return false;
  }

  var item = this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()];
  delete this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()];
  this._order[item.index].contained = false;
  --this._size;
  return true;
};

/**
 * @param {epiviz.measurements.Measurement} m
 * @returns {boolean}
 */
epiviz.measurements.MeasurementHashtable.prototype.contains = function(m) {
  if (!(m.dataprovider() in this._measurementTree)) {
    return false;
  }

  if (!(m.type() in this._measurementTree[m.dataprovider()])) {
    return false;
  }

  if (!(m.datasourceGroup() in this._measurementTree[m.dataprovider()][m.type()])) {
    return false;
  }

  if (!(m.datasource().id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()])) {
    return false;
  }

  return (m.id() in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()]);
};

/**
 */
epiviz.measurements.MeasurementHashtable.prototype.clear = function() {
  this._size = 0;
  this._measurementTree = {};
  this._order = [];
};

/**
 * @returns {boolean}
 */
epiviz.measurements.MeasurementHashtable.prototype.isEmpty = function() {
  return this._size == 0;
};

/**
 * returns {number}
 */
epiviz.measurements.MeasurementHashtable.prototype.size = function() {
  return this._size;
};

/**
 * Iterates through all pairs in the map, or until the given function returns something that
 * evaluates to true.
 * @param {function(epiviz.measurements.Measurement, T, number=)} func
 * @param {function(epiviz.measurements.Measurement):boolean} [predicate]
 */
epiviz.measurements.MeasurementHashtable.prototype.foreach = function(func, predicate) {
  var iter = this.iterator();
  for (var pair = iter.first(), i = 0; pair !== null; pair = iter.next(), ++i) {
    if (predicate && !predicate(pair.key)) { continue; }
    if (func(pair.key, pair.value, i)) { return; }
  }
};

/**
 * @returns {{key: epiviz.measurements.Measurement, value: T}}
 */
epiviz.measurements.MeasurementHashtable.prototype.first = function() {
  return this.iterator().first();
};

/**
 * Creates a copy of this hashtable, ordered by keys (measurements)
 * @param {function(epiviz.measurements.Measurement, epiviz.measurements.Measurement): number} comparer
 * @returns {epiviz.measurements.MeasurementHashtable}
 */
epiviz.measurements.MeasurementHashtable.prototype.sorted = function(comparer) {
  var ret = new epiviz.measurements.MeasurementHashtable();

  var pairs = this._order.slice(0);
  pairs.sort(function(p1, p2) { return comparer(p1.key, p2.key); });

  pairs.forEach(function(pair) {
    if (!pair.contained) { return; }
    ret.put(pair.key, pair.value);
  });

  return ret;
};

/**
 * @returns {Array.<epiviz.measurements.Measurement>}
 */
epiviz.measurements.MeasurementHashtable.prototype.keys = function() {
  var ret = [];
  this._order.forEach(function(o) {
    if (o.contained) { ret.push(o.key); }
  });
  return ret;
};

/**
 * @returns {epiviz.utils.Iterator.<{key: epiviz.measurements.Measurement, value: T}>}
 */
epiviz.measurements.MeasurementHashtable.prototype.iterator = function() {
  return new epiviz.measurements.MeasurementHashtable.Iterator(this);
};

/**
 * @returns {string}
 */
epiviz.measurements.MeasurementHashtable.prototype.toString = function() {
  var result = {};
  this.foreach(function(m, v) {
    var id = m.id();
    var i = 2;
    while (id in result) {
      id = m.id() + ' (' + (i++) + ')';
    }
    result[id] = v;
  });
  return JSON.stringify(result);
};

/**
 * @param {epiviz.measurements.MeasurementHashtable} measurementHashtable
 * @constructor
 * @implements {epiviz.utils.Iterator}
 */
epiviz.measurements.MeasurementHashtable.Iterator = function(measurementHashtable) {
  /**
   * @type {epiviz.measurements.MeasurementHashtable}
   * @private
   */
  this._parent = measurementHashtable;

  /**
   * @type {number}
   * @private
   */
  this._lastIndex = null;
};

/**
 * @returns {?{key: epiviz.measurements.Measurement, value: T}}
 */
epiviz.measurements.MeasurementHashtable.Iterator.prototype.first = function() {
  if (this._parent.size() == 0) {
    return null;
  }

  for (var i = 0; i < this._parent._order.length; ++i) {
    if (this._parent._order[i].contained) {
      this._lastIndex = i;
      return {key: this._parent._order[i].key, value: this._parent._order[i].value};
    }
  }

  // Should never be reached!
  throw Error('Inconsistent MeasurementHashtable with size() > 0 and no first element');
};

/**
 * @returns {?{key: epiviz.measurements.Measurement, value: T}}
 */
epiviz.measurements.MeasurementHashtable.Iterator.prototype.next = function() {
  if (this._lastIndex === null) {
    throw Error('Iterator.next() called before calling Iterator.first()');
  }

  for (var i = this._lastIndex + 1; i < this._parent._order.length; ++i) {
    if (this._parent._order[i].contained) {
      this._lastIndex = i;
      return {key: this._parent._order[i].key, value: this._parent._order[i].value};
    }
  }

  this._lastIndex = this._parent._order.length;
  return null;
};

// Input 181
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 12:56 PM
 */

goog.provide('epiviz.ui.ControlManager');

goog.require('epiviz.utils');
goog.require('epiviz.Config');
goog.require('epiviz.events.Event');
goog.require('epiviz.ui.controls.DatasourceGroupWizardStep');
goog.require('epiviz.datatypes.GenomicRange');
goog.require('epiviz.ui.charts.VisualizationType');
goog.require('epiviz.ui.controls.VisConfigSelection');
goog.require('epiviz.ui.controls.MeaurementsWizardStep');
goog.require('epiviz.ui.controls.Wizard');
goog.require('epiviz.ui.controls.ComputedMeasurementsDialog');
goog.require('epiviz.ui.tutorials');
goog.require('epiviz.ui.PrintManager');
goog.require('epiviz.ui.controls.MessageDialog');
goog.require('epiviz.events.EventListener');

// goog.require('epiviz.ui.charts.Chart');
// goog.require('epiviz.ui.charts.ChartFactory');
// goog.require('epiviz.ui.charts.ChartManager');
// goog.require('epiviz.workspaces.WorkspaceManager');

/**
 * @param {epiviz.Config} config
 * @param {epiviz.ui.charts.ChartFactory} chartFactory
 * @param {epiviz.ui.charts.ChartManager} chartManager
 * @param {epiviz.measurements.MeasurementsManager} measurementsManager
 * @param {epiviz.ui.LocationManager} locationManager
 * @constructor
 */
epiviz.ui.ControlManager = function(config, chartFactory, chartManager, measurementsManager, locationManager) {

  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {epiviz.ui.charts.ChartFactory}
   * @private
   */
  this._chartFactory = chartFactory;

  /**
   * @type {epiviz.ui.charts.ChartManager}
   * @private
   */
  this._chartManager = chartManager;

  /**
   * @type {epiviz.measurements.MeasurementsManager}
   * @private
   */
  this._measurementsManager = measurementsManager;

  /**
   * @type {epiviz.ui.LocationManager}
   * @private
   */
  this._locationManager = locationManager;

  // Events

  /**
   * @type {epiviz.events.Event.<{type: epiviz.ui.charts.ChartType, visConfigSelection: epiviz.ui.controls.VisConfigSelection}>}
   * @private
   */
  this._addChart = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{oldValue: {id: string, name: string}, newValue: {id: string, name: string}}>}
   * @private
   */
  this._activeWorkspaceChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{name: string, id: ?string}>}
   * @private
   */
  this._saveWorkspace = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event}
   * @private
   */
  this._deleteActiveWorkspace = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event}
   * @private
   */
  this._revertActiveWorkspace = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event}
   * @private
   */
  this._loginLinkClicked = new epiviz.events.Event();

  /**
   * Fired whenever the user clicks or searches through the workspaces textbox
   *
   * @type {epiviz.events.Event.<{searchTerm: string, callback: function(Array.<epiviz.workspaces.Workspace>)}>}
   * @private
   */
  this._searchWorkspaces = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<{searchTerm: string, callback: function(Array.<{probe: string, gene: string, seqName: string, start: number, end: number}>)}>}
   * @private
   */
  this._search = new epiviz.events.Event();

  // Selection

  /**
   * @type {?{id: string, name: string}}
   * @private
   */
  this._activeWorkspaceInfo = null;

  /**
   * @type {number}
   * @private
   */
  this._stepRatio = config.navigationStepRatio;

  /**
   * @type {number}
   * @private
   */
  this._zoominRatio = config.zoominRatio;

  /**
   * @type {number}
   * @private
   */
  this._zoomoutRatio = config.zoomoutRatio;
};

/**
 * @type {Object.<epiviz.ui.charts.VisualizationType.DisplayType, string>}
 * @const
 */
epiviz.ui.ControlManager.CHART_TYPE_CONTAINERS = {
  'plot': 'feature-view',
  'track': 'location-view',
  'data-structure': 'data-structure-view'
};

/**
 * @type {Object.<epiviz.ui.charts.VisualizationType.DisplayType, string>}
 * @const
 */
epiviz.ui.ControlManager.DISPLAY_TYPE_LABELS = {
  'plot': 'Feature',
  'track': 'Location',
  'data-structure': 'Data Structure'
};

epiviz.ui.ControlManager.prototype.initialize = function() {

  /*
   * Toolbar
   */
  this._initializeChromosomeSelector();
  this._initializeLocationTextbox();
  this._initializeNavigationButtons();
  this._initializeZoomButtons();
  this._initializeLocationSettingsDialog();
  this._initializeChartMenus();
  this._initializeComputedMeasurementsMenu();
  this._initializeHelpButton();
  this._initializeSearchBox();
  this._initializeWorkspaceSaving();
  this._initializeTutorials();
  this._initializeScreenshotMenu();

  /*
   * Log in/out
   */
  this._initializeLoginLink();

  /*
   * Layout
   */
  this._initializeLayout();

  /*
   * Browser compatibility
   */
  this._checkBrowserCompatibility();

  // Register for events

  this._registerLocationChanged();

  this._registerSeqInfosUpdated();

};

/**
 * @returns {epiviz.events.Event.<{type: epiviz.ui.charts.ChartType, visConfigSelection: epiviz.ui.controls.VisConfigSelection}>}
 */
epiviz.ui.ControlManager.prototype.onAddChart = function() { return this._addChart; };

/**
 * @returns {epiviz.events.Event.<{oldValue: {id: string, name: string}, newValue: {id: string, name: string}}>}
 */
epiviz.ui.ControlManager.prototype.onActiveWorkspaceChanged = function() { return this._activeWorkspaceChanged; };

/**
 * @returns {epiviz.events.Event.<{name: string, id: ?string}>}
 */
epiviz.ui.ControlManager.prototype.onSaveWorkspace = function() { return this._saveWorkspace; };

/**
 * @returns {epiviz.events.Event}
 */
epiviz.ui.ControlManager.prototype.onDeleteActiveWorkspace = function() { return this._deleteActiveWorkspace; };

/**
 * @returns {epiviz.events.Event}
 */
epiviz.ui.ControlManager.prototype.onRevertActiveWorkspace = function() { return this._revertActiveWorkspace; };

/**
 * @returns {epiviz.events.Event}
 */
epiviz.ui.ControlManager.prototype.onLoginLinkClicked = function() { return this._loginLinkClicked; };

/**
 * @returns {epiviz.events.Event.<{searchTerm: string, callback: (function(Array))}>}
 */
epiviz.ui.ControlManager.prototype.onSearchWorkspaces = function() { return this._searchWorkspaces; };

/**
 * @returns {epiviz.events.Event.<{searchTerm: string, callback: (function(Array.<{probe: string, gene: string, seqName: string, start: number, end: number}>))}>}
 */
epiviz.ui.ControlManager.prototype.onSearch = function() { return this._search; };

/**
 * @param {Array.<epiviz.datatypes.SeqInfo>} seqInfos
 * @private
 */
epiviz.ui.ControlManager.prototype._updateSeqNames = function(seqInfos) {
  var chromosomeSelector = $('#chromosome-selector');
  var optionFormat = '<option value="%s"%s>%s</option>';
  chromosomeSelector.empty();
  for (var i = 0; i < seqInfos.length; ++i) {
    var option = sprintf(
      optionFormat,
      seqInfos[i].seqName,
      (this._locationManager.currentLocation() && seqInfos[i].seqName == this._locationManager.currentLocation().seqName()) ?
        'selected="selected"' : '', seqInfos[i].seqName);
    chromosomeSelector.append(option);
  }
  chromosomeSelector.selectmenu();
};

/**
 * @param {epiviz.measurements.MeasurementSet} measurements
 */
/*epiviz.ui.ControlManager.prototype.updateMeasurements = function(measurements) {
  this._measurements = measurements;
};*/

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @private
 */
epiviz.ui.ControlManager.prototype._updateSelectedLocation = function(range) {
  if (!range) { return; }

  this._locationManager.changeCurrentLocation(range);
  range = this._locationManager.currentLocation();

  var locationTextBox = $('#text-location');
  locationTextBox.val(Globalize.format(range.start(), 'n0') + ' - ' + Globalize.format(range.end(), 'n0'));

  var chromosomeSelector = $('#chromosome-selector');
  chromosomeSelector.val(range.seqName());
  chromosomeSelector.selectmenu();
};

/**
 * @param {{id: string, name: string}} workspaceInfo
 */
epiviz.ui.ControlManager.prototype.updateSelectedWorkspace = function(workspaceInfo) {
  var self = this;
  var saveTextBox = $('#save-workspace-text');
  var oldValue = this._activeWorkspaceInfo;
  saveTextBox.val(workspaceInfo.name);
  this._activeWorkspaceInfo = workspaceInfo;
  var args = {oldValue: oldValue, newValue: workspaceInfo, cancel: function() {
    saveTextBox.val(oldValue.name);
    self._activeWorkspaceInfo = oldValue;
  }};
  this._activeWorkspaceChanged.notify(args);
};

epiviz.ui.ControlManager.prototype._initializeChromosomeSelector = function() {
  var chromosomeSelector = $('#chromosome-selector');
  chromosomeSelector.selectmenu({
    style:'popup',
    width:'90',
    maxHeight:'100',
    menuWidth:'90'
  });

  var self = this;
  chromosomeSelector.change(function () {
    var currentLocation = self._locationManager.lastUnfilledLocationChangeRequest() || self._locationManager.currentLocation();
    var seqName = $(this).val();
    self._updateSelectedLocation(new epiviz.datatypes.GenomicRange(
      seqName,
      currentLocation.start(),
      currentLocation.width()));
  });
};

epiviz.ui.ControlManager.prototype._initializeLocationTextbox = function() {
  var self = this;
  var locationTextBox = $('#text-location');
  locationTextBox.keypress(function(event) {
    if (event.which != 13) { return true; }

    try {
      var location = $(this).val();
      var startEnd = location.split('-');

      var start = Globalize.parseInt(startEnd[0]);
      var end = Globalize.parseInt(startEnd[1]);

      var currentLocation = self._locationManager.lastUnfilledLocationChangeRequest() || self._locationManager.currentLocation();
      self._updateSelectedLocation(
        epiviz.datatypes.GenomicRange.fromStartEnd(currentLocation.seqName(), start, end));

      return true;
    } catch (error) {
      return false;
    }
  });
};

epiviz.ui.ControlManager.prototype._initializeNavigationButtons = function() {
  var self = this;
  $('#moveright').button({
    icons:{
      primary: 'ui-icon ui-icon-seek-next'
    },
    text:false
  }).click(
    function () {
      var currentLocation = self._locationManager.lastUnfilledLocationChangeRequest() || self._locationManager.currentLocation();
      var start = currentLocation.start() + Math.round(currentLocation.width() * self._stepRatio);
      self._updateSelectedLocation(
        new epiviz.datatypes.GenomicRange(currentLocation.seqName(), start, currentLocation.width()));
    });

  $("#moveleft").button({
    icons:{
      primary: 'ui-icon ui-icon-seek-prev'
    },
    text:false
  }).click(
    function () {
      var currentLocation = self._locationManager.lastUnfilledLocationChangeRequest() || self._locationManager.currentLocation();
      var start = currentLocation.start() - Math.round(currentLocation.width() * self._stepRatio);
      self._updateSelectedLocation(
        new epiviz.datatypes.GenomicRange(currentLocation.seqName(), start, currentLocation.width()));
    });
};

epiviz.ui.ControlManager.prototype._initializeZoomButtons = function() {
  var self = this;
  var zoomin = $('#zoomin');
  zoomin.button({
    icons:{
      primary:'ui-icon ui-icon-zoomin'
    },
    text:false
  });

  var zoomout = $('#zoomout');
  zoomout.button({
    icons:{
      primary:'ui-icon ui-icon-zoomout'
    },
    text:false
  });

  var zoomHandler = function(zoomRatio) {
    var currentLocation = self._locationManager.lastUnfilledLocationChangeRequest() || self._locationManager.currentLocation();
    var mid = currentLocation.start() + currentLocation.width() * 0.5;
    var width = Math.round(currentLocation.width() * zoomRatio);
    var start = Math.round(mid - width * 0.5);
    self._updateSelectedLocation(
      new epiviz.datatypes.GenomicRange(currentLocation.seqName(), start, width));
  };

  zoomin.click(function() { zoomHandler(self._zoominRatio); });
  zoomout.click(function() { zoomHandler(self._zoomoutRatio); });
};

epiviz.ui.ControlManager.prototype._initializeLocationSettingsDialog = function() {
  // TODO: Remove location-settings-dialog div, and create it dynamically
  var self = this;
  $('#location-settings')
    .button({
      text: false,
      icons: {
        primary: 'ui-icon ui-icon-gear'
      }
    })
    .click(function() {
      $('#location-settings-dialog').dialog('open');
    });

  $('#location-settings-dialog').dialog({
    autoOpen: false,
    resizable: false,
    width: '300',
    buttons: {
      'Ok': function() {
        self._zoominRatio = $('#zoomin-ratio-text').val();
        self._zoomoutRatio = $('#zoomout-ratio-text').val();
        self._stepRatio = $('#navigation-step-ratio-text').val();
        $(this).dialog('close');
      },
      'Cancel': function() {
        $('#zoomin-ratio-text').val(Globalize.format(self._zoominRatio, 'n3'));
        $('#zoomout-ratio-text').val(Globalize.format(self._zoomoutRatio, 'n3'));
        $('#navigation-step-ratio-text').val(Globalize.format(self._stepRatio, 'n6'));
        $(this).dialog('close');
      }
    },
    modal:true
  });

  $('#zoomout-ratio-text').spinner({
    min: 1.001,
    max: 1000.000,
    step: 0.001,
    start: 1.200,
    numberFormat: 'n3'
  }).val(self._zoomoutRatio);

  $('#zoomin-ratio-text').spinner({
    min: 0.001,
    max: 0.999,
    step: 0.010,
    start: 0.800,
    numberFormat: 'n3'
  }).val(self._zoominRatio);

  $('#navigation-step-ratio-text').spinner({
    min:   0.000001,
    max:   1.000000,
    step:  0.000001,
    start: 0.200000,
    numberFormat: 'n6'
  }).val(self._stepRatio);
};

epiviz.ui.ControlManager.prototype._initializeChartMenus = function() {
  var self = this;
  var visMenu = $('#vis-menu');

  $('#vis-menu-button')
    .button({
      text: false,
      icons: {
        primary: 'ui-icon ui-icon-scatterplot', // 'ui-icon ui-icon-bookmark',
        secondary: "ui-icon-triangle-1-s"
      }
    })
    .click(function() {
      var menu = visMenu;
      var visible = menu.is(":visible");
      $('.dropdown-menu').find(">:first-child").hide();
      if (!visible) {
        menu.show().position({
          my: "left top",
          at: "left bottom",
          of: this
        });
      }
      else {
        menu.hide();
      }
/*      $( document ).one('click', function() {
        menu.hide();
      });*/
      return false;
    });

  /** @type {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<epiviz.ui.charts.ChartType>>} */
  var chartsByDisplayType = {};

  var displayTypeLabels = epiviz.ui.ControlManager.DISPLAY_TYPE_LABELS;

  this._chartFactory.foreach(
    /**
     * @param {string} typeName
     * @param {epiviz.ui.charts.ChartType} chartType
     */
    function(typeName, chartType) {
      if (!(chartType.chartDisplayType() in chartsByDisplayType)) { chartsByDisplayType[chartType.chartDisplayType()] = []; }
      chartsByDisplayType[chartType.chartDisplayType()].push(chartType);
    });

  for (var displayType in chartsByDisplayType) {
    if (!chartsByDisplayType.hasOwnProperty(displayType)) { continue; }
    $(sprintf('<li class="ui-widget-header">%s</li>', displayTypeLabels[displayType])).appendTo(visMenu);
    chartsByDisplayType[displayType].forEach(function(chartType, i) {
      var id = sprintf('%s-menu-add-%s', chartType.chartDisplayType(), chartType.chartHtmlAttributeName());
      visMenu.append(sprintf('<li><a href="javascript:void(0)" id="%s">Add New %s</a></li>', id, chartType.chartName()));

      $('#' + id).click(function() {
        var wizardSteps = [];
        if (chartType.isRestrictedToSameDatasourceGroup()) {
          wizardSteps.push(new epiviz.ui.controls.DatasourceGroupWizardStep());
        }
        if (chartType.chartDisplayType() != epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) {
          wizardSteps.push(new epiviz.ui.controls.MeaurementsWizardStep());
        }

        if (!wizardSteps.length) {
          self._addChart.notify({
            type: chartType,
            visConfigSelection: new epiviz.ui.controls.VisConfigSelection(
              self._measurementsManager.measurements().subset(chartType.measurementsFilter()))});
          return;
        }

        var wizardMeasurements = self._measurementsManager.measurements().subset(chartType.measurementsFilter());
        wizardMeasurements.addAll(self._measurementsManager.measurements()
          .map(function(m) { return m.datasource(); })
          .subset(chartType.measurementsFilter()));
        var dialog = new epiviz.ui.controls.Wizard(
          sprintf('Add new %s', chartType.chartName()),
          {finish:
            /** @param {epiviz.ui.controls.VisConfigSelection} data */
            function(data) {
              self._addChart.notify({type: chartType, visConfigSelection: data});
            }
          },
          wizardSteps,
          new epiviz.ui.controls.VisConfigSelection(
            wizardMeasurements, // measurements
            undefined, // datasource
            undefined, // datasourceGroup
            undefined, // dataprovider
            undefined, // annotation
            chartType.chartName(), // defaultChartType
            chartType.minSelectedMeasurements()),
          '750', undefined, // size of dialog
          chartType.isRestrictedToSameDatasourceGroup()); // showTabs
        dialog.show();

        visMenu.hide();
      });
    });
  }

  visMenu.hide().menu();
};

epiviz.ui.ControlManager.prototype._initializeComputedMeasurementsMenu = function() {
  var self = this;
  $('#computed-measurements-button')
    .button({
      text: false,
      icons: {
        primary: 'ui-icon ui-icon-calculator'
      }
    })
    .click(function() {
      var dialog = new epiviz.ui.controls.ComputedMeasurementsDialog(
        'Computed Measurements',
        {
          add: function(measurement) {
            self._measurementsManager.addMeasurement(measurement);
          },
          remove: function(measurement) {
            self._measurementsManager.removeMeasurement(measurement);
          },
          close: function() {}
        },
        self._measurementsManager.measurements(),
        self._chartManager.chartsMeasurements()
      );

      dialog.show();
    });
};

epiviz.ui.ControlManager.prototype._initializeHelpButton = function() {
  $('#help-button').button({
    text: false,
    icons: {
      primary: 'ui-icon ui-icon-help'
    }
  }).click(
    function() {
      var win=window.open('http://epiviz.github.io/', '_blank');
      win.focus();
    });
};

epiviz.ui.ControlManager.prototype._initializeTutorials = function() {
  var self = this;

  var tutorialMenu = $('#help-tutorials');

  var tuts = new epiviz.ui.tutorials();

  var tMenu = '<div class="dropdown-menu">' +
      '<ul id="tutorial-list">' +
      '<li class="ui-widget-header">Tutorials</li>';

  if(tuts._tutorialList.length > 0) {
    tuts._tutorialList.forEach(function(t) {
      tMenu += '<li><a href="javascript:void(0);" id="' + t.id +'">' + t.name + '</a></li>';
    });
  }
  else {
    tMenu += '<li>No Tutorials available</li>';
  }

  tMenu += '</ul>' +
      '</div>';

  $(sprintf(tMenu)).insertAfter(tutorialMenu);

  var tutorialList = $('#tutorial-list');

  tutorialList.hide().menu();

  tutorialMenu.button({
    icons:{
      primary:'ui-icon ui-icon-info',
      secondary: "ui-icon-triangle-1-s"
    },
    text:false
  })
  .click( function() {

    var visible = tutorialList.is(":visible");
    if (!visible) {
      tutorialList.show().position({
        my: "left top",
        at: "left bottom",
        of: this
      });
    }
    else {
      tutorialList.hide()
    }
    return false;
  });

  if(tuts._tutorialList.length > 0) {
    tuts._tutorialList.forEach(function(t) {
      $('#' + t.id).click(function() {
        var anno = new Anno(t.tutorial);
        anno.show();
        tutorialList.hide();
      });
    });
  }
};

epiviz.ui.ControlManager.prototype._initializeScreenshotMenu = function() {
  var self = this;

  var savePageButton = $('#save-page');

  savePageButton.button({
    icons:{
      primary:'ui-icon ui-icon-print'
    },
    text:false
  })
  .click( function() {

    self._saveWorkspace.notify({name: name, id: name == self._activeWorkspaceInfo.name ? self._activeWorkspaceInfo.id : null});

    savePageButton.append(sprintf('<div id="loading" title="printing workspace">' +
        '<p>Save/Print the existing EpiViz workspace.</p>' +
        '<div style="position:absolute; right:15px;">' +
        '<select class="screenshot-file-format">' +
          '<option value="pdf" selected="selected">PDF</option>' +
          '<option value="png" >PNG</option>' +
        '</select>' +
        '</div>' +
        '</div>'));

    savePageButton.find("#loading").dialog({
      resizable: false,
      modal: true,
      title: "Print workspace as image",
      buttons: {
        "Print": function () {

          // hide the dialog box from the UI so that its not in the screenshot
          $(this).dialog('close');

          var format = $('.screenshot-file-format option:selected').val();
          var timestamp = Math.floor($.now() / 1000);

          var workspace_id = self._activeWorkspaceInfo.id;
          var pm = new epiviz.ui.PrintManager('pagemain', "epiviz_" + timestamp, format, workspace_id);
          pm.print();

          $(this).dialog('destroy').remove();
        },
        "cancel": function () {
          $(this).dialog('destroy').remove();
        }
      }
    }).show();
  });

};

epiviz.ui.ControlManager.prototype._initializeSearchBox = function() {
  var self = this;

  var searchBox = $('#search-box');
  searchBox.watermark('Find Gene/Probe');

  searchBox.autocomplete({
    source: function(request, callback) {
      self._search.notify({ searchTerm: request.term, callback:
        /**
         * @param {Array.<{probe: string, gene: string, seqName: string, start: number, end: number}>} results
         */
        function(results) {
          var items = [];
          for (var i = 0; i < results.length; ++i) {
            items.push({
              value: results[i].probe || results[i].gene,
              label: results[i].probe || results[i].gene,
              html: results[i].probe ?
                sprintf('<b>%s</b>, %s, [%s: %s - %s]',
                  results[i].probe, results[i].gene, results[i].seqName,
                  Globalize.format(results[i].start, 'n0'), Globalize.format(results[i].end, 'n0')) :
                sprintf('<b>%s</b>, [%s: %s - %s]',
                  results[i].gene, results[i].seqName,
                  Globalize.format(results[i].start, 'n0'), Globalize.format(results[i].end, 'n0')),
              range: epiviz.datatypes.GenomicRange.fromStartEnd(results[i].seqName, results[i].start, results[i].end)
            });
          }

          callback(items);
        }});
    },
    minLength: 1,
    select: function(event, ui) {
      var currentLocation = self._locationManager.lastUnfilledLocationChangeRequest() || self._locationManager.currentLocation();
      var seqName = ui.item.range.seqName();
      var start = Math.round(ui.item.range.start() - ui.item.range.width() * 11);
      var width = ui.item.range.width() * 22;
      self._updateSelectedLocation(new epiviz.datatypes.GenomicRange(seqName, start, width));
    },
    focus: function(event) {
      event.preventDefault();
    },
    open: function() {},
    close: function() {}
  }).data('autocomplete')._renderItem = function(ul, item) {
    return $('<li></li>')
      .data( 'item.autocomplete', item )
      .append(sprintf('<a>%s</a>', item.html))
      .appendTo(ul);
  };
};

epiviz.ui.ControlManager.prototype._initializeWorkspaceSaving = function() {
  var self = this;

  var saveTextBox = $('#save-workspace-text');
  var saveWorkspaceButton = $('#save-workspace-button');
  var revertWorkspaceButton = $('#revert-workspace-button');
  var deleteWorkspaceButton = $('#delete-workspace-button');

  saveWorkspaceButton.button({
    text: false,
    icons: {
      primary: 'ui-icon-disk'
    }
  }).click(function() {
    var dialog = null;

    try {
      var name = saveTextBox.val();
      var pattern = /[a-zA-Z0-9_\s]+/g;

      var result = pattern.exec(name);

      if (result == name) { // Name is good.

        if (!epiviz.workspaces.UserManager.USER_STATUS.loggedIn) {
          dialog = new epiviz.ui.controls.MessageDialog(
            'User not logged in',
            {
              Yes: function() { self._loginLinkClicked.notify(); },
              No: function() {}
            },
            'You need to log in in order to save the workspace. Do you wish to log in now?',
            epiviz.ui.controls.MessageDialog.Icon.QUESTION);
          dialog.show();
          return;
        }

        self._saveWorkspace.notify({name: name, id: name == self._activeWorkspaceInfo.name ? self._activeWorkspaceInfo.id : null});
      } else {
        dialog = new epiviz.ui.controls.MessageDialog(
          'Invalid workspace name',
          { Ok: function() { $(this).remove(); } },
          'Invalid workspace name: ' + name,
          epiviz.ui.controls.MessageDialog.Icon.ERROR);
        dialog.show();
      }
    } catch(error) {
      dialog = new epiviz.ui.controls.MessageDialog(
        'Error',
        { ok: function() { $(this).remove(); } },
        'An error occurred while trying to save workspace: ' + error.message,
        epiviz.ui.controls.MessageDialog.Icon.ERROR);
      dialog.show();
    }
  });

  deleteWorkspaceButton.button({
    text: false,
    icons: {
      primary: 'ui-icon-trash'
    }
  }).click(function(e) {
    // Delete the active workspace

    if (!epiviz.workspaces.UserManager.USER_STATUS.loggedIn) {
      // Only a logged in user can delete a workspace
      return;
    }

    var dialog = new epiviz.ui.controls.MessageDialog(
      'Delete active workspace',
      {
        Yes: function() { self._deleteActiveWorkspace.notify(); },
        No: function() {}
      },
      'Are you sure you want to delete the active workspace?',
      epiviz.ui.controls.MessageDialog.Icon.QUESTION);
    dialog.show();
  });

  revertWorkspaceButton.button({
    text: false,
    icons: {
      primary: 'ui-icon-arrowreturnthick-1-w'
    }
  }).click(function(e) {
    var dialog = new epiviz.ui.controls.MessageDialog(
      'Delete active workspace',
      {
        Yes: function() { self._revertActiveWorkspace.notify(); },
        No: function() {}
      },
      'Are you sure you want to revert the changes on the active workspace?',
      epiviz.ui.controls.MessageDialog.Icon.QUESTION);
    dialog.show();
  });

  saveTextBox.watermark('Save Workspace Name');

  saveTextBox.autocomplete({
    source: function(request, callback) {
      self._searchWorkspaces.notify({ searchTerm: request.term, callback: function(workspaces) {
        var items = [];
        for (var i = 0; i < workspaces.length; ++i) {
          items.push({
            value: workspaces[i].id,
            label: workspaces[i].name,
            html: sprintf('<b>%s</b> %s', workspaces[i].name, workspaces[i].id || '')
          });
        }

        callback(items);
      }});
    },
    minLength: 0,
    select: function(event, ui) {
      event.preventDefault();
      self.updateSelectedWorkspace({id: ui.item.value || saveTextBox.val(), name: ui.item.label});
    },
    focus: function(event) {
      event.preventDefault();
    },
    open: function() {},
    close: function() {}
  }).data('autocomplete')._renderItem = function(ul, item) {
    return $('<li></li>')
      .data( 'item.autocomplete', item )
      .append(sprintf('<a>%s</a>', item.html))
      .appendTo(ul);
  };

  saveTextBox.click(function() { saveTextBox.autocomplete('search', ''); });
};

/**
 * @private
 */
epiviz.ui.ControlManager.prototype._initializeLoginLink = function() {
  var self = this;
  $('#login-link').live({ click: function() {
      self._loginLinkClicked.notify();
  }});
};

/**
 * @private
 */
epiviz.ui.ControlManager.prototype._initializeLayout = function() {
  var layout = $('body').layout({
    applyDefaultStyles: true,
    east__size:    390,
    east__minSize: 390,
    east__initHidden: true,
    north__resizable: false,
    north__initHidden: false,
    south__initHidden: true,
    east__initClosed: true
  });
};

/**
 * @private
 */
epiviz.ui.ControlManager.prototype._checkBrowserCompatibility = function() {
  var ie = epiviz.utils.getInternetExplorerVersion();
  if (ie > 0) {
    var dialog = new epiviz.ui.controls.MessageDialog(
      'Browser compatibility warning',
      {
        Ok: function() {}
      },
      'EpiViz works best on Google Chrome, Apple Safari or Mozilla Firefox. Please open it using one of those browsers.',
      epiviz.ui.controls.MessageDialog.Icon.ERROR);
    dialog.show();
  }
};

/**
 * @private
 */
epiviz.ui.ControlManager.prototype._registerLocationChanged = function() {
  var self = this;
  this._locationManager.onCurrentLocationChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {{oldValue: epiviz.datatypes.GenomicRange, newValue: epiviz.datatypes.GenomicRange}} e
     */
    function(e) {
      self._updateSelectedLocation(e.newValue);
    }));
};

/**
 * @private
 */
epiviz.ui.ControlManager.prototype._registerSeqInfosUpdated = function() {
  var self = this;
  this._locationManager.onSeqInfosUpdated().addListener(new epiviz.events.EventListener(function(seqNames) {
    self._updateSeqNames(seqNames);
  }));
};

// Input 182
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/11/14
 * Time: 12:01 PM
 */

goog.provide('epiviz.ui.LocationManager');

goog.require('epiviz.events.Event');
goog.require('epiviz.datatypes.GenomicRange');

/**
 * @param {epiviz.Config} config
 * @constructor
 */
epiviz.ui.LocationManager = function(config) {
  /**
   * @type {Object.<string, epiviz.datatypes.SeqInfo>}
   * @private
   */
  this._seqInfos = {};

  /**
   * @type {epiviz.datatypes.GenomicRange}
   * @private
   */
  this._currentLocation = null;

  /**
   * @type {?epiviz.datatypes.GenomicRange}
   * @private
   */
  this._lastUnfilledRequest = null;

  /**
   * @type {?number}
   * @private
   */
  this._timeout = null;

  /**
   * @type {number}
   * @private
   */
  this._navigationDelay = config.navigationDelay;

  /**
   * @type {epiviz.events.Event.<{oldValue: epiviz.datatypes.GenomicRange, newValue: epiviz.datatypes.GenomicRange}>}
   * @private
   */
  this._currentLocationChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<Array.<epiviz.datatypes.SeqInfo>>}
   * @private
   */
  this._seqInfosUpdated = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event}
   * @private
   */
  this._requestSeqInfos = new epiviz.events.Event();
};

epiviz.ui.LocationManager.prototype.initialize = function() {
  this._requestSeqInfos.notify();
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 */
epiviz.ui.LocationManager.prototype.changeCurrentLocation = function(range) {
  if (this._currentLocationChanged.isFiring()) {
    // Event cannot be fired again until it finishes firing;
    // Avoid infinite loops
    return;
  }

  this._lastUnfilledRequest = range;

  if (this._timeout !== null) {
    window.clearTimeout(this._timeout);
    this._timeout = null;
  }

  var self = this;
  var locationChangeFunction = function() {
    var request = self._lastUnfilledRequest;

    if (request === null) { return; }

    self._doChangeCurrentLocation(request);
  };

  if (this._navigationDelay) {
    this._timeout = window.setTimeout(locationChangeFunction, this._navigationDelay);
  } else {
    locationChangeFunction();
  }
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 */
epiviz.ui.LocationManager.prototype._doChangeCurrentLocation = function(range) {
  var oldValue = this._currentLocation;

  var seqName = range.seqName();
  if (!(range.seqName() in this._seqInfos)) {
    if (!oldValue) { return; }
    seqName = oldValue.seqName();
  }

  var start = undefined, end = undefined;
  if (this._seqInfos[seqName] && this._seqInfos[seqName].min != undefined && this._seqInfos[seqName].max != undefined) {
    start = range.start() != undefined && range.start() >= this._seqInfos[seqName].min ? range.start() : this._seqInfos[seqName].min;
    end = range.width() != undefined ? start + range.width() : start + 9999; // TODO: Set this constant somewhere
  }

  if (start != undefined && end != undefined &&
    end > this._seqInfos[seqName].max) {
    start = Math.max(this._seqInfos[seqName].min, this._seqInfos[seqName].max - end + start);
    end = this._seqInfos[seqName].max;
  }

  this._lastUnfilledRequest = null;

  this._currentLocation = epiviz.datatypes.GenomicRange.fromStartEnd(seqName, start, end);

  this._currentLocationChanged.notify({oldValue: oldValue, newValue: this._currentLocation});
};

/**
 * @returns {epiviz.datatypes.GenomicRange}
 */
epiviz.ui.LocationManager.prototype.currentLocation = function() { return this._currentLocation; };

/**
 * @returns {?epiviz.datatypes.GenomicRange}
 */
epiviz.ui.LocationManager.prototype.lastUnfilledLocationChangeRequest = function() { return this._lastUnfilledRequest; };

/**
 * @param {Array.<epiviz.datatypes.SeqInfo>} seqInfos
 */
epiviz.ui.LocationManager.prototype.updateSeqInfos = function(seqInfos) {
  this._seqInfos = {};
  for (var i = 0; i < seqInfos.length; ++i) {
    this._seqInfos[seqInfos[i].seqName] = seqInfos[i];
  }

  this._seqInfosUpdated.notify(seqInfos);

  if (this._lastUnfilledRequest !== null) {
    if (this._lastUnfilledRequest.seqName() in this._seqInfos) {
      this._doChangeCurrentLocation(this._lastUnfilledRequest);
    } else if (seqInfos.length > 0) {
      var request = new epiviz.datatypes.GenomicRange(seqInfos[0].seqName, this._lastUnfilledRequest.start(), this._lastUnfilledRequest.width());
      this._doChangeCurrentLocation(request);
    }
  }
};

/**
 * @param {Array.<epiviz.datatypes.SeqInfo>} seqInfos
 */
epiviz.ui.LocationManager.prototype.addSeqInfos = function(seqInfos) {
  for (var i = 0; i < seqInfos.length; ++i) {
    if (!this._seqInfos[seqInfos[i].seqName]) {
      this._seqInfos[seqInfos[i].seqName] = seqInfos[i];
    }
  }

  var eventSeqInfos = [];
  for (var seqName in this._seqInfos) {
    if (!this._seqInfos.hasOwnProperty(seqName)) { continue; }
    eventSeqInfos.push(this._seqInfos[seqName]);
  }

  this._seqInfosUpdated.notify(eventSeqInfos);
};

/**
 * @param {Array.<string>} seqNames
 */
epiviz.ui.LocationManager.prototype.removeSeqNames = function(seqNames) {

  for (var i = 0; i < seqNames.length; ++i) {
    delete this._seqInfos[seqNames[i]];
  }

  var eventSeqInfos = [];
  for (var seqName in this._seqInfos) {
    if (!this._seqInfos.hasOwnProperty(seqName)) { continue; }
    eventSeqInfos.push(this._seqInfos[seqName]);
  }

  this._seqInfosUpdated.notify(eventSeqInfos);

  if (!(this._currentLocation.seqName() in this._seqInfos)) {
    this.changeCurrentLocation(new epiviz.datatypes.GenomicRange(
      eventSeqInfos[0].seqName,
      this._currentLocation.start(),
      this._currentLocation.width()));
  }
};

/**
 * @returns {Object.<string, epiviz.datatypes.SeqInfo>}
 */
epiviz.ui.LocationManager.prototype.seqInfos = function() { return this._seqInfos; };

/**
 * @returns {epiviz.events.Event.<{oldValue: epiviz.datatypes.GenomicRange, newValue: epiviz.datatypes.GenomicRange}>}
 */
epiviz.ui.LocationManager.prototype.onCurrentLocationChanged = function() { return this._currentLocationChanged; };

/**
 * @returns {epiviz.events.Event.<Array.<epiviz.datatypes.SeqInfo>>}
 */
epiviz.ui.LocationManager.prototype.onSeqInfosUpdated = function() { return this._seqInfosUpdated; };

/**
 * @returns {epiviz.events.Event}
 */
epiviz.ui.LocationManager.prototype.onRequestSeqInfos = function() { return this._requestSeqInfos; };

// Input 183
goog.provide('epiviz.ui.tutorials');

epiviz.ui.tutorials = function() {
    this._tutorialList = [
        {
            "name": 'Epiviz Overview',
            "id": 'tut_epiviz_overview',
            "tutorial": [
                {
                    target: 'body',
                    content: "<p class='intro-header'>Welcome to Epiviz Genomic Browser!<br></p>" +
                    "<p class='intro-text'>This tutorial will walk you through the functionality available in Epiviz.</p>",
                    position: 'center'
                }, {
                    target: '#intro-navigation',
                    content: "<p class='intro-text'>The navigation section of Epiviz lets you select a chromosome and explore the genome. Options are available to move left/right and zoom in/out.</p>" +
                    "<p class='intro-text'>The settings icon allows you to control the navigation parameters.</p>",
                    position: 'right',
                    buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
                }, {
                    target: '#search-box',
                    content: "<p class='intro-header'>Use the search input to look for a specific gene or target.</p>" +
                    "<p class='intro-text'>This will navigate Epiviz to the selected gene location and update the workspace with the new data.</p>",
                    position: 'right',
                    buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
                }, {
                    target: '#vis-menu-button',
                    content: '<p class="intro-text">Choose from a list of available data sources, measurements or chart types to add visualizations to the Epiviz Workspace.</p>',
                    position: 'right',
                    buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
                }, {
                    target: '#intro-workspace',
                    content: '<p class="intro-header">managing workspaces.</p>' +
                    '<p class="intro-text">If you are logged in, you will be able to save your Epiviz analysis and workspaces.' +
                    'You will also be able to retrieve them at a later time from your account.</p>',
                    position: 'right',
                    buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
                }, {
                    target: '#login-link',
                    content: '<p class="intro-text">Please login to save and manage Epiviz workspaces.</p>',
                    position: 'left',
                    buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
                }, {
                    target: 'body',
                    content: "<p class='intro-header'>Thank you for using Epiviz!</p>" +
                    '<p class="intro-text">If you would like to give us some feedback or stay informed with updates, Please visit the <a target="_blank" href="http://epiviz.github.io/">Epiviz webpage</a>.</p>',
                    position: 'center'
                }]
        }, {
            "name": 'Data Visualization and Controls',
            "id": 'tut_data_controls',
            "tutorial": [{
                target: 'body',
                content: "<p class='intro-header'>Welcome to Epiviz Genomic Browser!<br><br>" +
                "Data visualization tutorial<br></p>" +
                "<p class='intro-text'>This tutorial will help create/add new data visualizations to the Epiviz workspace " +
                "and controls available for each visualization.</p>",
                position: 'center'
            }, {
                target: '#vis-menu-button',
                content: '<p class="intro-text">The Data Visualizations button helps users add new charts to the workspace.</p>' +
                '<p>Users have the option to choose data sources and measurements to add to the workspace.</p>',
                position: 'right',
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $('#vis-menu-button').button().trigger("click");
                },
                showOverlay: function(){},
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: '#vis-menu',
                content: '<p class="intro-text">Choose the type of chart to add to your workspace. We choose scatter plot to continue with the tutorial</p>',
                position: 'right',
                onShow: function(anno, $target, $annoElem) {
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $('#plot-menu-add-scatter').trigger("click");
                },
                showOverlay: function(){},
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() {
                    var parent = $('#wizardDialog').parent().attr('id');
                    var p_parent = $('#' + parent).parent();
                    return p_parent;
                },
                content: '<p class="intro-text">This window lets you choose form a list of data sources and ' +
                'the measurements available from each data source to add to your Epiviz workspace</p>' +
                '<p>We selected the first data source in the table or choose a data source from the list.</p>',
                showOverlay: function(){},
                onShow: function(anno, $target, $annoElem) {
                    $('#wizardDialog table tbody tr:first').trigger('click');
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $('.ui-button:contains("Next")').trigger('click');
                },
                position: 'right',
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() {
                    var parent = $('#wizardDialog').parent().attr('id');
                    var p_parent = $('#' + parent).parent();
                    return p_parent;
                },
                content: '<p class="intro-text">After choosing a data source, the next tab lists all the measurements (or features) ' +
                'available from this data source. If you have any computed measurements for this data source, they will be added to this list.</p>' +
                '<p>To add a plot to the workspace, pick a few measurements and select finish on this window. </p>',
                showOverlay: function(){},
                position: 'right',
                onShow: function(anno, $target, $annoElem) {
                    //$('#wizardDialog table tbody tr:first').trigger('click');
                    //$('#wizardDialog table tbody tr:eq(2)').trigger('click');
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    var parent = $('#wizardDialog').parent().attr('id');
                    $('#' + parent).dialog('close');
                    //$('.ui-button:contains("Finish")').trigger('click');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: '#feature-view',
                content: '<p class="intro-text">Visualizations are added to the workspace based on the type of chart. </p>' +
                '<p>Brushing is implemented on all the plots. When you hover over a data point, it highlight that region in the gene on all the visualizations.</p>',
                position: {
                    top: '24em',
                    left: '14em'
                },
                showOverlay: function(){},
                onShow: function(anno, $target, $annoElem) {

                    $('button:contains("Remove"):first').css('display', 'block');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() {
                    return $('button:contains("Remove"):first');
                },
                content: '<p class="intro-text">Removes the plot from the workspace</p>',
                position: 'left',
                showOverlay: function(){},
                className: 'anno-width-175',
                onShow: function(anno, $target, $annoElem) {
                    $('button:contains("Save"):eq(1)').css('display', 'block');
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $($target).css('display', 'none');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() { return $('button:contains("Save"):eq(1)'); },
                content: '<p class="intro-text">Save a plot to your local machine (image, pdf)</p>',
                position: 'left',
                showOverlay: function(){},
                className: 'anno-width-175',
                onShow: function(anno, $target, $annoElem) {
                    $('button:contains("Custom settings"):first').css('display', 'inline-block');
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $($target).css('display', 'none');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() { return $('button:contains("Custom settings"):first'); },
                content: '<p class="intro-text">Change chart display properties and aggregation methods for grouping.</p>',
                position: 'left',
                showOverlay: function(){},
                className: 'anno-width-175',
                onShow: function(anno, $target, $annoElem) {
                    $('button:contains("Code"):first').css('display', 'inline-block');
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $($target).css('display', 'none');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() { return $('button:contains("Code"):first'); },
                content: '<p class="intro-text">Edit code to redraw the chart on the workspace.</p>',
                position: 'left',
                showOverlay: function(){},
                className: 'anno-width-175',
                onShow: function(anno, $target, $annoElem) {
                    $('button:contains("Colors"):first').css('display', 'inline-block');
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $($target).css('display', 'none');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() { return $('button:contains("Colors"):first'); },
                content: '<p class="intro-text">Choose colors for data points on the plot</p>',
                position: 'left',
                showOverlay: function(){},
                className: 'anno-width-175',
                onShow: function(anno, $target, $annoElem) {
                    $('label:contains("Toggle tooltip"):first').css('display', 'block');
                },
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $($target).css('display', 'none');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: function() {
                    return $('label:contains("Toggle tooltip"):first');
                },
                content: '<p class="intro-text">Toggle tooltips for data points</p>',
                position: 'right',
                showOverlay: function(){},
                className: 'anno-width-175',
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    $($target).css('display', 'none');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: 'body',
                content: "<p class='intro-header'>Thank you for using Epiviz!</p>" +
                '<p class="intro-text">If you would like to give us some feedback or stay informed with updates, Please visit the <a target="_blank" href="http://epiviz.github.io/">Epiviz webpage</a>.</p>',
                position: 'center'
            }]
        }, {
            "name": 'Computed Measurements',
            "id": 'tut_comp_measurements',
            "tutorial": [{
                target: 'body',
                content: "<p class='intro-header'>Welcome to Epiviz Genomic Browser!<br>" +
                "Compute Measurements Tutorial<br></p>" +
                "<p class='intro-text'>This tutorial will help you create new measurements (derived from existing measurements) and generate plots to add " +
                "to the workspace.</p>",
                position: 'center'
            }, {
                target: '#computed-measurements-button',
                content: "<p class='intro-text'>The computed measurements button helps users " +
                "add new measurements to data sources</p>",
                position: 'right',
                onShow: function(anno, $target, $annoElem) {
                    $('#computed-measurements-button').button().trigger("click");
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: '#computedMeasurementsDialog',
                content: "<p class='intro-text'>This tab lets you " +
                "choose a data source where you will create a new measurement.</p>" +
                "<p>We choose the first data source in the list or choose any data source.</p>",
                position: {
                    top: '20em',
                    left: '1em'
                },
                showOverlay: function(){},
                onShow: function(anno, $target, $annoElem) {
                    $('#computedMeasurementsDialog table tbody tr td:first').trigger('click');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: '#computedMeasurementsDialog',
                content: "<p class='intro-text'>The measurements tab lists " +
                "all available measurements from the selected data source (including previously created computed measurements).</p>" +
                "<p>Use the buttons next to each measurement to add to the expression window</p>",
                position: {
                    top: '20em',
                    left: '1em'
                },
                showOverlay: function(){},
                onShow: function(anno, $target, $annoElem) {
                    $('.ui-button:contains("Next")').trigger('click');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: '#computedMeasurementsDialog',
                content: "<p class='intro-text'> After choosing measurements, use mathematical operators to evaluate the expression.</p>" +
                "<p><a target='_blank' href='https://silentmatt.com/javascript-expression-evaluator/'>supported operators</a> </p>",
                position: {
                    top: '33em',
                    left: '1em'
                },
                showOverlay: function(){},
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: '#computedMeasurementsDialog',
                content: "<p class='intro-text'>After adding a computed measurement, " +
                "use the data visualization button to plot the measurement to your workspace.</p>" +
                "<p>To learn how to add new plots to the workspace, please use the Epiviz data visualization tutorial.</p>",
                position: {
                    top: '10em',
                    left: '1em'
                },
                showOverlay: function(){},
                onHide: function(anno, $target, $annoElem, returnFromOnShow) {
                    var parent = $('#computedMeasurementsDialog').parent().attr('id');
                    $('#' + parent).dialog('close');
                },
                buttons: [AnnoButton.BackButton, AnnoButton.NextButton]
            }, {
                target: 'body',
                content: "<p class='intro-header'>Thank you for using Epiviz!</p>" +
                '<p class="intro-text">If you would like to give us some feedback or stay informed with updates, Please visit the <a target="_blank" href="http://epiviz.github.io/">Epiviz webpage</a>.</p>',
                position: 'center'
            }]
        }
    ];
};
// Input 184
/**
 * Created by Jayaram Kancherla ( jkanche [at] umd [dot] edu )
 * Date: 4/6/2016
 */

goog.provide('epiviz.ui.PrintManager');

/**
 * @param {string} ctrId DOM ID to print/save. Can be the whole page or a epiviz.chart id.
 * @param {string} fName File Name to use
 * @param {string} fType File Format (pdf, png)
 * @constructor
 */
epiviz.ui.PrintManager = function(ctrId, fName, fType, workspaceId) {

    /**
     * DOM ID to print
     * @type {string}
     */
    this._containerId = ctrId ? ctrId : 'pagemain';

    /**
     * File Name for the screenshot/chart
     * @type {string}
     */
    this._fName = fName ? fName : "epiviz_" + Math.floor($.now() / 1000);

    /**
     * File Format to save (pdf, png)
     * @type {string}
     */
    this._fType = fType ? fType : "pdf";

    /**
     * workspace id of the current plot
     * @type {string}
     */
    this._workspaceId = workspaceId;
};


/**
 * Prints the chart or the specified DOM ID to a pdf or png.
 */
epiviz.ui.PrintManager.prototype.print = function() {

    var self = this;

    var container = $('#' + self._containerId);

    function inline_styles(dom) {
        var used = "";
        var sheets = document.styleSheets;
        for (var i = 0; i < sheets.length; i++) {
            var rules = sheets[i].cssRules;
            for (var j = 0; j < rules.length; j++) {
                var rule = rules[j];
                if (typeof(rule.style) != "undefined") {
                    var elems = dom.querySelectorAll(rule.selectorText);
                    if (elems.length > 0) {
                        used += rule.selectorText + " { " + rule.style.cssText + " }\n";
                    }
                }
            }
        }

        $(dom).find('style').remove();

        var s = document.createElement('style');
        s.setAttribute('type', 'text/css');
        s.innerHTML = "<![CDATA[\n" + used + "\n]]>";

        //dom.getElementsByTagName("defs")[0].appendChild(s);
        dom.insertBefore(s, dom.firstChild);
    }

    //add inline styles to svg elements
    function custom_styles(dom) {

        // style axes lines
        var axes = $(dom).find('.domain');
        axes.each(function () {
            $(this).css({"fill": "none", "stroke-width": "1px", "stroke": "#000000", "shape-rendering": "crispEdges"});
        });

        //remove gene name labels
        var gLabels = $(dom).find('.gene-name');
        gLabels.each(function () {
            $(this).remove();
        });

        // fill path on single line tracks

            var lines = $(dom).find('.lines path');
            lines.each(function() {
                $(this).css({"fill": "none"});
            });

        //change text size to fit screen
        var texts = $(dom).find('text');
        texts.each(function(){
            $(this).css({"font-size": "11px"});
        });

        var cLegends = $(dom).find('.chart-legend');
        cLegends.each(function() {
            $(this).css({"border": "none", "background": "transparent"});
        });
    }

    var svgElems = container.find('svg');

    svgElems.each(function () {
        var canvas, xml;

        canvas = document.createElement("canvas");
        canvas.className = "tempCanvas";

        custom_styles(this);

        // Convert SVG into a XML string
        xml = new XMLSerializer().serializeToString(this);

        // Removing the name space as IE throws an error
        xml = xml.replace(/xmlns=\"http:\/\/www\.w3\.org\/2000\/svg\"/, '');

        // draw the canvas object created from canvg
        var self = this;
        canvg(canvas, xml, {
            useCORS: true,
            renderCallback: function() {
                $(canvas).insertAfter(this);
                $(this).hide();
            }
        });
    });

    // use html2canvas to take a screenshot of the page!
    html2canvas(container, {
        //allowTaint: true,
        //taintTest: false,
        timeout: 0,
        //logging: true,
        width: container[0].scrollWidth + 200,
        height: container[0].scrollHeight + 200,
        useCORS: true
    }).then(function (canvas) {

        var ctx = canvas.getContext("2d");
        ctx.mozImageSmoothingEnabled = false;
        ctx.imageSmoothingEnabled = false;

        var filename = self._fName + "." + self._fType;
        var format = self._fType;
        var image = canvas.toDataURL("image/png");

        if(format == "pdf") {

            var dWidth = container[0].scrollWidth > 1400 ? container[0].scrollWidth : 1400;
            var dHeight = container[0].scrollHeight > 1000 ? container[0].scrollHeight : 1000;

            var jsdoc = new jsPDF('l', 'px', [dWidth * 0.6, dHeight * 0.65]);

            function toDataUrl(url, callback, outputFormat){
                var img = new Image();
                //img.crossOrigin = 'Anonymous';
                img.onload = function(){
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext('2d');
                    var dataURL;
                    canvas.height = this.height;
                    canvas.width = this.width;
                    ctx.drawImage(this, 0, 0);

                    dataURL = canvas.toDataURL(outputFormat);
                    callback(dataURL);
                    canvas = null;
                };
                img.src = url;
            }

            //TODO: save workspace if user is not signed in and get workspace id
            var s_url ="http://epiviz.cbcb.umd.edu/4/?ws=" + self._workspaceId;

            /*      toDataUrl(window.location.href + '/img/epiviz_4_logo_medium.png', function(imgData) {
             jsdoc.addImage(imgData, 'PNG', 20, 20, 100, 21);
             });*/
            jsdoc.addImage("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQ4AAAAyCAYAAACtfjXHAAAVX0lEQVR4nO1de5QU1Zn/db27errnxVMcHAaF+AxmiKLBRN3Bo+7RELOAB4OS1YVN9piHyQmY1SSuiYKJa8IxcSFZwyZRw2BO3NWsCeJj1SO7hEHFVzAwIIg4wsz0dE/XVHU9ev+oLqem+lZ3VVd1z6j1O6fOzNS9db9bNfd+93vd78balm/BREWit1tgWk8/T2cbLlDZxnlGjJ1tUPRkytAnq0yCYXUpb1DsAGWoBwHspoz8U/zgq9szUxYOjXffAXQAWAdgSfHv7QDWAugJmc46AGuKv/cUaWwPmUaEDykOPbC0qudiE41xJHq7Of3Erit1ir3aoLjLdIoX/TxPG3kNMLaxWu5+Lv3GI5kpC/Va9bUC9sNkHnYMApgPoDckGk8A6CLcn4/wGVSEDyGqZRxUyP2oGo3pPZN4LXu73L74sMy1bFWZ5Of9Mg0A0CmO0SnhcplrfTg36ZN/FdTBf0y99zxXiz6XwRqUMg0AaAawMSQaq0BmGoAphUSIUDNQydyBk8e5Dw2sLt0x3HjqAYVJ3qJT3JSwGtYpfpbMNt+Xa+3cK+QHqmOt1WFJmbIumAwkKFbVgUaECERQknjia7w29MPG9J6GehPn1cwywNir0uLNeowl0qcNuY/Vhp9mtez9rJa7W8j3387q0l2sLm2iDfkxFPSDlejodLxd5lq2sFruqcTIkTmhv0gpSNKGHeUmvdf2OyvUcZNGIkx8rANQALALE3QBoPQYyylM4zeHU3P3NEiHLq4H0Qbp8CRWy3UrbOq3AHWCvYw28mley/yGLqgrEvLRWTolTFOZhotVJnm9yiS+KXOt31FpcY1Ki6t1SrgCMXpWQj46nTbyqwHjccBQ3eiqTOIimZ/8UnJ439rDDy6ja/R6Haj8zw46qctJNPZ+TER0wJwU9mtN2Sc+erAWlk4EX2RqgvdtHDrFzxqOz3hCyA/c0Zjew9SKoKj0XTYiTHlFZRK2wW8YvJb9E6+mP8e++eA0hUmt0GPsb3LC9INe2swJ09/VKW4TQF2eGni5ndZHbqON/HukujrFxbMNJ9859/Mbnm489sJJobzUWHiZsEFVCS+MZ6IyjgiVsan4s8f2+4TCWONojKZkruXm4eQpzyZGjrSFSSjR280I+YF1EjfpDzrFTzPvGnley9wvKsdPVZjkpQrb9Ij8sZVKEDqZlrPf0en493h1sJ3XMl8DjHdJ9SR+6gVSy7yXROXYlUHoEUBSIbYS7lW7kjSjlHGQ2o8YxwcXawHEYHrHBse5L0QQvSo6HT9P5if/WZTf/VQYRJLD+6fIJ13xlMy1rEGMjgEGROXY75PZ/acrTOp6iZ/yZhh07JD4qSMKk/qJkE+fAuAHKOglDEmlxSaJa3kkIR/9QYiqC0mSIK0a1aorJIbTg1L3ayUbSIQIVcPVHatT3FRJmPKkkB+4PgiBhHx0niSe+Gedjl9g3jFeTMh9F0n85KuyyVP2BWnbC2SuZRjALYI6dAZtKNtKKsToWE6Y/u25V214tOGtR5IhkCSt9D0olQqqVVdIDGcTSmNDmqtsP0KEiqAA5MsU8zLX9Atey9x++MFlMb+NC/n+q2R+0vM6xc9EQZd5LXsTQM3PCdOfqb7L1UHmWvYd/O21lxaNqFlnuSRMvUydcfELjcd3zgpIyrnSDxYvUkCWX3WFpKZsL7ZPCiqL1JUINQGVzB04nS6oW2Bat0lVoDCpWzqW/fL+1JFtrJdGDz+4LMZqw7fIbNPDeoxN0EZ+l6AOdipM8h4ARnjd94e25VsKOsVtonXl47Q+ssNZrjCpM4ZbztohqINBxHznZLUYRhjqCsmbYoWXk3ThoOpKF0yPxy6UekJ2Fcsmott3TfFy9rkAoBvuAXoRPILKJmbt02Ps1byaXkgb8ituFVVaXDkybeEjjcd3lo3mTB3Zxp68ZON/qEzD7YjFQBvKnTrFnSdzk14Pv/vVQafjB4S3Hv00q0t3wsHIdEqYqjINTwv5/r+pomnSRLUkgUGU7iHxq664qSkAWaKpVlVZBTNk/gmYMQWk9+oslj1RrOvFRewGK27B7fLirm22tbMO7tGzS4pl1vt5Za4W89zlsX4lNAMYAPn9rPfoLvNsue9V7hog0PON920cCtv0QuLos528NnQzCrpMqqzS4uXDzWc+nsq8kSKVNw7sToxM/dR/KmzTCgBpVpcX6xT/bQBa0I6GjVzHUk2lxW8L+f7FtJHP2Mv0GJtU2dR/C/kBv5OBtIrZVQjS5jOvNJoJdS01xUmnXH8q0XgCZli8n2c7YA7yboyPXaULJiPwOyG6YDICLyH664s/OxGO4XkVzG81iPq6XC0GG0hSHGMczcy4RFWYxnWCmv4kbSgvkx7Q6finc4n2pxqkw5Ps91OZv7RKjR97UmUSl9GGspfXsueotPhfQTpXD8hc66MNQ68v4LXsXvt9PcZyMtv4EK8NfcFHc5UYRxB1pZyaYtFxqit+BngnzEkUZEAtgcl46qkGrCrSDMKw1hTbKIetGP1fBpGuLFj2LTvz94pBmO7aai5LMg3E/IheFZlrfbVh8JVzeS2zgWSS0Ol454gw+VlR7jsBABIj70zNNbQ/o9LiuawuPSuOvHO+wiT/GqRj9cRQ87w3+L4d5/Ja5g9jCmI0rTCNm3k17dWzVIlxkIykS+Bt0JMmtNNT45Q6vE5gS2Ig1d8EYCnGDr4WmLEGJCmnE/WTPJbAfdPgegCLUDpx3NIOdMFdNbBgfe+gjKMLo9+aFINTK3Ta6AZKveDqjh1qna8oTOqrQj59NQr6sLNcp4RTFa75eVHumx0rqBqAAq9lHxLTr1+STcwaCNKp8UBmxiVDzKE/Xslq2TsczJJWmOTPeTX9JQ/NVGIcAHmgVBqIJG9KD6Htal2yJKbRAzMAaTVK+zwIc2LOxqgIb0cn/O0CtgKe3C4SjQ4XGtsxythIk8NiKEtRutIvQXl1x/oOHQjGPKxne1E/xmEtDs1FmoHSLlTcVi9zLVtE5dgC2pDfcpbpFDdL4ZqeU9nGaYnju87e133DNUOt8wNFfo4nch1LDZVJ/nNC7rvezOtRRIyOKWzTT3k1fWOFJpziH0l9IA2USuoByYhKasdNAiiHNYQ62+E9p8dakCf2EtR2n8VGlH6TTTCZghfRf6tL3XVwl9TsgXZhMI562jasxaEH5mIQCJ7ycUjCtNfEkaMLaEPZ6SzTKX66RovP5ps+1tm2fIuLS/eDhZww/X5ROnwFbch2SSumsKkNvJq+2eUx0upOmsi98K+ukAapV8ZRTl1pRukK2wtzNfYCaxVzW6VrtXmtE2QJzO+EcHvGi9SxBNXZciyjqL2tWsPyHln/28Bh7J4T+WQTs94Vc29dxOrSY84yneJaVCb1pJDvr8vu2nog2zD7jw1Df/kMq2Vte10oKGzTHbya/hEhIM6LmmLBj7riVU1xo1ducNsHsYW1qDywrIRE5dyw1upfC1sHiWa1+Va2olSlKcfI12P0+1QjddhTSYaVCa4cLA/KIMxvFApNXxnAssk5kpjd9zm6oD7gLNMprsF0YfZ/NoyOTQQMNc/bLfa/dB6vZt6w31fYpm+0L9v8UCrzRtx2u1wMhxNuxjkSvKopbvTKMQ7nwPeic6+BGQvgpoZYas5qkFW1MECKng0yIZwqA4lZ22F9I7+qWIet3XpIG6swKj2Fmu/Wd+rAoaazNGrPfdexWnazs0yPsbzKpn4n5I9fG0rvxgGJkbdTrJbbxmvZLezLG+ihqRcc5I/tXMir6efs9XQ6vmwkcdL/iMqxmcVbpBXKbTCTNqW5BYORBrCbRZw0UcsxDiezKzeYV8FkGG4xDz0wJYxFqG2+02aQbTJBQHq+3HezG0n9uK/tRtFa2ze6MGo8Xhs2vapyjqof/4quMsm/57Whf3OW6TGWltnmzayWvSl49+oLXhuaKfNTnleZxCID1HSxbaEAAJkTugaYw9suEfIDYyaWSouflPjJu3ktsxj+VBWgdJK6rXJOqYDEdMrRdDOOum3GI9HfD7Ix0qK3GqaUUY/s6n6/sxeQ3OTlGIddwvGjrlgSSq2lDcv2BJgMg2S8DoQgyYoL+7pXfZnXMj8uKYnRMZVJ3s1r2XvZlzfUKtNWqBDyx8/RaPH/dIo7k9Vyj4vp1y4davlEzirPdSyV//rwl64WlffucbhrW1Ew1sOfqgJ4iyIl6dqVBp1XdYV0zy6tdME0qrnFdwzCXMlmo/6Rj6S+BIUfSQ0YfWevjMNuTK0l42jGqNt1O0LwoJAQKNNX2/ItBQX4Oq+mhxU2dYuTDylM8p/YM25oE/ID1xS3t09I8FrmOpmbdB+AOK9lf8337bh+aMYlJSkI25ZvMSTgJlF+96DET/5XxGgaADRaOBlAxlG9kn5vSQ52hmOpK4O2v52otKr3oHQwWxZ1L3CeB0PCephM46OMTTDtB80wJYlKzNP6npUkxqDohvn/tlTH9/HA/95eUvm52SX3VgKwZ8a7rXhvs71SKMcjKGzTrUI+fSNglJxhotLilSrTsENU+sY7m3oJEvJRgdWljQqT2gwgLirH7t7XfcN1GQLTsEMSpm0Q88eXoKBLAKBTAgWgyVHNy0StpK6QjJeVBh2JWXkV75uL991W200YDa5yg7UZbI3tChOk9xuP/TH2TYt+AvhqKW1sLNLx41K3Yx6AXwL4XvFqhzmu73FWDO1cFZlruVfID1xNF9SSDXI6xZ2hsM1/FvIDl4VFLygapEPzZbapR6XFVXRB1YX8wI0SP/mbXmNRJH7q73ktexEKOjG3KbwxjnLqih9vSiW6Xg23lvTjZAxbMeopKSdF2Q2X1g7VMPZ12FFNkFutYP0/uir0oR4b2tYU6QRxu9oZRBrA1wF8FaWLYrgHMsncpIcF5fjFtJEvyfOpU1yTzLU8xurSjxr7d/Fh0vWDZPZNVlAHbxuJT9+h0/HTaCOfEeT3rpC5lnv9tqWwTTtpI7+ALmikvKZe/nGkeAyLYXjZm+LWphNug5oUiAaYDG1T8acVnu1FvK60Ec8NfiQGkiFzvHKCeN34ZpVtRW3c01aqAMBk7tWoQhcWLwuW7fJrpMqhn+SWE6bv4NWhc1hdeolET6XFbww3n7FTyB8/PWzalSAqfZ+REu0vymzzd/QYy9CG/GZc6VuQi894vNo2dTp+QI9RpHM0vXJ8N3XFGSPgRU0BRjOO2eGmejhp2/dgrIbJNPx4SkhqifN5rxJROTj7TYokrRcqbXyzb8OvhZpi37OzNgCNX9p+PwjgJzAlkBJpA6jREZASP/mwIL39KVaXNpPKdUo4S+Ym7Wa13Pp6HASVGDkyh9Wl30n81Kd1ijsdAHgt+4eGzJvnDsfb3qj0fGWMPRumiGoZB2CuHtWoKW603c562QTyXo1qbAakrFq9IDMeJ02/k570LdzcxbWGpXq4bXyzx26E7a628qc0I5jbdSVMe4aF22AyjJVuD9Ts7Nhsco6k0uIXhXz/P9AFdYRQhVOZxLeGU3P/wmvZLyR6u0M/yyUx8vZprJb9VS4+/TWVFq8CEKMLqibkj6/d133DFUNNZ6VDIhUktoCkrpDa88M4SJKJm0vVOdjsMQBe0QVyYJibEZX0vn6YBymAqpp+hwE7QyjHOGph27Bc5UHcrk7j50swPSjt5R6q+aHTMtf6C1F6ez5tyLtJ5TrFz1CY5K/l9sV7eTX95cb0HiEIvURvNyfk+z/ParltufgJr6pMcgVAMQBAG8pBQX7vIpmbtD7kDXkOG4JxKLbrrjJJoEtQiSm4JTt2g5/Q8/WEtq3MWF6MjlYiHSe2wv293CQGP5vGSPlArH57bcduGwgCu5HULvWsKvalFkZRy4NS4nb1Cafx8+teHqrLafXZxKzXxdyhBbya/j5dUIkTSqe4DoVt+ulwau5RUXnvV8nh/Vcmers9MZHGYy9MF/L9y3gt8yu5fXGfzLU+rDKJRQBV3IhmgNWlf08M9348F5/xfHhvBoA4SKk3C/O/lSu974pKIqzfQefVJWuBZIW3MoJtROlKau2qtcqdsKJJ3eB2gNR+eE9rZ3kPnOjEaKQraS+JlYB5P0ZjHoLCUvmsmA4LdmNzmEZRy4PSi2BMowljjZ/PFK+KqNlRj05kk3NUALcmRo5syXPNG1VaPJ9UT6f4JomfsgL8lBW0eGKe14ZeB/BKzNDfAQppoFAoxBhRo8UmwJgDUHOHJp07CzFygCpt5A/wavorEj/lMTV1qqe+HnrAuwt85jXdpIHn16ptDSw3Hd2vbuxVVbFgDUBS2r9V8LeZy2qr3ETphSkxkFZ7UuyHW84Pa7UlSTxWn/0kFAqCrUWaS2D2tVYb2iymPQjvuUfc4DR+ftHrg3VjHBZy8RmvHn5w2cJT/u5nV6tMYp1OCTPd6uoUz+kUPw9mYIov0EY+QxW0H8b7d9+dmbKQZGMJC5VCt71iPcgTqRqjWjWxDr0wYzW6Ub2HYju853tYD3I+kGpozofJIMbz9LpNMBlHJ0zmYfUl7Cxf1jaEXgTbo9OOscbPzTC9KZ5QF1XFibblWwoy1/pQw+Crc3ht6EZaHzkSVtusLh3jtey/iNLb7Sotfr/GTAPwtyu2HEinsQHVhXb7cck6n7PiNvy8g6Wa+F0B11ZBiwQrzWE13yqsnBg9GGXw9uRGYds2rP52wOfRCNcsuPX96/DUkw7Y2rSCvTxjXBiHBTOvaeO91Ks/70gO718h5Ad2oFAStV4ZBV0X8v1PJrN7r9Vf+lmbwiS/m23oqNdhvaTVuZrBaOnsPY6/q12tnOqKnyMht8LcvLYI7nkceoplixBso5uTVpDVeT3MHKWr4Z6QyNqctxZm+HyYm8CWYqx0uB7h70zdDm/JllzRJfeirW9MJtAfw2QenhFrW06KXRo/NEiH5o4I0z6LWOxvAZyvx1iiOkUb+eOUkX+SgvEnbuTdP2aTc46G1Qc/No4IET4oeG72mdavL2JU/T8I4GyUMo4LATxt+3tMxru62zgqYVicuRfAXQDuSh56NG5M/sRphRh9ms6ITSgYlEFxR1DQ9/R237CvbfkWAwCUJPF8qAgRIpRiJcbaDG+DT2kDmICMw47szCtG4LINeaJJShEifEDwXdvvVrCXb0xoxhEhQoRQsRhjI0IPYiwjsaPd8feYerFC4UNxokGECBEq4LnZZ34XZp6NwBhXr0qECBHqipJD1apFpKpEiPDRwWaYkaJejjBpwlgj6jP2wkhViRDhIwKbO9YLLkQZd2ykqkSIEME3IsYRIUIE34gYR4QIEXwjYhwRIkTwjcirEiFCBBLSKJPU5/8B11FP6b8S6U4AAAAASUVORK5CYII=", 'PNG', 20, 20, 100, 21);
            //jsdoc.setFontSize(10);
            //jsdoc.text(150, 25, "Chromosome: Location");
            //jsdoc.setFontSize(14);
            //jsdoc.text(150, 40, $('#chromosome-selector').val() + ' : ' + $('#text-location').val());
            jsdoc.setTextColor(0, 0, 0);
            jsdoc.setFontSize(10);

            //if(self._workspaceId != null ) {
            //  jsdoc.text(350, 25, "Workspace ID");
            //  jsdoc.setTextColor(0, 0, 255);
            //  jsdoc.setFontSize(16);
            //  jsdoc.text(350, 45, s_url);
            //}

            //jsdoc.setFontSize(14);
            //jsdoc.text(350, 40, $('#save-workspace-text').val());
            jsdoc.addImage(image, 'PNG', 15, 55);
            jsdoc.save(filename);

        }
        else {

            if (navigator.msSaveBlob) {
                // IE 10+
                var image_blob = canvas.msToBlob();
                var blob = new Blob([image_blob], {type: "image/png"});
                navigator.msSaveBlob(blob, filename);
            }
            else {
                var blob = new Blob([image], {type: "image/png"});
                var link = document.createElement("a");

                if (link.download !== undefined) {
                    // check if browser supports HTML5 download attribute
                    var url = URL.createObjectURL(blob);
                    link.setAttribute("href", image);
                    link.setAttribute("download", filename);
                    link.style = "visibility:hidden";
                    link.setAttribute("target", "_blank");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                else {
                    var image_octet = image.replace("image/png", "image/octet-stream");
                    window.open(image_octet);
                }
            }

            //$(container).css("overflow", "auto");

            // remove all changes made to the DOM
            container.find('.tempCanvas').remove();
            svgElems.each(function () {
                $(this).show();
            });
        }
    });
};

// Input 185
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/18/14
 * Time: 10:17 PM
 */

goog.provide('epiviz.ui.WebArgsManager');

goog.require('epiviz.utils');
goog.require('epiviz.events.EventListener');

/**
 * @param {epiviz.ui.LocationManager} locationManager
 * @param {epiviz.workspaces.WorkspaceManager} workspaceManager
 * @constructor
 */
epiviz.ui.WebArgsManager = function(locationManager, workspaceManager) {
  /**
   * @type {epiviz.ui.LocationManager}
   * @private
   */
  this._locationManager = locationManager;

  /**
   * @type {epiviz.workspaces.WorkspaceManager}
   * @private
   */
  this._workspaceManager = workspaceManager;

  this._registerLocationChanged();
  this._registerActiveWorkspaceChanged();
};

/**
 * @type {Object.<string, *>}
 */
epiviz.ui.WebArgsManager.WEB_ARGS = epiviz.ui.WebArgsManager.WEB_ARGS || {};

/**
 * @returns {Object.<string, string|Array.<string>>}
 */
epiviz.ui.WebArgsManager.extractWindowLocationArgs = function() {
  var argsStr = window.location.search.length > 0 ? window.location.search.substr(1) : '';
  var argPairs = argsStr.split('&');

  var args = {};
  argPairs.forEach(function(pair, i) {
    if (pair.trim().length == 0) { return; }
    var arrInd = pair.indexOf('[]');
    if (arrInd == 0) { return; }

    var arg, val;
    var eqInd = pair.indexOf('=');
    if (eqInd < 0) {
      arg = (arrInd < 0) ? pair : pair.substr(0, arrInd);
      val = 'true';
    } else {
      arg = (arrInd < 0) ? pair.substr(0, eqInd) : pair.substr(0, arrInd);
      val = pair.substr(eqInd + 1);
    }

    arg = decodeURIComponent(arg);
    val = decodeURIComponent(val);

    if (arrInd < 0) { args[arg] = val; }
    else {
      if (!(arg in args)) { args[arg] = []; }
      args[arg].push(val);
    }
  });

  return args;
};

/**
 * @private
 */
epiviz.ui.WebArgsManager.prototype._updateUrl = function() {
  var url = '?';
  var args = epiviz.ui.WebArgsManager.WEB_ARGS;

  // 'ws' and 'workspace' are arguments for the same functionality
  // (the latter is kept for backward compatibility)
  if (!('ws' in args) && 'workspace' in args) {
    args['ws'] = args['workspace'];
    delete args['workspace'];
  }

  for (var arg in args) {
    if (!args.hasOwnProperty(arg)) { continue; }

    if (Array.isArray(args[arg])) {
      var val;
      for (var i = 0; i < args[arg].length; ++i) {
        val = args[arg][i];
        if (val == undefined) { val = 'undefined'; }
        url += sprintf('%s[]=%s&', arg, val);
      }
    } else {
      val = args[arg];
      if (val == undefined) { val = 'undefined'; }
      url += sprintf('%s=%s&', arg, val);
    }
  }

  // IE versions before 10 don't support the history API
  var ie = epiviz.utils.getInternetExplorerVersion();
  if (ie < 0 || ie >= 10) {
    switch(window.location.protocol) {
      case 'http:':
      case 'https:':
        //remote file over http or https
        history.replaceState(null, '', url);
        break;
      case 'file:':
        //local file
        break;
      default:
      //some other protocol
    }
  }
};

/**
 * @private
 */
epiviz.ui.WebArgsManager.prototype._registerLocationChanged = function() {
  var self = this;
  this._locationManager.onCurrentLocationChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {{oldValue: epiviz.datatypes.GenomicRange, newValue: epiviz.datatypes.GenomicRange}} e
     */
    function(e) {
      epiviz.ui.WebArgsManager.WEB_ARGS['seqName'] = e.newValue.seqName();
      epiviz.ui.WebArgsManager.WEB_ARGS['start'] = e.newValue.start();
      epiviz.ui.WebArgsManager.WEB_ARGS['end'] = e.newValue.end();

      self._updateUrl();
    }));
};

/**
 * @private
 */
epiviz.ui.WebArgsManager.prototype._registerActiveWorkspaceChanged = function() {
  var self = this;
  this._workspaceManager.onActiveWorkspaceChanged().addListener(new epiviz.events.EventListener(
    /**
     * @param {{oldValue: epiviz.workspaces.Workspace, newValue: epiviz.workspaces.Workspace, workspaceId: string}} e
     */
    function(e) {
      epiviz.ui.WebArgsManager.WEB_ARGS['ws'] = e.workspaceId || '';
      delete epiviz.ui.WebArgsManager.WEB_ARGS['workspace'];

      self._updateUrl();
    }
  ));
};

// Input 186
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/22/13
 * Time: 8:34 PM
 */

goog.provide('epiviz.ui.charts.Margins');

goog.require('epiviz.ui.charts.Axis');

/**
 * @param {number} top
 * @param {number} left
 * @param {number} bottom
 * @param {number} right
 * @constructor
 */
epiviz.ui.charts.Margins = function(top, left, bottom, right) {
  /**
   * @type {number}
   * @private
   */
  this._top = top;

  /**
   * @type {number}
   * @private
   */
  this._left = left;

  /**
   * @type {number}
   * @private
   */
  this._bottom = bottom;

  /**
   * @type {number}
   * @private
   */
  this._right = right;
};

/**
 * @type {epiviz.ui.charts.Margins}
 * @const
 */
epiviz.ui.charts.Margins.ZERO_MARGIN = new epiviz.ui.charts.Margins(0, 0, 0, 0);

/**
 * @returns {number}
 */
epiviz.ui.charts.Margins.prototype.top = function() { return this._top; };

/**
 * @returns {number}
 */
epiviz.ui.charts.Margins.prototype.left = function() { return this._left; };

/**
 * @returns {number}
 */
epiviz.ui.charts.Margins.prototype.bottom = function() { return this._bottom; };

/**
 * @returns {number}
 */
epiviz.ui.charts.Margins.prototype.right = function() { return this._right; };

/**
 * @param {epiviz.ui.charts.Axis} axis
 * @returns {number}
 */
epiviz.ui.charts.Margins.prototype.sumAxis = function(axis) {
  switch (axis) {
    case epiviz.ui.charts.Axis.X: return this._left + this._right;
    case epiviz.ui.charts.Axis.Y: return this._top + this._bottom;
    default: throw Error('Invalid argument: ' + axis);
  }
};

/**
 * @returns {{top: number, left: number, bottom: number, right: number}}
 */
epiviz.ui.charts.Margins.prototype.raw = function() {
  return {
    top: this._top,
    left: this._left,
    bottom: this._bottom,
    right: this._right
  };
};

/**
 * @param {{top: number, left: number, bottom: number, right: number}} o
 * @returns {epiviz.ui.charts.Margins}
 */
epiviz.ui.charts.Margins.fromRawObject = function(o) {
  return new epiviz.ui.charts.Margins(o.top, o.left, o.bottom, o.right);
};

/**
 * @returns {epiviz.ui.charts.Margins}
 */
epiviz.ui.charts.Margins.prototype.copy = function() {
  return new epiviz.ui.charts.Margins(this._top, this._left, this._bottom, this._right);
};

/**
 * @param {epiviz.ui.charts.Margins} other
 * @returns {boolean}
 */
epiviz.ui.charts.Margins.prototype.equals = function(other) {
  if (!other) { return false; }
  if (this == other) { return true; }
  return (this._top == other._top && this._left == other._left && this._bottom == other._bottom && this._right == other._right);
};

// Input 187
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 11:24 PM
 */

goog.provide('epiviz.ui.charts.ChartManager');

goog.require('epiviz.events.Event');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');
goog.require('epiviz.utils');
goog.require('epiviz.ui.ControlManager');
goog.require('epiviz.ui.charts.VisualizationProperties');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.ui.charts.VisualizationType');
goog.require('epiviz.events.EventListener');
goog.require('epiviz.ui.controls.SaveSvgAsImageDialog');

/**
 * @param {epiviz.Config} config
 * @constructor
 */
epiviz.ui.charts.ChartManager = function(config) {

  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * Map id to chart
   * @type {Object.<string, epiviz.ui.charts.Chart>}
   * @private
   */
  this._charts = {};

  /**
   * Each array in the map contains the ids of the charts in order
   * @type {Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>}
   * @private
   */
  this._chartsOrder = {};

  /**
   * Used to resize the charts after window has been resized
   * @type {?number}
   * @private
   */
  this._resizeInterval = null;

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{
   *   type: epiviz.ui.charts.ChartType,
   *   properties: epiviz.ui.charts.VisualizationProperties,
   *   chartsOrder: Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>
   * }>>}
   * @private
   */
  this._chartAdded = new epiviz.events.Event();

  /**
   * Argument is chartsOrder: track -> ids, plot -> ids
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>>>}
   * @private
   */
  this._chartRemoved = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>>}
   * @private
   */
  this._chartsOrderChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event}
   * @private
   */
  this._chartsCleared = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.ColorPalette>>}
   * @private
   */
  this._chartColorsChanged = new epiviz.events.Event();

  /**
   * Event arg: a map of method -> code
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, string>>>}
   * @private
   */
  this._chartMethodsModified = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @private
   */
  this._chartMethodsReset = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Array.<epiviz.ui.charts.markers.VisualizationMarker>>>}
   * @private
   */
  this._chartMarkersModified = new epiviz.events.Event();

  /**
   * Event arg: custom settings values setting -> value
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, *>>>}
   * @private
   */
  this._chartCustomSettingsChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{width: number|string, height: number|string}>>}
   * @private
   */
  this._chartSizeChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.Margins>>}
   * @private
   */
  this._chartMarginsChanged = new epiviz.events.Event();

  /**
   * event -> event args -> selection -> data
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.controls.VisConfigSelection.<*>>>}
   * @protected
   */
  this._chartRequestHierarchy = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{selection: Object.<string, epiviz.ui.charts.tree.NodeSelectionType>, order: Object.<string, number>}>>}
   * @private
   */
  this._chartPropagateHierarchyChanges = new epiviz.events.Event();

  this._chartPropogateIcicleLocationChanges = new epiviz.events.Event();

  this._chartIcicleLocationChanges = new epiviz.events.Event();

  this._registerWindowResize();
};

/**
 * @param {epiviz.ui.charts.ChartType} chartType
 * @param {epiviz.ui.controls.VisConfigSelection} visConfigSelection
 * @param {string} [id] The specific id for the chart. If not
 *   specified, it's generated dynamically
 * @param {epiviz.ui.charts.VisualizationProperties} [chartProperties]
 * @returns {string} The id of the newly created chart
 */
epiviz.ui.charts.ChartManager.prototype.addChart = function(chartType, visConfigSelection, id, chartProperties) {
  id = id || sprintf('%s-%s-%s', chartType.chartDisplayType(), chartType.chartHtmlAttributeName(), epiviz.utils.generatePseudoGUID(5));
  var css = chartType.cssClass();

  var chartDisplayTypeContainer = $('#' + chartType.chartContainer());
  var chartsAccordion = chartDisplayTypeContainer.find('.accordion');
  var chartsContainer = chartsAccordion.find('.vis-container');
  if (chartsAccordion.length == 0) {
    chartsAccordion = $('<div class="accordion"></div>').appendTo(chartDisplayTypeContainer);
    var displayType = chartType.chartDisplayType();
    chartsAccordion.append(
      sprintf('<h3><a href="#"><b><span style="color: #025167">Views by %s</span></b></a></h3>',
        epiviz.ui.ControlManager.DISPLAY_TYPE_LABELS[displayType]));
    chartsContainer = $('<div class="vis-container"></div>').appendTo(chartsAccordion);
    chartsAccordion.multiAccordion();
    chartsAccordion.multiAccordion('option', 'active', 'all');
    var self = this;
    // TODO: This doesn't go well with the icicle, because that requires a lot of drag & drop
    // TODO: Once we find a solution for it, re-enable the feature
    /*chartsContainer.sortable({
      stop: function(e, ui) {
        var newOrder = chartsContainer.find('.visualization-container')
          .map(function(i, el) {
            return $(el).attr('id');
          });
        if (epiviz.utils.arraysEqual(newOrder, self._chartsOrder[displayType])) { return; }
        self._chartsOrder[displayType] = newOrder;
        self._chartsOrderChanged.notify(self._chartsOrder);
      }
    });*/
  }

  chartsContainer.append(sprintf('<div id="%s" class="%s"></div>', id, css));
  var container = chartsContainer.find('#' + id);

  var chartMarkers = []; 
  
  if( chartType._defaultSettings.chartMarkers != null || chartType._defaultSettings.chartMarkers != undefined) {
    for (var i=0; i < chartType._defaultSettings.chartMarkers.length ; i++ ) {
      var tMark = chartType._defaultSettings.chartMarkers[i];
      chartMarkers.push(new epiviz.ui.charts.markers.VisualizationMarker(tMark.type, tMark.id, tMark.name, tMark.preMark, tMark.mark));
    }
  } 

  chartProperties = chartProperties || new epiviz.ui.charts.VisualizationProperties(
    chartType.defaultWidth(), // width
    chartType.defaultHeight(), // height
    chartType.defaultMargins(), // margins
    visConfigSelection, // configuration of measurements and other information selected by the user
    chartType.defaultColors(), // colors
    null, // modified methods
    chartType.customSettingsValues(),
    chartType.customSettingsDefs(),
    //[],
    chartMarkers
  );

  var chart = chartType.createNew(id, container, chartProperties);
  this._charts[id] = chart;

  this._registerChartHover(chart);
  this._registerChartUnhover(chart);
  this._registerChartSelect(chart);
  this._registerChartDeselect(chart);
  this._registerChartColorsChanged(chart);
  this._registerChartMethodsModified(chart);
  this._registerChartMethodsReset(chart);
  this._registerChartMarkersModified(chart);
  this._registerChartCustomSettingsChanged(chart);
  this._registerChartSizeChanged(chart);
  this._registerChartMarginsChanged(chart);
  this._registerChartRemove(chart);
  this._registerChartSave(chart);
  this._registerChartRequestHierarchy(chart);
  this._registerChartPropagateHierarchyChanges(chart);
  this._registerChartPropogateIcicleLocationChanges(chart);
  this._registerChartIcicleLocationChanges(chart);

  if (chartType.decorations()) {
    /** @type {epiviz.ui.charts.decoration.VisualizationDecoration} */
    var topDecoration = undefined;
    for (var i = 0; i < chartType.decorations().length; ++i) {
      /** @type {?(function(new:epiviz.ui.charts.decoration.VisualizationDecoration))} */
      var decorationCtor = epiviz.utils.evaluateFullyQualifiedTypeName(chartType.decorations()[i]);

      if (!decorationCtor) { continue; }

      /** @type {epiviz.ui.charts.decoration.VisualizationDecoration} */
      topDecoration  = epiviz.utils.applyConstructor(decorationCtor, [chart, topDecoration, this._config]);
    }

    if (topDecoration) {
      topDecoration.decorate();
    }
  }

  if (!(chartType.chartDisplayType() in this._chartsOrder)) { this._chartsOrder[chartType.chartDisplayType()] = []; }
  this._chartsOrder[chartType.chartDisplayType()].push(id);

  this._chartAdded.notify(new epiviz.ui.charts.VisEventArgs(id, {
      type: chartType,
      properties: chartProperties,
      chartsOrder: this._chartsOrder
    }));

  return id;
};

/**
 * @param {string} id The id of the chart being removed
 */
epiviz.ui.charts.ChartManager.prototype.removeChart = function(id) {
  $('#' + id).remove();

  var chart = this._charts[id];
  delete this._charts[id];
  this._chartsOrder[chart.displayType()].splice(this._chartsOrder[chart.displayType()].indexOf(id), 1);

  var chartDisplayTypeContainer = $('#' + epiviz.ui.ControlManager.CHART_TYPE_CONTAINERS[chart.displayType()]);
  var chartsAccordion = chartDisplayTypeContainer.find('.accordion');
  var chartsContainer = chartsAccordion.find('.vis-container');
  if (chartsContainer.children().length == 0) {
    chartDisplayTypeContainer.empty();
  }

  this._chartRemoved.notify(new epiviz.ui.charts.VisEventArgs(id, this._chartsOrder));
};

/**
 * Returns a map of chart ids as keys and corresponding measurements as values
 * @returns {Object.<string, epiviz.measurements.MeasurementSet>}
 */
epiviz.ui.charts.ChartManager.prototype.chartsMeasurements = function() {
  /** @type {Object.<string, epiviz.measurements.MeasurementSet>} */
  var result = {};
  for (var chartId in this._charts) {
    if (!this._charts.hasOwnProperty(chartId)) { continue; }
    if (this._charts[chartId].displayType() == epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) { continue; }
    result[chartId] = this._charts[chartId].measurements();
  }

  return result;
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @param {Array.<string>} [chartIds]
 */
epiviz.ui.charts.ChartManager.prototype.updateCharts = function(range, data, chartIds) {
  chartIds = chartIds || Object.keys(this._charts);
  for (var i = 0; i < chartIds.length; ++i) {
    if (!this._charts.hasOwnProperty(chartIds[i])) { continue; }
    var chart = this._charts[chartIds[i]];
    if (!chart) { continue; }

    (function(chart) {
      chart.transformData(range, data).done(function() {
        // No need to call with arguments, since transformData will set the lastRange and lastData values
        chart.draw();
      });
    })(chart);
  }
};

/**
 */
epiviz.ui.charts.ChartManager.prototype.updateDataStructureCharts = function() {
  var chartIds = Object.keys(this._charts);
  for (var i = 0; i < chartIds.length; ++i) {
    if (!this._charts.hasOwnProperty(chartIds[i])) { continue; }
    var chart = this._charts[chartIds[i]];
    if (!chart) { continue; }
    if (chart.displayType() != epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) { continue; }

    (function(chart) {
      setTimeout(function() {
        chart.fireRequestHierarchy();
      }, 0);
    })(chart);
  }
};

/**
 * Clears all the charts on stage
 */
epiviz.ui.charts.ChartManager.prototype.clear = function() {
  this._charts = {};
  this._chartsOrder = {};

  var chartContainers = epiviz.ui.ControlManager.CHART_TYPE_CONTAINERS;

  for (var displayType in chartContainers) {
    if (!chartContainers.hasOwnProperty(displayType)) { continue; }
    $('#' + chartContainers[displayType]).empty();
  }

  this._chartsCleared.notify();
};

/**
 * Tells all charts that new data has been requested.
 * Used, for example, by ChartLoaderAnimation decoration.
 * @param {string} [chartId]
 * @param {function(epiviz.ui.charts.Visualization): boolean} [chartFilter]
 */
epiviz.ui.charts.ChartManager.prototype.dataWaitStart = function(chartId, chartFilter) {
  if (chartId && this._charts[chartId]) {
    this._charts[chartId].onDataWaitStart().notify(new epiviz.ui.charts.VisEventArgs(chartId));
    return;
  }
  for (var id in this._charts) {
    if (!this._charts.hasOwnProperty(id)) { continue; }
    if (!chartFilter || !chartFilter[this._charts[id]]) { continue; }
    this._charts[id].onDataWaitStart().notify(new epiviz.ui.charts.VisEventArgs(id));
  }
};

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{type: epiviz.ui.charts.ChartType, properties: epiviz.ui.charts.VisualizationProperties, chartsOrder: Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>}>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartAdded = function() { return this._chartAdded; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartRemoved = function() { return this._chartRemoved; };

/**
 * @returns {epiviz.events.Event.<Object.<epiviz.ui.charts.VisualizationType.DisplayType, Array.<string>>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartsOrderChanged = function() { return this._chartsOrderChanged; };

/**
 * @returns {epiviz.events.Event}
 */
epiviz.ui.charts.ChartManager.prototype.onChartsCleared = function() { return this._chartsCleared; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.ColorPalette>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartColorsChanged = function() { return this._chartColorsChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, string>>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartMethodsModified = function() { return this._chartMethodsModified; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartMethodsReset = function() { return this._chartMethodsReset; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Array.<epiviz.ui.charts.markers.VisualizationMarker>>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartMarkersModified = function() { return this._chartMarkersModified; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, *>>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartCustomSettingsChanged = function() { return this._chartCustomSettingsChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{width: (number|string), height: (number|string)}>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartSizeChanged = function() { return this._chartSizeChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.Margins>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartMarginsChanged = function() { return this._chartMarginsChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.controls.VisConfigSelection.<*>>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartRequestHierarchy = function() { return this._chartRequestHierarchy; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{selection: Object.<string, epiviz.ui.charts.tree.NodeSelectionType>, order: Object.<string, number>}>>}
 */
epiviz.ui.charts.ChartManager.prototype.onChartPropagateHierarchyChanges = function() { return this._chartPropagateHierarchyChanges; };

epiviz.ui.charts.ChartManager.prototype.onChartPropogateIcicleLocationChanges = function() { return this._chartPropogateIcicleLocationChanges; };

epiviz.ui.charts.ChartManager.prototype.onChartIcicleLocationChanges = function() { return this._chartIcicleLocationChanges; };


/**
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerWindowResize = function() {
  var self = this;
  $(window).resize(function() {
    if (self._resizeInterval !== null) { window.clearTimeout(self._resizeInterval); }
    self._resizeInterval = window.setTimeout(function() {
      for (var chartId in self._charts) {
        if (!self._charts.hasOwnProperty(chartId)) { continue; }
        self._charts[chartId].updateSize();
      }
      self._resizeInterval = null;
    }, 500);
  });
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartHover = function(chart) {
  var self = this;
  chart.onHover().addListener(new epiviz.events.EventListener(
    /** @param {epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.ChartObject>} e */
    function(e) {
      for (var id in self._charts) {
        if (!self._charts.hasOwnProperty(id)) { continue; }
        self._charts[id].doHover(e.args);
      }
    }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartUnhover = function(chart) {
  var self = this;
  chart.onUnhover().addListener(new epiviz.events.EventListener(function() {
    for (var id in self._charts) {
      if (!self._charts.hasOwnProperty(id)) { continue; }
      self._charts[id].doUnhover();
    }
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartSelect = function(chart) {
  var self = this;
  chart.onSelect().addListener(new epiviz.events.EventListener(
    /** @param {epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.ChartObject>} e */
      function(e) {
      var selectedObject = e.args;
      for (var id in self._charts) {
        if (!self._charts.hasOwnProperty(id)) { continue; }
        self._charts[id].doSelect(selectedObject);
      }
    }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartDeselect = function(chart) {
  var self = this;
  chart.onDeselect().addListener(new epiviz.events.EventListener(function() {
    for (var id in self._charts) {
      if (!self._charts.hasOwnProperty(id)) { continue; }
      self._charts[id].doDeselect();
    }
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartRemove = function(chart) {
  var self = this;
  chart.onRemove().addListener(new epiviz.events.EventListener(
    /** @param {epiviz.ui.charts.VisEventArgs} e */
    function(e) { self.removeChart(e.id); }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartSave = function(chart) {
  var self = this;

  if(self._config.configType != "default") {
    chart.onSave().addListener(new epiviz.events.EventListener(
        /** @param {epiviz.ui.charts.VisEventArgs} e */
        function(e) {
          var pm = new epiviz.ui.PrintManager(e.id, "epiviz_" + Math.floor($.now() / 1000), "pdf");
          pm.print();
        }));
  }
  else {
    chart.onSave().addListener(new epiviz.events.EventListener(
        /** @param {epiviz.ui.charts.VisEventArgs} e */
        function(e) {
          var saveSvgDialog = new epiviz.ui.controls.SaveSvgAsImageDialog(
              {ok: function(){}, cancel: function(){}},
              e.id,
              self._config.dataServerLocation + self._config.chartSaverLocation);

          saveSvgDialog.show();
        }));
  }

};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartColorsChanged = function(chart) {
  var self = this;
  chart.onColorsChanged().addListener(new epiviz.events.EventListener(function(e) {
    self._chartColorsChanged.notify(e);
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartMethodsModified = function(chart) {
  var self = this;
  chart.onMethodsModified().addListener(new epiviz.events.EventListener(function(e) {
    self._chartMethodsModified.notify(e);
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartMethodsReset = function(chart) {
  var self = this;
  chart.onMethodsReset().addListener(new epiviz.events.EventListener(function(e) {
    self._chartMethodsReset.notify(e);
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartMarkersModified = function(chart) {
  var self = this;
  chart.onMarkersModified().addListener(new epiviz.events.EventListener(function(e) {
    self._chartMarkersModified.notify(e);
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartCustomSettingsChanged = function(chart) {
  var self = this;
  chart.onCustomSettingsChanged().addListener(new epiviz.events.EventListener(function(e) {
    self._chartCustomSettingsChanged.notify(e);
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartSizeChanged = function(chart) {
  var self = this;
  chart.onSizeChanged().addListener(new epiviz.events.EventListener(function(e) {
    self._chartSizeChanged.notify(e);
  }));
};

/**
 * @param {epiviz.ui.charts.Chart} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartMarginsChanged = function(chart) {
  var self = this;
  chart.onMarginsChanged().addListener(new epiviz.events.EventListener(function(e) {
    self._chartMarginsChanged.notify(e);
  }));
};

/**
 * @param {epiviz.ui.charts.Visualization} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartRequestHierarchy = function(chart) {
  var self = this;
  if (chart.displayType() == epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) {
    var dataStructVis = /** @type {epiviz.ui.charts.DataStructureVisualization} */ chart; // Assignment done for consistency
    dataStructVis.onRequestHierarchy().addListener(new epiviz.events.EventListener(function(e) {
      self._chartRequestHierarchy.notify(e);
    }));
  }
};

/**
 * @param {epiviz.ui.charts.Visualization} chart
 * @private
 */
epiviz.ui.charts.ChartManager.prototype._registerChartPropagateHierarchyChanges = function(chart) {
  var self = this;
  if (chart.displayType() == epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) {
    var dataStructVis = /** @type {epiviz.ui.charts.DataStructureVisualization} */ chart; // Assignment done for consistency
    dataStructVis.onPropagateHierarchyChanges().addListener(new epiviz.events.EventListener(function(e) {
      self._chartPropagateHierarchyChanges.notify(e);
    }));
  }
};

epiviz.ui.charts.ChartManager.prototype._registerChartPropogateIcicleLocationChanges = function(chart) {
  var self = this;

  if (chart.displayType() == epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) {
    var dataStructVis = /** @type {epiviz.ui.charts.DataStructureVisualization} */ chart; // Assignment done for consistency
    dataStructVis.onPropagateIcicleLocationChanges().addListener(new epiviz.events.EventListener(function(e) {
      self._chartPropogateIcicleLocationChanges.notify(e);
    }));
  }
};

epiviz.ui.charts.ChartManager.prototype._registerChartIcicleLocationChanges = function(chart) {
   var self = this;

   self.onChartIcicleLocationChanges().addListener(new epiviz.events.EventListener(function(e) {
      if (chart.displayType() == epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE) {
        chart._updateLocation(e.args.start, e.args.width);
        chart._drawAxes(chart._lastRoot);
      }
   }));
}; 

epiviz.ui.charts.ChartManager.prototype.getChartSettings = function(id) {

  var chart = this._charts[id];
  var result = {};
  //result['defs'] = chart.properties().customSettingsDefs;
  result['settings'] = chart.customSettingsValues();
  result['colorMap'] = chart.properties().colors;
  return result;

};

epiviz.ui.charts.ChartManager.prototype.setChartSettings = function(id, settings, colorMap) {

  var chart = this._charts[id];

  if(settings != null) {
    var currentSettings = chart.customSettingsValues();

    var all_keys = Object.keys(settings);

    all_keys.forEach(function(key) {
      currentSettings[key] = settings[key];
    });

    chart.setCustomSettingsValues(currentSettings);
  }

  if(colorMap != null) {
    chart.setColors(colorMap);
  }

  chart.draw();
};


// Input 188
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/15/2014
 * Time: 9:19 AM
 */

goog.provide('epiviz.ui.charts.VisEventArgs');

/**
 * @param {string} id The id of the visualization
 * @param {T} [args] The custom event arguments
 * @constructor
 * @struct
 * @template T
 */
epiviz.ui.charts.VisEventArgs = function(id, args) {
  /**
   * @type {string}
   */
  this.id = id;

  /**
   * @type {T}
   */
  this.args = args;
};

// Input 189
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/1/2014
 * Time: 6:47 PM
 */

goog.provide('epiviz.ui.charts.DataStructureVisualization');

goog.require('epiviz.ui.charts.Visualization');
goog.require('epiviz.measurements.MeasurementSet');
goog.require('epiviz.events.Event');
goog.require('epiviz.ui.charts.VisualizationType');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.ui.controls.VisConfigSelection');

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Visualization.<T>}
 * @template T
 * @constructor
 */
epiviz.ui.charts.DataStructureVisualization = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Visualization.call(this, id, container, properties);


  /**
   * @type {string}
   * @private
   */
  this._datasourceGroup = properties.visConfigSelection.datasourceGroup;

  /**
   * @type {string}
   * @private
   */
  this._dataprovider = properties.visConfigSelection.dataprovider;

  if (!this._dataprovider) {
    var self = this;
    properties.visConfigSelection.measurements.foreach(function(m) {
      if (m.dataprovider()) { self._dataprovider = m.dataprovider(); return true; }
    });
  }

  // Discard all measurements but one.

  var ms = new epiviz.measurements.MeasurementSet();
  properties.visConfigSelection.measurements.foreach(function(m) {
    if (m.dataprovider()) { ms.add(m); return true; }
  });
  properties.visConfigSelection.measurements = ms;

  // Events

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{
   *   selection: Object.<string, epiviz.ui.charts.tree.NodeSelectionType>,
   *   order: Object.<string, number>
   * }>>}
   * @private
   */
  this._propagateHierarchyChanges = new epiviz.events.Event();

  this._propagateIcicleLocationChanges = new epiviz.events.Event();

  /**
   * event -> event args -> selection -> data
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.controls.VisConfigSelection.<T>>>}
   * @private
   */
  this._requestHierarchy = new epiviz.events.Event();
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.DataStructureVisualization.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Visualization.prototype);
epiviz.ui.charts.DataStructureVisualization.constructor = epiviz.ui.charts.DataStructureVisualization;

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.DataStructureVisualization.prototype.displayType = function() { return epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE; };

/**
 * @returns {string}
 */
epiviz.ui.charts.DataStructureVisualization.prototype.datasourceGroup = function() { return this._datasourceGroup; };

/**
 * @returns {string}
 */
epiviz.ui.charts.DataStructureVisualization.prototype.dataprovider = function() { return this._dataprovider; };

/**
 * @returns {Array.<{name: string, color: string}>}
 */
epiviz.ui.charts.DataStructureVisualization.prototype.colorLabels = function() {
  var labels = [];
  for (var i = 0; i < this.colors().size() && i < 20; ++i) {
    labels.push('Color ' + (i + 1));
  }
  return labels;
};

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{selection: Object.<string, epiviz.ui.charts.tree.NodeSelectionType>, order: Object.<string, number>}>>}
 */
epiviz.ui.charts.DataStructureVisualization.prototype.onPropagateHierarchyChanges = function() { return this._propagateHierarchyChanges; };

epiviz.ui.charts.DataStructureVisualization.prototype.onPropagateIcicleLocationChanges = function() { return this._propagateIcicleLocationChanges; };

/**
 */
epiviz.ui.charts.DataStructureVisualization.prototype.firePropagateHierarchyChanges = function() {
  this._propagateHierarchyChanges.notify(new epiviz.ui.charts.VisEventArgs(
    this.id(),
    new epiviz.ui.controls.VisConfigSelection(undefined, undefined, this.datasourceGroup(), this.dataprovider(), undefined, undefined, undefined, {})));
};


/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.controls.VisConfigSelection.<T>>>}
 */
epiviz.ui.charts.DataStructureVisualization.prototype.onRequestHierarchy = function() { return this._requestHierarchy; };

// Input 190
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/22/13
 * Time: 8:37 PM
 */

goog.provide('epiviz.ui.charts.Axis');

/**
 * @enum {string}
 */
epiviz.ui.charts.Axis = {
  X: 'x',
  Y: 'y'
};

// Input 191
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/28/13
 * Time: 10:25 AM
 */

goog.provide('epiviz.ui.charts.Plot');

goog.require('epiviz.ui.charts.Chart');
goog.require('epiviz.ui.charts.VisualizationType');

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Chart}
 * @constructor
 */
epiviz.ui.charts.Plot = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Chart.call(this, id, container, properties);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.Plot.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Chart.prototype);
epiviz.ui.charts.Plot.constructor = epiviz.ui.charts.Plot;

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.Plot.prototype.displayType = function() { return epiviz.ui.charts.VisualizationType.DisplayType.PLOT; };

// Input 192
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/25/14
 * Time: 2:03 PM
 */

goog.provide('epiviz.ui.charts.ChartIndexObject');

goog.require('epiviz.ui.charts.VisObject');
/**
 * A struct for various objects in visualizations, like blocks, genes or circles in scatter plots
 * @param {string} id
 * @param {number} start
 * @param {number} end
 * @param {?Array.<number>} [values] One for each measurement
 * @param {number} [seriesIndex]
 * @param {Array.<Array.<epiviz.datatypes.GenomicData.ValueItem>>} [valueItems] For each measurement, an array of value items
 * @param {Array.<epiviz.measurements.Measurement>} [measurements]
 * @param {string} [cssClasses]
 * @constructor
 * @struct
 * @extends {epiviz.ui.charts.VisObject}
 */
epiviz.ui.charts.ChartIndexObject = function(id, keys, keyValues, values, valueItems, measurements, seriesIndex, cssClasses) {
    epiviz.ui.charts.VisObject.call(this);

    this.id = id;

    // Array
    this.keys = keys;

    // Array - made of [keys]
    this.keyValues = keyValues;

    // array [x, y]
    this.values = values;

    // number
    this.seriesIndex = seriesIndex;

    // array [actual dataX and dataY items]
    this.valueItems = valueItems;

    // [dimx, dimY]
    this.measurements = measurements;
    this.cssClasses = cssClasses;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.ChartIndexObject.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.VisObject.prototype);
epiviz.ui.charts.ChartIndexObject.constructor = epiviz.ui.charts.ChartIndexObject;

epiviz.ui.charts.ChartIndexObject.prototype.getMetadata = function(i, j, metadataCol) {
    if (this.valueItems) {
        return this.valueItems[i][j][metadataCol];
    }

    return null;
};

epiviz.ui.charts.ChartIndexObject.prototype.metadataColumns = function() {
    return this.keys;
};

epiviz.ui.charts.ChartIndexObject.prototype.dimensions = function() {
    return [1, 1];
};
// Input 193
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/3/2014
 * Time: 9:27 AM
 */

goog.provide('epiviz.ui.charts.DisplayType');

/**
 * TODO: Maybe at some point, switch to this
 * @enum {{name: string, subtypes: epiviz.ui.charts.DisplayType}}
 */
epiviz.ui.charts.DisplayType = {
  MEASUREMENT_VIS: {
    name: 'measurement-vis',
    PLOT: {
      name: 'plot'
    },
    TRACK: {
      name: 'track'
    }
  },
  DATA_STRUCTURE: {
    name: 'data-structure',
    HIERARCHY: {
      name: 'hierarchy'
    }
  }
};

/**
 * @param subtype
 * @param type
 */
epiviz.ui.charts.DisplayType.is = function(subtype, type) {
  var recurseIs = function(subtype, type) {
    if (subtype.name == type.name) { return true; }
    for (var childType in type) {
      if (!type.hasOwnProperty(childType) || childType == 'name') { continue; }
      if (recurseIs(subtype, type[childType])) { return true; }
    }
    return false;
  };
  return recurseIs(subtype, type);
};

// Input 194
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/15/2014
 * Time: 9:07 AM
 */

goog.provide('epiviz.ui.charts.VisualizationProperties');

goog.require('epiviz.ui.controls.VisConfigSelection');
goog.require('epiviz.utils');
goog.require('epiviz.measurements.MeasurementSet');

/**
 * @param {number|string} [width]
 * @param {number|string} [height]
 * @param {epiviz.ui.charts.Margins} [margins]
 * @param {epiviz.ui.controls.VisConfigSelection} [visConfigSelection]
 * @param {epiviz.ui.charts.ColorPalette} [colors]
 * @param {Object.<string, string>} [modifiedMethods]
 * @param {Object<string, *>} [customSettingsValues]
 * @param {Array.<epiviz.ui.charts.CustomSetting>} [customSettingsDefs]
 * @param {Array.<epiviz.ui.charts.markers.VisualizationMarker>} [chartMarkers]
 * @constructor
 * @struct
 */
epiviz.ui.charts.VisualizationProperties = function(width, height, margins, visConfigSelection, colors, modifiedMethods, customSettingsValues, customSettingsDefs, chartMarkers) {
  /**
   * @type {number|string}
   */
  this.width = width;

  /**
   * @type {number|string}
   */
  this.height = height;

  /**
   * @type {epiviz.ui.charts.Margins}
   */
  this.margins = margins;

  /**
   * @type {epiviz.ui.controls.VisConfigSelection}
   */
  this.visConfigSelection = visConfigSelection;

  /**
   * @type {epiviz.ui.charts.ColorPalette}
   */
  this.colors = colors;

  /**
   * @type {Object.<string, string>}
   */
  this.modifiedMethods = modifiedMethods;

  /**
   * @type {Object.<string, *>}
   */
  this.customSettingsValues = customSettingsValues || {};

  /**
   * @type {Array.<epiviz.ui.charts.CustomSetting>}
   */
  this.customSettingsDefs = customSettingsDefs || [];

  /**
   * @type {Array.<epiviz.ui.charts.markers.VisualizationMarker>}
   */
  this.chartMarkers = chartMarkers || [];
};

/**
 * @returns {epiviz.ui.charts.VisualizationProperties}
 */
epiviz.ui.charts.VisualizationProperties.prototype.copy = function() {
  var visConfigSelection = new epiviz.ui.controls.VisConfigSelection(
    this.visConfigSelection.measurements ? new epiviz.measurements.MeasurementSet(this.visConfigSelection.measurements) : undefined,
    this.visConfigSelection.datasource,
    this.visConfigSelection.datasourceGroup,
    this.visConfigSelection.dataprovider,
    epiviz.utils.mapCopy(this.visConfigSelection.annotation),
    this.visConfigSelection.defaultChartType,
    this.visConfigSelection.minSelectedMeasurements);
  return new epiviz.ui.charts.VisualizationProperties(
    this.width, this.height,
    this.margins ? this.margins.copy() : this.margins,
    visConfigSelection,
    this.colors,
    this.modifiedMethods ? epiviz.utils.mapCopy(this.modifiedMethods) : this.modifiedMethods,
    this.customSettingsValues ? epiviz.utils.mapCopy(this.customSettingsValues) : this.customSettingsValues,
    this.customSettingsDefs ? this.customSettingsDefs.slice(0) : this.customSettingsDefs,
    this.chartMarkers.slice(0));
};


// Input 195
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/1/2014
 * Time: 6:52 PM
 */

goog.provide('epiviz.ui.charts.DataStructureVisualizationType');

goog.require('epiviz.ui.charts.VisualizationType');


/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.VisualizationType}
 * @constructor
 */
epiviz.ui.charts.DataStructureVisualizationType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.VisualizationType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.DataStructureVisualizationType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.VisualizationType.prototype);
epiviz.ui.charts.DataStructureVisualizationType.constructor = epiviz.ui.charts.DataStructureVisualizationType;

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.DataStructureVisualizationType.prototype.chartDisplayType = function() { return epiviz.ui.charts.VisualizationType.DisplayType.DATA_STRUCTURE; };

/**
 * @returns {string}
 */
epiviz.ui.charts.DataStructureVisualizationType.prototype.cssClass = function() {
  return 'data-structure-container ui-widget-content';
};

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.ui.charts.DataStructureVisualizationType.prototype.isRestrictedToSameDatasourceGroup = function() { return true; };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.DataStructureVisualizationType.prototype.hasMeasurements = function() { return false; };


epiviz.ui.charts.DataStructureVisualizationType.prototype.customSettingsDefs = function() {
  var defs = epiviz.ui.charts.VisualizationType.prototype.customSettingsDefs.call(this);
  return defs;
};
// Input 196
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/28/13
 * Time: 10:26 AM
 */

goog.provide('epiviz.ui.charts.PlotType');

goog.require('epiviz.ui.charts.ChartType');
goog.require('epiviz.ui.charts.VisualizationType');
/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.ChartType}
 * @constructor
 */
epiviz.ui.charts.PlotType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.ChartType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.PlotType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.ChartType.prototype);
epiviz.ui.charts.PlotType.constructor = epiviz.ui.charts.PlotType;

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.PlotType.prototype.chartDisplayType = function() { return epiviz.ui.charts.VisualizationType.DisplayType.PLOT; };

/**
 * @returns {string}
 */
epiviz.ui.charts.PlotType.prototype.cssClass = function() {
  return 'plot-container ui-widget-content';
};

// Input 197
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/25/14
 * Time: 2:03 PM
 */

goog.provide('epiviz.ui.charts.ChartObject');

goog.require('epiviz.ui.charts.VisObject');


/**
 * A struct for various objects in visualizations, like blocks, genes or circles in scatter plots
 * @param {string} id
 * @param {number} start
 * @param {number} end
 * @param {?Array.<number>} [values] One for each measurement
 * @param {number} [seriesIndex]
 * @param {Array.<Array.<epiviz.datatypes.GenomicData.ValueItem>>} [valueItems] For each measurement, an array of value items
 * @param {Array.<epiviz.measurements.Measurement>} [measurements]
 * @param {string} [cssClasses]
 * @constructor
 * @struct
 * @extends {epiviz.ui.charts.VisObject}
 */
epiviz.ui.charts.ChartObject = function(id, start, end, values, seriesIndex, valueItems, measurements, cssClasses) {
  epiviz.ui.charts.VisObject.call(this);

  /**
   * @type {string}
   */
  this.id = id;

  /**
   * @type {number}
   */
  this.start = start;

  /**
   * @type {number}
   */
  this.end = end;

  /**
   * @type {?Array<number>}
   */
  this.values = values;

  /**
   * @type {number}
   */
  this.seriesIndex = seriesIndex;

  /**
   * For each measurement, an array of value items
   * @type {Array.<Array.<epiviz.datatypes.GenomicData.ValueItem>>}
   */
  this.valueItems = valueItems;

  /**
   * @type {Array.<epiviz.measurements.Measurement>}
   */
  this.measurements = measurements;

  /**
   * @type {string}
   */
  this.cssClasses = cssClasses;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.ChartObject.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.VisObject.prototype);
epiviz.ui.charts.ChartObject.constructor = epiviz.ui.charts.ChartObject;

/**
 * @returns {number}
 */
epiviz.ui.charts.ChartObject.prototype.regionStart = function() { return this.start; };

/**
 * @returns {number}
 */
epiviz.ui.charts.ChartObject.prototype.regionEnd = function() { return this.end; };

/**
 * @param {number} i
 * @param {number} j
 * @param {string} metadataCol
 * @returns {string}
 */
epiviz.ui.charts.ChartObject.prototype.getMetadata = function(i, j, metadataCol) {
  if (this.valueItems) {
    return this.valueItems[i][j].rowItem.metadata(metadataCol);
  }

  return null;
};

/**
 * Measurement i, object j
 * @param {number} i
 * @param {number} j
 * @returns {number}
 */
epiviz.ui.charts.ChartObject.prototype.getStart = function(i, j) { return this.valueItems[i][j].rowItem.start(); };

/**
 * Measurement i, object j
 * @param {number} i
 * @param {number} j
 * @returns {number}
 */
epiviz.ui.charts.ChartObject.prototype.getEnd = function(i, j) { return this.valueItems[i][j].rowItem.end(); };

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.ChartObject.prototype.metadataColumns = function() { return Object.keys(this.valueItems[0][0].rowItem.rowMetadata()); };

/**
 * Number of measurements times number of objects stored per measurement
 * @returns {Array.<number>}
 */
epiviz.ui.charts.ChartObject.prototype.dimensions = function() {
  var ret = [];

  if (this.valueItems) {
    ret.push(this.valueItems.length);
    if (this.valueItems.length) {
      ret.push(this.valueItems[0].length);
    } else {
      ret.push(0);
    }
    return ret;
  }

  return [0, 0];
};

// Input 198
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/15/2014
 * Time: 11:03 AM
 */

goog.provide('epiviz.ui.charts.VisObject');

goog.require('epiviz.utils');

/**
 * @constructor
 */
epiviz.ui.charts.VisObject = function() {};

/**
 * @returns {number}
 */
epiviz.ui.charts.VisObject.prototype.regionStart = function() {
    return null; };

/**
 * @returns {number}
 */
epiviz.ui.charts.VisObject.prototype.regionEnd = function() {
    return null; };

/**
 * Measurement i, object j
 * @param {number} i
 * @param {number} j
 * @param {string} metadataCol
 * @returns {string}
 */
epiviz.ui.charts.VisObject.prototype.getMetadata = function(i, j, metadataCol) {
    return null; };

/**
 * Measurement i, object j
 * @param {number} i
 * @param {number} j
 * @returns {number}
 */
epiviz.ui.charts.VisObject.prototype.getStart = function(i, j) {
    return null; };

/**
 * Measurement i, object j
 * @param {number} i
 * @param {number} j
 * @returns {number}
 */
epiviz.ui.charts.VisObject.prototype.getEnd = function(i, j) {
    return null; };

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.VisObject.prototype.metadataColumns = function() {
    return null; };

/**
 * Number of measurements times number of objects stored per measurement
 * @returns {Array.<number>}
 */
epiviz.ui.charts.VisObject.prototype.dimensions = function() {
    return [0, 0]; };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.VisObject.prototype.metadataLooseCompare = function() {
    return false; };

/**
 * @param {epiviz.ui.charts.VisObject} other
 * @returns {boolean}
 */
epiviz.ui.charts.VisObject.prototype.overlapsWith = function(other) {
    if (!other) {
        return false; }
    if (this === other) {
        return true; }

    var i, j, k;

    // If this is a generic selection with no cells inside, then check its start and end against
    // the other object's cells/location
    var thisDim = this.dimensions();
    var otherDim = other.dimensions();

    if ((!thisDim[0] || !otherDim[0]) &&
        (this.regionStart() == undefined || other.regionStart() == undefined || this.regionEnd() == undefined || other.regionEnd() == undefined)) {

        return false;
    }

    if (!thisDim[0]) {
        if (!otherDim[0]) {
            return (this.regionStart() < other.regionEnd() && this.regionEnd() > other.regionStart());
        }

        for (j = 0; j < otherDim[1]; ++j) {
            var otherRowStart = other.getStart(0, j);
            var otherRowEnd = other.getEnd(0, j);

            if (otherRowStart != undefined && otherRowEnd != undefined &&
                this.regionStart() < otherRowEnd && this.regionEnd() > otherRowStart) {
                return true;
            }
        }

        return false;
    }

    // Check metadata
    var commonMetadata = epiviz.utils.arrayIntersection(this.metadataColumns(), other.metadataColumns());

    if (commonMetadata.length) {
        for (i = 0; i < thisDim[1]; ++i) {
            for (j = 0; j < otherDim[1]; ++j) {
                var metadataMatches = true;
                for (k = 0; k < commonMetadata.length; ++k) {
                    var useLooseCompare = this.metadataLooseCompare() || other.metadataLooseCompare();
                    var thisM = this.getMetadata(0, i, commonMetadata[k]);
                    var otherM = other.getMetadata(0, j, commonMetadata[k]);

                    if (thisM == otherM) {
                        continue; }
                    if (!useLooseCompare) { metadataMatches = false;
                        break; }

                    var first, second;
                    if (thisM.length <= otherM.length) {
                        first = thisM;
                        second = otherM;
                    } else {
                        first = otherM;
                        second = thisM;
                    }

                    var r = new RegExp('^(.+,)?' + first + '(,.+)?$');

                    if (!r.test(second)) {
                        metadataMatches = false;
                        break;
                    }
                }

                if (metadataMatches) {
                    return true;
                }
            }
        }

        return false;
    }

    // If there are no common metadata columns, then we'll check for location overlaps
    for (i = 0; i < thisDim[1]; ++i) {
        for (j = 0; j < otherDim[1]; ++j) {
            if (this.getStart(0, i) < other.getEnd(0, j) && this.getEnd(0, i) > other.getStart(0, j)) {
                return true;
            }
        }
    }

    return false;
};
// Input 199
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 8:21 PM
 */

goog.provide('epiviz.ui.charts.Chart');

goog.require('epiviz.ui.charts.Visualization');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.deferred.Deferred');
goog.require('epiviz.ui.charts.markers.MeasurementAggregator');
goog.require('epiviz.ui.charts.ChartType');
goog.require('epiviz.datatypes.MeasurementAggregatedGenomicData');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');
goog.require('epiviz.datatypes.ItemFilteredGenomicData');
goog.require('epiviz.datatypes.MeasurementOrderedGenomicData');
goog.require('epiviz.measurements.MeasurementHashtable');
goog.require('epiviz.ui.charts.VisEventArgs');

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @constructor
 * @extends {epiviz.ui.charts.Visualization.<epiviz.datatypes.GenomicData>}
 */
epiviz.ui.charts.Chart = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Visualization.call(this, id, container, properties);

  /**
   * Constant used for mouse highlighting by location
   * @type {number}
   * @protected
   */
  this._nBins = 100;

  /**
   * Used for mouse highlighting by location
   * @type {?number}
   * @protected
   */
  this._binSize = null;

  /**
   * @type {epiviz.measurements.MeasurementHashtable.<string>}
   * @protected
   */
  this._measurementColorLabels = null;

  /**
   * @type {Object.<number, string>}
   * @protected
   */
  this._globalIndexColorLabels = null;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.Chart.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Visualization.prototype);
epiviz.ui.charts.Chart.constructor = epiviz.ui.charts.Chart;

/**
 * @protected
 */
epiviz.ui.charts.Chart.prototype._initialize = function() {
  // Call super
  epiviz.ui.charts.Visualization.prototype._initialize.call(this);

  this._svg.classed('base-chart', true);
};

/**
 * Deprecated method, kept for future reference
 * @protected
 * @deprecated
 */
epiviz.ui.charts.Chart.prototype._addFilters = function() {
  var defs = this._svg.append('defs');
  var glow = defs.append('filter')
    .attr('id', this.id() + '-glow');
  glow.append('feGaussianBlur')
    .attr('id', 'gaussianBlur')
    .attr('stdDeviation', '2')
    .attr('result', 'blurResult');
  glow.append('feComposite')
    .attr('id', 'composite')
    .attr('in', 'SourceGraphic')
    .attr('in2', 'blurResult')
    .attr('operator', 'over');

  var contour = defs.append('filter')
    .attr('id', this.id() + '-contour');
  contour.append('feGaussianBlur')
    .attr('in', 'SourceAlpha')
    .attr('stdDeviation', '1')
    .attr('result', 'blur');
  contour.append('feColorMatrix')
    .attr('values', '1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 10 -1 ')
    .attr('result', 'colorMatrix');
  contour.append('feFlood')
    .attr('result', 'fillColor')
    .attr('flood-color', '#800000')
    .attr('in', 'blur');
  contour.append('feComposite')
    .attr('result', 'composite')
    .attr('in', 'fillColor')
    .attr('in2', 'colorMatrix')
    .attr('operator', 'atop');
  contour.append('feComposite')
    .attr('in', 'SourceGraphic')
    .attr('in2', 'composite')
    .attr('operator', 'atop');

  var dropShadow = defs.append('filter')
    .attr('id', this.id() + '-dropshadow')
    .attr('filterUnits', 'userSpaceOnUse')
    .attr('color-interpolation-filters', 'sRGB');
  var temp = dropShadow.append('feComponentTransfer')
    .attr('in', 'SourceAlpha');
  temp.append('feFuncR')
    .attr('type', 'discrete')
    .attr('tableValues', '1');
  temp.append('feFuncG')
    .attr('type', 'discrete')
    .attr('tableValues', 198/255);
  temp.append('feFuncB')
    .attr('type', 'discrete')
    .attr('tableValues', '0');
  dropShadow.append('feGaussianBlur')
    .attr('stdDeviation', '2');
  dropShadow.append('feOffset')
    .attr('dx', '0')
    .attr('dy', '0')
    .attr('result', 'shadow');
  dropShadow.append('feComposite')
    .attr('in', 'SourceGraphic')
    .attr('in2', 'shadow')
    .attr('operator', 'over');
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {epiviz.datatypes.GenomicData} [data]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.ui.charts.Chart.prototype.draw = function(range, data) {
  epiviz.ui.charts.Visualization.prototype.draw.call(this, range, data);
  if (range) {
    this._binSize = Math.ceil((range.end() - range.start()) / this._nBins);
  }

  return [];
};

/**
 * @param {epiviz.datatypes.GenomicRange} range
 * @param {epiviz.datatypes.GenomicData} data
 * @returns {epiviz.deferred.Deferred}
 */
epiviz.ui.charts.Chart.prototype.transformData = function(range, data) {
  var deferred = new epiviz.deferred.Deferred();
  var self = this;
  epiviz.ui.charts.Visualization.prototype.transformData.call(this, range, data)
    .done(function() {
      if (!self._lastData) { deferred.resolve(); return; }
      self._lastData.ready(function() {
        var isFeatureChart = false;
        self._lastData.measurements().every(function(m) { isFeatureChart = m.type() !== epiviz.measurements.Measurement.Type.RANGE; return !isFeatureChart });

        if (isFeatureChart) {
          var groupByMarker;
          self._markers.every(function(marker) {
            if (marker && marker.type() == epiviz.ui.charts.markers.VisualizationMarker.Type.GROUP_BY_MEASUREMENTS) {
              groupByMarker = marker;
            }
            return !groupByMarker;
          });
          if (groupByMarker) {
            var aggregator = epiviz.ui.charts.markers.MeasurementAggregators[
              self.customSettingsValues()[epiviz.ui.charts.ChartType.CustomSettings.MEASUREMENT_GROUPS_AGGREGATOR]];
            self._lastData = new epiviz.datatypes.MeasurementAggregatedGenomicData(self._lastData, groupByMarker, aggregator);
          }
        }

        var filter;
        self._markers.every(function(marker) {
          if (marker && marker.type() == epiviz.ui.charts.markers.VisualizationMarker.Type.FILTER) {
            filter = marker;
          }
          return !filter;
        });
        if (filter) { self._lastData = new epiviz.datatypes.ItemFilteredGenomicData(self._lastData, filter); }

        var order;
        self._markers.every(function(marker) {
          if (marker && marker.type() == epiviz.ui.charts.markers.VisualizationMarker.Type.ORDER_BY_MEASUREMENTS) {
            order = marker;
          }
          return !order;
        });

        if (order) { self._lastData = new epiviz.datatypes.MeasurementOrderedGenomicData(self._lastData, order); }

        self._lastData.ready(function() {
          // self._lastData might have changed since we started to wait for it
          // so check the last version of it
          var data = self._lastData;
          if (data.isReady()) {
            // Also reassign color labels for both measurements and global indices
            var deferredColorByMeasurements = new epiviz.deferred.Deferred();
            var colorByMeasurements;
            self._markers.every(function(marker) {
              if (marker && marker.type() == epiviz.ui.charts.markers.VisualizationMarker.Type.COLOR_BY_MEASUREMENTS) {
                colorByMeasurements = marker;
              }
              return !colorByMeasurements;
            });

            self._measurementColorLabels = null;
            if (colorByMeasurements) {
              var measurementColorLabels = new epiviz.measurements.MeasurementHashtable();
              colorByMeasurements.preMark()(data).done(function(preColorVars) {
                var measurements = data.measurements();
                epiviz.utils.deferredFor(measurements.length, function(j) {
                  var mDeferredIteration = new epiviz.deferred.Deferred();
                  colorByMeasurements.mark()(measurements[j], data, preColorVars).done(function(label) {
                    measurementColorLabels.put(measurements[j], label);
                    mDeferredIteration.resolve();
                  });
                  return mDeferredIteration;
                }).done(function() {
                  self._measurementColorLabels = measurementColorLabels;
                  deferredColorByMeasurements.resolve();
                });
              });
            } else {
              deferredColorByMeasurements.resolve();
            }

            var deferredColorByGlobalIndices = new epiviz.deferred.Deferred();
            var colorByGlobalIndices;
            self._markers.every(function(marker) {
              if (marker && marker.type() == epiviz.ui.charts.markers.VisualizationMarker.Type.COLOR_BY_ROW) {
                colorByGlobalIndices = marker;
              }
              return !colorByGlobalIndices;
            });

            self._globalIndexColorLabels = null;
            if (colorByGlobalIndices) {
              var globalIndexColorLabels = {};
              colorByGlobalIndices.preMark()(data).done(function(preColorVars) {
                var firstSeries = data.firstSeries();
                epiviz.utils.deferredFor(firstSeries.size(), function(j) {
                  var seriesDeferredIteration = new epiviz.deferred.Deferred();
                  colorByGlobalIndices.mark()(firstSeries.getRow(j), data, preColorVars).done(function(label) {
                    globalIndexColorLabels[j + firstSeries.globalStartIndex()] = label;
                    seriesDeferredIteration.resolve();
                  });
                  return seriesDeferredIteration;
                }).done(function() {
                  self._globalIndexColorLabels = globalIndexColorLabels;
                  deferredColorByGlobalIndices.resolve();
                });
              });
            } else {
              deferredColorByGlobalIndices.resolve();
            }

            deferredColorByMeasurements.done(function() {
              if (deferredColorByGlobalIndices.state() == epiviz.deferred.Deferred.State.RESOLVED) {
                self._dataWaitEnd.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
                deferred.resolve();
              }
            });

            deferredColorByGlobalIndices.done(function() {
              if (deferredColorByMeasurements.state() == epiviz.deferred.Deferred.State.RESOLVED) {
                self._dataWaitEnd.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
                deferred.resolve();
              }
            });
          }
        });
      });
    });
  return deferred;
};

/**
 * @returns {epiviz.ui.charts.VisualizationProperties}
 */
epiviz.ui.charts.Chart.prototype.properties = function() {
  return /** @type {epiviz.ui.charts.VisualizationProperties} */ epiviz.ui.charts.Visualization.prototype.properties.call(this);
};

// Input 200
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/15/2014
 * Time: 9:05 AM
 */

goog.provide('epiviz.ui.charts.Visualization');

goog.require('epiviz.caja');
goog.require('epiviz.deferred.Deferred');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.events.Event');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.ui.charts.Margins');
goog.require('epiviz.ui.charts.ChartType');

/**
 * Uses data of T type for drawing objects of a subtype of epiviz.ui.charts.VisObject
 * @param {string} id
 * @param {jQuery} container The div where the visualization will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @constructor
 * @template T
 */
epiviz.ui.charts.Visualization = function(id, container, properties) {
  /**
   * @type {string}
   * @private
   */
  this._id = id;

  /**
   * @type {jQuery}
   * @private
   */
  this._container = container;

  /**
   * @type {epiviz.ui.charts.VisualizationProperties}
   * @private
   */
  this._properties = properties;

  /**
   * @type {Object.<string, function>}
   * @private
   */
  this._originalMethods = {};

  /**
   * @type {boolean}
   * @private
   */
  this._hasModifiedMethods = false;

  /**
   * @type {string}
   * @private
   */
  this._lastModifiedMethod = 'draw';

  var self = this;
  if (properties.modifiedMethods) {
    var methodsUpdated = new epiviz.deferred.Deferred();
    var modifiedMethods = properties.modifiedMethods;
    var modifiedMethodNames = Object.keys(modifiedMethods);
    var cajoledMethods = {};
    var nMethodsUpdated = 0;
    for (var m in modifiedMethods) {
      if (!modifiedMethods.hasOwnProperty(m)) { continue; }
      if (m == '_setModifiedMethods') { continue; } // Ignore modifications to this method
      (function(m) {
        epiviz.caja.cajole(modifiedMethods[m], epiviz.caja.buildChartMethodContext()).done(function(method) {
          if (!method) { return; }
          cajoledMethods[m] = method;
          nMethodsUpdated += 1;
          if (nMethodsUpdated >= modifiedMethodNames.length) {
            methodsUpdated.resolve();
          }
        });
      })(m);
    }
    methodsUpdated.done(function() {
      for (var m in cajoledMethods) {
        if (!cajoledMethods.hasOwnProperty(m)) { continue; }
        self._originalMethods[m] = self[m];
        self[m] = cajoledMethods[m];
        self._lastModifiedMethod = m;
      }
      self._hasModifiedMethods = true;
      self.draw();
    });
  }

  /**
   * @type {Object.<string, *>}
   * @private
   */
  this._customSettingsValues = {};
  for (var i = 0; i < properties.customSettingsDefs.length; ++i) {
    var setting = properties.customSettingsDefs[i];
    var val = properties.customSettingsValues[setting.id];
    switch (setting.type) {
      case epiviz.ui.charts.CustomSetting.Type.BOOLEAN:
        this._customSettingsValues[setting.id] = (val === false || val) ? val : setting.defaultValue;
        break;
      case epiviz.ui.charts.CustomSetting.Type.NUMBER:
        this._customSettingsValues[setting.id] = (val === 0 || val) ? val : setting.defaultValue;
        break;
      case epiviz.ui.charts.CustomSetting.Type.STRING:
        this._customSettingsValues[setting.id] = (val === '' || val) ? val : setting.defaultValue;
        break;
      case epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_METADATA:
        var possibleValues = {};
        properties.visConfigSelection.measurements.foreach(function(m) {
          m.metadata().forEach(function(metadataCol) { possibleValues[metadataCol] = metadataCol; });
        });
        setting.possibleValues = Object.keys(possibleValues);
        setting.possibleValues.sort();
        val = val || setting.defaultValue;
        this._customSettingsValues[setting.id] = (val in possibleValues) ?
          val : ((setting.possibleValues.length) ? setting.possibleValues[0] : '');
        break;
      case epiviz.ui.charts.CustomSetting.Type.MEASUREMENTS_ANNOTATION:
        var possibleValues = {name: 'name'};
        properties.visConfigSelection.measurements.foreach(function(m) {
          var anno = m.annotation();
          if (!anno) { return; }
          Object.keys(anno).forEach(function(key) { possibleValues[key] = key; });
        });
        setting.possibleValues = Object.keys(possibleValues);
        setting.possibleValues.sort();
        val = val || setting.defaultValue;
        this._customSettingsValues[setting.id] = (val in possibleValues) ?
          val : ((setting.possibleValues.length) ? setting.possibleValues[0] : '');
        break;
      default:
        this._customSettingsValues[setting.id] = val || setting.defaultValue;
        break;
    }
  }

  /**
   * @type {string}
   * @private
   */
  this._svgId = sprintf('%s-svg', this._id);

  /**
   * The D3 svg handler for the visualization
   * @protected
   */
  this._svg = null;

  /**
   * @type {?T}
   * @protected
   */
  this._unalteredData = null;

  /**
   * @type {?T}
   * @protected
   */
  this._lastData = null;

  /**
   * @type {epiviz.datatypes.Range}
   * @protected
   */
  this._lastRange = null;

  /**
   * @type {number}
   * @protected
   */
  this._slide = 0;

  /**
   * @type {number}
   * @protected
   */
  this._zoom = 1;

  /**
   * @type {Array.<epiviz.ui.charts.markers.VisualizationMarker>}
   * @protected
   */
  this._markers = properties.chartMarkers;

  /**
   * @type {Object.<string, epiviz.ui.charts.markers.VisualizationMarker>}
   * @protected
   */
  this._markersMap = {};

  /**
   * @type {Object.<string, number>}
   * @private
   */
  this._markersIndices = {};

  this._markers.forEach(function(marker, i) {
    if (!marker) { return; }
    self._markersMap[marker.id()] = marker;
    self._markersIndices[marker.id()] = i;
  });

  /**
   * @type {boolean}
   */
  this._autoPropagateChanges = true;

  // Events

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.VisObject>>}
   * @protected
   */
  this._hover = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @protected
   */
  this._unhover = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.VisObject>>}
   * @protected
   */
  this._select = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @protected
   */
  this._deselect = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @private
   */
  this._save = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @private
   */
  this._remove = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.ColorPalette>>}
   * @protected
   */
  this._colorsChanged = new epiviz.events.Event();

  /**
   * Event arg: a map of method -> code
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, string>>>}
   * @private
   */
  this._methodsModified = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @private
   */
  this._methodsReset = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Array.<epiviz.ui.charts.markers.VisualizationMarker>>>}
   * @private
   */
  this._markersModified = new epiviz.events.Event();

  /**
   * Event arg: custom settings values setting -> value
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, *>>>}
   * @private
   */
  this._customSettingsChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{width: number|string, height: number|string}>>}
   * @private
   */
  this._sizeChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.Margins>>}
   * @private
   */
  this._marginsChanged = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @private
   */
  this._dataWaitStart = new epiviz.events.Event();

  /**
   * @type {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
   * @protected
   */
  this._dataWaitEnd = new epiviz.events.Event();
};

/**
 * @type {number}
 * @constant
 */
epiviz.ui.charts.Visualization.SVG_MARGIN = 20;

/**
 * Initializes the visualization and draws the initial SVG in the container
 * @protected
 */
epiviz.ui.charts.Visualization.prototype._initialize = function() {
  if (this._properties.height == '100%') { this._properties.height = this._container.height() - epiviz.ui.charts.Visualization.SVG_MARGIN; }
  if (this._properties.width == '100%') { this._properties.width = this._container.width() - epiviz.ui.charts.Visualization.SVG_MARGIN; }

  var width = this.width();
  var height = this.height();

  this._container.addClass('visualization-container');

  this._container.append(sprintf('<svg id="%s" class="visualization" width="%s" height="%s"><style type="text/css"></style><defs></defs></svg>', this._svgId, width, height));
  this._svg = d3.select('#' + this._svgId);

  var jSvg = $('#' + this._svgId);

  /**
   * The difference in size between the container and the inner SVG
   * @type {number}
   * @private
   */
  this._widthDif = jSvg.width() - (this._container.width() - epiviz.ui.charts.Visualization.SVG_MARGIN);

  /**
   * The difference in size between the container and the inner SVG
   * @type {number}
   * @private
   */
  this._heightDif = height - (this._container.height() - epiviz.ui.charts.Visualization.SVG_MARGIN);

  this._properties.width = width;
  this._properties.height = height;

  var self = this;
  this._container.click(function() { self._deselect.notify(new epiviz.ui.charts.VisEventArgs(self._id)); });
};

/**
 * @param [svg] D3 svg container for the axes
 * @protected
 */
epiviz.ui.charts.Visualization.prototype._clearAxes = function(svg) {
  svg = svg || this._svg;
  svg.selectAll('.xAxis').remove();
  svg.selectAll('.yAxis').remove();
};

/**
 * @param [xScale] D3 linear scale for the x axis
 * @param [yScale] D3 linear scale for the y axis
 * @param {number} [xTicks]
 * @param {number} [yTicks]
 * @param [svg] D3 svg container for the axes
 * @param {number} [width]
 * @param {number} [height]
 * @param {epiviz.ui.charts.Margins} [margins]
 * @param {function} [xAxisFormat]
 * @param {function} [yAxisFormat]
 * @param {Array.<string>} [xLabels]
 * @param {Array.<string>} [yLabels]
 * @param {boolean} [xLabelsBtTicks]
 * @param {boolean} [yLabelsBtTicks]
 * @protected
 */
epiviz.ui.charts.Visualization.prototype._drawAxes = function (xScale, yScale, xTicks, yTicks, svg, width, height, margins, xAxisFormat, yAxisFormat, xLabels, yLabels, xLabelsBtTicks, yLabelsBtTicks) {

  svg = svg || this._svg;
  margins = margins || this.margins();
  height = height || this.height();
  width = width || this.width();

  var axesGroup = svg.select('.axes'),
    xAxisGrid = axesGroup.select('.xAxis-grid'),
    yAxisGrid = axesGroup.select('.yAxis-grid'),
    xAxisLine = axesGroup.select('.xAxis-line'),
    yAxisLine = axesGroup.select('.yAxis-line');

  if (axesGroup.empty()) { axesGroup = svg.append('g').attr('class', 'axes'); }

  if (xAxisGrid.empty()) { xAxisGrid = axesGroup.append('g').attr('class', 'xAxis xAxis-grid'); }
  if (yAxisGrid.empty()) { yAxisGrid = axesGroup.append('g').attr('class', 'yAxis yAxis-grid'); }
  if (xAxisLine.empty()) { xAxisLine = axesGroup.append('g').attr('class', 'xAxis xAxis-line'); }
  if (yAxisLine.empty()) { yAxisLine = axesGroup.append('g').attr('class', 'yAxis yAxis-line'); }

  if (xScale) {
    // Draw X-axis grid lines
    xAxisGrid
      .attr('transform', 'translate(' + margins.left() + ', ' + margins.top() + ')')
      .selectAll('line.x')
      .data(xScale.ticks(xTicks))
      .enter().append('line')
      .attr('x1', xScale)
      .attr('x2', xScale)
      .attr('y1', 0)
      .attr('y2', height - margins.top() - margins.bottom())
      .style('stroke', '#eeeeee')
      .style('shape-rendering', 'crispEdges');

    var xAxisTickFormat = xAxisFormat ||
      ((xLabels) ?
        function(i) { return xLabels[i]; } :
        function(x) {
          var format = d3.format('s');
          var rounded = Math.round(x * 1000) / 1000;
          return format(rounded);
        });

    var xAxis = d3.svg.axis()
      .scale(xScale)
      .orient('bottom')
      .ticks(xTicks)
      .tickFormat(xAxisTickFormat);

    xAxisLine
      .attr('transform', 'translate(' + margins.left() + ', ' + (height - margins.bottom()) + ')')
      .call(xAxis);

    if (xLabels) {
      var xTransform = 'rotate(-90)';
      if (xLabelsBtTicks) { xTransform += 'translate(0,' + (xScale(0.5) - xScale(0)) + ')'; }
      xAxisLine
      .selectAll('text')
      .style('text-anchor', 'end')
      .attr('dx', '-.8em')
      .attr('dy', '-0.5em')
      .attr('transform', xTransform);
    }
  }

  if (yScale) {
    // Draw Y-axis grid lines
    yAxisGrid
      .attr('transform', 'translate(' + margins.left() + ', ' + margins.top() + ')')
      .selectAll('line.y')
      .data(yScale.ticks(yTicks - 1))
      .enter().append('line')
      .attr('x1', 0)
      .attr('x2', width - margins.left() - margins.right())
      .attr('y1', yScale)
      .attr('y2', yScale)
      .style('stroke', '#eeeeee')
      .style('shape-rendering', 'crispEdges');

    var yAxisTickFormat = (yLabels) ? function(i) { return yLabels[i]; } :
      function(y) {
        var format = d3.format('s');
        var rounded = Math.round(y * 1000) / 1000;
        return format(rounded);
      };

    var yAxis = d3.svg.axis()
      .ticks(yTicks - 1)
      .scale(yScale)
      .orient('left')
      .tickFormat(yAxisTickFormat);
    yAxisLine
      .attr('transform', 'translate(' + margins.left() + ', ' + margins.top() + ')')
      .call(yAxis);
  }
};

/**
 * @private
 */
epiviz.ui.charts.Visualization.prototype._drawTitle = function() {
  var svgTitle = this._svg.selectAll('.visualization-title');

  var Settings = epiviz.ui.charts.Visualization.CustomSettings;
  var settingsVals = this.customSettingsValues();

  var title = settingsVals[Settings.TITLE];
  if (!title || title.trim() == '') {
    if (!svgTitle.empty()) {
      svgTitle.remove();
    }
    return;
  }

  if (svgTitle.empty()) {
    svgTitle = this._svg.append('text')
      .attr('class', 'visualization-title')
      .attr('text-anchor', 'middle');
  }

  svgTitle
    .attr('x', this.width() * 0.5)
    .attr('y', 25)
    .text(title);
};

/**
 * @param {number} width
 * @param {number} height
 */
epiviz.ui.charts.Visualization.prototype.resize = function(width, height) {
  if (width) { this._properties.width = width; }
  if (height) { this._properties.height = height; }

  this.draw();

  this._sizeChanged.notify(new epiviz.ui.charts.VisEventArgs(this._id, {width: this._properties.width, height: this._properties.height}));
};


/**
 */
epiviz.ui.charts.Visualization.prototype.updateSize = function() {
  this.resize(
    this._widthDif + this._container.width() - epiviz.ui.charts.Visualization.SVG_MARGIN,
    this._heightDif + this._container.height() - epiviz.ui.charts.Visualization.SVG_MARGIN);
};

/**
 * @param {epiviz.datatypes.Range} [range]
 * @param {T} [data]
 * @returns {Array.<epiviz.ui.charts.VisObject>}
 */
epiviz.ui.charts.Visualization.prototype.draw = function(range, data) {

  if (range != undefined) {
    this._lastRange = range;
  }

  if (data != undefined) {
    this._lastData = data;
    this._unalteredData = data;
    this._dataWaitEnd.notify(new epiviz.ui.charts.VisEventArgs(this._id));
  }

  this._svg
    .attr('width', this.width())
    .attr('height', this.height());

  this._drawTitle();

  return [];
};

/* Getters */

/**
 * @returns {jQuery}
 */
epiviz.ui.charts.Visualization.prototype.container = function() { return this._container; };

/**
 * @returns {string}
 */
epiviz.ui.charts.Visualization.prototype.id = function() { return this._id; };

/**
 * @returns {epiviz.ui.charts.VisualizationProperties}
 */
epiviz.ui.charts.Visualization.prototype.properties = function() {
  return this._properties;
};

/**
 * @returns {number}
 */
epiviz.ui.charts.Visualization.prototype.height = function() {
  return this._properties.height;
};

/**
 * @returns {number}
 */
epiviz.ui.charts.Visualization.prototype.width = function() {
  return this._properties.width;
};

/**
 * @returns {epiviz.ui.charts.Margins}
 */
epiviz.ui.charts.Visualization.prototype.margins = function() {
  return this._properties.margins;
};

/**
 * @returns {epiviz.ui.charts.ColorPalette}
 */
epiviz.ui.charts.Visualization.prototype.colors = function() {
  return this._properties.colors;
};

/**
 * @param {epiviz.ui.charts.ColorPalette} colors
 */
epiviz.ui.charts.Visualization.prototype.setColors = function(colors) {
  if (!colors || colors.equals(this._properties.colors)) { return; }
  this._properties.colors = colors;
  this.draw();
  this._colorsChanged.notify(new epiviz.ui.charts.VisEventArgs(this._id, this._properties.colors));
};

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.Visualization.prototype.colorLabels = function() {
  var self = this;
  var colors = new Array(this.measurements().size());
  this.measurements().foreach(
    /**
     * @param {epiviz.measurements.Measurement} m
     * @param {number} i
     */
      function(m, i) {
      colors[i] = m.name();
    });

  return colors;
};

/**
 * @returns {epiviz.measurements.MeasurementSet}
 */
epiviz.ui.charts.Visualization.prototype.measurements = function() {
  return this.properties().visConfigSelection.measurements;
};

/**
 * @returns {Object.<string, *>}
 */
epiviz.ui.charts.Visualization.prototype.customSettingsValues = function() { return this._customSettingsValues; };

/**
 * @param {Object.<string, *>} settingsValues
 */
epiviz.ui.charts.Visualization.prototype.setCustomSettingsValues = function(settingsValues) {
  if (this._customSettingsValues == settingsValues || !settingsValues || epiviz.utils.mapEquals(this._customSettingsValues, settingsValues)) {
    return;
  }
  var CustomSettings = epiviz.ui.charts.Visualization.CustomSettings;

  var currentTitle = this._customSettingsValues[CustomSettings.TITLE] || '';
  var newTitle = settingsValues[CustomSettings.TITLE] || '';

  var currentLen = currentTitle.trim().length;
  var newLen = newTitle.trim().length;

  // Check if either both titles are undefined or both are defined
  if (!(currentLen * newLen) && (currentLen + newLen)) {
    var marginDelta = epiviz.utils.sign(newLen - currentLen) * 20;
    var top = settingsValues[CustomSettings.MARGIN_TOP] || this._properties.margins.top();
    var left = settingsValues[CustomSettings.MARGIN_LEFT] || this._properties.margins.left();
    var right = settingsValues[CustomSettings.MARGIN_RIGHT] || this._properties.margins.right();
    var bottom = settingsValues[CustomSettings.MARGIN_BOTTOM] || this._properties.margins.bottom();
    settingsValues[CustomSettings.MARGIN_TOP] = top + marginDelta;
    settingsValues[CustomSettings.MARGIN_LEFT] = left;
    settingsValues[CustomSettings.MARGIN_RIGHT] = right;
    settingsValues[CustomSettings.MARGIN_BOTTOM] = bottom;
  }

  // FIXME: This is a property specific to Chart and not Visualization; move this portion of the code in Chart
  var currentMeasurementAggregator = this._customSettingsValues[epiviz.ui.charts.ChartType.CustomSettings.MEASUREMENT_GROUPS_AGGREGATOR];
  var newMeasurementAggregator = settingsValues[epiviz.ui.charts.ChartType.CustomSettings.MEASUREMENT_GROUPS_AGGREGATOR];

  this._customSettingsValues = settingsValues;

  if (CustomSettings.MARGIN_TOP in settingsValues && CustomSettings.MARGIN_BOTTOM in settingsValues && CustomSettings.MARGIN_LEFT in settingsValues && CustomSettings.MARGIN_RIGHT in settingsValues) {
    this._properties.margins = new epiviz.ui.charts.Margins(settingsValues[CustomSettings.MARGIN_TOP], settingsValues[CustomSettings.MARGIN_LEFT], settingsValues[CustomSettings.MARGIN_BOTTOM], settingsValues[CustomSettings.MARGIN_RIGHT]);
    this._marginsChanged.notify(new epiviz.ui.charts.VisEventArgs(this._id, this._properties.margins));
  }

  if (currentMeasurementAggregator != newMeasurementAggregator) {
    var self = this;
    this.transformData(this._lastRange, this._unalteredData).done(function() {
      self.draw();
    });
  } else {
    this.draw();
  }

  this._customSettingsChanged.notify(new epiviz.ui.charts.VisEventArgs(this._id, settingsValues));
};

/**
 * @param {Object.<string, string>} modifiedMethods
 */
epiviz.ui.charts.Visualization.prototype.setModifiedMethods = function(modifiedMethods) {
  var self = this;
  var methodsModified = false;
  if (!modifiedMethods) { return; }
  var modifiedMethodNames = Object.keys(modifiedMethods);
  var methodsUpdated = new epiviz.deferred.Deferred();
  var nMethodsUpdated = 0;
  var cajoledMethods = {};
  for (var m in modifiedMethods) {
    if (!modifiedMethods.hasOwnProperty(m)) { continue; }
    if (m == '_setModifiedMethods') { continue; } // Ignore modifications to this method
    if (this[m].toString() == modifiedMethods[m]) { continue; }

    if (!(m in this._originalMethods)) {
      this._originalMethods[m] = this[m];
    }

    (function(m) {
      epiviz.caja.cajole(modifiedMethods[m], epiviz.caja.buildChartMethodContext()).done(function(method) {
        if (method) {
          cajoledMethods[m] = method;
          methodsModified = true;

          nMethodsUpdated += 1;
          if (nMethodsUpdated >= modifiedMethodNames.length) {
            methodsUpdated.resolve();
          }
        }
      });
    })(m);
  }

  methodsUpdated.done(function() {
    if (methodsModified) {
      for (var m in cajoledMethods) {
        if (!cajoledMethods.hasOwnProperty(m)) { continue; }
        self[m] = cajoledMethods[m];
        self._lastModifiedMethod = m;
      }
      self._hasModifiedMethods = true;
      self.draw();
      self._methodsModified.notify(new epiviz.ui.charts.VisEventArgs(self._id, modifiedMethods));
    }
  });
};

/**
 * @returns {boolean}
 */
epiviz.ui.charts.Visualization.prototype.hasModifiedMethods = function() { return this._hasModifiedMethods; };

/**
 * @returns {string}
 */
epiviz.ui.charts.Visualization.prototype.lastModifiedMethod = function() { return this._lastModifiedMethod; };

/**
 */
epiviz.ui.charts.Visualization.prototype.resetModifiedMethods = function() {
  if (!this._hasModifiedMethods) { return; }
  for (var m in this._originalMethods) {
    if (!this._originalMethods.hasOwnProperty(m)) { continue; }
    this[m] = this._originalMethods[m];
  }

  this._hasModifiedMethods = false;

  this.draw();

  this._methodsReset.notify(new epiviz.ui.charts.VisEventArgs(this._id));
};

/**
 * @param {epiviz.ui.charts.markers.VisualizationMarker} marker
 */
epiviz.ui.charts.Visualization.prototype.putMarker = function(marker) {
  if (!marker) { return; }
  var i;
  if (marker.id() in this._markersMap) {
    i = this._markersIndices[marker.id()];
    var oldMarker = this._markers[i];
    if (oldMarker == marker ||
        (oldMarker.type() == marker.type() &&
         oldMarker.preMarkStr() == marker.preMarkStr() &&
         oldMarker.markStr() == marker.markStr())) {
      // Marker not modified
      return;
    }
    this._markers[i] = marker;
    this._markersMap[marker.id()] = marker;
  } else {
    i = this._markers.length;
    this._markers.push(marker);
    this._markersIndices[marker.id()] = i;
    this._markersMap[marker.id()] = marker;
  }

  var self = this;
  this.transformData(this._lastRange, this._unalteredData).done(function() {
    self.draw();
  });

  this._markersModified.notify(new epiviz.ui.charts.VisEventArgs(this._id, this._markers));
};

epiviz.ui.charts.Visualization.prototype.removeMarker = function(markerId) {
  if (!(markerId in this._markersMap)) { return; }

  var i = this._markersIndices[markerId];
  this._markers[i] = null;
  delete this._markersMap[markerId];
  delete this._markersIndices[markerId];

  var self = this;
  this.transformData(this._lastRange, this._unalteredData).done(function() {
    self.draw();
  });

  this._markersModified.notify(new epiviz.ui.charts.VisEventArgs(this._id, this._markers));
};

/**
 * @param {string} markerId
 * @returns {epiviz.ui.charts.markers.VisualizationMarker}
 */
epiviz.ui.charts.Visualization.prototype.getMarker = function(markerId) {
  if (!markerId || !(markerId in this._markersMap)) { return null; }
  return this._markersMap[markerId];
};

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.Visualization.prototype.displayType = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.Visualization.prototype.autoPropagateChanges = function() { return this._autoPropagateChanges; };

/**
 * @param {boolean} val
 */
epiviz.ui.charts.Visualization.prototype.setAutoPropagateChanges = function(val) { this._autoPropagateChanges = val; };

/**
 * @param {epiviz.datatypes.Range} range
 * @param {T} data
 * @returns {epiviz.deferred.Deferred}
 */
epiviz.ui.charts.Visualization.prototype.transformData = function(range, data) {
  var lastRange = this._lastRange;

  if (range != undefined) {
    this._lastRange = range;
  }
  if (data != undefined) {
    this._lastData = data;
    this._unalteredData = data;
  }

  if (lastRange && range && lastRange.overlapsWith(range) && lastRange.width() == range.width()) {
    this._slide = range.start() - lastRange.start();
  }

  if (lastRange && range && lastRange.overlapsWith(range) && lastRange.width() != range.width()) {
    this._zoom = lastRange.width() / range.width();
  }

  var deferred = new epiviz.deferred.Deferred();
  deferred.resolve();
  return deferred;
};

/* Events */

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.VisObject>>}
 */
epiviz.ui.charts.Visualization.prototype.onHover = function() { return this._hover; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.Visualization.prototype.onUnhover = function() { return this._unhover; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.VisObject>>}
 */
epiviz.ui.charts.Visualization.prototype.onSelect = function() { return this._select; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.Visualization.prototype.onDeselect = function() { return this._deselect; };

// Deprecated code, kept here for future reference
// Selection and hovering by changing the class of the selected items

/**
 * @param {epiviz.ui.charts.VisObject} selectedObject
 */
/*epiviz.ui.charts.Visualization.prototype.doHover = function(selectedObject) {
  var itemsGroup = this._svg.select('.items');
  itemsGroup.classed('unhovered', true);
  var selectItems = itemsGroup.selectAll('.item').filter(function(d) {
    return selectedObject.overlapsWith(d);
  });
  selectItems.classed('hovered', true);
  itemsGroup.selectAll('.item').sort(function(d1, d2) { return selectedObject.overlapsWith(d1) ? 1 : -1; });
};*/

/**
 */
/*epiviz.ui.charts.Visualization.prototype.doUnhover = function() {
  this._svg.select('.items').classed('unhovered', false);
  this._svg.select('.items').selectAll('.item').classed('hovered', false);
};*/

/**
 * @param {epiviz.ui.charts.ChartObject} selectedObject
 */
/*epiviz.ui.charts.Visualization.prototype.doSelect = function(selectedObject) {
  var itemsGroup = this._svg.select('.items');
  var selectItems = itemsGroup.selectAll('.item').filter(function(d) {
    return selectedObject.overlapsWith(d);
  });
  selectItems.classed('selected', true);
};*/

/**
 */
/*epiviz.ui.charts.Visualization.prototype.doDeselect = function() {
  this._svg.select('.items').selectAll('.selected').classed('selected', false);
};*/

/**
 * @param {epiviz.ui.charts.VisObject} selectedObject
 */
epiviz.ui.charts.Visualization.prototype.doHover = function(selectedObject) {
  var itemsGroup = this._container.find('.items');
  var unselectedHoveredGroup = itemsGroup.find('> .hovered');
  var selectedGroup = itemsGroup.find('> .selected');
  var selectedHoveredGroup = selectedGroup.find('> .hovered');

  var filter = function() {
    return selectedObject.overlapsWith(d3.select(this).data()[0]);
  };
  var selectItems = itemsGroup.find('> .item').filter(filter);
  unselectedHoveredGroup.append(selectItems);

  selectItems = selectedGroup.find('> .item').filter(filter);
  selectedHoveredGroup.append(selectItems);
};

/**
 */
epiviz.ui.charts.Visualization.prototype.doUnhover = function() {
  var itemsGroup = this._container.find('.items');
  var unselectedHoveredGroup = itemsGroup.find('> .hovered');
  var selectedGroup = itemsGroup.find('> .selected');
  var selectedHoveredGroup = selectedGroup.find('> .hovered');

  itemsGroup.prepend(unselectedHoveredGroup.children());

  selectedGroup.prepend(selectedHoveredGroup.children());
};

/**
 * @param {epiviz.ui.charts.ChartObject} selectedObject
 */
epiviz.ui.charts.Visualization.prototype.doSelect = function(selectedObject) {
  var itemsGroup = this._container.find('.items');
  var unselectedHoveredGroup = itemsGroup.find('> .hovered');
  var selectedGroup = itemsGroup.find('> .selected');
  var selectedHoveredGroup = selectedGroup.find('> .hovered');

  var filter = function() {
    return selectedObject.overlapsWith(d3.select(this).data()[0]);
  };
  var selectItems = itemsGroup.find('> .item').filter(filter);
  selectedGroup.append(selectItems);

  selectItems = unselectedHoveredGroup.find('> .item').filter(filter);
  selectedHoveredGroup.append(selectItems);
};

/**
 */
epiviz.ui.charts.Visualization.prototype.doDeselect = function() {
  var itemsGroup = this._container.find('.items');
  var unselectedHoveredGroup = itemsGroup.find('> .hovered');
  var selectedGroup = itemsGroup.find('> .selected');
  var selectedHoveredGroup = selectedGroup.find('> .hovered');

  itemsGroup.prepend(selectedGroup.find('> .item'));
  unselectedHoveredGroup.prepend(selectedHoveredGroup.children());
};

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.Visualization.prototype.onSave = function() { return this._save; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.Visualization.prototype.onRemove = function() { return this._remove; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.ColorPalette>>}
 */
epiviz.ui.charts.Visualization.prototype.onColorsChanged = function() { return this._colorsChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, string>>>}
 */
epiviz.ui.charts.Visualization.prototype.onMethodsModified = function() { return this._methodsModified; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.Visualization.prototype.onMethodsReset = function() { return this._methodsReset; };

/**
 * @returns {epiviz.events.Event.<Array.<epiviz.ui.charts.markers.VisualizationMarker>>}
 */
epiviz.ui.charts.Visualization.prototype.onMarkersModified = function() { return this._markersModified; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<Object.<string, *>>>}
 */
epiviz.ui.charts.Visualization.prototype.onCustomSettingsChanged = function() { return this._customSettingsChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<{width: (number|string), height: (number|string)}>>}
 */
epiviz.ui.charts.Visualization.prototype.onSizeChanged = function() { return this._sizeChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs.<epiviz.ui.charts.Margins>>}
 */
epiviz.ui.charts.Visualization.prototype.onMarginsChanged = function() { return this._marginsChanged; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.Visualization.prototype.onDataWaitStart = function() { return this._dataWaitStart; };

/**
 * @returns {epiviz.events.Event.<epiviz.ui.charts.VisEventArgs>}
 */
epiviz.ui.charts.Visualization.prototype.onDataWaitEnd = function() { return this._dataWaitEnd; };

/**
 * @enum {string}
 */
epiviz.ui.charts.Visualization.CustomSettings = {
  TITLE: 'title',
  MARGIN_LEFT: 'marginLeft',
  MARGIN_RIGHT: 'marginRight',
  MARGIN_TOP: 'marginTop',
  MARGIN_BOTTOM: 'marginBottom',
  X_MIN: 'xMin',
  X_MAX: 'xMax',
  Y_MIN: 'yMin',
  Y_MAX: 'yMax',
  COL_LABEL: 'colLabel',
  ROW_LABEL: 'rowLabel'
};

// Input 201
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 11:02 PM
 */

goog.provide('epiviz.ui.charts.ChartType');

goog.require('epiviz.ui.charts.VisualizationType');
goog.require('epiviz.ui.charts.markers.MeasurementAggregator');
goog.require('epiviz.ui.charts.CustomSetting');

/**
 * Abstract class
 * @param {epiviz.Config} config
 * @constructor
 * @extends {epiviz.ui.charts.VisualizationType}
 */
epiviz.ui.charts.ChartType = function(config) {
  epiviz.ui.charts.VisualizationType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.ChartType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.VisualizationType.prototype);
epiviz.ui.charts.ChartType.constructor = epiviz.ui.charts.ChartType;

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.ui.charts.Chart}
 */
epiviz.ui.charts.ChartType.prototype.createNew = function(id, container, properties) { throw Error('unimplemented abstract method'); };

epiviz.ui.charts.ChartType.prototype.customSettingsDefs = function() {
  var defs = epiviz.ui.charts.VisualizationType.prototype.customSettingsDefs.call(this);
  if (this.isRestrictedToRangeMeasurements()) { return defs; }

  var aggregators = Object.keys(epiviz.ui.charts.markers.MeasurementAggregators);

  return defs.concat([
    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.ChartType.CustomSettings.MEASUREMENT_GROUPS_AGGREGATOR,
      epiviz.ui.charts.CustomSetting.Type.CATEGORICAL,
      aggregators[0],
      'Aggregator for measurement groups', aggregators)
  ]);
};

/**
 * @enum {string}
 */
epiviz.ui.charts.ChartType.CustomSettings = {
  MEASUREMENT_GROUPS_AGGREGATOR: 'measurementGroupsAggregator'
};

// Input 202
/**
 * Created by: Florin Chelaru
 * Date: 11/22/14
 * Time: 12:43 PM
 */

goog.provide('epiviz.ui.charts.VisualizationType');
goog.provide('epiviz.ui.charts.VisualizationType.DisplayType');

goog.require('epiviz.ui.charts.Visualization');
goog.require('epiviz.Config');
goog.require('epiviz.utils');
goog.require('epiviz.ui.charts.CustomSetting');

/**
 * Abstract class
 * @param {epiviz.Config} config
 * @constructor
 */
epiviz.ui.charts.VisualizationType = function(config) {

  var VisualizationPropertySettings = epiviz.Config.VisualizationPropertySettings;

  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {Object.<epiviz.Config.VisualizationPropertySettings|string, *>}
   * @protected
   */
  this._defaultSettings = epiviz.utils.mapCombine(
    epiviz.utils.mapCombine(config.chartSettings[this.typeName()], config.chartSettings[this.chartDisplayType()], true),
    config.chartSettings['default'], true);

  /**
   * @type {string|number}
   * @private
   */
  this._defaultWidth = this._defaultSettings[VisualizationPropertySettings.WIDTH];

  /**
   * @type {string|number}
   * @private
   */
  this._defaultHeight = this._defaultSettings[VisualizationPropertySettings.HEIGHT];

  /**
   * @type {epiviz.ui.charts.Margins}
   * @private
   */
  this._defaultMargins = this._defaultSettings[VisualizationPropertySettings.MARGINS];

  /**
   * @type {epiviz.ui.charts.ColorPalette}
   * @private
   */
  this._defaultColors = config.colorPalettesMap[this._defaultSettings[VisualizationPropertySettings.COLORS]];

  /**
   * @type {Array.<string>}
   * @private
   */
  this._decorations = this._defaultSettings[VisualizationPropertySettings.DECORATIONS];

  /**
   * @type {?Object.<string, *>}
   * @private
   */
  this._customSettingsValues = config.chartCustomSettings[this.typeName()] || null;
};

/**
 * @enum {string}
 */
epiviz.ui.charts.VisualizationType.DisplayType = {
  PLOT: 'plot',
  TRACK: 'track',
  DATA_STRUCTURE: 'data-structure'
};

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.ui.charts.Chart}
 */
epiviz.ui.charts.VisualizationType.prototype.createNew = function(id, container, properties) { throw Error('unimplemented abstract method'); };

/**
 * @returns {string} The fully qualified type name of the chart
 */
epiviz.ui.charts.VisualizationType.prototype.typeName = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string}
 */
epiviz.ui.charts.VisualizationType.prototype.chartName = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string} a string to be used for html id attributes of
 *   elements containing this chart type
 */
epiviz.ui.charts.VisualizationType.prototype.chartHtmlAttributeName = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.VisualizationType.prototype.chartDisplayType = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {function(epiviz.measurements.Measurement): boolean}
 */
epiviz.ui.charts.VisualizationType.prototype.measurementsFilter = function() { return function(m) { return true; }; };

/**
 * If true, this flag indicates that the corresponding chart can only show measurements that belong to the same
 * data source group
 * @returns {boolean}
 */
epiviz.ui.charts.VisualizationType.prototype.isRestrictedToSameDatasourceGroup = function() { return false; };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.VisualizationType.prototype.isRestrictedToRangeMeasurements = function() { return false; };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.VisualizationType.prototype.isRestrictedToFeatureMeasurements = function() { return !this.isRestrictedToRangeMeasurements(); };

/**
 * Gets the minimum number of measurements that must be selected for the chart to be displayed
 * @returns {number}
 */
epiviz.ui.charts.VisualizationType.prototype.minSelectedMeasurements = function() { return 1; };

/**
 * @returns {string}
 */
epiviz.ui.charts.VisualizationType.prototype.chartContainer = function() {
  return epiviz.ui.ControlManager.CHART_TYPE_CONTAINERS[this.chartDisplayType()];
};

/**
 * @returns {string}
 */
epiviz.ui.charts.VisualizationType.prototype.cssClass = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {number|string}
 */
epiviz.ui.charts.VisualizationType.prototype.defaultWidth = function() { return this._defaultWidth; };

/**
 * @returns {number|string}
 */
epiviz.ui.charts.VisualizationType.prototype.defaultHeight = function() { return this._defaultHeight; };

/**
 * @returns {epiviz.ui.charts.Margins}
 */
epiviz.ui.charts.VisualizationType.prototype.defaultMargins = function() { return this._defaultMargins; };

/**
 * @returns {epiviz.ui.charts.ColorPalette}
 */
epiviz.ui.charts.VisualizationType.prototype.defaultColors = function() { return this._defaultColors; };

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.VisualizationType.prototype.decorations = function() { return this._decorations; };

/**
 * @returns {?Object.<string, *>}
 */
epiviz.ui.charts.VisualizationType.prototype.customSettingsValues = function() { return this._customSettingsValues; };

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.ui.charts.VisualizationType.prototype.customSettingsDefs = function() {
  return [
    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.TITLE,
      epiviz.ui.charts.CustomSetting.Type.STRING,
      '',
      'Title'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.MARGIN_TOP,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      this._defaultMargins.top(),
      'Top margin'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.MARGIN_BOTTOM,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      this._defaultMargins.bottom(),
      'Bottom margin'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.MARGIN_LEFT,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      this._defaultMargins.left(),
      'Left margin'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.Visualization.CustomSettings.MARGIN_RIGHT,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      this._defaultMargins.right(),
      'Right margin')
  ];
};

// Input 203
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/22/13
 * Time: 6:49 PM
 */

goog.provide('epiviz.ui.charts.TrackType');

goog.require('epiviz.ui.charts.ChartType');
goog.require('epiviz.ui.charts.VisualizationType');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.ChartType}
 * @constructor
 */
epiviz.ui.charts.TrackType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.ChartType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.TrackType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.ChartType.prototype);
epiviz.ui.charts.TrackType.constructor = epiviz.ui.charts.TrackType;

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.TrackType.prototype.chartDisplayType = function() { return epiviz.ui.charts.VisualizationType.DisplayType.TRACK; };

/**
 * @returns {string}
 */
epiviz.ui.charts.TrackType.prototype.cssClass = function() {
  return 'track-container ui-widget-content';
};

// Input 204
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/29/14
 * Time: 2:52 PM
 */

goog.provide('epiviz.ui.charts.CustomSetting');

/**
 * @param {string} id
 * @param {epiviz.ui.charts.CustomSetting.Type} type
 * @param defaultValue
 * @param {string} [label]
 * @param {Array} [possibleValues]
 * @constructor
 * @struct
 */
epiviz.ui.charts.CustomSetting = function(id, type, defaultValue, label, possibleValues) {
  /**
   * @type {string}
   */
  this.id = id;

  /**
   * @type {epiviz.ui.charts.CustomSetting.Type}
   */
  this.type = type;

  this.defaultValue = defaultValue;

  /**
   * @type {string}
   */
  this.label = label || id;

  /**
   * @type {Array}
   */
  this.possibleValues = possibleValues || null;
};

/**
 * @enum {string}
 */
epiviz.ui.charts.CustomSetting.Type = {
  NUMBER: 'number',
  STRING: 'string',
  ARRAY: 'array',
  BOOLEAN: 'boolean',
  CATEGORICAL: 'categorical',
  MEASUREMENTS_METADATA: 'measurementsMetadata',
  MEASUREMENTS_ANNOTATION: 'measurementsAnnotation'
};

/**
 * @type {string}
 * @constant
 */
epiviz.ui.charts.CustomSetting.DEFAULT = 'default';

// Input 205
/**
 * Created by: Florin Chelaru
 * Date: 10/3/13
 * Time: 10:59 PM
 */

goog.provide('epiviz.ui.charts.ChartFactory');

goog.require('epiviz.utils');
goog.require('epiviz.plugins.charts.BlocksTrackType');
goog.require('epiviz.plugins.charts.LineTrackType');
goog.require('epiviz.plugins.charts.StackedLineTrackType');
goog.require('epiviz.plugins.charts.ScatterPlotType');
goog.require('epiviz.plugins.charts.GenesTrackType');
goog.require('epiviz.plugins.charts.HeatmapPlotType');
goog.require('epiviz.plugins.charts.LinePlotType');
goog.require('epiviz.plugins.charts.StackedLinePlotType');
goog.require('epiviz.ui.charts.tree.IcicleType');
goog.require('epiviz.plugins.charts.DiversityScatterPlotType');
goog.require('epiviz.plugins.charts.CustomScatterPlotType');


/**
 * @param {epiviz.Config} config
 * @constructor
 * @implements {epiviz.utils.Iterable}
 */
epiviz.ui.charts.ChartFactory = function(config) {

  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * A map of type names and their corresponding constructors
   * @type {Object.<string, epiviz.ui.charts.ChartType>}
   * @private
   */
  this._types = {};

  /**
   * @type {number}
   * @private
   */
  this._size = 0;

  for (var i = 0; i < config.chartTypes.length; ++i) {
    this.register(config.chartTypes[i]);
  }
};

/**
 * @returns {number}
 */
epiviz.ui.charts.ChartFactory.prototype.size = function() {
  return this._size;
};

/**
 * @param {epiviz.ui.charts.ChartType} type
 */
epiviz.ui.charts.ChartFactory.prototype.registerType = function(type) {
  if (!(type.typeName() in this._types)) {
    ++this._size;
  }
  this._types[type.typeName()] = type;
};

/**
 * @param {epiviz.ui.charts.ChartType} type
 * @returns {boolean}
 */
epiviz.ui.charts.ChartFactory.prototype.unregisterType = function(type) {
  if (!(type.typeName() in this._types)) { return false; }

  --this._size;

  delete this._types[type.typeName()];
  return true;
};

/**
 * @param {string} typeName
 * @returns {boolean}
 */
epiviz.ui.charts.ChartFactory.prototype.register = function(typeName) {
  /** @type {?function(new:epiviz.ui.charts.ChartType)} */
  var typeDescriptorConstructor = epiviz.utils.evaluateFullyQualifiedTypeName(typeName);

  if (!typeDescriptorConstructor) { return false; }

  this.registerType(/** @type {epiviz.ui.charts.ChartType} */ (new typeDescriptorConstructor(this._config)));
  return true;
};

/**
 * @param {string} typeName
 * @returns {boolean}
 */
epiviz.ui.charts.ChartFactory.prototype.unregister = function(typeName) {
  /** @type {?function(new:epiviz.ui.charts.ChartType)} */
  var typeDescriptorConstructor = epiviz.utils.evaluateFullyQualifiedTypeName(typeName);

  if (!typeDescriptorConstructor) { return false; }

  return this.unregisterType(/** @type {epiviz.ui.charts.ChartType} */ (new typeDescriptorConstructor(this._config)));
};

/**
 * @param {string} typeName
 * @returns {?epiviz.ui.charts.ChartType}
 */
epiviz.ui.charts.ChartFactory.prototype.get = function(typeName) {
  if (typeName && typeName in this._types) {
    return this._types[typeName];
  }

  return null;
};

/**
 * Iterates through all types in the factory, or until func returns something that evaluates to true.
 * @param {function(string, epiviz.ui.charts.ChartType)} func A function called for each (typeName, descriptor) pair in the factory.
 */
epiviz.ui.charts.ChartFactory.prototype.foreach = function(func) {
  for (var typeName in this._types) {
    if (!this._types.hasOwnProperty(typeName)) { continue; }
    if (func(typeName, this._types[typeName])) {
      return;
    }
  }
};


// Input 206
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/22/13
 * Time: 6:47 PM
 */

goog.provide('epiviz.ui.charts.Track');

goog.require('epiviz.ui.charts.Chart');
goog.require('epiviz.ui.charts.VisualizationType');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.ui.charts.ChartObject');
goog.require('epiviz.ui.charts.Axis');

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.Chart}
 * @constructor
 */
epiviz.ui.charts.Track = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.Chart.call(this, id, container, properties);

  /**
   * D3 rectangle in the SVG
   * @type {*}
   * @protected
   */
  this._background = null;

  /**
   * D3 group in the SVG used for adding hover/selection elements
   * @type {*}
   * @protected
   */
  this._highlightGroup = null;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.Track.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Chart.prototype);
epiviz.ui.charts.Track.constructor = epiviz.ui.charts.Track;


/**
 * Initializes the chart and draws the initial SVG in the container
 * @protected
 */
epiviz.ui.charts.Track.prototype._initialize = function() {
  this._properties.width = '100%';

  epiviz.ui.charts.Chart.prototype._initialize.call(this);

  var self = this;

  this._highlightGroup = this._svg
    .append('g')
    .attr('class', 'track-highlight');

  this._background = this._svg
    .append('rect')
    .attr('class', 'chart-background')
    .attr('x', 0)
    .attr('y', 0)
    .attr('width', '100%')
    .attr('height', '100%')
    .attr('fill', '#ffffff')
    .attr('fill-opacity', '0');

  this._background
    .on('mouseover', function() { self._captureMouseHover(); })
    .on('mousemove', function() { self._captureMouseHover(); })
    .on('mouseout', function () { self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id())); });
};

/**
 * @param {epiviz.datatypes.GenomicRange} [range]
 * @param {epiviz.datatypes.GenomicData} [data]
 * @param {number} [slide]
 * @param {number} [zoom]
 * @returns {Array.<epiviz.ui.charts.ChartObject>} The objects drawn
 */
epiviz.ui.charts.Track.prototype.draw = function(range, data, slide, zoom) {
  var result = epiviz.ui.charts.Chart.prototype.draw.call(this, range, data);

  this._drawLegend();

  return result;
};

/**
 * @returns {epiviz.ui.charts.VisualizationType.DisplayType}
 */
epiviz.ui.charts.Track.prototype.displayType = function() { return epiviz.ui.charts.VisualizationType.DisplayType.TRACK; };

/**
 * @param {epiviz.ui.charts.ChartObject} selectedObject
 */
epiviz.ui.charts.Track.prototype.doHover = function(selectedObject) {
  epiviz.ui.charts.Chart.prototype.doHover.call(this, selectedObject);

  if (selectedObject.start == undefined || selectedObject.end == undefined) {
    return;
  }

  if (!this._lastRange) { return; }

  this._highlightGroup.selectAll('rect').remove();
  this._highlightGroup.attr('transform', 'translate(' + this.margins().left() + ', ' + 0 + ')');

  var Axis = epiviz.ui.charts.Axis;
  var xScale = d3.scale.linear()
    .domain([this._lastRange.start(), this._lastRange.end()])
    .range([0, this.width() - this.margins().sumAxis(Axis.X)]);

  var items = [];
  if (!selectedObject.measurements || !selectedObject.measurements.length) {
    items.push({start: selectedObject.start, end: selectedObject.end});
  } else {
    for (var i = 0; i < selectedObject.valueItems[0].length; ++i) {
      var rowItem = selectedObject.valueItems[0][i].rowItem;
      items.push({start: rowItem.start(), end: rowItem.end()});
    }
  }

  var minHighlightSize = 5;
  this._highlightGroup.selectAll('rect').data(items, function(d) { return sprintf('%s-%s', d.start, d.end); })
    .enter()
    .append('rect')
    .style('fill', this.colors().get(0))
    .style('fill-opacity', '0.1')
    .attr('x', function(d) {
      var defaultWidth = xScale(d.end + 1) - xScale(d.start);
      var width = Math.max(minHighlightSize, defaultWidth);
      return xScale(d.start) + defaultWidth * 0.5 - width * 0.5;
    })
    .attr('width', function(d) { return Math.max(minHighlightSize, xScale(d.end + 1) - xScale(d.start)); })
    .attr('y', 0)
    .attr('height', this.height());
};

/**
 */
epiviz.ui.charts.Track.prototype.doUnhover = function() {
  epiviz.ui.charts.Chart.prototype.doUnhover.call(this);

  this._highlightGroup.selectAll('rect').remove();
};

/**
 * @protected
 */
epiviz.ui.charts.Track.prototype._captureMouseHover = function() {
  if (!this._lastRange) { return; }
  this._unhover.notify(new epiviz.ui.charts.VisEventArgs(this.id()));
  var inverseXScale = d3.scale.linear()
    .domain([0, this.width()])
    .range([this._lastRange.start(), this._lastRange.end()]);
  var start = inverseXScale(d3.mouse(this._background[0][0])[0]) - this._binSize / 2;
  var end = start + this._binSize;

  var selectedObject = new epiviz.ui.charts.ChartObject(sprintf('%s-highlight', this.id()), start, end);
  this._hover.notify(new epiviz.ui.charts.VisEventArgs(this.id(), selectedObject));
};

/**
 * @private
 */
epiviz.ui.charts.Track.prototype._drawLegend = function() {
  var self = this;
  this._svg.selectAll('.chart-title').remove();
  this._svg.selectAll('.chart-title-color ').remove();

  if (!this._lastData || !this._lastData.isReady()) { return; }

  var title = '';
  var measurements = this._lastData.measurements();

  var titleEntries = this._svg
    .selectAll('.chart-title')
    .data(measurements)
    .enter()
    .append('text')
    .attr('class', 'chart-title')
    .attr('font-weight', 'bold')
    .attr('fill', function(m, i) {
      if (!self._measurementColorLabels) { return self.colors().get(i); }
      return self.colors().getByKey(self._measurementColorLabels.get(m));
    })
    .attr('y', self.margins().top() - 5)
    .text(function(m, i) { return m.name(); });

  var textLength = 0;
  var titleEntriesStartPosition = [];

  $('#' + this.id() + ' .chart-title')
    .each(function(i) {
      titleEntriesStartPosition.push(textLength);
      textLength += this.getBBox().width + 15;
    });

  titleEntries.attr('x', function(column, i) {
    return self.margins().left() + 10 + titleEntriesStartPosition[i];
  });

  var colorEntries = this._svg
    .selectAll('.chart-title-color')
    .data(measurements)
    .enter()
    .append('circle')
    .attr('class', 'chart-title-color')
    .attr('cx', function(column, i) { return self.margins().left() + 4 + titleEntriesStartPosition[i]; })
    .attr('cy', self.margins().top() - 9)
    .attr('r', 4)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .style('fill', function(m, i) {
      if (!self._measurementColorLabels) { return self.colors().get(i); }
      return self.colors().getByKey(self._measurementColorLabels.get(m));
    });
};

// Input 207
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/22/13
 * Time: 9:00 PM
 */

goog.provide('epiviz.ui.charts.ColorPalette');

goog.require('epiviz.utils');
goog.require('epiviz.Config');

/**
 * @param {Array.<string>} colors
 * @param {string} [name]
 * @param {string} [id]
 * @param {Object.<string|number, number>} [keyIndices]
 * @constructor
 */
epiviz.ui.charts.ColorPalette = function(colors, name, id, keyIndices) {
  /**
   * @type {Array.<string>}
   * @private
   */
  this._colors = colors;

  /**
   * @type {string}
   * @private
   */
  this._id = id || epiviz.utils.generatePseudoGUID(6);

  /**
   * @type {string}
   * @private
   */
  this._name = name || 'Custom (' + this._id + ')';

  /**
   * @type {Object.<string|number, number>}
   * @private
   */
  this._keyIndices = keyIndices || {};

  /**
   * @type {number}
   * @private
   */
  this._nKeys = 0;
};

/**
 * @returns {string}
 */
epiviz.ui.charts.ColorPalette.prototype.id = function() { return this._id; };

/**
 * @returns {string}
 */
epiviz.ui.charts.ColorPalette.prototype.name = function() { return this._name; };

/**
 * @param {number} i
 * @returns {string} A color corresponding to the index i
 */
epiviz.ui.charts.ColorPalette.prototype.get = function(i) {
  return this._colors[i % this._colors.length];
};

/**
 * @param {string|number} key
 * @returns {string}
 */
epiviz.ui.charts.ColorPalette.prototype.getByKey = function(key) {
  var index = this._keyIndices[key];
  if (index == undefined) {
    index = this._nKeys;
    this._keyIndices[key] = this._nKeys;
    ++this._nKeys;
  }
  return this.get(index);
};

/**
 * @param {string} key
 * @returns {number}
 */
epiviz.ui.charts.ColorPalette.prototype.keyColorIndex = function(key) {
  var ret = this._keyIndices[key];
  if (ret == undefined) { return -1; }
  return ret;
};

/**
 * @returns {Object.<string|number, number>}
 */
epiviz.ui.charts.ColorPalette.prototype.keyIndices = function() { return this._keyIndices; };

/**
 * @returns {Number} The number of colors contained in this palette
 */
epiviz.ui.charts.ColorPalette.prototype.size = function() {
  return this._colors.length;
};

/**
 * @param {epiviz.ui.charts.ColorPalette} other
 * @returns {boolean}
 */
epiviz.ui.charts.ColorPalette.prototype.equals = function(other) {
  if (this == other) { return true; }
  if (!other) { return false; }

  return epiviz.utils.arraysEqual(this._colors, other._colors);
};

/**
 * @returns {epiviz.ui.charts.ColorPalette}
 */
epiviz.ui.charts.ColorPalette.prototype.copy = function() {
  return new epiviz.ui.charts.ColorPalette(this._colors.slice(0));
};

/**
 * @param {epiviz.Config} [config]
 * @returns {{id: string, name: string, colors: Array.<string>}}
 */
epiviz.ui.charts.ColorPalette.prototype.raw = function(config) {
  if (config && (this._id in config.colorPalettesMap)) {
    return {id: this._id};
  }
  return {id: this._id, name: this._name, colors: this._colors};
};

/**
 * @param {Array.<string>|{id:string, name:string, colors:Array.<string>}} o
 * @param {epiviz.Config} [config]
 * @returns {epiviz.ui.charts.ColorPalette}
 */
epiviz.ui.charts.ColorPalette.fromRawObject = function(o, config) {
  if ($.isArray(o)) {
    return new epiviz.ui.charts.ColorPalette(o);
  }

  if (config && (o.id in config.colorPalettesMap)) {
    return config.colorPalettesMap[o.id];
  }

  if (!o.colors || !o.colors.length) { o.colors = epiviz.Config.COLORS_BRIGHT; }

  return new epiviz.ui.charts.ColorPalette(o.colors, o.name, o.id);
};

// Input 208
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/22/2014
 * Time: 12:56 PM
 */

goog.provide('epiviz.ui.charts.tree.IcicleType');

goog.require('epiviz.ui.charts.DataStructureVisualizationType');
goog.require('epiviz.ui.charts.CustomSetting');

/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.tree.HierarchyVisualizationType}
 * @constructor
 */
epiviz.ui.charts.tree.IcicleType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.DataStructureVisualizationType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.tree.IcicleType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.tree.HierarchyVisualizationType.prototype);
epiviz.ui.charts.tree.IcicleType.constructor = epiviz.ui.charts.tree.IcicleType;

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @returns {epiviz.ui.charts.tree.Icicle}
 */
epiviz.ui.charts.tree.IcicleType.prototype.createNew = function(id, container, properties) {
  return new epiviz.ui.charts.tree.Icicle(id, container, properties);
};

/**
 * @returns {string}
 */
epiviz.ui.charts.tree.IcicleType.prototype.typeName = function() {
  return 'epiviz.ui.charts.tree.Icicle';
};

/**
 * @returns {string}
 */
epiviz.ui.charts.tree.IcicleType.prototype.chartName = function() {
  return 'Icicle';
};

/**
 * @returns {string}
 */
epiviz.ui.charts.tree.IcicleType.prototype.chartHtmlAttributeName = function() {
  return 'icicle';
};

/**
 * @returns {Array.<epiviz.ui.charts.CustomSetting>}
 */
epiviz.ui.charts.tree.IcicleType.prototype.customSettingsDefs = function() {
  return epiviz.ui.charts.DataStructureVisualizationType.prototype.customSettingsDefs.call(this).concat([

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.tree.IcicleType.CustomSettings.HOVER_OPACITY,
      epiviz.ui.charts.CustomSetting.Type.NUMBER,
      0.9,
      'Hover Opacity'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.tree.IcicleType.CustomSettings.AGG_LEVEL,
      epiviz.ui.charts.CustomSetting.Type.STRING,
      '',
      'Agg Level'),

    new epiviz.ui.charts.CustomSetting(
      epiviz.ui.charts.tree.IcicleType.CustomSettings.NODE_SEL,
      epiviz.ui.charts.CustomSetting.Type.STRING,
      '{}',
      'Node Selection')
  ]);
};

/**
 * @enum {string}
 */
epiviz.ui.charts.tree.IcicleType.CustomSettings = {
  HOVER_OPACITY: 'hoverOpacity',
  AGG_LEVEL: 'aggLevel',
  NODE_SEL: 'nodeSel'
};

// Input 209
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/7/2014
 * Time: 8:33 PM
 */

goog.provide('epiviz.ui.charts.tree.Node');

goog.require('epiviz.ui.charts.VisObject');
goog.require('epiviz.ui.charts.tree.NodeSelectionType');

/**
 * @param {string} id
 * @param {string} name
 * @param {Array.<epiviz.ui.charts.tree.Node>} children
 * @param {string} parentId
 * @param {number} [size]
 * @param {number} [depth]
 * @param {number} [nchildren]
 * @param {number} [nleaves]
 * @param {epiviz.ui.charts.tree.NodeSelectionType} [selectionType]
 * @param {number} [order]
 * @param {number} [globalDepth]
 * @param {string} [taxonomy]
 * @constructor
 * @struct
 * @extends {epiviz.ui.charts.VisObject}
 */
epiviz.ui.charts.tree.Node = function(id, name, children, parentId, size, depth, nchildren, nleaves, selectionType, order, globalDepth, taxonomy, start, end) {
  epiviz.ui.charts.VisObject.call(this);

  /**
   * @type {string}
   */
  this.id = id;

  /**
   * @type {string}
   */
  this.name = name;

  /**
   * @type {Array.<epiviz.ui.charts.tree.Node>}
   */
  this.children = children;

  /**
   * @type {string}
   */
  this.parentId = parentId;

  /**
   * @type {number}
   */
  this.size = size;

  /**
   * @type {number}
   */
  this.depth = depth;

  /**
   * @type {number}
   */
  this.nchildren = nchildren;

  /**
   * @type {number}
   */
  this.nleaves = nleaves;

  /**
   * @type {epiviz.ui.charts.tree.NodeSelectionType}
   */
  this.selectionType = selectionType || epiviz.ui.charts.tree.NodeSelectionType.NONE;

  /**
   * @type {number}
   */
  this.order = order;

  /**
   * @type {number}
   */
  this.globalDepth = globalDepth;

  /**
   * @type {string}
   */
  this.taxonomy = taxonomy;

  /**
   * @type {number}
   */
  this.start = start;

  /**
   * @type {number}
   */
  this.end = end;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.tree.Node.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.VisObject.prototype);
epiviz.ui.charts.tree.Node.constructor = epiviz.ui.charts.tree.Node;

/**
 * Measurement i, object j
 * @param {number} i
 * @param {number} j
 * @param {string} metadataCol
 * @returns {string}
 */
epiviz.ui.charts.tree.Node.prototype.getMetadata = function(i, j, metadataCol) { return (i != 0 || j != 0 || metadataCol != 'lineage') ? null : this.id; };

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.tree.Node.prototype.metadataColumns = function() { return ['lineage']; };

/**
 * Number of measurements times number of objects stored per measurement
 * @returns {Array.<number>}
 */
epiviz.ui.charts.tree.Node.prototype.dimensions = function() { return [1, 1]; };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.tree.Node.prototype.metadataLooseCompare = function() { return true; };

/**
 * @param {epiviz.ui.charts.tree.Node} node
 * @param {function(epiviz.ui.charts.tree.Node): boolean} callback A function called
 *   for each node in the traversal. If it returns something that evaluates to true, the
 *   traversal is halted.
 */
epiviz.ui.charts.tree.Node.dfs = function(node, callback) {
  if (!node) { return; }
  if (callback(node)) { return; }
  if (node.children) {
    node.children.forEach(function(child) { epiviz.ui.charts.tree.Node.dfs(child, callback); });
  }
};

/**
 * @param {epiviz.ui.charts.tree.Node} node
 * @param {function(epiviz.ui.charts.tree.Node): boolean} callback A function called
 *   for each node in the traversal. If it returns something that evaluates to true, the
 *   traversal is halted.
 */
epiviz.ui.charts.tree.Node.bfs = function(node, callback) {
  if (!node) { return; }

  var q = [];
  q.push(node);
  for (var i = 0; i < q.length; ++i) {
    if (callback(q[i])) { return; }
    if (q[i].nchildren) {
      q[i].children.forEach(function(child) { q.push(child); });
    }
  }
};

/**
 * Creates a copy of the tree filtering out nodes specified by the filter callback
 * @param {epiviz.ui.charts.tree.Node} node
 * @param {function(epiviz.ui.charts.tree.Node): boolean} filter
 */
epiviz.ui.charts.tree.Node.filter = function(node, filter) {
  if (!filter(node)) { return null; }
  var copy = {};
  for (var key in node) {
    if (!node.hasOwnProperty(key) || key == 'children') { continue; }
    copy[key] = node[key];
  }
  if (node.children) {
    copy.children = [];
    node.children.forEach(function(child) {
      var childCopy = epiviz.ui.charts.tree.Node.filter(child, filter);
      if (childCopy !== null) {
        copy.children.push(childCopy);
      }
    });
  }
  return copy;
};

// Input 210
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/7/2014
 * Time: 9:23 PM
 */

goog.provide('epiviz.ui.charts.tree.UiNode');

goog.require('epiviz.ui.charts.tree.Node');


/**
 * @param {string} id
 * @param {string} name
 * @param {Array.<epiviz.ui.charts.tree.Node>} children
 * @param {string} parentId
 * @param {number} [size]
 * @param {number} [depth]
 * @param {number} [nchildren]
 * @param {number} [nleaves]
 * @param {epiviz.ui.charts.tree.NodeSelectionType} [selectionType]
 * @param {number} [order]
 * @param {number} [globalDepth]
 * @param {string} [taxonomy]
 * @param {number} [x]
 * @param {number} [dx]
 * @param {number} [y]
 * @param {number} [dy]
 * @param {epiviz.ui.charts.tree.Node} [parent]
 * @constructor
 * @struct
 * @extends {epiviz.ui.charts.tree.Node}
 */
epiviz.ui.charts.tree.UiNode = function(id, name, children, parentId, size, depth, nchildren, nleaves, selectionType, order, globalDepth, taxonomy, x, dx, y, dy, parent, start, end) {
  epiviz.ui.charts.tree.Node.call(this, id, name, children, parentId, size, depth, nchildren, nleaves, selectionType, order, globalDepth, taxonomy, start, end);

  /**
   * @type {number}
   */
  this.x = x;

  /**
   * @type {number}
   */
  this.dx = dx;

  /**
   * @type {number}
   */
  this.y = y;

  /**
   * @type {number}
   */
  this.dy = dy;

  /**
   * @type {epiviz.ui.charts.tree.UiNode}
   */
  this.parent = parent || null;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.tree.UiNode.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.tree.Node.prototype);
epiviz.ui.charts.tree.UiNode.constructor = epiviz.ui.charts.tree.UiNode;

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @returns {epiviz.ui.charts.tree.UiNode}
 */
epiviz.ui.charts.tree.UiNode.deepCopy = function(node) {
  var copy = new epiviz.ui.charts.tree.UiNode(node.id, node.name, [], node.parentId,
    node.size, node.depth, node.nchildren, node.nleaves, node.selectionType, node.order, node.globalDepth, node.taxonomy, node.x, node.dx, node.y, node.dy, null, node.start, node.end);
  if (node.children && node.children.length) {
    node.children.forEach(function(child) {
      var childCopy = epiviz.ui.charts.tree.UiNode.deepCopy(child);
      copy.children.push(childCopy);
      childCopy.parent = copy;
    });
  }

  return copy;
};

// Input 211
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/19/2014
 * Time: 12:41 PM
 */

goog.provide('epiviz.ui.charts.tree.NodeSelectionType');

/**
 * @enum {number}
 */
epiviz.ui.charts.tree.NodeSelectionType = {
  NONE: 0,
  LEAVES: 1,
  NODE: 2
};

// Input 212
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/2/2014
 * Time: 7:13 PM
 */


goog.provide('epiviz.ui.charts.tree.HierarchyVisualization');

goog.require('epiviz.ui.charts.DataStructureVisualization');
goog.require('epiviz.ui.charts.tree.NodeSelectionType');
goog.require('epiviz.ui.charts.tree.Node');
goog.require('epiviz.ui.charts.tree.UiNode');
goog.require('epiviz.ui.charts.VisEventArgs');

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.DataStructureVisualization.<epiviz.ui.charts.tree.Node>}
 * @constructor
 */
epiviz.ui.charts.tree.HierarchyVisualization = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.DataStructureVisualization.call(this, id, container, properties);

  // Selection

  /**
   * @type {Object.<string, epiviz.ui.charts.tree.NodeSelectionType>}
   * @private
   */
  this._selectedNodes = JSON.parse(this._customSettingsValues["nodeSel"]) || {};

  /**
   * @type {Object.<number, number>}
   * @private
   */
  this._selectedLevels = {};

  /**
   * @type {Object.<string, number>}
   * @private
   */
  this._nodesOrder = {};

  /**
   * @type {boolean}
   * @private
   */
  this._selectMode = false;

  // Animation

  var self = this;
  /**
   * A D3 function used to partition a tree
   * @private
   */
  this._partition = d3.layout.partition()
    .value(
    /**
     * @param {epiviz.ui.charts.tree.Node} d
     * @returns {number}
     */
      // function(d) { return d.nleaves; }) // If we want the size of the nodes to reflect the number of leaves under them
      function(d) { return 1; }) // If we want the size of the nodes to reflect only the number of leaves in the current subtree
    //.sort(function() { return 0; }); // No reordering of the nodes
    .sort(function(d1, d2) { return (self._calcNodeOrder(d1) || 0) - (self._calcNodeOrder(d2) || 0); }); // Take predefined order into account

  /**
   * @type {Array.<epiviz.ui.charts.tree.UiNode>}
   * @private
   */
  this._uiData = null;

  /**
   * @type {number}
   * @private
   */
  this._oldSubtreeDepth = null;

  /**
   * @type {number}
   * @private
   */
  this._subtreeDepth = null;

  /**
   * @type {number}
   * @private
   */
  this._oldRootDepth = null;

  /**
   * @type {number}
   * @private
   */
  this._rootDepth = null;

  /**
   * @type {Object.<string, epiviz.ui.charts.tree.UiNode>}
   * @private
   */
  this._oldUiDataMap = null;

  /**
   * @type {Object.<string, epiviz.ui.charts.tree.UiNode>}
   * @protected
   */
  this._uiDataMap = {};

  /**
   * @type {epiviz.ui.charts.tree.UiNode}
   * @private
   */
  this._referenceNode = null;

  /**
   * @type {epiviz.ui.charts.tree.UiNode}
   * @private
   */
  this._selectedNode = null;

  /**
   * @type {Array.<string>}
   * @private
   */
  this._levelsTaxonomy = null;

  this.selCutLevel = parseInt(this._customSettingsValues["aggLevel"]) || 3;

  this._selectedLevels[this.selCutLevel] = 2;

  this._firstRun = 0;
};

/**
 * @type {Object.<epiviz.ui.charts.tree.NodeSelectionType, string>}
 * @const
 */
epiviz.ui.charts.tree.HierarchyVisualization.SELECTION_CLASSES = {
  0: 'none-select',
  1: 'leaves-select',
  2: 'node-select'
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.DataStructureVisualization.prototype);
epiviz.ui.charts.tree.HierarchyVisualization.constructor = epiviz.ui.charts.tree.HierarchyVisualization;

/**
 * @param {epiviz.datatypes.Range} [range]
 * @param {epiviz.ui.charts.tree.Node} [root]
 * @returns {Array.<epiviz.ui.charts.VisObject>}
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.draw = function(range, root) {
  epiviz.ui.charts.DataStructureVisualization.prototype.draw.call(this, range, root);

  var self = this;

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  root = this._lastData;
  range = this._lastRange;

  if(this._lastData.dataprovidertype != null && this._lastData.dataprovidertype == "websocket") {
    root = this._lastData.tree;
    range = this._lastRange;

    if(root) {

      self._selectedNodes = {};
      self._oldUiDataMap = null;
      self._uiDataMap = {};

      var selTypeKeys = Object.keys(this._lastData.nodeSelectionTypes);

      for(var i=0; i < selTypeKeys.length; i++) {
        if(this._lastData.nodeSelectionTypes[selTypeKeys[i]] != 1) {
            self._selectedNodes[selTypeKeys[i]] = this._lastData.nodeSelectionTypes[selTypeKeys[i]];
        }
      }

      self._selectedLevels = {};
      self._selectedLevels[this._lastData.selectionLevel] = 2;
    }

      this._lastData = root;
  }

  if (root) {
    this._oldRootDepth = this._rootDepth;
    this._rootDepth = root.depth;
    this._referenceNode = null;
    var uiSelected = root.children && root.children.length ? this._uiDataMap[root.children[0].id] : null;
    this._selectedNode = uiSelected ?
      new epiviz.ui.charts.tree.UiNode(uiSelected.id, uiSelected.name, uiSelected.children, uiSelected.parentId, uiSelected.size,
        uiSelected.depth, uiSelected.nchildren, uiSelected.nleaves, uiSelected.selectionType, uiSelected.order, uiSelected.globalDepth, uiSelected.taxonomy, uiSelected.x, uiSelected.dx, uiSelected.y, uiSelected.dy, uiSelected.parent, uiSelected.start, uiSelected.end) : null;

    this._oldSubtreeDepth = this._subtreeDepth;
    this._subtreeDepth = 0;
    
    // append new data to old data for hierarchy propogation
    if(this._oldUiDataMap == null) {
        this._oldUiDataMap = this._uiDataMap;
    }
    else {
      Object.keys(self._uiDataMap).forEach(function(uiDM) {
        self._oldUiDataMap[uiDM] = self._uiDataMap[uiDM];
      });
    }

    this._uiDataMap = {};

    var uiData = this._partition.nodes(root);
    this._uiData = [];
    var rootCopy = null;
    uiData.every(function(node) {
      if (node.id == root.id) {
        rootCopy = epiviz.ui.charts.tree.UiNode.deepCopy(node);
        return false; // break
      }
      return true;
    });
    var levelsTaxonomy = {};
    epiviz.ui.charts.tree.Node.dfs(rootCopy, function(node) {
      self._uiData.push(node);
      if (!(node.taxonomy in levelsTaxonomy)) { levelsTaxonomy[node.taxonomy] = node.taxonomy; }
    });
    this._levelsTaxonomy = Object.keys(levelsTaxonomy);

    this._uiData.forEach(function(node) {
      self._uiDataMap[node.id] = node;
      if ((!self._referenceNode || self._referenceNode.x == undefined || self._referenceNode.depth < node.depth) && (node.id in self._oldUiDataMap)) {
        self._referenceNode = node;
      }
      if (self._subtreeDepth < node.depth + 1) {
        self._subtreeDepth = node.depth + 1;
      }
    });
    if (!this._selectedNode) { this._selectedNode = root.children && root.children.length ? this._uiDataMap[root.children[0].id] : this._uiDataMap[root.id]; }
    if (!this._referenceNode) { this._referenceNode = this._uiData[0]; }
    if (this._oldSubtreeDepth == null) { this._oldSubtreeDepth = this._subtreeDepth; }
    if (this._oldRootDepth == null) { this._oldRootDepth = this._rootDepth; }

    if(Object.keys(self._selectedLevels).length == 0) {
      self._selectedLevels["3"] = 2;
    }
    else {
      self.selCutLevel = parseInt(Object.keys(self._selectedLevels)[0]);
    }

    Object.keys(self._selectedLevels).forEach(function(sel) {
        if (parseInt(sel) < self.selCutLevel) {
            self.selCutLevel = parseInt(sel);
        }
    });

    // get selectionType from oldUiData
    this._uiData.forEach(function(node) {
        if (self._oldUiDataMap[node.id] != null) {
            node.selectionType = self._oldUiDataMap[node.id].selectionType;
            self._updateSelectionAttribute(node, node.selectionType);
        }

        if(node.globalDepth == self.selCutLevel && node.selectionType != 0) {
          self._updateSelectionAttribute(node, 2);
        }
    }); 

    //update to give parent higher preference
    Object.keys(self._selectedNodes).forEach(function(sel) {
      if(self._uiDataMap[sel]) {
        self._updateSelectionAttribute(self._uiDataMap[sel], self._selectedNodes[sel]);
      }
    });
  }

  //this._drawLegend();

  return this._uiData;
};

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @protected
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype._calcNodeOrder = function(node) {
  if (node.id in this._nodesOrder) { return this._nodesOrder[node.id]; }
  if (node.id in this._uiDataMap) { return this._uiDataMap[node.id].order; }
  return node.order;
};

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @returns {epiviz.ui.charts.tree.UiNode}
 * @protected
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype._getOldNode = function(node) {
  var oldNode = this._oldUiDataMap[node.id];
  var newNode = this._uiDataMap[node.id];
  if (oldNode) { return oldNode; }
  if (!newNode) { return node; }
  var oldDepth = newNode.depth + this._rootDepth - this._oldRootDepth;
  var isRoot = oldDepth < 0;
  var isExtremity = oldDepth < 0 || oldDepth >= this._subtreeDepth;
  var oldY = isRoot ? 0 : Math.min(1, oldDepth / this._oldSubtreeDepth);
  return new epiviz.ui.charts.tree.UiNode(
    node.id, node.name, node.children, node.parentId, node.size, node.depth, node.nchildren, node.nleaves, node.selectionType, node.order, node.globalDepth, node.taxonomy,

    isExtremity ? newNode.x : (newNode.x <= this._referenceNode.x ? 0 : 1), // x
    isExtremity ? newNode.dx : 0, // dx
    oldY, // y
    isExtremity ? 0 : newNode.y + newNode.dy - oldY, // dy
    null,
    node.start,
    node.end
    ); 
};

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @returns {epiviz.ui.charts.tree.UiNode}
 * @protected
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype._getNewNode = function(node) {
  var oldNode = this._oldUiDataMap[node.id];
  var newNode = this._uiDataMap[node.id];
  if (newNode) { return newNode; }
  if (!oldNode) { return node; }
  var newDepth = oldNode.depth - this._rootDepth + this._oldRootDepth;
  var isRoot = newDepth < 0;
  var isExtremity = newDepth < 0 || newDepth >= this._subtreeDepth;
  var newY = isRoot ? 0 : Math.min(1, newDepth / this._subtreeDepth);
  return new epiviz.ui.charts.tree.UiNode(
    node.id, node.name, node.children, node.parentId, node.size, node.depth, node.nchildren, node.nleaves, node.selectionType, node.order, node.globalDepth, node.taxonomy,
    isExtremity ? oldNode.x : (oldNode.x <= this._selectedNode.x ? 0 : 1), // x
    isExtremity ? oldNode.dx : 0, // dx
    newY, // y
    isExtremity ? 0 : oldNode.y + oldNode.dy - newY, // dy
    null, 
    node.start,
    node.end
    ); 
};

/**
 * @private
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype._drawLegend = function() {
  this._svg.selectAll('.chart-title').remove();
  this._svg.selectAll('.chart-title-color').remove();
  if (!this._levelsTaxonomy) { return; }
  var self = this;
  var titleEntries = this._svg
    .selectAll('.chart-title')
    .data(this._levelsTaxonomy);
  titleEntries
    .enter()
    .append('text')
    .attr('class', 'chart-title')
    .attr('font-weight', 'bold')
    .attr('y', this.margins().top() - 5);
  titleEntries
    .attr('fill', function(label) { return self.colors().getByKey(label); })
    .text(function(label) { return label; });

  var textLength = 0;
  var titleEntriesStartPosition = [];

  $('#' + this.id() + ' .chart-title')
    .each(function(i) {
      titleEntriesStartPosition.push(textLength);
      textLength += this.getBBox().width + 15;
    });

  titleEntries.attr('x', function(column, i) {
    return self.margins().left() + 10 + titleEntriesStartPosition[i];
  });

  var colorEntries = this._svg
    .selectAll('.chart-title-color')
    .data(this._levelsTaxonomy)
    .enter()
    .append('circle')
    .attr('class', 'chart-title-color')
    .attr('cx', function(column, i) { return self.margins().left() + 4 + titleEntriesStartPosition[i]; })
    .attr('cy', self.margins().top() - 9)
    .attr('r', 4)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .style('fill', function(label) { return self.colors().getByKey(label); });
};

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.levelsTaxonomy = function() { return this._levelsTaxonomy; };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.selectMode = function() { return this._selectMode; };

/**
 * @param {boolean} mode
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.setSelectMode = function(mode) { this._selectMode = mode; };

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.selectNode = function(node) {
  var selectionType = (node.selectionType + 1) % 3;
  this._selectedNodes[node.id] = selectionType;

  var self = this;

  function setDisplay(nes) {

    nes.selectionType = selectionType;
    self._changeNodeSelection(nes, selectionType);

    if(nes.children.length == 0) {
      return;
    }
    else {
      nes.children.forEach(function(n) {
        setDisplay(n);
      });
    }
  }

  setDisplay(node);

  // this._changeNodeSelection(node, selectionType);

  if (this.autoPropagateChanges()) {
    this.firePropagateHierarchyChanges();
  }

  return selectionType;
};

/**
 * @param {number} level
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.selectLevel = function(level) {
  var self = this;
  var deselectedNodeIds = [];
  var deselectedNodes = [];
  $.each(this._selectedNodes, function(nodeId, selectionType) {
    /** @type {epiviz.ui.charts.tree.UiNode} */
    var node = self._uiDataMap[nodeId];
    if (node != undefined && node.globalDepth == level) {
      deselectedNodeIds.push(nodeId);
      deselectedNodes.push(node);
    }
  });
  deselectedNodeIds.forEach(function(nodeId) { delete self._selectedNodes[nodeId]; });

  var tLevel;

  if (!(level in this._selectedLevels)) {

    var currentLevel = Object.keys(self._selectedLevels)[0]

    self._changeLevelSelection(this._levelsTaxonomy[currentLevel], 1);

      //propogate level selection to nodes
    self._uiData.forEach(function(node) {
      if (node.globalDepth == currentLevel && node.selectionType != 0) {
          self._updateSelectionAttribute(node, 1);
          self._uiDataMap[node.id] == node.selectionType;
      }
    });

    for(var nodeId in  self._oldUiDataMap) {
      var node = self._oldUiDataMap[nodeId];
      if (node.globalDepth == currentLevel && node.selectionType != 0) {
          self._updateSelectionAttribute(node, 1);
          self._oldUiDataMap[nodeId] == 1;
      }
    }

    this._selectedLevels = {};

    tLevel = 2;
    this._selectedLevels[level] = epiviz.ui.charts.tree.NodeSelectionType.NODE;
  } else {
    
    var tLevel = (this._selectedLevels[level] + 1) % 3;

    if (tLevel == 0) {
      tLevel = 1;
    }
    this._selectedLevels[level] = tLevel;
  }

  deselectedNodes.forEach(function(tn) {
    self._changeNodeSelection(tn, tLevel);
  });

  self._changeLevelSelection(self._levelsTaxonomy[level], tLevel);

  //propogate level selection to nodes
  self._uiData.forEach(function(node) {
    if (node.globalDepth == level) {
        node.selectionType = self._selectedLevels[level.toString()];
        self._updateSelectionAttribute(node, node.selectionType);
        self._uiDataMap[node.id] == node.selectionType;
    }
  });

  for(var nodeId in  self._oldUiDataMap) {
      var node = self._oldUiDataMap[nodeId];
      if (node.globalDepth == level) {
        node.selectionType = self._selectedLevels[level.toString()];
          self._updateSelectionAttribute(node, node.selectionType);
          self._oldUiDataMap[nodeId] == node.selectionType;
      }
    }

  if (this.autoPropagateChanges()) {
    this.firePropagateHierarchyChanges();
  }
};

/**
 * @returns {Object.<string, epiviz.ui.charts.tree.NodeSelectionType>}
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.selectedNodes = function() { return this._selectedNodes; };

/**
 * @returns {Object.<string, number>}
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.nodesOrder = function() { return this._nodesOrder; };

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @param {epiviz.ui.charts.tree.NodeSelectionType} selectionType
 * @private
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype._changeNodeSelection = function(node, selectionType) {
  var selectionClasses = epiviz.ui.charts.tree.HierarchyVisualization.SELECTION_CLASSES;
  var item = this._svg.select('#' + this.id() + '-' + node.id);

  for (var t in selectionClasses) {
    if (!selectionClasses.hasOwnProperty(t)) { continue; }
    item.classed(selectionClasses[t], false);
  }
  item.classed(selectionClasses[selectionType], true);
};

epiviz.ui.charts.tree.HierarchyVisualization.prototype._changeLevelSelection = function(level, selectionType) {
  var selectionClasses = epiviz.ui.charts.tree.HierarchyVisualization.SELECTION_CLASSES;
  var item = this._svg.select('#' + this.id() + '-' + level);

  for (var t in selectionClasses) {
    if (!selectionClasses.hasOwnProperty(t)) { continue; }
    item.classed(selectionClasses[t], false);
  }
  item.classed('custom-select', false);
  item.classed(selectionClasses[selectionType], true);
};

/**
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.firePropagateHierarchyChanges = function() {
  var selectedNodes = this._selectedNodes;
  var nodesOrder = this._nodesOrder;
  var selectedLevels = this._selectedLevels;
  //this._selectedNodes = {};
  //this._nodesOrder = {};
  this.onPropagateHierarchyChanges().notify(new epiviz.ui.charts.VisEventArgs(
    this.id(),
    new epiviz.ui.controls.VisConfigSelection(undefined, undefined, this.datasourceGroup(), this.dataprovider(), undefined, undefined, undefined,
      {selection: selectedNodes, order: nodesOrder, selectedLevels: selectedLevels})));
};

/**
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.fireRequestHierarchy = function() {
  var nodeId = null;
  if (this._lastData && this._lastData.children) {
    if (this._lastData.children.length == 1) {
      nodeId = this._lastData.children[0].id;
    } else {
      nodeId = this._lastData.id;
    }
  }
  this.onRequestHierarchy().notify(new epiviz.ui.charts.VisEventArgs(
    this.id(),
    new epiviz.ui.controls.VisConfigSelection(undefined, undefined, this.datasourceGroup(), this.dataprovider(), undefined, undefined, undefined, nodeId)));
};

/**
 * @param {boolean} val
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.setAutoPropagateChanges = function(val) {
  epiviz.ui.charts.Visualization.prototype.setAutoPropagateChanges.call(this, val);
  if (val) { this.firePropagateHierarchyChanges(); }
};


/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @param {number} selectionType
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype._updateSelectionAttribute = function(node, selectionType) {

  var self = this;

  function setDisplay(nes, sType) {

    if(nes.selectionType != 0) {
      nes.selectionType = sType;
    }

    self._changeNodeSelection(nes, nes.selectionType);

    if(nes.children.length == 0) {
      return;
    }
    else {
      nes.children.forEach(function(n) {
        setDisplay(n, nes.selectionType);
      });
    }
  }

  setDisplay(node, selectionType);
};

// Input 213
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/7/2014
 * Time: 7:18 PM
 */

goog.provide('epiviz.ui.charts.tree.Icicle');

goog.require('epiviz.ui.charts.tree.HierarchyVisualization');
goog.require('epiviz.ui.charts.Axis');
goog.require('epiviz.ui.charts.VisEventArgs');
goog.require('epiviz.ui.controls.VisConfigSelection');
goog.require('epiviz.datatypes.GenomicRange');
goog.require('epiviz.ui.charts.tree.UiNode');

/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @constructor
 * @extends {epiviz.ui.charts.tree.HierarchyVisualization}
 */
epiviz.ui.charts.tree.Icicle = function(id, container, properties) {

  epiviz.ui.charts.tree.HierarchyVisualization.call(this, id, container, properties);

  // Animation

  /**
   * The number of milliseconds for animations within the chart
   * @type {number}
   * @private
   */
  this._animationDelay = 750;

  /**
   * @type {boolean}
   * @private
   */
  this._dragging = false;

  /**
   * Used to measure maximum number of chars to display
   * @type {number}
   * @private
   */
  this._charWidth = 10;

  /**
   * Used to clip labels that are too long
   * @type {number}
   * @private
   */
  this._nodeMargin = 3;

  /**
   * @type {number}
   * @private
   */
  this._nodeBorder = 1;

  /**
   * Size of icons on nodes. This should be the same as the font size of ".icicle .icon" in svg.css
   * @type {number}
   * @private
   */
  this._iconSize = 16;

  /**
   * @type {function(number): number}
   * @private
   */
  this._xScale = null;

  /**
   * @type {function(number): number}
   * @private
   */
  this._yScale = null;

  /**
   * @type {number}
   * @private
   */
  this._rowCtrlWidth = 50;

  this._legendX = null;

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.tree.Icicle.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.tree.HierarchyVisualization.prototype);
epiviz.ui.charts.tree.Icicle.constructor = epiviz.ui.charts.tree.Icicle;

/**
 * Initializes the chart and draws the initial SVG in the container
 * @protected
 */
epiviz.ui.charts.tree.Icicle.prototype._initialize = function() {
  epiviz.ui.charts.tree.HierarchyVisualization.prototype._initialize.call(this);

  this._svg.classed('icicle', true);

  this._legend = this._svg.append('g').attr('class', 'chart-legend');
};


/**
 * @param {epiviz.datatypes.Range} [range]
 * @param {epiviz.ui.charts.tree.Node} [root]
 * @returns {Array.<epiviz.ui.charts.VisObject>}
 */
epiviz.ui.charts.tree.Icicle.prototype.draw = function(range, root) {
  var uiData = epiviz.ui.charts.tree.HierarchyVisualization.prototype.draw.call(this, range, root);

  var self = this;

  var hoverOpacity = this.customSettingsValues()[epiviz.ui.charts.tree.IcicleType.CustomSettings.HOVER_OPACITY];

  var aggLevel = this.customSettingsValues()[epiviz.ui.charts.tree.IcicleType.CustomSettings.AGG_LEVEL];
  var nodeSel = this.customSettingsValues()[epiviz.ui.charts.tree.IcicleType.CustomSettings.NODE_SEL];

  //self.visualization().setCustomSettingsValues(settingsValues);

  var Axis = epiviz.ui.charts.Axis;

  if (!root) {
    root = this._lastData;
  }

  self._lastRoot = root;

  var width = this.width();
  var height = this.height();

  this._xScale = d3.scale.linear().range([this._rowCtrlWidth, width - this.margins().sumAxis(Axis.X)]);
  //this._yScale = d3.scale.pow().exponent(1.25).range([0, height - this.margins().sumAxis(Axis.Y)]);
  this._yScale = d3.scale.linear().range([0, height - this.margins().sumAxis(Axis.Y)]);
  
  this._drawAxes(root);

  var itemsGroup = this._svg.select('.items');
  var defs = this._svg.select('.defs');
  if (itemsGroup.empty()) {
    itemsGroup = this._svg.append('g')
      .attr('class', 'items');

    var selectedGroup = itemsGroup.append('g').attr('class', 'selected');
    itemsGroup.append('g').attr('class', 'hovered');
    selectedGroup.append('g').attr('class', 'hovered');
  }
  if (defs.empty()) {
    defs = this._svg.select('defs').append('g')
      .attr('class', 'defs');
  }
  itemsGroup
    .attr('transform', sprintf('translate(%s,%s)', this.margins().left(), this.margins().top()));
  defs
    .attr('transform', sprintf('translate(%s,%s)', this.margins().left(), this.margins().top()));

  if (!root) { return []; }

    var calcOldWidth = function(d) {
        var node = self._getOldNode(d);
        return Math.max(0, self._xScale(node.x + node.dx) - self._xScale(node.x) - 2 * self._nodeBorder);
    };
    var calcOldHeight = function(d) {
        var node = self._getOldNode(d);
        return Math.max(0, self._yScale(node.y + node.dy) - self._yScale(node.y) - 2 * self._nodeBorder);
    };
    var calcOldX = function(d) {
        return self._xScale(self._getOldNode(d).x) + self._nodeBorder;
    };
    var calcOldY = function(d) {
        return height - self._yScale(self._getOldNode(d).y) - calcOldHeight(d) - self.margins().sumAxis(Axis.Y) + self._nodeBorder;
    };
    var calcNewWidth = function(d) {
        var node = self._getNewNode(d);
        return Math.max(0, self._xScale(node.x + node.dx) - self._xScale(node.x) - 2 * self._nodeBorder);
    };
    var calcNewHeight = function(d) {
        var node = self._getNewNode(d);
        return Math.max(0, self._yScale(node.y + node.dy) - self._yScale(node.y) - 2 * self._nodeBorder);
    };
    var calcNewX = function(d) {
        return self._xScale(self._getNewNode(d).x) + self._nodeBorder;
    };
    var calcNewY = function(d) {
        return height - self._yScale(self._getNewNode(d).y) - calcNewHeight(d) - self.margins().sumAxis(Axis.Y) + self._nodeBorder;
    };
  var getOverlappingNode = function(x, y, globalDepth) {
    var ret = null;
    uiData.forEach(function(uiNode) {
      var nodeRect = {
        x: calcNewX(uiNode),
        y: calcNewY(uiNode),
        width: calcNewWidth(uiNode),
        height: calcNewHeight(uiNode)
      };
      if (nodeRect.x <= x && x < nodeRect.x + nodeRect.width && uiNode.globalDepth == globalDepth) {
        //&& nodeRect.y <= y && y < nodeRect.y + nodeRect.height) {
        ret = uiNode;
      }
    });

    return ret;
  };

  var lastUiNodeHovered = null;
  var drag = d3.behavior.drag()
    .origin(function(d) { return {x:0, y:0}})
    .on('dragstart', function(d) {
      self._svg.selectAll('.item').sort(function (a, b) { return (a.id != d.id) ? -1 : 1; });
    })
    .on('drag', function(d) {
      self._dragging = true;
      d3.select(this)
        .attr('transform', 'translate(' + d3.event.x + ',' + d3.event.y + ')');
      var mouseCoordinates = d3.mouse(self._svg[0][0]);
      var uiNodeHovered = getOverlappingNode(mouseCoordinates[0], mouseCoordinates[1], d.globalDepth);
      if (uiNodeHovered && uiNodeHovered.parentId == d.parentId) {
        lastUiNodeHovered = uiNodeHovered;
        self._svg.selectAll('.item').classed('selected', false).classed('dragstart', true);
        self._svg.select('#' + self.id() + '-' + d.id).classed('selected', true).classed('dragstart', false);
        self._svg.select('#' + self.id() + '-' + uiNodeHovered.id).classed('selected', true).classed('dragstart', false);
      }
    })
    .on('dragend', function(d) {
      if (!self._dragging) { return; }
      self._svg.selectAll('.item').classed('selected', false).classed('dragstart', false);
      d3.select(this)
        .attr('transform', null);
      // Change the order
      var mouseCoordinates = d3.mouse(self._svg[0][0]);
      var uiNodeHovered = lastUiNodeHovered;
      if (!uiNodeHovered || uiNodeHovered.parentId != d.parentId || uiNodeHovered.id == d.id) { return; }

      /** @type {epiviz.ui.charts.tree.UiNode} */
      var parent = self._uiDataMap[d.parentId];
      var uiNodeX = calcNewX(uiNodeHovered);
      var uiNodeWidth = calcNewWidth(uiNodeHovered);
      var uiNodeOrder = self._calcNodeOrder(uiNodeHovered);
      var after = false;
      if (mouseCoordinates[0] >= uiNodeX + uiNodeWidth * 0.5) { after = true; }
      var other = null;
      var otherOrder;
      parent.children.forEach(function(child) {
        var childOrder = self._calcNodeOrder(child);
        if ((after && childOrder > uiNodeOrder && (otherOrder == undefined || childOrder < otherOrder)) ||
            (!after && childOrder < uiNodeOrder && (otherOrder == undefined || childOrder > otherOrder))) {
          other = child;
          otherOrder = childOrder;
        }
      });

      var order;
      if (!other && !after) { order = uiNodeOrder - 1; }
      else if (!other && after) { order = uiNodeOrder + 1; }
      else { order = (uiNodeOrder + otherOrder) * 0.5; }

      self.nodesOrder()[d.id] = order;

      if (self.autoPropagateChanges()) {
        self.firePropagateHierarchyChanges();
      } else {
        setTimeout(function() {
          self.draw(range, root);
        }, 0);
      }
    });

  var items = itemsGroup.selectAll('.item')
    .data(uiData, function(d) { return d.id; });

  var clips = defs.selectAll('clipPath')
    .data(uiData, function(d) { return d.id; });

  var newItems = items
    .enter().append('g')
    .attr('id', function(d) { return self.id() + '-' + d.id; })
    .attr('class', function(d) {
      var selectionType = self.selectedNodes()[d.id];
      if (selectionType == undefined) { selectionType = d.selectionType || 0; }
      return 'item ' + epiviz.ui.charts.tree.HierarchyVisualization.SELECTION_CLASSES[selectionType];
    })
    .on('click', function(d) {
      if (self._dragging) { self._dragging = false; return; }
      if (self.selectMode()) {
        var node = self._getNewNode(d);
        d.selectionType = node.selectionType = self.selectNode(node);
      } else {
        self.onRequestHierarchy().notify(new epiviz.ui.charts.VisEventArgs(
          self.id(),
          new epiviz.ui.controls.VisConfigSelection(undefined, undefined, self.datasourceGroup(), self.dataprovider(), undefined, undefined, undefined, d.id)));
      }
      d3.event.stopPropagation();
    })
    .on('mouseover', function(d) {
      self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d));
      
      var w = calcNewWidth(d);
      var maxChars = w / self._charWidth;
      if (maxChars < 7) {
            d3.select(this).append("text")
                .attr("class", "hoverText")
                .text(function(d) {return d.name;})
                .attr("x", function(d) {
                  var xText = calcNewX(d);
                  if (xText < 2*self._rowCtrlWidth) {
                    xText += self._rowCtrlWidth;
                  }
                  if(xText > width -  self._rowCtrlWidth) {
                    xText -= (self._rowCtrlWidth/2);
                  }
                  return xText;
                })
                .attr("y", function(d) { return calcNewY(d) + (calcNewHeight(d)/3)});
      }
      
      self.notifyAggregateNode(d);

    })
    .on('mouseout', function () {
      self._unhover.notify(new epiviz.ui.charts.VisEventArgs(self.id()));
              d3.select(this).selectAll(".hoverText").remove();
    })
    .call(drag);

  var newClips = clips
    .enter().append('clipPath')
    .attr('id', function(d) { return self.id() + '-clip-' + d.id; })
    .append('rect')
    .attr('x', function(d) { return calcOldX(d) + self._nodeMargin; })
    .attr('y', function(d) { return calcOldY(d) + self._nodeMargin; })
    .attr('width', function(d) { return Math.max(0, calcOldWidth(d) - 2 * self._nodeMargin); })
    .attr('height', function(d) { return Math.max(0, calcOldHeight(d) - 2 * self._nodeMargin); });

  var newRects = newItems.append('rect')
    .attr('x', calcOldX)
    .attr('y', calcOldY)
    .attr('width', calcOldWidth)
    .attr('height', calcOldHeight);

  var newLabels = newItems.append('text')
    .attr('class', 'unselectable-text node-label')
    .attr('clip-path', function(d) { return 'url(#' + self.id() + '-clip-' + d.id + ')'; })
    .style("visibility", function(d) {
      var w = calcNewWidth(d);
      var maxChars = w / self._charWidth;
      if (maxChars < 7 && d.depth > (self._levelsTaxonomy.length/2)) {
          return "hidden";
      }
      return "visible";
    })
    .text(function(d) {
      var w = calcOldWidth(d);
      var maxChars = w / self._charWidth;
      if (maxChars < d.name.length - 3) {
        return d.name.substring(0, maxChars) + '...';
      }
      return d.name;
    })
    .attr('x', function(d) { return calcOldX(d) + calcOldWidth(d) * 0.5; })
    .attr('y', function(d) { return calcOldY(d) + calcOldHeight(d) * 0.5; });

  var newIconsBg = newItems.append('circle')
    .attr('class', 'icon-bg')
    .attr('cx', function(d) { return calcOldX(d) + self._nodeMargin + self._iconSize * 0.5; })
    .attr('cy', function(d) { return calcOldY(d) + calcOldHeight(d) - self._nodeMargin - self._iconSize * 0.5; })
    .attr('r', self._iconSize * 0.5 + 2)
    .style('fill', '#ffffff')
    .style('opacity', 0);

  var newIcons = newItems.append('svg:foreignObject')
    .attr('class', 'icon-container')
    .attr('clip-path', function(d) { return 'url(#' + self.id() + '-clip-' + d.id + ')'; })
    .attr('width', this._iconSize)
    .attr('height', this._iconSize)
    .attr('x', function(d) { return calcOldX(d) + self._nodeMargin; })
    .attr('y', function(d) { return calcOldY(d) + calcOldHeight(d) - self._nodeMargin - self._iconSize; })
    .append('xhtml:span')
    .attr('class', 'unselectable-text icon')
    .on('mouseover', function(d) {
      d3.select(d3.select(this).node().parentNode.parentNode).select('.icon-bg')
        .style('opacity', 0.3);
    })
    .on('mouseout', function(d) {
      d3.select(d3.select(this).node().parentNode.parentNode).select('.icon-bg')
        .style('opacity', 0);
    })
    .on('mousedown', function(d) {
      d3.event.stopPropagation();
    })
    .on('click', function(d) {
      var node = self._getNewNode(d);
      node.selectionType = d.selectionType;
      node.selectionType = self.selectNode(node);
      self._customSettingsValues["nodeSel"] = JSON.stringify(self._selectedNodes);
      d.selectionType = node.selectionType;
      self._customSettingsChanged.notify(new epiviz.ui.charts.VisEventArgs(self._id, self._customSettingsValues));
      d3.event.stopPropagation();
    });


  defs.selectAll('rect')
    .transition().duration(this._animationDelay)
    .attr('x', function(d) { return calcNewX(d) + self._nodeMargin; })
    .attr('y', function(d) { return calcNewY(d) + self._nodeMargin; })
    .attr('width', function(d) { return Math.max(0, calcNewWidth(d) - 2 * self._nodeMargin); })
    .attr('height', function(d) { return Math.max(0, calcNewHeight(d) - 2 * self._nodeMargin); });

  itemsGroup.selectAll('.item')
    .attr('class', function(d) {
      var selectionType = self.selectedNodes()[d.id];
      if (selectionType == undefined) { selectionType = d.selectionType || 0; }
      return 'item ' + epiviz.ui.charts.tree.HierarchyVisualization.SELECTION_CLASSES[selectionType];
    });

  itemsGroup.selectAll('.item').selectAll('rect')
    .transition().duration(this._animationDelay)
    .style('fill', function(d) { 
      return self.colors().getByKey(d.taxonomy); 
    })
    .attr('x', calcNewX)
    .attr('y', calcNewY)
    .attr('width', calcNewWidth)
    .attr('height', calcNewHeight);

  itemsGroup.selectAll('.item').selectAll('.node-label')
    .transition().duration(this._animationDelay)
    .attr('x', function(d) { return calcNewX(d) + calcNewWidth(d) * 0.5; })
    .attr('y', function(d) { return calcNewY(d) + calcNewHeight(d) * 0.5; })
    .style("visibility", function(d) {
      var w = calcNewWidth(d);
      var maxChars = w / self._charWidth;
      if (maxChars < 7 && d.depth > (self._levelsTaxonomy.length/2)) {
          return "hidden";
      }
      return "visible";
    })
    .tween('text', function(d) {
      var w = d3.interpolate(calcOldWidth(d), calcNewWidth(d));
      return function(t) {
        var maxChars = Math.round(w(t) / self._charWidth);
        if (maxChars < d.name.length - 3) {
          this.textContent = d.name.substring(0, maxChars) + '...';
          return;
        }
        this.textContent = d.name;
      };
    });

  itemsGroup.selectAll('.item').selectAll('.icon-bg')
    .transition().duration(this._animationDelay)
    .style("visibility", function(d) {
      var w = calcNewWidth(d);
      if (w < 20) {
          return "hidden";
      }
      return "visible";
    })
    .attr('cx', function(d) { return calcNewX(d) + self._nodeMargin + self._iconSize * 0.5; })
    .attr('cy', function(d) { return calcNewY(d) + calcNewHeight(d) - self._nodeMargin - self._iconSize * 0.5; });

  itemsGroup.selectAll('.item').selectAll('.icon-container')
    .transition().duration(this._animationDelay)
    .style("visibility", function(d) {
      var w = calcNewWidth(d);
      if (w < 20) {
          return "hidden";
      }
      return "visible";
    })
    .attr('x', function(d) { return calcNewX(d) + self._nodeMargin; })
    .attr('y', function(d) { return calcNewY(d) + calcNewHeight(d) - self._nodeMargin - self._iconSize; });


  items.exit()
    .selectAll('.node-label').transition().duration(this._animationDelay)
    .attr('x', function(d) { return calcNewX(d) + calcNewWidth(d) * 0.5; })
    .attr('y', function(d) { return calcNewY(d) + calcNewHeight(d) * 0.5; });
  items.exit().transition().delay(this._animationDelay).remove();

  this._drawRowControls(root);

  if(this._firstRun == 0) {
    this._firstRun++;
    // this.selectLevel(this.selCutLevel);
    this.firePropagateHierarchyChanges();
  }

  return uiData;
};


epiviz.ui.charts.tree.Icicle.prototype._updateChartLocation = function(start, width) {

  var self = this;
        
  self._propagateIcicleLocationChanges.notify({start: start, width: width});

  self._lastRange = new epiviz.datatypes.GenomicRange('NA', 
                          start, 
                          width);
};

epiviz.ui.charts.tree.Icicle.prototype._updateLocation = function(start, width) {
  var self = this;
  self._lastRange = new epiviz.datatypes.GenomicRange('NA', 
                          start, 
                          width);
};

epiviz.ui.charts.tree.Icicle.prototype._drawAxes = function(root) {

  if(!root) {return;}

  this._legend.selectAll("*").remove();

  var self = this;

  var navbar_y = 27;
  var navbar_height = 17;

  //var location =  $('#text-location').val();
  var location = self._lastRange;

  if(location != null) {

      var loc_start = location.start();
      var loc_end = location.end();

      var node_starts = [], node_ends = [];
      var node_starts_val = [], node_ends_val = [];

      var move_level = parseInt(self.selCutLevel);

      if(!(root.globalDepth <= move_level && (root.globalDepth + self._subtreeDepth - 1) >= move_level)) {
          move_level = root.globalDepth + this._subtreeDepth - 1;
      }

      this._uiData.forEach(function(uiNode) {

        if( (uiNode.globalDepth) == move_level) {
          if(  loc_start <= uiNode.start || (loc_start >= uiNode.start && loc_start < uiNode.end) ) {
            node_starts.push(uiNode.x);
            node_starts_val.push([uiNode.start, uiNode.end]);
          }

          if( loc_end > uiNode.end || (loc_end > uiNode.start && loc_end <= uiNode.end) ) {
            node_ends.push(uiNode.x + uiNode.dx);
            node_ends_val.push([uiNode.start, uiNode.end]);
          }
        }

      });

      function moveLeftCtrl() {
        if(node_starts_val.length == 0 || node_ends_val.length == 0) {
        }
        else {
          var x1 = node_starts_val[0][0] - 1;
          var x2 = node_ends_val[node_ends_val.length-1][0];
          self._updateChartLocation(x1, x2 - x1);
              self._drawAxes(self._lastRoot);
        }        
      }

      function moveCtrCtrl() {
        if(node_starts_val.length == 0 || node_ends_val.length == 0) {
          if(node_starts_val.length > 0) {
            var x1 = node_starts_val[0][0];
            var x2 = node_starts_val[node_starts_val.length-1][1];
            // find the block right to the current position.
            self._updateChartLocation(x1, x2 - x1);
                self._drawAxes(self._lastRoot);
          }
          else if(node_ends_val.length > 0) {
              var x1 = node_ends_val[0][0];
              var x2 = node_ends_val[node_ends_val.length-1][1];
              // find the block right to the current position.
              self._updateChartLocation(x1, x2 - x1);
                  self._drawAxes(self._lastRoot);
          }
        }
        else {
          var x2 = node_starts_val[node_starts_val.length-1][1];
          var x1 = node_ends_val[0][0];
          // find the block right to the current position.
          self._updateChartLocation(x1, x2 - x1);
              self._drawAxes(self._lastRoot);
        }
      }

      function moveRightCtrl() {
        if(node_starts_val.length == 0 || node_ends_val.length == 0) {
        }
        else {
            var x1 = node_starts_val[0][1];
            var x2 = node_ends_val[node_ends_val.length-1][1] + 1;
            // find the block right to the current position.
            self._updateChartLocation(x1, x2 - x1);
                self._drawAxes(self._lastRoot);
        }
      }

      if(node_starts.length == 0) {

        var ctrCtrl = this._legend.append('g')
          .on("click", function(d) {
              moveCtrCtrl();
              d3.event.stopPropagation();
          });

      ctrCtrl.append("rect")
        .attr("x", self.margins().left() + this._rowCtrlWidth / 3 - 1)
        .attr("y", navbar_y)
        .attr("rx", 5)
        .attr("ry", 5)
        .attr("height", navbar_height)
        .attr("width", this._rowCtrlWidth / 3 - 2)
        .attr("fill-opacity", .3)
        .attr("fill","gray");

      var ctrIcons = ctrCtrl.append('svg:foreignObject')
        .attr('class', 'icon-container')
        .attr("x", (self.margins().left() - 5 + this._rowCtrlWidth / 3 - 1 + (this._rowCtrlWidth / 3 - 2) * 0.5 ))
        .attr("y", (navbar_y + (navbar_height/3) - 4))
        .attr("height", navbar_height)
        .attr("width", this._rowCtrlWidth / 3 - 2);

      ctrIcons.append('xhtml:span')
        .attr('class', 'unselectable-text fa fa-exchange')
        .attr("fill-opacity", .5)
        .style('color', 'black');

        this._legend.append("svg:line")
          .attr("x1", self._rowCtrlWidth + self.margins().left() + 5)
          .attr("y1", navbar_y + (navbar_height/2))
          .attr("x2", self.width() - self.margins().left() - 5)
          .attr("y2", navbar_y + (navbar_height/2))
          .attr("fill-opacity", .5)
          .style("stroke", "grey")
          .style("stroke-width", 3)
          .attr("stroke-dasharray", "10,10");

        this._legend.append("polyline")
          .style("stroke", "grey")
          .style("fill", "none")
          .style("stroke-width", 2)
          .style("stroke-linejoin", "round")
          .attr("fill-opacity", .5)
          .attr("points", (Math.round(self._rowCtrlWidth + self.margins().left() + 5) - 3) + 
                          "," + (navbar_y + (navbar_height/2) - 7) +
                          " " + (Math.round(self._rowCtrlWidth + self.margins().left() + 5) - 3) +
                          "," + (navbar_y + (navbar_height/2)) + 
                          " " +  (Math.round(self._rowCtrlWidth + self.margins().left() + 5) - 3) + 
                          "," + (navbar_y + (navbar_height/2) + 7)
                          ); 


        this._legend.append("polyline")       
          .style("stroke", "grey")   
          .style("fill", "none")      
          .style("stroke-width", 2)  
          .style("stroke-linejoin", "round")
          .attr("fill-opacity", .5)
          .attr("points", (Math.round(self.width() - self.margins().left() - 5) - 5 ) + 
                          "," + (navbar_y + (navbar_height/2) - 7) +
                          " " + (Math.round(self.width() - self.margins().left() - 5) + 3) +
                          "," + (navbar_y + (navbar_height/2)) + 
                          " " +  (Math.round(self.width() - self.margins().left() - 5) - 5) + 
                          "," + (navbar_y + (navbar_height/2) + 7)
                          ); 
      }
      else if (node_ends.length == 0) {

        var ctrCtrl = this._legend.append('g')
        //.attr("cursor", "pointer")
          .on("click", function(d) {
              moveCtrCtrl();
              d3.event.stopPropagation();
          });

      ctrCtrl.append("rect")
        .attr("x", self.margins().left() + this._rowCtrlWidth / 3 - 1)
        .attr("y", navbar_y)
        .attr("rx", 5)
        .attr("ry", 5)
        .attr("height", navbar_height)
        .attr("width", this._rowCtrlWidth / 3 - 2)
        .attr("fill-opacity", .3)
        .attr("fill","gray");

      var ctrIcons = ctrCtrl.append('svg:foreignObject')
        .attr('class', 'icon-container')
        .attr("x", (self.margins().left() - 5 + this._rowCtrlWidth / 3 - 1 + (this._rowCtrlWidth / 3 - 2) * 0.5 ))
        .attr("y", (navbar_y + (navbar_height/3) - 4))
        .attr("height", navbar_height)
        .attr("width", this._rowCtrlWidth / 3 - 2);

      ctrIcons.append('xhtml:span')
        .attr('class', 'unselectable-text fa fa-exchange')
        .attr("fill-opacity", .5)
        .style('color', 'black');

        this._legend.append("svg:line")
          .attr("x1", self._rowCtrlWidth + self.margins().left() + 5)
          .attr("y1", navbar_y + (navbar_height/2))
          .attr("x2", self.width() - self.margins().left() - 5)
          .attr("y2", navbar_y + (navbar_height/2))
          .attr("fill-opacity", .5)
          .style("stroke", "grey")
          .style("stroke-width", 3)
          .attr("stroke-dasharray", "10,10");

        this._legend.append("polyline")
          .style("stroke", "grey")
          .style("fill", "none")
          .style("stroke-width", 2)
          .style("stroke-linejoin", "round")
          .attr("fill-opacity", .5)
          .attr("points", (Math.round(self._rowCtrlWidth + self.margins().left() + 5) + 3) + 
                          "," + (navbar_y + (navbar_height/2) - 7) +
                          " " + (Math.round(self._rowCtrlWidth + self.margins().left() + 5) - 5) +
                          "," + (navbar_y + (navbar_height/2)) + 
                          " " +  (Math.round(self._rowCtrlWidth + self.margins().left() + 5) + 3) + 
                          "," + (navbar_y + (navbar_height/2)  + 7)
                          ); 


        this._legend.append("polyline")       
          .style("stroke", "grey")   
          .style("fill", "none")      
          .style("stroke-width", 2)  
          .style("stroke-linejoin", "round")
          .attr("fill-opacity", .5)
          .attr("points", (Math.round(self.width() - self.margins().left() - 5) + 3) + 
                          "," + (navbar_y + (navbar_height/2) - 7) +
                          " " + (Math.round(self.width() - self.margins().left() - 5) + 3) +
                          "," + (navbar_y + (navbar_height/2)) + 
                          " " +  (Math.round(self.width() - self.margins().left() - 5) + 3) + 
                          "," + (navbar_y + (navbar_height/2)  + 7)
                          ); 

      }
      else {

      var leftCtrl = this._legend.append('g')
      //.attr("cursor", "pointer")
        .on("click", function(d) {
              moveLeftCtrl();
              d3.event.stopPropagation();
          });

      leftCtrl.append("rect")
        .attr("x", self.margins().left())
        .attr("y", navbar_y)
        .attr("class", "item")
        .attr("rx", 5)
        .attr("ry", 5)
        .attr("height", navbar_height)
        .attr("width", this._rowCtrlWidth / 3 - 2)
        .attr("fill-opacity", .3)
        .attr("fill","gray");

      var leftIcons = leftCtrl.append('svg:foreignObject')
        .attr('class', 'icon-container')
        .attr("x", (self.margins().left() - 4 + (this._rowCtrlWidth / 3 - 2) * 0.5 ))
        .attr("y", (navbar_y + (navbar_height/3)) - 4)
        .attr("height", navbar_height)
        .attr("width", this._rowCtrlWidth / 3 - 2);

      leftIcons.append('xhtml:span')
        .attr('class', 'unselectable-text fa fa-arrow-left')
        .attr("fill-opacity", .5)
        .style('color', 'black');

      var ctrCtrl = this._legend.append('g')
        .attr("class", "ctr-select")
        .on("click", function(d) {
              moveCtrCtrl();
              d3.event.stopPropagation();
          });

      ctrCtrl.append("rect")
        .attr("x", self.margins().left() + this._rowCtrlWidth / 3 - 1)
        .attr("y", navbar_y)
        .attr("rx", 5)
        .attr("ry", 5)
        .attr("height", navbar_height)
        .attr("width", this._rowCtrlWidth / 3 - 2)
        .attr("fill-opacity", .3)
        .attr("fill","gray");

      var ctrIcons = ctrCtrl.append('svg:foreignObject')
        .attr('class', 'icon-container')
        .attr("x", (self.margins().left() - 5 + this._rowCtrlWidth / 3 - 1 + (this._rowCtrlWidth / 3 - 2) * 0.5 ))
        .attr("y", (navbar_y + (navbar_height/3)) - 4)
        .attr("height", navbar_height)
        .attr("width", this._rowCtrlWidth / 3 - 2);

      ctrIcons.append('xhtml:span')
        .attr('class', 'unselectable-text fa fa-exchange')
        .attr("fill-opacity", .5)
        .style('color', 'black');

      var rightCtrl = this._legend.append('g')
      //.attr("cursor", "pointer")
        .on("click", function(d) {
              moveRightCtrl();
              d3.event.stopPropagation();
          });

      rightCtrl.append("rect")
        .attr("x", self.margins().left() + 2 * (this._rowCtrlWidth / 3 - 1))
        .attr("y", navbar_y)
        .attr("rx", 5)
        .attr("ry", 5)
        .attr("height", navbar_height)
        .attr("width", this._rowCtrlWidth / 3 - 2)
        .attr("fill-opacity", .3)
        .attr("fill","gray");

    var rightIcons = rightCtrl.append('svg:foreignObject')
        .attr('class', 'icon-container')
        .attr("x", (self.margins().left() - 5 + (2 * (this._rowCtrlWidth / 3 - 1)) + (this._rowCtrlWidth / 3 - 2) * 0.5 ))
        .attr("y", (navbar_y + (navbar_height/3)) - 4)
        .attr("height", navbar_height)
        .attr("width", this._rowCtrlWidth / 3 - 2);

      rightIcons.append('xhtml:span')
        .attr('class', 'unselectable-text fa fa-arrow-right')
        .attr("fill-opacity", .5)
        .style('color', 'black');

      var x1 = self._xScale(Math.min.apply(Math, node_starts)) + this.margins().left() + 5; // + self._nodeBorder + self._nodeMargin;
      var x2 = self._xScale(Math.max.apply(Math, node_ends)) + this.margins().left() - 5; // + self._nodeBorder + self._nodeMargin;

      var bar_width = x2 - x1;
      var bar_start = x1;

      var y1 = navbar_y;

      var extend_bar_width = 8;

      var drag = d3.behavior.drag().origin(Object)
                  .on("drag", dragmove)
                  .on("dragend", dragend);

      var dragright = d3.behavior.drag()
        .origin(Object)
        .on("drag", rdragresize)
        .on("dragend", rdragend);

      var dragleft = d3.behavior.drag()
        .origin(Object)
        .on("drag", ldragresize)
        .on("dragend", ldragend);

      this._legend.data([{x: x1, y:y1}]);

      this._legend.append("line")
                .attr("x1", self._rowCtrlWidth + self.margins().left() + 5)
                .attr("y1", navbar_y + (navbar_height/2))
                .attr("x2", self.width() - self.margins().left() - 5)
                .attr("y2", navbar_y + (navbar_height/2))
                .attr("fill-opacity", .5)
                .style("stroke", "grey")
                .style("stroke-width", 3);

            this._legend.append("polyline")
                .style("stroke", "grey")
                .style("fill", "none")
                .style("stroke-width", 2)
                .style("stroke-linejoin", "round")
                .attr("fill-opacity", .5)
                .attr("points", (Math.round(self._rowCtrlWidth + self.margins().left() + 5) - 3) +
                    "," + (navbar_y + (navbar_height/2) - 7) +
                    " " + (Math.round(self._rowCtrlWidth + self.margins().left() + 5) - 3) +
                    "," + (navbar_y + (navbar_height/2)) +
                    " " + (Math.round(self._rowCtrlWidth + self.margins().left() + 5) - 3) +
                    "," + (navbar_y + (navbar_height/2) + 7)
                );


            this._legend.append("polyline")
                .style("stroke", "grey")
                .style("fill", "none")
                .style("stroke-width", 2)
                .style("stroke-linejoin", "round")
                .attr("fill-opacity", .5)
                .attr("points", (Math.round(self.width() - self.margins().left() - 5) + 3) +
                    "," + (navbar_y + (navbar_height/2) - 7) +
                    " " + (Math.round(self.width() - self.margins().left() - 5) + 3) +
                    "," + (navbar_y + (navbar_height/2)) +
                    " " + (Math.round(self.width() - self.margins().left() - 5) + 3) +
                    "," + (navbar_y + (navbar_height/2) + 7)
                );


      var dragrect = this._legend.append("rect")
          .attr("id", "active")
          .attr("x", function(d) { return d.x; })
          .attr("y", function(d) { return d.y; })
          .attr("height", navbar_height)
          .attr("width", bar_width)
          .attr("fill-opacity", .5)
          .attr("cursor", "move")
          .call(drag);

      var dragbarleft = this._legend.append("rect")
          .attr("x", function(d) { return d.x - (extend_bar_width/2); })
          .attr("y", function(d) { return d.y + 1; })
          .attr("id", "dragleft")
          .attr("width", extend_bar_width)
          .attr("height", navbar_height - 2)
          .attr("fill", "red")
          .attr("fill-opacity", .5)
          .attr("cursor", "ew-resize")
          .call(dragleft);

      var dragbarright = this._legend.append("rect")
          .attr("x", function(d) { return d.x + bar_width - (extend_bar_width/2); })
          .attr("y", function(d) { return d.y + 1; })
          .attr("id", "dragright")
          .attr("width", extend_bar_width)
          .attr("height", navbar_height - 2)
          .attr("fill", "red")
          .attr("fill-opacity", .5)
          .attr("cursor", "ew-resize")
          .call(dragright);

      // var txMin = node_starts_val[0][0];
      // var txMax = node_ends_val[node_ends_val.length-1][1]; 
      // self._updateChartLocation(txMin, txMax - txMin);

      function dragmove(d) {
        dragrect
            .attr("x", d.x = Math.max(self._rowCtrlWidth + self.margins().left(), Math.min(self.width() - self.margins().left() - bar_width, d3.event.x)));

        dragbarleft 
            .attr("x", function(d) { return d.x - (extend_bar_width/2);});

        dragbarright 
            .attr("x", function(d) { return  d.x + bar_width - (extend_bar_width/2);});

        bar_start = d.x;
      }

      function ldragresize(d) {
        var oldx = d.x; 

        d.x = Math.max(self._rowCtrlWidth + self.margins().left(), Math.min(d.x + bar_width - (extend_bar_width/2), d3.event.x)); 

        bar_start = d.x;
        bar_width = bar_width + (oldx - d.x);

        dragbarleft
          .attr("x", function(d) { return d.x - (extend_bar_width/2); });
        
        dragrect
          .attr("x", function(d) { return  d.x;})
          .attr("width", bar_width);
      }

      function rdragresize(d) {
          var dragx = Math.max(d.x + (extend_bar_width/2), Math.min(self.width() - self.margins().left(), d.x + bar_width + d3.event.dx));
          bar_width = dragx - d.x;

          dragbarright
              .attr("x", dragx - (extend_bar_width/2) );
          dragrect
              .attr("width", bar_width);
      }

      function dragend(d) {
        updateLocationBox(d.x, d.x+bar_width, "drag", d);
      }

      function ldragend(d) {
        updateLocationBox(d.x, d.x+bar_width - 5, "dragleft", d);
      }

      function rdragend(d) {
        updateLocationBox(d.x, d.x+bar_width, "dragright", d);
      }

      function updateLocationBox (loc_x, loc_y, dragType, d) {

        loc_x = self._xScale.invert(loc_x);
        loc_y = self._xScale.invert(loc_y);

        // find nodes positions for those x1 and x2
        var node_starts = [], node_ends = [];
        var range_start = 0, range_end = 0;

        self._uiData.forEach(function(uiNode) {

          if(uiNode.depth == self._rootDepth) {
            range_start = uiNode.start;
            range_end = uiNode.end;
          }

          if( (uiNode.depth) == move_level) {

            if(loc_x >= uiNode.x && loc_x < (uiNode.x + uiNode.dx)) {
              node_starts.push(uiNode.start);
            }

            if(loc_y > uiNode.x && loc_y <= (uiNode.x + uiNode.dx) ) {
              node_ends.push(uiNode.end);
            }
          }

        });

        var x1 = Math.max.apply(Math, node_starts);
        var x2 = Math.min.apply(Math, node_ends);

        if (!Number.isFinite(x1)) {
          x1 = range_start;
        }

        if(!Number.isFinite(x2)) {
          x2 = range_end;
        }

        self._updateChartLocation(x1, x2 - x1);
        self._drawAxes(self._lastRoot);

      }
      }
  }
};

/**
 * @param {epiviz.ui.charts.tree.Node} root
 * @private
 */
epiviz.ui.charts.tree.Icicle.prototype._drawRowControls = function(root) {
  var self = this;

  var height = self.height();

  var calcHeight = function(d, i) { return self._yScale((i + 1) / nLevels) - self._yScale(i / nLevels) - 2; };
  var calcWidth = function(d, i) { return self._rowCtrlWidth - 2; };
  var calcY = function(d, i) { return self._yScale((nLevels - i - 1) / nLevels) + 1; };
  var calcX = function(d, i) { return 1; };
  var calcR = function(d, i) {
    var height = calcHeight(d, i) - 3;
    var width = calcWidth(d, i) - 3;
    return Math.min(height, width) / 2 - 5;
  };

  var rowCtrlGroup = this._svg.select('.row-ctrls');

  if (rowCtrlGroup.empty()) {
    rowCtrlGroup = this._svg.append('g')
      .attr('class', 'row-ctrls');
  }

  rowCtrlGroup
    .attr('transform', sprintf('translate(%s,%s)', this.margins().left(), this.margins().top()));

  rowCtrlGroup.selectAll('.row-ctrl').remove();

  var levelsTaxonomy = this.levelsTaxonomy();
  var nLevels = levelsTaxonomy.length;
  var rowCtrls = rowCtrlGroup.selectAll('.row-ctrl')
    .data(levelsTaxonomy);

  var newCtrls = rowCtrls
    .enter().append('g')
    .attr('id', function(d) { return self.id() + '-' + d; })
    .style('opacity', 0)
    .attr('class', function(d, i) {

      if((root.globalDepth + i) == Object.keys(self._selectedLevels)[0]) {
        return 'row-ctrl ' + epiviz.ui.charts.tree.HierarchyVisualization.SELECTION_CLASSES[self._selectedLevels[root.globalDepth + i]];
      }

      return 'row-ctrl ' + epiviz.ui.charts.tree.HierarchyVisualization.SELECTION_CLASSES[1];

      // Object.keys(self._selectedLevels).forEach(function(sl) {
      //   var selectionType = self._selectedLevels[sl];
      //   if(levelsTaxonomy[sl] == d) {
      //     return 'row-ctrl ' + epiviz.ui.charts.tree.HierarchyVisualization.SELECTION_CLASSES[selectionType];
      //   }
      // });

      // return 'row-ctrl custom-select';
    });

  newCtrls
    .transition().duration(this._animationDelay)
    .style('opacity', 1);

  rowCtrls.exit()
    .transition().duration(this._animationDelay)
    .style('opacity', 0)
    .remove();

  //   newCtrls
  //   .append('rect')
  //   .style('fill', function(label) { return self.colors().getByKey(label); });

  // rowCtrlGroup.selectAll('.row-ctrl').select('rect')
  //   .attr('x', calcX)
  //   .attr('width', calcWidth)
  //   .attr('rx', 10)
  //   .attr('ry', 10)
  //   .transition().duration(this._animationDelay)
  //   .attr('y', calcY)
  //   .attr('height', calcHeight)
  //   .style('fill', function(label) { return self.colors().getByKey(label); });

  newCtrls
    .append('path')
    .attr("class", "rowCtrlPath")
    .style('fill', function(label) { return self.colors().getByKey(label); });


  var lineFunction = d3.svg.line()
                          .x(function(d) { return d.x; })
                          .y(function(d) { return d.y; })
                      .interpolate("linear");

  var lineGraph = rowCtrlGroup.selectAll('.row-ctrl').select("path.rowCtrlPath")
    .attr("d", function(d, i) {

        var height = calcHeight(d, i);
        var width = calcWidth(d, i);
        var x = calcX(d, i);
        var y = calcY(d, i);
        var polyFactor = 5/7;

        var lineData = [];

        y = y+2;

      if(i == 0 && root.globalDepth + i > 0) {
        lineData.push({'x': x, 'y': y});
        lineData.push({'x': x, 'y': (y + (height*polyFactor))});
        lineData.push({'x': x + (width/2), 'y': y + height});
        lineData.push({'x': x + width, 'y': (y + (height*polyFactor))});
        lineData.push({'x': x + width, 'y': y});
        lineData.push({'x': x, 'y': y});
        return lineFunction(lineData)
      }
      else if(i == nLevels-1 && levelsTaxonomy[nLevels-1] != "OTU") {
        lineData.push({'x': x + (width/2), 'y': y});
        lineData.push({'x': x, 'y': (y + (height*(1-polyFactor)))});
        lineData.push({'x': x, 'y': y + height});
        lineData.push({'x': x + width, 'y': y + height});
        lineData.push({'x': x + width, 'y': (y + (height*(1-polyFactor)))});
        lineData.push({'x': x + (width/2), 'y': y});
        return lineFunction(lineData)
      }
      else {
        lineData.push({'x': x, 'y': y});
        lineData.push({'x': x, 'y': y + height});
        lineData.push({'x': x + width, 'y': y + height});
        lineData.push({'x': x + width, 'y': y});
        lineData.push({'x': x, 'y': y});
        return lineFunction(lineData)
      }

    })
    .attr("stroke", "none");

  var textFields2 = newCtrls.append('text')
    .attr("class", "rotatetext-rowCtrl")
    .text(function(d){return d.charAt(0).toUpperCase();})
    .style("font-size", 17)
    .attr("text-anchor", "middle")
    .style("font-weight", "bolder")
    .attr("transform" , function(d, i) {
      var x = calcWidth(d, i) / 2 + 1 - (calcR(d,i) * Math.cos(265));
      var y = calcY(d, i) + (calcHeight(d, i)* 7 / 12) - (calcR(d,i) * Math.sin(265));

      return "translate(" + x + "," + y + ") " + "rotate(-30)";
    });

  var newIconsBg = newCtrls.append('circle')
    .attr('class', 'icon-bg')
    .style('fill', '#ffffff')
    .style('opacity', 0.5);

  rowCtrlGroup.selectAll('.icon-bg')
    .transition().duration(this._animationDelay)
    .attr('cx', function(d, i) { return calcWidth(d, i) / 2 + 1; })
    .attr('cy', function(d, i) { return  calcY(d, i) + (calcHeight(d, i)* 7 / 12); })
    .attr('r', calcR);

  var newIcons = newCtrls.append('svg:foreignObject')
    .attr('class', 'icon-container')
    .attr('width', function(d, i) { return calcR(d, i) * 2; })
    .attr('height', function(d, i) { return calcR(d, i) * 2; });

  newIcons.append('xhtml:span')
    .attr('class', 'unselectable-text icon large-icon');

  rowCtrlGroup.selectAll('.icon-container')
    .style('visibility', function(d, i) {
      return (calcR(d, i) * 2 + 13 < calcWidth(d, i)) ?
        'hidden' : 'visible';
    })
    .transition().duration(this._animationDelay)
    .attr('x', function(d, i) { return calcX(d, i) + calcWidth(d, i) / 2 - calcR(d, i) + 5; })
    .attr('y', function(d, i) { return  calcY(d, i) + (calcHeight(d, i)* 7 / 12) - calcR(d, i) + 5; });

  rowCtrls
    .on('mouseover', function(d, i) {
      d3.select(this)
        .style('opacity', 0.8);
    })
    .on('mouseout', function(d) {
      d3.select(this)
        .style('opacity', 1);
    })
    .on('mousedown', function(d) {
      d3.select(this)
        .style('opacity', 0.7);
    })
    .on('mouseup', function(d) {
      d3.select(this)
        .style('opacity', 0.8);
    })
    .on('click', function(d, i) {
      self.selectLevel(root.globalDepth + i);
      self._customSettingsValues["aggLevel"] = root.globalDepth + i;
      self._customSettingsChanged.notify(new epiviz.ui.charts.VisEventArgs(self._id, self._customSettingsValues));
      d3.event.stopPropagation();
    });
};

/**
 * @param {epiviz.ui.charts.VisObject} selectedObject
 */
epiviz.ui.charts.tree.Icicle.prototype.doHover = function(selectedObject) {

  var hoverOpacity = this.customSettingsValues()[epiviz.ui.charts.tree.IcicleType.CustomSettings.HOVER_OPACITY];

    var self = this;
    if (this._dragging) {
        return;
    }

    var itemsGroup = this._svg.select('.items');
    itemsGroup.classed('unhovered', true);
    var selectItems = itemsGroup.selectAll('.item').filter(function(d) {
        if (d instanceof epiviz.ui.charts.tree.UiNode) {
            var isOverlap = selectedObject.overlapsWith(d);

            if (isOverlap && d.selectionType == 2) {
                self.hoverHierarchy(d);
            }

            return isOverlap;
        }
        return false;
    });
    selectItems.classed('hovered', true);
    itemsGroup.selectAll('.item').sort(function(d1, d2) {
        if (d1 instanceof epiviz.ui.charts.tree.UiNode) {
            return selectedObject.overlapsWith(d1) ? 1 : -1;
        }
        return -1;

    });

    if (selectedObject instanceof epiviz.ui.charts.tree.UiNode) {
        this.hoverHierarchy(selectedObject);
    }

      this._svg.selectAll(".item rect")
      .style("fill-opacity", 1 - hoverOpacity);

      this._svg.selectAll(".item.hovered rect")
      .style("fill-opacity", hoverOpacity);
};

/**
 */
epiviz.ui.charts.tree.Icicle.prototype.doUnhover = function() {

  var hoverOpacity = this.customSettingsValues()[epiviz.ui.charts.tree.IcicleType.CustomSettings.HOVER_OPACITY];

  if (this._dragging) { return; }
  this._svg.select('.items').classed('unhovered', false);
  this._svg.select('.items').selectAll('.item').classed('hovered', false);

        this._svg.selectAll(".item.hovered rect")
      .style("fill-opacity", 1);

      this._svg.selectAll(".item rect")
      .style("fill-opacity", 1);
};

/**
 * @param {epiviz.ui.charts.ChartObject} selectedObject
 */
epiviz.ui.charts.tree.Icicle.prototype.doSelect = function(selectedObject) {
  var itemsGroup = this._svg.select('.items');
  var selectItems = itemsGroup.selectAll('.item').filter(function(d) {
    return selectedObject.overlapsWith(d);
  });
  selectItems.classed('selected', true);
};

/**
 */
epiviz.ui.charts.tree.Icicle.prototype.doDeselect = function() {
  this._svg.select('.items').selectAll('.selected').classed('selected', false);
};

epiviz.ui.charts.tree.Icicle.prototype.hoverHierarchy = function(selectedObject) {

    var self = this;
    var itemsGroup = this._svg.select('.items');

    // for all children and parents set class hovered = true;
    function setChildrenHovered(nes) {
        var selectItems = itemsGroup.selectAll('.item').filter(function(d) {
            if (d instanceof epiviz.ui.charts.tree.UiNode) {
              return nes.overlapsWith(d);
            }
            return false;
        });

        selectItems.classed('hovered', true);
        if (nes.children.length == 0) {
            return;
        } else {
            nes.children.forEach(function(n) {
                setChildrenHovered(n);
            });
        }
    }

    setChildrenHovered(selectedObject);

    function setParentHovered(nes) {
        var selectItems = itemsGroup.selectAll('.item').filter(function(d) {
            if (d instanceof epiviz.ui.charts.tree.UiNode) {
                return nes.overlapsWith(d);
            }
            return false;
        });

        selectItems.classed('hovered', true);
        if (nes.parent == null) {
            return;
        } else {
            setParentHovered(nes.parent);
        }
    }
    setParentHovered(selectedObject);

};

epiviz.ui.charts.tree.Icicle.prototype.notifyAggregateNode = function(node) {

    var self = this;

    function setParentHovered(nes) {

        if (nes.selectionType == 2) {
            self._hover.notify(new epiviz.ui.charts.VisEventArgs(self.id(), nes));
        }

        if (nes.parent == null) {
            return;
        } else {
            setParentHovered(nes.parent);
        }

    }

    if (node.parent != null) {
        setParentHovered(node.parent);
    }

};

// Input 214
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/2/2014
 * Time: 7:13 PM
 */

goog.provide('epiviz.ui.charts.tree.HierarchyVisualizationType');

goog.require('epiviz.ui.charts.DataStructureVisualizationType');


/**
 * @param {epiviz.Config} config
 * @extends {epiviz.ui.charts.DataStructureVisualizationType}
 * @constructor
 */
epiviz.ui.charts.tree.HierarchyVisualizationType = function(config) {
  // Call superclass constructor
  epiviz.ui.charts.DataStructureVisualizationType.call(this, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.tree.HierarchyVisualizationType.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.DataStructureVisualizationType.prototype);
epiviz.ui.charts.tree.HierarchyVisualizationType.constructor = epiviz.ui.charts.tree.HierarchyVisualizationType;

// Input 215
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 11/7/2014
 * Time: 7:18 PM
 */

goog.provide('epiviz.ui.charts.tree.Sunburst');

goog.require('epiviz.ui.charts.Visualization');
goog.require('epiviz.ui.charts.VisEventArgs');


/**
 * @param {string} id
 * @param {jQuery} container
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @constructor
 * @extends {epiviz.ui.charts.Visualization.<epiviz.ui.charts.tree.Node>}
 */
epiviz.ui.charts.tree.Sunburst = function(id, container, properties) {

  epiviz.ui.charts.Visualization.call(this, id, container, properties);

  // Sunburst specific

  /**
   * A D3 function used to partition a tree
   * @private
   */
  this._partition = d3.layout.partition().value(
    /**
     * @param {epiviz.ui.charts.tree.Node} d
     * @returns {number}
     */
    function(d) { return d.nleaves; });

  /**
   * Converts x values for a partition to radians (0..1 -> 0..2PI)
   * @type {function(number): number}
   * @private
   */
  this._x = d3.scale.linear().range([0, 2 * Math.PI]);

  /**
   * @type {number}
   * @private
   */
  this._radius = null;

  /**
   * Converts y values for a partition (depth) to circle radius
   * @type {function(number): number}
   * @private
   */
  this._y = null;

  var self = this;
  /**
   * Generates an arc given a ui node
   * @type {function(epiviz.ui.charts.tree.UiNode): string}
   */
  this._arc = d3.svg.arc()
    .startAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, self._x(d.x))); })
    .endAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, self._x(d.x + d.dx))); })
    .innerRadius(function(d) { return Math.max(0, self._y(d.y)); })
    .outerRadius(function(d) { return Math.max(0, self._y(d.y + d.dy)); });

  /**
   * The number of milliseconds for animations within the chart
   * @type {number}
   * @private
   */
  this._animationDelay = 750;

  /**
   * @type {Array.<epiviz.ui.charts.tree.UiNode>}
   * @private
   */
  this._uiData = null;

  /**
   * @type {number}
   * @private
   */
  this._oldSubtreeDepth = null;

  /**
   * @type {number}
   * @private
   */
  this._subtreeDepth = null;

  /**
   * @type {number}
   * @private
   */
  this._oldRootDepth = null;

  /**
   * @type {number}
   * @private
   */
  this._rootDepth = null;

  /**
   * @type {Object.<string, epiviz.ui.charts.tree.UiNode>}
   * @private
   */
  this._oldUiDataMap = null;

  /**
   * @type {Object.<string, epiviz.ui.charts.tree.UiNode>}
   * @private
   */
  this._uiDataMap = {};

  /**
   * @type {epiviz.ui.charts.tree.UiNode}
   * @private
   */
  this._referenceNode = null;

  /**
   * @type {epiviz.ui.charts.tree.UiNode}
   * @private
   */
  this._selectedNode = null;

  this._initialize();
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.tree.Sunburst.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.Visualization.prototype);
epiviz.ui.charts.tree.Sunburst.constructor = epiviz.ui.charts.tree.Sunburst;

/**
 * Initializes the chart and draws the initial SVG in the container
 * @protected
 */
epiviz.ui.charts.tree.Sunburst.prototype._initialize = function() {
  epiviz.ui.charts.Visualization.prototype._initialize.call(this);

  this._radius = Math.min(this.width(), this.height()) * 0.5;
  this._y = d3.scale.pow().exponent(1.2)
    .range([0, this._radius]);
};


/**
 * @param {epiviz.ui.charts.tree.Node} [root]
 * @returns {Array.<epiviz.ui.charts.VisObject>}
 */
epiviz.ui.charts.tree.Sunburst.prototype.draw = function(root) {
  epiviz.ui.charts.Visualization.prototype.draw.call(this, root);

  var self = this;

  if (root) {
    this._oldRootDepth = this._rootDepth;
    this._rootDepth = root.depth;
    this._referenceNode = null;
    this._selectedNode = this._uiDataMap[root.id];

    this._uiData = this._partition.nodes(root);
    this._oldSubtreeDepth = this._subtreeDepth;
    this._subtreeDepth = 0;
    this._oldUiDataMap = this._uiDataMap;
    this._uiDataMap = {};
    this._uiData.forEach(function(node) {
      self._uiDataMap[node.id] = node;
      if ((!self._referenceNode || !self._referenceNode.x) && (node.id in self._oldUiDataMap)) {
        self._referenceNode = node;
      }
      if (self._subtreeDepth < node.depth + 1) {
        self._subtreeDepth = node.depth + 1;
      }
    });
    if (!this._referenceNode) { this._referenceNode = this._uiData[0]; }
    if (this._oldSubtreeDepth == null) { this._oldSubtreeDepth = this._subtreeDepth; }
    if (this._oldRootDepth == null) { this._oldRootDepth = this._rootDepth; }
  } else {
    root = this._lastData;
  }

  var width = this.width();
  var height = this.height();

  var canvas = this._svg.select('.sunburst-canvas');
  if (canvas.empty()) {
    canvas = this._svg.append('g')
      .attr('class', 'sunburst-canvas')
      .attr('transform', sprintf('translate(%s,%s) rotate(180)', width * 0.5, height * 0.5));
  }

  if (!root) { return; }

  var groups = canvas.selectAll('g')
    .data(this._uiData, function(d) { return d.id; });

  var newGroups = groups
    .enter().append('g')
    .on('click', function(d) { self._select.notify(new epiviz.ui.charts.VisEventArgs(self.id(), d)); });

  var newPaths = newGroups.append('path')
    .attr('id', function(d) { return self.id() + '-' + d.id; })
    .attr('class', 'node-arc')
    .style('fill', function(d) { return self.colors().getByKey((d.children && d.children.length ? d : d.parent).id); });

  var newLabels = newGroups.append('text')
    .attr('class', 'unselectable-text node-label')
    .append('textPath')
    .attr('xlink:href', function(d) { return '#' + self.id() + '-' + d.id; })
    .attr("dx", "6") // margin
    .attr("dy", ".35em") // vertical-align
    .attr('startOffset', 20)
    .text(function(d) { return d.name; });

  canvas.selectAll('g').selectAll('path')
    .transition().duration(this._animationDelay)
    .attrTween('d', function(d) { return self._nodeArcTween(d); });

  canvas.selectAll('g').selectAll('text')
    .transition().duration(this._animationDelay)
    .attrTween('transform', function(d) { return self._nodeLabelTransformTween(d); })
    .each(function(d) {
      d3.select(this.childNodes[0])
        .transition().duration(self._animationDelay)
        .attrTween('startOffset', function(d) { return self._nodeLabelStartOffsetTween(d); });
    });

  groups.exit()
    .selectAll('text').transition().duration(this._animationDelay).style('opacity', 0);
  groups.exit().transition().delay(this._animationDelay).remove();

  return this._uiData;
};

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @returns {function(number): epiviz.ui.charts.tree.UiNode}
 * @private
 */
epiviz.ui.charts.tree.Sunburst.prototype._nodeTween = function(node) {
  var self = this;
  var oldNode = this._oldUiDataMap[node.id];
  var newNode = this._uiDataMap[node.id];

  if (!oldNode && !newNode) {
    return function(t) {
      return node;
    };
  }

  var isRoot, isExtremity;

  // this node will be added
  if (!oldNode) {
    var oldDepth = newNode.depth + this._rootDepth - this._oldRootDepth;
    isRoot = oldDepth < 0;
    isExtremity = oldDepth < 0 || oldDepth >= this._subtreeDepth;
    var oldY = isRoot ? 0 : Math.min(1, oldDepth / this._oldSubtreeDepth);
    oldNode = {
      x: isExtremity ? newNode.x : (newNode.x <= this._referenceNode.x ? 0 : 1),
      dx: isRoot ? 1 : (isExtremity ? newNode.dx : 0),
      y: oldY,
      dy: isExtremity ? 0 : newNode.y + newNode.dy - oldY
    };
  }

  // this node will be removed
  if (!newNode) {
    var newDepth = oldNode.depth - this._rootDepth + this._oldRootDepth;
    isRoot = newDepth < 0;
    isExtremity = newDepth < 0 || newDepth >= this._subtreeDepth;
    var newY = isRoot ? 0 : Math.min(1, newDepth / this._subtreeDepth);
    newNode = {
      x: isExtremity ? oldNode.x : (oldNode.x <= this._selectedNode.x ? 0 : 1),
      dx: isRoot ? 1 : (isExtremity ? oldNode.dx : 0),
      y: newY,
      dy: isExtremity ? 0 : oldNode.y + oldNode.dy - newY
    };
  }

  var xi = d3.interpolate(oldNode.x, newNode.x);
  var dxi = d3.interpolate(oldNode.dx, newNode.dx);
  var yi = d3.interpolate(oldNode.y, newNode.y);
  var dyi = d3.interpolate(oldNode.dy, newNode.dy);
  return function(t) {
    return {x: xi(t), dx: dxi(t), y: yi(t), dy: dyi(t)};
  };
};

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @returns {function(number): string}
 * @private
 */
epiviz.ui.charts.tree.Sunburst.prototype._nodeArcTween = function(node) {
  var self = this;
  /** @type {function(number): epiviz.ui.charts.tree.UiNode} */
  var nodeTween = this._nodeTween(node);
  return function(t) { return self._arc(nodeTween(t)); };
};

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @returns {function(number): string}
 * @private
 */
epiviz.ui.charts.tree.Sunburst.prototype._nodeLabelTransformTween = function(node) {
  var self = this;
  /** @type {function(number): epiviz.ui.charts.tree.UiNode} */
  var nodeTween = this._nodeTween(node);
  return function(t) {
    var dt = nodeTween(t);
    var dx = dt.dx == 1 ? 0 : dt.dx;
    var phi = self._x(dt.x + dx / 2);
    var z = (self._y(dt.y + dt.dy) - self._y(dt.y)) / 2;
    var ty = Math.cos(phi) * z;
    var tx = Math.sin(phi) * z;
    return 'rotate(' + (dt.dx == 1 ? 180 : 0) + ') translate(' + -tx + ',' + ty + ')';
  };
};

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @returns {function(number): string}
 * @private
 */
epiviz.ui.charts.tree.Sunburst.prototype._nodeLabelStartOffsetTween = function(node) {
  var self = this;
  /** @type {function(number): epiviz.ui.charts.tree.UiNode} */
  var nodeTween = this._nodeTween(node);
  return function(t) {
    var dt = nodeTween(t);
    var py = self._y(dt.y + dt.dy);
    return py * self._x(dt.dx / 2);
  };
};

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @returns {string}
 * @private
 */
epiviz.ui.charts.tree.Sunburst.prototype._nodeLabelTransform = function(node) {
  // Bug in D3.js, making arcs start point be in a different location when the arc transforms into a circle:
  var dx = node.dx == 1 ? 0 : node.dx;

  var y0 = this._y(node.y);
  var y1 = this._y(node.y + node.dy);
  var phi = this._x(node.x + dx / 2);
  var z = (y1 - y0) / 2;
  var ty = Math.cos(phi) * z;
  var tx = Math.sin(phi) * z;
  return 'rotate(' + (node.dx == 1 ? 180 : 0) + ') translate(' + -tx + ',' + ty + ')';
};

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @returns {number}
 * @private
 */
epiviz.ui.charts.tree.Sunburst.prototype._nodeLabelStartOffset = function(node) {
  var py = this._y(node.y + node.dy);
  return py * this._x(node.dx / 2);
};

// Input 216
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 12/2/2014
 * Time: 7:13 PM
 */


goog.provide('epiviz.ui.charts.tree.HierarchyVisualization');

goog.require('epiviz.ui.charts.DataStructureVisualization');
goog.require('epiviz.ui.charts.tree.NodeSelectionType');
goog.require('epiviz.ui.charts.tree.Node');
goog.require('epiviz.ui.charts.tree.UiNode');
goog.require('epiviz.ui.charts.VisEventArgs');

/**
 * @param {string} id
 * @param {jQuery} container The div where the chart will be drawn
 * @param {epiviz.ui.charts.VisualizationProperties} properties
 * @extends {epiviz.ui.charts.DataStructureVisualization.<epiviz.ui.charts.tree.Node>}
 * @constructor
 */
epiviz.ui.charts.tree.HierarchyVisualization = function(id, container, properties) {
  // Call superclass constructor
  epiviz.ui.charts.DataStructureVisualization.call(this, id, container, properties);

  // Selection

  /**
   * @type {Object.<string, epiviz.ui.charts.tree.NodeSelectionType>}
   * @private
   */
  this._selectedNodes = JSON.parse(this._customSettingsValues["nodeSel"]) || {};

  /**
   * @type {Object.<number, number>}
   * @private
   */
  this._selectedLevels = {};

  /**
   * @type {Object.<string, number>}
   * @private
   */
  this._nodesOrder = {};

  /**
   * @type {boolean}
   * @private
   */
  this._selectMode = false;

  // Animation

  var self = this;
  /**
   * A D3 function used to partition a tree
   * @private
   */
  this._partition = d3.layout.partition()
    .value(
    /**
     * @param {epiviz.ui.charts.tree.Node} d
     * @returns {number}
     */
      // function(d) { return d.nleaves; }) // If we want the size of the nodes to reflect the number of leaves under them
      function(d) { return 1; }) // If we want the size of the nodes to reflect only the number of leaves in the current subtree
    //.sort(function() { return 0; }); // No reordering of the nodes
    .sort(function(d1, d2) { return (self._calcNodeOrder(d1) || 0) - (self._calcNodeOrder(d2) || 0); }); // Take predefined order into account

  /**
   * @type {Array.<epiviz.ui.charts.tree.UiNode>}
   * @private
   */
  this._uiData = null;

  /**
   * @type {number}
   * @private
   */
  this._oldSubtreeDepth = null;

  /**
   * @type {number}
   * @private
   */
  this._subtreeDepth = null;

  /**
   * @type {number}
   * @private
   */
  this._oldRootDepth = null;

  /**
   * @type {number}
   * @private
   */
  this._rootDepth = null;

  /**
   * @type {Object.<string, epiviz.ui.charts.tree.UiNode>}
   * @private
   */
  this._oldUiDataMap = null;

  /**
   * @type {Object.<string, epiviz.ui.charts.tree.UiNode>}
   * @protected
   */
  this._uiDataMap = {};

  /**
   * @type {epiviz.ui.charts.tree.UiNode}
   * @private
   */
  this._referenceNode = null;

  /**
   * @type {epiviz.ui.charts.tree.UiNode}
   * @private
   */
  this._selectedNode = null;

  /**
   * @type {Array.<string>}
   * @private
   */
  this._levelsTaxonomy = null;

  this.selCutLevel = parseInt(this._customSettingsValues["aggLevel"]) || 3;

  this._selectedLevels[this.selCutLevel] = 2;

  this._firstRun = 0;
};

/**
 * @type {Object.<epiviz.ui.charts.tree.NodeSelectionType, string>}
 * @const
 */
epiviz.ui.charts.tree.HierarchyVisualization.SELECTION_CLASSES = {
  0: 'none-select',
  1: 'leaves-select',
  2: 'node-select'
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.DataStructureVisualization.prototype);
epiviz.ui.charts.tree.HierarchyVisualization.constructor = epiviz.ui.charts.tree.HierarchyVisualization;

/**
 * @param {epiviz.datatypes.Range} [range]
 * @param {epiviz.ui.charts.tree.Node} [root]
 * @returns {Array.<epiviz.ui.charts.VisObject>}
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.draw = function(range, root) {
  epiviz.ui.charts.DataStructureVisualization.prototype.draw.call(this, range, root);

  var self = this;

  // If data is defined, then the base class sets this._lastData to data.
  // If it isn't, then we'll use the data from the last draw call
  root = this._lastData;
  range = this._lastRange;

  if(this._lastData.dataprovidertype != null && this._lastData.dataprovidertype == "websocket") {
    root = this._lastData.tree;
    range = this._lastRange;

    if(root) {

      self._selectedNodes = {};
      self._oldUiDataMap = null;
      self._uiDataMap = {};

      var selTypeKeys = Object.keys(this._lastData.nodeSelectionTypes);

      for(var i=0; i < selTypeKeys.length; i++) {
        if(this._lastData.nodeSelectionTypes[selTypeKeys[i]] != 1) {
            self._selectedNodes[selTypeKeys[i]] = this._lastData.nodeSelectionTypes[selTypeKeys[i]];
        }
      }

      self._selectedLevels = {};
      self._selectedLevels[this._lastData.selectionLevel] = 2;
    }

      this._lastData = root;
  }

  if (root) {
    this._oldRootDepth = this._rootDepth;
    this._rootDepth = root.depth;
    this._referenceNode = null;
    var uiSelected = root.children && root.children.length ? this._uiDataMap[root.children[0].id] : null;
    this._selectedNode = uiSelected ?
      new epiviz.ui.charts.tree.UiNode(uiSelected.id, uiSelected.name, uiSelected.children, uiSelected.parentId, uiSelected.size,
        uiSelected.depth, uiSelected.nchildren, uiSelected.nleaves, uiSelected.selectionType, uiSelected.order, uiSelected.globalDepth, uiSelected.taxonomy, uiSelected.x, uiSelected.dx, uiSelected.y, uiSelected.dy, uiSelected.parent, uiSelected.start, uiSelected.end) : null;

    this._oldSubtreeDepth = this._subtreeDepth;
    this._subtreeDepth = 0;
    
    // append new data to old data for hierarchy propogation
    if(this._oldUiDataMap == null) {
        this._oldUiDataMap = this._uiDataMap;
    }
    else {
      Object.keys(self._uiDataMap).forEach(function(uiDM) {
        self._oldUiDataMap[uiDM] = self._uiDataMap[uiDM];
      });
    }

    this._uiDataMap = {};

    var uiData = this._partition.nodes(root);
    this._uiData = [];
    var rootCopy = null;
    uiData.every(function(node) {
      if (node.id == root.id) {
        rootCopy = epiviz.ui.charts.tree.UiNode.deepCopy(node);
        return false; // break
      }
      return true;
    });
    var levelsTaxonomy = {};
    epiviz.ui.charts.tree.Node.dfs(rootCopy, function(node) {
      self._uiData.push(node);
      if (!(node.taxonomy in levelsTaxonomy)) { levelsTaxonomy[node.taxonomy] = node.taxonomy; }
    });
    this._levelsTaxonomy = Object.keys(levelsTaxonomy);

    this._uiData.forEach(function(node) {
      self._uiDataMap[node.id] = node;
      if ((!self._referenceNode || self._referenceNode.x == undefined || self._referenceNode.depth < node.depth) && (node.id in self._oldUiDataMap)) {
        self._referenceNode = node;
      }
      if (self._subtreeDepth < node.depth + 1) {
        self._subtreeDepth = node.depth + 1;
      }
    });
    if (!this._selectedNode) { this._selectedNode = root.children && root.children.length ? this._uiDataMap[root.children[0].id] : this._uiDataMap[root.id]; }
    if (!this._referenceNode) { this._referenceNode = this._uiData[0]; }
    if (this._oldSubtreeDepth == null) { this._oldSubtreeDepth = this._subtreeDepth; }
    if (this._oldRootDepth == null) { this._oldRootDepth = this._rootDepth; }

    if(Object.keys(self._selectedLevels).length == 0) {
      self._selectedLevels["3"] = 2;
    }
    else {
      self.selCutLevel = parseInt(Object.keys(self._selectedLevels)[0]);
    }

    Object.keys(self._selectedLevels).forEach(function(sel) {
        if (parseInt(sel) < self.selCutLevel) {
            self.selCutLevel = parseInt(sel);
        }
    });

    // get selectionType from oldUiData
    this._uiData.forEach(function(node) {
        if (self._oldUiDataMap[node.id] != null) {
            node.selectionType = self._oldUiDataMap[node.id].selectionType;
            self._updateSelectionAttribute(node, node.selectionType);
        }

        if(node.globalDepth == self.selCutLevel && node.selectionType != 0) {
          self._updateSelectionAttribute(node, 2);
        }
    }); 

    //update to give parent higher preference
    Object.keys(self._selectedNodes).forEach(function(sel) {
      if(self._uiDataMap[sel]) {
        self._updateSelectionAttribute(self._uiDataMap[sel], self._selectedNodes[sel]);
      }
    });
  }

  //this._drawLegend();

  return this._uiData;
};

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @protected
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype._calcNodeOrder = function(node) {
  if (node.id in this._nodesOrder) { return this._nodesOrder[node.id]; }
  if (node.id in this._uiDataMap) { return this._uiDataMap[node.id].order; }
  return node.order;
};

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @returns {epiviz.ui.charts.tree.UiNode}
 * @protected
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype._getOldNode = function(node) {
  var oldNode = this._oldUiDataMap[node.id];
  var newNode = this._uiDataMap[node.id];
  if (oldNode) { return oldNode; }
  if (!newNode) { return node; }
  var oldDepth = newNode.depth + this._rootDepth - this._oldRootDepth;
  var isRoot = oldDepth < 0;
  var isExtremity = oldDepth < 0 || oldDepth >= this._subtreeDepth;
  var oldY = isRoot ? 0 : Math.min(1, oldDepth / this._oldSubtreeDepth);
  return new epiviz.ui.charts.tree.UiNode(
    node.id, node.name, node.children, node.parentId, node.size, node.depth, node.nchildren, node.nleaves, node.selectionType, node.order, node.globalDepth, node.taxonomy,

    isExtremity ? newNode.x : (newNode.x <= this._referenceNode.x ? 0 : 1), // x
    isExtremity ? newNode.dx : 0, // dx
    oldY, // y
    isExtremity ? 0 : newNode.y + newNode.dy - oldY, // dy
    null,
    node.start,
    node.end
    ); 
};

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @returns {epiviz.ui.charts.tree.UiNode}
 * @protected
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype._getNewNode = function(node) {
  var oldNode = this._oldUiDataMap[node.id];
  var newNode = this._uiDataMap[node.id];
  if (newNode) { return newNode; }
  if (!oldNode) { return node; }
  var newDepth = oldNode.depth - this._rootDepth + this._oldRootDepth;
  var isRoot = newDepth < 0;
  var isExtremity = newDepth < 0 || newDepth >= this._subtreeDepth;
  var newY = isRoot ? 0 : Math.min(1, newDepth / this._subtreeDepth);
  return new epiviz.ui.charts.tree.UiNode(
    node.id, node.name, node.children, node.parentId, node.size, node.depth, node.nchildren, node.nleaves, node.selectionType, node.order, node.globalDepth, node.taxonomy,
    isExtremity ? oldNode.x : (oldNode.x <= this._selectedNode.x ? 0 : 1), // x
    isExtremity ? oldNode.dx : 0, // dx
    newY, // y
    isExtremity ? 0 : oldNode.y + oldNode.dy - newY, // dy
    null, 
    node.start,
    node.end
    ); 
};

/**
 * @private
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype._drawLegend = function() {
  this._svg.selectAll('.chart-title').remove();
  this._svg.selectAll('.chart-title-color').remove();
  if (!this._levelsTaxonomy) { return; }
  var self = this;
  var titleEntries = this._svg
    .selectAll('.chart-title')
    .data(this._levelsTaxonomy);
  titleEntries
    .enter()
    .append('text')
    .attr('class', 'chart-title')
    .attr('font-weight', 'bold')
    .attr('y', this.margins().top() - 5);
  titleEntries
    .attr('fill', function(label) { return self.colors().getByKey(label); })
    .text(function(label) { return label; });

  var textLength = 0;
  var titleEntriesStartPosition = [];

  $('#' + this.id() + ' .chart-title')
    .each(function(i) {
      titleEntriesStartPosition.push(textLength);
      textLength += this.getBBox().width + 15;
    });

  titleEntries.attr('x', function(column, i) {
    return self.margins().left() + 10 + titleEntriesStartPosition[i];
  });

  var colorEntries = this._svg
    .selectAll('.chart-title-color')
    .data(this._levelsTaxonomy)
    .enter()
    .append('circle')
    .attr('class', 'chart-title-color')
    .attr('cx', function(column, i) { return self.margins().left() + 4 + titleEntriesStartPosition[i]; })
    .attr('cy', self.margins().top() - 9)
    .attr('r', 4)
    .style('shape-rendering', 'auto')
    .style('stroke-width', '0')
    .style('fill', function(label) { return self.colors().getByKey(label); });
};

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.levelsTaxonomy = function() { return this._levelsTaxonomy; };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.selectMode = function() { return this._selectMode; };

/**
 * @param {boolean} mode
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.setSelectMode = function(mode) { this._selectMode = mode; };

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.selectNode = function(node) {
  var selectionType = (node.selectionType + 1) % 3;
  this._selectedNodes[node.id] = selectionType;

  var self = this;

  function setDisplay(nes) {

    nes.selectionType = selectionType;
    self._changeNodeSelection(nes, selectionType);

    if(nes.children.length == 0) {
      return;
    }
    else {
      nes.children.forEach(function(n) {
        setDisplay(n);
      });
    }
  }

  setDisplay(node);

  // this._changeNodeSelection(node, selectionType);

  if (this.autoPropagateChanges()) {
    this.firePropagateHierarchyChanges();
  }

  return selectionType;
};

/**
 * @param {number} level
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.selectLevel = function(level) {
  var self = this;
  var deselectedNodeIds = [];
  var deselectedNodes = [];
  $.each(this._selectedNodes, function(nodeId, selectionType) {
    /** @type {epiviz.ui.charts.tree.UiNode} */
    var node = self._uiDataMap[nodeId];
    if (node != undefined && node.globalDepth == level) {
      deselectedNodeIds.push(nodeId);
      deselectedNodes.push(node);
    }
  });
  deselectedNodeIds.forEach(function(nodeId) { delete self._selectedNodes[nodeId]; });

  var tLevel;

  if (!(level in this._selectedLevels)) {

    var currentLevel = Object.keys(self._selectedLevels)[0]

    self._changeLevelSelection(this._levelsTaxonomy[currentLevel], 1);

      //propogate level selection to nodes
    self._uiData.forEach(function(node) {
      if (node.globalDepth == currentLevel && node.selectionType != 0) {
          self._updateSelectionAttribute(node, 1);
          self._uiDataMap[node.id] == node.selectionType;
      }
    });

    for(var nodeId in  self._oldUiDataMap) {
      var node = self._oldUiDataMap[nodeId];
      if (node.globalDepth == currentLevel && node.selectionType != 0) {
          self._updateSelectionAttribute(node, 1);
          self._oldUiDataMap[nodeId] == 1;
      }
    }

    this._selectedLevels = {};

    tLevel = 2;
    this._selectedLevels[level] = epiviz.ui.charts.tree.NodeSelectionType.NODE;
  } else {
    
    var tLevel = (this._selectedLevels[level] + 1) % 3;

    if (tLevel == 0) {
      tLevel = 1;
    }
    this._selectedLevels[level] = tLevel;
  }

  deselectedNodes.forEach(function(tn) {
    self._changeNodeSelection(tn, tLevel);
  });

  self._changeLevelSelection(self._levelsTaxonomy[level], tLevel);

  //propogate level selection to nodes
  self._uiData.forEach(function(node) {
    if (node.globalDepth == level) {
        node.selectionType = self._selectedLevels[level.toString()];
        self._updateSelectionAttribute(node, node.selectionType);
        self._uiDataMap[node.id] == node.selectionType;
    }
  });

  for(var nodeId in  self._oldUiDataMap) {
      var node = self._oldUiDataMap[nodeId];
      if (node.globalDepth == level) {
        node.selectionType = self._selectedLevels[level.toString()];
          self._updateSelectionAttribute(node, node.selectionType);
          self._oldUiDataMap[nodeId] == node.selectionType;
      }
    }

  if (this.autoPropagateChanges()) {
    this.firePropagateHierarchyChanges();
  }
};

/**
 * @returns {Object.<string, epiviz.ui.charts.tree.NodeSelectionType>}
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.selectedNodes = function() { return this._selectedNodes; };

/**
 * @returns {Object.<string, number>}
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.nodesOrder = function() { return this._nodesOrder; };

/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @param {epiviz.ui.charts.tree.NodeSelectionType} selectionType
 * @private
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype._changeNodeSelection = function(node, selectionType) {
  var selectionClasses = epiviz.ui.charts.tree.HierarchyVisualization.SELECTION_CLASSES;
  var item = this._svg.select('#' + this.id() + '-' + node.id);

  for (var t in selectionClasses) {
    if (!selectionClasses.hasOwnProperty(t)) { continue; }
    item.classed(selectionClasses[t], false);
  }
  item.classed(selectionClasses[selectionType], true);
};

epiviz.ui.charts.tree.HierarchyVisualization.prototype._changeLevelSelection = function(level, selectionType) {
  var selectionClasses = epiviz.ui.charts.tree.HierarchyVisualization.SELECTION_CLASSES;
  var item = this._svg.select('#' + this.id() + '-' + level);

  for (var t in selectionClasses) {
    if (!selectionClasses.hasOwnProperty(t)) { continue; }
    item.classed(selectionClasses[t], false);
  }
  item.classed('custom-select', false);
  item.classed(selectionClasses[selectionType], true);
};

/**
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.firePropagateHierarchyChanges = function() {
  var selectedNodes = this._selectedNodes;
  var nodesOrder = this._nodesOrder;
  var selectedLevels = this._selectedLevels;
  //this._selectedNodes = {};
  //this._nodesOrder = {};
  this.onPropagateHierarchyChanges().notify(new epiviz.ui.charts.VisEventArgs(
    this.id(),
    new epiviz.ui.controls.VisConfigSelection(undefined, undefined, this.datasourceGroup(), this.dataprovider(), undefined, undefined, undefined,
      {selection: selectedNodes, order: nodesOrder, selectedLevels: selectedLevels})));
};

/**
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.fireRequestHierarchy = function() {
  var nodeId = null;
  if (this._lastData && this._lastData.children) {
    if (this._lastData.children.length == 1) {
      nodeId = this._lastData.children[0].id;
    } else {
      nodeId = this._lastData.id;
    }
  }
  this.onRequestHierarchy().notify(new epiviz.ui.charts.VisEventArgs(
    this.id(),
    new epiviz.ui.controls.VisConfigSelection(undefined, undefined, this.datasourceGroup(), this.dataprovider(), undefined, undefined, undefined, nodeId)));
};

/**
 * @param {boolean} val
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype.setAutoPropagateChanges = function(val) {
  epiviz.ui.charts.Visualization.prototype.setAutoPropagateChanges.call(this, val);
  if (val) { this.firePropagateHierarchyChanges(); }
};


/**
 * @param {epiviz.ui.charts.tree.UiNode} node
 * @param {number} selectionType
 */
epiviz.ui.charts.tree.HierarchyVisualization.prototype._updateSelectionAttribute = function(node, selectionType) {

  var self = this;

  function setDisplay(nes, sType) {

    if(nes.selectionType != 0) {
      nes.selectionType = sType;
    }

    self._changeNodeSelection(nes, nes.selectionType);

    if(nes.children.length == 0) {
      return;
    }
    else {
      nes.children.forEach(function(n) {
        setDisplay(n, nes.selectionType);
      });
    }
  }

  setDisplay(node, selectionType);
};

// Input 217
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/2014
 * Time: 12:11 PM
 */

goog.provide('epiviz.ui.charts.decoration.VisualizationDecoration');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @constructor
 */
epiviz.ui.charts.decoration.VisualizationDecoration = function(visualization, otherDecoration, config) {
  /**
   * @type {epiviz.ui.charts.Visualization}
   * @private
   */
  this._visualization = visualization;

  /**
   * @type {epiviz.ui.charts.decoration.VisualizationDecoration}
   * @private
   */
  this._otherDecoration = otherDecoration;

  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;
};

/**
 */
epiviz.ui.charts.decoration.VisualizationDecoration.prototype.decorate = function() {
  if (this._otherDecoration) { this._otherDecoration.decorate(); }
};

/**
 * @returns {epiviz.ui.charts.Visualization}
 */
epiviz.ui.charts.decoration.VisualizationDecoration.prototype.visualization = function() { return this._visualization; };

/**
 * @returns {epiviz.ui.charts.decoration.VisualizationDecoration}
 */
epiviz.ui.charts.decoration.VisualizationDecoration.prototype.otherDecoration = function() { return this._otherDecoration; };

/**
 * @returns {epiviz.Config}
 */
epiviz.ui.charts.decoration.VisualizationDecoration.prototype.config = function() { return this._config; };

// Input 218
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/13/2015
 * Time: 11:22 AM
 */

goog.provide('epiviz.ui.charts.tree.decoration.TogglePropagateSelectionButton');

goog.require('epiviz.ui.charts.decoration.VisualizationDecoration');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @extends {epiviz.ui.charts.decoration.VisualizationDecoration}
 * @constructor
 */
epiviz.ui.charts.tree.decoration.TogglePropagateSelectionButton = function(visualization, otherDecoration) {
  epiviz.ui.charts.decoration.VisualizationDecoration.call(this, visualization, otherDecoration);

  /**
   * @type {boolean}
   * @const
   */
  this.isChartOptionButton = true;

  /**
   * @type {boolean}
   * @private
   */
  this._checked = true;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.tree.decoration.TogglePropagateSelectionButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.VisualizationDecoration.prototype);
epiviz.ui.charts.tree.decoration.TogglePropagateSelectionButton.constructor = epiviz.ui.charts.tree.decoration.TogglePropagateSelectionButton;

/**
 */
epiviz.ui.charts.tree.decoration.TogglePropagateSelectionButton.prototype.decorate = function() {
  epiviz.ui.charts.decoration.VisualizationDecoration.prototype.decorate.call(this);

  var buttonIndex = 0;
  for (var decoration = this.otherDecoration(); decoration; decoration = decoration.otherDecoration()) {
    if (decoration.isChartOptionButton) { ++buttonIndex; }
  }

  var self = this;
  var buttonId = sprintf('%s-propagate-selection-button', this.visualization().id());
  this.visualization().container().append(sprintf(
    '<div id="%1$s-container" style="position: absolute; top: 5px; right: %2$spx">' +
    '<input type="checkbox" id="%1$s" %3$s />' +
    '<label for="%1$s" >Toggle propagate selection</label>' +
    '</div>', buttonId, 5 + buttonIndex * 30, this._checked ? 'checked="checked"' : ''));
  var button = $('#' + buttonId);
  var buttonContainer = $('#' + buttonId + '-container');
  button.button({
    text: false,
    icons:{ primary:'ui-icon ui-icon-refresh' }
  }).click(function() {
    self._checked = button.is(':checked');

    self.visualization().setAutoPropagateChanges(self._checked);
  });

  this.visualization().container()
    .mousemove(function () { buttonContainer.show(); })
    .mouseleave(function () { buttonContainer.hide(); });
};

/**
 * @returns {boolean}
 */
epiviz.ui.charts.tree.decoration.TogglePropagateSelectionButton.prototype.checked = function() { return this._checked; };


// Input 219
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/10/2015
 * Time: 10:19 AM
 */

goog.provide('epiviz.ui.charts.markers.VisualizationMarker');

goog.require('epiviz.utils');
goog.require('epiviz.deferred.Deferred');
goog.require('epiviz.caja.cajole');

/**
 * @param {epiviz.ui.charts.markers.VisualizationMarker.Type} type
 * @param {string} [id]
 * @param {string} [name]
 * @param {string} [preMark]
 * @param {string} [mark]
 * @constructor
 * @template Data, InitialVars, Item, MarkResult
 */
epiviz.ui.charts.markers.VisualizationMarker = function(type, id, name, preMark, mark) {

  /**
   * @type {epiviz.ui.charts.markers.VisualizationMarker.Type}
   * @private
   */
  this._type = type;

  /**
   * @type {string}
   * @protected
   */
  this._id = id || epiviz.utils.generatePseudoGUID(6);

  /**
   * @type {string}
   * @protected
   */
  this._name = name || 'Custom Marker ' + this._id;

  /**
   * @type {string}
   * @private
   */
  this._preMarkStr = preMark || '';

  /**
   * @type {string}
   * @private
   */
  this._markStr = mark || '';

  var deferredPreMark = new epiviz.deferred.Deferred();
  var cajoledPreMark = null;
  epiviz.caja.cajole(this._preMarkStr).done(function(preMarkFunc) {
    cajoledPreMark = preMarkFunc;
    deferredPreMark.resolve();
  });

  /**
   * @type {function(Data): epiviz.deferred.Deferred.<InitialVars>}
   * @private
   */
  this._preMark = function(data) {
    var d = new epiviz.deferred.Deferred();
    deferredPreMark.done(function(){
      var initialVars = cajoledPreMark(data);
      d.resolve(initialVars);
    });
    return d;
  };

  var deferredMark = new epiviz.deferred.Deferred();
  var cajoledMark = null;
  epiviz.caja.cajole(this._markStr).done(function(markFunc) {
    cajoledMark = markFunc;
    deferredMark.resolve();
  });

  /**
   * @type {function(Item, Data, InitialVars): epiviz.deferred.Deferred.<MarkResult>}
   * @private
   */
  this._mark = function(item, data, preMarkResult) {
    var d = new epiviz.deferred.Deferred();
    deferredMark.done(function() {
      var markResult = cajoledMark(item, data, preMarkResult);
      d.resolve(markResult);
    });
    return d;
  };
};

/**
 * @returns {epiviz.ui.charts.markers.VisualizationMarker.Type}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.type = function() { return this._type; };

/**
 * @returns {string}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.id = function() { return this._id; };

/**
 * @returns {string}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.name = function() { return this._name; };

/**
 * @returns {function(Data, function(InitialVars))}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.preMark = function() { return this._preMark; };

/**
 * @returns {function(Item, Data, InitialVars, function(MarkResult))}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.mark = function() { return this._mark; };

/**
 * @returns {string}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.preMarkStr = function() { return this._preMarkStr; };

/**
 * @returns {string}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.markStr = function() { return this._markStr; };

/**
 * @enum {string}
 */
epiviz.ui.charts.markers.VisualizationMarker.Type = {
  FILTER: 'filter',
  COLOR_BY_ROW: 'colorByRow',
  ORDER_BY_MEASUREMENTS: 'orderByMeasurements',
  COLOR_BY_MEASUREMENTS: 'colorByMeasurements',
  GROUP_BY_MEASUREMENTS: 'groupByMeasurements'
};

/**
 * @returns {{type: string, id: string, name: string, preMark: string, mark: string}}
 */
epiviz.ui.charts.markers.VisualizationMarker.prototype.raw = function() {
  return {
    type: this._type,
    id: this._id,
    name: this._name,
    preMark: this._preMarkStr,
    mark: this._markStr
  };
};

/**
 * @param {{type: string, id: string, name: string, preMark: string, mark: string}} o
 * @returns {epiviz.ui.charts.markers.VisualizationMarker}
 */
epiviz.ui.charts.markers.VisualizationMarker.fromRawObject = function(o) {
  return new epiviz.ui.charts.markers.VisualizationMarker(o.type, o.id, o.name, o.preMark, o.mark);
};

// Input 220
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/16/2015
 * Time: 6:58 PM
 */

goog.provide('epiviz.ui.charts.markers.MeasurementAggregator');

/**
 * @param {string} [id]
 * @param {function(string, Array.<epiviz.measurements.Measurement>, Array.<number>): {value: number, errMinus: number=, errPlus: number=}} aggregator
 * @constructor
 */
epiviz.ui.charts.markers.MeasurementAggregator = function(id, aggregator) {
  /**
   * @type {string}
   * @private
   */
  this._id = id;

  /**
   * @type {function(string, Array.<epiviz.measurements.Measurement>, Array.<number>): {value: number, errMinus?: number, errPlus?: number}}
   * @private
   */
  this._aggregator = aggregator;
};

/**
 * @param {string} label
 * @param {Array.<epiviz.measurements.Measurement>} measurements
 * @param {Array.<number>} values
 * @returns {{value: number, errMinus?: number, errPlus?: number}}
 */
epiviz.ui.charts.markers.MeasurementAggregator.prototype.aggregate = function(label, measurements, values) {
  return this._aggregator(label, measurements, values);
};

/**
 * @returns {string}
 */
epiviz.ui.charts.markers.MeasurementAggregator.prototype.id = function() { return this._id; };

/**
 * @type{Object.<string, epiviz.ui.charts.markers.MeasurementAggregator>}
 */
epiviz.ui.charts.markers.MeasurementAggregators = {
  'mean-stdev': new epiviz.ui.charts.markers.MeasurementAggregator('mean-stdev', function(label, measurements, values) {
    if (!values || values.length == 0) { return null; }
    var mean = values.reduce(function(v1, v2) { return v1 + v2; }) / values.length;
    var variance = values
        .map(function(v) { return (v - mean) * (v - mean); })
        .reduce(function(v1, v2) { return v1 + v2; }) / values.length;
    var stdev = Math.sqrt(variance);
    return { value: mean, errMinus: mean - stdev, errPlus: mean + stdev };
  }),

  'quartiles': new epiviz.ui.charts.markers.MeasurementAggregator('quartiles', function(label, measurements, values) {
    if (!values || values.length == 0) { return null; }
    values = values.slice(0).sort(function(v1, v2) { return v1 - v2; });
    var n = values.length;
    var m1 = Math.floor(n * 0.5);
    var m2 = Math.ceil(n * 0.5);
    var q2 = (values[Math.floor((n - 1) * 0.5)] + values[m1]) * 0.5;
    var q1 = (values[Math.floor((m1 - 1) * 0.5)] + values[Math.floor(m1 * 0.5)]) * 0.5;
    var q3 = (values[m2 + Math.floor((n - m2 - 1) * 0.5)] + values[m2 + Math.floor((n - m2) * 0.5)]) * 0.5;

    return { value: q2, errMinus: q1, errPlus: q3 };
  }),

  'count': new epiviz.ui.charts.markers.MeasurementAggregator('count', function(label, measurements, values) {
    if (!values || values.length == 0) { return 0; }
    return { value: values.length };
  }),

  'min': new epiviz.ui.charts.markers.MeasurementAggregator('min', function(label, measurements, values) {
    if (!values || values.length == 0) { return null; }
    return { value: Math.min.apply(undefined, values) };
  }),

  'max': new epiviz.ui.charts.markers.MeasurementAggregator('max', function(label, measurements, values) {
    if (!values || values.length == 0) { return null; }
    return { value: Math.max.apply(undefined, values) };
  }),

  'sum': new epiviz.ui.charts.markers.MeasurementAggregator('sum', function(label, measurements, values) {
    if (!values || values.length == 0) { return null; }
    return { value: values.reduce(function(v1, v2) { return v1 + v2; }) };
  })
};

// Input 221
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/2014
 * Time: 12:31 PM
 */

goog.provide('epiviz.ui.charts.decoration.ChartOptionButton');

goog.require('epiviz.ui.charts.decoration.VisualizationDecoration');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @extends {epiviz.ui.charts.decoration.VisualizationDecoration}
 * @constructor
 */
epiviz.ui.charts.decoration.ChartOptionButton = function(visualization, otherDecoration, config) {
  epiviz.ui.charts.decoration.VisualizationDecoration.call(this, visualization, otherDecoration, config);

  /**
   * @type {boolean}
   */
  this.isChartOptionButton = true;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.ChartOptionButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.VisualizationDecoration.prototype);
epiviz.ui.charts.decoration.ChartOptionButton.constructor = epiviz.ui.charts.decoration.ChartOptionButton;

/**
 */
epiviz.ui.charts.decoration.ChartOptionButton.prototype.decorate = function() {
  epiviz.ui.charts.decoration.VisualizationDecoration.prototype.decorate.call(this);

  if (!this.isChartOptionButton) { return; }

  var buttonIndex = 0;
  for (var decoration = this.otherDecoration(); decoration; decoration = decoration.otherDecoration()) {
    if (decoration.isChartOptionButton) { ++buttonIndex; }
  }

  var button = $(sprintf('<button style="position: absolute; top: 5px; right: %spx">%s</button>',
    5 + buttonIndex * 30,
    this._text()))
    .appendTo(this.visualization().container())
    .button(this._renderOptions())
    .click(this._click());

  this.visualization().container()
    .mousemove(function () { button.show(); })
    .mouseleave(function () { button.hide(); });
};

/**
 * @returns {Function}
 * @protected
 */
epiviz.ui.charts.decoration.ChartOptionButton.prototype._click = function() { return function() {}; };

/**
 * @returns {*} jQuery button render options
 * @protected
 */
epiviz.ui.charts.decoration.ChartOptionButton.prototype._renderOptions = function() { return {}; };

/**
 * @returns {string}
 * @protected
 */
epiviz.ui.charts.decoration.ChartOptionButton.prototype._text = function() { return ''; };

// Input 222
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/16/14
 * Time: 4:22 PM
 */

goog.provide('epiviz.ui.controls.CodeDialog');

goog.require('epiviz.ui.controls.Dialog');

/**
 * @param {string} title
 * @param {{save: function(Object.<string, string>), cancel: function()}} handlers
 * @param {Array.<function(jQuery): epiviz.ui.controls.CodeControl>} controlCreators
 * @constructor
 * @extends {epiviz.ui.controls.Dialog}
 */
epiviz.ui.controls.CodeDialog = function(title, handlers, controlCreators) {
  epiviz.ui.controls.Dialog.call(this, title, handlers);

  /**
   * @type {Array.<function(jQuery): epiviz.ui.controls.CodeControl>}
   * @private
   */
  this._controlCreators = controlCreators;

  this._dialog = $('#' + this._id);

  /**
   * @type {Array.<epiviz.ui.controls.CodeControl>}
   * @private
   */
  this._controls = [];

  var self = this;
  this._dialog.append('<div class="code-tabs"><ul></ul></div>');
  var codeTabs = this._dialog.find('.code-tabs');
  var codeTabsList = codeTabs.find('ul');
  this._controlCreators.forEach(function(creator, i) {
    var id = self._id + '-code-tab-' + i;
    codeTabs.append(sprintf('<div id="%s"></div>', id));
    var tab = codeTabs.find('#' + id);
    var control = creator(tab);

    codeTabsList.append(sprintf('<li><a href="#%s">%s</a></li>', id, control.title()))
    self._controls.push(control);
  });



  codeTabs.tabs({
    activate: function(e, ui) { self._tabActivate(codeTabs); }
  });

  this._dialog.dialog({
    autoOpen: false,
    resizable: false,
    width: '800',
    buttons: {
      Save: function() {
        var results = [];
        self._controls.forEach(function(control) {
          control.save();
          results.push(control.result());
        });
        self._handlers.save(results);
        $(this).dialog('close');
      },
      Cancel: function() {
        self._controls.forEach(function(control) {
          control.revert();
        });
        self._handlers.cancel();
        $(this).dialog('close');
      }
    },
    modal: true
  });

  this._dialog.dialog('option', 'position', 'center');
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.CodeDialog.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Dialog.prototype);
epiviz.ui.controls.CodeDialog.constructor = epiviz.ui.controls.CodeDialog;

/**
 */
epiviz.ui.controls.CodeDialog.prototype.show = function() {
  epiviz.ui.controls.Dialog.prototype.show.call(this);

  this._dialog.dialog('open');

  this._controls[0].initialize();
  this._dialog.dialog('option', 'position', 'center');
};

/**
 * @param tabs
 * @private
 */
epiviz.ui.controls.CodeDialog.prototype._tabActivate = function(tabs) {
  var selectedTabIndex = tabs.tabs('option', 'active');

  this._controls[selectedTabIndex].initialize();
  this._dialog.dialog('option', 'position', 'center');
};

// Input 223
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/6/2015
 * Time: 12:59 PM
 */

goog.provide('epiviz.ui.charts.decoration.CodeButton');

goog.require('epiviz.ui.charts.decoration.ChartOptionButton');
goog.require('epiviz.ui.controls.CodeDialog');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @extends {epiviz.ui.charts.decoration.ChartOptionButton}
 * @constructor
 */
epiviz.ui.charts.decoration.CodeButton = function(visualization, otherDecoration, config) {
  epiviz.ui.charts.decoration.ChartOptionButton.call(this, visualization, otherDecoration, config);

  /**
   * @type {boolean}
   * @const
   */
  this.isCodeButton = true;

  /**
   * @type {Array.<{creator: function(jQuery): epiviz.ui.controls.CodeControl, save: function(*), cancel: function()}>}
   * @private
   */
  this._controlCreators = [];

  var isChartOptionButton = true;
  var lastCodeButtonDecoration;
  for (var decoration = this.otherDecoration(); decoration; decoration = decoration.otherDecoration()) {
    if (decoration.isCodeButton) {
      isChartOptionButton = false;
      lastCodeButtonDecoration = decoration;
    }
  }
  if (lastCodeButtonDecoration) {
    lastCodeButtonDecoration._addControlCreator(this._controlCreator(), this._saveHandler(), this._cancelHandler());
  }
  this.isChartOptionButton = isChartOptionButton;
  if (isChartOptionButton) {
    this._addControlCreator(this._controlCreator(), this._saveHandler(), this._cancelHandler());
  }
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.CodeButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.ChartOptionButton.prototype);
epiviz.ui.charts.decoration.CodeButton.constructor = epiviz.ui.charts.decoration.CodeButton;

/**
 * @returns {Function}
 * @protected
 */
epiviz.ui.charts.decoration.CodeButton.prototype._click = function() {
  var self = this;

  return function() {
    var editCodeDialog = new epiviz.ui.controls.CodeDialog(
      'Chart Code',
      {
        save: function(results) {
          results.forEach(function(result, i) {
            self._controlCreators[i].save(result);
          });
        },
        cancel: function() {
          self._controlCreators.forEach(function(o) { o.cancel(); })
        }
      },
      self._controlCreators.map(function(o) { return o.creator; }));
    editCodeDialog.show();
  };
};

/**
 * @returns {*} jQuery button render options
 * @protected
 */
epiviz.ui.charts.decoration.CodeButton.prototype._renderOptions = function() {
  return {
    icons:{ primary:'ui-icon ui-icon-pencil' },
    text:false
  };
};

/**
 * @returns {string}
 * @protected
 */
epiviz.ui.charts.decoration.CodeButton.prototype._text = function() { return 'Code'; };

/**
 * @param {function(jQuery): epiviz.ui.controls.CodeControl} creator
 * @param {function(*)} [saveHandler]
 * @param {function()} [cancelHandler]
 * @protected
 */
epiviz.ui.charts.decoration.CodeButton.prototype._addControlCreator = function(creator, saveHandler, cancelHandler) {
  this._controlCreators.push({creator: creator, save: saveHandler, cancel: cancelHandler});
};

/**
 * @returns {function(jQuery): epiviz.ui.controls.CodeControl}
 * @protected
 */
epiviz.ui.charts.decoration.CodeButton.prototype._controlCreator = function() { return null; };

/**
 * @returns {function(*)}
 * @private
 */
epiviz.ui.charts.decoration.CodeButton.prototype._saveHandler = function() { return null; };

/**
 * @returns {function()}
 * @private
 */
epiviz.ui.charts.decoration.CodeButton.prototype._cancelHandler = function() { return null; };

//goog.inherits(epiviz.ui.charts.decoration.CodeButton, epiviz.ui.charts.decoration.ChartOptionButton);
// Input 224
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/6/2015
 * Time: 1:50 PM
 */

goog.provide('epiviz.ui.controls.CodeControl');

goog.require('epiviz.ui.controls.Control');

/**
 * @param {jQuery} container
 * @param {string} [title]
 * @param {string} [id]
 * @param {Object} [targetObject]
 * @constructor
 * @extends {epiviz.ui.controls.Control}
 */
epiviz.ui.controls.CodeControl = function(container, title, id, targetObject) {
  // Call superclass constructor
  epiviz.ui.controls.Control.call(this, container, title, id);

  /**
   * @type {Object}
   * @protected
   */
  this._targetObj = targetObject;

  /**
   * @type {string}
   * @protected
   */
  this._text = '// TODO: Your code here\n';
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.CodeControl.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Control.prototype);
epiviz.ui.controls.CodeControl.constructor = epiviz.ui.controls.CodeControl;

epiviz.ui.controls.CodeControl.prototype.initialize = function() {};

/**
 */
epiviz.ui.controls.CodeControl.prototype.save = function() {};

/**
 */
epiviz.ui.controls.CodeControl.prototype.revert = function() {};

/**
 * @returns {string}
 */
epiviz.ui.controls.CodeControl.prototype.text = function() { return this._text; };

/**
 * @returns {*}
 */
epiviz.ui.controls.CodeControl.prototype.result = function() { return null; };

// Input 225
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/7/2015
 * Time: 2:01 PM
 */

goog.provide('epiviz.ui.controls.MarkerCodeControl');

goog.require('epiviz.ui.controls.CodeControl');

/**
 * @param {jQuery} container
 * @param {string} [title]
 * @param {string} [id]
 * @param {Object} [targetObject]
 * @param {string} [preFilterText]
 * @param {string} [filterText]
 * @param {boolean} [enabled]
 * @constructor
 * @extends {epiviz.ui.controls.CodeControl}
 */
epiviz.ui.controls.MarkerCodeControl = function(container, title, id, targetObject, preFilterText, filterText, enabled) {
  // Call superclass constructor
  epiviz.ui.controls.CodeControl.call(this, container, title, id, targetObject);

  /**
   * @type {CodeMirror}
   * @private
   */
  this._editor = null;

  /**
   * @type {CodeMirror}
   * @private
   */
  this._markEditor = null;

  /**
   * @type {string}
   * @private
   */
  this._editorText = preFilterText;

  /**
   * @type {string}
   * @private
   */
  this._markText = filterText;

  /**
   * @type {boolean}
   * @private
   */
  this._enabled = enabled || false;
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.MarkerCodeControl.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.CodeControl.prototype);
epiviz.ui.controls.MarkerCodeControl.constructor = epiviz.ui.controls.MarkerCodeControl;

epiviz.ui.controls.MarkerCodeControl.prototype.initialize = function() {
  if (this._editor) { return; }

  this._container.append(
    sprintf(
      '<div id="%1$s">' +
      '<label for="%1$s-true">On</label>' +
      '<input type="radio" id="%1$s-true" name="%1$s" %2$s />' +
      '<label for="%1$s-false">Off</label>' +
      '<input type="radio" id="%1$s-false" name="%1$s" %3$s />' +
      '</div>', this.id() + '-switch', this._enabled ? 'checked="checked"' : '',
      this._enabled ? '' : 'checked="checked"') +
    '<br />' +
    '<div><label><b>Pre-mark Method</b></label></div><br />' +
    '<div style="overflow-y: scroll; max-height: 250px;">' +
      '<textarea autofocus="autofocus" class="pre-filter-code"></textarea>' +
    '</div><br/>' +
    '<div><label><b>Mark Method</b></label></div><br/>' +
    '<div style="overflow-y: scroll; max-height: 250px;">' +
      '<textarea autofocus="autofocus" class="filter-code"></textarea>' +
    '</div>');

  var onOffSwitch = this._container.find('#' + this.id() + '-switch');
  onOffSwitch.buttonset();
  var self = this;
  var optionChange = function(e) {
    var optionChecked = $('#' + self.id() + '-switch :radio:checked').attr('id');
    var newValue = optionChecked.substr(optionChecked.lastIndexOf('-')+1) == 'true';
    if (self._editor) { self._editor.setOption('disableInput', !newValue); }
    if (self._markEditor) { self._markEditor.setOption('disableInput', !newValue);}
    self._enabled = newValue;
  };
  onOffSwitch.find('#' + this.id() + '-switch-true').on('change', optionChange);
  onOffSwitch.find('#' + this.id() + '-switch-false').on('change', optionChange);

  var preFilterCodeEditor = this._container.find('.pre-filter-code');
  preFilterCodeEditor.val(this._editorText);

  var filterCodeEditor = this._container.find('.filter-code');
  filterCodeEditor.val(this._markText);

  this._editor = CodeMirror.fromTextArea(preFilterCodeEditor[0], {
    lineNumbers: true,
    matchBrackets: true,
    continueComments: "Enter",
    extraKeys: {"Ctrl-Q": "toggleComment"},
    autofocus: true
  });
  this._editor.setOption('disableInput', !this._enabled);

  this._markEditor = CodeMirror.fromTextArea(filterCodeEditor[0], {
    lineNumbers: true,
    matchBrackets: true,
    continueComments: "Enter",
    extraKeys: {"Ctrl-Q": "toggleComment"},
    autofocus: true
  });
  this._markEditor.setOption('disableInput', !this._enabled);
};

/**
 */
epiviz.ui.controls.MarkerCodeControl.prototype.save = function() {
  if (!this._editor) { return; }
  this._editorText = this._editor.getValue();
  this._markText = this._markEditor.getValue();
};

/**
 */
epiviz.ui.controls.MarkerCodeControl.prototype.revert = function() {
  if (this._editor) {
    this._editor.setOption('value', this._editorText);
  }

  if (this._markEditor) {
    this._markEditor.setOption('value', this._markText);
  }
};

/**
 * @returns {{enabled: boolean, preMark: string, mark: string}}
 */
epiviz.ui.controls.MarkerCodeControl.prototype.result = function() {
  return {
    enabled: this._enabled,
    preMark: this._enabled ? this._editorText : null,
    mark: this._enabled ? this._markText : null
  }
};


// Input 226
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/7/2015
 * Time: 2:00 PM
 */

goog.provide('epiviz.ui.charts.decoration.MarkerCodeButton');

goog.require('epiviz.ui.charts.decoration.CodeButton');
goog.require('epiviz.ui.controls.MarkerCodeControl');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @extends {epiviz.ui.charts.decoration.CodeButton}
 * @constructor
 */
epiviz.ui.charts.decoration.MarkerCodeButton = function(visualization, otherDecoration, config) {
  epiviz.ui.charts.decoration.CodeButton.call(this, visualization, otherDecoration, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.CodeButton.prototype);
epiviz.ui.charts.decoration.MarkerCodeButton.constructor = epiviz.ui.charts.decoration.MarkerCodeButton;

/**
 * @returns {function(jQuery): epiviz.ui.controls.CodeControl}
 * @private
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype._controlCreator = function() {
  var self = this;
  return function(container) {
    var existingMark = self.visualization().getMarker(self.markerId());
    var preMark, mark;
    if (existingMark) {
      preMark = existingMark.preMarkStr();
      mark = existingMark.markStr();
    }

    preMark = preMark || self.preMarkTemplate();
    mark = mark || self.markTemplate();

    return new epiviz.ui.controls.MarkerCodeControl(container, self.markerLabel(), null, self.visualization(), preMark, mark, existingMark != undefined);
  };
};

/**
 * @returns {function(*)}
 * @private
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype._saveHandler = function() {
  var self = this;
  return function(arg) {
    if (arg.enabled) {
      self.visualization().putMarker(self.createMarker(arg.preMark, arg.mark));
    } else {
      self.visualization().removeMarker(self.markerId());
    }
  };
};

/**
 * @returns {function()}
 * @private
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype._cancelHandler = function() { return function() {}; };

/**
 * @param {string} [preMark]
 * @param {string} [mark]
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype.createMarker = function(preMark, mark) {
  return new epiviz.ui.charts.markers.VisualizationMarker(
    this.markerType(),
    this.markerId(),
    this.markerLabel(),
    preMark,
    mark);
};

/**
 * @returns {epiviz.ui.charts.markers.VisualizationMarker.Type}
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype.markerType = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype.markerLabel = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype.markerId = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype.preMarkTemplate = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype.markTemplate = function() { throw Error('unimplemented abstract method'); };

// Input 227
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/10/2015
 * Time: 11:04 AM
 */

goog.provide('epiviz.ui.charts.decoration.HierarchyFilterCodeButton');

goog.require('epiviz.ui.charts.decoration.MarkerCodeButton');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @extends {epiviz.ui.charts.decoration.CodeButton}
 * @constructor
 */
epiviz.ui.charts.decoration.HierarchyFilterCodeButton = function(visualization, otherDecoration, config) {
  epiviz.ui.charts.decoration.MarkerCodeButton.call(this, visualization, otherDecoration, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.HierarchyFilterCodeButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.MarkerCodeButton.prototype);
epiviz.ui.charts.decoration.HierarchyFilterCodeButton.constructor = epiviz.ui.charts.decoration.HierarchyFilterCodeButton;

/**
 * @returns {epiviz.ui.charts.markers.VisualizationMarker.Type}
 */
epiviz.ui.charts.decoration.HierarchyFilterCodeButton.prototype.markerType = function() { return epiviz.ui.charts.markers.VisualizationMarker.Type.FILTER; };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.HierarchyFilterCodeButton.prototype.markerLabel = function() { return 'User Filter' };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.HierarchyFilterCodeButton.prototype.markerId = function() { return 'user-filter'; };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.HierarchyFilterCodeButton.prototype.preMarkTemplate = function() {
  return '/**\n' +
  ' * This method is called once before every draw, for all data available to the visualization,\n' +
  ' * for initialization. Its result can be used inside the filter method.\n' +
  ' * @param {epiviz.ui.charts.tree.Node} [root]\n' +
  ' * @returns {InitialVars}\n' +
  ' * @template InitialVars\n' +
  ' */\n' +
  'function(root) {\n' +
  '  // TODO: Your code here\n' +
  '  return null;\n' +
  '}\n';
};

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.HierarchyFilterCodeButton.prototype.markTemplate = function() {
  return '/**\n' +
  ' * This method is called for every data object. If it returns false, the object will not be drawn.\n' +
  ' * @param {epiviz.ui.charts.tree.Node} [node]\n' +
  ' * @param {epiviz.ui.charts.tree.Node} [root]\n' +
  ' * @param {InitialVars} [preMarkResult]\n' +
  ' * @returns {boolean}\n' +
  ' * @template InitialVars\n' +
  ' */\n' +
  'function(node, root, preMarkResult) {\n' +
  '  // TODO: Your code here\n' +
  '  return true;\n' +
  '}\n'
};


// goog.inherits(epiviz.ui.charts.decoration.HierarchyFilterCodeButton, epiviz.ui.charts.decoration.MarkerCodeButton);
// Input 228
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/2014
 * Time: 12:24 PM
 */

goog.provide('epiviz.ui.charts.decoration.RemoveChartButton');

goog.require('epiviz.ui.charts.decoration.ChartOptionButton');
goog.require('epiviz.ui.charts.VisEventArgs');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @extends {epiviz.ui.charts.decoration.ChartOptionButton}
 * @constructor
 */
epiviz.ui.charts.decoration.RemoveChartButton = function(visualization, otherDecoration) {
  epiviz.ui.charts.decoration.ChartOptionButton.call(this, visualization, otherDecoration);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.RemoveChartButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.ChartOptionButton.prototype);
epiviz.ui.charts.decoration.RemoveChartButton.constructor = epiviz.ui.charts.decoration.RemoveChartButton;

/**
 * @returns {Function}
 * @protected
 */
epiviz.ui.charts.decoration.RemoveChartButton.prototype._click = function() {
  var self = this;
  return function(){
    self.visualization().onRemove().notify(new epiviz.ui.charts.VisEventArgs(self.visualization().id()));
  };
};

/**
 * @returns {*} jQuery button render options
 * @protected
 */
epiviz.ui.charts.decoration.RemoveChartButton.prototype._renderOptions = function() {
  return {
    icons:{ primary:'ui-icon ui-icon-cancel' },
    text:false
  };
};

/**
 * @returns {string}
 * @protected
 */
epiviz.ui.charts.decoration.RemoveChartButton.prototype._text = function() { return 'Remove'; };

// Input 229
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/17/14
 * Time: 12:15 PM
 */

goog.provide('epiviz.ui.controls.ColorPickerDialog');

goog.require('epiviz.ui.controls.Dialog');
goog.require('epiviz.ui.charts.ColorPalette');

/**
 * @param {{ok: function(epiviz.ui.charts.ColorPalette), cancel: function(), reset: function()}} handlers
 * @param {Array.<string>} names A list of measurement names
 * @param {Array.<epiviz.ui.charts.ColorPalette>} palettes
 * @param {epiviz.ui.charts.ColorPalette} selectedPalette
 * @constructor
 * @extends {epiviz.ui.controls.Dialog}
 */
epiviz.ui.controls.ColorPickerDialog = function(handlers, names, palettes, selectedPalette) {
  epiviz.ui.controls.Dialog.call(this, 'Pick Colors', handlers);

  this._dialog = $('#' + this._id);

  this._dialog.append(
    '<div class="color-picker-form" action="" style="width: 420px;">' +
      '<div class="chart-picker" style="float: right;"></div>' +
    '</div>');

  var colorPickerForm = this._dialog.find('.color-picker-form');
  var tableContent = '';
  for (var i = 0; i < names.length; ++i) {
    var inputClass = sprintf('color-%s', i);
    tableContent += sprintf(
      '<tr>' +
        '<td><label>%s:&nbsp;</label></td>' +
        '<td><input type="text" name="%s" class="colorwell %s" value="%s" /></td>' +
      '</tr>',
      names[i], inputClass, inputClass,
      selectedPalette.keyColorIndex(names[i]) >= 0 ?
        selectedPalette.getByKey(names[i]) : selectedPalette.get(i)
    );
  }
  colorPickerForm.append(sprintf('<table class="color-picker-table">%s</table>', tableContent));

  var f = $.farbtastic(sprintf('#%s .chart-picker', this._id));
  var p = $(sprintf('#%s .chart-picker', this._id)).css('opacity', 0.25);
  var selected;
  $(sprintf('#%s .colorwell', this._id))
    .each(function () { f.linkTo(this); $(this).css('opacity', 0.75); })
    .focus(function() {
      if (selected) {
        $(selected).css('opacity', 0.75).removeClass('colorwell-selected');
      }
      f.linkTo(this);
      p.css('opacity', 1);
      $(selected = this).css('opacity', 1).addClass('colorwell-selected');
    });

  colorPickerForm.append('<select class="palettes-selector"></select>');
  var palettesSelector = colorPickerForm.find('.palettes-selector');
  var palettesMap = {};
  if (palettes) {
    palettes.forEach(function(palette) {
      palettesSelector.append(sprintf('<option value="%s"%s>%s</option>',
        palette.id(), palette.id() == selectedPalette.id() ? ' selected="selected"' : '', palette.name()));
      palettesMap[palette.id()] = palette;
    });
  }
  if (!(selectedPalette.id() in palettesMap)) {
    palettesSelector.prepend(sprintf('<option value="%s" selected="selected">%s</option>',
      selectedPalette.id(), selectedPalette.name()));
    palettesMap[selectedPalette.id()] = selectedPalette;
  }
  palettesSelector.selectmenu({
    style: 'popup',
    width: '200',
    maxHeight: '150',
    menuWidth: '200'
  });

  var updateColorFields = function() {
    var inputs = colorPickerForm.find('.colorwell');
    for (var i = 0; i < inputs.length; ++i) {
      var input = inputs[i];

      // First, connect farbtastic to this input
      f.linkTo($(input));

      // Use farbtastic to modify this input
      f.setColor(selectedPalette.get(i));
    }

    // Reconnect farbtastic to the selected input
    // so that it receives focus once again
    if (selected) {f.linkTo(selected); }
  };

  palettesSelector.change(function() {
    selectedPalette = palettesMap[$(this).val()];
    updateColorFields();
  });

  var self = this;

  this._dialog.dialog({
    autoOpen: false,
    resizable: false,
    width: '440',
    buttons: {
      Ok: function() {
        var inputs = colorPickerForm.find('.colorwell');

        var paletteChanged = false;
        var colors = [];

        var i;
        for (i = 0; i < selectedPalette.size(); ++i) {
          colors.push(selectedPalette.get(i));
        }

        for (i = 0; i < inputs.length; ++i) {
          var userVal = inputs[i].value;
          var index = selectedPalette.keyColorIndex(names[i]);
          if (index < 0) { index = i; }

          if (userVal != colors[index]) {
            paletteChanged = true;
            colors[index] = userVal;
          }
        }

        if (paletteChanged) { selectedPalette = new epiviz.ui.charts.ColorPalette(colors, undefined, undefined, selectedPalette.keyIndices()); }
        self._handlers.ok(selectedPalette);

        $(this).dialog('close');
      },
      Cancel: function() {
        self._handlers.cancel();
        $(this).dialog('close');
      },
      Reset: function() {
        updateColorFields();

        self._handlers.reset();
      }
    },
    modal: true
  });
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.ColorPickerDialog.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Dialog.prototype);
epiviz.ui.controls.ColorPickerDialog.constructor = epiviz.ui.controls.ColorPickerDialog;

/**
 */
epiviz.ui.controls.ColorPickerDialog.prototype.show = function() {
  epiviz.ui.controls.Dialog.prototype.show.call(this);

  var self = this;
  if (this._dialog) {
    this._dialog.dialog('open');

    this._dialog.dialog('option', 'position', 'center');

    // This makes the dialog only able to open once:
    this._dialog.dialog({
      close: function(event, ui) {
        $(this).remove();
        self._dialog = null;
      }
    });
  }
};

// Input 230
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/2014
 * Time: 12:24 PM
 */

goog.provide('epiviz.ui.charts.decoration.ChartColorsButton');

goog.require('epiviz.ui.charts.decoration.ChartOptionButton');
goog.require('epiviz.ui.controls.ColorPickerDialog');


/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @extends {epiviz.ui.charts.decoration.ChartOptionButton}
 * @constructor
 */
epiviz.ui.charts.decoration.ChartColorsButton = function(visualization, otherDecoration, config) {
  epiviz.ui.charts.decoration.ChartOptionButton.call(this, visualization, otherDecoration, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.ChartColorsButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.ChartOptionButton.prototype);
epiviz.ui.charts.decoration.ChartColorsButton.constructor = epiviz.ui.charts.decoration.ChartColorsButton;

/**
 * @returns {Function}
 * @protected
 */
epiviz.ui.charts.decoration.ChartColorsButton.prototype._click = function() {
  var self = this;
  return function(){
    var labels = self.visualization().colorLabels();
    var colorPickerDialog = new epiviz.ui.controls.ColorPickerDialog(
      {
        ok: function(colors) {
          self.visualization().setColors(colors);
        },
        cancel: function() {},
        reset: function() {}
      },
      labels,
      self.config().colorPalettes,
      self.visualization().colors());
    colorPickerDialog.show();
  };
};

/**
 * @returns {*} jQuery button render options
 * @protected
 */
epiviz.ui.charts.decoration.ChartColorsButton.prototype._renderOptions = function() {
  return {
    icons:{ primary:'ui-icon ui-icon-colorpicker' },
    text:false
  };
};

/**
 * @returns {string}
 * @protected
 */
epiviz.ui.charts.decoration.ChartColorsButton.prototype._text = function() { return 'Colors'; };


// goog.inherits(epiviz.ui.charts.decoration.ChartColorsButton, epiviz.ui.charts.decoration.ChartOptionButton);

// Input 231
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/2014
 * Time: 12:31 PM
 */

goog.provide('epiviz.ui.charts.decoration.ChartResize');

goog.require('epiviz.ui.charts.decoration.VisualizationDecoration');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @extends {epiviz.ui.charts.decoration.VisualizationDecoration}
 * @constructor
 */
epiviz.ui.charts.decoration.ChartResize = function(visualization, otherDecoration) {
  epiviz.ui.charts.decoration.VisualizationDecoration.call(this, visualization, otherDecoration);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.ChartResize.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.VisualizationDecoration.prototype);
epiviz.ui.charts.decoration.ChartResize.constructor = epiviz.ui.charts.decoration.ChartResize;

/**
 */
epiviz.ui.charts.decoration.ChartResize.prototype.decorate = function() {
  epiviz.ui.charts.decoration.VisualizationDecoration.prototype.decorate.call(this);

  var self = this;
  var resizeHandler = function(event, ui) { self.visualization().updateSize(); };
  this.visualization().container().resizable({
    //resize: resizeHandler,
    stop: resizeHandler
  });
};

// Input 232
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/2014
 * Time: 12:24 PM
 */

goog.provide('epiviz.ui.charts.decoration.ToggleTooltipButton');

goog.require('epiviz.ui.charts.decoration.VisualizationDecoration');


/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @extends {epiviz.ui.charts.decoration.VisualizationDecoration}
 * @constructor
 */
epiviz.ui.charts.decoration.ToggleTooltipButton = function(visualization, otherDecoration) {
  epiviz.ui.charts.decoration.VisualizationDecoration.call(this, visualization, otherDecoration);

  /**
   * @type {boolean}
   * @const
   */
  this.isChartOptionButton = true;

  /**
   * @type {boolean}
   * @private
   */
  this._checked = false;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.ToggleTooltipButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.VisualizationDecoration.prototype);
epiviz.ui.charts.decoration.ToggleTooltipButton.constructor = epiviz.ui.charts.decoration.ToggleTooltipButton;

/**
 */
epiviz.ui.charts.decoration.ToggleTooltipButton.prototype.decorate = function() {
  epiviz.ui.charts.decoration.VisualizationDecoration.prototype.decorate.call(this);

  var buttonIndex = 0;
  for (var decoration = this.otherDecoration(); decoration; decoration = decoration.otherDecoration()) {
    if (decoration.isChartOptionButton) { ++buttonIndex; }
  }

  var self = this;
  var tooltipButtonId = sprintf('%s-tooltip-button', this.visualization().id());
  this.visualization().container().append(sprintf(
    '<div id="%1$s-container" style="position: absolute; top: 5px; right: %2$spx">' +
    '<input type="checkbox" id="%1$s" %3$s />' +
    '<label for="%1$s" >Toggle tooltip</label>' +
    '</div>', tooltipButtonId, 5 + buttonIndex * 30, this._checked ? 'checked="checked"' : ''));
  var button = $('#' + tooltipButtonId);
  var tooltipButtonContainer = $('#' + tooltipButtonId + '-container');
  button.button({
    text: false,
    icons: {
      primary: 'ui-icon-comment'
    }
  }).click(function() {
    self._checked = button.is(':checked');
  });

  this.visualization().container()
    .mousemove(function () { tooltipButtonContainer.show(); })
    .mouseleave(function () { tooltipButtonContainer.hide(); });
};

/**
 * @returns {boolean}
 */
epiviz.ui.charts.decoration.ToggleTooltipButton.prototype.checked = function() { return this._checked; };

// Input 233
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/2014
 * Time: 12:31 PM
 */

goog.provide('epiviz.ui.charts.decoration.ChartTooltip');

goog.require('epiviz.ui.charts.decoration.VisualizationDecoration');
goog.require('epiviz.ui.charts.decoration.ToggleTooltipButton');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @extends {epiviz.ui.charts.decoration.VisualizationDecoration}
 * @constructor
 */
epiviz.ui.charts.decoration.ChartTooltip = function(visualization, otherDecoration) {
  epiviz.ui.charts.decoration.VisualizationDecoration.call(this, visualization, otherDecoration);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.ChartTooltip.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.VisualizationDecoration.prototype);
epiviz.ui.charts.decoration.ChartTooltip.constructor = epiviz.ui.charts.decoration.ChartTooltip;

/**
 */
epiviz.ui.charts.decoration.ChartTooltip.prototype.decorate = function() {
  epiviz.ui.charts.decoration.VisualizationDecoration.prototype.decorate.call(this);

  /** @type {epiviz.ui.charts.decoration.ToggleTooltipButton} */
  var tooltipButtonDecoration = undefined;
  for (var decoration = this.otherDecoration(); decoration; decoration = decoration.otherDecoration()) {
    if (decoration.constructor == epiviz.ui.charts.decoration.ToggleTooltipButton) {
      tooltipButtonDecoration = decoration;
      break;
    }
  }

  var self = this;
  this.visualization().container().tooltip({
    items: '.item',
    content:function () {
      if (!tooltipButtonDecoration.checked()) { return false; }

      /** @type {epiviz.ui.charts.ChartObject} */
      var item = d3.select(this).data()[0];
      if (item.valueItems[0].length > item.measurements.length + item.measurements[0].metadata().length) {
        return self._horizontalContent(item);
      } else {
        return self._verticalContent(item);
      }
    },
    track: true,
    show: false
    // TODO: Use a better tooltip
    /*,
    position: {
      my: 'left+10 bottom-10',
      of: event,
      collision: 'fit'
    }*/
  });
};

/**
 * @param {epiviz.ui.charts.ChartObject} item
 * @returns {*}
 * @private
 */
epiviz.ui.charts.decoration.ChartTooltip.prototype._horizontalContent = function(item) {
  var maxMetadataValueLength = 15;

  var metadataCols = item.measurements[0].metadata();
  var colsHeader = sprintf('%s%s%s',
    (item.start != undefined && item.end != undefined) ? '<th><b>Start</b></th><th><b>End</b></th>' : '',
    metadataCols ? '<th><b>' + metadataCols.join('</b></th><th><b>') + '</b></th>' : '',
    item.values ? '<th><b>' + item.measurements.join('</b></th><th><b>') + '</b></th>': '');

  var rows = '';
  for (var j = 0; j < item.valueItems[0].length && j < 10; ++j) {
    var row = '';
    var rowItem = item.valueItems[0][j].rowItem;
    var start = Globalize.format(rowItem.start(), 'n0');
    var end = Globalize.format(rowItem.end(), 'n0');
    if (start != undefined && end != undefined) {
      row += sprintf('<td>%s</td><td>%s</td>', start, end);
    }
    var rowMetadata = rowItem.rowMetadata();
    if (metadataCols && rowMetadata) {
      for (var k = 0; k < metadataCols.length; ++k) {
        var metadataCol = metadataCols[k];
        var metadataValue = rowMetadata[metadataCol] || '';
        row += sprintf('<td>%s</td>', metadataValue.length <= maxMetadataValueLength ? metadataValue : metadataValue.substr(0, maxMetadataValueLength) + '...');
      }
    }

    if (item.values) {
      for (var i = 0; i < item.measurements.length; ++i) {
        row += sprintf('<td>%s</td>', Globalize.format(item.valueItems[i][j].value, 'n3'));
      }
    }

    rows += sprintf('<tr>%s</tr>', row);
  }
  if (j < item.valueItems[0].length) {
    var colspan = 2 + (metadataCols ? metadataCols.length : 0) + (item.values ? item.measurements.length : 0);
    rows += sprintf('<tr><td colspan="%s" style="text-align: center;">...</td></tr>', colspan)
  }

  return sprintf('<table class="tooltip-table"><thead><tr>%s</tr></thead><tbody>%s</tbody></table>', colsHeader, rows);
};

/**
 * @param {epiviz.ui.charts.ChartObject} item
 * @returns {*}
 * @private
 */
epiviz.ui.charts.decoration.ChartTooltip.prototype._verticalContent = function(item) {
  var maxMetadataValueLength = 15;
  var maxRows = 10;
  var maxCols = 6;
  var condensedMetadata = 4;
  var condensedValues = 5;

  var table = [];
  var coordinates = [0, 0];
  if (item.start != undefined && item.end != undefined) {
    var start = ['Start'];
    var end = ['End'];
    item.valueItems[0].every(function(valueItem, j) {
      start.push(Globalize.format(valueItem.rowItem.start(), 'n0'));
      end.push(Globalize.format(valueItem.rowItem.end(), 'n0'));
      return j < (maxCols - 1);
    });
    table.push(start);
    table.push(end);
    coordinates = [0, 2];
  }

  var metadataCols = item.measurements[0].metadata();
  var metadata = [coordinates[1], coordinates[1] + metadataCols.length];
  metadataCols.forEach(function(metadata) {
    var row = [metadata];
    item.valueItems[0].every(function(valueItem, j) {
      var metadataVal = valueItem.rowItem.metadata(metadata) || '[NA]';
      if (metadataVal.length > maxMetadataValueLength) {
        metadataVal = metadataVal.substr(0, maxMetadataValueLength) + '...';
      }
      row.push(metadataVal);
      return j < (maxCols - 1);
    });
    table.push(row);
  });

  var values = [metadata[1], metadata[1]];
  if (item.values) {
    values = [metadata[1], metadata[1] + item.measurements.length];
    item.measurements.forEach(function(m, i) {
      var row = [m.name()];
      item.valueItems[i].every(function(valueItem, j) {
        row.push(Globalize.format(valueItem.value, 'n3'));
        return j < (maxCols - 1);
      });
      table.push(row);
    });
  }

  var nRows = values[1];
  if (nRows > maxRows) {
    coordinates[1] = 1;
    metadata[1] = Math.min(metadata[1], metadata[0] + condensedMetadata);
    nRows = coordinates[1] - coordinates[0] + metadata[1] - metadata[0] + values[1] - values[0];
    if (nRows > maxRows) {
      values[1] -= (nRows - maxRows);
    }
  }

  var ret = '', i;
  for (i = coordinates[0]; i < coordinates[1]; ++i) {
    ret += '<tr><td><b>' + table[i][0] + '</b></td><td>' + table[i].slice(1).join('</td><td>') + '</td></tr>';
  }
  for (i = metadata[0]; i < metadata[1]; ++i) {
    ret += '<tr><td><b>' + table[i][0] + '</b></td><td>' + table[i].slice(1).join('</td><td>') + '</td></tr>';
  }
  for (i = values[0]; i < values[1]; ++i) {
    ret += '<tr><td><b>' + table[i][0] + '</b></td><td>' + table[i].slice(1).join('</td><td>') + '</td></tr>';
  }
  return '<table class="tooltip-table"><tbody>' + ret + '</tbody></table>';
};

// Input 234
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/10/2015
 * Time: 11:00 AM
 */

goog.provide('epiviz.ui.charts.decoration.ChartColorByRowCodeButton');

goog.require('epiviz.ui.charts.decoration.MarkerCodeButton');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @extends {epiviz.ui.charts.decoration.CodeButton}
 * @constructor
 */
epiviz.ui.charts.decoration.ChartColorByRowCodeButton = function(visualization, otherDecoration, config) {
  epiviz.ui.charts.decoration.MarkerCodeButton.call(this, visualization, otherDecoration, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.ChartColorByRowCodeButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.MarkerCodeButton.prototype);
epiviz.ui.charts.decoration.ChartColorByRowCodeButton.constructor = epiviz.ui.charts.decoration.ChartColorByRowCodeButton;

/**
 * @returns {epiviz.ui.charts.markers.VisualizationMarker.Type}
 */
epiviz.ui.charts.decoration.ChartColorByRowCodeButton.prototype.markerType = function() { return epiviz.ui.charts.markers.VisualizationMarker.Type.COLOR_BY_ROW; };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartColorByRowCodeButton.prototype.markerLabel = function() { return 'Color By' };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartColorByRowCodeButton.prototype.markerId = function() { return 'color-by'; };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartColorByRowCodeButton.prototype.preMarkTemplate = function() {
  return '/**\n' +
  ' * This method is called once before every draw, for all data available to the visualization,\n' +
  ' * for initialization. Its result can be used inside the filter method.\n' +
  ' * @param {epiviz.datatypes.GenomicData} [data]\n' +
  ' * @returns {InitialVars}\n' +
  ' * @template InitialVars\n' +
  ' */\n' +
  'function(data) {\n' +
  '  // TODO: Your code here\n' +
  '  return null;\n' +
  '}\n';
};

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartColorByRowCodeButton.prototype.markTemplate = function() {
  return '/**\n' +
  ' * This method is called for every data object. If it returns false, the object will not be drawn.\n' +
  ' * @param {epiviz.datatypes.GenomicData.RowItem} [row]\n' +
  ' * @param {epiviz.datatypes.GenomicData} [data]\n' +
  ' * @param {InitialVars} [preMarkResult]\n' +
  ' * @returns {string}\n' +
  ' * @template InitialVars\n' +
  ' */\n' +
  'function(row, data, preMarkResult) {\n' +
  '  // TODO: Your code here\n' +
  '  return row.metadata(\'colLabel\');\n' +
  '}\n'
};

// goog.inherits(epiviz.ui.charts.decoration.ChartColorByRowCodeButton, epiviz.ui.charts.decoration.MarkerCodeButton);
// Input 235
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/2014
 * Time: 12:24 PM
 */

goog.provide('epiviz.ui.charts.decoration.ToggleTooltipButton');

goog.require('epiviz.ui.charts.decoration.VisualizationDecoration');


/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @extends {epiviz.ui.charts.decoration.VisualizationDecoration}
 * @constructor
 */
epiviz.ui.charts.decoration.ToggleTooltipButton = function(visualization, otherDecoration) {
  epiviz.ui.charts.decoration.VisualizationDecoration.call(this, visualization, otherDecoration);

  /**
   * @type {boolean}
   * @const
   */
  this.isChartOptionButton = true;

  /**
   * @type {boolean}
   * @private
   */
  this._checked = false;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.ToggleTooltipButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.VisualizationDecoration.prototype);
epiviz.ui.charts.decoration.ToggleTooltipButton.constructor = epiviz.ui.charts.decoration.ToggleTooltipButton;

/**
 */
epiviz.ui.charts.decoration.ToggleTooltipButton.prototype.decorate = function() {
  epiviz.ui.charts.decoration.VisualizationDecoration.prototype.decorate.call(this);

  var buttonIndex = 0;
  for (var decoration = this.otherDecoration(); decoration; decoration = decoration.otherDecoration()) {
    if (decoration.isChartOptionButton) { ++buttonIndex; }
  }

  var self = this;
  var tooltipButtonId = sprintf('%s-tooltip-button', this.visualization().id());
  this.visualization().container().append(sprintf(
    '<div id="%1$s-container" style="position: absolute; top: 5px; right: %2$spx">' +
    '<input type="checkbox" id="%1$s" %3$s />' +
    '<label for="%1$s" >Toggle tooltip</label>' +
    '</div>', tooltipButtonId, 5 + buttonIndex * 30, this._checked ? 'checked="checked"' : ''));
  var button = $('#' + tooltipButtonId);
  var tooltipButtonContainer = $('#' + tooltipButtonId + '-container');
  button.button({
    text: false,
    icons: {
      primary: 'ui-icon-comment'
    }
  }).click(function() {
    self._checked = button.is(':checked');
  });

  this.visualization().container()
    .mousemove(function () { tooltipButtonContainer.show(); })
    .mouseleave(function () { tooltipButtonContainer.hide(); });
};

/**
 * @returns {boolean}
 */
epiviz.ui.charts.decoration.ToggleTooltipButton.prototype.checked = function() { return this._checked; };

// Input 236
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/10/2015
 * Time: 11:00 AM
 */

goog.provide('epiviz.ui.charts.decoration.ChartColorByMeasurementsCodeButton');

goog.require('epiviz.ui.charts.decoration.MarkerCodeButton');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');


/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @extends {epiviz.ui.charts.decoration.CodeButton}
 * @constructor
 */
epiviz.ui.charts.decoration.ChartColorByMeasurementsCodeButton = function(visualization, otherDecoration, config) {
  epiviz.ui.charts.decoration.MarkerCodeButton.call(this, visualization, otherDecoration, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.ChartColorByMeasurementsCodeButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.MarkerCodeButton.prototype);
epiviz.ui.charts.decoration.ChartColorByMeasurementsCodeButton.constructor = epiviz.ui.charts.decoration.ChartColorByMeasurementsCodeButton;

/**
 * @returns {epiviz.ui.charts.markers.VisualizationMarker.Type}
 */
epiviz.ui.charts.decoration.ChartColorByMeasurementsCodeButton.prototype.markerType = function() { return epiviz.ui.charts.markers.VisualizationMarker.Type.COLOR_BY_MEASUREMENTS; };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartColorByMeasurementsCodeButton.prototype.markerLabel = function() { return 'Color by Measurements' };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartColorByMeasurementsCodeButton.prototype.markerId = function() { return 'color-by-measurements'; };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartColorByMeasurementsCodeButton.prototype.preMarkTemplate = function() {
  return '/**\n' +
  ' * This method is called once before every draw, for all data available to the visualization,\n' +
  ' * for initialization. Its result can be used inside the filter method.\n' +
  ' * @param {epiviz.datatypes.GenomicData} [data]\n' +
  ' * @returns {InitialVars}\n' +
  ' * @template InitialVars\n' +
  ' */\n' +
  'function(data) {\n' +
  '  // TODO: Your code here\n' +
  '  return null;\n' +
  '}\n';
};

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartColorByMeasurementsCodeButton.prototype.markTemplate = function() {
  return '/**\n' +
  ' * @param {epiviz.measurements.Measurement} m\n' +
  ' * @param {epiviz.datatypes.GenomicData} [data]\n' +
  ' * @param {InitialVars} [preMarkResult]\n' +
  ' * @returns {string|number}\n' +
  ' * @template InitialVars\n' +
  ' */\n' +
  'function(m, data, preMarkResult) {\n' +
  '  // TODO: Your code here\n' +
  '  return 0;\n' +
  '}\n';
};

// goog.inherits(epiviz.ui.charts.decoration.ChartColorByMeasurementsCodeButton, epiviz.ui.charts.decoration.MarkerCodeButton);
// Input 237
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/2014
 * Time: 12:31 PM
 */

goog.provide('epiviz.ui.charts.decoration.ChartOptionButton');

goog.require('epiviz.ui.charts.decoration.VisualizationDecoration');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @extends {epiviz.ui.charts.decoration.VisualizationDecoration}
 * @constructor
 */
epiviz.ui.charts.decoration.ChartOptionButton = function(visualization, otherDecoration, config) {
  epiviz.ui.charts.decoration.VisualizationDecoration.call(this, visualization, otherDecoration, config);

  /**
   * @type {boolean}
   */
  this.isChartOptionButton = true;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.ChartOptionButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.VisualizationDecoration.prototype);
epiviz.ui.charts.decoration.ChartOptionButton.constructor = epiviz.ui.charts.decoration.ChartOptionButton;

/**
 */
epiviz.ui.charts.decoration.ChartOptionButton.prototype.decorate = function() {
  epiviz.ui.charts.decoration.VisualizationDecoration.prototype.decorate.call(this);

  if (!this.isChartOptionButton) { return; }

  var buttonIndex = 0;
  for (var decoration = this.otherDecoration(); decoration; decoration = decoration.otherDecoration()) {
    if (decoration.isChartOptionButton) { ++buttonIndex; }
  }

  var button = $(sprintf('<button style="position: absolute; top: 5px; right: %spx">%s</button>',
    5 + buttonIndex * 30,
    this._text()))
    .appendTo(this.visualization().container())
    .button(this._renderOptions())
    .click(this._click());

  this.visualization().container()
    .mousemove(function () { button.show(); })
    .mouseleave(function () { button.hide(); });
};

/**
 * @returns {Function}
 * @protected
 */
epiviz.ui.charts.decoration.ChartOptionButton.prototype._click = function() { return function() {}; };

/**
 * @returns {*} jQuery button render options
 * @protected
 */
epiviz.ui.charts.decoration.ChartOptionButton.prototype._renderOptions = function() { return {}; };

/**
 * @returns {string}
 * @protected
 */
epiviz.ui.charts.decoration.ChartOptionButton.prototype._text = function() { return ''; };

// Input 238
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/29/14
 * Time: 4:36 PM
 */

goog.provide('epiviz.ui.controls.CustomSettingsDialog');

goog.require('epiviz.ui.controls.Dialog');
goog.require('epiviz.utils');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.controls.MessageDialog');

/**
 * @param {string} title
 * @param {{ok: function(Object.<string, *>), cancel: function()}} handlers
 * @param {Array.<epiviz.ui.charts.CustomSetting>} customSettingsDefs
 * @param {Object.<string, *>} customSettingsValues
 * @constructor
 * @extends {epiviz.ui.controls.Dialog}
 */
epiviz.ui.controls.CustomSettingsDialog = function(title, handlers, customSettingsDefs, customSettingsValues) {
  epiviz.ui.controls.Dialog.call(this, title, handlers);

  /**
   * @type {Array.<epiviz.ui.charts.CustomSetting>}
   * @private
   */
  this._customSettingsDefs = customSettingsDefs;

  /**
   * @type {Object.<string, *>}
   * @private
   */
  this._customSettingsValues = epiviz.utils.mapCopy(customSettingsValues);
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.CustomSettingsDialog.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Dialog.prototype);
epiviz.ui.controls.CustomSettingsDialog.constructor = epiviz.ui.controls.CustomSettingsDialog;

/**
 */
epiviz.ui.controls.CustomSettingsDialog.prototype.show = function() {
  epiviz.ui.controls.Dialog.prototype.show.call(this);

  var SettingType = epiviz.ui.charts.CustomSetting.Type;

  if (!this._dialog) {
    var self = this;
    this._dialog = $('#' + this._id);
    this._dialog.css('display', 'inline');

    var i, inputId, input, value;
    var content = '';
    for (i = 0; i < this._customSettingsDefs.length; ++i) {
      inputId = sprintf('%s-%s', this._id, this._customSettingsDefs[i].id);
      var row = sprintf(
        '<tr><td><label for="%s">%s</label></td><td style="text-align: right;">%%s</td></tr>',
        inputId, this._customSettingsDefs[i].label);

      input = null;
      value = this._customSettingsValues[this._customSettingsDefs[i].id];
      switch (this._customSettingsDefs[i].type) {
        case SettingType.BOOLEAN:
          row = sprintf(row, sprintf(
            '<div id="%1$s">' +
              '<label for="%1$s-true">On</label>' +
              '<input type="radio" id="%1$s-true" name="%1$s" %2$s />' +
              '<label for="%1$s-false">Off</label>' +
              '<input type="radio" id="%1$s-false" name="%1$s" %3$s />' +
              '</div>', inputId, value ? 'checked="checked"' : '', value ? '' : 'checked="checked"'));
          break;

        case SettingType.ARRAY:
          row = sprintf(row, sprintf(
            '<input id="%s" value="%s" class="ui-widget-content ui-corner-all" style="text-align: right; padding: 5px;" />', inputId, value.join(',')));
          break;
        case SettingType.NUMBER:
        case SettingType.STRING:
          row = sprintf(row, sprintf(
            '<input id="%s" value="%s" class="ui-widget-content ui-corner-all" style="text-align: right; padding: 5px;" />', inputId, value));
          break;
        case SettingType.CATEGORICAL:
        case SettingType.MEASUREMENTS_METADATA:
        case SettingType.MEASUREMENTS_ANNOTATION:
          var optionFormat = '<option value="%1$s"%2$s>%1$s</option>';
          var options = '';
          var def = this._customSettingsDefs[i];
          if (def.possibleValues) {
            for (var j = 0; j < def.possibleValues.length; ++j) {
              options += sprintf(optionFormat, def.possibleValues[j], def.possibleValues[j] == value ? 'selected="selected"' : '');
            }
          }
          var selector = sprintf('<select id="%s">%s</select>', inputId, options);
          row = sprintf(row, selector);
          break;
      }

      content += row;
    }
    content = sprintf('<div style="margin: 5px; padding: 5px; height: auto;"><table style="width: 100%%;">%s</table></div>', content);

    this._dialog.append(content);

    // Add jQuery UI properties to fields
    for (i = 0; i < this._customSettingsDefs.length; ++i) {
      inputId = sprintf('%s-%s', this._id, this._customSettingsDefs[i].id);
      input = $('#' + inputId);
      value = this._customSettingsValues[this._customSettingsDefs[i].id];
      switch (this._customSettingsDefs[i].type) {
        case SettingType.BOOLEAN:
          input.buttonset();
          break;

        case SettingType.NUMBER:
        case SettingType.ARRAY:
        case SettingType.STRING:
          input.watermark(this._customSettingsDefs[i].label);
          break;
        case SettingType.CATEGORICAL:
        case SettingType.MEASUREMENTS_METADATA:
        case SettingType.MEASUREMENTS_ANNOTATION:
          input.selectmenu();
      }
    }


    this._dialog.dialog({
      autoOpen: false,
      resizable: false,
      //width: '600',
      buttons: {
        Ok: function() {
          for (var i = 0; i < self._customSettingsDefs.length; ++i) {
            inputId = sprintf('%s-%s', self._id, self._customSettingsDefs[i].id);
            input = $('#' + inputId);
            var newValue = null;
            if (input.val() == epiviz.ui.charts.CustomSetting.DEFAULT) {
              newValue = self._customSettingsDefs[i].defaultValue;
            } else {
              var errorDialog = null;
              try {
                switch (self._customSettingsDefs[i].type) {
                  case SettingType.BOOLEAN:
                    var checked = $('#' + inputId + ' :radio:checked').attr('id');
                    newValue = checked.substr(checked.lastIndexOf('-')+1) == 'true';
                    break;

                  case SettingType.NUMBER:
                    newValue = (input.val() == epiviz.ui.charts.CustomSetting.DEFAULT) ?
                      self._customSettingsDefs[i].defaultValue :
                      parseFloat(input.val());
                    if (isNaN(newValue)) {
                      errorDialog = new epiviz.ui.controls.MessageDialog(
                        'Invalid property value',
                        { Ok: function() {} },
                        sprintf('Invalid value for setting "%s" (%s)', self._customSettingsDefs[i].label, self._customSettingsDefs[i].id),
                        epiviz.ui.controls.MessageDialog.Icon.ERROR);
                      errorDialog.show();
                      return;
                    }
                    break;
                  case SettingType.ARRAY:
                    newValue = input.val().split(/[\s,]+/g);
                    break;
                  case SettingType.STRING:
                  case SettingType.CATEGORICAL:
                  case SettingType.MEASUREMENTS_METADATA:
                  case SettingType.MEASUREMENTS_ANNOTATION:
                    newValue = input.val();
                    break;
                }
              } catch (error) {
                errorDialog = new epiviz.ui.controls.MessageDialog(
                  'Invalid property value',
                  { Ok: function() {} },
                  sprintf('Invalid value for setting "%s" (%s)', self._customSettingsDefs[i].label, self._customSettingsDefs[i].id),
                  epiviz.ui.controls.MessageDialog.Icon.ERROR);
                errorDialog.show();
                return;
              }
            }

            self._customSettingsValues[self._customSettingsDefs[i].id] = newValue;
          }

          self._handlers.ok(self._customSettingsValues);
          $(this).dialog('close');
        },
        Cancel: function() {
          self._handlers.cancel();
          $(this).dialog('close');
        }
      },
      modal: true
    });

    // This makes the dialog only able to open once:
    this._dialog.dialog({
      close: function(event, ui) {
        $(this).remove();
        self._dialog = null;
      }
    });
  }

  this._dialog.dialog('open');

  this._dialog.dialog('option', 'position', 'center');
};

// Input 239
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/2014
 * Time: 12:24 PM
 */

goog.provide('epiviz.ui.charts.decoration.CustomSettingsButton');

goog.require('epiviz.ui.charts.decoration.ChartOptionButton');
goog.require('epiviz.ui.controls.CustomSettingsDialog');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @extends {epiviz.ui.charts.decoration.ChartOptionButton}
 * @constructor
 */
epiviz.ui.charts.decoration.CustomSettingsButton = function(visualization, otherDecoration) {
  epiviz.ui.charts.decoration.ChartOptionButton.call(this, visualization, otherDecoration);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.CustomSettingsButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.ChartOptionButton.prototype);
epiviz.ui.charts.decoration.CustomSettingsButton.constructor = epiviz.ui.charts.decoration.CustomSettingsButton;

/**
 * @returns {Function}
 * @protected
 */
epiviz.ui.charts.decoration.CustomSettingsButton.prototype._click = function() {
  var self = this;
  return function(){
    var CustomSettings = epiviz.ui.charts.Visualization.CustomSettings;
    var customSettingsDialog = new epiviz.ui.controls.CustomSettingsDialog(
      'Edit custom settings', {
        ok: function(settingsValues) {
          self.visualization().setCustomSettingsValues(settingsValues);
        },
        cancel: function() {}
      },
      self.visualization().properties().customSettingsDefs,
      self.visualization().customSettingsValues());
    customSettingsDialog.show();
  };
};

/**
 * @returns {*} jQuery button render options
 * @protected
 */
epiviz.ui.charts.decoration.CustomSettingsButton.prototype._renderOptions = function() {
  return {
    icons:{ primary:'ui-icon ui-icon-gear' },
    text:false
  };
};

/**
 * @returns {string}
 * @protected
 */
epiviz.ui.charts.decoration.CustomSettingsButton.prototype._text = function() { return 'Custom settings'; };

// Input 240
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/10/2015
 * Time: 11:00 AM
 */

goog.provide('epiviz.ui.charts.decoration.ChartFilterCodeButton');

goog.require('epiviz.ui.charts.decoration.MarkerCodeButton');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @extends {epiviz.ui.charts.decoration.CodeButton}
 * @constructor
 */
epiviz.ui.charts.decoration.ChartFilterCodeButton = function(visualization, otherDecoration, config) {
  epiviz.ui.charts.decoration.MarkerCodeButton.call(this, visualization, otherDecoration, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.ChartFilterCodeButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.MarkerCodeButton.prototype);
epiviz.ui.charts.decoration.ChartFilterCodeButton.constructor = epiviz.ui.charts.decoration.ChartFilterCodeButton;

/**
 * @returns {epiviz.ui.charts.markers.VisualizationMarker.Type}
 */
epiviz.ui.charts.decoration.ChartFilterCodeButton.prototype.markerType = function() { return epiviz.ui.charts.markers.VisualizationMarker.Type.FILTER; };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartFilterCodeButton.prototype.markerLabel = function() { return 'User Filter' };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartFilterCodeButton.prototype.markerId = function() { return 'user-filter'; };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartFilterCodeButton.prototype.preMarkTemplate = function() {
  return '/**\n' +
  ' * This method is called once before every draw, for all data available to the visualization,\n' +
  ' * for initialization. Its result can be used inside the filter method.\n' +
  ' * @param {epiviz.datatypes.GenomicData} [data]\n' +
  ' * @returns {InitialVars}\n' +
  ' * @template InitialVars\n' +
  ' */\n' +
  'function(data) {\n' +
  '  // TODO: Your code here\n' +
  '  return null;\n' +
  '}\n';
};

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartFilterCodeButton.prototype.markTemplate = function() {
  return '/**\n' +
  ' * This method is called for every data object. If it returns false, the object will not be drawn.\n' +
  ' * @param {epiviz.datatypes.GenomicData.ValueItem} [item]\n' +
  ' * @param {epiviz.datatypes.GenomicData} [data]\n' +
  ' * @param {InitialVars} [preMarkResult]\n' +
  ' * @returns {boolean}\n' +
  ' * @template InitialVars\n' +
  ' */\n' +
  'function(item, data, preMarkResult) {\n' +
  '  // TODO: Your code here\n' +
  '  return true;\n' +
  '}\n'
};


// Input 241
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/2014
 * Time: 12:24 PM
 */

goog.provide('epiviz.ui.charts.decoration.SaveChartButton');

goog.require('epiviz.ui.charts.decoration.ChartOptionButton');
goog.require('epiviz.ui.charts.VisEventArgs');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @extends {epiviz.ui.charts.decoration.ChartOptionButton}
 * @constructor
 */
epiviz.ui.charts.decoration.SaveChartButton = function(visualization, otherDecoration) {
  epiviz.ui.charts.decoration.ChartOptionButton.call(this, visualization, otherDecoration);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.SaveChartButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.ChartOptionButton.prototype);
epiviz.ui.charts.decoration.SaveChartButton.constructor = epiviz.ui.charts.decoration.SaveChartButton;

/**
 * @returns {Function}
 * @protected
 */
epiviz.ui.charts.decoration.SaveChartButton.prototype._click = function() {
  var self = this;
  return function(){
    self.visualization().onSave().notify(new epiviz.ui.charts.VisEventArgs(self.visualization().id()));
  };
};

/**
 * @returns {*} jQuery button render options
 * @protected
 */
epiviz.ui.charts.decoration.SaveChartButton.prototype._renderOptions = function() {
  return {
    icons:{ primary:'ui-icon ui-icon-disk' },
    text:false
  };
};

/**
 * @returns {string}
 * @protected
 */
epiviz.ui.charts.decoration.SaveChartButton.prototype._text = function() { return 'Save'; };

// Input 242
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/6/2015
 * Time: 12:59 PM
 */

goog.provide('epiviz.ui.charts.decoration.CodeButton');

goog.require('epiviz.ui.charts.decoration.ChartOptionButton');
goog.require('epiviz.ui.controls.CodeDialog');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @extends {epiviz.ui.charts.decoration.ChartOptionButton}
 * @constructor
 */
epiviz.ui.charts.decoration.CodeButton = function(visualization, otherDecoration, config) {
  epiviz.ui.charts.decoration.ChartOptionButton.call(this, visualization, otherDecoration, config);

  /**
   * @type {boolean}
   * @const
   */
  this.isCodeButton = true;

  /**
   * @type {Array.<{creator: function(jQuery): epiviz.ui.controls.CodeControl, save: function(*), cancel: function()}>}
   * @private
   */
  this._controlCreators = [];

  var isChartOptionButton = true;
  var lastCodeButtonDecoration;
  for (var decoration = this.otherDecoration(); decoration; decoration = decoration.otherDecoration()) {
    if (decoration.isCodeButton) {
      isChartOptionButton = false;
      lastCodeButtonDecoration = decoration;
    }
  }
  if (lastCodeButtonDecoration) {
    lastCodeButtonDecoration._addControlCreator(this._controlCreator(), this._saveHandler(), this._cancelHandler());
  }
  this.isChartOptionButton = isChartOptionButton;
  if (isChartOptionButton) {
    this._addControlCreator(this._controlCreator(), this._saveHandler(), this._cancelHandler());
  }
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.CodeButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.ChartOptionButton.prototype);
epiviz.ui.charts.decoration.CodeButton.constructor = epiviz.ui.charts.decoration.CodeButton;

/**
 * @returns {Function}
 * @protected
 */
epiviz.ui.charts.decoration.CodeButton.prototype._click = function() {
  var self = this;

  return function() {
    var editCodeDialog = new epiviz.ui.controls.CodeDialog(
      'Chart Code',
      {
        save: function(results) {
          results.forEach(function(result, i) {
            self._controlCreators[i].save(result);
          });
        },
        cancel: function() {
          self._controlCreators.forEach(function(o) { o.cancel(); })
        }
      },
      self._controlCreators.map(function(o) { return o.creator; }));
    editCodeDialog.show();
  };
};

/**
 * @returns {*} jQuery button render options
 * @protected
 */
epiviz.ui.charts.decoration.CodeButton.prototype._renderOptions = function() {
  return {
    icons:{ primary:'ui-icon ui-icon-pencil' },
    text:false
  };
};

/**
 * @returns {string}
 * @protected
 */
epiviz.ui.charts.decoration.CodeButton.prototype._text = function() { return 'Code'; };

/**
 * @param {function(jQuery): epiviz.ui.controls.CodeControl} creator
 * @param {function(*)} [saveHandler]
 * @param {function()} [cancelHandler]
 * @protected
 */
epiviz.ui.charts.decoration.CodeButton.prototype._addControlCreator = function(creator, saveHandler, cancelHandler) {
  this._controlCreators.push({creator: creator, save: saveHandler, cancel: cancelHandler});
};

/**
 * @returns {function(jQuery): epiviz.ui.controls.CodeControl}
 * @protected
 */
epiviz.ui.charts.decoration.CodeButton.prototype._controlCreator = function() { return null; };

/**
 * @returns {function(*)}
 * @private
 */
epiviz.ui.charts.decoration.CodeButton.prototype._saveHandler = function() { return null; };

/**
 * @returns {function()}
 * @private
 */
epiviz.ui.charts.decoration.CodeButton.prototype._cancelHandler = function() { return null; };

//goog.inherits(epiviz.ui.charts.decoration.CodeButton, epiviz.ui.charts.decoration.ChartOptionButton);
// Input 243
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/7/2015
 * Time: 2:00 PM
 */

goog.provide('epiviz.ui.charts.decoration.MarkerCodeButton');

goog.require('epiviz.ui.charts.decoration.CodeButton');
goog.require('epiviz.ui.controls.MarkerCodeControl');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @extends {epiviz.ui.charts.decoration.CodeButton}
 * @constructor
 */
epiviz.ui.charts.decoration.MarkerCodeButton = function(visualization, otherDecoration, config) {
  epiviz.ui.charts.decoration.CodeButton.call(this, visualization, otherDecoration, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.CodeButton.prototype);
epiviz.ui.charts.decoration.MarkerCodeButton.constructor = epiviz.ui.charts.decoration.MarkerCodeButton;

/**
 * @returns {function(jQuery): epiviz.ui.controls.CodeControl}
 * @private
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype._controlCreator = function() {
  var self = this;
  return function(container) {
    var existingMark = self.visualization().getMarker(self.markerId());
    var preMark, mark;
    if (existingMark) {
      preMark = existingMark.preMarkStr();
      mark = existingMark.markStr();
    }

    preMark = preMark || self.preMarkTemplate();
    mark = mark || self.markTemplate();

    return new epiviz.ui.controls.MarkerCodeControl(container, self.markerLabel(), null, self.visualization(), preMark, mark, existingMark != undefined);
  };
};

/**
 * @returns {function(*)}
 * @private
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype._saveHandler = function() {
  var self = this;
  return function(arg) {
    if (arg.enabled) {
      self.visualization().putMarker(self.createMarker(arg.preMark, arg.mark));
    } else {
      self.visualization().removeMarker(self.markerId());
    }
  };
};

/**
 * @returns {function()}
 * @private
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype._cancelHandler = function() { return function() {}; };

/**
 * @param {string} [preMark]
 * @param {string} [mark]
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype.createMarker = function(preMark, mark) {
  return new epiviz.ui.charts.markers.VisualizationMarker(
    this.markerType(),
    this.markerId(),
    this.markerLabel(),
    preMark,
    mark);
};

/**
 * @returns {epiviz.ui.charts.markers.VisualizationMarker.Type}
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype.markerType = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype.markerLabel = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype.markerId = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype.preMarkTemplate = function() { throw Error('unimplemented abstract method'); };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.MarkerCodeButton.prototype.markTemplate = function() { throw Error('unimplemented abstract method'); };

// Input 244
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/16/2015
 * Time: 6:18 PM
 */

goog.provide('epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton');

goog.require('epiviz.ui.charts.decoration.MarkerCodeButton');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @extends {epiviz.ui.charts.decoration.CodeButton}
 * @constructor
 */
epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton = function(visualization, otherDecoration, config) {
  epiviz.ui.charts.decoration.MarkerCodeButton.call(this, visualization, otherDecoration, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.MarkerCodeButton.prototype);
epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton.constructor = epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton;

/**
 * @returns {epiviz.ui.charts.markers.VisualizationMarker.Type}
 */
epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton.prototype.markerType = function() { return epiviz.ui.charts.markers.VisualizationMarker.Type.GROUP_BY_MEASUREMENTS; };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton.prototype.markerLabel = function() { return 'Group by' };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton.prototype.markerId = function() { return 'group-by-measurements'; };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton.prototype.preMarkTemplate = function() {
  return '/**\n' +
  ' * This method is called once before every draw, for all data available to the visualization,\n' +
  ' * for initialization. Its result can be used inside the filter method.\n' +
  ' * @param {epiviz.datatypes.GenomicData} [data]\n' +
  ' * @returns {InitialVars}\n' +
  ' * @template InitialVars\n' +
  ' */\n' +
  'function(data) {\n' +
  '  // TODO: Your code here\n' +
  '  return null;\n' +
  '}\n';
};

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton.prototype.markTemplate = function() {
  return '/**\n' +
  ' * @param {epiviz.measurements.Measurement} m\n' +
  ' * @param {epiviz.datatypes.GenomicData} [data]\n' +
  ' * @param {InitialVars} [preMarkResult]\n' +
  ' * @returns {string}\n' +
  ' * @template InitialVars\n' +
  ' */\n' +
  'function(m, data, preMarkResult) {\n' +
  '  // TODO: Your code here\n' +
  '  return 0;\n' +
  '}\n';
};

// goog.inherits(epiviz.ui.charts.decoration.ChartGroupByMeasurementsCodeButton, epiviz.ui.charts.decoration.MarkerCodeButton);
// Input 245
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/10/2015
 * Time: 11:00 AM
 */

goog.provide('epiviz.ui.charts.decoration.ChartOrderByMeasurementsCodeButton');

goog.require('epiviz.ui.charts.decoration.MarkerCodeButton');
goog.require('epiviz.ui.charts.markers.VisualizationMarker');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @extends {epiviz.ui.charts.decoration.CodeButton}
 * @constructor
 */
epiviz.ui.charts.decoration.ChartOrderByMeasurementsCodeButton = function(visualization, otherDecoration, config) {
  epiviz.ui.charts.decoration.MarkerCodeButton.call(this, visualization, otherDecoration, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.ChartOrderByMeasurementsCodeButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.MarkerCodeButton.prototype);
epiviz.ui.charts.decoration.ChartOrderByMeasurementsCodeButton.constructor = epiviz.ui.charts.decoration.ChartOrderByMeasurementsCodeButton;

/**
 * @returns {epiviz.ui.charts.markers.VisualizationMarker.Type}
 */
epiviz.ui.charts.decoration.ChartOrderByMeasurementsCodeButton.prototype.markerType = function() { return epiviz.ui.charts.markers.VisualizationMarker.Type.ORDER_BY_MEASUREMENTS; };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartOrderByMeasurementsCodeButton.prototype.markerLabel = function() { return 'Order By' };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartOrderByMeasurementsCodeButton.prototype.markerId = function() { return 'order-by-measurements'; };

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartOrderByMeasurementsCodeButton.prototype.preMarkTemplate = function() {
  return '/**\n' +
  ' * This method is called once before every draw, for all data available to the visualization,\n' +
  ' * for initialization. Its result can be used inside the filter method.\n' +
  ' * @param {epiviz.datatypes.GenomicData} [data]\n' +
  ' * @returns {InitialVars}\n' +
  ' * @template InitialVars\n' +
  ' */\n' +
  'function(data) {\n' +
  '  // TODO: Your code here\n' +
  '  return null;\n' +
  '}\n';
};

/**
 * @returns {string}
 */
epiviz.ui.charts.decoration.ChartOrderByMeasurementsCodeButton.prototype.markTemplate = function() {
  return '/**\n' +
  ' * @param {epiviz.measurements.Measurement} m\n' +
  ' * @param {epiviz.datatypes.GenomicData} [data]\n' +
  ' * @param {InitialVars} [preMarkResult]\n' +
  ' * @returns {string|number}\n' +
  ' * @template InitialVars\n' +
  ' */\n' +
  'function(m, data, preMarkResult) {\n' +
  '  // TODO: Your code here\n' +
  '  return 0;\n' +
  '}\n';
};

// goog.inherits(epiviz.ui.charts.decoration.ChartOrderByMeasurementsCodeButton, epiviz.ui.charts.decoration.MarkerCodeButton);
// Input 246
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/5/2015
 * Time: 5:53 PM
 */

goog.provide('epiviz.ui.controls.EditCodeControl');

goog.require('epiviz.ui.controls.CodeControl');

/**
 * @param {jQuery} container
 * @param {string} [title]
 * @param {string} [id]
 * @param {Object} [targetObject]
 * @param {string} [defaultMethod]
 * @param {boolean} [hasModifiedMethods]
 * @constructor
 * @extends {epiviz.ui.controls.CodeControl}
 */
epiviz.ui.controls.EditCodeControl = function(container, title, id, targetObject, defaultMethod, hasModifiedMethods) {
  // Call superclass constructor
  epiviz.ui.controls.CodeControl.call(this, container, title, id, targetObject);

  /**
   * @type {string}
   * @private
   */
  this._defaultMethod = defaultMethod;

  /**
   * @type {CodeMirror}
   * @private
   */
  this._editor = null;

  /**
   * @type {Object.<string, string>}
   * @private
   */
  this._methodsCode = {};

  /**
   * @type {string}
   * @private
   */
  this._selectedMethod = null;

  /**
   * @type {boolean}
   * @private
   */
  this._hasModifiedMethods = hasModifiedMethods || false;
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.EditCodeControl.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.CodeControl.prototype);
epiviz.ui.controls.EditCodeControl.constructor = epiviz.ui.controls.EditCodeControl;

epiviz.ui.controls.EditCodeControl.prototype.initialize = function() {
  if (this._editor) { return; }

  this._container.append(
    '<div style="float: left; margin-right: 5px;"><select class="obj-methods"></select></div>' +
    sprintf(
      '<div id="%1$s">' +
        '<label for="%1$s-true">On</label>' +
        '<input type="radio" id="%1$s-true" name="%1$s" %2$s />' +
        '<label for="%1$s-false">Off</label>' +
        '<input type="radio" id="%1$s-false" name="%1$s" %3$s />' +
      '</div>', this.id() + '-switch', this._hasModifiedMethods ? 'checked="checked"' : '',
      this._hasModifiedMethods ? '' : 'checked="checked"') +
    '<br />' +
    '<div style="overflow-y: scroll; max-height: 500px;">' +
    '<textarea autofocus="autofocus" class="code-edit"></textarea>' +
    '</div>');

  this._methodsSelector = this._container.find('.obj-methods');
  var onOffSwitch = this._container.find('#' + this.id() + '-switch');
  onOffSwitch.buttonset();
  var self = this;
  var optionChange = function(e) {
    var optionChecked = $('#' + self.id() + '-switch :radio:checked').attr('id');
    var newValue = optionChecked.substr(optionChecked.lastIndexOf('-')+1) == 'true';
    if (self._editor) { self._editor.setOption('disableInput', !newValue); }
    self._hasModifiedMethods = newValue;
  };
  onOffSwitch.find('#' + this.id() + '-switch-true').on('change', optionChange);
  onOffSwitch.find('#' + this.id() + '-switch-false').on('change', optionChange);
  var codeEditor = this._container.find('.code-edit');
  var methods = [];
  var obj = this._targetObj;
  for (var m in obj) {
    if ($.isFunction(obj[m])) {
      methods.push(m);
    }
  }
  methods.sort();
  for (var i = 0; i < methods.length; ++i) {
    m = methods[i];
    var selected = ((i == 0 && !this._defaultMethod) || this._defaultMethod == m);
    this._methodsSelector.append(sprintf('<option value="%s"%s>%s</option>',
      m, selected ? ' selected="selected"' : '', m));
    if (selected) {
      this._text = obj[m].toString();
      this._selectedMethod = m;
    }
  }

  this._methodsSelector.change(function() {
    self._methodsCode[self._selectedMethod] = self._editor.getValue();

    var sel = $(this).val();
    var text = self._methodsCode[sel];
    if (!text) {
      text = self._targetObj[sel].toString();
      self._methodsCode[sel] = text;
    }
    self._text = text;
    if (self._editor) {
      self._editor.getDoc().setValue(self._text);
    } else {
      codeEditor.val(self._text);
    }
    self._selectedMethod = sel;
    //self._dialog.dialog('option', 'position', 'center');// TODO: Trigger an event so that the dialog can re-center
  });

  codeEditor.val(this._text);
  this._methodsSelector.selectmenu({
    style: 'popup',
    width: '150',
    maxHeight: '150',
    menuWidth: '150'
  });

  this._editor = CodeMirror.fromTextArea(this._container.find('.code-edit')[0], {
    lineNumbers: true,
    matchBrackets: true,
    continueComments: "Enter",
    extraKeys: {"Ctrl-Q": "toggleComment"},
    autofocus: true
  });
  this._editor.setOption('disableInput', !this._hasModifiedMethods);
};

/**
 */
epiviz.ui.controls.EditCodeControl.prototype.save = function() {
  this._methodsCode[this._selectedMethod] = this._editor.getValue();
  this._text = this._editor.getValue();
};

/**
 */
epiviz.ui.controls.EditCodeControl.prototype.revert = function() {
  if (this._editor) {
    this._editor.setOption('value', this._text);
  }
};

/**
 * @returns {Object.<string, string>}
 */
epiviz.ui.controls.EditCodeControl.prototype.modifiedMethods = function() {
  /** @type {Object.<string, string>} */
  var modifiedMethods = {};
  for (var m in this._methodsCode) {
    if (!this._methodsCode.hasOwnProperty(m)) { continue; }
    if (this._methodsCode[m] != this._targetObj[m].toString()) {
      modifiedMethods[m] = this._methodsCode[m];
    }
  }
  return modifiedMethods;
};

/**
 * @returns {*}
 */
epiviz.ui.controls.EditCodeControl.prototype.result = function() {
  return {
    hasModifiedMethods: this._hasModifiedMethods,
    modifiedMethods: this._hasModifiedMethods ? this.modifiedMethods() : {}
  };
};

// Input 247
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/2014
 * Time: 12:24 PM
 */

goog.provide('epiviz.ui.charts.decoration.EditCodeButton');

goog.require('epiviz.ui.charts.decoration.CodeButton');
goog.require('epiviz.ui.controls.EditCodeControl');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @extends {epiviz.ui.charts.decoration.CodeButton}
 * @constructor
 */
epiviz.ui.charts.decoration.EditCodeButton = function(visualization, otherDecoration, config) {
  epiviz.ui.charts.decoration.CodeButton.call(this, visualization, otherDecoration, config);
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.EditCodeButton.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.CodeButton.prototype);
epiviz.ui.charts.decoration.EditCodeButton.constructor = epiviz.ui.charts.decoration.EditCodeButton;

/**
 * @returns {function(jQuery): epiviz.ui.controls.CodeControl}
 * @private
 */
epiviz.ui.charts.decoration.EditCodeButton.prototype._controlCreator = function() {
  var self = this;
  return function(container) {
    return new epiviz.ui.controls.EditCodeControl(container, 'Edit Code', null, self.visualization(), self.visualization().lastModifiedMethod(), self.visualization().hasModifiedMethods());
  };
};

/**
 * @returns {function(*)}
 * @private
 */
epiviz.ui.charts.decoration.EditCodeButton.prototype._saveHandler = function() {
  var self = this;
  return function(result) {
    if (result.hasModifiedMethods) {
      self.visualization().setModifiedMethods(result.modifiedMethods);
    } else {
      self.visualization().resetModifiedMethods();
    }
  };
};

/**
 * @returns {function()}
 * @private
 */
epiviz.ui.charts.decoration.EditCodeButton.prototype._cancelHandler = function() { return function() {}; };

// Input 248
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/2014
 * Time: 12:11 PM
 */

goog.provide('epiviz.ui.charts.decoration.VisualizationDecoration');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @param {epiviz.Config} [config]
 * @constructor
 */
epiviz.ui.charts.decoration.VisualizationDecoration = function(visualization, otherDecoration, config) {
  /**
   * @type {epiviz.ui.charts.Visualization}
   * @private
   */
  this._visualization = visualization;

  /**
   * @type {epiviz.ui.charts.decoration.VisualizationDecoration}
   * @private
   */
  this._otherDecoration = otherDecoration;

  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;
};

/**
 */
epiviz.ui.charts.decoration.VisualizationDecoration.prototype.decorate = function() {
  if (this._otherDecoration) { this._otherDecoration.decorate(); }
};

/**
 * @returns {epiviz.ui.charts.Visualization}
 */
epiviz.ui.charts.decoration.VisualizationDecoration.prototype.visualization = function() { return this._visualization; };

/**
 * @returns {epiviz.ui.charts.decoration.VisualizationDecoration}
 */
epiviz.ui.charts.decoration.VisualizationDecoration.prototype.otherDecoration = function() { return this._otherDecoration; };

/**
 * @returns {epiviz.Config}
 */
epiviz.ui.charts.decoration.VisualizationDecoration.prototype.config = function() { return this._config; };

// Input 249
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/30/2014
 * Time: 12:31 PM
 */

goog.provide('epiviz.ui.charts.decoration.ChartLoaderAnimation');

goog.require('epiviz.ui.charts.decoration.VisualizationDecoration');
goog.require('epiviz.events.EventListener');

/**
 * @param {epiviz.ui.charts.Visualization} visualization
 * @param {epiviz.ui.charts.decoration.VisualizationDecoration} [otherDecoration]
 * @extends {epiviz.ui.charts.decoration.VisualizationDecoration}
 * @constructor
 */
epiviz.ui.charts.decoration.ChartLoaderAnimation = function(visualization, otherDecoration) {
  epiviz.ui.charts.decoration.VisualizationDecoration.call(this, visualization, otherDecoration);

  /**
   * @type {number}
   * @private
   */
  this._loaderTimeout = 0;

  /**
   * @type {boolean}
   * @private
   */
  this._animationShowing = false;
};

/*
 * Copy methods from upper class
 */
epiviz.ui.charts.decoration.ChartLoaderAnimation.prototype = epiviz.utils.mapCopy(epiviz.ui.charts.decoration.VisualizationDecoration.prototype);
epiviz.ui.charts.decoration.ChartLoaderAnimation.constructor = epiviz.ui.charts.decoration.ChartLoaderAnimation;

/**
 */
epiviz.ui.charts.decoration.ChartLoaderAnimation.prototype.decorate = function() {
  epiviz.ui.charts.decoration.VisualizationDecoration.prototype.decorate.call(this);

  var self = this;
  this.visualization().onDataWaitStart().addListener(new epiviz.events.EventListener(function() {
    self._addLoaderAnimation();
  }));

  this.visualization().onDataWaitEnd().addListener(new epiviz.events.EventListener(function() {
    self._removeLoaderAnimation();
  }));

  this.visualization().onSizeChanged().addListener(new epiviz.events.EventListener(function() {
    if (self._animationShowing) {
      self._addLoaderAnimation();
    }
  }));
};

epiviz.ui.charts.decoration.ChartLoaderAnimation.prototype._addLoaderAnimation = function() {
  if (this._loaderTimeout) { clearTimeout(this._loaderTimeout); }

  var doAddLoaderAnimation = function() {
    self._animationShowing = true;
    var loaderCls = 'chart-loader';

    var visualization = self.visualization();
    var container = visualization.container();
    container.find('.' + loaderCls).remove();

    container.append(sprintf(
      '<div class="loader-icon %s" style="top: %spx; left: %spx;"></div>',
      loaderCls,
      Math.floor(visualization.height() * 0.5),
      Math.floor(visualization.width() * 0.5)));
    container.find('.' + loaderCls).activity({
      segments: 8,
      steps: 5,
      opacity: 0.3,
      width: 4,
      space: 0,
      length: 10,
      color: '#0b0b0b',
      speed: 1.0
    });
  };

  var self = this;

  if (!this._animationShowing) {
    this._loaderTimeout = setTimeout(doAddLoaderAnimation, 500);
  } else {
    doAddLoaderAnimation();
  }
};

epiviz.ui.charts.decoration.ChartLoaderAnimation.prototype._removeLoaderAnimation = function() {
  if (this._loaderTimeout) { clearTimeout(this._loaderTimeout); }
  this._animationShowing = false;
  var loaderCls = 'chart-loader';
  this.visualization().container().find('.' + loaderCls).remove();
};

// Input 250
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/14/14
 * Time: 10:17 AM
 */

goog.provide('epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory');

goog.require('epiviz.utils');

/**
 * @param {epiviz.Config} config
 * @constructor
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory = function(config) {
  /**
   * @type {epiviz.Config}
   * @private
   */
  this._config = config;

  /**
   * @type {Object.<string, epiviz.ui.charts.transform.clustering.HierarchicalClusteringAlgorithm>}
   * @private
   */
  this._algorithms = {};

  /**
   * @type {Object.<string, epiviz.ui.charts.transform.clustering.ClusteringMetric>}
   * @private
   */
  this._metrics = {};

  /**
   * @type {Object.<string, epiviz.ui.charts.transform.clustering.ClusteringLinkage>}
   * @private
   */
  this._linkages = {};

  var i;
  for (i = 0; i < config.clustering.algorithms.length; ++i) {
    /** @type {?function(new:epiviz.ui.charts.transform.clustering.HierarchicalClusteringAlgorithm)} */
    var algorithmConstructor = epiviz.utils.evaluateFullyQualifiedTypeName(config.clustering.algorithms[i]);

    /** @type {epiviz.ui.charts.transform.clustering.HierarchicalClusteringAlgorithm} */
    var algorithm = epiviz.utils.applyConstructor(algorithmConstructor);

    this._algorithms[algorithm.id()] = algorithm;
  }

  for (i = 0; i < config.clustering.metrics.length; ++i) {
    /** @type {?function(new:epiviz.ui.charts.transform.clustering.ClusteringMetric)} */
    var metricConstructor = epiviz.utils.evaluateFullyQualifiedTypeName(config.clustering.metrics[i]);

    /** @type {epiviz.ui.charts.transform.clustering.ClusteringMetric} */
    var metric = epiviz.utils.applyConstructor(metricConstructor);

    this._metrics[metric.id()] = metric;
  }

  for (i = 0; i < config.clustering.linkages.length; ++i) {
    /** @type {?function(new:epiviz.ui.charts.transform.clustering.ClusteringLinkage)} */
    var linkageConstructor = epiviz.utils.evaluateFullyQualifiedTypeName(config.clustering.linkages[i]);

    /** @type {epiviz.ui.charts.transform.clustering.ClusteringLinkage} */
    var linkage = epiviz.utils.applyConstructor(linkageConstructor);

    this._linkages[linkage.id()] = linkage;
  }
};

/**
 * @type {?epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory}
 * @private
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory._instance = null;

/**
 * @returns {?epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory}
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.instance = function() {
  return epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory._instance;
};

/**
 * @param {epiviz.Config} config
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.initialize = function(config) {
  epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory._instance =
    new epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory(config);
};

/**
 * @param {string} id
 * @returns {epiviz.ui.charts.transform.clustering.HierarchicalClusteringAlgorithm}
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.prototype.algorithm = function(id) { return this._algorithms[id]; };

/**
 * @param {string} id
 * @returns {epiviz.ui.charts.transform.clustering.ClusteringMetric}
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.prototype.metric = function(id) { return this._metrics[id]; };

/**
 * @param {string} id
 * @returns {epiviz.ui.charts.transform.clustering.ClusteringLinkage}
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.prototype.linkage = function(id) { return this._linkages[id]; };

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.prototype.algorithms = function() { return Object.keys(this._algorithms); };

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.prototype.metrics = function() { return Object.keys(this._metrics); };

/**
 * @returns {Array.<string>}
 */
epiviz.ui.charts.transform.clustering.ClusteringAlgorithmFactory.prototype.linkages = function() { return Object.keys(this._linkages); };

// Input 251
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/14/14
 * Time: 11:35 AM
 */

goog.provide('epiviz.ui.charts.transform.clustering.ClusterLeaf');

/**
 * @param {number} dataIndex
 * @constructor
 * @implements {epiviz.ui.charts.transform.clustering.ClusterNode}
 */
epiviz.ui.charts.transform.clustering.ClusterLeaf = function(dataIndex) {
  /**
   * @type {number}
   * @private
   */
  this._dataIndex = dataIndex;
};

/**
 * @returns {number}
 */
epiviz.ui.charts.transform.clustering.ClusterLeaf.prototype.weight = function() { return 1; };

/**
 * @returns {Array.<epiviz.ui.charts.transform.clustering.ClusterNode>}
 */
epiviz.ui.charts.transform.clustering.ClusterLeaf.prototype.children = function() { return []; };

/**
 * The indices of the data stored
 * @returns {Array.<number>}
 */
epiviz.ui.charts.transform.clustering.ClusterLeaf.prototype.data = function() { return [this._dataIndex]; };

/**
 */
epiviz.ui.charts.transform.clustering.ClusterLeaf.prototype.sort = function() {};

/**
 * @returns {epiviz.ui.charts.transform.clustering.ClusterNode}
 */
epiviz.ui.charts.transform.clustering.ClusterLeaf.prototype.copy = function() { return new epiviz.ui.charts.transform.clustering.ClusterLeaf(this._dataIndex); };

/**
 * @returns {number}
 */
epiviz.ui.charts.transform.clustering.ClusterLeaf.prototype.distance = function() { return 0; };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.transform.clustering.ClusterLeaf.prototype.sorted = function() { return true; };

// Input 252
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/14/14
 * Time: 11:30 AM
 */

goog.provide('epiviz.ui.charts.transform.clustering.ClusterNode');

/**
 * @interface
 */
epiviz.ui.charts.transform.clustering.ClusterNode = function() {};

/**
 * @returns {number}
 */
epiviz.ui.charts.transform.clustering.ClusterNode.prototype.weight = function() {};

/**
 * @returns {Array.<epiviz.ui.charts.transform.clustering.ClusterNode>}
 */
epiviz.ui.charts.transform.clustering.ClusterNode.prototype.children = function() {};

/**
 * The indices of the data stored
 * @returns {Array.<number>}
 */
epiviz.ui.charts.transform.clustering.ClusterNode.prototype.data = function() {};

/**
 * @param {boolean} [recursive]
 */
epiviz.ui.charts.transform.clustering.ClusterNode.prototype.sort = function(recursive) {};

/**
 * @returns {epiviz.ui.charts.transform.clustering.ClusterNode}
 */
epiviz.ui.charts.transform.clustering.ClusterNode.prototype.copy = function() {};

/**
 * @returns {number}
 */
epiviz.ui.charts.transform.clustering.ClusterNode.prototype.distance = function() {};

/**
 * @returns {boolean}
 */
epiviz.ui.charts.transform.clustering.ClusterNode.prototype.sorted = function() {};

// Input 253
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/14/14
 * Time: 11:33 AM
 */

goog.provide('epiviz.ui.charts.transform.clustering.ClusterSubtree');

/**
 * @param {Array.<epiviz.ui.charts.transform.clustering.ClusterNode>} children
 * @param {number} distance
 * @constructor
 * @implements {epiviz.ui.charts.transform.clustering.ClusterNode}
 */
epiviz.ui.charts.transform.clustering.ClusterSubtree = function(children, distance) {
  /**
   * @type {Array.<epiviz.ui.charts.transform.clustering.ClusterNode>}
   * @private
   */
  this._children = children;

  /**
   * @type {?number}
   * @private
   */
  this._weight = null;

  /**
   * @type {number}
   * @private
   */
  this._distance = distance;

  /**
   * @type {boolean}
   * @private
   */
  this._sorted = false;
};

/**
 * @returns {number}
 */
epiviz.ui.charts.transform.clustering.ClusterSubtree.prototype.weight = function() {
  if (this._weight == undefined) {
    var weight = 0;
    for (var i = 0; i < this._children.length; ++i) {
      weight += this._children[i].weight();
    }
    this._weight = weight;
  }

  return this._weight;
};

/**
 * @returns {Array.<epiviz.ui.charts.transform.clustering.ClusterNode>}
 */
epiviz.ui.charts.transform.clustering.ClusterSubtree.prototype.children = function() { return this._children; };

/**
 * The indices of the data stored
 * @returns {Array.<number>}
 */
epiviz.ui.charts.transform.clustering.ClusterSubtree.prototype.data = function() {
  var ret = [];
  for (var i = 0; i < this._children.length; ++i) {
    ret = ret.concat(this._children[i].data());
  }

  return ret;
};

/**
 * @param {boolean} [recursive]
 */
epiviz.ui.charts.transform.clustering.ClusterSubtree.prototype.sort = function(recursive) {
  if (this.sorted()) { return; }

  this._children.sort(function(node1, node2) {
    return node1.weight() - node2.weight();
  });

  if (recursive) {
    for (var i = 0; i < this._children.length; ++i) {
      this._children[i].sort(recursive);
    }

    this._sorted = true;
  }
};

/**
 * @returns {epiviz.ui.charts.transform.clustering.ClusterNode}
 */
epiviz.ui.charts.transform.clustering.ClusterSubtree.prototype.copy = function() {
  var children = [];
  for (var i = 0; i < this._children.length; ++i) {
    children.push(this._children[i].copy());
  }
  return new epiviz.ui.charts.transform.clustering.ClusterSubtree(children);
};

/**
 * @returns {number}
 */
epiviz.ui.charts.transform.clustering.ClusterSubtree.prototype.distance = function() { return this._distance; };

/**
 * @returns {boolean}
 */
epiviz.ui.charts.transform.clustering.ClusterSubtree.prototype.sorted = function() { return this._sorted; };

// Input 254
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/14/14
 * Time: 11:28 AM
 */

goog.provide('epiviz.ui.charts.transform.clustering.ClusterTree');

/**
 * @param {epiviz.ui.charts.transform.clustering.ClusterNode} root
 * @param {Array.<Array.<number>>} data
 * @constructor
 */
epiviz.ui.charts.transform.clustering.ClusterTree = function(root, data) {
  /**
   * @type {epiviz.ui.charts.transform.clustering.ClusterNode}
   * @private
   */
  this._root = root;

  /**
   * @type {Array.<Array.<number>>}
   * @private
   */
  this._data = data;
};

/**
 * @returns {epiviz.ui.charts.transform.clustering.ClusterNode}
 */
epiviz.ui.charts.transform.clustering.ClusterTree.prototype.root = function() { return this._root; };

/**
 * @returns {Array.<Array.<number>>}
 */
epiviz.ui.charts.transform.clustering.ClusterTree.prototype.orderedData = function() {
  if (!this._root.sorted()) {
    this._root.sort(true);
  }

  var orderedIndices = this._root.data();
  var orderedData = [];
  for (var i = 0; i < orderedIndices.length; ++i) {
    orderedData.push(this._data[orderedIndices[i]]);
  }

  return orderedData;
};

// Input 255
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/14/14
 * Time: 11:37 AM
 */

goog.provide('epiviz.ui.charts.transform.clustering.AgglomerativeClustering');

goog.require('epiviz.ui.charts.transform.clustering.ClusterSubtree');
goog.require('epiviz.ui.charts.transform.clustering.ClusterLeaf');
goog.require('epiviz.ui.charts.transform.clustering.ClusterTree');
goog.require('epiviz.utils');

/**
 * @constructor
 * @implements {epiviz.ui.charts.transform.clustering.HierarchicalClusteringAlgorithm}
 */
epiviz.ui.charts.transform.clustering.AgglomerativeClustering = function() {};

/**
 * @param {Array.<Array.<number>>} data
 * @param {epiviz.ui.charts.transform.clustering.ClusteringMetric} metric
 * @param {epiviz.ui.charts.transform.clustering.ClusteringLinkage} linkage
 * @returns {epiviz.ui.charts.transform.clustering.ClusterTree}
 */
epiviz.ui.charts.transform.clustering.AgglomerativeClustering.prototype.cluster = function(data, metric, linkage) {
  var i, j;
  var distances = new Array(data.length);
  for (i = 0; i < data.length; ++i) {
    distances[i] = new Array(data.length);

    for (j = i + 1; j < data.length; ++j) {
      distances[i][j] = metric.distance(data[i], data[j]);
    }
  }

  var nodes = [];
  for (i = 0; i < data.length; ++i) {
    nodes.push(new epiviz.ui.charts.transform.clustering.ClusterLeaf(i));
  }

  while (nodes.length > 1) {
    /** @type {{min: number, index: Array}} */
    var minInfo = epiviz.utils.indexOfMin(distances, true);
    var indices = minInfo.index;
    var node = new epiviz.ui.charts.transform.clustering.ClusterSubtree([nodes[indices[0]], nodes[indices[1]]], minInfo.min);
    if (indices[0] < indices[1]) {
      var aux = indices[0];
      indices[0] = indices[1];
      indices[1] = aux;
    }
    nodes.splice(indices[0], 1);
    nodes.splice(indices[1], 1);
    nodes.push(node);
    distances = linkage.link(distances, indices);
  }

  return new epiviz.ui.charts.transform.clustering.ClusterTree(nodes[0], data);
};

/**
 * @returns {string}
 */
epiviz.ui.charts.transform.clustering.AgglomerativeClustering.prototype.id = function() { return 'agglomerative'; };

// Input 256
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/14/14
 * Time: 11:26 AM
 */

goog.provide('epiviz.ui.charts.transform.clustering.ClusteringLinkage');

/**
 * @interface
 */
epiviz.ui.charts.transform.clustering.ClusteringLinkage = function() {};

/**
 * @param {Array.<Array.<number>>} distances
 * @param {Array.<number>} indices
 * @returns {Array.<Array.<number>>}
 */
epiviz.ui.charts.transform.clustering.ClusteringLinkage.prototype.link = function(distances, indices) {};

/**
 * @returns {string}
 */
epiviz.ui.charts.transform.clustering.ClusteringLinkage.prototype.id = function() {};

// Input 257
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/14/14
 * Time: 11:59 AM
 */

goog.provide('epiviz.ui.charts.transform.clustering.NoneClustering');

goog.require('epiviz.ui.charts.transform.clustering.ClusterSubtree');
goog.require('epiviz.ui.charts.transform.clustering.ClusterLeaf');
goog.require('epiviz.ui.charts.transform.clustering.ClusterTree');

/**
 * @constructor
 * @implements {epiviz.ui.charts.transform.clustering.HierarchicalClusteringAlgorithm}
 */
epiviz.ui.charts.transform.clustering.NoneClustering = function() {};

/**
 * @param {Array.<Array.<number>>} data
 * @param {epiviz.ui.charts.transform.clustering.ClusteringMetric} metric
 * @param {epiviz.ui.charts.transform.clustering.ClusteringLinkage} linkage
 * @returns {epiviz.ui.charts.transform.clustering.ClusterTree}
 */
epiviz.ui.charts.transform.clustering.NoneClustering.prototype.cluster = function(data, metric, linkage) {
  var nodes = [];
  for (var i = 0; i < data.length; ++i) {
    nodes.push(new epiviz.ui.charts.transform.clustering.ClusterLeaf(i));
  }

  var root = new epiviz.ui.charts.transform.clustering.ClusterSubtree(nodes, 0);

  return new epiviz.ui.charts.transform.clustering.ClusterTree(root, data);
};

/**
 * @returns {string}
 */
epiviz.ui.charts.transform.clustering.NoneClustering.prototype.id = function() { return 'none'; };

// Input 258
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/14/14
 * Time: 11:55 AM
 */

goog.provide('epiviz.ui.charts.transform.clustering.EuclideanMetric');

/**
 * @constructor
 * @implements {epiviz.ui.charts.transform.clustering.ClusteringMetric}
 */
epiviz.ui.charts.transform.clustering.EuclideanMetric = function() {};

/**
 * @param {?Array.<number>} item1
 * @param {?Array.<number>} item2
 * @returns {?number}
 */
epiviz.ui.charts.transform.clustering.EuclideanMetric.prototype.distance = function(item1, item2) {
  if (item1 == undefined || item2 == undefined) {
    return null;
  }

  var len = item1.length; // Assume item1.length == item2.length

  var nDimensions = 0;
  var meanDimDif = 0;
  var dist = 0;

  var i;
  for (i = 0; i < len; ++i) {
    if (item1[i] == undefined || item2[i] == undefined) { continue; }

    ++nDimensions;
    var dif = item1[i] - item2[i];
    meanDimDif += dif;
    dist += dif * dif;
  }

  if (nDimensions > 0) {
    meanDimDif /= nDimensions;
  }

  // All undefined dimensions are replaced with the mean dimension difference
  dist += (len - nDimensions) * meanDimDif * meanDimDif;

  return dist;
};

/**
 * @returns {string}
 */
epiviz.ui.charts.transform.clustering.EuclideanMetric.prototype.id = function() { return 'euclidean'; };

// Input 259
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/14/14
 * Time: 11:21 AM
 */

goog.provide('epiviz.ui.charts.transform.clustering.HierarchicalClusteringAlgorithm');

/**
 * @interface
 */
epiviz.ui.charts.transform.clustering.HierarchicalClusteringAlgorithm = function() {};

/**
 * @param {Array.<Array.<number>>} data An array of rows representing multidimensional items
 * @param {epiviz.ui.charts.transform.clustering.ClusteringMetric} metric
 * @param {epiviz.ui.charts.transform.clustering.ClusteringLinkage} linkage
 * @returns {epiviz.ui.charts.transform.clustering.ClusterTree}
 */
epiviz.ui.charts.transform.clustering.HierarchicalClusteringAlgorithm.prototype.cluster = function(data, metric, linkage) {};

/**
 * @returns {string}
 */
epiviz.ui.charts.transform.clustering.HierarchicalClusteringAlgorithm.prototype.id = function() {};

// Input 260
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/14/14
 * Time: 11:28 AM
 */

goog.provide('epiviz.ui.charts.transform.clustering.ClusterTree');

/**
 * @param {epiviz.ui.charts.transform.clustering.ClusterNode} root
 * @param {Array.<Array.<number>>} data
 * @constructor
 */
epiviz.ui.charts.transform.clustering.ClusterTree = function(root, data) {
  /**
   * @type {epiviz.ui.charts.transform.clustering.ClusterNode}
   * @private
   */
  this._root = root;

  /**
   * @type {Array.<Array.<number>>}
   * @private
   */
  this._data = data;
};

/**
 * @returns {epiviz.ui.charts.transform.clustering.ClusterNode}
 */
epiviz.ui.charts.transform.clustering.ClusterTree.prototype.root = function() { return this._root; };

/**
 * @returns {Array.<Array.<number>>}
 */
epiviz.ui.charts.transform.clustering.ClusterTree.prototype.orderedData = function() {
  if (!this._root.sorted()) {
    this._root.sort(true);
  }

  var orderedIndices = this._root.data();
  var orderedData = [];
  for (var i = 0; i < orderedIndices.length; ++i) {
    orderedData.push(this._data[orderedIndices[i]]);
  }

  return orderedData;
};

// Input 261
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/14/14
 * Time: 11:24 AM
 */

goog.provide('epiviz.ui.charts.transform.clustering.ClusteringMetric');

/**
 * @interface
 */
epiviz.ui.charts.transform.clustering.ClusteringMetric = function() {};

/**
 * @param {Array.<number>} item1
 * @param {Array.<number>} item2
 * @returns {number}
 */
epiviz.ui.charts.transform.clustering.ClusteringMetric.prototype.distance = function(item1, item2) {};

/**
 * @returns {string}
 */
epiviz.ui.charts.transform.clustering.ClusteringMetric.prototype.id = function() {};

// Input 262
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/14/14
 * Time: 11:53 AM
 */

goog.provide('epiviz.ui.charts.transform.clustering.CompleteLinkage');

/**
 * @constructor
 * @implements {epiviz.ui.charts.transform.clustering.ClusteringLinkage}
 */
epiviz.ui.charts.transform.clustering.CompleteLinkage = function() {};

/**
 * @param {Array.<Array.<number>>} distances
 * @param {Array.<number>} indices
 * @returns {Array.<Array.<number>>}
 */
epiviz.ui.charts.transform.clustering.CompleteLinkage.prototype.link = function(distances, indices) {
  var ret = new Array(distances.length - 1);

  if (indices[0] < indices[1]) {
    var aux = indices[0];
    indices[0] = indices[1];
    indices[1] = aux;
  }

  for (var i = 0, j = 0; i < distances.length; ++i, ++j) {
    if (i == indices[0] || i == indices[1]) {
      --j;
      continue;
    }
    ret[j] = distances[i].slice(0);
    ret[j].splice(indices[0], 1);
    ret[j].splice(indices[1], 1);

    var vals = [
      i < indices[0] ? distances[i][indices[0]] : distances[indices[0]][i],
      i < indices[1] ? distances[i][indices[1]] : distances[indices[1]][i]
    ];
    ret[j].push(Math.max(vals[0], vals[1]));
  }

  ret[ret.length - 1] = new Array(ret.length);

  return ret;
};

/**
 * @returns {string}
 */
epiviz.ui.charts.transform.clustering.CompleteLinkage.prototype.id = function() { return 'complete'; };

// Input 263
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/31/14
 * Time: 12:44 PM
 */

goog.provide('epiviz.ui.controls.DatasourceGroupWizardStep');

goog.require('epiviz.ui.controls.DataTable');
/**
 * @constructor
 * @implements {epiviz.ui.controls.Wizard.Step}
 */
epiviz.ui.controls.DatasourceGroupWizardStep = function() {
  /**
   * @type {?epiviz.ui.controls.DataTable}
   * @private
   */
  this._dataTable = null;

  /**
   * @type {epiviz.ui.controls.VisConfigSelection}
   * @private
   */
  this._data = null;
};

/**
 * @param {jQuery} container
 * @param {epiviz.ui.controls.VisConfigSelection} data
 */
epiviz.ui.controls.DatasourceGroupWizardStep.prototype.initialize = function(container, data) {
  this._data = data;

  container.find('.epiviz-data-table').remove();

  var columns = [
    new epiviz.ui.controls.DataTable.Column('datasourceGroup', 'Data Source Group', epiviz.ui.controls.DataTable.ColumnType.STRING)
  ];

  var datasourceGroups = {};
  data.measurements.foreach(function(m) {
    if (data.dataprovider && data.dataprovider != m.dataprovider()) { return; }
    if (data.annotation) {
      for (var key in data.annotation) {
        if (!data.annotation.hasOwnProperty(key)) { continue; }
        if (!m.annotation() || m.annotation()[key] != data.annotation[key]) { return; }
      }
    }

    datasourceGroups[m.datasourceGroup()] = true;
  });

  this._dataTable = new epiviz.ui.controls.DataTable(container, columns, new epiviz.utils.IterableArray(Object.keys(datasourceGroups)), function(v) { return v; });
  this._dataTable.initialize();
};

/**
 * Gets the selected datasource group, or, if
 * there is an error, success is set to false and errorMessage contains
 * the details of the error that occurred.
 *
 * @returns {{
 *   error: string=,
 *   data: epiviz.ui.controls.VisConfigSelection=}}
 */
epiviz.ui.controls.DatasourceGroupWizardStep.prototype.next = function() {
  var selectedRows = this._dataTable ? this._dataTable.selectedRows() : [];
  if (selectedRows.length == 0) {
    return {
      error: 'No rows selected'
    };
  }

  this._data.datasourceGroup = selectedRows[0];

  var copy = new epiviz.ui.controls.VisConfigSelection(
    this._data.measurements.subset(function(m) { return m.datasourceGroup() == selectedRows[0]; }),
    this._data.datasource,
    this._data.datasourceGroup,
    this._data.dataprovider,
    this._data.annotation ? epiviz.utils.mapCopy(this._data.annotation) : this._data.annotation,
    this._data.defaultChartType,
    this._data.minSelectedMeasurements,
    this._data.customData
  );

  return {
    data: copy
  };
};

epiviz.ui.controls.DatasourceGroupWizardStep.prototype.title = function() {
  return 'Select Datasource Group';
};

// Input 264
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/30/14
 * Time: 9:33 PM
 */

goog.provide('epiviz.ui.controls.DataTable');

goog.require('epiviz.ui.controls.Control');

/**
 * @param {jQuery} container
 * @param {Array.<epiviz.ui.controls.DataTable.Column>} columns
 * @param {Iterable.<T>} rows
 * @param {function(T, epiviz.ui.controls.DataTable.Column): number|string} rowParser
 * @param {boolean} [multiselect]
 * @param {boolean} [showColumnSelector]
 * @constructor
 * @extends {epiviz.ui.controls.Control}
 * @template T
 */
epiviz.ui.controls.DataTable = function(container, columns, rows, rowParser, multiselect, showColumnSelector) {
  // Call superclass constructor
  epiviz.ui.controls.Control.call(this, container);

  /**
   * @type {Array.<epiviz.ui.controls.DataTable.Column>}
   * @private
   */
  this._columns = columns;

  /**
   * @type {Iterable.<T>}
   * @private
   */
  this._rows = rows;

  /**
   * @type {Array.<T>}
   * @private
   */
  this._rowsArray = [];

  var self = this;
  this._rows.foreach(function(row) { self._rowsArray.push(row); });

  /**
   * @type {function(T, epiviz.ui.controls.DataTable.Column): number|string}
   * @private
   */
  this._rowParser = rowParser;

  /**
   * @type {boolean}
   * @private
   */
  this._multiselect = multiselect || false;

  /**
   * @type {boolean}
   * @private
   */
  this._showColumnSelector = showColumnSelector || false;

  /**
   * @type {?jQuery}
   * @private
   */
  this._table = null;

  /**
   * @type {?jQuery}
   * @private
   */
  this._columnSelector = null;

  /**
   * @type {Array.<number>}
   * @private
   */
  this._selectedIndices = [];

  /**
   * @type {Object.<number, boolean>}
   * @private
   */
  this._selectedIndicesMap = {};

  // Helper members used for selection

  /**
   * @type {?Array.<HTMLElement>}
   * @private
   */
  this._selectList = null;

  /**
   * @type {?Array.<HTMLElement>}
   * @private
   */
  this._deselectList = null;

  /**
   * @type {?HTMLElement}
   * @private
   */
  this._lastSelection = null;
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.DataTable.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Control.prototype);
epiviz.ui.controls.DataTable.constructor = epiviz.ui.controls.DataTable;

/**
 * @enum {string}
 */
epiviz.ui.controls.DataTable.ColumnType = {
  STRING: 'string',
  NUMBER: 'number',
  BOOLEAN: 'boolean'
};

epiviz.ui.controls.DataTable.prototype.initialize = function() {
  this._container.append('<div class="epiviz-data-table"><table style="width: 100%!important;"><thead></thead><tbody></tbody><tfoot></tfoot></table></div>');
  this._table = this._container.find('table');
  var thead = this._table.find('thead');
  var tfoot = this._table.find('tfoot');
  var tbody = this._table.find('tbody');

  var headFootContent = sprintf('<tr><th>%s</th></tr>', this._columns.join('</th><th>'));
  thead.append(headFootContent);
  tfoot.append(headFootContent);

  var self = this;
  this._rows.foreach(
    /** @param {T} row */
    function(row) {
      var rowHtml = '';
      for (var i = 0; i < self._columns.length; ++i) {
        rowHtml += sprintf('<td>%s</td>', self._rowParser(row, self._columns[i]));
      }
      tbody.append(sprintf('<tr>%s</tr>', rowHtml));
    });

  var j;
  var columnFilterTypes = new Array(this._columns.length);
  for (j = 0; j < this._columns.length; ++j) {
    columnFilterTypes[j] = {
      type: 'text',
      bRegex: true,
      bSmart: true
    };
  }

  this._table.dataTable({
    bJQueryUI: true,
    sDom: '<"H"lfr>Tt<"F"ip>',
    oTableTools: {
      //'sSwfPath': 'src/jquery/DataTables-1.9.4/extras/TableTools/media/swf/copy_csv_xls_pdf.swf',
      sRowSelect: this._multiselect ? 'multi' : 'single',
      aButtons: ['select_all'],

      fnPreRowSelect: function(e, nodes, isSelect) { return self._preRowSelect(this, e, nodes, isSelect); },
      fnRowSelected:  function(nodes) { return self._select(this, nodes); },
      fnRowDeselected: function(nodes) { return self._select(this, nodes); }
    }
  }).columnFilter({ aoColumns: columnFilterTypes });

  var visibleIndex = -1;
  for (j = 0; j < this._columns.length; ++j) {
    if (this._columns[j].isVisible) { ++visibleIndex; }
    this._table.fnSetColumnVis(j, this._columns[j].isVisible);
    if (!this._columns[j].defaultFilter) { continue; }
    this._table.fnFilter(this._columns[j].defaultFilter, j, true, true);
    this._table
      .find('tfoot')
      .find(sprintf('th:eq(%s)', visibleIndex))
      .find('input')
      .removeClass('search_init')
      .val(this._columns[j].defaultFilter);
  }

  // Hack
  this._container.find('.ui-buttonset').first().attr('style', 'position: absolute!important;');

  if (this._showColumnSelector) {
    var colSelectorCls = 'epiviz-data-table-column-selector';
    this._container.find('.fg-toolbar').first().append(sprintf(
      '<div style="float: right; margin-right: 5px;">' +
        '<label>Selected Columns: </label>' +
        '<select class="%s" multiple="multiple" style="">' +
          '<option value="-1">All</option>' +
        '</select>' +
      '</div>', colSelectorCls));

    this._columnSelector = this._container.find('.' + colSelectorCls);
    for (var i = 0; i < this._columns.length; ++i) {
      var option = sprintf('<option value="%s"%s%s>%s</option>',
        i,
        this._columns[i].isVisible ? ' selected="selected"' : '',
        this._columns[i].isFixed ? ' disabled="disabled"' : '',
        this._columns[i].name);

      this._columnSelector.append(option);
    }

    this._columnSelector.dropdownchecklist({
      width: '80px',
      firstItemChecksAll: true,
      onComplete: function(selector) { self._selectColumns(selector); }
    });
  }
};

/**
 * @returns {Array.<number>}
 */
epiviz.ui.controls.DataTable.prototype.selectedIndices = function() {
  return this._selectedIndices || [];
};

/**
 * @returns {Array.<T>}
 */
epiviz.ui.controls.DataTable.prototype.selectedRows = function() {
  if (!this._selectedIndices) { return []; }

  var result = new Array(this._selectedIndices.length);
  for (var i = 0; i < this._selectedIndices.length; ++i) {
    result[i] = this._rowsArray[this._selectedIndices[i]];
  }

  return result;
};

/**
 * @param {TableTools} tableTools
 * @param {jQuery.Event} e
 * @param {Array.<HTMLElement>} nodes
 * @param {boolean} isSelect
 * @returns {boolean}
 * @private
 */
epiviz.ui.controls.DataTable.prototype._preRowSelect = function(tableTools, e, nodes, isSelect) {
  if (e) {
    this._selectList = this._deselectList = null;
    if (e.shiftKey && nodes.length == 1) {
      this._deselectList = tableTools.fnGetSelected();
      if (!this._lastSelection) { this._lastSelection = nodes[0]; }
      this._selectList = this._getRangeOfRows(this._lastSelection, nodes[0]);
    } else {
      this._lastSelection = nodes[0];
      if (!e.ctrlKey && !e.metaKey) {
        this._deselectList = tableTools.fnGetSelected();
        if (!isSelect) {
          this._selectList = nodes;
        }
      }
    }
  }
  return true;
};

/**
 * @param {HTMLElement} fromNode
 * @param {HTMLElement} toNode
 * @returns {?Array.<HTMLElement>}
 * @private
 */
epiviz.ui.controls.DataTable.prototype._getRangeOfRows = function(fromNode, toNode) {
  var
    fromPos = this._table.fnGetPosition(fromNode),
    toPos = this._table.fnGetPosition(toNode),
    oSettings = this._table.fnSettings(),
    fromIndex = $.inArray(fromPos, oSettings.aiDisplay),
    toIndex = $.inArray(toPos, oSettings.aiDisplay),
    result = [];

  if (fromIndex >= 0 && toIndex >= 0) {
    for (var i = Math.min(fromIndex, toIndex); i <= Math.max(fromIndex, toIndex); ++i) {
      var dataIndex = oSettings.aiDisplay[i];
      result.push(oSettings.aoData[dataIndex].nTr);
    }
  }
  return (result.length > 0) ? result : null;
};

/**
 * @param {TableTools} tableTools
 * @param {Array.<HTMLElement>} nodes
 * @returns {boolean}
 * @private
 */
epiviz.ui.controls.DataTable.prototype._select = function(tableTools, nodes) {
  var nodeList;
  if (this._deselectList) {
    nodeList = this._deselectList;
    this._deselectList = null;
    tableTools.fnDeselect(nodeList);
  }
  if (this._selectList) {
    nodeList = this._selectList;
    if (!this._multiselect && nodeList.length > 0) {
      nodeList = [nodeList[nodeList.length - 1]];}
    this._selectList = null;
    tableTools.fnSelect(nodeList);
  }

  var selection = tableTools.fnGetSelected();

  // We want to maintain order of selected indices, so we'll remove from the
  // _selectedIndices member the indices that have been deselected, and
  // add the new ones.

  var selectedIndices = new Array(selection.length);
  var selectedIndicesMap = {};

  var i;
  for (i = 0; i < selection.length; ++i) {
    selectedIndices[i] = this._table.fnGetPosition(selection[i]);
    selectedIndicesMap[selectedIndices[i]] = true;
  }

  // Remove indices corresponding to deselected nodes
  for (i = 0; i < this._selectedIndices.length; ++i) {
    if (!selectedIndicesMap[this._selectedIndices[i]]) {
      delete this._selectedIndicesMap[this._selectedIndices[i]];
      this._selectedIndices.splice(i, 1);
      --i;
    }
  }

  // Add indices corresponding to newly selected nodes
  for (i = 0; i < selectedIndices.length; ++i) {
    if (!this._selectedIndicesMap[selectedIndices[i]]) {
      this._selectedIndicesMap[selectedIndices[i]] = true;
      this._selectedIndices.push(selectedIndices[i]);
    }
  }

  return true;
};

/**
 * @param selector
 * @private
 */
epiviz.ui.controls.DataTable.prototype._selectColumns = function(selector) {
  var selectedIndices = {}, i;
  for(i = 0; i < selector.options.length; ++i) {
    if (selector.options[i].selected && selector.options[i].value) {
      selectedIndices[parseInt(selector.options[i].value)] = true;
    }
  }

  for (i = 0; i < this._columns.length; ++i) {
    this._table.fnSetColumnVis(i, selectedIndices[i] || this._columns[i].isFixed);
  }
};

goog.provide('epiviz.ui.controls.DataTable.Column');

/**
 * @param {string} id
 * @param {string} name
 * @param {epiviz.ui.controls.DataTable.ColumnType} type
 * @param {boolean} [isHidden]
 * @param {boolean} [isFixed]
 * @param {string} [defaultFilter]
 * @constructor
 * @struct
 */
epiviz.ui.controls.DataTable.Column = function(id, name, type, isHidden, isFixed, defaultFilter) {
  this.id = id;
  this.name = name;
  this.type = type;
  this.isVisible = !(isHidden);
  this.isFixed = isFixed || false;
  this.defaultFilter = defaultFilter || '';
};

/**
 * @returns {string}
 */
epiviz.ui.controls.DataTable.Column.prototype.toString = function() { return this.name; };

// Input 265
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/17/14
 * Time: 12:15 PM
 */

goog.provide('epiviz.ui.controls.ColorPickerDialog');

goog.require('epiviz.ui.controls.Dialog');
goog.require('epiviz.ui.charts.ColorPalette');

/**
 * @param {{ok: function(epiviz.ui.charts.ColorPalette), cancel: function(), reset: function()}} handlers
 * @param {Array.<string>} names A list of measurement names
 * @param {Array.<epiviz.ui.charts.ColorPalette>} palettes
 * @param {epiviz.ui.charts.ColorPalette} selectedPalette
 * @constructor
 * @extends {epiviz.ui.controls.Dialog}
 */
epiviz.ui.controls.ColorPickerDialog = function(handlers, names, palettes, selectedPalette) {
  epiviz.ui.controls.Dialog.call(this, 'Pick Colors', handlers);

  this._dialog = $('#' + this._id);

  this._dialog.append(
    '<div class="color-picker-form" action="" style="width: 420px;">' +
      '<div class="chart-picker" style="float: right;"></div>' +
    '</div>');

  var colorPickerForm = this._dialog.find('.color-picker-form');
  var tableContent = '';
  for (var i = 0; i < names.length; ++i) {
    var inputClass = sprintf('color-%s', i);
    tableContent += sprintf(
      '<tr>' +
        '<td><label>%s:&nbsp;</label></td>' +
        '<td><input type="text" name="%s" class="colorwell %s" value="%s" /></td>' +
      '</tr>',
      names[i], inputClass, inputClass,
      selectedPalette.keyColorIndex(names[i]) >= 0 ?
        selectedPalette.getByKey(names[i]) : selectedPalette.get(i)
    );
  }
  colorPickerForm.append(sprintf('<table class="color-picker-table">%s</table>', tableContent));

  var f = $.farbtastic(sprintf('#%s .chart-picker', this._id));
  var p = $(sprintf('#%s .chart-picker', this._id)).css('opacity', 0.25);
  var selected;
  $(sprintf('#%s .colorwell', this._id))
    .each(function () { f.linkTo(this); $(this).css('opacity', 0.75); })
    .focus(function() {
      if (selected) {
        $(selected).css('opacity', 0.75).removeClass('colorwell-selected');
      }
      f.linkTo(this);
      p.css('opacity', 1);
      $(selected = this).css('opacity', 1).addClass('colorwell-selected');
    });

  colorPickerForm.append('<select class="palettes-selector"></select>');
  var palettesSelector = colorPickerForm.find('.palettes-selector');
  var palettesMap = {};
  if (palettes) {
    palettes.forEach(function(palette) {
      palettesSelector.append(sprintf('<option value="%s"%s>%s</option>',
        palette.id(), palette.id() == selectedPalette.id() ? ' selected="selected"' : '', palette.name()));
      palettesMap[palette.id()] = palette;
    });
  }
  if (!(selectedPalette.id() in palettesMap)) {
    palettesSelector.prepend(sprintf('<option value="%s" selected="selected">%s</option>',
      selectedPalette.id(), selectedPalette.name()));
    palettesMap[selectedPalette.id()] = selectedPalette;
  }
  palettesSelector.selectmenu({
    style: 'popup',
    width: '200',
    maxHeight: '150',
    menuWidth: '200'
  });

  var updateColorFields = function() {
    var inputs = colorPickerForm.find('.colorwell');
    for (var i = 0; i < inputs.length; ++i) {
      var input = inputs[i];

      // First, connect farbtastic to this input
      f.linkTo($(input));

      // Use farbtastic to modify this input
      f.setColor(selectedPalette.get(i));
    }

    // Reconnect farbtastic to the selected input
    // so that it receives focus once again
    if (selected) {f.linkTo(selected); }
  };

  palettesSelector.change(function() {
    selectedPalette = palettesMap[$(this).val()];
    updateColorFields();
  });

  var self = this;

  this._dialog.dialog({
    autoOpen: false,
    resizable: false,
    width: '440',
    buttons: {
      Ok: function() {
        var inputs = colorPickerForm.find('.colorwell');

        var paletteChanged = false;
        var colors = [];

        var i;
        for (i = 0; i < selectedPalette.size(); ++i) {
          colors.push(selectedPalette.get(i));
        }

        for (i = 0; i < inputs.length; ++i) {
          var userVal = inputs[i].value;
          var index = selectedPalette.keyColorIndex(names[i]);
          if (index < 0) { index = i; }

          if (userVal != colors[index]) {
            paletteChanged = true;
            colors[index] = userVal;
          }
        }

        if (paletteChanged) { selectedPalette = new epiviz.ui.charts.ColorPalette(colors, undefined, undefined, selectedPalette.keyIndices()); }
        self._handlers.ok(selectedPalette);

        $(this).dialog('close');
      },
      Cancel: function() {
        self._handlers.cancel();
        $(this).dialog('close');
      },
      Reset: function() {
        updateColorFields();

        self._handlers.reset();
      }
    },
    modal: true
  });
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.ColorPickerDialog.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Dialog.prototype);
epiviz.ui.controls.ColorPickerDialog.constructor = epiviz.ui.controls.ColorPickerDialog;

/**
 */
epiviz.ui.controls.ColorPickerDialog.prototype.show = function() {
  epiviz.ui.controls.Dialog.prototype.show.call(this);

  var self = this;
  if (this._dialog) {
    this._dialog.dialog('open');

    this._dialog.dialog('option', 'position', 'center');

    // This makes the dialog only able to open once:
    this._dialog.dialog({
      close: function(event, ui) {
        $(this).remove();
        self._dialog = null;
      }
    });
  }
};

// Input 266
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/1/14
 * Time: 3:31 PM
 */

goog.provide('epiviz.ui.controls.VisConfigSelection');

/**
 * @param {epiviz.measurements.MeasurementSet} [measurements]
 * @param {string} [datasource]
 * @param {string} [datasourceGroup]
 * @param {string} [dataprovider]
 * @param {Object.<string, string>} [annotation]
 * @param {string} [defaultChartType]
 * @param {number} [minSelectedMeasurements]
 * @param {T} [customData]
 * @constructor
 * @struct
 * @template T
 */
epiviz.ui.controls.VisConfigSelection = function(measurements, datasource, datasourceGroup, dataprovider, annotation, defaultChartType, minSelectedMeasurements, customData) {
  /**
   * @type {epiviz.measurements.MeasurementSet}
   */
  this.measurements = measurements;

  /**
   * @type {string}
   */
  this.datasource = datasource;

  /**
   * @type {string}
   */
  this.datasourceGroup = datasourceGroup;

  /**
   * @type {string}
   */
  this.dataprovider = dataprovider;

  /**
   * @type {Object.<string, string>}
   */
  this.annotation = annotation;

  /**
   * @type {string}
   */
  this.defaultChartType = defaultChartType;

  /**
   * @type {number}
   */
  this.minSelectedMeasurements = minSelectedMeasurements || 1;

  /**
   * @type {T}
   */
  this.customData = customData;
};

// Input 267
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/29/14
 * Time: 4:36 PM
 */

goog.provide('epiviz.ui.controls.CustomSettingsDialog');

goog.require('epiviz.ui.controls.Dialog');
goog.require('epiviz.utils');
goog.require('epiviz.ui.charts.CustomSetting');
goog.require('epiviz.ui.controls.MessageDialog');

/**
 * @param {string} title
 * @param {{ok: function(Object.<string, *>), cancel: function()}} handlers
 * @param {Array.<epiviz.ui.charts.CustomSetting>} customSettingsDefs
 * @param {Object.<string, *>} customSettingsValues
 * @constructor
 * @extends {epiviz.ui.controls.Dialog}
 */
epiviz.ui.controls.CustomSettingsDialog = function(title, handlers, customSettingsDefs, customSettingsValues) {
  epiviz.ui.controls.Dialog.call(this, title, handlers);

  /**
   * @type {Array.<epiviz.ui.charts.CustomSetting>}
   * @private
   */
  this._customSettingsDefs = customSettingsDefs;

  /**
   * @type {Object.<string, *>}
   * @private
   */
  this._customSettingsValues = epiviz.utils.mapCopy(customSettingsValues);
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.CustomSettingsDialog.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Dialog.prototype);
epiviz.ui.controls.CustomSettingsDialog.constructor = epiviz.ui.controls.CustomSettingsDialog;

/**
 */
epiviz.ui.controls.CustomSettingsDialog.prototype.show = function() {
  epiviz.ui.controls.Dialog.prototype.show.call(this);

  var SettingType = epiviz.ui.charts.CustomSetting.Type;

  if (!this._dialog) {
    var self = this;
    this._dialog = $('#' + this._id);
    this._dialog.css('display', 'inline');

    var i, inputId, input, value;
    var content = '';
    for (i = 0; i < this._customSettingsDefs.length; ++i) {
      inputId = sprintf('%s-%s', this._id, this._customSettingsDefs[i].id);
      var row = sprintf(
        '<tr><td><label for="%s">%s</label></td><td style="text-align: right;">%%s</td></tr>',
        inputId, this._customSettingsDefs[i].label);

      input = null;
      value = this._customSettingsValues[this._customSettingsDefs[i].id];
      switch (this._customSettingsDefs[i].type) {
        case SettingType.BOOLEAN:
          row = sprintf(row, sprintf(
            '<div id="%1$s">' +
              '<label for="%1$s-true">On</label>' +
              '<input type="radio" id="%1$s-true" name="%1$s" %2$s />' +
              '<label for="%1$s-false">Off</label>' +
              '<input type="radio" id="%1$s-false" name="%1$s" %3$s />' +
              '</div>', inputId, value ? 'checked="checked"' : '', value ? '' : 'checked="checked"'));
          break;

        case SettingType.ARRAY:
          row = sprintf(row, sprintf(
            '<input id="%s" value="%s" class="ui-widget-content ui-corner-all" style="text-align: right; padding: 5px;" />', inputId, value.join(',')));
          break;
        case SettingType.NUMBER:
        case SettingType.STRING:
          row = sprintf(row, sprintf(
            '<input id="%s" value="%s" class="ui-widget-content ui-corner-all" style="text-align: right; padding: 5px;" />', inputId, value));
          break;
        case SettingType.CATEGORICAL:
        case SettingType.MEASUREMENTS_METADATA:
        case SettingType.MEASUREMENTS_ANNOTATION:
          var optionFormat = '<option value="%1$s"%2$s>%1$s</option>';
          var options = '';
          var def = this._customSettingsDefs[i];
          if (def.possibleValues) {
            for (var j = 0; j < def.possibleValues.length; ++j) {
              options += sprintf(optionFormat, def.possibleValues[j], def.possibleValues[j] == value ? 'selected="selected"' : '');
            }
          }
          var selector = sprintf('<select id="%s">%s</select>', inputId, options);
          row = sprintf(row, selector);
          break;
      }

      content += row;
    }
    content = sprintf('<div style="margin: 5px; padding: 5px; height: auto;"><table style="width: 100%%;">%s</table></div>', content);

    this._dialog.append(content);

    // Add jQuery UI properties to fields
    for (i = 0; i < this._customSettingsDefs.length; ++i) {
      inputId = sprintf('%s-%s', this._id, this._customSettingsDefs[i].id);
      input = $('#' + inputId);
      value = this._customSettingsValues[this._customSettingsDefs[i].id];
      switch (this._customSettingsDefs[i].type) {
        case SettingType.BOOLEAN:
          input.buttonset();
          break;

        case SettingType.NUMBER:
        case SettingType.ARRAY:
        case SettingType.STRING:
          input.watermark(this._customSettingsDefs[i].label);
          break;
        case SettingType.CATEGORICAL:
        case SettingType.MEASUREMENTS_METADATA:
        case SettingType.MEASUREMENTS_ANNOTATION:
          input.selectmenu();
      }
    }


    this._dialog.dialog({
      autoOpen: false,
      resizable: false,
      //width: '600',
      buttons: {
        Ok: function() {
          for (var i = 0; i < self._customSettingsDefs.length; ++i) {
            inputId = sprintf('%s-%s', self._id, self._customSettingsDefs[i].id);
            input = $('#' + inputId);
            var newValue = null;
            if (input.val() == epiviz.ui.charts.CustomSetting.DEFAULT) {
              newValue = self._customSettingsDefs[i].defaultValue;
            } else {
              var errorDialog = null;
              try {
                switch (self._customSettingsDefs[i].type) {
                  case SettingType.BOOLEAN:
                    var checked = $('#' + inputId + ' :radio:checked').attr('id');
                    newValue = checked.substr(checked.lastIndexOf('-')+1) == 'true';
                    break;

                  case SettingType.NUMBER:
                    newValue = (input.val() == epiviz.ui.charts.CustomSetting.DEFAULT) ?
                      self._customSettingsDefs[i].defaultValue :
                      parseFloat(input.val());
                    if (isNaN(newValue)) {
                      errorDialog = new epiviz.ui.controls.MessageDialog(
                        'Invalid property value',
                        { Ok: function() {} },
                        sprintf('Invalid value for setting "%s" (%s)', self._customSettingsDefs[i].label, self._customSettingsDefs[i].id),
                        epiviz.ui.controls.MessageDialog.Icon.ERROR);
                      errorDialog.show();
                      return;
                    }
                    break;
                  case SettingType.ARRAY:
                    newValue = input.val().split(/[\s,]+/g);
                    break;
                  case SettingType.STRING:
                  case SettingType.CATEGORICAL:
                  case SettingType.MEASUREMENTS_METADATA:
                  case SettingType.MEASUREMENTS_ANNOTATION:
                    newValue = input.val();
                    break;
                }
              } catch (error) {
                errorDialog = new epiviz.ui.controls.MessageDialog(
                  'Invalid property value',
                  { Ok: function() {} },
                  sprintf('Invalid value for setting "%s" (%s)', self._customSettingsDefs[i].label, self._customSettingsDefs[i].id),
                  epiviz.ui.controls.MessageDialog.Icon.ERROR);
                errorDialog.show();
                return;
              }
            }

            self._customSettingsValues[self._customSettingsDefs[i].id] = newValue;
          }

          self._handlers.ok(self._customSettingsValues);
          $(this).dialog('close');
        },
        Cancel: function() {
          self._handlers.cancel();
          $(this).dialog('close');
        }
      },
      modal: true
    });

    // This makes the dialog only able to open once:
    this._dialog.dialog({
      close: function(event, ui) {
        $(this).remove();
        self._dialog = null;
      }
    });
  }

  this._dialog.dialog('open');

  this._dialog.dialog('option', 'position', 'center');
};

// Input 268
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/6/2015
 * Time: 1:50 PM
 */

goog.provide('epiviz.ui.controls.CodeControl');

goog.require('epiviz.ui.controls.Control');

/**
 * @param {jQuery} container
 * @param {string} [title]
 * @param {string} [id]
 * @param {Object} [targetObject]
 * @constructor
 * @extends {epiviz.ui.controls.Control}
 */
epiviz.ui.controls.CodeControl = function(container, title, id, targetObject) {
  // Call superclass constructor
  epiviz.ui.controls.Control.call(this, container, title, id);

  /**
   * @type {Object}
   * @protected
   */
  this._targetObj = targetObject;

  /**
   * @type {string}
   * @protected
   */
  this._text = '// TODO: Your code here\n';
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.CodeControl.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Control.prototype);
epiviz.ui.controls.CodeControl.constructor = epiviz.ui.controls.CodeControl;

epiviz.ui.controls.CodeControl.prototype.initialize = function() {};

/**
 */
epiviz.ui.controls.CodeControl.prototype.save = function() {};

/**
 */
epiviz.ui.controls.CodeControl.prototype.revert = function() {};

/**
 * @returns {string}
 */
epiviz.ui.controls.CodeControl.prototype.text = function() { return this._text; };

/**
 * @returns {*}
 */
epiviz.ui.controls.CodeControl.prototype.result = function() { return null; };

// Input 269
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 4/1/14
 * Time: 9:32 AM
 */

goog.provide('epiviz.ui.controls.MeaurementsWizardStep');

goog.require('epiviz.ui.controls.DataTable');
goog.require('epiviz.measurements.MeasurementSet');

/**
 * @constructor
 * @implements {epiviz.ui.controls.Wizard.Step}
 */
epiviz.ui.controls.MeaurementsWizardStep = function() {
  /**
   * @type {?epiviz.ui.controls.DataTable}
   * @private
   */
  this._dataTable = null;

  /**
   * @type {epiviz.ui.controls.VisConfigSelection}
   * @private
   */
  this._data = null;

  /**
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._measurements = null;
};

/**
 * @param {jQuery} container
 * @param {epiviz.ui.controls.VisConfigSelection} data
 */
epiviz.ui.controls.MeaurementsWizardStep.prototype.initialize = function(container, data) {
  this._data = data;

  container.find('.epiviz-data-table').remove();

  var viewCount = 2;

  var ColumnType = epiviz.ui.controls.DataTable.ColumnType;
  var columns = [
    new epiviz.ui.controls.DataTable.Column('id', 'Id', ColumnType.STRING, true),
    new epiviz.ui.controls.DataTable.Column('name', 'Name', ColumnType.STRING, false, true),
    // new epiviz.ui.controls.DataTable.Column('defaultChartType', 'Default Chart Type', ColumnType.STRING, true, true),
    new epiviz.ui.controls.DataTable.Column('type', 'Type', ColumnType.STRING, true),
    new epiviz.ui.controls.DataTable.Column('datasourceId', 'Data Source', ColumnType.STRING, true),
    new epiviz.ui.controls.DataTable.Column('datasourceGroup', 'Data Source Group', ColumnType.STRING, true),
    new epiviz.ui.controls.DataTable.Column('dataprovider', 'Data Provider', ColumnType.STRING, true),
    new epiviz.ui.controls.DataTable.Column('formulaStr', 'Formula', ColumnType.STRING, true)//,
    //new epiviz.ui.controls.DataTable.Column('annotation', 'Annotation', ColumnType.STRING)
  ];

  var annotationColumns = [];
  var annotationMap = {};
  data.measurements.foreach(function(m) {
    var anno = m.annotation();
    if (anno == undefined) { return; }
    for (var annoCol in anno) {
      if (!anno.hasOwnProperty(annoCol)) { continue; }
      if (!(annoCol in annotationMap)) {
        annotationColumns.push(annoCol);
        annotationMap[annoCol] = true;
      }
    }
  });
  annotationColumns.sort();
  columns = columns.concat(annotationColumns.map(function(annoCol) {
    var hidden = false;

    if(viewCount <= 0) {
      hidden = true;
    }
    viewCount--;
    return new epiviz.ui.controls.DataTable.Column('[anno] ' + annoCol, annoCol, ColumnType.STRING, hidden)
  }));

  // Filter out measurements that don't match the given restrictions
  this._measurements = data.measurements.subset(
    function(m) {
      if (data.datasource && data.datasource != m.datasourceId()) { return false; }
      if (data.datasourceGroup && data.datasourceGroup != m.datasourceGroup()) { return false; }
      if (data.dataprovider && data.dataprovider != m.dataprovider()) { return false; }
      if (data.annotation) {
        for (var key in data.annotation) {
          if (!data.annotation.hasOwnProperty(key)) { continue; }
          if (!m.annotation() || m.annotation()[key] != data.annotation[key]) { return false; }
        }
      }
      return true;
    });

  this._dataTable = new epiviz.ui.controls.DataTable(container, columns, this._measurements,
    /**
     * @param {epiviz.measurements.Measurement} m
     * @param {epiviz.ui.controls.DataTable.Column} column
     * @returns {string|number}
     */
    function(m, column) {
      var result = null;
      if (epiviz.utils.stringStartsWith(column.id, '[anno] ')) {
        result = '';
        if (m.annotation() != undefined) { result = m.annotation()[column.name] || ''; }
      } else {
        switch (column.id) {
          case 'annotation':
            result = epiviz.utils.mapJoin(m.annotation(), ': ', '<br />');
            break;
          default:
            result = m[column.id](); // Getter with the same name
            break;
        }
      }
      if (result === 0 || result) { return result; }
      return '';
    }, true, true);
  this._dataTable.initialize();
};

/**
 * Gets the selected datasource group, or, if
 * there is an error, success is set to false and errorMessage contains
 * the details of the error that occurred.
 *
 * @returns {{
 *   error: string=,
 *   data: epiviz.ui.controls.VisConfigSelection=
 * }}
 */
epiviz.ui.controls.MeaurementsWizardStep.prototype.next = function() {
  var selectedRows = this._dataTable ? this._dataTable.selectedRows() : [];
  if (selectedRows.length < this._data.minSelectedMeasurements) {
    return {
      error: 'Minimum selected rows required is ' + this._data.minSelectedMeasurements
    };
  }

  var selectedMeasurements = new epiviz.measurements.MeasurementSet();
  for (var i = 0; i < selectedRows.length; ++i) {
    selectedMeasurements.add(selectedRows[i]);
  }
  this._data.measurements = selectedMeasurements;

  return {
    data: this._data
  };
};

epiviz.ui.controls.MeaurementsWizardStep.prototype.title = function() {
  return 'Select Measurements';
};


// Input 270
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/19/13
 * Time: 2:03 PM
 */

goog.provide('epiviz.ui.controls.Dialog');

goog.require('epiviz.utils');
/**
 * @param {string} title
 * @param {Object.<string, function>} handlers
 * @constructor
 */
epiviz.ui.controls.Dialog = function(title, handlers) {
  /**
   * @type {jQuery}
   * @protected
   */
  this._container = $('#dialogs');

  /**
   * @type {string}
   * @protected
   */
  this._title = title;

  /**
   * @type {string}
   * @protected
   */
  this._id = epiviz.ui.controls.Dialog.generateId();

  /**
   * @type {Object.<string, Function>}
   * @protected
   */
  this._handlers = handlers;

  this._container.append(sprintf('<div id="%s" title="%s" style="display: none;"></div>', this._id, this._title));

  /**
   * @type {jQuery}
   * @protected
   */
  this._dialog = null;
};

/**
 * @type {number}
 * @private
 */
epiviz.ui.controls.Dialog._nextIdIndex = 0;

/**
 * @returns {string}
 */
epiviz.ui.controls.Dialog.generateId = function() {
  return sprintf('dialog-%s', epiviz.utils.generatePseudoGUID(5));
};

/**
 */
epiviz.ui.controls.Dialog.prototype.show = function() {};

// Input 271
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/16/14
 * Time: 4:22 PM
 */

goog.provide('epiviz.ui.controls.MessageDialog');

goog.require('epiviz.ui.controls.Dialog');

/**
 * @param {string} title
 * @param {string} message
 * @param {Object.<string, function>} handlers
 * @param {epiviz.ui.controls.MessageDialog.Icon} [icon]
 * @constructor
 * @extends {epiviz.ui.controls.Dialog}
 */
epiviz.ui.controls.MessageDialog = function(title, handlers, message, icon) {
  epiviz.ui.controls.Dialog.call(this, title, handlers);

  /**
   * @type {string}
   * @private
   */
  this._message = message;

  /**
   * @type {epiviz.ui.controls.MessageDialog.Icon}
   * @private
   */
  this._icon = icon || epiviz.ui.controls.MessageDialog.Icon.INFO;
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.MessageDialog.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Dialog.prototype);
epiviz.ui.controls.MessageDialog.constructor = epiviz.ui.controls.MessageDialog;

/**
 * @enum {string}
 */
epiviz.ui.controls.MessageDialog.Icon = {
  INFO: 'info',
  ERROR: 'error',
  QUESTION: 'question'
};

/**
 */
epiviz.ui.controls.MessageDialog.prototype.show = function() {
  epiviz.ui.controls.Dialog.prototype.show.call(this);

  var Icon = epiviz.ui.controls.MessageDialog.Icon;

  if (!this._dialog) {
    var self = this;
    this._dialog = $('#' + this._id);
    this._dialog.css('display', 'inline');

    var state = this._icon == Icon.ERROR ? 'error' : 'highlight';
    var icon = this._icon == Icon.ERROR ? 'alert' : 'info';
    this._dialog.append(sprintf(
      '<div class="ui-state-%s ui-corner-all" style="margin: 5px; padding: 5px; height: auto;">' +
        '<div class="ui-icon ui-icon-%s" style="float: left; margin-right: 5px;"></div>' +
        '<div class="dialog-text">%s</div>' +
      '</div>', state, icon, this._message));

    var buttons = {};
    for (var buttonName in this._handlers) {
      if (!this._handlers.hasOwnProperty(buttonName)) { continue; }
      (function(buttonName) {
        buttons[buttonName] = function() {
          self._handlers[buttonName]();
          $(this).dialog('close');
        };
      })(buttonName);
    }

    this._dialog.dialog({
      autoOpen: false,
      resizable: false,
      //width: '600',
      buttons: buttons,
      modal: true
    });

    // This makes the dialog only able to open once:
    this._dialog.dialog({
      close: function(event, ui) {
        $(this).remove();
        self._dialog = null;
      }
    });
  }

  this._dialog.dialog('open');

  this._dialog.dialog('option', 'position', 'center');
};

// Input 272
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/16/14
 * Time: 4:22 PM
 */

goog.provide('epiviz.ui.controls.CodeDialog');

goog.require('epiviz.ui.controls.Dialog');

/**
 * @param {string} title
 * @param {{save: function(Object.<string, string>), cancel: function()}} handlers
 * @param {Array.<function(jQuery): epiviz.ui.controls.CodeControl>} controlCreators
 * @constructor
 * @extends {epiviz.ui.controls.Dialog}
 */
epiviz.ui.controls.CodeDialog = function(title, handlers, controlCreators) {
  epiviz.ui.controls.Dialog.call(this, title, handlers);

  /**
   * @type {Array.<function(jQuery): epiviz.ui.controls.CodeControl>}
   * @private
   */
  this._controlCreators = controlCreators;

  this._dialog = $('#' + this._id);

  /**
   * @type {Array.<epiviz.ui.controls.CodeControl>}
   * @private
   */
  this._controls = [];

  var self = this;
  this._dialog.append('<div class="code-tabs"><ul></ul></div>');
  var codeTabs = this._dialog.find('.code-tabs');
  var codeTabsList = codeTabs.find('ul');
  this._controlCreators.forEach(function(creator, i) {
    var id = self._id + '-code-tab-' + i;
    codeTabs.append(sprintf('<div id="%s"></div>', id));
    var tab = codeTabs.find('#' + id);
    var control = creator(tab);

    codeTabsList.append(sprintf('<li><a href="#%s">%s</a></li>', id, control.title()))
    self._controls.push(control);
  });



  codeTabs.tabs({
    activate: function(e, ui) { self._tabActivate(codeTabs); }
  });

  this._dialog.dialog({
    autoOpen: false,
    resizable: false,
    width: '800',
    buttons: {
      Save: function() {
        var results = [];
        self._controls.forEach(function(control) {
          control.save();
          results.push(control.result());
        });
        self._handlers.save(results);
        $(this).dialog('close');
      },
      Cancel: function() {
        self._controls.forEach(function(control) {
          control.revert();
        });
        self._handlers.cancel();
        $(this).dialog('close');
      }
    },
    modal: true
  });

  this._dialog.dialog('option', 'position', 'center');
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.CodeDialog.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Dialog.prototype);
epiviz.ui.controls.CodeDialog.constructor = epiviz.ui.controls.CodeDialog;

/**
 */
epiviz.ui.controls.CodeDialog.prototype.show = function() {
  epiviz.ui.controls.Dialog.prototype.show.call(this);

  this._dialog.dialog('open');

  this._controls[0].initialize();
  this._dialog.dialog('option', 'position', 'center');
};

/**
 * @param tabs
 * @private
 */
epiviz.ui.controls.CodeDialog.prototype._tabActivate = function(tabs) {
  var selectedTabIndex = tabs.tabs('option', 'active');

  this._controls[selectedTabIndex].initialize();
  this._dialog.dialog('option', 'position', 'center');
};

// Input 273
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/7/2015
 * Time: 2:01 PM
 */

goog.provide('epiviz.ui.controls.MarkerCodeControl');

goog.require('epiviz.ui.controls.CodeControl');

/**
 * @param {jQuery} container
 * @param {string} [title]
 * @param {string} [id]
 * @param {Object} [targetObject]
 * @param {string} [preFilterText]
 * @param {string} [filterText]
 * @param {boolean} [enabled]
 * @constructor
 * @extends {epiviz.ui.controls.CodeControl}
 */
epiviz.ui.controls.MarkerCodeControl = function(container, title, id, targetObject, preFilterText, filterText, enabled) {
  // Call superclass constructor
  epiviz.ui.controls.CodeControl.call(this, container, title, id, targetObject);

  /**
   * @type {CodeMirror}
   * @private
   */
  this._editor = null;

  /**
   * @type {CodeMirror}
   * @private
   */
  this._markEditor = null;

  /**
   * @type {string}
   * @private
   */
  this._editorText = preFilterText;

  /**
   * @type {string}
   * @private
   */
  this._markText = filterText;

  /**
   * @type {boolean}
   * @private
   */
  this._enabled = enabled || false;
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.MarkerCodeControl.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.CodeControl.prototype);
epiviz.ui.controls.MarkerCodeControl.constructor = epiviz.ui.controls.MarkerCodeControl;

epiviz.ui.controls.MarkerCodeControl.prototype.initialize = function() {
  if (this._editor) { return; }

  this._container.append(
    sprintf(
      '<div id="%1$s">' +
      '<label for="%1$s-true">On</label>' +
      '<input type="radio" id="%1$s-true" name="%1$s" %2$s />' +
      '<label for="%1$s-false">Off</label>' +
      '<input type="radio" id="%1$s-false" name="%1$s" %3$s />' +
      '</div>', this.id() + '-switch', this._enabled ? 'checked="checked"' : '',
      this._enabled ? '' : 'checked="checked"') +
    '<br />' +
    '<div><label><b>Pre-mark Method</b></label></div><br />' +
    '<div style="overflow-y: scroll; max-height: 250px;">' +
      '<textarea autofocus="autofocus" class="pre-filter-code"></textarea>' +
    '</div><br/>' +
    '<div><label><b>Mark Method</b></label></div><br/>' +
    '<div style="overflow-y: scroll; max-height: 250px;">' +
      '<textarea autofocus="autofocus" class="filter-code"></textarea>' +
    '</div>');

  var onOffSwitch = this._container.find('#' + this.id() + '-switch');
  onOffSwitch.buttonset();
  var self = this;
  var optionChange = function(e) {
    var optionChecked = $('#' + self.id() + '-switch :radio:checked').attr('id');
    var newValue = optionChecked.substr(optionChecked.lastIndexOf('-')+1) == 'true';
    if (self._editor) { self._editor.setOption('disableInput', !newValue); }
    if (self._markEditor) { self._markEditor.setOption('disableInput', !newValue);}
    self._enabled = newValue;
  };
  onOffSwitch.find('#' + this.id() + '-switch-true').on('change', optionChange);
  onOffSwitch.find('#' + this.id() + '-switch-false').on('change', optionChange);

  var preFilterCodeEditor = this._container.find('.pre-filter-code');
  preFilterCodeEditor.val(this._editorText);

  var filterCodeEditor = this._container.find('.filter-code');
  filterCodeEditor.val(this._markText);

  this._editor = CodeMirror.fromTextArea(preFilterCodeEditor[0], {
    lineNumbers: true,
    matchBrackets: true,
    continueComments: "Enter",
    extraKeys: {"Ctrl-Q": "toggleComment"},
    autofocus: true
  });
  this._editor.setOption('disableInput', !this._enabled);

  this._markEditor = CodeMirror.fromTextArea(filterCodeEditor[0], {
    lineNumbers: true,
    matchBrackets: true,
    continueComments: "Enter",
    extraKeys: {"Ctrl-Q": "toggleComment"},
    autofocus: true
  });
  this._markEditor.setOption('disableInput', !this._enabled);
};

/**
 */
epiviz.ui.controls.MarkerCodeControl.prototype.save = function() {
  if (!this._editor) { return; }
  this._editorText = this._editor.getValue();
  this._markText = this._markEditor.getValue();
};

/**
 */
epiviz.ui.controls.MarkerCodeControl.prototype.revert = function() {
  if (this._editor) {
    this._editor.setOption('value', this._editorText);
  }

  if (this._markEditor) {
    this._markEditor.setOption('value', this._markText);
  }
};

/**
 * @returns {{enabled: boolean, preMark: string, mark: string}}
 */
epiviz.ui.controls.MarkerCodeControl.prototype.result = function() {
  return {
    enabled: this._enabled,
    preMark: this._enabled ? this._editorText : null,
    mark: this._enabled ? this._markText : null
  }
};


// Input 274
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 10/17/13
 * Time: 11:38 AM
 */

goog.provide('epiviz.ui.controls.Control');

goog.require('epiviz.utils');

/**
 * @param {jQuery} container
 * @param {string} [title]
 * @param {string} [id]
 * @constructor
 */
epiviz.ui.controls.Control = function(container, title, id) {
  /**
   * @type {jQuery}
   * @protected
   */
  this._container = container;

  /**
   * @type {string}
   * @private
   */
  this._title = title || '';

  /**
   * @type {string}
   * @private
   */
  this._id = id || epiviz.utils.generatePseudoGUID(6);
};

/**
 */
epiviz.ui.controls.Control.prototype.initialize = function() {};

/**
 * @returns {string}
 */
epiviz.ui.controls.Control.prototype.id = function() { return this._id; };

/**
 * @returns {string}
 */
epiviz.ui.controls.Control.prototype.title = function() { return this._title; };

// Input 275
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/20/14
 * Time: 6:20 PM
 */

goog.provide('epiviz.ui.controls.ComputedMeasurementsDialog');

goog.require('epiviz.ui.controls.Dialog');
goog.require('epiviz.measurements.Measurement');
goog.require('epiviz.utils');
goog.require('epiviz.ui.controls.MessageDialog');

/**
 * @param {string} title
 * @param {{add: function(epiviz.measurements.Measurement), remove: function(epiviz.measurements.Measurement), close: function()}} handlers
 * @param {epiviz.measurements.MeasurementSet} measurements
 * @param {Object.<string, epiviz.measurements.MeasurementSet>} chartsMeasurements
 * @constructor
 * @extends {epiviz.ui.controls.Dialog}
 */
epiviz.ui.controls.ComputedMeasurementsDialog = function(title, handlers, measurements, chartsMeasurements) {
  epiviz.ui.controls.Dialog.call(this, title, handlers);

  /**
   * @type {epiviz.measurements.MeasurementSet}
   * @private
   */
  this._measurements = measurements;

  /**
   * @type {Object.<string, epiviz.measurements.MeasurementSet>}
   * @private
   */
  this._chartsMeasurements = chartsMeasurements;

  /**
   * @type {?jQuery}
   * @private
   */
  this._expressionTextBox = null;

  /**
   * @type {?jQuery}
   * @private
   */
  this._idTextBox = null;

  /**
   * @type {?jQuery}
   * @private
   */
  this._nameTextBox = null;

  /**
   * @type {?jQuery}
   * @private
   */
  this._minTextBox = null;

  /**
   * @type {?jQuery}
   * @private
   */
  this._maxTextBox = null;

  /**
   * @type {?jQuery}
   * @private
   */
  this._measurementsList = null;

  /**
   * @type {{text: boolean, icons: {primary: string}}}
   * @private
   */
  this._addButtonProperties = {
    text: false,
    icons: {
      primary: 'ui-icon ui-icon-plus'
    }
  };

  /**
   * @type {{text: boolean, icons: {primary: string}}}
   * @private
   */
  this._deleteButtonsProperties = {
    text: false,
    icons: {
      primary: 'ui-icon ui-icon-trash'
    }
  };

  /**
   * @type {?jQuery}
   * @private
   */
  this._tabs = null;

  /**
   * @type {string}
   * @private
   */
  this._selectedDatasourceGroup = null;

  /**
   * @type {Array.<epiviz.measurements.Measurement>}
   * @private
   */
  this._datasourceGroupMeasurements = null;

  this._addTabs();
  this._addDialogContents();
  this._addDatasourceGroupTable(measurements);
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Dialog.prototype);
epiviz.ui.controls.ComputedMeasurementsDialog.constructor = epiviz.ui.controls.ComputedMeasurementsDialog;

/**
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype.show = function() {
  epiviz.ui.controls.Dialog.prototype.show.call(this);

  var self = this;
  if (this._dialog) {
    this._dialog.dialog('open');
    this._dialog.dialog('option', 'position', 'center');

    // This makes the dialog only able to open once:
    this._dialog.dialog({
      close: function(event, ui) {
        $(this).remove();
        self._dialog = null;
        self._handlers.close();
      }
    });
  }
};

/**
 * @param {epiviz.measurements.MeasurementSet} measurements
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._addDatasourceGroupTable = function(measurements) {
  var self = this;
  var container = $(sprintf('#datasource-group-tab-%s', this._id));
  var rawTableCls = 'computed-measurements-dialog-raw-table';

  var table = '<table ' +
    'style="border-spacing:0; ' +
    'border-collapse:collapse; ' +
    '-webkit-touch-callout: none; ' +
    '-webkit-user-select: none; ' +
    '-khtml-user-select: none; ' +
    '-moz-user-select: moz-none; ' +
    '-ms-user-select: none; ' +
    'user-select: none; ' +
    'width: 100%%;" ' +
    'class="' + rawTableCls + '">%s</table>';

  var header = '<thead><tr><th>Data Source Group</th></tr></thead>';
  var footer = '<tfoot><tr><th>Data Source Group</th></tr></tfoot>';
  var body = '';

  /**
   * @type {Object.<string, Array.<epiviz.measurements.Measurement>>}
   */
  var measurementsByDatasourceGroup = {};

  measurements.foreach(function(m) {
    if (m.type() != epiviz.measurements.Measurement.Type.FEATURE) { return; } // continue

    if (!(m.datasourceGroup() in measurementsByDatasourceGroup)) {
      measurementsByDatasourceGroup[m.datasourceGroup()] = [];
    }

    measurementsByDatasourceGroup[m.datasourceGroup()].push(m);
  });

  for (var g in measurementsByDatasourceGroup) {
    if (!measurementsByDatasourceGroup.hasOwnProperty(g)) { continue; }

    body += sprintf('<tr><td class="center">%s</td></tr>', g);
  }

  container.append(sprintf(table, header + body + footer));

  var rawTable = container.find('.' + rawTableCls);
  var oTable = rawTable.dataTable({
    bJQueryUI: true,
    sDom: '<"H"lfr>Tt<"F"ip>',
    'oTableTools': {
      "sRowSelect": "single",
      "aButtons": [],

      "fnPreRowSelect": function(e, nodes, isSelect) {
        return true;
      },
      "fnRowSelected":   function(nodes) {
        var data = oTable.fnGetData(nodes[0]);
        self._selectedDatasourceGroup = data[0];
        self._datasourceGroupMeasurements = measurementsByDatasourceGroup[self._selectedDatasourceGroup];
      },
      "fnRowDeselected": function(nodes) {
        var data = oTable.fnGetData(nodes[0]);
        if (data == self._selectedDatasourceGroup) {
          self._selectedDatasourceGroup = null;
          self._datasourceGroupMeasurements = null;
        }
      }
    }
  });

  // Hack, to position the table at the top
  container.find('.DTTT_container').css('position', 'absolute');
};

/**
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._addTabs = function() {
  var self = this;
  this._selectDialog().append(
    '<div id="computedMeasurementsDialog" class="computed-measurements-dialog">' +
      '<div class="computed-measurements-tabs">' +
        '<ul>' +
          sprintf('<li><a href="#datasource-group-tab-%s">Data Source Group</a></li>', this._id) +
          sprintf('<li><a href="#formula-tab-%s">Expression</a></li>', this._id) +
        '</ul>' +
        sprintf('<div id="datasource-group-tab-%s"></div>', this._id) +
        sprintf('<div id="formula-tab-%s"></div>', this._id) +
      '</div>' +
    '</div>');

  this._tabs = this._selectTabs();
  this._tabs.tabs({
    activate: function(e, ui) { self._tabActivate(ui); }
  });
};

/**
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._addDialogContents = function() {
  var self = this;
  this._selectDialog().dialog({
    autoOpen: false,
    resizable: true,
    width: '600',
    height: '550',
    buttons: {
      Back: function() {
        var selectedTabIndex = self._tabs.tabs('option', 'active');
        if (selectedTabIndex == 0) { return; }

        self._tabs.tabs('option', 'active', 0);
      },
      Next: function() {
        var selectedTabIndex = self._tabs.tabs('option', 'active');
        if (selectedTabIndex == 1) { return; }

        self._tabs.tabs('option', 'active', 1);
      },
      Add: function() {
        /** @type {epiviz.utils.ExpressionParser.Expression} */
        var expr = epiviz.utils.ExpressionParser.parse(self._selectExpressionTextBox().val().trim());

        var referredMeasurements = {};
        var variables = expr.variables();
        var min = null, max = null;
        var metadata = [];
        var usedMetadata = {};

        for (var i = 0; i < variables.length; ++i) {
          var variable = variables[i];

          if (!epiviz.utils.stringStartsWith(variable, '{') || !epiviz.utils.stringEndsWith(variable, '}')) {
            // This means that the variable is something else than a measurement
            continue;
          }
          var index = parseInt(variable.substring(1, variable.length - 1));

          var m = self._datasourceGroupMeasurements[index];
          referredMeasurements[index] = m;

          if (min === null || min > m.minValue()) {
            min = m.minValue();
          }

          if (max === null || max < m.maxValue()) {
            max = m.maxValue();
          }

          if (m.metadata()) {
            for (var j = 0; j < m.metadata().length; ++j) {
              if (!usedMetadata[m.metadata()[j]]) {
                usedMetadata[m.metadata()[j]] = true;
                metadata.push(m.metadata()[j]);
              }
            }
          }
        }

        var userMin = self._selectMinTextBox().val().trim();
        var userMax = self._selectMaxTextBox().val().trim();

        min = userMin ? parseFloat(userMin) : min;
        max = userMax ? parseFloat(userMax) : max;

        var id = self._selectIdTextBox().val().trim() || epiviz.utils.generatePseudoGUID(5);
        var measurement = new epiviz.measurements.Measurement(
          id,
          self._selectNameTextBox().val().trim() || 'Unnamed [' + id + ']',
          epiviz.measurements.Measurement.Type.FEATURE,
          null, // datasourceId
          self._selectedDatasourceGroup,
          null, // data provider
          {referredMeasurements: referredMeasurements, expression: expr},
          'any',
          null,
          min,
          max,
          metadata
        );

        var nextIndex = self._datasourceGroupMeasurements.length;
        var msList = $(sprintf('#computed-measurement-measurements-%s', self._id));
        var removeButton = '<button id="delete-button-%2$s-%3$s" data-measurement="%2$s">Delete</button>';
        msList.append(sprintf(
          '<div style="min-height: 30px; padding: 2px;">' +
            '<div style="margin: 6px; float: left;">%1$s {<b>%2$s</b>}</div>' +
            '<div style="float: right;">' +
              removeButton +
              '<button style="" id="measurement-button-%2$s-%3$s" data-measurement="%2$s">Insert %2$s</button>' +
            '</div>' +
          '</div>', measurement.name(), nextIndex, self._id));

        $('#measurement-button-' + nextIndex + '-' + self._id)
          .button(self._addButtonProperties)
          .click(function() { self._addButtonClick($(this)); });
        $('#delete-button-' + nextIndex + '-' + self._id)
          .button(self._deleteButtonsProperties)
          .click(function() { self._deleteButtonClick($(this)); });

        self._datasourceGroupMeasurements.push(measurement);

        self._handlers.add(measurement);

      },
      Close: function() {
        self._handlers.close();
        $(this).dialog('close');
      }
    },
    modal: true
  });
};

/**
 * @param {jQuery} button
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._addButtonClick = function(button) {
  var measurementIndex = button.data('measurement');

  var exprBox = this._selectExpressionTextBox();
  exprBox.val(exprBox.val().trim() + ' {' + measurementIndex + '}');
};

/**
 * @param {jQuery} button
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._deleteButtonClick = function(button) {
  var measurementIndex = button.data('measurement');
  var measurement = this._datasourceGroupMeasurements[measurementIndex];
  var dialog;

  // Check if there are other measurements using this measurement.
  // If there are, display a message and don't delete it.
  for (var i = 0; i < this._datasourceGroupMeasurements.length; ++i) {
    var m = this._datasourceGroupMeasurements[i];
    if (m == null || m === measurement || !m.isComputed()) { continue; }
    if (m.componentMeasurements().contains(measurement)) {
      dialog = new epiviz.ui.controls.MessageDialog(
        'Measurement cannot be deleted',
        {
          Ok: function() {}
        },
        'There are other measurements that depend on the one selected. Please delete those before deleting this.',
        epiviz.ui.controls.MessageDialog.Icon.ERROR);
      dialog.show();
      return;
    }
  }

   // Check if there are existing charts using this measurement.
   // If there are, then display a message and don't delete it.
  for (var chartId in this._chartsMeasurements) {
    if (!this._chartsMeasurements.hasOwnProperty(chartId)) { continue; }
    if (this._chartsMeasurements[chartId].contains(measurement)) {
      dialog = new epiviz.ui.controls.MessageDialog(
        'Measurement cannot be deleted',
        {
          Ok: function() {}
        },
        'There are charts using the selected measurement. Remove them from the workspace and then try again.',
        epiviz.ui.controls.MessageDialog.Icon.ERROR);
      dialog.show();
      return;
    }
  }

  this._datasourceGroupMeasurements[measurementIndex] = null;
  button.parent().parent().remove();
  this._handlers.remove(measurement);
};

/**
 * @param ui
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._tabActivate = function(ui) {
  var selectedTabIndex = this._selectTabs().tabs('option', 'active');

  if (selectedTabIndex == 0) { return; }

  ui.newPanel.empty();

  this._idTextBox = null;
  this._nameTextBox = null;
  this._expressionTextBox = null;
  this._minTextBox = null;
  this._maxTextBox = null;
  this._measurementsList = null;

  if (!this._selectedDatasourceGroup) { return; }

  ui.newPanel.append(sprintf(
    '<label for="computed-measurement-key-%1$s"><b>Id:</b></label> ' +
    '<input id="computed-measurement-key-%1$s" class="ui-widget-content ui-corner-all" style="padding: 2px;" type="text"/>&nbsp;' +
    '<label for="computed-measurement-name-%1$s"><b>Name:</b></label> ' +
    '<input id="computed-measurement-name-%1$s" class="ui-widget-content ui-corner-all" style="padding: 2px;" type="text"/>' +
    '<br /><br />' +
    '<div id="computed-measurement-measurements-%1$s" style="overflow: auto; max-height: 200px; border-style: solid; border-width: 1px; border-color: #999999;"></div>' +
    '<br/>' +
    '<label for="computed-measurement-min-%1$s"><b>Min:</b></label> ' +
    '<input id="computed-measurement-min-%1$s" class="ui-widget-content ui-corner-all" style="padding: 2px;" type="text"/>&nbsp;' +
    '<label for="computed-measurement-max-%1$s"><b>Max:</b></label> ' +
    '<input id="computed-measurement-max-%1$s" class="ui-widget-content ui-corner-all" style="padding: 2px;" type="text"/><br/>' +
    '<div style="overflow: hidden; padding: 10px; padding-right: 20px; margin: 0px;">' +
      '<textarea id="computed-measurement-expr-%1$s" class="ui-widget-content ui-corner-all" style="width: 100%%; height: 55px; padding: 5px; margin: 0; resize: none;"></textarea>' +
    '</div>',
    this._id));

  var msList = this._selectMeasurementsList();

  var contents = '';
  for (var i = 0; i < this._datasourceGroupMeasurements.length; ++i) {
    var m = this._datasourceGroupMeasurements[i];
    var removeButton = '';
    if (m.isComputed()) {
      removeButton = '<button id="delete-button-%2$s-%3$s" data-measurement="%2$s">Delete %2$s</button>';
    }
    contents += sprintf(
      '<div style="min-height: 30px; padding: 2px;">' +
        '<div style="margin: 6px; float: left;">%1$s {<b>%2$s</b>}</div>' +
        '<div style="float: right;">' +
          removeButton +
          //editButton +
          '<button style="" id="measurement-button-%2$s-%3$s" data-measurement="%2$s">Insert %2$s</button>' +
        '</div>' +
      '</div>', m.name(), i, this._id);
  }

  msList.append(contents);

  var self = this;
  for (i = 0; i < this._datasourceGroupMeasurements.length; ++i) {
    m = this._datasourceGroupMeasurements[i];
    if (m.isComputed()) {
      $('#delete-button-' + i + '-' + this._id)
        .button(this._deleteButtonsProperties)
        .click(function() { self._deleteButtonClick($(this)); });
    }
    $('#measurement-button-' + i + '-' + this._id)
      .button(this._addButtonProperties)
      .click(function() { self._addButtonClick($(this)); });
  }

  this._selectIdTextBox().watermark('[auto]');
  this._selectNameTextBox().watermark('[auto]');
  this._selectMinTextBox().watermark('[auto]');
  this._selectMaxTextBox().watermark('[auto]');
  this._selectExpressionTextBox().watermark('[expression; for example: {0} - {1}]');
};


/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectDialog = function() {
  if (!this._dialog) { this._dialog = $('#' + this._id); }

  return this._dialog;
};

/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectExpressionTextBox = function() {
  if (!this._expressionTextBox) { this._expressionTextBox = $('#computed-measurement-expr-' + this._id); }

  return this._expressionTextBox;
};

/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectIdTextBox = function() {
  if (!this._idTextBox) { this._idTextBox = $('#computed-measurement-key-' + this._id); };

  return this._idTextBox;
};

/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectNameTextBox = function() {
  if (!this._nameTextBox) { this._nameTextBox = $('#computed-measurement-name-' + this._id); };

  return this._nameTextBox;
};

/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectMinTextBox = function() {
  if (!this._minTextBox) { this._minTextBox = $('#computed-measurement-min-' + this._id); };

  return this._minTextBox;
};

/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectMaxTextBox = function() {
  if (!this._maxTextBox) { this._maxTextBox = $('#computed-measurement-max-' + this._id); };

  return this._maxTextBox;
};

/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectTabs = function() {
  if (!this._tabs) { this._tabs = this._dialog.find('.computed-measurements-tabs'); }

  return this._tabs;
};

/**
 * @returns {jQuery}
 * @private
 */
epiviz.ui.controls.ComputedMeasurementsDialog.prototype._selectMeasurementsList = function() {
  if (!this._measurementsList) { this._measurementsList = $('#computed-measurement-measurements-' + this._id); }

  return this._measurementsList;
};

// Input 276
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 1/5/2015
 * Time: 5:53 PM
 */

goog.provide('epiviz.ui.controls.EditCodeControl');

goog.require('epiviz.ui.controls.CodeControl');

/**
 * @param {jQuery} container
 * @param {string} [title]
 * @param {string} [id]
 * @param {Object} [targetObject]
 * @param {string} [defaultMethod]
 * @param {boolean} [hasModifiedMethods]
 * @constructor
 * @extends {epiviz.ui.controls.CodeControl}
 */
epiviz.ui.controls.EditCodeControl = function(container, title, id, targetObject, defaultMethod, hasModifiedMethods) {
  // Call superclass constructor
  epiviz.ui.controls.CodeControl.call(this, container, title, id, targetObject);

  /**
   * @type {string}
   * @private
   */
  this._defaultMethod = defaultMethod;

  /**
   * @type {CodeMirror}
   * @private
   */
  this._editor = null;

  /**
   * @type {Object.<string, string>}
   * @private
   */
  this._methodsCode = {};

  /**
   * @type {string}
   * @private
   */
  this._selectedMethod = null;

  /**
   * @type {boolean}
   * @private
   */
  this._hasModifiedMethods = hasModifiedMethods || false;
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.EditCodeControl.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.CodeControl.prototype);
epiviz.ui.controls.EditCodeControl.constructor = epiviz.ui.controls.EditCodeControl;

epiviz.ui.controls.EditCodeControl.prototype.initialize = function() {
  if (this._editor) { return; }

  this._container.append(
    '<div style="float: left; margin-right: 5px;"><select class="obj-methods"></select></div>' +
    sprintf(
      '<div id="%1$s">' +
        '<label for="%1$s-true">On</label>' +
        '<input type="radio" id="%1$s-true" name="%1$s" %2$s />' +
        '<label for="%1$s-false">Off</label>' +
        '<input type="radio" id="%1$s-false" name="%1$s" %3$s />' +
      '</div>', this.id() + '-switch', this._hasModifiedMethods ? 'checked="checked"' : '',
      this._hasModifiedMethods ? '' : 'checked="checked"') +
    '<br />' +
    '<div style="overflow-y: scroll; max-height: 500px;">' +
    '<textarea autofocus="autofocus" class="code-edit"></textarea>' +
    '</div>');

  this._methodsSelector = this._container.find('.obj-methods');
  var onOffSwitch = this._container.find('#' + this.id() + '-switch');
  onOffSwitch.buttonset();
  var self = this;
  var optionChange = function(e) {
    var optionChecked = $('#' + self.id() + '-switch :radio:checked').attr('id');
    var newValue = optionChecked.substr(optionChecked.lastIndexOf('-')+1) == 'true';
    if (self._editor) { self._editor.setOption('disableInput', !newValue); }
    self._hasModifiedMethods = newValue;
  };
  onOffSwitch.find('#' + this.id() + '-switch-true').on('change', optionChange);
  onOffSwitch.find('#' + this.id() + '-switch-false').on('change', optionChange);
  var codeEditor = this._container.find('.code-edit');
  var methods = [];
  var obj = this._targetObj;
  for (var m in obj) {
    if ($.isFunction(obj[m])) {
      methods.push(m);
    }
  }
  methods.sort();
  for (var i = 0; i < methods.length; ++i) {
    m = methods[i];
    var selected = ((i == 0 && !this._defaultMethod) || this._defaultMethod == m);
    this._methodsSelector.append(sprintf('<option value="%s"%s>%s</option>',
      m, selected ? ' selected="selected"' : '', m));
    if (selected) {
      this._text = obj[m].toString();
      this._selectedMethod = m;
    }
  }

  this._methodsSelector.change(function() {
    self._methodsCode[self._selectedMethod] = self._editor.getValue();

    var sel = $(this).val();
    var text = self._methodsCode[sel];
    if (!text) {
      text = self._targetObj[sel].toString();
      self._methodsCode[sel] = text;
    }
    self._text = text;
    if (self._editor) {
      self._editor.getDoc().setValue(self._text);
    } else {
      codeEditor.val(self._text);
    }
    self._selectedMethod = sel;
    //self._dialog.dialog('option', 'position', 'center');// TODO: Trigger an event so that the dialog can re-center
  });

  codeEditor.val(this._text);
  this._methodsSelector.selectmenu({
    style: 'popup',
    width: '150',
    maxHeight: '150',
    menuWidth: '150'
  });

  this._editor = CodeMirror.fromTextArea(this._container.find('.code-edit')[0], {
    lineNumbers: true,
    matchBrackets: true,
    continueComments: "Enter",
    extraKeys: {"Ctrl-Q": "toggleComment"},
    autofocus: true
  });
  this._editor.setOption('disableInput', !this._hasModifiedMethods);
};

/**
 */
epiviz.ui.controls.EditCodeControl.prototype.save = function() {
  this._methodsCode[this._selectedMethod] = this._editor.getValue();
  this._text = this._editor.getValue();
};

/**
 */
epiviz.ui.controls.EditCodeControl.prototype.revert = function() {
  if (this._editor) {
    this._editor.setOption('value', this._text);
  }
};

/**
 * @returns {Object.<string, string>}
 */
epiviz.ui.controls.EditCodeControl.prototype.modifiedMethods = function() {
  /** @type {Object.<string, string>} */
  var modifiedMethods = {};
  for (var m in this._methodsCode) {
    if (!this._methodsCode.hasOwnProperty(m)) { continue; }
    if (this._methodsCode[m] != this._targetObj[m].toString()) {
      modifiedMethods[m] = this._methodsCode[m];
    }
  }
  return modifiedMethods;
};

/**
 * @returns {*}
 */
epiviz.ui.controls.EditCodeControl.prototype.result = function() {
  return {
    hasModifiedMethods: this._hasModifiedMethods,
    modifiedMethods: this._hasModifiedMethods ? this.modifiedMethods() : {}
  };
};

// Input 277
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 3/30/14
 * Time: 6:21 PM
 */

goog.provide('epiviz.ui.controls.Wizard');

goog.require('epiviz.ui.controls.Dialog');
goog.require('epiviz.ui.controls.MessageDialog');
goog.require('epiviz.utils');

/**
 * @param {string} title
 * @param {{finish: function(*)=, close: function()=}} handlers
 * @param {Array.<epiviz.ui.controls.Wizard.Step>} steps
 * @param {*} initialData
 * @param {string} [width]
 * @param {string} [height]
 * @param {boolean} [showTabs]
 * @constructor
 * @extends {epiviz.ui.controls.Dialog}
 */
epiviz.ui.controls.Wizard = function(title, handlers, steps, initialData, width, height, showTabs) {
  epiviz.ui.controls.Dialog.call(this, title, handlers);

  /**
   * @type {Array.<epiviz.ui.controls.Wizard.Step>}
   * @private
   */
  this._steps = steps;

  /**
   * @type {*}
   * @private
   */
  this._initialData = initialData;

  /**
   * @type {string=}
   * @private
   */
  this._width = width;

  /**
   * @type {string=}
   * @private
   */
  this._height = height;

  /**
   * @type {boolean}
   * @private
   */
  this._showTabs = showTabs || false;

  /**
   * @type {?jQuery}
   * @private
   */
  this._tabs = null;

  this._initialize();
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.Wizard.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Dialog.prototype);
epiviz.ui.controls.Wizard.constructor = epiviz.ui.controls.Wizard;

/**
 * @private
 */
epiviz.ui.controls.Wizard.prototype._initialize = function() {
  var self = this;
  this._dialog = $('#' + this._id);
  this._dialog.append(
    '<div id="wizardDialog" class="wizard-dialog">' +
      '<div class="wizard-tabs">' +
        '<ul class="wizard-tabs-title-list"></ul>' +
      '</div>' +
    '</div>');

  this._tabs = this._dialog.find('.wizard-tabs');

  /** @type {jQuery} */
  var titleList = this._tabs.find('.wizard-tabs-title-list');

  for (var i = 0; i < this._steps.length; ++i) {
    titleList.append(sprintf('<li><a href="#%s-tab-%s">%s</a></li>', this._id, i, this._steps[i].title()));
    this._tabs.append(sprintf('<div id="%s-tab-%s"></div>', this._id, i));
  }

  if (!this._showTabs) {
    titleList.css('visibility', 'hidden');
    titleList.css('position', 'absolute');
  }

  this._tabs.tabs({
    activate: function(e, ui) { self._tabActivate(ui); },
    disabled: epiviz.utils.range(this._steps.length - 1, 1)
  });

  this._dialog.dialog({
    autoOpen: false,
    resizable: true,
    width: this._width || undefined,
    height: this._height || undefined,
    buttons: {
      Back: function() {
        var selectedTabIndex = self._tabs.tabs('option', 'active');
        if (selectedTabIndex == 0) { return; }

        self._tabs.tabs('option', 'disabled', epiviz.utils.range(self._steps.length - selectedTabIndex, selectedTabIndex));
        self._tabs.tabs('option', 'active', selectedTabIndex - 1);
      },
      Next: function() {
        var selectedTabIndex = self._tabs.tabs('option', 'active');

        /** @type {{data: *=, error: string=}} */
        var result = self._steps[selectedTabIndex].next();

        if (result.error) {
          var errorDialog = new epiviz.ui.controls.MessageDialog('Error', { Ok: function() {} }, result.error, epiviz.ui.controls.MessageDialog.Icon.ERROR);
          errorDialog.show();
          return;
        }

        self._steps[selectedTabIndex+1].initialize($(sprintf('#%s-tab-%s', self._id, selectedTabIndex+1)), result.data);

        self._tabs.tabs('option', 'disabled', epiviz.utils.range(self._steps.length - selectedTabIndex - 2, selectedTabIndex + 2));
        self._tabs.tabs('option', 'active', selectedTabIndex + 1);
      },
      Finish: function() {
        /** @type {{data: *=, error: string=}} */
        var result = self._steps[self._steps.length - 1].next();

        if (result.error) {
          var errorDialog = new epiviz.ui.controls.MessageDialog('Error', { Ok: function() {} }, result.error, epiviz.ui.controls.MessageDialog.Icon.ERROR);
          errorDialog.show();
          return;
        }

        if (self._handlers.finish) {
          self._handlers.finish(result.data);
        }

        $(this).dialog('close');
      },
      Cancel: function() {
        if (self._handlers.close) {
          self._handlers.close();
        }
        $(this).dialog('close');
      }
    },
    modal: true
  });

  if (this._steps.length > 1) {
    this._dialog.parent().find('button:contains("Finish")').button('disable');
    this._dialog.parent().find('button:contains("Next")').button('enable');
  } else {
    this._dialog.parent().find('button:contains("Finish")').button('enable');
    this._dialog.parent().find('button:contains("Next")').button('disable');
  }
  this._steps[0].initialize($(sprintf('#%s-tab-0', self._id)), this._initialData);
  this._dialog.css('overflow', 'visible');
};

/**
 * @param ui
 * @private
 */
epiviz.ui.controls.Wizard.prototype._tabActivate = function(ui) {
  var selectedTabIndex = this._tabs.tabs('option', 'active');
  var finishButton = this._dialog.parent().find('button:contains("Finish")');
  var nextButton = this._dialog.parent().find('button:contains("Next")');

  if (selectedTabIndex == this._steps.length - 1) {
    nextButton.button('disable');
    finishButton.button('enable');
  } else {
    nextButton.button('enable');
    finishButton.button('disable');
  }

  this._tabs.tabs('option', 'disabled', epiviz.utils.range(this._steps.length - selectedTabIndex - 1, selectedTabIndex + 1));
};

/**
 */
epiviz.ui.controls.Wizard.prototype.show = function() {
  var self = this;

  this._dialog.dialog('open');
  this._dialog.dialog('option', 'position', 'center');

  // This makes the dialog only able to open once:
  this._dialog.dialog({
    close: function(event, ui) {
      $(this).remove();
      self._dialog = null;
    }
  });
};

goog.provide('epiviz.ui.controls.Wizard.Step');

/**
 * @interface
 * @template I, O
 */
epiviz.ui.controls.Wizard.Step = function() {};

/**
 * @param {jQuery} container
 * @param {I} [data]
 */
epiviz.ui.controls.Wizard.Step.prototype.initialize = function(container, data) {};

/**
 * Gets the data resulted from manipulation of this wizard step, or, if
 * there is an error, error contains the details of the error that occurred.
 * @returns {{data: O=, error: string=}}
 */
epiviz.ui.controls.Wizard.Step.prototype.next = function() {};

/**
 * @returns {string}
 */
epiviz.ui.controls.Wizard.Step.prototype.title = function() {};

// Input 278
/**
 * Created by Florin Chelaru ( florinc [at] umd [dot] edu )
 * Date: 2/18/14
 * Time: 6:44 PM
 */

goog.provide('epiviz.ui.controls.SaveSvgAsImageDialog');

goog.require('epiviz.ui.controls.Dialog');

/**
 * @param {{ok: function(), cancel: function()}} handlers
 * @param {string} chartId The id of the chart being saved
 * @param {string} chartSaverLocation The location of the
 *   PHP server providing the SVG saving functionality
 * @constructor
 * @extends {epiviz.ui.controls.Dialog}
 */
epiviz.ui.controls.SaveSvgAsImageDialog = function(handlers, chartId, chartSaverLocation) {
  epiviz.ui.controls.Dialog.call(this, 'Save Chart SVG as Image', handlers);

  this._dialog = $('#' + this._id);

  this._dialog.append(
    '<div class="save-svg-dialog">' +
    '<label class="dialog-label">Choose file format:</label>' +
    '<br/><br/>' +
    '<div style="position:absolute; right:15px;">' +
      '<select class="svg-file-format">' +
        '<option value="pdf" selected="selected">PDF</option>' +
        '<option value="ps" >PS</option>' +
        '<option value="png" >PNG</option>' +
        '<option value="svg">SVG</option>' +
        '<option value="eps">EPS</option>' +
      '</select>' +
    '</div>' +
    sprintf('<form name="%s-svg-save-form" method="POST">', this._id) +
      '<div>' +
        '<input type="hidden" name="svg" />' +
        '<input type="hidden" name="format" />' +
        '<br/><br/>' +
      '</div>' +
    '</form>' +
  '</div>');

  /**
   * @type {string}
   * @private
   */
  this._chartId = chartId;

  /**
   * @type {string}
   * @private
   */
  this._chartSaverLocation = chartSaverLocation;

  var self = this;
  this._dialog.dialog({
    autoOpen: false,
    resizable: false,
    width: '200',
    buttons: {
      Ok: function() {
        var svg = $('#' + self._chartId).find('svg').clone();
        svg.attr('xmlns', 'http://www.w3.org/2000/svg');
        svg.attr('version', '1.1');

        var fileFormat = self._dialog.find('.svg-file-format');

        var form = document.forms[sprintf('%s-svg-save-form', self._id)];

        form.action = self._chartSaverLocation;
        form['svg'].value = $('<div>').append(svg).html();
        form['format'].value = fileFormat.val();
        form.submit();

        self._handlers.ok();
        $(this).dialog('close');
      },
      Cancel: function() {
        self._handlers.cancel();
        $(this).dialog('close');
      }
    },
    modal: true
  });
};

/**
 * Copy methods from upper class
 */
epiviz.ui.controls.SaveSvgAsImageDialog.prototype = epiviz.utils.mapCopy(epiviz.ui.controls.Dialog.prototype);
epiviz.ui.controls.SaveSvgAsImageDialog.constructor = epiviz.ui.controls.SaveSvgAsImageDialog;

/**
 */
epiviz.ui.controls.SaveSvgAsImageDialog.prototype.show = function() {
  epiviz.ui.controls.Dialog.prototype.show.call(this);

  var self = this;
  if (this._dialog) {
    this._dialog.dialog('open');

    this._dialog.dialog('option', 'position', 'center');

    // This makes the dialog only able to open once:
    this._dialog.dialog({
      close: function(event, ui) {
        $(this).remove();
        self._dialog = null;
      }
    });
  }
};

