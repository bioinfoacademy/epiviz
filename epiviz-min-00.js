goog.provide("epiviz.utils.capitalizeFirstLetter");goog.provide("epiviz.utils.fillArray");goog.provide("epiviz.utils.mapCopy");goog.provide("epiviz.utils.evaluateFullyQualifiedTypeName");goog.provide("epiviz.utils.generatePseudoGUID");epiviz.utils.capitalizeFirstLetter=function(str){return str.charAt(0).toUpperCase()+str.slice(1)};epiviz.utils.stringContains=function(str,substr){return str.indexOf(substr)!=-1};epiviz.utils.stringStartsWith=function(str,prefix){return str.indexOf(prefix)==0};
epiviz.utils.stringEndsWith=function(str,suffix){return str.lastIndexOf(suffix)==str.length-suffix.length};epiviz.utils.fillArray=function(n,value){n=n||0;var result=new Array(n);for(var i=0;i<n;++i)result.push(value);return result};epiviz.utils.indexOf=function(arr,predicate){for(var i=0;i<arr.length;++i)if(predicate(arr[i]))return i;return-1};
epiviz.utils.arraysEqual=function(arr1,arr2){if(arr1==arr2)return true;if(!arr1||!arr2)return false;if(arr1.length!=arr2.length)return false;return!(arr1<arr2||arr2<arr1)};epiviz.utils.elementsEqual=function(arr1,arr2){if(arr1==arr2)return true;if(!arr1||!arr2)return false;if(arr1.length!=arr2.length)return false;var valueMap={};var i;for(i=0;i<arr1.length;++i){if(!(arr1[i]in valueMap))valueMap[arr1[i]]=0;++valueMap[arr1[i]]}for(i=0;i<arr2.length;++i){if(!valueMap[arr2[i]])return false;--valueMap[arr2[i]]}return true};
epiviz.utils.range=function(n,startIndex){startIndex=startIndex||0;n=n||0;var result=new Array(n);for(var i=0;i<n;++i)result[i]=i+startIndex;return result};epiviz.utils.arrayAppend=function(self,arr){self.push.apply(self,arr)};epiviz.utils.arrayFlip=function(arr){var result={};for(var i=0;i<arr.length;++i)result[arr[i]]=i;return result};epiviz.utils.mapCopy=function(map){var result={};for(var key in map){if(!map.hasOwnProperty(key))continue;result[key]=map[key]}return result};
epiviz.utils.mapEquals=function(m1,m2){if(m1==m2)return true;if(!m1||!m2)return false;var k;for(k in m1){if(!m1.hasOwnProperty(k))continue;if(!m2.hasOwnProperty(k))return false;if(m1[k]!=m2[k])return false}for(k in m2){if(!m2.hasOwnProperty(k))continue;if(!m1.hasOwnProperty(k))return false}return true};
epiviz.utils.mapCombine=function(m1,m2){var result={};var key;if(m2)for(key in m2){if(!m2.hasOwnProperty(key))continue;result[key]=m2[key]}if(m1)for(key in m1){if(!m1.hasOwnProperty(key))continue;result[key]=m1[key]}return result};
epiviz.utils.mapJoin=function(map,keyValueSep,separator){if(!keyValueSep&&keyValueSep!=="")keyValueSep=":";if(!separator&&separator!=="")separator=",";var result="";for(var key in map){if(!map.hasOwnProperty(key))continue;if(result)result+=separator;result+=key+keyValueSep+map[key]}return result};epiviz.utils.mapKeyIntersection=function(m1,m2){var result=[];if(!m1||!m2)return result;for(var key in m1){if(!m1.hasOwnProperty(key))continue;if(key in m2)result.push(key)}return result};
epiviz.utils.evaluateFullyQualifiedTypeName=function(typeName){try{var namespaces=typeName.split(".");var func=namespaces.pop();var context=window;for(var i=0;i<namespaces.length;++i)context=context[namespaces[i]];var result=context[func];if(typeof result!=="function")return null;return result}catch(error){console.error("Unknown type name: "+typeName);return null}};
epiviz.utils.applyConstructor=function(ctor,params){var obj;var fakeCtor=function(){};fakeCtor.prototype=ctor.prototype;obj=new fakeCtor;obj.constructor=ctor;ctor.apply(obj,params);return obj};epiviz.utils.getInternetExplorerVersion=function(){var rv=-1;if(navigator.appName=="Microsoft Internet Explorer"){var ua=navigator.userAgent;var re=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");var match=re.exec(ua);if(match!=null)rv=parseFloat(match[1])}return rv};
epiviz.utils.generatePseudoGUID=function(size){var chars="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";var result="";for(var i=0;i<size;++i)result+=chars[Math.round(Math.random()*(chars.length-1))];return result};epiviz.utils.colorize=function(min,max,median,colorMin,colorMax,colorMedian){return d3.scale.linear().domain([min,median,max]).range([colorMin,colorMedian,colorMax])};
epiviz.utils.colorizeBinary=function(min,max,colorMin,colorMax){return d3.scale.linear().domain([min,max]).range([colorMin,colorMax])};if(!Array.indexOf)Array.prototype.indexOf=function(obj,start){for(var i=start||0;i<this.length;i++)if(this[i]===obj)return i;return-1};goog.provide("epiviz.utils.ExpressionParser");
epiviz.utils.ExpressionParser=function(scope){function object(o){function F(){}F.prototype=o;return new F}var TNUMBER=0;var TOP1=1;var TOP2=2;var TVAR=3;var TFUNCALL=4;function Token(type_,index_,prio_,number_){this.type_=type_;this.index_=index_||0;this.prio_=prio_||0;this.number_=number_!==undefined&&number_!==null?number_:0;this.toString=function(){switch(this.type_){case TNUMBER:return this.number_;case TOP1:case TOP2:case TVAR:return this.index_;case TFUNCALL:return"CALL";default:return"Invalid Token"}}}
function Expression(tokens,ops1,ops2,functions){this.tokens=tokens;this.ops1=ops1;this.ops2=ops2;this.functions=functions}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\'\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","'":"\\'","\\":"\\\\"};function escapeValue(v){if(typeof v==="string"){escapable.lastIndex=
0;return escapable.test(v)?"'"+v.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+"'":"'"+v+"'"}return v}Expression.prototype={simplify:function(values){values=values||{};var nstack=[];var newexpression=[];var n1;var n2;var f;var L=this.tokens.length;var item;var i=0;for(i=0;i<L;i++){item=this.tokens[i];var type_=item.type_;if(type_===TNUMBER)nstack.push(item);else if(type_===TVAR&&item.index_ in values){item=new Token(TNUMBER,
0,0,values[item.index_]);nstack.push(item)}else if(type_===TOP2&&nstack.length>1){n2=nstack.pop();n1=nstack.pop();f=this.ops2[item.index_];item=new Token(TNUMBER,0,0,f(n1.number_,n2.number_));nstack.push(item)}else if(type_===TOP1&&nstack.length>0){n1=nstack.pop();f=this.ops1[item.index_];item=new Token(TNUMBER,0,0,f(n1.number_));nstack.push(item)}else{while(nstack.length>0)newexpression.push(nstack.shift());newexpression.push(item)}}while(nstack.length>0)newexpression.push(nstack.shift());return new Expression(newexpression,
object(this.ops1),object(this.ops2),object(this.functions))},substitute:function(variable,expr){if(!(expr instanceof Expression))expr=(new Parser).parse(String(expr));var newexpression=[];var L=this.tokens.length;var item;var i=0;for(i=0;i<L;i++){item=this.tokens[i];var type_=item.type_;if(type_===TVAR&&item.index_===variable)for(var j=0;j<expr.tokens.length;j++){var expritem=expr.tokens[j];var replitem=new Token(expritem.type_,expritem.index_,expritem.prio_,expritem.number_);newexpression.push(replitem)}else newexpression.push(item)}var ret=
new Expression(newexpression,object(this.ops1),object(this.ops2),object(this.functions));return ret},evaluate:function(values){values=values||{};var nstack=[];var n1;var n2;var f;var L=this.tokens.length;var item;var i=0;for(i=0;i<L;i++){item=this.tokens[i];var type_=item.type_;if(type_===TNUMBER)nstack.push(item.number_);else if(type_===TOP2){n2=nstack.pop();n1=nstack.pop();f=this.ops2[item.index_];nstack.push(f(n1,n2))}else if(type_===TVAR)if(item.index_ in values)nstack.push(values[item.index_]);
else if(item.index_ in this.functions)nstack.push(this.functions[item.index_]);else throw new Error("undefined variable: "+item.index_);else if(type_===TOP1){n1=nstack.pop();f=this.ops1[item.index_];nstack.push(f(n1))}else if(type_===TFUNCALL){n1=nstack.pop();f=nstack.pop();if(f.apply&&f.call)if(Object.prototype.toString.call(n1)=="[object Array]")nstack.push(f.apply(undefined,n1));else nstack.push(f.call(undefined,n1));else throw new Error(f+" is not a function");}else throw new Error("invalid Expression");
}if(nstack.length>1)throw new Error("invalid Expression (parity)");return nstack[0]},evaluateArr:function(values){var result=[];var finished=false;while(!finished){var tuple={};for(var v in values){if(!values.hasOwnProperty(v))continue;if(result.length>=values[v].length){finished=true;break}tuple[v]=values[v][result.length]}if(!finished)result.push(this.evaluate(tuple))}return result},toString:function(toJS){var nstack=[];var n1;var n2;var f;var L=this.tokens.length;var item;var i=0;for(i=0;i<L;i++){item=
this.tokens[i];var type_=item.type_;if(type_===TNUMBER)nstack.push(escapeValue(item.number_));else if(type_===TOP2){n2=nstack.pop();n1=nstack.pop();f=item.index_;if(toJS&&f=="^")nstack.push("Math.pow("+n1+","+n2+")");else nstack.push("("+n1+f+n2+")")}else if(type_===TVAR)nstack.push(item.index_);else if(type_===TOP1){n1=nstack.pop();f=item.index_;if(f==="-")nstack.push("("+f+n1+")");else nstack.push(f+"("+n1+")")}else if(type_===TFUNCALL){n1=nstack.pop();f=nstack.pop();nstack.push(f+"("+n1+")")}else throw new Error("invalid Expression");
}if(nstack.length>1)throw new Error("invalid Expression (parity)");return nstack[0]},variables:function(){var L=this.tokens.length;var vars=[];for(var i=0;i<L;i++){var item=this.tokens[i];if(item.type_===TVAR&&vars.indexOf(item.index_)==-1)vars.push(item.index_)}return vars},toJSFunction:function(param,variables){var f=new Function(param,"with(Parser.values) { return "+this.simplify(variables).toString(true)+"; }");return f}};function add(a,b){return Number(a)+Number(b)}function sub(a,b){return a-
b}function mul(a,b){return a*b}function div(a,b){return a/b}function mod(a,b){return a%b}function concat(a,b){return""+a+b}function neg(a){return-a}function random(a){return Math.random()*(a||1)}function fac(a){a=Math.floor(a);var b=a;while(a>1)b=b*--a;return b}function pyt(a,b){return Math.sqrt(a*a+b*b)}function append(a,b){if(Object.prototype.toString.call(a)!="[object Array]")return[a,b];a=a.slice();a.push(b);return a}function Parser(){this.success=false;this.errormsg="";this.expression="";this.pos=
0;this.tokennumber=0;this.tokenprio=0;this.tokenindex=0;this.tmpprio=0;this.ops1={"sin":Math.sin,"cos":Math.cos,"tan":Math.tan,"asin":Math.asin,"acos":Math.acos,"atan":Math.atan,"sqrt":Math.sqrt,"log":Math.log,"abs":Math.abs,"ceil":Math.ceil,"floor":Math.floor,"round":Math.round,"-":neg,"exp":Math.exp};this.ops2={"+":add,"-":sub,"*":mul,"/":div,"%":mod,"^":Math.pow,",":append,"||":concat};this.functions={"random":random,"fac":fac,"min":Math.min,"max":Math.max,"pyt":pyt,"pow":Math.pow,"atan2":Math.atan2};
this.consts={"E":Math.E,"PI":Math.PI}}Parser.parse=function(expr){return(new Parser).parse(expr)};Parser.evaluate=function(expr,variables){return Parser.parse(expr).evaluate(variables)};Parser.Expression=Expression;Parser.values={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sqrt:Math.sqrt,log:Math.log,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,random:random,fac:fac,exp:Math.exp,min:Math.min,max:Math.max,pyt:pyt,pow:Math.pow,atan2:Math.atan2,
E:Math.E,PI:Math.PI};var PRIMARY=1<<0;var OPERATOR=1<<1;var FUNCTION=1<<2;var LPAREN=1<<3;var RPAREN=1<<4;var COMMA=1<<5;var SIGN=1<<6;var CALL=1<<7;var NULLARY_CALL=1<<8;Parser.prototype={parse:function(expr){this.errormsg="";this.success=true;var operstack=[];var tokenstack=[];this.tmpprio=0;var expected=PRIMARY|LPAREN|FUNCTION|SIGN;var noperators=0;this.expression=expr;this.pos=0;while(this.pos<this.expression.length)if(this.isOperator())if(this.isSign()&&expected&SIGN){if(this.isNegativeSign()){this.tokenprio=
2;this.tokenindex="-";noperators++;this.addfunc(tokenstack,operstack,TOP1)}expected=PRIMARY|LPAREN|FUNCTION|SIGN}else if(this.isComment());else{if((expected&OPERATOR)===0)this.error_parsing(this.pos,"unexpected operator");noperators+=2;this.addfunc(tokenstack,operstack,TOP2);expected=PRIMARY|LPAREN|FUNCTION|SIGN}else if(this.isNumber()){if((expected&PRIMARY)===0)this.error_parsing(this.pos,"unexpected number");var token=new Token(TNUMBER,0,0,this.tokennumber);tokenstack.push(token);expected=OPERATOR|
RPAREN|COMMA}else if(this.isString()){if((expected&PRIMARY)===0)this.error_parsing(this.pos,"unexpected string");var token=new Token(TNUMBER,0,0,this.tokennumber);tokenstack.push(token);expected=OPERATOR|RPAREN|COMMA}else if(this.isLeftParenth()){if((expected&LPAREN)===0)this.error_parsing(this.pos,'unexpected "("');if(expected&CALL){noperators+=2;this.tokenprio=-2;this.tokenindex=-1;this.addfunc(tokenstack,operstack,TFUNCALL)}expected=PRIMARY|LPAREN|FUNCTION|SIGN|NULLARY_CALL}else if(this.isRightParenth()){if(expected&
NULLARY_CALL){var token=new Token(TNUMBER,0,0,[]);tokenstack.push(token)}else if((expected&RPAREN)===0)this.error_parsing(this.pos,'unexpected ")"');expected=OPERATOR|RPAREN|COMMA|LPAREN|CALL}else if(this.isComma()){if((expected&COMMA)===0)this.error_parsing(this.pos,'unexpected ","');this.addfunc(tokenstack,operstack,TOP2);noperators+=2;expected=PRIMARY|LPAREN|FUNCTION|SIGN}else if(this.isConst()){if((expected&PRIMARY)===0)this.error_parsing(this.pos,"unexpected constant");var consttoken=new Token(TNUMBER,
0,0,this.tokennumber);tokenstack.push(consttoken);expected=OPERATOR|RPAREN|COMMA}else if(this.isOp2()){if((expected&FUNCTION)===0)this.error_parsing(this.pos,"unexpected function");this.addfunc(tokenstack,operstack,TOP2);noperators+=2;expected=LPAREN}else if(this.isOp1()){if((expected&FUNCTION)===0)this.error_parsing(this.pos,"unexpected function");this.addfunc(tokenstack,operstack,TOP1);noperators++;expected=LPAREN}else if(this.isVar()){if((expected&PRIMARY)===0)this.error_parsing(this.pos,"unexpected variable");
var vartoken=new Token(TVAR,this.tokenindex,0,0);tokenstack.push(vartoken);expected=OPERATOR|RPAREN|COMMA|LPAREN|CALL}else if(this.isWhite());else if(this.errormsg==="")this.error_parsing(this.pos,"unknown character");else this.error_parsing(this.pos,this.errormsg);if(this.tmpprio<0||this.tmpprio>=10)this.error_parsing(this.pos,'unmatched "()"');while(operstack.length>0){var tmp=operstack.pop();tokenstack.push(tmp)}if(noperators+1!==tokenstack.length)this.error_parsing(this.pos,"parity");return new Expression(tokenstack,
object(this.ops1),object(this.ops2),object(this.functions))},evaluate:function(expr,variables){return this.parse(expr).evaluate(variables)},error_parsing:function(column,msg){this.success=false;this.errormsg="parse error [column "+column+"]: "+msg;throw new Error(this.errormsg);},addfunc:function(tokenstack,operstack,type_){var operator=new Token(type_,this.tokenindex,this.tokenprio+this.tmpprio,0);while(operstack.length>0)if(operator.prio_<=operstack[operstack.length-1].prio_)tokenstack.push(operstack.pop());
else break;operstack.push(operator)},isNumber:function(){var r=false;var str="";while(this.pos<this.expression.length){var code=this.expression.charCodeAt(this.pos);if(code>=48&&code<=57||code===46){str+=this.expression.charAt(this.pos);this.pos++;this.tokennumber=parseFloat(str);r=true}else break}return r},unescape:function(v,pos){var buffer=[];var escaping=false;for(var i=0;i<v.length;i++){var c=v.charAt(i);if(escaping){switch(c){case "'":buffer.push("'");break;case "\\":buffer.push("\\");break;
case "/":buffer.push("/");break;case "b":buffer.push("\b");break;case "f":buffer.push("\f");break;case "n":buffer.push("\n");break;case "r":buffer.push("\r");break;case "t":buffer.push("\t");break;case "u":var codePoint=parseInt(v.substring(i+1,i+5),16);buffer.push(String.fromCharCode(codePoint));i+=4;break;default:throw this.error_parsing(pos+i,"Illegal escape sequence: '\\"+c+"'");}escaping=false}else if(c=="\\")escaping=true;else buffer.push(c)}return buffer.join("")},isString:function(){var r=
false;var str="";var startpos=this.pos;if(this.pos<this.expression.length&&this.expression.charAt(this.pos)=="'"){this.pos++;while(this.pos<this.expression.length){var code=this.expression.charAt(this.pos);if(code!="'"||str.slice(-1)=="\\"){str+=this.expression.charAt(this.pos);this.pos++}else{this.pos++;this.tokennumber=this.unescape(str,startpos);r=true;break}}}return r},isConst:function(){var str;for(var i in this.consts)if(true){var L=i.length;str=this.expression.substr(this.pos,L);if(i===str){this.tokennumber=
this.consts[i];this.pos+=L;return true}}return false},isOperator:function(){var code=this.expression.charCodeAt(this.pos);if(code===43){this.tokenprio=0;this.tokenindex="+"}else if(code===45){this.tokenprio=0;this.tokenindex="-"}else if(code===124)if(this.expression.charCodeAt(this.pos+1)===124){this.pos++;this.tokenprio=0;this.tokenindex="||"}else return false;else if(code===42){this.tokenprio=1;this.tokenindex="*"}else if(code===47){this.tokenprio=2;this.tokenindex="/"}else if(code===37){this.tokenprio=
2;this.tokenindex="%"}else if(code===94){this.tokenprio=3;this.tokenindex="^"}else return false;this.pos++;return true},isSign:function(){var code=this.expression.charCodeAt(this.pos-1);if(code===45||code===43)return true;return false},isPositiveSign:function(){var code=this.expression.charCodeAt(this.pos-1);if(code===43)return true;return false},isNegativeSign:function(){var code=this.expression.charCodeAt(this.pos-1);if(code===45)return true;return false},isLeftParenth:function(){var code=this.expression.charCodeAt(this.pos);
if(code===40){this.pos++;this.tmpprio+=10;return true}return false},isRightParenth:function(){var code=this.expression.charCodeAt(this.pos);if(code===41){this.pos++;this.tmpprio-=10;return true}return false},isComma:function(){var code=this.expression.charCodeAt(this.pos);if(code===44){this.pos++;this.tokenprio=-1;this.tokenindex=",";return true}return false},isWhite:function(){var code=this.expression.charCodeAt(this.pos);if(code===32||code===9||code===10||code===13){this.pos++;return true}return false},
isOp1:function(){var str="";for(var i=this.pos;i<this.expression.length;i++){var c=this.expression.charAt(i);if(c.toUpperCase()===c.toLowerCase())if(i===this.pos||c!="_"&&(c<"0"||c>"9"))break;str+=c}if(str.length>0&&str in this.ops1){this.tokenindex=str;this.tokenprio=5;this.pos+=str.length;return true}return false},isOp2:function(){var str="";for(var i=this.pos;i<this.expression.length;i++){var c=this.expression.charAt(i);if(c.toUpperCase()===c.toLowerCase())if(i===this.pos||c!="_"&&(c<"0"||c>"9"))break;
str+=c}if(str.length>0&&str in this.ops2){this.tokenindex=str;this.tokenprio=5;this.pos+=str.length;return true}return false},isVar:function(){var str="";for(var i=this.pos;i<this.expression.length;i++){var c=this.expression.charAt(i);if(c.toUpperCase()===c.toLowerCase())if(i===this.pos||c!="_"&&(c<"0"||c>"9"))break;str+=c}var start=this.pos,end=this.expression.indexOf("}",this.pos);if(this.expression.charAt(start)=="{"&&end>start)str=this.expression.substring(start,end+1);if(str.length>0){this.tokenindex=
str;this.tokenprio=4;this.pos+=str.length;return true}return false},isComment:function(){var code=this.expression.charCodeAt(this.pos-1);if(code===47&&this.expression.charCodeAt(this.pos)===42){this.pos=this.expression.indexOf("*/",this.pos)+2;if(this.pos===1)this.pos=this.expression.length;return true}return false}};scope.Parser=Parser;return Parser}(typeof exports==="undefined"?{}:exports);goog.provide("epiviz.utils.Iterable");epiviz.utils.Iterable=function(){};epiviz.utils.Iterable.prototype.foreach=function(iteration){};goog.provide("epiviz.utils.IterableArray");epiviz.utils.IterableArray=function(array){this._array=array};epiviz.utils.IterableArray.prototype.foreach=function(iteration){for(var i=0;i<this._array.length;++i)if(iteration(this._array[i]))return};goog.provide("epiviz.Config");
epiviz.Config=function(settingsMap){this.dataServerLocation="";this.chartSaverLocation="";this.zoominRatio=.8;this.zoomoutRatio=1.2;this.navigationStepRatio=.2;this.navigationDelay=100;this.defaultWorkspaceSettings={name:epiviz.workspaces.Workspace.DEFAULT_WORKSPACE_NAME,content:{range:{seqName:"chr11",start:998E5,width:3583180},measurements:[],charts:{track:[],plot:[]}}};this.dataProviders=[sprintf("epiviz.data.WebServerDataProvider,%s,%s",epiviz.data.WebServerDataProvider.DEFAULT_ID,epiviz.data.WebServerDataProvider.DEFAULT_SERVER_ENDPOINT)];
this.workspacesDataProvider=sprintf("epiviz.data.WebServerDataProvider,%s,%s","workspaces_provider",epiviz.data.WebServerDataProvider.DEFAULT_SERVER_ENDPOINT);this.cacheUpdateIntervalMilliseconds=3E4;this.maxSearchResults=12;this.chartTypes=[];this.chartSettings={plot:{width:600,height:400,margins:new epiviz.ui.charts.Margins(10,5,5,5),colors:new epiviz.ui.charts.ColorPalette(epiviz.Config.COLORS_BRIGHT)},track:{width:"100%",height:120,margins:new epiviz.ui.charts.Margins(10,5,5,5),colors:new epiviz.ui.charts.ColorPalette(epiviz.Config.COLORS_BRIGHT)}};
this.chartCustomSettings={};if(settingsMap){for(var setting in settingsMap){if(!settingsMap.hasOwnProperty(setting))continue;this[setting]=settingsMap[setting]}var socketHosts=epiviz.ui.WebArgsManager.WEB_ARGS["websocket-host"];if(socketHosts&&socketHosts.length)for(var i=0;i<socketHosts.length;++i)this.dataProviders.push(sprintf("epiviz.data.WebsocketDataProvider,%s,%s",epiviz.data.WebsocketDataProvider.DEFAULT_ID+"-"+i,socketHosts[i]))}};
epiviz.Config.EPIVIZ_V1_COLORS=["#025167","#e7003e","#ffcd00","#057d9f","#970026","#ffe373","#ff8100"];epiviz.Config.COLORS_BRIGHT=["#1859a9","#ed2d2e","#008c47","#010101","#f37d22","#662c91","#a11d20","#b33893"];epiviz.Config.COLORS_LIGHT=["#b8d2eb","#f2aeac","#d8e4aa","#cccccc","#f2d1b0","#d4b2d3","#ddb8a9","#ebbfd9"];epiviz.Config.COLORS_MEDIUM=["#599ad3","#f1595f","#79c36a","#727272","#f9a65a","#9e66ab","#cd7058","#d77fb3"];
epiviz.Config.ChartPropertySettings={WIDTH:"width",HEIGHT:"height",MARGINS:"margins",COLORS:"colors"};goog.provide("epiviz.events.EventListener");epiviz.events.EventListener=function(updateCallback){this._id=epiviz.events.EventListener._nextId++;this._updateCallback=updateCallback};epiviz.events.EventListener._nextId=0;epiviz.events.EventListener.prototype.update=function(args){this._updateCallback(args)};epiviz.events.EventListener.prototype.id=function(){return this._id};goog.provide("epiviz.events.Event");goog.require("epiviz.events.EventListener");epiviz.events.Event=function(){this._count=0;this._listeners={};this._firing=false};epiviz.events.Event.prototype.addListener=function(listener){if(!this._listeners[listener.id()])++this._count;this._listeners[listener.id()]=listener};epiviz.events.Event.prototype.removeListener=function(listener){if(!this._listeners[listener.id()])return;delete this._listeners[listener.id()];--this._count};
epiviz.events.Event.prototype.notify=function(args){if(this._firing)return;if(this._count==0)return;this._firing=true;for(var id in this._listeners){if(!this._listeners.hasOwnProperty(id))continue;this._listeners[id].update(args)}this._firing=false};epiviz.events.Event.prototype.isFiring=function(){return this._firing};goog.provide("epiviz.events.EventResult");epiviz.events.EventResult=function(){this.success=null;this.errorMessage=null;this.value=null};goog.provide("epiviz.data.MessageType");epiviz.data.MessageType={REQUEST:"request",RESPONSE:"response"};goog.provide("epiviz.data.Request");epiviz.data.Request=function(id,args,method){this._id=id;this._args=args;this._method=method};epiviz.data.Request.Method={GET:"get",POST:"post"};
epiviz.data.Request.Action={GET_ROWS:"getRows",GET_VALUES:"getValues",GET_MEASUREMENTS:"getMeasurements",SEARCH:"search",GET_SEQINFOS:"getSeqInfos",SAVE_WORKSPACE:"saveWorkspace",DELETE_WORKSPACE:"deleteWorkspace",GET_WORKSPACES:"getWorkspaces",ADD_MEASUREMENTS:"addMeasurements",REMOVE_MEASUREMENTS:"removeMeasurements",ADD_SEQINFOS:"addSeqInfos",REMOVE_SEQNAMES:"removeSeqNames",ADD_CHART:"addChart",REMOVE_CHART:"removeChart",CLEAR_DATASOURCE_GROUP_CACHE:"clearDatasourceGroupCache",FLUSH_CACHE:"flushCache",
NAVIGATE:"navigate",REDRAW:"redraw",GET_CURRENT_LOCATION:"getCurrentLocation"};epiviz.data.Request.createRequest=function(args,method){return new epiviz.data.Request(epiviz.data.Request._nextId++,args,method||epiviz.data.Request.Method.GET)};epiviz.data.Request.fromRawObject=function(o){return new epiviz.data.Request(o.requestId,o.data)};epiviz.data.Request._nextId=0;epiviz.data.Request.prototype.id=function(){return this._id};epiviz.data.Request.prototype.type=function(){return epiviz.data.MessageType.REQUEST};
epiviz.data.Request.prototype.method=function(){return this._method};
epiviz.data.Request.prototype.joinArgs=function(keyValGlue,argGlue){keyValGlue=keyValGlue||"=";argGlue=argGlue||"&";var result=sprintf("requestId%s%s",keyValGlue,this._id);for(var arg in this._args){if(!this._args.hasOwnProperty(arg))continue;if(!Array.isArray(this._args[arg]))result+=sprintf("%s%s%s%s",argGlue,arg,keyValGlue,this._args[arg]||"");else for(var i=0;i<this._args[arg].length;++i)result+=sprintf("%s%s[]%s%s",argGlue,arg,keyValGlue,this._args[arg][i])}return result};
epiviz.data.Request.prototype.isEmpty=function(){for(var arg in this._args){if(!this._args.hasOwnProperty(arg))continue;return false}return true};epiviz.data.Request.prototype.get=function(arg){return arg in this._args?this._args[arg]:null};epiviz.data.Request.prototype.raw=function(){return{requestId:this._id,type:this.type(),data:epiviz.utils.mapCopy(this._args)}};epiviz.data.Request.emptyRequest=function(){return epiviz.data.Request.createRequest({})};
epiviz.data.Request.getRows=function(datasource,range){return epiviz.data.Request.createRequest({version:epiviz.EpiViz.VERSION,action:epiviz.data.Request.Action.GET_ROWS,datasource:datasource.id(),seqName:range.seqName(),start:range.start(),end:range.end(),metadata:datasource.metadata()})};
epiviz.data.Request.getValues=function(measurement,range){return epiviz.data.Request.createRequest({version:epiviz.EpiViz.VERSION,action:epiviz.data.Request.Action.GET_VALUES,datasource:measurement.datasource().id(),measurement:measurement.id(),seqName:range.seqName(),start:range.start(),end:range.end()})};epiviz.data.Request.getMeasurements=function(){return epiviz.data.Request.createRequest({version:epiviz.EpiViz.VERSION,action:epiviz.data.Request.Action.GET_MEASUREMENTS})};
epiviz.data.Request.search=function(query,maxResults){return epiviz.data.Request.createRequest({version:epiviz.EpiViz.VERSION,action:epiviz.data.Request.Action.SEARCH,q:query||"",maxResults:maxResults})};epiviz.data.Request.getSeqInfos=function(){return epiviz.data.Request.createRequest({version:epiviz.EpiViz.VERSION,action:epiviz.data.Request.Action.GET_SEQINFOS})};
epiviz.data.Request.saveWorkspace=function(workspace){return epiviz.data.Request.createRequest({version:epiviz.EpiViz.VERSION,action:epiviz.data.Request.Action.SAVE_WORKSPACE,id:workspace.id(),name:workspace.name(),content:encodeURIComponent(JSON.stringify(workspace.raw().content))},epiviz.data.Request.Method.POST)};
epiviz.data.Request.deleteWorkspace=function(workspace){return epiviz.data.Request.createRequest({version:epiviz.EpiViz.VERSION,action:epiviz.data.Request.Action.DELETE_WORKSPACE,id:workspace.id()},epiviz.data.Request.Method.POST)};epiviz.data.Request.getWorkspaces=function(filter,requestWorkspaceId){return epiviz.data.Request.createRequest({version:epiviz.EpiViz.VERSION,action:epiviz.data.Request.Action.GET_WORKSPACES,q:filter||"",ws:requestWorkspaceId})};goog.provide("epiviz.data.RequestStack");epiviz.data.RequestStack=function(){this._requests=[];this._callbacks={};this._dataMap={}};epiviz.data.RequestStack.prototype.pushRequest=function(request,callback){this._requests.push(request);this._callbacks[request.id()]=callback};
epiviz.data.RequestStack.prototype.serveData=function(response){if(!this._callbacks[response.id()])return;if(this._requests.length>0&&this._requests[0].id()==response.id()){var callback=this._callbacks[response.id()];delete this._callbacks[response.id()];this._requests=this._requests.slice(1);callback(response.data());while(this._requests.length>0&&this._requests[0].id()in this._dataMap){callback=this._callbacks[this._requests[0].id()];var data=this._dataMap[this._requests[0].id()];delete this._callbacks[this._requests[0].id()];
delete this._dataMap[this._requests[0].id()];this._requests=this._requests.slice(1);callback(data)}return}this._dataMap[response.id()]=response.data()};epiviz.data.RequestStack.prototype.clear=function(){this._requests=[];this._callbacks={};this._dataMap={}};goog.provide("epiviz.data.Response");epiviz.data.Response=function(requestId,data){this._id=requestId;this._data=data};epiviz.data.Response.prototype.id=function(){return this._id};epiviz.data.Response.prototype.data=function(){return this._data};epiviz.data.Response.prototype.type=function(){return epiviz.data.MessageType.RESPONSE};epiviz.data.Response.prototype.raw=function(){return{requestId:this._id,type:this.type(),data:this._data}};
epiviz.data.Response.fromRawObject=function(o){return new epiviz.data.Response(o.requestId,o.data)};goog.provide("epiviz.measurements.Measurement");goog.provide("epiviz.measurements.Measurement.Type");
epiviz.measurements.Measurement=function(id,name,type,datasourceId,datasourceGroup,dataprovider,formula,defaultChartType,annotation,minValue,maxValue,metadata){var MeasurementType=epiviz.measurements.Measurement.Type;this._id=id;this._name=name;this._type=type;this._datasource=type==MeasurementType.RANGE?this:new epiviz.measurements.Measurement(datasourceId,datasourceId,MeasurementType.RANGE,datasourceId,datasourceGroup,dataprovider,null,"Blocks Track",null,null,null,metadata);this._datasourceGroup=
datasourceGroup;this._dataprovider=dataprovider;this._formula=formula||null;this._defaultChartType=defaultChartType||null;this._annotation=annotation||null;this._minValue=minValue||minValue===0?minValue:null;this._maxValue=maxValue||maxValue===0?maxValue:null;this._metadata=metadata||null};epiviz.measurements.Measurement.Type={FEATURE:"feature",RANGE:"range"};epiviz.measurements.Measurement.prototype.id=function(){return this._id};epiviz.measurements.Measurement.prototype.name=function(){return this._name};
epiviz.measurements.Measurement.prototype.type=function(){return this._type};epiviz.measurements.Measurement.prototype.datasource=function(){return this._datasource};epiviz.measurements.Measurement.prototype.datasourceId=function(){return this._datasource.id()};epiviz.measurements.Measurement.prototype.datasourceGroup=function(){return this._datasourceGroup};epiviz.measurements.Measurement.prototype.dataprovider=function(){return this._dataprovider};
epiviz.measurements.Measurement.prototype.formula=function(){return this._formula};epiviz.measurements.Measurement.prototype.formulaStr=function(){if(!this._formula)return"";var referredMs=this._formula.referredMeasurements;var expression=this._formula.expression.toString();for(var formulaIndex in referredMs){if(!referredMs.hasOwnProperty(formulaIndex))continue;expression=expression.replace(new RegExp("\\{"+formulaIndex+"\\}","g")," {"+referredMs[formulaIndex].name()+"} ")}return expression};
epiviz.measurements.Measurement.prototype.evaluate=function(values){var tuple={};for(var i in this._formula.referredMeasurements){if(!this._formula.referredMeasurements.hasOwnProperty(i))continue;var m=this._formula.referredMeasurements[i];tuple["{"+i+"}"]=m.isComputed()?m.evaluate(values):values.get(m)}return this._formula.expression.evaluate(tuple)};
epiviz.measurements.Measurement.prototype.evaluateArr=function(values){var tuple={};for(var i in this._formula.referredMeasurements){if(!this._formula.referredMeasurements.hasOwnProperty(i))continue;var m=this._formula.referredMeasurements[i];tuple["{"+i+"}"]=m.isComputed()?m.evaluateArr(values):values.get(m)}return this._formula.expression.evaluateArr(tuple)};epiviz.measurements.Measurement.prototype.defaultChartType=function(){return this._defaultChartType};
epiviz.measurements.Measurement.prototype.annotation=function(){return this._annotation};epiviz.measurements.Measurement.prototype.minValue=function(){return this._minValue};epiviz.measurements.Measurement.prototype.maxValue=function(){return this._maxValue};epiviz.measurements.Measurement.prototype.metadata=function(){return this._metadata};
epiviz.measurements.Measurement.prototype.componentMeasurements=function(){var result=new epiviz.measurements.MeasurementSet;if(!this._formula){result.add(this);return result}for(var i in this._formula.referredMeasurements){if(!this._formula.referredMeasurements.hasOwnProperty(i))continue;result.addAll(this._formula.referredMeasurements[i].componentMeasurements())}return result};epiviz.measurements.Measurement.prototype.isComputed=function(){return this._formula?true:false};
epiviz.measurements.Measurement.prototype.raw=function(measurementsIndexMap){if(this._formula){var referredMeasurements=this._formula.referredMeasurements;var rawReferredMeasurements={};for(var formulaIndex in referredMeasurements){if(!referredMeasurements.hasOwnProperty(formulaIndex))continue;rawReferredMeasurements[formulaIndex]=measurementsIndexMap.get(referredMeasurements[formulaIndex])}}return{id:this._id,name:this._name,type:this._type,datasourceId:this._datasource._id,datasourceGroup:this._datasourceGroup,
dataprovider:this._dataprovider,formula:this._formula?{expression:this._formula.expression.toString(),referredMeasurements:rawReferredMeasurements}:null,defaultChartType:this._defaultChartType,annotation:this._annotation,minValue:this._minValue,maxValue:this._maxValue,metadata:this._metadata}};epiviz.measurements.Measurement.prototype.toString=function(){return this.name()};
epiviz.measurements.Measurement.fromRawObject=function(o,measurements){var formula=null;if(o.formula){var expr=epiviz.utils.ExpressionParser.parse(o.formula.expression);var refMs={};var vars=expr.variables();for(var i=0;i<vars.length;++i){if(!epiviz.utils.stringStartsWith(vars[i],"{")||!epiviz.utils.stringEndsWith(vars[i],"}"))continue;var formulaIndex=parseInt(vars[i].substring(1,vars[i].length-1));var index=o.formula.referredMeasurements[formulaIndex];refMs[formulaIndex]=measurements[index]}formula=
{expression:expr,referredMeasurements:refMs}}return new epiviz.measurements.Measurement(o.id,o.name,o.type,o.datasourceId,o.datasourceGroup,o.dataprovider,formula,o.defaultChartType,o.annotation,o.minValue,o.maxValue,o.metadata)};goog.provide("epiviz.measurements.MeasurementSet");epiviz.measurements.MeasurementSet=function(other){this._measurementTree={};this._size=0;this._order=[];if(other)this.addAll(other)};
epiviz.measurements.MeasurementSet.prototype.add=function(m){if(!(m.dataprovider()in this._measurementTree))this._measurementTree[m.dataprovider()]={};if(!(m.type()in this._measurementTree[m.dataprovider()]))this._measurementTree[m.dataprovider()][m.type()]={};if(!(m.datasourceGroup()in this._measurementTree[m.dataprovider()][m.type()]))this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()]={};if(!(m.datasource().id()in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()]))this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()]=
{};if(m.id()in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()])return false;this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()]={measurement:m,index:this._order.length};this._order.push({measurement:m,contained:true});++this._size;return true};
epiviz.measurements.MeasurementSet.prototype.remove=function(m){if(!(m.dataprovider()in this._measurementTree))return false;if(!(m.type()in this._measurementTree[m.dataprovider()]))return false;if(!(m.datasourceGroup()in this._measurementTree[m.dataprovider()][m.type()]))return false;if(!(m.datasource().id()in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()]))return false;if(!(m.id()in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()]))return false;
this._order[this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()].index].contained=false;delete this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()];--this._size;return true};
epiviz.measurements.MeasurementSet.prototype.addAll=function(measurements){if(!measurements||!measurements.size())return false;var newMeasurementsAdded=false;var self=this;measurements.foreach(function(m){if(self.add(m))newMeasurementsAdded=true;return false});return newMeasurementsAdded};
epiviz.measurements.MeasurementSet.prototype.removeAll=function(measurements){var someMeasurementsRemoved=false;var self=this;measurements.foreach(function(m){if(self.remove(m))someMeasurementsRemoved=true;return false});return someMeasurementsRemoved};epiviz.measurements.MeasurementSet.prototype.foreach=function(func,predicate){var iter=this.iterator();for(var m=iter.first(),i=0;m!==null;m=iter.next(),++i){if(predicate&&!predicate(m))continue;if(func(m,i))return}};
epiviz.measurements.MeasurementSet.prototype.iterator=function(){return new epiviz.measurements.MeasurementSet.Iterator(this)};epiviz.measurements.MeasurementSet.prototype.subset=function(predicate){var measurements=new epiviz.measurements.MeasurementSet;this.foreach(function(m){measurements.add(m)},predicate);return measurements};epiviz.measurements.MeasurementSet.prototype.size=function(){return this._size};
epiviz.measurements.MeasurementSet.prototype.contains=function(m){if(!(m.dataprovider()in this._measurementTree))return false;if(!(m.type()in this._measurementTree[m.dataprovider()]))return false;if(!(m.datasourceGroup()in this._measurementTree[m.dataprovider()][m.type()]))return false;if(!(m.datasource().id()in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()]))return false;return m.id()in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()]};
epiviz.measurements.MeasurementSet.prototype.first=function(){return this.iterator().first()};epiviz.measurements.MeasurementSet.prototype.get=function(index){if(index>=this._size||index<0)return null;if(this._size==this._order.length)return this._order[index].measurement;var result=null;this.foreach(function(m,i){if(i==index){result=m;return true}return false});return result};
epiviz.measurements.MeasurementSet.prototype.toArray=function(){var result=new Array(this._size);this.foreach(function(m,i){result[i]=m});return result};epiviz.measurements.MeasurementSet.prototype.raw=function(){var result=new Array(this._size);this.foreach(function(m,i){result[i]=m.raw()});return result};epiviz.measurements.MeasurementSet.Iterator=function(measurementSet){this._parent=measurementSet;this._lastIndex=null};
epiviz.measurements.MeasurementSet.Iterator.prototype.first=function(){if(this._parent.size()==0)return null;for(var i=0;i<this._parent._order.length;++i)if(this._parent._order[i].contained){this._lastIndex=i;return this._parent._order[i].measurement}throw Error("Inconsistent MeasurementSet with size() > 0 and no first element");};
epiviz.measurements.MeasurementSet.Iterator.prototype.next=function(){if(this._lastIndex===null)throw Error("Iterator.next() called before calling Iterator.first()");for(var i=this._lastIndex+1;i<this._parent._order.length;++i)if(this._parent._order[i].contained){this._lastIndex=i;return this._parent._order[i].measurement}this._lastIndex=this._parent._order.length;return null};goog.provide("epiviz.measurements.MeasurementHashtable");epiviz.measurements.MeasurementHashtable=function(){this._size=0;this._measurementTree={};this._order=[]};
epiviz.measurements.MeasurementHashtable.prototype.put=function(m,value){if(this.contains(m)){var existingItem=this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()];this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()]={key:m,value:value,index:existingItem.index};this._order[existingItem.index]={key:m,value:value,contained:true};return}if(!(m.dataprovider()in this._measurementTree))this._measurementTree[m.dataprovider()]=
{};if(!(m.type()in this._measurementTree[m.dataprovider()]))this._measurementTree[m.dataprovider()][m.type()]={};if(!(m.datasourceGroup()in this._measurementTree[m.dataprovider()][m.type()]))this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()]={};if(!(m.datasource().id()in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()]))this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()]={};this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()]=
{key:m,value:value,index:this._order.length};this._order.push({key:m,value:value,contained:true});++this._size};epiviz.measurements.MeasurementHashtable.prototype.get=function(m){if(!this.contains(m))return null;return this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()].value};
epiviz.measurements.MeasurementHashtable.prototype.remove=function(m){if(!this.contains(m))return false;var item=this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()];delete this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()][m.id()];this._order[item.index].contained=false;--this._size;return true};
epiviz.measurements.MeasurementHashtable.prototype.contains=function(m){if(!(m.dataprovider()in this._measurementTree))return false;if(!(m.type()in this._measurementTree[m.dataprovider()]))return false;if(!(m.datasourceGroup()in this._measurementTree[m.dataprovider()][m.type()]))return false;if(!(m.datasource().id()in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()]))return false;return m.id()in this._measurementTree[m.dataprovider()][m.type()][m.datasourceGroup()][m.datasource().id()]};
epiviz.measurements.MeasurementHashtable.prototype.clear=function(){this._size=0;this._measurementTree={};this._order=[]};epiviz.measurements.MeasurementHashtable.prototype.isEmpty=function(){return this._size==0};epiviz.measurements.MeasurementHashtable.prototype.size=function(){return this._size};
epiviz.measurements.MeasurementHashtable.prototype.foreach=function(func,predicate){var iter=this.iterator();for(var pair=iter.first(),i=0;pair!==null;pair=iter.next(),++i){if(predicate&&!predicate(pair.key))continue;if(func(pair.key,pair.value,i))return}};epiviz.measurements.MeasurementHashtable.prototype.first=function(){return this.iterator().first()};epiviz.measurements.MeasurementHashtable.prototype.iterator=function(){return new epiviz.measurements.MeasurementHashtable.Iterator(this)};
epiviz.measurements.MeasurementHashtable.Iterator=function(measurementHashtable){this._parent=measurementHashtable;this._lastIndex=null};
epiviz.measurements.MeasurementHashtable.Iterator.prototype.first=function(){if(this._parent.size()==0)return null;for(var i=0;i<this._parent._order.length;++i)if(this._parent._order[i].contained){this._lastIndex=i;return{key:this._parent._order[i].key,value:this._parent._order[i].value}}throw Error("Inconsistent MeasurementHashtable with size() > 0 and no first element");};
epiviz.measurements.MeasurementHashtable.Iterator.prototype.next=function(){if(this._lastIndex===null)throw Error("Iterator.next() called before calling Iterator.first()");for(var i=this._lastIndex+1;i<this._parent._order.length;++i)if(this._parent._order[i].contained){this._lastIndex=i;return{key:this._parent._order[i].key,value:this._parent._order[i].value}}this._lastIndex=this._parent._order.length;return null};goog.provide("epiviz.measurements.MeasurementsManager");epiviz.measurements.MeasurementsManager=function(){this._requestMeasurements=new epiviz.events.Event;this._measurementsAdded=new epiviz.events.Event;this._measurementsRemoved=new epiviz.events.Event;this._computedMeasurementsAdded=new epiviz.events.Event;this._computedMeasurementsRemoved=new epiviz.events.Event;this._measurements=new epiviz.measurements.MeasurementSet;this._computedMeasurements=new epiviz.measurements.MeasurementSet};
epiviz.measurements.MeasurementsManager.prototype.initialize=function(){this._requestMeasurements.notify()};epiviz.measurements.MeasurementsManager.prototype.onRequestMeasurements=function(){return this._requestMeasurements};epiviz.measurements.MeasurementsManager.prototype.onMeasurementsAdded=function(){return this._measurementsAdded};epiviz.measurements.MeasurementsManager.prototype.onMeasurementsRemoved=function(){return this._measurementsRemoved};
epiviz.measurements.MeasurementsManager.prototype.onComputedMeasurementsAdded=function(){return this._computedMeasurementsAdded};epiviz.measurements.MeasurementsManager.prototype.onComputedMeasurementsRemoved=function(){return this._computedMeasurementsRemoved};epiviz.measurements.MeasurementsManager.prototype.measurements=function(){return this._measurements};epiviz.measurements.MeasurementsManager.prototype.computedMeasurements=function(){return this._computedMeasurements};
epiviz.measurements.MeasurementsManager.prototype.addMeasurements=function(measurements){if(!measurements||!measurements.size())return;var self=this;this._measurements.addAll(measurements);var computedMeasurements=new epiviz.measurements.MeasurementSet;measurements.foreach(function(m){if(m.isComputed()){computedMeasurements.add(m);self._computedMeasurements.add(m)}});this._measurementsAdded.notify(measurements);if(computedMeasurements.size()>0)this._computedMeasurementsAdded.notify(computedMeasurements)};
epiviz.measurements.MeasurementsManager.prototype.removeMeasurements=function(measurements){var self=this;this._measurements.removeAll(measurements);var computedMeasurements=new epiviz.measurements.MeasurementSet;measurements.foreach(function(m){if(m.isComputed()){computedMeasurements.add(m);self._computedMeasurements.remove(m)}});this._measurementsRemoved.notify(measurements);if(computedMeasurements.size()>0)this._computedMeasurementsRemoved.notify(computedMeasurements)};
epiviz.measurements.MeasurementsManager.prototype.addMeasurement=function(measurement){var measurements=new epiviz.measurements.MeasurementSet;measurements.add(measurement);this.addMeasurements(measurements)};epiviz.measurements.MeasurementsManager.prototype.removeMeasurement=function(measurement){var measurements=new epiviz.measurements.MeasurementSet;measurements.add(measurement);this.removeMeasurements(measurements)};goog.provide("epiviz.data.DataProvider");
epiviz.data.DataProvider=function(id){this._id=id;this._requestAddSeqInfos=new epiviz.events.Event;this._requestRemoveSeqNames=new epiviz.events.Event;this._requestAddMeasurements=new epiviz.events.Event;this._requestRemoveMeasurements=new epiviz.events.Event;this._requestAddChart=new epiviz.events.Event;this._requestRemoveChart=new epiviz.events.Event;this._requestFlushCache=new epiviz.events.Event;this._requestClearDatasourceGroupCache=new epiviz.events.Event;this._requestNavigate=new epiviz.events.Event;
this._requestRedraw=new epiviz.events.Event;this._requestCurrentLocation=new epiviz.events.Event};epiviz.data.DataProvider.prototype.id=function(){return this._id};epiviz.data.DataProvider.prototype.getData=function(request,callback){callback(epiviz.data.Response.fromRawObject({requestId:request.id(),data:null}))};epiviz.data.DataProvider.prototype.onRequestAddSeqInfos=function(){return this._requestAddSeqInfos};epiviz.data.DataProvider.prototype.onRequestRemoveSeqNames=function(){return this._requestRemoveSeqNames};
epiviz.data.DataProvider.prototype.onRequestAddMeasurements=function(){return this._requestAddMeasurements};epiviz.data.DataProvider.prototype.onRequestRemoveMeasurements=function(){return this._requestRemoveMeasurements};epiviz.data.DataProvider.prototype.onRequestAddChart=function(){return this._requestAddChart};epiviz.data.DataProvider.prototype.onRequestRemoveChart=function(){return this._requestRemoveChart};epiviz.data.DataProvider.prototype.onRequestFlushCache=function(){return this._requestFlushCache};
epiviz.data.DataProvider.prototype.onRequestClearDatasourceGroupCache=function(){return this._requestClearDatasourceGroupCache};epiviz.data.DataProvider.prototype.onRequestNavigate=function(){return this._requestNavigate};epiviz.data.DataProvider.prototype.onRequestRedraw=function(){return this._requestRedraw};epiviz.data.DataProvider.prototype.onRequestCurrentLocation=function(){return this._requestCurrentLocation};goog.provide("epiviz.data.DataProviderFactory");
epiviz.data.DataProviderFactory=function(config){this._config=config;this._providers={};this._size=0;var tokens;for(var i=0;i<this._config.dataProviders.length;++i){tokens=this._config.dataProviders[i].split(",");var dataProviderConstructor=epiviz.utils.evaluateFullyQualifiedTypeName(tokens[0]);if(!dataProviderConstructor)continue;var dataProvider=epiviz.utils.applyConstructor(dataProviderConstructor,tokens.slice(1));this._providers[dataProvider.id()]=dataProvider;++this._size}var emptyProvider=new epiviz.data.EmptyResponseDataProvider;
this._providers[emptyProvider.id()]=emptyProvider;++this._size;tokens=this._config.workspacesDataProvider.split(",");var wsDataProviderConstructor=epiviz.utils.evaluateFullyQualifiedTypeName(tokens[0]);this._workspacesDataProvider=epiviz.utils.applyConstructor(wsDataProviderConstructor,tokens.slice(1))};epiviz.data.DataProviderFactory.prototype.foreach=function(func){for(var id in this._providers){if(!this._providers.hasOwnProperty(id))continue;if(func(this._providers[id]))return}};
epiviz.data.DataProviderFactory.prototype.isEmpty=function(){return!this._size};epiviz.data.DataProviderFactory.prototype.size=function(){return this._size};epiviz.data.DataProviderFactory.prototype.get=function(id){if(id in this._providers)return this._providers[id];return null};epiviz.data.DataProviderFactory.prototype.workspacesDataProvider=function(){return this._workspacesDataProvider};goog.provide("epiviz.data.Cache");epiviz.data.Cache=function(config,dataProviderFactory){this._config=config;this._dataProviderFactory=dataProviderFactory;this._data={};this._measurementRequestStackMap=new epiviz.measurements.MeasurementHashtable;this._measurementPendingRequestsMap=new epiviz.measurements.MeasurementHashtable;this._lastRequest=null;if(this._config.cacheUpdateIntervalMilliseconds>0){var self=this;this._intervalId=window.setTimeout(function(){self._clearUnneededData()},config.cacheUpdateIntervalMilliseconds)}};
epiviz.data.Cache.prototype.getData=function(range,chartMeasurementsMap,dataReadyCallback){var MeasurementType=epiviz.measurements.Measurement.Type;var self=this;this._lastRequest=epiviz.datatypes.GenomicRange.fromStartEnd(range.seqName(),range.start()-range.width(),range.end()+range.width());if(this._config.cacheUpdateIntervalMilliseconds>0){window.clearInterval(this._intervalId);this._intervalId=window.setTimeout(function(){self._clearUnneededData()},this._config.cacheUpdateIntervalMilliseconds)}var computedMs=
this._extractComputedMeasurements(chartMeasurementsMap);this._updateComputedMeasurementsData(computedMs);this._serveAvailableData(range,chartMeasurementsMap,dataReadyCallback);var requestRanges=[range,epiviz.datatypes.GenomicRange.fromStartEnd(range.seqName(),Math.max(range.start()-range.width(),0),range.start()),new epiviz.datatypes.GenomicRange(range.seqName(),range.end(),range.width())];var msNeededRanges=this._calcMeasurementNeededRanges(requestRanges,chartMeasurementsMap);msNeededRanges.foreach(function(m,
ranges){var requestStack=self._measurementRequestStackMap.get(m);if(!requestStack){requestStack=new epiviz.data.RequestStack;self._measurementRequestStackMap.put(m,requestStack)}var request;if(ranges.length==0){request=epiviz.data.Request.emptyRequest();requestStack.pushRequest(request,function(){self._handleResponse(dataReadyCallback,range,chartMeasurementsMap,request,null,m,null)});requestStack.serveData(new epiviz.data.Response(request.id(),{}));return}for(var i=0;i<ranges.length;++i){request=
m.type()==MeasurementType.RANGE?epiviz.data.Request.getRows(m,ranges[i]):epiviz.data.Request.getValues(m,ranges[i]);(function(r,request){requestStack.pushRequest(request,function(data){self._handleResponse(dataReadyCallback,range,chartMeasurementsMap,request,r,m,data)})})(ranges[i],request);var pendingRequests=self._measurementPendingRequestsMap.get(m);if(!pendingRequests){pendingRequests={};self._measurementPendingRequestsMap.put(m,pendingRequests)}pendingRequests[request.id()]=ranges[i];var dataProvider=
self._dataProviderFactory.get(m.dataprovider())||self._dataProviderFactory.get(epiviz.data.EmptyResponseDataProvider.DEFAULT_ID);dataProvider.getData(request,function(response){requestStack.serveData(response)})}})};
epiviz.data.Cache.prototype._handleResponse=function(chartDataReadyCallback,chartRequestedRange,chartMeasurementsMap,request,range,measurement,rawData){if(range){var genomicArray=measurement.type()==epiviz.measurements.Measurement.Type.RANGE?new epiviz.datatypes.GenomicRangeArray(measurement,range,rawData.globalStartIndex,rawData.values,rawData.useOffset):new epiviz.datatypes.FeatureValueArray(measurement,range,rawData.globalStartIndex,rawData.values);this._mergeData(measurement,genomicArray)}var computedMs=
this._extractComputedMeasurements(chartMeasurementsMap);this._updateComputedMeasurementsData(computedMs);delete this._measurementPendingRequestsMap.get(measurement)[request.id()];this._serveAvailableData(chartRequestedRange,chartMeasurementsMap,chartDataReadyCallback)};
epiviz.data.Cache.prototype._serveAvailableData=function(range,chartMeasurementsMap,dataReadyCallback){var MeasurementType=epiviz.measurements.Measurement.Type;var self=this;var servedChartIds=[];for(var chartId in chartMeasurementsMap){if(!chartMeasurementsMap.hasOwnProperty(chartId))continue;var chartMeasurements=chartMeasurementsMap[chartId];var allDataAvailable=true;var chartData=new epiviz.measurements.MeasurementHashtable;(function(chartData){chartMeasurements.foreach(function(m){var storedData=
self._data[m.datasourceGroup()];if(!storedData||!storedData.rowData()||m.type()==MeasurementType.FEATURE&&!storedData.values(m)){allDataAvailable=false;return true}var rowData=storedData.rowData();var valueData=m.type()==MeasurementType.FEATURE?storedData.values(m):null;var neededRanges=range.subtract(rowData.boundaries());if(neededRanges.length){allDataAvailable=false;return true}if(valueData){neededRanges=range.subtract(valueData.boundaries());if(neededRanges.length){allDataAvailable=false;return true}}chartData.put(m,
new epiviz.datatypes.GenomicDataMeasurementWrapper(m,self._data[m.datasourceGroup()]));return false})})(chartData);if(allDataAvailable){dataReadyCallback(chartId,chartData);servedChartIds.push(chartId)}}for(var i=0;i<servedChartIds.length;++i)delete chartMeasurementsMap[servedChartIds[i]]};
epiviz.data.Cache.prototype._calcMeasurementNeededRanges=function(ranges,chartMeasurementsMap){var MeasurementType=epiviz.measurements.Measurement.Type;var self=this;var result=new epiviz.measurements.MeasurementHashtable;for(var chartId in chartMeasurementsMap){if(!chartMeasurementsMap.hasOwnProperty(chartId))continue;var chartMeasurements=new epiviz.measurements.MeasurementSet;(function(chartMeasurements){chartMeasurementsMap[chartId].foreach(function(m){var compMs=m.componentMeasurements();compMs.foreach(function(compM){chartMeasurements.add(compM);
chartMeasurements.add(compM.datasource())});if(!m.isComputed())chartMeasurements.add(m.datasource())})})(chartMeasurements);chartMeasurements.foreach(function(m){var neededRanges=null;var storedData=self._data[m.datasourceGroup()];if(!storedData||m.type()==MeasurementType.FEATURE&&!storedData.values(m))neededRanges=ranges.slice(0);else{var data=m.type()==MeasurementType.FEATURE?storedData.values(m):storedData.rowData();if(!data)neededRanges=ranges.slice(0);else{neededRanges=[];var boundaries=data.boundaries();
for(var i=0;i<ranges.length;++i)neededRanges=neededRanges.concat(ranges[i].subtract(boundaries))}}var pendingRequests=self._measurementPendingRequestsMap.get(m);if(pendingRequests)for(var j=0;j<neededRanges.length;++j)for(var requestId in pendingRequests){if(!pendingRequests.hasOwnProperty(requestId))continue;var dif=neededRanges[j].subtract(pendingRequests[requestId]);Array.prototype.splice.apply(neededRanges,[j,1].concat(dif));if(j>=neededRanges.length)break}result.put(m,neededRanges)})}return result};
epiviz.data.Cache.prototype._extractComputedMeasurements=function(chartMeasurementsMap){var result=new epiviz.measurements.MeasurementSet;for(var chartId in chartMeasurementsMap){if(!chartMeasurementsMap.hasOwnProperty(chartId))continue;chartMeasurementsMap[chartId].foreach(function(m){if(m.isComputed())result.add(m)})}return result};
epiviz.data.Cache.prototype._mergeData=function(measurement,data){var MeasurementType=epiviz.measurements.Measurement.Type;var storedData=this._data[measurement.datasourceGroup()];if(!storedData){storedData=new epiviz.datatypes.PartialSummarizedExperiment;this._data[measurement.datasourceGroup()]=storedData}if(measurement.type()==MeasurementType.RANGE){storedData.addRowData(data);return}storedData.addValues(data)};
epiviz.data.Cache.prototype._clearUnneededData=function(){if(!this._lastRequest)return;console.log(sprintf("Clearing data outside of range [%7s%10s%10s]",this._lastRequest.seqName(),this._lastRequest.start(),this._lastRequest.end()));var self=this;var newData={};for(var datasourceGroup in this._data){if(!this._data.hasOwnProperty(datasourceGroup))continue;var exp=this._data[datasourceGroup];newData[datasourceGroup]=exp.trim(self._lastRequest)}this._data=newData};
epiviz.data.Cache.prototype._updateComputedMeasurementsData=function(computedMs){var self=this;var GenomicRange=epiviz.datatypes.GenomicRange;computedMs.foreach(function(cm){var storedData=self._data[cm.datasourceGroup()];if(!storedData)return false;var componentMeasurements=cm.componentMeasurements();var globalStartIndex=null;var size=null;var boundaries=null;componentMeasurements.foreach(function(m){var values=storedData.values(m);if(!values||!values.boundaries()){globalStartIndex=null;size=null;
boundaries=null;return true}if(boundaries===null){globalStartIndex=values.globalStartIndex();size=values.size();boundaries=values.boundaries();return globalStartIndex===null}if(values.boundaries().seqName()!=boundaries.seqName()){size=0;return true}if(globalStartIndex<values.globalStartIndex()){size-=values.globalStartIndex()-globalStartIndex;if(size<0){size=0;return true}globalStartIndex=values.globalStartIndex();var start=values.boundaries().start(),end=boundaries.end();if(size>values.size()){size=
values.size();end=values.boundaries().end()}boundaries=GenomicRange.fromStartEnd(boundaries.seqName(),start,end)}else{var newSize=values.size()-globalStartIndex+values.globalStartIndex();if(size>newSize){size=newSize;if(size<=0){size=0;return true}boundaries=GenomicRange.fromStartEnd(boundaries.seqName(),boundaries.start(),values.boundaries().end())}}if(size==0)return true;return false});if(boundaries===null)return false;var existingValues=storedData.values(cm);if(existingValues&&(globalStartIndex===
null||existingValues.globalStartIndex()<globalStartIndex&&existingValues.globalStartIndex()+existingValues.size()>globalStartIndex+size))return false;var compMsVals=new epiviz.measurements.MeasurementHashtable;var values=null;if(existingValues&&existingValues.size()){componentMeasurements.foreach(function(m){var v=storedData.values(m);var mVals=[];if(globalStartIndex!==null)for(var index=globalStartIndex;index<existingValues.globalStartIndex();++index)mVals.push(v.getByGlobalIndex(index));compMsVals.put(m,
mVals)});values=new epiviz.datatypes.FeatureValueArray(cm,GenomicRange.fromStartEnd(boundaries.seqName(),boundaries.start(),existingValues.boundaries().start()),globalStartIndex,cm.evaluateArr(compMsVals));self._mergeData(cm,values);compMsVals=new epiviz.measurements.MeasurementHashtable;componentMeasurements.foreach(function(m){var v=storedData.values(m);var mVals=[];if(globalStartIndex!==null)for(var index=existingValues.globalStartIndex()+existingValues.size();index<globalStartIndex+size;++index)mVals.push(v.getByGlobalIndex(index));
compMsVals.put(m,mVals)});values=new epiviz.datatypes.FeatureValueArray(cm,GenomicRange.fromStartEnd(boundaries.seqName(),existingValues.boundaries().end(),boundaries.end()),existingValues.globalStartIndex()+existingValues.size(),cm.evaluateArr(compMsVals));self._mergeData(cm,values);return false}compMsVals=new epiviz.measurements.MeasurementHashtable;componentMeasurements.foreach(function(m){var v=storedData.values(m);var mVals=[];if(globalStartIndex!==null)for(var index=globalStartIndex;index<globalStartIndex+
size;++index)mVals.push(v.getByGlobalIndex(index));compMsVals.put(m,mVals)});values=new epiviz.datatypes.FeatureValueArray(cm,boundaries,globalStartIndex,cm.evaluateArr(compMsVals));self._mergeData(cm,values);return false})};epiviz.data.Cache.prototype.flush=function(){this._data={};this._measurementRequestStackMap.foreach(function(m,requestStack){requestStack.clear()});this._measurementPendingRequestsMap.clear()};
epiviz.data.Cache.prototype.clearDatasourceGroupCache=function(datasourceGroup){delete this._data[datasourceGroup];this._measurementRequestStackMap.foreach(function(m,requestStack){if(m.datasourceGroup()==datasourceGroup)requestStack.clear()});var msToClear=[];this._measurementPendingRequestsMap.foreach(function(m,map){if(m.datasourceGroup()==datasourceGroup)msToClear.push(m)});for(var i=0;i<msToClear.length;++i)this._measurementPendingRequestsMap.put(msToClear[i],{})};goog.provide("epiviz.data.DataManager");goog.require("epiviz.data.DataProvider");goog.require("epiviz.data.DataProviderFactory");goog.require("epiviz.measurements.MeasurementSet");goog.require("epiviz.events.EventListener");
epiviz.data.DataManager=function(config,dataProviderFactory){this._config=config;this._measurements=new epiviz.measurements.MeasurementSet;this._dataProviderFactory=dataProviderFactory;this._cache=new epiviz.data.Cache(config,dataProviderFactory);this._requestAddMeasurements=new epiviz.events.Event;this._requestRemoveMeasurements=new epiviz.events.Event;this._requestAddChart=new epiviz.events.Event;this._requestRemoveChart=new epiviz.events.Event;this._requestAddSeqInfos=new epiviz.events.Event;this._requestRemoveSeqNames=
new epiviz.events.Event;this._requestNavigate=new epiviz.events.Event;this._requestRedraw=new epiviz.events.Event;this._flushCache=new epiviz.events.Event;this._clearDatasourceGroupCache=new epiviz.events.Event;this._requestCurrentLocation=new epiviz.events.Event;this._registerProviderAddMeasurements();this._registerProviderRemoveMeasurements();this._registerProviderAddChart();this._registerProviderRemoveChart();this._registerProviderAddSeqInfos();this._registerProviderRemoveSeqNames();this._registerProviderNavigate();
this._registerProviderRedraw();this._registerProviderFlushCache();this._registerProviderClearDatasourceGroupCache();this._registerProviderGetCurrentLocation()};epiviz.data.DataManager.prototype.onRequestAddMeasurements=function(){return this._requestAddMeasurements};epiviz.data.DataManager.prototype.onRequestRemoveMeasurements=function(){return this._requestRemoveMeasurements};epiviz.data.DataManager.prototype.onRequestAddChart=function(){return this._requestAddChart};
epiviz.data.DataManager.prototype.onRequestRemoveChart=function(){return this._requestRemoveChart};epiviz.data.DataManager.prototype.onRequestAddSeqInfos=function(){return this._requestAddSeqInfos};epiviz.data.DataManager.prototype.onRequestRemoveSeqNames=function(){return this._requestRemoveSeqNames};epiviz.data.DataManager.prototype.onRequestNavigate=function(){return this._requestNavigate};epiviz.data.DataManager.prototype.onRequestRedraw=function(){return this._requestRedraw};
epiviz.data.DataManager.prototype.onClearDatasourceGroupCache=function(){return this._clearDatasourceGroupCache};epiviz.data.DataManager.prototype.onFlushCache=function(){return this._flushCache};epiviz.data.DataManager.prototype.onRequestCurrentLocation=function(){return this._requestCurrentLocation};
epiviz.data.DataManager.prototype.getSeqInfos=function(callback){var self=this;var nResponses=0;var existingSeqNames={};var result=[];this._dataProviderFactory.foreach(function(provider){provider.getData(epiviz.data.Request.getSeqInfos(),function(response){var seqs=response.data();if(seqs)for(var i=0;i<seqs.length;++i)if(!(seqs[i][0]in existingSeqNames)){result.push(epiviz.datatypes.SeqInfo.fromRawObject(seqs[i]));existingSeqNames[seqs[i][0]]=true}if(++nResponses<self._dataProviderFactory.size())return;
callback(result.sort(epiviz.datatypes.SeqInfo.compare))})})};
epiviz.data.DataManager.prototype.getMeasurements=function(callback){var self=this;var result=new epiviz.measurements.MeasurementSet;var nResponses=0;this._dataProviderFactory.foreach(function(provider){provider.getData(epiviz.data.Request.getMeasurements(),function(response){var jsondata=response.data();if(jsondata){var n=jsondata["id"]?jsondata["id"].length||0:0;for(var i=0;i<n;++i)result.add(new epiviz.measurements.Measurement(jsondata["id"][i],jsondata["name"][i],jsondata["type"][i],jsondata["datasourceId"][i],
jsondata["datasourceGroup"][i],provider.id(),null,jsondata["defaultChartType"][i],jsondata["annotation"][i],jsondata["minValue"][i],jsondata["maxValue"][i],jsondata["metadata"][i]))}if(++nResponses<self._dataProviderFactory.size())return;callback(result)})})};epiviz.data.DataManager.prototype.getData=function(range,chartMeasurementsMap,dataReadyCallback){this._cache.getData(range,chartMeasurementsMap,dataReadyCallback)};
epiviz.data.DataManager.prototype.getWorkspaces=function(callback,filter,requestWorkspaceId){var workspaceProvider=this._dataProviderFactory.workspacesDataProvider();if(!workspaceProvider)throw Error("Invalid data provider for workspaces (see Config.workspaceDataProvider)");workspaceProvider.getData(epiviz.data.Request.getWorkspaces(filter,requestWorkspaceId),function(response){var wsRows=response.data();var workspaces=[];if(!wsRows||!wsRows.length){callback(workspaces);return}for(var i=0;i<wsRows.length;++i)workspaces.push({id:wsRows[i].id,
name:wsRows[i].name,content:JSON.parse(wsRows[i].content)});callback(workspaces)})};epiviz.data.DataManager.prototype.saveWorkspace=function(workspace,callback){var workspaceProvider=this._dataProviderFactory.workspacesDataProvider();if(!workspaceProvider)throw Error("Invalid data provider for workspaces (see Config.workspaceDataProvider)");workspaceProvider.getData(epiviz.data.Request.saveWorkspace(workspace),function(response){var workspaceId=response.data();callback(workspaceId)})};
epiviz.data.DataManager.prototype.deleteWorkspace=function(workspace){var workspaceProvider=this._dataProviderFactory.workspacesDataProvider();if(!workspaceProvider)throw Error("Invalid data provider for workspaces (see Config.workspaceDataProvider)");workspaceProvider.getData(epiviz.data.Request.deleteWorkspace(workspace),function(response){var success=response.data().success})};
epiviz.data.DataManager.prototype.search=function(callback,query){var self=this;var remainingResponses=this._dataProviderFactory.size();var results=[];this._dataProviderFactory.foreach(function(provider){provider.getData(epiviz.data.Request.search(query,self._config.maxSearchResults),function(response){var providerResults=response.data();if(providerResults)epiviz.utils.arrayAppend(results,providerResults);--remainingResponses;if(!remainingResponses)callback(results)})})};
epiviz.data.DataManager.prototype.flushCache=function(){this._cache.flush();this._flushCache.notify()};epiviz.data.DataManager.prototype.clearDatasourceGroupCache=function(datasourceGroup){this._cache.clearDatasourceGroupCache(datasourceGroup);this._clearDatasourceGroupCache.notify({datasourceGroup:datasourceGroup})};epiviz.data.DataManager.prototype._registerProviderAddMeasurements=function(){var self=this;this._dataProviderFactory.foreach(function(provider){provider.onRequestAddMeasurements().addListener(new epiviz.events.EventListener(function(e){self._requestAddMeasurements.notify(e)}))})};
epiviz.data.DataManager.prototype._registerProviderRemoveMeasurements=function(){var self=this;this._dataProviderFactory.foreach(function(provider){provider.onRequestRemoveMeasurements().addListener(new epiviz.events.EventListener(function(e){self._requestRemoveMeasurements.notify(e)}))})};epiviz.data.DataManager.prototype._registerProviderAddChart=function(){var self=this;this._dataProviderFactory.foreach(function(provider){provider.onRequestAddChart().addListener(new epiviz.events.EventListener(function(e){self._requestAddChart.notify(e)}))})};
epiviz.data.DataManager.prototype._registerProviderRemoveChart=function(){var self=this;this._dataProviderFactory.foreach(function(provider){provider.onRequestRemoveChart().addListener(new epiviz.events.EventListener(function(e){self._requestRemoveChart.notify(e)}))})};
epiviz.data.DataManager.prototype._registerProviderAddSeqInfos=function(){var self=this;this._dataProviderFactory.foreach(function(provider){provider.onRequestAddSeqInfos().addListener(new epiviz.events.EventListener(function(e){var seqInfos=[];for(var i=0;i<e.seqInfos.length;++i)seqInfos.push(epiviz.datatypes.SeqInfo.fromRawObject(e.seqInfos[i]));self._requestAddSeqInfos.notify({seqInfos:seqInfos,result:e.result})}))})};
epiviz.data.DataManager.prototype._registerProviderRemoveSeqNames=function(){var self=this;this._dataProviderFactory.foreach(function(provider){provider.onRequestRemoveSeqNames().addListener(new epiviz.events.EventListener(function(e){self._requestRemoveSeqNames.notify(e)}))})};epiviz.data.DataManager.prototype._registerProviderNavigate=function(){var self=this;this._dataProviderFactory.foreach(function(provider){provider.onRequestNavigate().addListener(new epiviz.events.EventListener(function(e){self._requestNavigate.notify(e)}))})};
epiviz.data.DataManager.prototype._registerProviderRedraw=function(){var self=this;this._dataProviderFactory.foreach(function(provider){provider.onRequestRedraw().addListener(new epiviz.events.EventListener(function(e){self._requestRedraw.notify(e)}))})};
epiviz.data.DataManager.prototype._registerProviderClearDatasourceGroupCache=function(){var self=this;this._dataProviderFactory.foreach(function(provider){provider.onRequestClearDatasourceGroupCache().addListener(new epiviz.events.EventListener(function(e){self.clearDatasourceGroupCache(e.datasourceGroup);e.result.success=true}))})};
epiviz.data.DataManager.prototype._registerProviderFlushCache=function(){var self=this;this._dataProviderFactory.foreach(function(provider){provider.onRequestFlushCache().addListener(new epiviz.events.EventListener(function(e){self.flushCache();e.result.success=true}))})};epiviz.data.DataManager.prototype._registerProviderGetCurrentLocation=function(){var self=this;this._dataProviderFactory.foreach(function(provider){provider.onRequestCurrentLocation().addListener(new epiviz.events.EventListener(function(e){self._requestCurrentLocation.notify(e)}))})};goog.provide("epiviz.data.EmptyResponseDataProvider");epiviz.data.EmptyResponseDataProvider=function(){epiviz.data.DataProvider.call(this,epiviz.data.EmptyResponseDataProvider.DEFAULT_ID)};epiviz.data.EmptyResponseDataProvider.prototype=epiviz.utils.mapCopy(epiviz.data.DataProvider.prototype);epiviz.data.EmptyResponseDataProvider.constructor=epiviz.data.EmptyResponseDataProvider;epiviz.data.EmptyResponseDataProvider.DEFAULT_ID="empty";
epiviz.data.EmptyResponseDataProvider.prototype.getData=function(request,callback){var requestId=request.id();var action=request.get("action");switch(action){case epiviz.data.Request.Action.GET_ROWS:callback(epiviz.data.Response.fromRawObject({data:{values:{id:null,start:[],end:[],strand:[],metadata:{my_metadata:[]}},globalStartIndex:null,useOffset:false},requestId:requestId}));return;case epiviz.data.Request.Action.GET_VALUES:callback(epiviz.data.Response.fromRawObject({data:{values:[],globalStartIndex:null},
requestId:requestId}));return;case epiviz.data.Request.Action.GET_MEASUREMENTS:callback(epiviz.data.Response.fromRawObject({requestId:request.id(),data:{id:[],name:[],type:[],datasourceId:[],datasourceGroup:[],defaultChartType:[],annotation:[],minValue:[],maxValue:[],metadata:[]}}));return;case epiviz.data.Request.Action.GET_SEQINFOS:callback(epiviz.data.Response.fromRawObject({requestId:request.id(),data:[]}));return;case epiviz.data.Request.Action.SEARCH:callback(epiviz.data.Response.fromRawObject({requestId:request.id(),
data:[]}));return;default:epiviz.data.DataProvider.prototype.getData.call(this,request,callback);break}};goog.provide("epiviz.data.WebsocketDataProvider");epiviz.data.WebsocketDataProvider=function(id,websocketHost){epiviz.data.DataProvider.call(this,id||epiviz.data.WebsocketDataProvider.DEFAULT_ID);this._websocketHost=websocketHost;this._socket=null;this._useUI=epiviz.ui.WebArgsManager.WEB_ARGS["websocketNoUI"]!="true";this._debug=epiviz.ui.WebArgsManager.WEB_ARGS["debug"]=="true";this._callbacks={};this._requestsStack=[];this._initialize()};epiviz.data.WebsocketDataProvider.prototype=epiviz.utils.mapCopy(epiviz.data.DataProvider.prototype);
epiviz.data.WebsocketDataProvider.constructor=epiviz.data.WebsocketDataProvider;epiviz.data.WebsocketDataProvider.DEFAULT_ID="websocket";
epiviz.data.WebsocketDataProvider.prototype._initialize=function(){if(!this._websocketHost||this._websocketHost=="None")return;try{this._socket=new WebSocket(this._websocketHost);this._log("WebSocket - status "+this._socket.readyState);var self=this;this._socket.onopen=function(){self._onSocketOpen()};this._socket.onmessage=function(msg){self._onSocketMessage(msg)};this._socket.onclose=function(){self._onSocketClose()}}catch(error){this._log(error.toString())}};
epiviz.data.WebsocketDataProvider.prototype._onSocketOpen=function(){for(var i=0;i<this._requestsStack.length;++i)this._socket.send(this._requestsStack[i]);this._requestsStack=[]};epiviz.data.WebsocketDataProvider.prototype._onSocketClose=function(){this._socket=null};epiviz.data.WebsocketDataProvider.prototype._sendMessage=function(message){if(this.connected()&&this._socket.readyState)this._socket.send(message);else this._requestsStack.push(message)};
epiviz.data.WebsocketDataProvider.prototype._onSocketMessage=function(msg){this._log("Local Controller Received: "+msg.data);var message=JSON.parse(msg.data);if(message["type"]==epiviz.data.MessageType.RESPONSE){var response=epiviz.data.Response.fromRawObject(message);var callback=this._callbacks[response.id()];delete this._callbacks[response.id()];callback(response)}else if(message["type"]==epiviz.data.MessageType.REQUEST){var Action=epiviz.data.Request.Action;var request=epiviz.data.Request.fromRawObject(message);
switch(request.get("action")){case Action.ADD_MEASUREMENTS:this._addMeasurements(request);break;case Action.REMOVE_MEASUREMENTS:this._removeMeasurements(request);break;case Action.ADD_SEQINFOS:this._addSeqInfos(request);break;case Action.REMOVE_SEQNAMES:this._removeSeqNames(request);break;case Action.ADD_CHART:this._addChart(request);break;case Action.REMOVE_CHART:this._removeChart(request);break;case Action.CLEAR_DATASOURCE_GROUP_CACHE:this._clearDatasourceGroupCache(request);break;case Action.FLUSH_CACHE:this._flushCache(request);
break;case Action.NAVIGATE:this._navigate(request);break;case Action.REDRAW:this._redraw(request);break;case Action.GET_CURRENT_LOCATION:this._getCurrentLocation(request);break}}};epiviz.data.WebsocketDataProvider.prototype._log=function(message){if(this._debug)console.log(message)};epiviz.data.WebsocketDataProvider.prototype._fireEvent=function(event,args){if(!this._useUI){args.result.success=true;return}event.notify(args)};
epiviz.data.WebsocketDataProvider.prototype.connected=function(){return this._socket!=null};epiviz.data.WebsocketDataProvider.prototype.getData=function(request,callback){var message=JSON.stringify(request.raw());this._callbacks[request.id()]=callback;this._sendMessage(message)};
epiviz.data.WebsocketDataProvider.prototype._addMeasurements=function(request){var result=new epiviz.events.EventResult;var measurements=new epiviz.measurements.MeasurementSet;var rawMeasurements=JSON.parse(request.get("measurements"));for(var i=0;i<rawMeasurements.length;++i)measurements.add(new epiviz.measurements.Measurement(rawMeasurements[i]["id"],rawMeasurements[i]["name"],rawMeasurements[i]["type"],rawMeasurements[i]["datasourceId"],rawMeasurements[i]["datasourceGroup"],this.id(),null,rawMeasurements[i]["defaultChartType"],
rawMeasurements[i]["annotation"],rawMeasurements[i]["minValue"],rawMeasurements[i]["maxValue"],rawMeasurements[i]["metadata"]));this._fireEvent(this.onRequestAddMeasurements(),{measurements:measurements,result:result});var response=new epiviz.data.Response(request.id(),result);this._sendMessage(JSON.stringify(response.raw()))};
epiviz.data.WebsocketDataProvider.prototype._removeMeasurements=function(request){var result=new epiviz.events.EventResult;var measurements=new epiviz.measurements.MeasurementSet;var rawMeasurements=JSON.parse(request.get("measurements"));for(var i=0;i<rawMeasurements.length;++i)measurements.add(new epiviz.measurements.Measurement(rawMeasurements[i]["id"],rawMeasurements[i]["name"],rawMeasurements[i]["type"],rawMeasurements[i]["datasourceId"],rawMeasurements[i]["datasourceGroup"],this.id(),null,rawMeasurements[i]["defaultChartType"],
rawMeasurements[i]["annotation"],rawMeasurements[i]["minValue"],rawMeasurements[i]["maxValue"],rawMeasurements[i]["metadata"]));this._fireEvent(this.onRequestRemoveMeasurements(),{measurements:measurements,result:result});var response=new epiviz.data.Response(request.id(),result);this._sendMessage(JSON.stringify(response.raw()))};
epiviz.data.WebsocketDataProvider.prototype._addSeqInfos=function(request){var result=new epiviz.events.EventResult;var seqInfos=JSON.parse(request.get("seqInfos"));this._fireEvent(this.onRequestAddSeqInfos(),{seqInfos:seqInfos,result:result});var response=new epiviz.data.Response(request.id(),result);this._sendMessage(JSON.stringify(response.raw()))};
epiviz.data.WebsocketDataProvider.prototype._removeSeqNames=function(request){var result=new epiviz.events.EventResult;var seqNames=JSON.parse(request.get("seqNames"));this._fireEvent(this.onRequestRemoveSeqNames(),{seqNames:seqNames,result:result});var response=new epiviz.data.Response(request.id(),result);this._sendMessage(JSON.stringify(response.raw()))};
epiviz.data.WebsocketDataProvider.prototype._addChart=function(request){var result=new epiviz.events.EventResult;var measurements=new epiviz.measurements.MeasurementSet;var rawMeasurements=JSON.parse(request.get("measurements"));for(var i=0;i<rawMeasurements.length;++i)measurements.add(new epiviz.measurements.Measurement(rawMeasurements[i]["id"],rawMeasurements[i]["name"],rawMeasurements[i]["type"],rawMeasurements[i]["datasourceId"],rawMeasurements[i]["datasourceGroup"],this.id(),null,rawMeasurements[i]["defaultChartType"],
rawMeasurements[i]["annotation"],rawMeasurements[i]["minValue"],rawMeasurements[i]["maxValue"],rawMeasurements[i]["metadata"]));this._fireEvent(this.onRequestAddChart(),{type:request.get("type"),measurements:measurements,result:result});var response=new epiviz.data.Response(request.id(),result);this._sendMessage(JSON.stringify(response.raw()))};
epiviz.data.WebsocketDataProvider.prototype._removeChart=function(request){var chartId=request.get("chartId");var result=new epiviz.events.EventResult;this._fireEvent(this.onRequestRemoveChart(),{id:chartId,result:result});var response=new epiviz.data.Response(request.id(),result);this._sendMessage(JSON.stringify(response.raw()))};
epiviz.data.WebsocketDataProvider.prototype._clearDatasourceGroupCache=function(request){var result=new epiviz.events.EventResult;this._fireEvent(this.onRequestClearDatasourceGroupCache(),{datasourceGroup:request.get("datasourceGroup"),result:result});var response=new epiviz.data.Response(request.id(),result);this._sendMessage(JSON.stringify(response.raw()))};
epiviz.data.WebsocketDataProvider.prototype._flushCache=function(request){var result=new epiviz.events.EventResult;this._fireEvent(this.onRequestFlushCache(),{result:result});var response=new epiviz.data.Response(request.id(),result);this._sendMessage(JSON.stringify(response.raw()))};
epiviz.data.WebsocketDataProvider.prototype._navigate=function(request){var range=JSON.parse(request.get("range"));var result=new epiviz.events.EventResult;this._fireEvent(this.onRequestNavigate(),{range:epiviz.datatypes.GenomicRange.fromStartEnd(range.seqName,range.start,range.end),result:result});var response=new epiviz.data.Response(request.id(),result);this._sendMessage(JSON.stringify(response.raw()))};
epiviz.data.WebsocketDataProvider.prototype._redraw=function(request){var result=new epiviz.events.EventResult;this._fireEvent(this.onRequestRedraw(),{result:result});var response=new epiviz.data.Response(request.id(),result);this._sendMessage(JSON.stringify(response.raw()))};
epiviz.data.WebsocketDataProvider.prototype._getCurrentLocation=function(request){var result=new epiviz.events.EventResult;this._fireEvent(this.onRequestCurrentLocation(),{result:result});var response=new epiviz.data.Response(request.id(),result);this._sendMessage(JSON.stringify(response.raw()))};goog.provide("epiviz.data.WebServerDataProvider");epiviz.data.WebServerDataProvider=function(id,serverEndpoint){epiviz.data.DataProvider.call(this,id||epiviz.data.WebServerDataProvider.DEFAULT_ID);this._serverEndpoint=serverEndpoint||epiviz.data.WebServerDataProvider.DEFAULT_SERVER_ENDPOINT};epiviz.data.WebServerDataProvider.prototype=epiviz.utils.mapCopy(epiviz.data.DataProvider.prototype);epiviz.data.WebServerDataProvider.constructor=epiviz.data.WebServerDataProvider;
epiviz.data.WebServerDataProvider.DEFAULT_ID="umd";epiviz.data.WebServerDataProvider.DEFAULT_SERVER_ENDPOINT="data/main.php";
epiviz.data.WebServerDataProvider.prototype.getData=function(request,callback){if(request.isEmpty())return;if(request.method()==epiviz.data.Request.Method.GET){var query=sprintf("%s?%s",this._serverEndpoint,request.joinArgs());epiviz.data.WebServerDataProvider.makeGetRequest(query,function(jsondata){callback(epiviz.data.Response.fromRawObject(jsondata))})}else epiviz.data.WebServerDataProvider.makePostRequest(this._serverEndpoint,request.joinArgs(),function(jsondata){callback(epiviz.data.Response.fromRawObject(jsondata))})};
epiviz.data.WebServerDataProvider.makeGetRequest=function(query,callback){var request=$.ajax({type:"get",url:query,dataType:"json",async:true,cache:false,processData:true});request.done(function(jsonData){callback(jsonData)});request.fail(function(jqXHR,textStatus,errorThrown){});request.always(function(){})};
epiviz.data.WebServerDataProvider.makePostRequest=function(query,postData,callback){var request=$.ajax({type:"post",url:query,data:postData,dataType:"json",async:true,cache:false,processData:true});request.done(function(data,textStatus,jqXHR){callback(data)});request.fail(function(jqXHR,textStatus,errorThrown){console.error("The following error occured: "+textStatus,errorThrown);$("#php-response").append(jqXHR.responseText)});request.always(function(){})};goog.provide("epiviz.data.MockDataProvider");
epiviz.data.MockDataProvider=function(id){epiviz.data.DataProvider.call(this,id||epiviz.data.MockDataProvider.DEFAULT_ID);this._measurements=new epiviz.measurements.MeasurementSet;this._m1=null;this._m2=null;this._values=new epiviz.measurements.MeasurementHashtable;this._coveredRegions=[epiviz.datatypes.GenomicRange.fromStartEnd("chr6",103839409,107422589),epiviz.datatypes.GenomicRange.fromStartEnd("myChr",103839409,107422589)];this._addSeqnamesButton=$("#button-mock-add-seqnames");this._removeSeqnamesButton=
$("#button-mock-remove-seqnames");this._addMeasurementsButton=$("#button-mock-add-measurements");this._removeMeasurementsButton=$("#button-mock-remove-measurements");this._addChartButton=$("#button-mock-add-chart");this._removeChartButton=$("#button-mock-remove-chart");this._clearCacheButton=$("#button-mock-clear-cache");this._navigateButton=$("#button-mock-navigate");this._initialize();this._initializeButtonHandlers()};epiviz.data.MockDataProvider.prototype=epiviz.utils.mapCopy(epiviz.data.DataProvider.prototype);
epiviz.data.MockDataProvider.constructor=epiviz.data.MockDataProvider;epiviz.data.MockDataProvider.DEFAULT_ID="mock-provider";
epiviz.data.MockDataProvider.prototype._initialize=function(){var m1=new epiviz.measurements.Measurement("column_1_feature","Mock Feature Measurement 1",epiviz.measurements.Measurement.Type.FEATURE,"mock_gene_expression","affymetrix_probeset",this.id(),null,"Scatter Plot",null,-5,25,["probe"]);var m2=new epiviz.measurements.Measurement("table_2_range","Mock Range Measurement 2",epiviz.measurements.Measurement.Type.RANGE,"table_2_range","some_datasource_group",this.id(),null,"Blocks Track",null,null,
null,null);this._m1=m1;this._m2=m2;this._measurements.add(m1);this._values.put(m1,{chr6:{values:[-1.8223838498414,-.61258676716977,-.47866833545712,-.054737753101232,-.17442192545694,-.40962816952573,3.1485057281967,3.4216926668387,1.2040975523491,6.1801932225364,6.2102197272821,2.884041505725,4.5749627572691,12.327818860502,2.1696605100473,1.6726685919334,1.3730964627525,2.572793075785,.66402453937773,.29669898727439,3.1745684364685,2.0365248658682],globalStartIndex:25879}});this._values.put(m1.datasource(),
{chr6:{values:{id:[25879,25880,25881,25882,25883,25884,25885,25886,25887,25888,25889,25890,25891,25892,25893,25894,25895,25896,25897,25898,25899,25900],start:[105175968,105404923,105544697,105544697,105585562,105606155,105725440,105725440,106534195,106534195,106632351,106632351,106632351,106959730,107019846,107019846,107077453,107077453,107077453,107077489,107349417,107386386],end:[105307794,105531207,105585049,105585049,105617820,105627735,105850959,105850959,106557813,106557813,106773666,106773666,
106773666,107018326,107077362,107077362,107116292,107116292,107116292,107101698,107372546,107436473],strand:"*",metadata:{probe:["227471_at","229349_at","223853_at","228783_at","232492_at","219926_at","204117_at","37950_at","217192_s_at","228964_at","202511_s_at","202512_s_at","210639_s_at","212543_at","1555679_a_at","224509_s_at","218948_at","218949_s_at","241933_at","233089_at","223576_at","227920_at"]}},globalStartIndex:25879}});this._values.put(m2,{chr6:{values:{id:[10693,10694,10695,10696,10697,
10698,10699,10700,10701,10702],start:[101857270,105250651,105309133,105411671,105596427,105627861,105856970,105962958,106046989,106105087],end:[105211359,105271461,105383016,105571044,105627384,105719343,105932269,105994851,106071935,106148917],strand:"*"},globalStartIndex:10693},myChr:{values:{id:[10703,10704,10705,10706,10707,10708,10709,10710,10711],start:[106196924,106299261,106341705,106458601,106568336,106773852,107067335,107303124,107374709],end:[106234848,106319337,106416368,106529963,106596204,
106803274,107077437,107342199,107384388],strand:"*"},globalStartIndex:10703}})};
epiviz.data.MockDataProvider.prototype._initializeButtonHandlers=function(){var self=this;this._addSeqnamesButton.button().click(function(){var result=new epiviz.events.EventResult;self.onRequestAddSeqInfos().notify({seqInfos:[["otherChr",1,1E9],["andYetAnotherChr",1,1E9]],result:result});alert("Adding seqnames was "+(result.success?"successful!":"unsuccessful. Error: "+result.errorMessage))});this._removeSeqnamesButton.button().click(function(){var result=new epiviz.events.EventResult;self.onRequestRemoveSeqNames().notify({seqNames:["chr1",
"andYetAnotherChr"],result:result});alert("Removing seqnames was "+(result.success?"successful!":"unsuccessful. Error: "+result.errorMessage))});this._addMeasurementsButton.button().click(function(){var result=new epiviz.events.EventResult;var newMs=new epiviz.measurements.MeasurementSet;newMs.add(self._m2);self._measurements.add(self._m2);self.onRequestAddMeasurements().notify({measurements:newMs,result:result});alert("Adding measurements was "+(result.success?"successful!":"unsuccessful. Error: "+
result.errorMessage))});this._removeMeasurementsButton.button().click(function(){var result=new epiviz.events.EventResult;var rmMs=new epiviz.measurements.MeasurementSet;rmMs.add(self._m2);self._measurements.remove(self._m2);self.onRequestRemoveMeasurements().notify({measurements:rmMs,result:result});alert("Removing measurements was "+result.success?"successful!":"unsuccessful. Error: "+result.errorMessage)});var chartIds=[];this._addChartButton.button().click(function(){var result=new epiviz.events.EventResult;
var ms=new epiviz.measurements.MeasurementSet;ms.add(self._m2);self.onRequestAddChart().notify({type:"epiviz.plugins.charts.BlocksTrack",measurements:ms,result:result});alert("Adding chart was "+(result.success?"successful! Chart id is: "+result.value.id:"unsuccessful. Error: "+result.errorMessage));if(result.success)chartIds.push(result.value.id)});this._removeChartButton.button().click(function(){if(!chartIds.length)return;var chartId=chartIds.pop();var result=new epiviz.events.EventResult;self.onRequestRemoveChart().notify({id:chartId,
result:result});alert("Removing chart was "+(result.success?"successful!":"unsuccessful. Error: "+result.errorMessage))});this._clearCacheButton.button().click(function(){});this._navigateButton.button().click(function(){var result=new epiviz.events.EventResult;self.onRequestNavigate().notify({range:epiviz.datatypes.GenomicRange.fromStartEnd("chr6",103839409,107422589),result:result});alert("Navigate was "+(result.success?"successful!":"unsuccessful. Error: "+result.errorMessage))})};
epiviz.data.MockDataProvider.prototype.connected=function(){return true};
epiviz.data.MockDataProvider.prototype.getData=function(request,callback){var requestId=request.id();var action=request.get("action");var seqName=request.get("chr");var start=request.get("start");var end=request.get("end");var datasource=request.get("datasource");var m,d;var data;switch(action){case epiviz.data.Request.Action.GET_ROWS:m=this._measurements.subset(function(m){return m.datasource().datasourceId()==datasource}).first();if(!m)return;d=m.datasource();data=this._values.get(d)[seqName];if(!data||
seqName!=this._coveredRegions[0].seqName()&&seqName!=this._coveredRegions[1].seqName()||start>this._coveredRegions[0].end()||end<this._coveredRegions[0].start()){callback(epiviz.data.Response.fromRawObject({data:{values:{id:[],start:[],end:[],strand:"*",metadata:{probe:[]}},globalStartIndex:null},requestId:requestId}));return}callback(epiviz.data.Response.fromRawObject({requestId:request.id(),data:data}));return;case epiviz.data.Request.Action.GET_VALUES:m=this._measurements.subset(function(m){return m.datasource().datasourceId()==
datasource}).first();if(!m)return;data=this._values.get(m)[seqName];if(!data||seqName!=this._coveredRegions[0].seqName()&&seqName!=this._coveredRegions[1].seqName()||start>this._coveredRegions[0].end()||end<this._coveredRegions[0].start()){callback(epiviz.data.Response.fromRawObject({data:{values:[],globalStartIndex:null},requestId:requestId}));return}data["requestId"]=requestId;callback(epiviz.data.Response.fromRawObject({requestId:request.id(),data:data}));return;case epiviz.data.Request.Action.GET_MEASUREMENTS:callback(epiviz.data.Response.fromRawObject({requestId:request.id(),
type:epiviz.data.MessageType.RESPONSE,data:{id:[this._m1.id(),this._m2.id()],name:[this._m1.name(),this._m2.name()],type:[this._m1.type(),this._m2.type()],datasourceId:[this._m1.datasourceId(),this._m2.datasourceId()],datasourceGroup:[this._m1.datasourceGroup(),this._m2.datasourceGroup()],defaultChartType:[this._m1.defaultChartType(),this._m2.defaultChartType()],annotation:[this._m1.annotation(),this._m2.annotation()],minValue:[this._m1.minValue(),this._m2.minValue()],maxValue:[this._m1.maxValue(),
this._m2.maxValue()],metadata:[this._m1.metadata(),this._m2.metadata()]}}));return;case epiviz.data.Request.Action.GET_SEQINFOS:callback(epiviz.data.Response.fromRawObject({requestId:request.id(),data:[["chr1",1,248956422],["chr11",1,135086622],["myChr",1,1E9]]}));return;default:epiviz.data.DataProvider.prototype.getData.call(this,request,callback);break}};goog.provide("epiviz.datatypes.SeqInfo");epiviz.datatypes.SeqInfo=function(seqName,min,max){this.seqName=seqName;this.min=min;this.max=max};epiviz.datatypes.SeqInfo.prototype.raw=function(){return[this.seqName,this.min,this.max]};epiviz.datatypes.SeqInfo.fromRawObject=function(o){return new epiviz.datatypes.SeqInfo(o[0],o[1],o[2])};
epiviz.datatypes.SeqInfo.compare=function(s1,s2){var n1str=s1.seqName.replace(/\D/g,"");var n2str=s2.seqName.replace(/\D/g,"");if(n1str==""||n2str==""||!epiviz.utils.stringStartsWith(s1.seqName,n1str)&&!epiviz.utils.stringEndsWith(s1.seqName,n1str)||!epiviz.utils.stringStartsWith(s2.seqName,n2str)&&!epiviz.utils.stringEndsWith(s2.seqName,n2str))return s1.seqName<s2.seqName?-1:s1.seqName>s2.seqName?1:0;return parseInt(n1str)-parseInt(n2str)};goog.provide("epiviz.datatypes.GenomicArray");epiviz.datatypes.GenomicArray=function(measurement,boundaries,globalStartIndex,values){this._measurement=measurement;this._boundaries=boundaries;this._globalStartIndex=globalStartIndex;this._values=values};epiviz.datatypes.GenomicArray.prototype.boundaries=function(){return this._boundaries};epiviz.datatypes.GenomicArray.prototype.globalStartIndex=function(){return this._globalStartIndex};epiviz.datatypes.GenomicArray.prototype.measurement=function(){return this._measurement};
epiviz.datatypes.GenomicArray.prototype.get=function(index){throw Error("unimplemented abstract method");};epiviz.datatypes.GenomicArray.prototype.size=function(){throw Error("unimplemented abstract method");};epiviz.datatypes.GenomicArray.prototype.getByGlobalIndex=function(globalIndex){return this.get(globalIndex-this._globalStartIndex)};epiviz.datatypes.GenomicArray.prototype.concatValues=function(second,secondIndex){throw Error("unimplemented abstract method");};
epiviz.datatypes.GenomicArray.prototype.createNew=function(measurement,boundaries,globalStartIndex,values){throw Error("unimplemented abstract method");};
epiviz.datatypes.GenomicArray.prototype.merge=function(arr){if(!arr||arr.boundaries()==undefined)return this;if(this.boundaries().seqName()!=arr.boundaries().seqName()||this.boundaries().start()>arr.boundaries().end()||arr.boundaries().start()>this.boundaries().end())throw Error("Two genomic arrays can only be merged if they overlap or are in continuation to one another");var first=this.boundaries().start()<arr.boundaries().start()?this:arr;var second=first==this?arr:this;if(first.boundaries().end()>=
second.boundaries().end())return first;var secondIndex=first.globalStartIndex()!=undefined&&second.globalStartIndex()!=undefined?first.globalStartIndex()+first.size()-second.globalStartIndex():0;var measurement=first.measurement(),globalStartIndex=first.globalStartIndex()!=undefined?first.globalStartIndex():second.globalStartIndex(),boundaries=epiviz.datatypes.GenomicRange.fromStartEnd(first.boundaries().seqName(),first.boundaries().start(),second.boundaries().end()),values=first.concatValues(second,
secondIndex);return this.createNew(measurement,boundaries,globalStartIndex,values)};goog.provide("epiviz.datatypes.GenomicRangeArray");epiviz.datatypes.GenomicRangeArray=function(measurement,boundaries,globalStartIndex,values,useOffset){epiviz.datatypes.GenomicArray.call(this,measurement,boundaries,globalStartIndex,values);this._id=values.id;this._start=values.start;this._end=values.end;this._strand=values.strand||null;this._metadata=values.metadata;if(useOffset){var i;for(i=1;i<this._start.length;++i){this._start[i]+=this._start[i-1];if(this._end)this._end[i]+=this._end[i-1]}}};
epiviz.datatypes.GenomicRangeArray.prototype=epiviz.utils.mapCopy(epiviz.datatypes.GenomicArray.prototype);epiviz.datatypes.GenomicRangeArray.constructor=epiviz.datatypes.GenomicRangeArray;epiviz.datatypes.GenomicRangeArray.prototype.createNew=function(measurement,boundaries,globalStartIndex,values){return new epiviz.datatypes.GenomicRangeArray(measurement,boundaries,globalStartIndex,values)};
epiviz.datatypes.GenomicRangeArray.prototype.get=function(i){if(i<0||i>=this.size())return null;return new epiviz.datatypes.GenomicRangeArray.Item(this,i)};epiviz.datatypes.GenomicRangeArray.prototype.size=function(){return this._start?this._start.length:0};
epiviz.datatypes.GenomicRangeArray.prototype.concatValues=function(second,secondIndex){var strand=null;if(!Array.isArray(this._strand)&&!Array.isArray(second._strand)&&this._strand==second._strand)strand=this._strand;else{var firstStrand=Array.isArray(this._strand)?this._strand:epiviz.utils.fillArray(this.size(),this._strand),secondStrand=Array.isArray(second._strand)?second._strand:epiviz.utils.fillArray(second.size(),second._strand);strand=firstStrand.concat(secondStrand.slice(secondIndex))}var id=
this._id?this._id.concat(second._id.slice(secondIndex)):null,start=this._start.concat(second._start.slice(secondIndex)),end=this._end?this._end.concat(second._end.slice(secondIndex)):null;var metadata={};for(var col in this._metadata){if(!this._metadata.hasOwnProperty(col))continue;metadata[col]=this._metadata[col].concat(second._metadata[col].slice(secondIndex))}return{id:id,start:start,end:end,strand:strand,metadata:metadata}};
epiviz.datatypes.GenomicRangeArray.prototype.trim=function(range){if(this.globalStartIndex()==undefined||!this.size()||!range||!this.boundaries()||this.boundaries().seqName()!=range.seqName())return null;var start=Math.max(this.boundaries().start(),range.start());var end=Math.min(this.boundaries().end(),range.end());if(end<=start)return null;range=epiviz.datatypes.GenomicRange.fromStartEnd(range.seqName(),start,end);var startIndex=-1;var endIndex=-1;for(var i=0;i<this.size();++i){if(startIndex<0&&
this.end(i)>=range.start())startIndex=i;if(this._start[i]<range.end())endIndex=i+1}if(endIndex<=startIndex)return null;var values,globalStartIndex;var col;if(startIndex>=0&&endIndex>=startIndex){values={id:this._id?this._id.slice(startIndex,endIndex):null,start:this._start.slice(startIndex,endIndex),end:this._end?this._end.slice(startIndex,endIndex):null,strand:Array.isArray(this._strand)?this._strand.slice(startIndex,endIndex):this._strand,metadata:{}};for(col in this._metadata){if(!this._metadata.hasOwnProperty(col))continue;
values.metadata[col]=this._metadata[col].slice(startIndex,endIndex)}globalStartIndex=this.globalStartIndex()+startIndex}else{values={id:this._id?[]:null,start:[],end:this._end?[]:null,strand:Array.isArray(this._strand)?[]:this._strand,metadata:{}};for(col in this._metadata){if(!this._metadata.hasOwnProperty(col))continue;values.metadata[col]=[]}globalStartIndex=null}return new epiviz.datatypes.GenomicRangeArray(this.measurement(),range,globalStartIndex,values)};
epiviz.datatypes.GenomicRangeArray.prototype.ranges=function(){return this};epiviz.datatypes.GenomicRangeArray.prototype.foreach=function(func){var size=this.size();for(var i=0;i<size;++i)if(func(this.get(i)))return};epiviz.datatypes.GenomicRangeArray.prototype.metadataColumns=function(){if(this._metadata)return Object.keys(this._metadata);return[]};epiviz.datatypes.GenomicRangeArray.prototype.id=function(index){return this._id?this._id[index]:this.globalStartIndex()+index};
epiviz.datatypes.GenomicRangeArray.prototype.start=function(index){return this._start[index]};epiviz.datatypes.GenomicRangeArray.prototype.end=function(index){return this._end?this._end[index]:this._start[index]};epiviz.datatypes.GenomicRangeArray.prototype.strand=function(index){return Array.isArray(this._strand)?this._strand[index]:this._strand};epiviz.datatypes.GenomicRangeArray.prototype.metadata=function(column,index){if(!this._metadata||!this._metadata[column])return null;return this._metadata[column][index]};
epiviz.datatypes.GenomicRangeArray.prototype.rowMetadata=function(index){var result={};for(var column in this._metadata){if(!this._metadata.hasOwnProperty(column))continue;result[column]=this._metadata[column][index]}return result};
epiviz.datatypes.GenomicRangeArray.prototype.toString=function(){var c,s,e;if(this.boundaries()){c=this.boundaries().seqName();s=this.boundaries().start();e=this.boundaries().end()}else c=s=e="*";var header=sprintf("%25s",this.measurement().name().substr(0,22))+sprintf(" [%6s%10s%10s]",c,s,e);var id=sprintf("%10s:","id");var idx=sprintf("%10s:","idx");var chr=sprintf("%10s:","chr");var start=sprintf("%10s:","start");var end=sprintf("%10s:","end");if(this.globalStartIndex()!=undefined)for(var globalIndex=
this.globalStartIndex();globalIndex<this.globalStartIndex()+this.size();++globalIndex){var row=this.getByGlobalIndex(globalIndex);id+=sprintf("%10s",row.id());idx+=sprintf("%10s",globalIndex);chr+=sprintf("%10s",row.seqName());start+=sprintf("%10s",row.start());end+=sprintf("%10s",row.end())}return[header,id,idx,chr,start,end].join("\n")};goog.provide("epiviz.datatypes.GenomicRangeArray.Item");epiviz.datatypes.GenomicRangeArray.Item=function(parent,index){this._index=index;this._parent=parent};
epiviz.datatypes.GenomicRangeArray.Item.prototype.parent=function(){return this._parent};epiviz.datatypes.GenomicRangeArray.Item.prototype.id=function(){return this._parent.id(this._index)};epiviz.datatypes.GenomicRangeArray.Item.prototype.seqName=function(){return this._parent.boundaries().seqName()};epiviz.datatypes.GenomicRangeArray.Item.prototype.start=function(){return this._parent.start(this._index)};epiviz.datatypes.GenomicRangeArray.Item.prototype.end=function(){return this._parent.end(this._index)};
epiviz.datatypes.GenomicRangeArray.Item.prototype.index=function(){return this._index};epiviz.datatypes.GenomicRangeArray.Item.prototype.globalIndex=function(){return this._index+this._parent.globalStartIndex()};epiviz.datatypes.GenomicRangeArray.Item.prototype.equals=function(other){if(!other)return false;if(this==other)return true;return other.seqName()==this.seqName()&&other.start()==this.start()&&other.end()==this.end()};epiviz.datatypes.GenomicRangeArray.Item.prototype.strand=function(){return this._parent.strand(this._index)};
epiviz.datatypes.GenomicRangeArray.Item.prototype.metadata=function(column){return this._parent.metadata(column,this._index)};epiviz.datatypes.GenomicRangeArray.Item.prototype.rowMetadata=function(){return this._parent.rowMetadata(this._index)};epiviz.datatypes.GenomicRangeArray.Item.prototype.overlapsWith=function(other){if(!other)return false;if(this==other)return true;if(this.seqName()!=other.seqName())return false;return this.start()<other.end()&&this.end()>other.start()};goog.provide("epiviz.datatypes.FeatureValueArray");epiviz.datatypes.FeatureValueArray=function(measurement,boundaries,globalStartIndex,values){epiviz.datatypes.GenomicArray.call(this,measurement,boundaries,globalStartIndex,values)};epiviz.datatypes.FeatureValueArray.prototype=epiviz.utils.mapCopy(epiviz.datatypes.GenomicArray.prototype);epiviz.datatypes.FeatureValueArray.constructor=epiviz.datatypes.FeatureValueArray;
epiviz.datatypes.FeatureValueArray.prototype.createNew=function(measurement,boundaries,globalStartIndex,values){return new epiviz.datatypes.FeatureValueArray(measurement,boundaries,globalStartIndex,values)};epiviz.datatypes.FeatureValueArray.prototype.get=function(index){return this._values[index]};epiviz.datatypes.FeatureValueArray.prototype.size=function(){return this._values?this._values.length:0};
epiviz.datatypes.FeatureValueArray.prototype.concatValues=function(second,secondIndex){if(!second||!second.size())return this._values;if(!this._values)this._values=[];return this._values.concat(second._values.slice(secondIndex))};
epiviz.datatypes.FeatureValueArray.prototype.trim=function(range,globalStartIndex,length){if(this.globalStartIndex()==undefined||!this.size()||globalStartIndex==undefined||!range||!this.boundaries()||this.boundaries().seqName()!=range.seqName())return null;var start=Math.max(this.boundaries().start(),range.start());var end=Math.min(this.boundaries().end(),range.end());if(end<=start)return null;range=epiviz.datatypes.GenomicRange.fromStartEnd(range.seqName(),start,end);var startIndex=Math.max(globalStartIndex,
this.globalStartIndex())-this.globalStartIndex();var endIndex=Math.min(globalStartIndex+length,this.globalStartIndex()+this.size())-this.globalStartIndex();if(endIndex<=startIndex)return null;var values=this._values.slice(startIndex,endIndex);return new epiviz.datatypes.FeatureValueArray(this.measurement(),range,startIndex+this.globalStartIndex(),values)};
epiviz.datatypes.FeatureValueArray.prototype.toString=function(){var c,s,e;if(this.boundaries()){c=this.boundaries().seqName();s=this.boundaries().start();e=this.boundaries().end()}else c=s=e="*";var header=sprintf("%25s",this.measurement().name().substr(0,22))+sprintf(" [%6s%10s%10s]",c,s,e);var idx=sprintf("%10s:","idx");var val=sprintf("%10s:","val");if(this.globalStartIndex()!=undefined)for(var globalIndex=this.globalStartIndex();globalIndex<this.globalStartIndex()+this.size();++globalIndex){var v=
this.getByGlobalIndex(globalIndex);idx+=sprintf("%10s",globalIndex);val+=sprintf("%10s",v)}return[header,idx,val].join("\n")};goog.provide("epiviz.datatypes.PartialSummarizedExperiment");goog.require("epiviz.datatypes.GenomicRangeArray");epiviz.datatypes.PartialSummarizedExperiment=function(){this._rowData=null;this._values=new epiviz.measurements.MeasurementHashtable};epiviz.datatypes.PartialSummarizedExperiment.prototype.ranges=function(){return this.rowData()};epiviz.datatypes.PartialSummarizedExperiment.prototype.rowData=function(){return this._rowData};
epiviz.datatypes.PartialSummarizedExperiment.prototype.addRowData=function(rowData){if(!rowData)return;if(!this._rowData||this._rowData.boundaries().seqName()!=rowData.boundaries().seqName()||this._rowData.boundaries().start()>rowData.boundaries().end()||this._rowData.boundaries().end()<rowData.boundaries().start()){this._rowData=rowData;return}this._rowData=this._rowData.merge(rowData)};
epiviz.datatypes.PartialSummarizedExperiment.prototype.addValues=function(values){if(!values)return;var currentValues=this._values.get(values.measurement());if(!currentValues||currentValues.boundaries().seqName()!=values.boundaries().seqName()||currentValues.boundaries().start()>values.boundaries().end()||currentValues.boundaries().end()<values.boundaries().start()){this._values.put(values.measurement(),values);return}this._values.put(values.measurement(),currentValues.merge(values))};
epiviz.datatypes.PartialSummarizedExperiment.prototype.trim=function(range){var result=new epiviz.datatypes.PartialSummarizedExperiment;if(this._rowData)result.addRowData(this._rowData.trim(range));if(result.rowData())this._values.foreach(function(m,featureValueArray){result.addValues(featureValueArray.trim(range,result.rowData().globalStartIndex(),result.rowData().size()))});return result};epiviz.datatypes.PartialSummarizedExperiment.prototype.values=function(measurement){return this._values.get(measurement)};
epiviz.datatypes.PartialSummarizedExperiment.prototype.calcMinGlobalIndex=function(){var minGlobalIndex=this._rowData?this._rowData.globalStartIndex():null;if(this._values)this._values.foreach(function(m,valuesArray){if(valuesArray&&valuesArray.globalStartIndex()!=undefined&&(minGlobalIndex==undefined||minGlobalIndex>valuesArray.globalStartIndex()))minGlobalIndex=valuesArray.globalStartIndex()});return minGlobalIndex};
epiviz.datatypes.PartialSummarizedExperiment.prototype.calcMaxGlobalIndex=function(){var maxGlobalIndex=this._rowData&&this._rowData.globalStartIndex()!=undefined?this._rowData.globalStartIndex()+this._rowData.size():null;if(this._values)this._values.foreach(function(m,valuesArray){if(valuesArray&&valuesArray.globalStartIndex()!=undefined&&(maxGlobalIndex==undefined||maxGlobalIndex<valuesArray.globalStartIndex()+valuesArray.size()))maxGlobalIndex=valuesArray.globalStartIndex()+valuesArray.size()});
return maxGlobalIndex};
epiviz.datatypes.PartialSummarizedExperiment.prototype.toString=function(){var result="";var minGlobalIndex=this.calcMinGlobalIndex();var maxGlobalIndex=this.calcMaxGlobalIndex();result+=sprintf("%25s",this._rowData&&this._rowData.measurement()?this._rowData.measurement().name().substr(0,22):"[undefined datasource]");var chr,start,end,rowGlobalIndex,rowSize;if(this._rowData&&this._rowData.boundaries()){chr=this._rowData.boundaries().seqName();start=this._rowData.boundaries().start();end=this._rowData.boundaries().end();
rowGlobalIndex=this._rowData.globalStartIndex()!=undefined?this._rowData.globalStartIndex():"*";rowSize=this._rowData.size()}else{chr=start=end=rowGlobalIndex="*";rowSize=0}result+=sprintf(" [%6s%10s%10s] [globalStartIndex: %10s] [size: %7s]\n",chr,start,end,rowGlobalIndex,rowSize);var header=sprintf("%15s%15s%15s%15s%15s","id","idx","chr","start","end");if(this._values)this._values.foreach(function(m,valuesArray){result+=sprintf("%25s",m.name().substr(0,22));if(valuesArray&&valuesArray.boundaries()){chr=
valuesArray.boundaries().seqName();start=valuesArray.boundaries().start();end=valuesArray.boundaries().end()}else chr=start=end="*";result+=sprintf(" [%6s%10s%10s] [globalStartIndex: %10s] [size: %7s]\n",chr,start,end,valuesArray.globalStartIndex()!=undefined?valuesArray.globalStartIndex():"*",valuesArray.size());header+=sprintf("%25s",m.name().substr(0,22))});result+=header+"\n";for(var globalIndex=minGlobalIndex;globalIndex<maxGlobalIndex;++globalIndex){var id;if(this._rowData&&this._rowData.globalStartIndex()!=
undefined&&this._rowData.globalStartIndex()<=globalIndex&&this._rowData.globalStartIndex()+this._rowData.size()>globalIndex){var row=this._rowData.getByGlobalIndex(globalIndex);id=row.id();chr=row.seqName();start=row.start();end=row.end()}else id=chr=start=end="*";result+=sprintf("%15s%15s%15s%15s%15s",id,globalIndex,chr,start,end);if(this._values)this._values.foreach(function(m,valuesArray){if(valuesArray&&valuesArray.globalStartIndex()!=undefined&&valuesArray.globalStartIndex()<=globalIndex&&valuesArray.globalStartIndex()+
valuesArray.size()>globalIndex)result+=sprintf("%25s",valuesArray.getByGlobalIndex(globalIndex));else result+=sprintf("%25s","*")});result+="\n"}return result};goog.provide("epiviz.datatypes.GenomicDataMeasurementWrapper");goog.provide("epiviz.datatypes.GenomicDataMeasurementWrapper.ValueItem");epiviz.datatypes.GenomicDataMeasurementWrapper=function(measurement,container){this._measurement=measurement;this._container=container;this._size=null;this._globalStartIndex=null};
epiviz.datatypes.GenomicDataMeasurementWrapper.prototype.get=function(index){var rows=this._container.rowData();var values=null;var firstGlobalIndex=this.globalStartIndex();var item=null;var value=null;var globalIndex=null;var size=this.size();if(!size||index>=size||index<0)return new epiviz.datatypes.GenomicDataMeasurementWrapper.ValueItem(globalIndex,item,value);if(firstGlobalIndex!=undefined){if(this._measurement.type()==epiviz.measurements.Measurement.Type.FEATURE){values=this._container.values(this._measurement);
var valueIndex=firstGlobalIndex-values.globalStartIndex()+index;value=values.get(valueIndex)}var rowIndex=firstGlobalIndex-rows.globalStartIndex()+index;item=rows.get(rowIndex);globalIndex=firstGlobalIndex+index}return new epiviz.datatypes.GenomicDataMeasurementWrapper.ValueItem(globalIndex,item,value)};epiviz.datatypes.GenomicDataMeasurementWrapper.prototype.measurement=function(){return this._measurement};
epiviz.datatypes.GenomicDataMeasurementWrapper.prototype.globalStartIndex=function(){if(this._globalStartIndex!==null)return this._globalStartIndex;var rows=this._container.rowData();var values=null;var firstGlobalIndex=rows.globalStartIndex();if(firstGlobalIndex===null)return firstGlobalIndex;if(this._measurement.type()==epiviz.measurements.Measurement.Type.FEATURE){values=this._container.values(this._measurement);if(!values.globalStartIndex())return values.globalStartIndex();firstGlobalIndex=Math.max(firstGlobalIndex,
values.globalStartIndex())}this._globalStartIndex=firstGlobalIndex;return this._globalStartIndex};
epiviz.datatypes.GenomicDataMeasurementWrapper.prototype.size=function(){if(this._size!==null)return this._size;var firstGlobalIndex=this.globalStartIndex();if(firstGlobalIndex==undefined)return 0;var rows=this._container.rowData();var values=this._container.values(this._measurement);var result=rows.size()-firstGlobalIndex+rows.globalStartIndex();if(this._measurement.type()==epiviz.measurements.Measurement.Type.FEATURE)result=Math.min(result,values.size()-firstGlobalIndex+values.globalStartIndex());
this._size=Math.max(0,result);return this._size};epiviz.datatypes.GenomicDataMeasurementWrapper.prototype.getByGlobalIndex=function(globalIndex){var firstGlobalIndex=this.globalStartIndex();if(!firstGlobalIndex)return new epiviz.datatypes.GenomicDataMeasurementWrapper.ValueItem(null,null,null);return this.get(globalIndex-firstGlobalIndex)};
epiviz.datatypes.GenomicDataMeasurementWrapper.prototype.binarySearchStarts=function(range){var rows=this._container.rowData();if(this.size()==0||!rows||rows.size()==0||rows.start(0)>=range.end()||rows.start(rows.size()-1)<=range.start())return{index:null,length:0};var s=0,e=rows.size()-1;var m;var startIndex=null;while(s<=e){m=Math.floor((s+e)*.5);if(rows.start(m)==range.start()){startIndex=m;e=m-1}else if(rows.start(m)<range.start())s=m+1;else e=m-1}if(startIndex===null)startIndex=s;s=0;e=rows.size()-
1;var endIndex=null;while(s<=e){m=Math.floor((s+e)*.5);if(rows.start(m)==range.end()){endIndex=m;s=m+1}else if(rows.start(m)<range.end())s=m+1;else e=m-1}if(endIndex===null)endIndex=s-1;var globalStartIndex=Math.max(startIndex+rows.globalStartIndex(),this.globalStartIndex());var globalEndIndex=Math.min(endIndex+rows.globalStartIndex(),this.globalStartIndex()+this.size()-1);return{index:globalStartIndex-this.globalStartIndex(),length:globalEndIndex-globalStartIndex+1}};
epiviz.datatypes.GenomicDataMeasurementWrapper.ValueItem=function(globalIndex,rowItem,value){this.globalIndex=globalIndex;this.rowItem=rowItem;this.value=value===0||value?value:null};goog.provide("epiviz.ui.controls.Control");epiviz.ui.controls.Control=function(container){this._container=container};epiviz.ui.controls.Control.prototype.initialize=function(){};goog.provide("epiviz.ui.controls.Dialog");epiviz.ui.controls.Dialog=function(title,handlers){this._container=$("#dialogs");this._title=title;this._id=epiviz.ui.controls.Dialog.generateId();this._handlers=handlers;this._container.append(sprintf('<div id="%s" title="%s" style="display: none;"></div>',this._id,this._title));this._dialog=null};epiviz.ui.controls.Dialog._nextIdIndex=0;epiviz.ui.controls.Dialog.generateId=function(){return sprintf("dialog-%s",epiviz.utils.generatePseudoGUID(5))};
epiviz.ui.controls.Dialog.prototype.show=function(){};goog.provide("epiviz.ui.charts.Margins");epiviz.ui.charts.Margins=function(top,left,bottom,right){this._top=top;this._left=left;this._bottom=bottom;this._right=right};epiviz.ui.charts.Margins.ZERO_MARGIN=new epiviz.ui.charts.Margins(0,0,0,0);epiviz.ui.charts.Margins.prototype.top=function(){return this._top};epiviz.ui.charts.Margins.prototype.left=function(){return this._left};epiviz.ui.charts.Margins.prototype.bottom=function(){return this._bottom};epiviz.ui.charts.Margins.prototype.right=function(){return this._right};
epiviz.ui.charts.Margins.prototype.sumAxis=function(axis){switch(axis){case epiviz.ui.charts.Axis.X:return this._left+this._right;case epiviz.ui.charts.Axis.Y:return this._top+this._bottom;default:throw Error("Invalid argument: "+axis);}};epiviz.ui.charts.Margins.prototype.raw=function(){return{top:this._top,left:this._left,bottom:this._bottom,right:this._right}};epiviz.ui.charts.Margins.fromRawObject=function(o){return new epiviz.ui.charts.Margins(o.top,o.left,o.bottom,o.right)};
epiviz.ui.charts.Margins.prototype.copy=function(){return new epiviz.ui.charts.Margins(this._top,this._left,this._bottom,this._right)};epiviz.ui.charts.Margins.prototype.equals=function(other){if(!other)return false;if(this==other)return true;return this._top==other._top&&this._left==other._left&&this._bottom==other._bottom&&this._right==other._right};goog.provide("epiviz.ui.charts.ColorPalette");epiviz.ui.charts.ColorPalette=function(colors){this._colors=colors};epiviz.ui.charts.ColorPalette.prototype.get=function(i){return this._colors[i%this._colors.length]};epiviz.ui.charts.ColorPalette.prototype.size=function(){return this._colors.length};epiviz.ui.charts.ColorPalette.prototype.equals=function(other){if(this==other)return true;if(!other)return false;return epiviz.utils.arraysEqual(this._colors,other._colors)};
epiviz.ui.charts.ColorPalette.prototype.copy=function(){return new epiviz.ui.charts.ColorPalette(this._colors.slice(0))};epiviz.ui.charts.ColorPalette.prototype.raw=function(){return this._colors};epiviz.ui.charts.ColorPalette.fromRawObject=function(o){return new epiviz.ui.charts.ColorPalette(o)};goog.provide("epiviz.ui.charts.Axis");epiviz.ui.charts.Axis={X:"x",Y:"y"};goog.provide("epiviz.ui.charts.ChartProperties");epiviz.ui.charts.ChartProperties=function(width,height,margins,measurements,colors,customSettingsValues,customSettingsDefs){this.width=width;this.height=height;this.margins=margins;this.measurements=measurements;this.colors=colors;this.customSettingsValues=customSettingsValues||{};this.customSettingsDefs=customSettingsDefs||[]};
epiviz.ui.charts.ChartProperties.prototype.copy=function(){return new epiviz.ui.charts.ChartProperties(this.width,this.height,this.margins?this.margins.copy():this.margins,this.measurements?new epiviz.measurements.MeasurementSet(this.measurements):this.measurements,this.colors?this.colors.copy():this.colors,this.customSettingsValues?epiviz.utils.mapCopy(this.customSettingsValues):this.customSettingsValues,this.customSettingsDefs?this.customSettingsDefs.slice(0):this.customSettingsDefs)};goog.provide("epiviz.ui.charts.UiObject");epiviz.ui.charts.UiObject=function(id,start,end,values,seriesIndex,valueItems,measurements,cssClasses){this.id=id;this.start=start;this.end=end;this.values=values;this.seriesIndex=seriesIndex;this.valueItems=valueItems;this.measurements=measurements;this.cssClasses=cssClasses};
epiviz.ui.charts.UiObject.prototype.overlapsWith=function(other){if(!other)return false;if(this===other)return true;var i,j,k;var thisRowItem,otherRowItem;if(!this.measurements||!this.measurements.length){if(!other.measurements||!other.measurements.length)return this.start<other.end&&this.end>other.start;for(j=0;j<other.valueItems[0].length;++j){otherRowItem=other.valueItems[0][j].rowItem;if(this.start<otherRowItem.end()&&this.end>otherRowItem.start())return true}return false}var commonMetadata=epiviz.utils.mapKeyIntersection(this.valueItems[0][0].rowItem.rowMetadata(),
other.valueItems[0][0].rowItem.rowMetadata());if(commonMetadata.length){for(i=0;i<this.valueItems[0].length;++i)for(j=0;j<other.valueItems[0].length;++j){thisRowItem=this.valueItems[0][i].rowItem;otherRowItem=other.valueItems[0][j].rowItem;var metadataMatches=true;for(k=0;k<commonMetadata.length;++k)if(thisRowItem.metadata(commonMetadata[k])!=otherRowItem.metadata(commonMetadata[k])){metadataMatches=false;break}if(metadataMatches)return true}return false}for(i=0;i<this.valueItems[0].length;++i)for(j=
0;j<other.valueItems[0].length;++j){thisRowItem=this.valueItems[0][i].rowItem;otherRowItem=other.valueItems[0][j].rowItem;if(thisRowItem.overlapsWith(otherRowItem))return true}return false};goog.provide("epiviz.ui.charts.CustomSetting");epiviz.ui.charts.CustomSetting=function(id,type,defaultValue,label,possibleValues){this.id=id;this.type=type;this.defaultValue=defaultValue;this.label=label||id;this.possibleValues=possibleValues||null};epiviz.ui.charts.CustomSetting.Type={NUMBER:"number",STRING:"string",ARRAY:"array",BOOLEAN:"boolean",CATEGORICAL:"categorical"};epiviz.ui.charts.CustomSetting.DEFAULT="default";goog.provide("epiviz.ui.charts.Chart");
epiviz.ui.charts.Chart=function(id,container,properties){this._id=id;this._container=container;this._properties=properties;this._customSettingsValues={};for(var i=0;i<properties.customSettingsDefs.length;++i){var setting=properties.customSettingsDefs[i];var val=properties.customSettingsValues[setting.id];switch(setting.type){case epiviz.ui.charts.CustomSetting.Type.BOOLEAN:this._customSettingsValues[setting.id]=val===false||val?val:setting.defaultValue;break;case epiviz.ui.charts.CustomSetting.Type.NUMBER:this._customSettingsValues[setting.id]=
val===0||val?val:setting.defaultValue;break;case epiviz.ui.charts.CustomSetting.Type.STRING:this._customSettingsValues[setting.id]=val===""||val?val:setting.defaultValue;break;default:this._customSettingsValues[setting.id]=val||setting.defaultValue;break}}this._svgId=sprintf("%s-svg",this._id);this._svg=null;this._loaderTimeout=0;this._lastRange=null;this._lastData=null;this._nBins=100;this._binSize=null;this._showTooltip=true;this._hover=new epiviz.events.Event;this._unhover=new epiviz.events.Event;
this._select=new epiviz.events.Event;this._deselect=new epiviz.events.Event;this._save=new epiviz.events.Event;this._remove=new epiviz.events.Event;this._colorsChanged=new epiviz.events.Event;this._customSettingsChanged=new epiviz.events.Event;this._sizeChanged=new epiviz.events.Event;this._marginsChanged=new epiviz.events.Event};epiviz.ui.charts.Chart.SVG_MARGIN=20;
epiviz.ui.charts.Chart.prototype._initialize=function(){if(this._properties.height=="100%")this._properties.height=this._container.height()-epiviz.ui.charts.Chart.SVG_MARGIN;if(this._properties.width=="100%")this._properties.width=this._container.width()-epiviz.ui.charts.Chart.SVG_MARGIN;var width=this.width();var height=this.height();this._addChartButtons();this._container.append(sprintf('<svg id="%s" class="base-chart" width="%s" height="%s"></svg>',this._svgId,width,height));this._svg=d3.select("#"+
this._svgId);this._addStyles();this._addFilters();this._addResizable();this._addTooltip();var jSvg=$("#"+this._svgId);this._widthDif=jSvg.width()-(this._container.width()-epiviz.ui.charts.Chart.SVG_MARGIN);this._heightDif=height-(this._container.height()-epiviz.ui.charts.Chart.SVG_MARGIN);this._properties.width=width;this._properties.height=height;var self=this;this._container.click(function(){self._deselect.notify()})};
epiviz.ui.charts.Chart.prototype._addResizable=function(){var self=this;var resizeHandler=function(event,ui){self.containerResize()};this._container.resizable({stop:resizeHandler})};
epiviz.ui.charts.Chart.prototype._addTooltip=function(){var self=this;this._container.tooltip({items:".item",content:function(){if(!self._showTooltip)return false;var uiObj=d3.select(this).data()[0];var maxMetadataValueLength=15;var metadataCols=uiObj.measurements[0].metadata();var colsHeader=sprintf("<th><b>Start</b></th><th><b>End</b></th>%s%s",metadataCols?"<th><b>"+metadataCols.join("</b></th><th><b>")+"</b></th>":"",uiObj.values?"<th><b>"+uiObj.measurements.join("</b></th><th><b>")+"</b></th>":
"");var rows="";for(var j=0;j<uiObj.valueItems[0].length&&j<10;++j){var row="";var rowItem=uiObj.valueItems[0][j].rowItem;row+=sprintf("<td>%s</td><td>%s</td>",Globalize.format(rowItem.start(),"n0"),Globalize.format(rowItem.end(),"n0"));var rowMetadata=rowItem.rowMetadata();if(metadataCols&&rowMetadata)for(var k=0;k<metadataCols.length;++k){var metadataCol=metadataCols[k];var metadataValue=rowMetadata[metadataCol]||"";row+=sprintf("<td>%s</td>",metadataValue.length<=maxMetadataValueLength?metadataValue:
metadataValue.substr(0,maxMetadataValueLength)+"...")}if(uiObj.values)for(var i=0;i<uiObj.measurements.length;++i)row+=sprintf("<td>%s</td>",Globalize.format(uiObj.valueItems[i][j].value,"n3"));rows+=sprintf("<tr>%s</tr>",row)}if(j<uiObj.valueItems[0].length){var colspan=2+(metadataCols?metadataCols.length:0)+(uiObj.values?uiObj.measurements.length:0);rows+=sprintf('<tr><td colspan="%s" style="text-align: center;">...</td></tr>',colspan)}return sprintf('<table class="tooltip-table"><thead><tr>%s</tr></thead><tbody>%s</tbody></table>',
colsHeader,rows)},track:true,show:false})};
epiviz.ui.charts.Chart.prototype._addChartButtons=function(){var self=this;var saveButtonId=sprintf("%s-save",this._id);this._container.append(sprintf('<button id="%s" style="position: absolute; top: 5px; right: 35px">Save</button>',saveButtonId));var saveButton=$("#"+saveButtonId);saveButton.button({icons:{primary:"ui-icon ui-icon-disk"},text:false}).click(function(){self._save.notify(self._id);return false});var removeButtonId=sprintf("%s-remove",this._id);this._container.append(sprintf('<button id="%s" style="position: absolute; top: 5px; right: 5px">Remove</button>',
removeButtonId));var removeButton=$("#"+removeButtonId);removeButton.button({icons:{primary:"ui-icon ui-icon-cancel"},text:false}).click(function(){self._remove.notify(self._id);return false});var colorsButtonId=sprintf("%s-color-picker",this._id);this._container.append(sprintf('<button id="%s" style="position: absolute; top: 5px; right: 65px">Colors</button>',colorsButtonId));var colorsButton=$("#"+colorsButtonId);colorsButton.button({icons:{primary:"ui-icon ui-icon-colorpicker"},text:false}).click(function(){var colors=
self.colorMap();var colorPickerDialog=new epiviz.ui.controls.ColorPickerDialog({ok:function(colors){self.setColorMap(colors)},cancel:function(){},reset:function(){}},colors);colorPickerDialog.show();return false});var customSettingsButtonId=sprintf("%s-custom-settings",this._id);this._container.append(sprintf('<button id="%s" style="position: absolute; top: 5px; right: 95px">Custom settings</button>',customSettingsButtonId));var customSettingsButton=$("#"+customSettingsButtonId);customSettingsButton.button({icons:{primary:"ui-icon ui-icon-gear"},
text:false}).click(function(){var CustomSettings=epiviz.ui.charts.ChartType.CustomSettings;var customSettingsDialog=new epiviz.ui.controls.CustomSettingsDialog("Edit custom settings",{ok:function(settingsValues){self._customSettingsValues=settingsValues;if(CustomSettings.MARGIN_TOP in settingsValues&&CustomSettings.MARGIN_BOTTOM in settingsValues&&CustomSettings.MARGIN_LEFT in settingsValues&&CustomSettings.MARGIN_RIGHT in settingsValues){self._properties.margins=new epiviz.ui.charts.Margins(settingsValues[CustomSettings.MARGIN_TOP],
settingsValues[CustomSettings.MARGIN_LEFT],settingsValues[CustomSettings.MARGIN_BOTTOM],settingsValues[CustomSettings.MARGIN_RIGHT]);self._marginsChanged.notify({id:self._id,margins:self._properties.margins})}self.draw();self._customSettingsChanged.notify({id:self._id,customSettingsValues:settingsValues})},cancel:function(){}},self.properties().customSettingsDefs,self._customSettingsValues);customSettingsDialog.show();return false});var tooltipButtonId=sprintf("%s-tooltip-button",this._id);this._container.append(sprintf('<div id="%1$s-container" style="position: absolute; top: 7px; right: 125px">'+
'<input type="checkbox" id="%1$s" checked="checked" />'+'<label for="%1$s" >Toggle Tooltip</label>'+"</div>",tooltipButtonId));var tooltipButton=$("#"+tooltipButtonId);var tooltipButtonContainer=$("#"+tooltipButtonId+"-container");tooltipButton.button({text:false,icons:{primary:"ui-icon-comment"}}).click(function(){self._showTooltip=tooltipButton.is(":checked")});this._container.mousemove(function(){saveButton.show();removeButton.show();colorsButton.show();customSettingsButton.show();tooltipButtonContainer.show()}).mouseleave(function(){saveButton.hide();
removeButton.hide();colorsButton.hide();customSettingsButton.hide();tooltipButtonContainer.hide()})};epiviz.ui.charts.Chart.prototype._addStyles=function(){var jSvg=this._container.find("svg");jSvg.append('<style type="text/css"></style>')};
epiviz.ui.charts.Chart.prototype._addFilters=function(){var defs=this._svg.append("defs");var glow=defs.append("filter").attr("id",this._id+"-glow");glow.append("feGaussianBlur").attr("id","gaussianBlur").attr("stdDeviation","2").attr("result","blurResult");glow.append("feComposite").attr("id","composite").attr("in","SourceGraphic").attr("in2","blurResult").attr("operator","over");var contour=defs.append("filter").attr("id",this._id+"-contour");contour.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",
"1").attr("result","blur");contour.append("feColorMatrix").attr("values","1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 10 -1 ").attr("result","colorMatrix");contour.append("feFlood").attr("result","fillColor").attr("flood-color","#800000").attr("in","blur");contour.append("feComposite").attr("result","composite").attr("in","fillColor").attr("in2","colorMatrix").attr("operator","atop");contour.append("feComposite").attr("in","SourceGraphic").attr("in2","composite").attr("operator","atop");var dropShadow=defs.append("filter").attr("id",
this._id+"-dropshadow").attr("filterUnits","userSpaceOnUse").attr("color-interpolation-filters","sRGB");var temp=dropShadow.append("feComponentTransfer").attr("in","SourceAlpha");temp.append("feFuncR").attr("type","discrete").attr("tableValues","1");temp.append("feFuncG").attr("type","discrete").attr("tableValues",198/255);temp.append("feFuncB").attr("type","discrete").attr("tableValues","0");dropShadow.append("feGaussianBlur").attr("stdDeviation","2");dropShadow.append("feOffset").attr("dx","0").attr("dy",
"0").attr("result","shadow");dropShadow.append("feComposite").attr("in","SourceGraphic").attr("in2","shadow").attr("operator","over")};
epiviz.ui.charts.Chart.prototype.addLoaderAnimation=function(){if(this._loaderTimeout)clearTimeout(this._loaderTimeout);var self=this;this._loaderTimeout=setTimeout(function(){var loaderCls="chart-loader";var loaderBgCls="chart-loader-background";self._container.find("."+loaderCls).remove();self._container.find("."+loaderBgCls).remove();self._container.append(sprintf('<div class="loader-icon %s" style="top: %spx; left: %spx;"></div>',loaderCls,Math.floor(self.height()*.5),Math.floor(self.width()*
.5)));self._container.find("."+loaderCls).activity({segments:8,steps:5,opacity:.3,width:4,space:0,length:10,color:"#0b0b0b",speed:1});self._svg.append("rect").attr("class",loaderBgCls).attr("x",0).attr("y",0).attr("width","100%").attr("height","100%").attr("fill","#ffffff").attr("opacity",.7)},500)};
epiviz.ui.charts.Chart.prototype.removeLoaderAnimation=function(){if(this._loaderTimeout)clearTimeout(this._loaderTimeout);var loaderCls="chart-loader";var loaderBgCls="chart-loader-background";this._container.find("."+loaderCls).remove();this._container.find("."+loaderBgCls).remove()};epiviz.ui.charts.Chart.prototype._clearAxes=function(svg){svg=svg||this._svg;svg.selectAll(".xAxis").remove();svg.selectAll(".yAxis").remove()};
epiviz.ui.charts.Chart.prototype._drawAxes=function(xScale,yScale,xTicks,yTicks,svg,width,height,margins){svg=svg||this._svg;margins=margins||this.margins();height=height||this.height();width=width||this.width();var axesGroup=svg.select(".axes"),xAxisGrid=axesGroup.select(".xAxis-grid"),yAxisGrid=axesGroup.select(".yAxis-grid"),xAxisLine=axesGroup.select(".xAxis-line"),yAxisLine=axesGroup.select(".yAxis-line");if(axesGroup.empty())axesGroup=svg.append("g").attr("class","axes");if(xAxisGrid.empty())xAxisGrid=
axesGroup.append("g").attr("class","xAxis xAxis-grid");if(yAxisGrid.empty())yAxisGrid=axesGroup.append("g").attr("class","yAxis yAxis-grid");if(xAxisLine.empty())xAxisLine=axesGroup.append("g").attr("class","xAxis xAxis-line");if(yAxisLine.empty())yAxisLine=axesGroup.append("g").attr("class","yAxis yAxis-line");if(xScale){xAxisGrid.attr("transform","translate("+margins.left()+", "+margins.top()+")").selectAll("line.x").data(xScale.ticks(xTicks)).enter().append("line").attr("x1",xScale).attr("x2",
xScale).attr("y1",0).attr("y2",height-margins.top()-margins.bottom()).style("stroke","#eeeeee").style("shape-rendering","crispEdges");var xAxis=d3.svg.axis().scale(xScale).orient("bottom").tickFormat(d3.format("s"));xAxisLine.attr("transform","translate("+margins.left()+", "+(height-margins.bottom())+")").call(xAxis)}if(yScale){yAxisGrid.attr("transform","translate("+margins.left()+", "+margins.top()+")").selectAll("line.y").data(yScale.ticks(yTicks)).enter().append("line").attr("x1",0).attr("x2",
width-margins.left()-margins.right()).attr("y1",yScale).attr("y2",yScale).style("stroke","#eeeeee").style("shape-rendering","crispEdges");var yAxis=d3.svg.axis().scale(yScale).orient("left");yAxisLine.attr("transform","translate("+margins.left()+", "+margins.top()+")").call(yAxis)}};
epiviz.ui.charts.Chart.prototype.resize=function(width,height){if(width)this._properties.width=width;if(height)this._properties.height=height;this.draw();this._sizeChanged.notify({id:this._id,width:this._properties.width,height:this._properties.height})};epiviz.ui.charts.Chart.prototype.containerResize=function(){this.resize(this._widthDif+this._container.width()-epiviz.ui.charts.Chart.SVG_MARGIN,this._heightDif+this._container.height()-epiviz.ui.charts.Chart.SVG_MARGIN)};
epiviz.ui.charts.Chart.prototype.draw=function(range,data){this.removeLoaderAnimation();if(range)this._binSize=Math.ceil((range.end()-range.start())/this._nBins);if(data&&range){this._lastData=data;this._lastRange=range}this._svg.attr("width",this.width()).attr("height",this.height());return[]};epiviz.ui.charts.Chart.prototype.id=function(){return this._id};epiviz.ui.charts.Chart.prototype.properties=function(){return this._properties};epiviz.ui.charts.Chart.prototype.height=function(){return this._properties.height};
epiviz.ui.charts.Chart.prototype.width=function(){return this._properties.width};epiviz.ui.charts.Chart.prototype.margins=function(){return this._properties.margins};epiviz.ui.charts.Chart.prototype.measurements=function(){return this._properties.measurements};epiviz.ui.charts.Chart.prototype.colors=function(){return this._properties.colors};epiviz.ui.charts.Chart.prototype.displayType=function(){throw Error("unimplemented abstract method");};
epiviz.ui.charts.Chart.prototype.chartTypeName=function(){throw Error("unimplemented abstract method");};epiviz.ui.charts.Chart.prototype.onHover=function(){return this._hover};epiviz.ui.charts.Chart.prototype.onUnhover=function(){return this._unhover};epiviz.ui.charts.Chart.prototype.onSelect=function(){return this._select};epiviz.ui.charts.Chart.prototype.onDeselect=function(){return this._deselect};
epiviz.ui.charts.Chart.prototype._changeObjectSelection=function(selectionData,sourceGroup,targetGroup){var selectClasses=this._filterClassSelection(selectionData);if(selectClasses==null){selectClasses="";var s=Math.floor(selectionData.start/this._binSize);var e=Math.floor(selectionData.end/this._binSize);for(var j=s;j<=e;++j)selectClasses+=sprintf("> .bin-%s,",j)}var objects=sourceGroup.find(selectClasses);targetGroup.append(objects);return objects};
epiviz.ui.charts.Chart.prototype.doHover=function(selectedObject){var itemsGroup=this._container.find(".items");var unselectedHoveredGroup=itemsGroup.find("> .hovered");var selectedGroup=itemsGroup.find("> .selected");var selectedHoveredGroup=selectedGroup.find("> .hovered");var filter=function(){return selectedObject.overlapsWith(d3.select(this).data()[0])};var selectItems=itemsGroup.find("> .item").filter(filter);unselectedHoveredGroup.append(selectItems);selectItems=selectedGroup.find("> .item").filter(filter);
selectedHoveredGroup.append(selectItems)};epiviz.ui.charts.Chart.prototype.doUnhover=function(){var itemsGroup=this._container.find(".items");var unselectedHoveredGroup=itemsGroup.find("> .hovered");var selectedGroup=itemsGroup.find("> .selected");var selectedHoveredGroup=selectedGroup.find("> .hovered");itemsGroup.prepend(unselectedHoveredGroup.children());selectedGroup.prepend(selectedHoveredGroup.children())};
epiviz.ui.charts.Chart.prototype.doSelect=function(selectedObject){var itemsGroup=this._container.find(".items");var unselectedHoveredGroup=itemsGroup.find("> .hovered");var selectedGroup=itemsGroup.find("> .selected");var selectedHoveredGroup=selectedGroup.find("> .hovered");var filter=function(){return selectedObject.overlapsWith(d3.select(this).data()[0])};var selectItems=itemsGroup.find("> .item").filter(filter);selectedGroup.append(selectItems);selectItems=unselectedHoveredGroup.find("> .item").filter(filter);
selectedHoveredGroup.append(selectItems)};epiviz.ui.charts.Chart.prototype.doDeselect=function(){var itemsGroup=this._container.find(".items");var unselectedHoveredGroup=itemsGroup.find("> .hovered");var selectedGroup=itemsGroup.find("> .selected");var selectedHoveredGroup=selectedGroup.find("> .hovered");itemsGroup.prepend(selectedGroup.find("> .item"));unselectedHoveredGroup.prepend(selectedHoveredGroup.children())};
epiviz.ui.charts.Chart.prototype.colorMap=function(){var self=this;var colors=new Array(this._properties.measurements.size());this._properties.measurements.foreach(function(m,i){colors[i]={name:m.name(),color:self._properties.colors.get(i)}});return colors};
epiviz.ui.charts.Chart.prototype.setColorMap=function(colorMap){var colors=[];for(var i=0;i<colorMap.length;++i)colors.push(colorMap[i].color);for(;i<this._properties.colors.size();++i)colors.push(this._properties.colors.get(i));this._properties.colors=new epiviz.ui.charts.ColorPalette(colors);this.draw();this._colorsChanged.notify({id:this._id,colors:this._properties.colors})};epiviz.ui.charts.Chart.prototype.onSave=function(){return this._save};epiviz.ui.charts.Chart.prototype.onRemove=function(){return this._remove};
epiviz.ui.charts.Chart.prototype.onColorsChanged=function(){return this._colorsChanged};epiviz.ui.charts.Chart.prototype.onCustomSettingsChanged=function(){return this._customSettingsChanged};epiviz.ui.charts.Chart.prototype.onSizeChanged=function(){return this._sizeChanged};epiviz.ui.charts.Chart.prototype.onMarginsChanged=function(){return this._marginsChanged};goog.provide("epiviz.ui.charts.Track");epiviz.ui.charts.Track=function(id,container,properties){epiviz.ui.charts.Chart.call(this,id,container,properties);this._background=null;this._highlightGroup=null};epiviz.ui.charts.Track.prototype=epiviz.utils.mapCopy(epiviz.ui.charts.Chart.prototype);epiviz.ui.charts.Track.constructor=epiviz.ui.charts.Track;
epiviz.ui.charts.Track.prototype._initialize=function(){this._properties.width="100%";epiviz.ui.charts.Chart.prototype._initialize.call(this);var self=this;this._highlightGroup=this._svg.append("g").attr("class","track-highlight");this._background=this._svg.append("rect").attr("class","chart-background").attr("x",0).attr("y",0).attr("width","100%").attr("height","100%").attr("fill","#ffffff").attr("fill-opacity","0");this._background.on("mouseover",function(){self._captureMouseHover()}).on("mousemove",
function(){self._captureMouseHover()}).on("mouseout",function(){self._unhover.notify()})};epiviz.ui.charts.Track.prototype.draw=function(range,data,slide,zoom){var result=epiviz.ui.charts.Chart.prototype.draw.call(this,range,data);this._drawTitle();return result};epiviz.ui.charts.Track.prototype.displayType=function(){return epiviz.ui.charts.ChartType.DisplayType.TRACK};
epiviz.ui.charts.Track.prototype.doHover=function(selectedObject){epiviz.ui.charts.Chart.prototype.doHover.call(this,selectedObject);if(!this._lastRange)return;this._highlightGroup.selectAll("rect").remove();this._highlightGroup.attr("transform","translate("+this.margins().left()+", "+0+")");var Axis=epiviz.ui.charts.Axis;var xScale=d3.scale.linear().domain([this._lastRange.start(),this._lastRange.end()]).range([0,this.width()-this.margins().sumAxis(Axis.X)]);var items=[];if(!selectedObject.measurements||
!selectedObject.measurements.length)items.push({start:selectedObject.start,end:selectedObject.end});else for(var i=0;i<selectedObject.valueItems[0].length;++i){var rowItem=selectedObject.valueItems[0][i].rowItem;items.push({start:rowItem.start(),end:rowItem.end()})}var minHighlightSize=5;this._highlightGroup.selectAll("rect").data(items,function(d){return sprintf("%s-%s",d.start,d.end)}).enter().append("rect").style("fill",this.colors().get(0)).style("fill-opacity","0.1").attr("x",function(d){var defaultWidth=
xScale(d.end+1)-xScale(d.start);var width=Math.max(minHighlightSize,defaultWidth);return xScale(d.start)+defaultWidth*.5-width*.5}).attr("width",function(d){return Math.max(minHighlightSize,xScale(d.end+1)-xScale(d.start))}).attr("y",0).attr("height",this.height())};epiviz.ui.charts.Track.prototype.doUnhover=function(){epiviz.ui.charts.Chart.prototype.doUnhover.call(this);this._highlightGroup.selectAll("rect").remove()};
epiviz.ui.charts.Track.prototype._captureMouseHover=function(){if(!this._lastRange)return;this._unhover.notify();var inverseXScale=d3.scale.linear().domain([0,this.width()]).range([this._lastRange.start(),this._lastRange.end()]);var start=inverseXScale(d3.mouse(this._background[0][0])[0])-this._binSize/2;var end=start+this._binSize;var selectedObject=new epiviz.ui.charts.UiObject(sprintf("%s-highlight",this._id),start,end,null,null,null,null,null);this._hover.notify(selectedObject)};
epiviz.ui.charts.Track.prototype._drawTitle=function(){var textLength=0;var title="";var measurements=this.measurements().toArray();var self=this;this._svg.selectAll(".chart-title").remove();this._svg.selectAll(".chart-title").data(measurements).enter().append("text").attr("class","chart-title").attr("font-weight","bold").attr("fill",function(m,i){return self.colors().get(i)}).attr("x",function(m,i){var result=self.margins().left()+textLength;textLength+=m.name().length*6+7;return result}).attr("y",
self.margins().top()-5).text(function(m,i){return m.name()})};goog.provide("epiviz.ui.charts.Plot");epiviz.ui.charts.Plot=function(id,container,properties){epiviz.ui.charts.Chart.call(this,id,container,properties)};epiviz.ui.charts.Plot.prototype=epiviz.utils.mapCopy(epiviz.ui.charts.Chart.prototype);epiviz.ui.charts.Plot.constructor=epiviz.ui.charts.Plot;epiviz.ui.charts.Plot.prototype.displayType=function(){return epiviz.ui.charts.ChartType.DisplayType.PLOT};goog.provide("epiviz.ui.charts.ChartType");goog.provide("epiviz.ui.charts.ChartType.DisplayType");goog.require("epiviz.ui.charts.Chart");
epiviz.ui.charts.ChartType=function(config){var ChartPropertySettings=epiviz.Config.ChartPropertySettings;this._config=config;this._defaultSettings=epiviz.utils.mapCombine(config.chartSettings[this.typeName()],config.chartSettings[this.chartDisplayType()]);this._defaultWidth=this._defaultSettings[ChartPropertySettings.WIDTH];this._defaultHeight=this._defaultSettings[ChartPropertySettings.HEIGHT];this._defaultMargins=this._defaultSettings[ChartPropertySettings.MARGINS];this._defaultColors=this._defaultSettings[ChartPropertySettings.COLORS];
this._customSettingsValues=config.chartCustomSettings[this.typeName()]||null};epiviz.ui.charts.ChartType.DisplayType={PLOT:"plot",TRACK:"track"};epiviz.ui.charts.ChartType.prototype.createNew=function(id,container,properties){throw Error("unimplemented abstract method");};epiviz.ui.charts.ChartType.prototype.typeName=function(){throw Error("unimplemented abstract method");};epiviz.ui.charts.ChartType.prototype.chartName=function(){throw Error("unimplemented abstract method");};
epiviz.ui.charts.ChartType.prototype.chartHtmlAttributeName=function(){throw Error("unimplemented abstract method");};epiviz.ui.charts.ChartType.prototype.chartDisplayType=function(){throw Error("unimplemented abstract method");};epiviz.ui.charts.ChartType.prototype.chartContentType=function(){throw Error("unimplemented abstract method");};epiviz.ui.charts.ChartType.prototype.isRestrictedToSameDatasourceGroup=function(){return false};epiviz.ui.charts.ChartType.prototype.minSelectedMeasurements=function(){return 1};
epiviz.ui.charts.ChartType.prototype.chartContainer=function(){return epiviz.ui.ControlManager.CHART_TYPE_CONTAINERS[this.chartDisplayType()]};epiviz.ui.charts.ChartType.prototype.cssClass=function(){throw Error("unimplemented abstract method");};epiviz.ui.charts.ChartType.prototype.defaultWidth=function(){return this._defaultWidth};epiviz.ui.charts.ChartType.prototype.defaultHeight=function(){return this._defaultHeight};epiviz.ui.charts.ChartType.prototype.defaultMargins=function(){return this._defaultMargins};
epiviz.ui.charts.ChartType.prototype.defaultColors=function(){return this._defaultColors};epiviz.ui.charts.ChartType.prototype.customSettingsValues=function(){return this._customSettingsValues};
epiviz.ui.charts.ChartType.prototype.customSettingsDefs=function(){return[new epiviz.ui.charts.CustomSetting(epiviz.ui.charts.ChartType.CustomSettings.MARGIN_TOP,epiviz.ui.charts.CustomSetting.Type.NUMBER,this._defaultMargins.top(),"Top margin"),new epiviz.ui.charts.CustomSetting(epiviz.ui.charts.ChartType.CustomSettings.MARGIN_BOTTOM,epiviz.ui.charts.CustomSetting.Type.NUMBER,this._defaultMargins.bottom(),"Bottom margin"),new epiviz.ui.charts.CustomSetting(epiviz.ui.charts.ChartType.CustomSettings.MARGIN_LEFT,
epiviz.ui.charts.CustomSetting.Type.NUMBER,this._defaultMargins.left(),"Left margin"),new epiviz.ui.charts.CustomSetting(epiviz.ui.charts.ChartType.CustomSettings.MARGIN_RIGHT,epiviz.ui.charts.CustomSetting.Type.NUMBER,this._defaultMargins.right(),"Right margin")]};epiviz.ui.charts.ChartType.prototype.constructTitle=function(measurements){var measurementNames=[];measurements.foreach(function(m){measurementNames.push(m.name())});return measurementNames.join(", ")};
epiviz.ui.charts.ChartType.CustomSettings={MARGIN_LEFT:"marginLeft",MARGIN_RIGHT:"marginRight",MARGIN_TOP:"marginTop",MARGIN_BOTTOM:"marginBottom",X_MIN:"xMin",X_MAX:"xMax",Y_MIN:"yMin",Y_MAX:"yMax",LABEL:"label"};goog.provide("epiviz.ui.charts.TrackType");epiviz.ui.charts.TrackType=function(config){epiviz.ui.charts.ChartType.call(this,config)};epiviz.ui.charts.TrackType.prototype=epiviz.utils.mapCopy(epiviz.ui.charts.ChartType.prototype);epiviz.ui.charts.TrackType.constructor=epiviz.ui.charts.TrackType;epiviz.ui.charts.TrackType.prototype.chartDisplayType=function(){return epiviz.ui.charts.ChartType.DisplayType.TRACK};epiviz.ui.charts.TrackType.prototype.cssClass=function(){return"track-container ui-widget-content"};goog.provide("epiviz.ui.charts.PlotType");epiviz.ui.charts.PlotType=function(config){epiviz.ui.charts.ChartType.call(this,config)};epiviz.ui.charts.PlotType.prototype=epiviz.utils.mapCopy(epiviz.ui.charts.ChartType.prototype);epiviz.ui.charts.PlotType.constructor=epiviz.ui.charts.PlotType;epiviz.ui.charts.PlotType.prototype.chartDisplayType=function(){return epiviz.ui.charts.ChartType.DisplayType.PLOT};epiviz.ui.charts.PlotType.prototype.cssClass=function(){return"plot-container ui-widget-content"};goog.provide("epiviz.ui.charts.ChartFactory");goog.require("epiviz.ui.charts.Chart");goog.require("epiviz.ui.charts.ChartType");epiviz.ui.charts.ChartFactory=function(config){this._config=config;this._types={};this._size=0;for(var i=0;i<config.chartTypes.length;++i)this.register(config.chartTypes[i])};epiviz.ui.charts.ChartFactory.prototype.size=function(){return this._size};
epiviz.ui.charts.ChartFactory.prototype.registerType=function(type){if(!(type.typeName()in this._types))++this._size;this._types[type.typeName()]=type};epiviz.ui.charts.ChartFactory.prototype.unregisterType=function(type){if(!(type.typeName()in this._types))return false;--this._size;delete this._types[type.typeName()];return true};
epiviz.ui.charts.ChartFactory.prototype.register=function(typeName){var typeDescriptorConstructor=epiviz.utils.evaluateFullyQualifiedTypeName(typeName);if(!typeDescriptorConstructor)return false;this.registerType((new typeDescriptorConstructor(this._config)));return true};epiviz.ui.charts.ChartFactory.prototype.unregister=function(typeName){var typeDescriptorConstructor=epiviz.utils.evaluateFullyQualifiedTypeName(typeName);if(!typeDescriptorConstructor)return false;return this.unregisterType((new typeDescriptorConstructor(this._config)))};
epiviz.ui.charts.ChartFactory.prototype.get=function(typeName){if(typeName&&typeName in this._types)return this._types[typeName];return null};epiviz.ui.charts.ChartFactory.prototype.foreach=function(func){for(var typeName in this._types){if(!this._types.hasOwnProperty(typeName))continue;if(func(typeName,this._types[typeName]))return}};goog.provide("epiviz.ui.charts.ChartManager");
epiviz.ui.charts.ChartManager=function(config){this._config=config;this._charts={};this._chartsOrder={};this._resizeInterval=null;this._chartAdded=new epiviz.events.Event;this._chartRemoved=new epiviz.events.Event;this._chartsCleared=new epiviz.events.Event;this._chartColorsChanged=new epiviz.events.Event;this._chartCustomSettingsChanged=new epiviz.events.Event;this._chartSizeChanged=new epiviz.events.Event;this._chartMarginsChanged=new epiviz.events.Event;this._registerWindowResize()};
epiviz.ui.charts.ChartManager.prototype.addChart=function(chartType,measurements,id,chartProperties){id=id||sprintf("%s-%s-%s",chartType.chartDisplayType(),chartType.chartHtmlAttributeName(),epiviz.utils.generatePseudoGUID(5));var css=chartType.cssClass();var chartsContainer=$("#"+chartType.chartContainer());chartsContainer.append(sprintf('<div id="%s" class="%s"></div>',id,css));var container=chartsContainer.find("#"+id);chartProperties=chartProperties||new epiviz.ui.charts.ChartProperties(chartType.defaultWidth(),
chartType.defaultHeight(),chartType.defaultMargins(),measurements,chartType.defaultColors(),chartType.customSettingsValues(),chartType.customSettingsDefs());var chart=chartType.createNew(id,container,chartProperties);this._charts[id]=chart;this._registerChartHover(chart);this._registerChartUnhover(chart);this._registerChartSelect(chart);this._registerChartDeselect(chart);this._registerChartColorsChanged(chart);this._registerChartCustomSettingsChanged(chart);this._registerChartSizeChanged(chart);this._registerChartMarginsChanged(chart);
this._registerChartRemove(chart);this._registerChartSave(chart);if(!(chartType.chartDisplayType()in this._chartsOrder))this._chartsOrder[chartType.chartDisplayType()]=[];this._chartsOrder[chartType.chartDisplayType()].push(id);this._chartAdded.notify({id:id,type:chartType,properties:chartProperties,chartsOrder:this._chartsOrder});return id};
epiviz.ui.charts.ChartManager.prototype.removeChart=function(id){$("#"+id).remove();var DisplayType=epiviz.ui.charts.ChartType.DisplayType;var chart=this._charts[id];delete this._charts[id];this._chartsOrder[chart.displayType()].splice(this._chartsOrder[chart.displayType()].indexOf(id),1);this._chartRemoved.notify({id:id,chartsOrder:this._chartsOrder})};
epiviz.ui.charts.ChartManager.prototype.chartsMeasurements=function(){var result={};for(var chartId in this._charts){if(!this._charts.hasOwnProperty(chartId))continue;result[chartId]=this._charts[chartId].measurements()}return result};
epiviz.ui.charts.ChartManager.prototype.updateCharts=function(range,data,chartIds){chartIds=chartIds||Object.keys(this._charts);for(var i=0;i<chartIds.length;++i){if(!this._charts.hasOwnProperty(chartIds[i]))continue;var chart=this._charts[chartIds[i]];if(!chart)continue;chart.draw(range,data)}};
epiviz.ui.charts.ChartManager.prototype.clear=function(){this._charts={};this._chartsOrder={};var chartContainers=epiviz.ui.ControlManager.CHART_TYPE_CONTAINERS;for(var displayType in chartContainers){if(!chartContainers.hasOwnProperty(displayType))continue;$("#"+chartContainers[displayType]).empty()}this._chartsCleared.notify()};
epiviz.ui.charts.ChartManager.prototype.addChartsLoaderAnimation=function(chartId){if(chartId&&this._charts[chartId]){this._charts[chartId].addLoaderAnimation();return}for(var id in this._charts){if(!this._charts.hasOwnProperty(chartId))continue;this._charts[chartId].addLoaderAnimation()}};epiviz.ui.charts.ChartManager.prototype.onChartAdded=function(){return this._chartAdded};epiviz.ui.charts.ChartManager.prototype.onChartRemoved=function(){return this._chartRemoved};
epiviz.ui.charts.ChartManager.prototype.onChartsCleared=function(){return this._chartsCleared};epiviz.ui.charts.ChartManager.prototype.onChartColorsChanged=function(){return this._chartColorsChanged};epiviz.ui.charts.ChartManager.prototype.onChartCustomSettingsChanged=function(){return this._chartCustomSettingsChanged};epiviz.ui.charts.ChartManager.prototype.onChartSizeChanged=function(){return this._chartSizeChanged};epiviz.ui.charts.ChartManager.prototype.onChartMarginsChanged=function(){return this._chartMarginsChanged};
epiviz.ui.charts.ChartManager.prototype._registerWindowResize=function(){var self=this;$(window).resize(function(e){if(self._resizeInterval!==null)window.clearTimeout(self._resizeInterval);self._resizeInterval=window.setTimeout(function(){for(var chartId in self._charts){if(!self._charts.hasOwnProperty(chartId))continue;self._charts[chartId].containerResize()}self._resizeInterval=null},500)})};
epiviz.ui.charts.ChartManager.prototype._registerChartHover=function(chart){var self=this;chart.onHover().addListener(new epiviz.events.EventListener(function(selectedObject){for(var id in self._charts){if(!self._charts.hasOwnProperty(id))continue;self._charts[id].doHover(selectedObject)}}))};
epiviz.ui.charts.ChartManager.prototype._registerChartUnhover=function(chart){var self=this;chart.onUnhover().addListener(new epiviz.events.EventListener(function(){for(var id in self._charts){if(!self._charts.hasOwnProperty(id))continue;self._charts[id].doUnhover()}}))};
epiviz.ui.charts.ChartManager.prototype._registerChartSelect=function(chart){var self=this;chart.onSelect().addListener(new epiviz.events.EventListener(function(selectedObject){for(var id in self._charts){if(!self._charts.hasOwnProperty(id))continue;self._charts[id].doSelect(selectedObject)}}))};
epiviz.ui.charts.ChartManager.prototype._registerChartDeselect=function(chart){var self=this;chart.onDeselect().addListener(new epiviz.events.EventListener(function(){for(var id in self._charts){if(!self._charts.hasOwnProperty(id))continue;self._charts[id].doDeselect()}}))};epiviz.ui.charts.ChartManager.prototype._registerChartRemove=function(chart){var self=this;chart.onRemove().addListener(new epiviz.events.EventListener(function(){self.removeChart(chart.id())}))};
epiviz.ui.charts.ChartManager.prototype._registerChartSave=function(chart){var self=this;chart.onSave().addListener(new epiviz.events.EventListener(function(chartId){var saveSvgDialog=new epiviz.ui.controls.SaveSvgAsImageDialog({ok:function(){},cancel:function(){}},chartId,self._config.dataServerLocation+self._config.chartSaverLocation);saveSvgDialog.show()}))};epiviz.ui.charts.ChartManager.prototype._registerChartColorsChanged=function(chart){var self=this;chart.onColorsChanged().addListener(new epiviz.events.EventListener(function(e){self._chartColorsChanged.notify(e)}))};
epiviz.ui.charts.ChartManager.prototype._registerChartCustomSettingsChanged=function(chart){var self=this;chart.onCustomSettingsChanged().addListener(new epiviz.events.EventListener(function(e){self._chartCustomSettingsChanged.notify(e)}))};epiviz.ui.charts.ChartManager.prototype._registerChartSizeChanged=function(chart){var self=this;chart.onSizeChanged().addListener(new epiviz.events.EventListener(function(e){self._chartSizeChanged.notify(e)}))};
epiviz.ui.charts.ChartManager.prototype._registerChartMarginsChanged=function(chart){var self=this;chart.onMarginsChanged().addListener(new epiviz.events.EventListener(function(e){self._chartMarginsChanged.notify(e)}))};goog.provide("epiviz.workspaces.UserManager");epiviz.workspaces.UserManager=function(config){this._config=config};epiviz.workspaces.UserManager.USER_STATUS=epiviz.workspaces.UserManager.USER_STATUS||{loggedIn:false,userData:null,oauthProvider:null};epiviz.workspaces.UserManager.prototype.toggleLogin=function(){if(!epiviz.workspaces.UserManager.USER_STATUS.loggedIn)this._login();else this._logout()};
epiviz.workspaces.UserManager.prototype._login=function(){var location=window.location.toString();if(location.length>0)location=encodeURIComponent(location);var pathname=this._config.dataServerLocation+"login.php";window.location=pathname+"?location="+location};epiviz.workspaces.UserManager.prototype._logout=function(){var location=window.location.toString();if(location.length>0)location=encodeURIComponent(location);window.location=this._config.dataServerLocation+"logout.php?logout&location="+location};goog.provide("epiviz.workspaces.Workspace");
epiviz.workspaces.Workspace=function(id,name,content){this._id=id;this._name=name;this._range=content.range;this._chartsOrder={};this._chartsById={};for(var displayType in content.charts){if(!content.charts.hasOwnProperty(displayType))continue;this._chartsOrder[displayType]=[];for(var i=0;i<content.charts[displayType].length;++i){this._chartsById[content.charts[displayType][i].id]=content.charts[displayType][i];this._chartsOrder[displayType].push(content.charts[displayType][i].id)}}this._computedMeasurements=content.computedMeasurements||
new epiviz.measurements.MeasurementSet;this._changed=false};epiviz.workspaces.Workspace.DEFAULT_WORKSPACE_NAME="Default Workspace";epiviz.workspaces.Workspace.prototype.id=function(){return this._id};epiviz.workspaces.Workspace.prototype.name=function(){return this._name};epiviz.workspaces.Workspace.prototype.range=function(){return this._range};
epiviz.workspaces.Workspace.prototype.charts=function(){var charts={};for(var displayType in this._chartsOrder){if(!this._chartsOrder.hasOwnProperty(displayType))continue;charts[displayType]=[];for(var i=0;i<this._chartsOrder[displayType].length;++i)charts[displayType].push(this._chartsById[this._chartsOrder[displayType][i]])}return charts};epiviz.workspaces.Workspace.prototype.chartsOrder=function(){return this._chartsOrder};epiviz.workspaces.Workspace.prototype.computedMeasurements=function(){return this._computedMeasurements};
epiviz.workspaces.Workspace.prototype.chartAdded=function(id,type,properties,chartsOrder){this._chartsById[id]={id:id,type:type,properties:properties.copy()};this._chartsOrder=chartsOrder;this._setChanged()};epiviz.workspaces.Workspace.prototype.chartRemoved=function(id,chartsOrder){if(!this._chartsById[id])return;delete this._chartsById[id];this._chartsOrder=chartsOrder;this._setChanged()};
epiviz.workspaces.Workspace.prototype.chartSizeChanged=function(chartId,width,height){if(this._chartsById[chartId].properties.width==width&&this._chartsById[chartId].properties.height==height)return;this._chartsById[chartId].properties.width=width;this._chartsById[chartId].properties.height=height;this._setChanged()};
epiviz.workspaces.Workspace.prototype.chartMarginsChanged=function(chartId,margins){if(this._chartsById[chartId].properties.margins.equals(margins))return;this._chartsById[chartId].properties.margins=margins?margins.copy():margins;this._setChanged()};epiviz.workspaces.Workspace.prototype.chartColorsChanged=function(chartId,colors){if(this._chartsById[chartId].properties.colors.equals(colors))return;this._chartsById[chartId].properties.colors=colors;this._setChanged()};
epiviz.workspaces.Workspace.prototype.chartCustomSettingsChanged=function(chartId,customSettingsValues){if(epiviz.utils.mapEquals(this._chartsById[chartId].properties.customSettingsValues,customSettingsValues))return;this._chartsById[chartId].properties.customSettingsValues=customSettingsValues?epiviz.utils.mapCopy(customSettingsValues):customSettingsValues;this._setChanged()};
epiviz.workspaces.Workspace.prototype.locationChanged=function(range){if(this._range.equals(range))return;this._range=range;this._setChanged()};epiviz.workspaces.Workspace.prototype.computedMeasurementsAdded=function(measurements){var sizeBefore=this._computedMeasurements.size();this._computedMeasurements.addAll(measurements);if(sizeBefore!=this._computedMeasurements.size())this._setChanged()};
epiviz.workspaces.Workspace.prototype.computedMeasurementsRemoved=function(measurements){var sizeBefore=this._computedMeasurements.size();this._computedMeasurements.removeAll(measurements);if(sizeBefore!=this._computedMeasurements.size())this._setChanged()};epiviz.workspaces.Workspace.prototype.changed=function(){return this._changed};epiviz.workspaces.Workspace.prototype.resetChanged=function(){this._changed=false};epiviz.workspaces.Workspace.prototype._setChanged=function(){this._changed=true};
epiviz.workspaces.Workspace.prototype.copy=function(name,id){var charts=this.charts();return new epiviz.workspaces.Workspace(id||null,name,{range:this._range,computedMeasurements:new epiviz.measurements.MeasurementSet(this._computedMeasurements),charts:charts})};
epiviz.workspaces.Workspace.prototype.raw=function(){var wsMeasurements=new epiviz.measurements.MeasurementHashtable;var charts={};this._computedMeasurements.foreach(function(m){var mIndex;var componentMs=m.componentMeasurements();componentMs.foreach(function(compM){var mIndex=wsMeasurements.get(compM);if(mIndex===null){mIndex=wsMeasurements.size();wsMeasurements.put(compM,mIndex)}});var refMs=m.formula().referredMeasurements;for(var j in refMs){if(!refMs.hasOwnProperty(j))continue;mIndex=wsMeasurements.get(refMs[j]);
if(mIndex===null){mIndex=wsMeasurements.size();wsMeasurements.put(refMs[j],mIndex)}}mIndex=wsMeasurements.get(m);if(mIndex===null){mIndex=wsMeasurements.size();wsMeasurements.put(m,mIndex)}});for(var displayType in this._chartsOrder){if(!this._chartsOrder.hasOwnProperty(displayType))continue;charts[displayType]=[];for(var i=0;i<this._chartsOrder[displayType].length;++i){var chartData=this._chartsById[this._chartsOrder[displayType][i]];var props=chartData.properties;var ms=[];(function(ms){props.measurements.foreach(function(m){var mIndex=
wsMeasurements.get(m);if(mIndex===null){mIndex=wsMeasurements.size();wsMeasurements.put(m,mIndex)}ms.push(mIndex)})})(ms);charts[displayType].push({id:chartData.id,type:chartData.type.typeName(),properties:{width:props.width,height:props.height,margins:props.margins.raw(),measurements:ms,colors:props.colors.raw(),customSettings:props.customSettingsValues||null}})}}var rawMs=new Array(wsMeasurements.size());wsMeasurements.foreach(function(m,j){rawMs[j]=m.raw(wsMeasurements)});return{id:this._id,name:this._name,
content:{range:this._range.raw(),measurements:rawMs,charts:charts}}};
epiviz.workspaces.Workspace.fromRawObject=function(o,chartFactory){var i;var ms=new Array(o.content.measurements.length);var computedMeasurements=new epiviz.measurements.MeasurementSet;for(i=0;i<o.content.measurements.length;++i)if(!o.content.measurements[i].formula)ms[i]=epiviz.measurements.Measurement.fromRawObject(o.content.measurements[i]);for(i=0;i<o.content.measurements.length;++i)if(o.content.measurements[i].formula){ms[i]=epiviz.measurements.Measurement.fromRawObject(o.content.measurements[i],
ms);computedMeasurements.add(ms[i])}var charts={};for(var t in o.content.charts){if(!o.content.charts.hasOwnProperty(t))continue;charts[t]=[];for(i=0;i<o.content.charts[t].length;++i){var chartInfo=o.content.charts[t][i];var chartMs=new epiviz.measurements.MeasurementSet;for(var j=0;j<chartInfo.properties.measurements.length;++j)chartMs.add(ms[chartInfo.properties.measurements[j]]);var chartType=chartFactory.get(chartInfo.type);if(!chartType)continue;charts[t].push({id:chartInfo.id,type:chartType,
properties:new epiviz.ui.charts.ChartProperties(chartInfo.properties.width,chartInfo.properties.height,epiviz.ui.charts.Margins.fromRawObject(chartInfo.properties.margins),chartMs,epiviz.ui.charts.ColorPalette.fromRawObject(chartInfo.properties.colors),chartInfo.properties.customSettings,chartType.customSettingsDefs())})}}return new epiviz.workspaces.Workspace(o.id,o.name,{range:epiviz.datatypes.GenomicRange.fromRawObject(o.content.range),computedMeasurements:computedMeasurements,charts:charts})};goog.provide("epiviz.workspaces.WorkspaceManager");goog.require("epiviz.workspaces.Workspace");
epiviz.workspaces.WorkspaceManager=function(config,locationManager,measurementsManager,chartManager,chartFactory){this._config=config;this._locationManager=locationManager;this._measurementsManager=measurementsManager;this._chartManager=chartManager;this._chartFactory=chartFactory;this._activeWorkspace=null;this._workspaces=null;this._workspacesByName=null;this._workspacesLoaded=new epiviz.events.Event;this._activeWorkspaceChanged=new epiviz.events.Event;this._activeWorkspaceChanging=false;this._requestWorkspaces=
new epiviz.events.Event;this._registerLocationChanged();this._registerComputedMeasurementAdded();this._registerComputedMeasurementRemoved();this._registerChartAdded();this._registerChartRemoved();this._registerChartColorsChanged();this._registerChartSizeChanged();this._registerChartMarginsChanged();this._registerChartCustomSettingsChanged()};epiviz.workspaces.WorkspaceManager.prototype.activeWorkspace=function(){return this._activeWorkspace||null};
epiviz.workspaces.WorkspaceManager.prototype.get=function(id){return id&&this._workspaces?this._workspaces[id]||null:null};epiviz.workspaces.WorkspaceManager.prototype.getByName=function(name){return name&&this._workspacesByName?this._workspacesByName[name]||null:null};epiviz.workspaces.WorkspaceManager.prototype.initialize=function(){var requestWorkspaceId=epiviz.ui.WebArgsManager.WEB_ARGS["ws"]||epiviz.ui.WebArgsManager.WEB_ARGS["workspace"]||null;this._requestWorkspaces.notify({activeWorkspaceId:requestWorkspaceId})};
epiviz.workspaces.WorkspaceManager.prototype.updateWorkspaces=function(workspaces,activeWorkspace,activeWorkspaceId){if(workspaces){this._workspaces={};this._workspacesByName={};for(var i=0;i<workspaces.length;++i){if(workspaces[i].id()===null)continue;this._workspaces[workspaces[i].id()]=workspaces[i];this._workspacesByName[workspaces[i].name()]=workspaces[i]}}if(!activeWorkspace)activeWorkspace=workspaces&&workspaces.length?workspaces[0]:epiviz.workspaces.Workspace.fromRawObject(this._config.defaultWorkspaceSettings,
this._chartFactory);var oldActiveWorkspace=this._activeWorkspace;this._activeWorkspace=activeWorkspace;var webArgs=epiviz.ui.WebArgsManager.WEB_ARGS;var seqName=webArgs["seqName"]||this._activeWorkspace.range().seqName();var start=parseInt(webArgs["start"])||this._activeWorkspace.range().start();var end=parseInt(webArgs["end"])||this._activeWorkspace.range().end();this._activeWorkspace.locationChanged(epiviz.datatypes.GenomicRange.fromStartEnd(seqName,start,end));this._workspacesLoaded.notify({activeWorkspace:this._activeWorkspace,
workspaces:workspaces});this._activeWorkspaceChanged.notify({oldValue:oldActiveWorkspace,newValue:this._activeWorkspace,workspaceId:this._activeWorkspace.id()||activeWorkspaceId})};epiviz.workspaces.WorkspaceManager.prototype.updateWorkspace=function(workspace){this._workspaces[workspace.id()]=workspace;this._workspacesByName[workspace.name()]=workspace};
epiviz.workspaces.WorkspaceManager.prototype.deleteActiveWorkspace=function(){var activeWorkspace=this._activeWorkspace;if(!activeWorkspace||!activeWorkspace.id())return;delete this._workspaces[activeWorkspace.id()];delete this._workspacesByName[activeWorkspace.name()];var newActiveWorkspace=null;for(var id in this._workspaces){if(!this._workspaces.hasOwnProperty(id))continue;newActiveWorkspace=this._workspaces[id];break}if(!newActiveWorkspace)newActiveWorkspace=epiviz.workspaces.Workspace.fromRawObject(this._config.defaultWorkspaceSettings,
this._chartFactory);this._activeWorkspace=newActiveWorkspace;var seqName=activeWorkspace.range().seqName();var start=activeWorkspace.range().start();var end=activeWorkspace.range().end();this._activeWorkspace.locationChanged(epiviz.datatypes.GenomicRange.fromStartEnd(seqName,start,end));this._activeWorkspaceChanged.notify({oldValue:activeWorkspace,newValue:this._activeWorkspace,workspaceId:this._activeWorkspace.id()})};epiviz.workspaces.WorkspaceManager.prototype.onWorkspacesLoaded=function(){return this._workspacesLoaded};
epiviz.workspaces.WorkspaceManager.prototype.onActiveWorkspaceChanged=function(){return this._activeWorkspaceChanged};epiviz.workspaces.WorkspaceManager.prototype.startChangingActiveWorkspace=function(){this._activeWorkspaceChanging=true};epiviz.workspaces.WorkspaceManager.prototype.endChangingActiveWorkspace=function(){this._activeWorkspaceChanging=false};epiviz.workspaces.WorkspaceManager.prototype.activeWorkspaceChanging=function(){return this._activeWorkspaceChanging};
epiviz.workspaces.WorkspaceManager.prototype.onRequestWorkspaces=function(){return this._requestWorkspaces};epiviz.workspaces.WorkspaceManager.prototype.changeActiveWorkspace=function(id,workspace){workspace=workspace||this._workspaces[id];if(!workspace||workspace===this._activeWorkspace)return;var oldValue=this._activeWorkspace;this._activeWorkspace=workspace;this._activeWorkspaceChanged.notify({oldValue:oldValue,newValue:this._activeWorkspace,workspaceId:id})};
epiviz.workspaces.WorkspaceManager.prototype._registerLocationChanged=function(){var self=this;this._locationManager.onCurrentLocationChanged().addListener(new epiviz.events.EventListener(function(e){if(self._activeWorkspaceChanging)return;if(!self._activeWorkspace)return;self._activeWorkspace.locationChanged(e.newValue)}))};
epiviz.workspaces.WorkspaceManager.prototype._registerChartAdded=function(){var self=this;this._chartManager.onChartAdded().addListener(new epiviz.events.EventListener(function(e){if(self._activeWorkspaceChanging)return;if(!self._activeWorkspace)return;self._activeWorkspace.chartAdded(e.id,e.type,e.properties,e.chartsOrder)}))};
epiviz.workspaces.WorkspaceManager.prototype._registerChartRemoved=function(){var self=this;this._chartManager.onChartRemoved().addListener(new epiviz.events.EventListener(function(e){if(self._activeWorkspaceChanging)return;if(!self._activeWorkspace)return;self._activeWorkspace.chartRemoved(e.id,e.chartsOrder)}))};
epiviz.workspaces.WorkspaceManager.prototype._registerChartColorsChanged=function(){var self=this;this._chartManager.onChartColorsChanged().addListener(new epiviz.events.EventListener(function(e){if(self._activeWorkspaceChanging)return;if(!self._activeWorkspace)return;self._activeWorkspace.chartColorsChanged(e.id,e.colors)}))};
epiviz.workspaces.WorkspaceManager.prototype._registerChartCustomSettingsChanged=function(){var self=this;this._chartManager.onChartCustomSettingsChanged().addListener(new epiviz.events.EventListener(function(e){if(self._activeWorkspaceChanging)return;if(!self._activeWorkspace)return;self._activeWorkspace.chartCustomSettingsChanged(e.id,e.customSettingsValues)}))};
epiviz.workspaces.WorkspaceManager.prototype._registerChartSizeChanged=function(){var self=this;this._chartManager.onChartSizeChanged().addListener(new epiviz.events.EventListener(function(e){if(self._activeWorkspaceChanging)return;if(!self._activeWorkspace)return;self._activeWorkspace.chartSizeChanged(e.id,e.width,e.height)}))};
epiviz.workspaces.WorkspaceManager.prototype._registerChartMarginsChanged=function(){var self=this;this._chartManager.onChartMarginsChanged().addListener(new epiviz.events.EventListener(function(e){if(self._activeWorkspaceChanging)return;if(!self._activeWorkspace)return;self._activeWorkspace.chartMarginsChanged(e.id,e.margins)}))};
epiviz.workspaces.WorkspaceManager.prototype._registerComputedMeasurementAdded=function(){var self=this;this._measurementsManager.onComputedMeasurementsAdded().addListener(new epiviz.events.EventListener(function(measurements){if(self._activeWorkspaceChanging)return;if(!self._activeWorkspace)return;self._activeWorkspace.computedMeasurementsAdded(measurements)}))};
epiviz.workspaces.WorkspaceManager.prototype._registerComputedMeasurementRemoved=function(){var self=this;this._measurementsManager.onComputedMeasurementsRemoved().addListener(new epiviz.events.EventListener(function(measurements){if(self._activeWorkspaceChanging)return;if(!self._activeWorkspace)return;self._activeWorkspace.computedMeasurementsRemoved(measurements)}))};goog.provide("epiviz.datatypes.GenomicRange");epiviz.datatypes.GenomicRange=function(seqname,start,width){this._seqname=seqname;this._start=start;this._width=width};epiviz.datatypes.GenomicRange.fromStartEnd=function(seqname,start,end){return new epiviz.datatypes.GenomicRange(seqname,start,end-start)};epiviz.datatypes.GenomicRange.prototype.seqName=function(){return this._seqname};epiviz.datatypes.GenomicRange.prototype.start=function(){return this._start};
epiviz.datatypes.GenomicRange.prototype.width=function(){return this._width};epiviz.datatypes.GenomicRange.prototype.end=function(){return this._start+this._width};epiviz.datatypes.GenomicRange.prototype.isEmpty=function(){return this._width<=0};
epiviz.datatypes.GenomicRange.prototype.subtract=function(other){if(!other||other.seqName()!=this._seqname||other.isEmpty()||other.start()>=this.end()||this._start>=other.end())return[this];if(other.start()<=this._start&&other.end()>=this.end())return[];if(other.start()>this._start&&other.end()<this.end())return[epiviz.datatypes.GenomicRange.fromStartEnd(this._seqname,this._start,other.start()),epiviz.datatypes.GenomicRange.fromStartEnd(this._seqname,other.end(),this.end())];if(other.start()>this._start)return[epiviz.datatypes.GenomicRange.fromStartEnd(this._seqname,
this._start,other.start())];return[epiviz.datatypes.GenomicRange.fromStartEnd(this._seqname,other.end(),this.end())]};epiviz.datatypes.GenomicRange.prototype.equals=function(other){if(!other)return false;if(other==this)return true;return this._seqname==other._seqname&&this._start==other._start&&this._width==other._width};
epiviz.datatypes.GenomicRange.prototype.overlapsWith=function(other){if(!other)return false;if(this==other)return true;if(this.seqName()!=other.seqName())return false;return this.start()<other.end()&&this.end()>other.start()};epiviz.datatypes.GenomicRange.prototype.raw=function(){return{seqName:this._seqname,start:this._start,width:this._width}};epiviz.datatypes.GenomicRange.fromRawObject=function(o){return new epiviz.datatypes.GenomicRange(o.seqName,o.start,o.width)};goog.provide("epiviz.ui.LocationManager");epiviz.ui.LocationManager=function(config){this._seqInfos={};this._currentLocation=null;this._lastUnfilledRequest=null;this._timeout=null;this._navigationDelay=config.navigationDelay;this._currentLocationChanged=new epiviz.events.Event;this._seqInfosUpdated=new epiviz.events.Event;this._requestSeqInfos=new epiviz.events.Event};epiviz.ui.LocationManager.prototype.initialize=function(){this._requestSeqInfos.notify()};
epiviz.ui.LocationManager.prototype.changeCurrentLocation=function(range){if(this._currentLocationChanged.isFiring())return;this._lastUnfilledRequest=range;if(this._timeout!==null){window.clearTimeout(this._timeout);this._timeout=null}var self=this;var locationChangeFunction=function(){var request=self._lastUnfilledRequest;if(request===null)return;self._doChangeCurrentLocation(request)};if(this._navigationDelay)this._timeout=window.setTimeout(locationChangeFunction,this._navigationDelay);else locationChangeFunction()};
epiviz.ui.LocationManager.prototype._doChangeCurrentLocation=function(range){var oldValue=this._currentLocation;var seqName=range.seqName();if(!(range.seqName()in this._seqInfos)){if(!oldValue)return;seqName=oldValue.seqName()}var start=range.start()>=this._seqInfos[seqName].min?range.start():this._seqInfos[seqName].min;var end=start+range.width();if(end>this._seqInfos[seqName].max){end=this._seqInfos[seqName].max;start=Math.max(this._seqInfos[seqName].min,end-range.width())}this._lastUnfilledRequest=
null;this._currentLocation=epiviz.datatypes.GenomicRange.fromStartEnd(seqName,start,end);this._currentLocationChanged.notify({oldValue:oldValue,newValue:this._currentLocation})};epiviz.ui.LocationManager.prototype.currentLocation=function(){return this._currentLocation};epiviz.ui.LocationManager.prototype.lastUnfilledLocationChangeRequest=function(){return this._lastUnfilledRequest};
epiviz.ui.LocationManager.prototype.updateSeqInfos=function(seqInfos){this._seqInfos={};for(var i=0;i<seqInfos.length;++i)this._seqInfos[seqInfos[i].seqName]=seqInfos[i];this._seqInfosUpdated.notify(seqInfos);if(this._lastUnfilledRequest!==null)this._doChangeCurrentLocation(this._lastUnfilledRequest)};
epiviz.ui.LocationManager.prototype.addSeqInfos=function(seqInfos){for(var i=0;i<seqInfos.length;++i)if(!this._seqInfos[seqInfos[i].seqName])this._seqInfos[seqInfos[i].seqName]=seqInfos[i];var eventSeqInfos=[];for(var seqName in this._seqInfos){if(!this._seqInfos.hasOwnProperty(seqName))continue;eventSeqInfos.push(this._seqInfos[seqName])}this._seqInfosUpdated.notify(eventSeqInfos)};
epiviz.ui.LocationManager.prototype.removeSeqNames=function(seqNames){for(var i=0;i<seqNames.length;++i)delete this._seqInfos[seqNames[i]];var eventSeqInfos=[];for(var seqName in this._seqInfos){if(!this._seqInfos.hasOwnProperty(seqName))continue;eventSeqInfos.push(this._seqInfos[seqName])}this._seqInfosUpdated.notify(eventSeqInfos);if(!(this._currentLocation.seqName()in this._seqInfos))this.changeCurrentLocation(new epiviz.datatypes.GenomicRange(eventSeqInfos[0].seqName,this._currentLocation.start(),
this._currentLocation.width()))};epiviz.ui.LocationManager.prototype.seqInfos=function(){return this._seqInfos};epiviz.ui.LocationManager.prototype.onCurrentLocationChanged=function(){return this._currentLocationChanged};epiviz.ui.LocationManager.prototype.onSeqInfosUpdated=function(){return this._seqInfosUpdated};epiviz.ui.LocationManager.prototype.onRequestSeqInfos=function(){return this._requestSeqInfos};goog.provide("epiviz.ui.ControlManager");goog.require("epiviz.Config");goog.require("epiviz.events.Event");goog.require("epiviz.ui.charts.Chart");goog.require("epiviz.ui.charts.ChartFactory");goog.require("epiviz.ui.charts.ChartManager");goog.require("epiviz.workspaces.WorkspaceManager");goog.require("epiviz.datatypes.GenomicRange");
epiviz.ui.ControlManager=function(config,chartFactory,chartManager,measurementsManager,locationManager){this._config=config;this._chartFactory=chartFactory;this._chartManager=chartManager;this._measurementsManager=measurementsManager;this._locationManager=locationManager;this._addChart=new epiviz.events.Event;this._activeWorkspaceChanged=new epiviz.events.Event;this._saveWorkspace=new epiviz.events.Event;this._deleteActiveWorkspace=new epiviz.events.Event;this._loginLinkClicked=new epiviz.events.Event;
this._searchWorkspaces=new epiviz.events.Event;this._search=new epiviz.events.Event;this._activeWorkspaceInfo=null;this._stepRatio=config.navigationStepRatio;this._zoominRatio=config.zoominRatio;this._zoomoutRatio=config.zoomoutRatio};epiviz.ui.ControlManager.CHART_TYPE_CONTAINERS={"plot":"chart-container","track":"track-container"};
epiviz.ui.ControlManager.prototype.initialize=function(){this._initializeAccordions();this._initializeChromosomeSelector();this._initializeLocationTextbox();this._initializeNavigationButtons();this._initializeZoomButtons();this._initializeLocationSettingsDialog();this._initializeChartMenus();this._initializeComputedMeasurementsMenu();this._initializeHelpButton();this._initializeSearchBox();this._initializeWorkspaceSaving();this._initializeLoginLink();this._initializeLayout();this._checkBrowserCompatibility();
this._registerLocationChanged();this._registerSeqInfosUpdated()};epiviz.ui.ControlManager.prototype.onAddChart=function(){return this._addChart};epiviz.ui.ControlManager.prototype.onActiveWorkspaceChanged=function(){return this._activeWorkspaceChanged};epiviz.ui.ControlManager.prototype.onSaveWorkspace=function(){return this._saveWorkspace};epiviz.ui.ControlManager.prototype.onDeleteActiveWorkspace=function(){return this._deleteActiveWorkspace};
epiviz.ui.ControlManager.prototype.onLoginLinkClicked=function(){return this._loginLinkClicked};epiviz.ui.ControlManager.prototype.onSearchWorkspaces=function(){return this._searchWorkspaces};epiviz.ui.ControlManager.prototype.onSearch=function(){return this._search};
epiviz.ui.ControlManager.prototype._updateSeqNames=function(seqInfos){var chromosomeSelector=$("#chromosome-selector");var optionFormat='<option value="%s"%s>%s</option>';chromosomeSelector.empty();for(var i=0;i<seqInfos.length;++i){var option=sprintf(optionFormat,seqInfos[i].seqName,this._locationManager.currentLocation()&&seqInfos[i].seqName==this._locationManager.currentLocation().seqName()?'selected="selected"':"",seqInfos[i].seqName);chromosomeSelector.append(option)}chromosomeSelector.selectmenu()};
epiviz.ui.ControlManager.prototype._updateSelectedLocation=function(range){if(!range)return;this._locationManager.changeCurrentLocation(range);range=this._locationManager.currentLocation();var locationTextBox=$("#text-location");locationTextBox.val(Globalize.format(range.start(),"n0")+" - "+Globalize.format(range.end(),"n0"));var chromosomeSelector=$("#chromosome-selector");chromosomeSelector.val(range.seqName());chromosomeSelector.selectmenu()};
epiviz.ui.ControlManager.prototype.updateSelectedWorkspace=function(workspaceInfo){var self=this;var saveTextBox=$("#save-workspace-text");var oldValue=this._activeWorkspaceInfo;saveTextBox.val(workspaceInfo.name);this._activeWorkspaceInfo=workspaceInfo;var args={oldValue:oldValue,newValue:workspaceInfo,cancel:function(){saveTextBox.val(oldValue.name);self._activeWorkspaceInfo=oldValue}};this._activeWorkspaceChanged.notify(args)};
epiviz.ui.ControlManager.prototype._initializeAccordions=function(){var topAccordion=$("#top-accordion");topAccordion.multiAccordion();topAccordion.multiAccordion("option","active","all");var bottomAccordion=$("#bottom-accordion");bottomAccordion.multiAccordion();bottomAccordion.multiAccordion("option","active","all")};
epiviz.ui.ControlManager.prototype._initializeChromosomeSelector=function(){var chromosomeSelector=$("#chromosome-selector");chromosomeSelector.selectmenu({style:"popup",width:"90",maxHeight:"100",menuWidth:"90"});var self=this;chromosomeSelector.change(function(){var currentLocation=self._locationManager.lastUnfilledLocationChangeRequest()||self._locationManager.currentLocation();var seqName=$(this).val();self._updateSelectedLocation(new epiviz.datatypes.GenomicRange(seqName,currentLocation.start(),
currentLocation.width()))})};
epiviz.ui.ControlManager.prototype._initializeLocationTextbox=function(){var self=this;var locationTextBox=$("#text-location");locationTextBox.keypress(function(event){if(event.which!=13)return true;try{var location=$(this).val();var startEnd=location.split("-");var start=Globalize.parseInt(startEnd[0]);var end=Globalize.parseInt(startEnd[1]);var currentLocation=self._locationManager.lastUnfilledLocationChangeRequest()||self._locationManager.currentLocation();self._updateSelectedLocation(epiviz.datatypes.GenomicRange.fromStartEnd(currentLocation.seqName(),start,
end));return true}catch(error){return false}})};
epiviz.ui.ControlManager.prototype._initializeNavigationButtons=function(){var self=this;$("#moveright").button({icons:{primary:"ui-icon ui-icon-seek-next"},text:false}).click(function(){var currentLocation=self._locationManager.lastUnfilledLocationChangeRequest()||self._locationManager.currentLocation();var start=currentLocation.start()+Math.round(currentLocation.width()*self._stepRatio);self._updateSelectedLocation(new epiviz.datatypes.GenomicRange(currentLocation.seqName(),start,currentLocation.width()))});
$("#moveleft").button({icons:{primary:"ui-icon ui-icon-seek-prev"},text:false}).click(function(){var currentLocation=self._locationManager.lastUnfilledLocationChangeRequest()||self._locationManager.currentLocation();var start=currentLocation.start()-Math.round(currentLocation.width()*self._stepRatio);self._updateSelectedLocation(new epiviz.datatypes.GenomicRange(currentLocation.seqName(),start,currentLocation.width()))})};
epiviz.ui.ControlManager.prototype._initializeZoomButtons=function(){var self=this;var zoomin=$("#zoomin");zoomin.button({icons:{primary:"ui-icon ui-icon-zoomin"},text:false});var zoomout=$("#zoomout");zoomout.button({icons:{primary:"ui-icon ui-icon-zoomout"},text:false});var zoomHandler=function(zoomRatio){var currentLocation=self._locationManager.lastUnfilledLocationChangeRequest()||self._locationManager.currentLocation();var mid=currentLocation.start()+currentLocation.width()*.5;var width=Math.round(currentLocation.width()*
zoomRatio);var start=Math.round(mid-width*.5);self._updateSelectedLocation(new epiviz.datatypes.GenomicRange(currentLocation.seqName(),start,width))};zoomin.click(function(){zoomHandler(self._zoominRatio)});zoomout.click(function(){zoomHandler(self._zoomoutRatio)})};
epiviz.ui.ControlManager.prototype._initializeLocationSettingsDialog=function(){var self=this;$("#location-settings").button({text:false,icons:{primary:"ui-icon ui-icon-gear"}}).click(function(){$("#location-settings-dialog").dialog("open")});$("#location-settings-dialog").dialog({autoOpen:false,resizable:false,width:"300",buttons:{"Ok":function(){self._zoominRatio=$("#zoomin-ratio-text").val();self._zoomoutRatio=$("#zoomout-ratio-text").val();self._stepRatio=$("#navigation-step-ratio-text").val();
$(this).dialog("close")},"Cancel":function(){$("#zoomin-ratio-text").val(Globalize.format(self._zoominRatio,"n3"));$("#zoomout-ratio-text").val(Globalize.format(self._zoomoutRatio,"n3"));$("#navigation-step-ratio-text").val(Globalize.format(self._stepRatio,"n6"));$(this).dialog("close")}},modal:true});$("#zoomout-ratio-text").spinner({min:1.001,max:1E3,step:.001,start:1.2,numberFormat:"n3"}).val(self._zoomoutRatio);$("#zoomin-ratio-text").spinner({min:.001,max:.999,step:.01,start:.8,numberFormat:"n3"}).val(self._zoominRatio);
$("#navigation-step-ratio-text").spinner({min:1E-6,max:1,step:1E-6,start:.2,numberFormat:"n6"}).val(self._stepRatio)};
epiviz.ui.ControlManager.prototype._initializeChartMenus=function(){var self=this;var plotMenu=$("#plot-menu");var trackMenu=$("#track-menu");$("#plot-button").button({text:false,icons:{primary:"ui-icon ui-icon-scatterplot",secondary:"ui-icon-triangle-1-s"}}).click(function(){var menu=plotMenu;var visible=menu.is(":visible");$(".dropdown-menu").find(">:first-child").hide();if(!visible)menu.show().position({my:"left top",at:"left bottom",of:this});$(document).one("click",function(){menu.hide()});return false});
$("#track-button").button({text:false,icons:{primary:"ui-icon ui-icon-track",secondary:"ui-icon-triangle-1-s"}}).click(function(){var menu=trackMenu;var visible=menu.is(":visible");$(".dropdown-menu").find(">:first-child").hide();if(!visible)menu.show().position({my:"left top",at:"left bottom",of:this});$(document).one("click",function(){menu.hide()});return false});this._chartFactory.foreach(function(typeName,chartType){var id=sprintf("%s-menu-add-%s",chartType.chartDisplayType(),chartType.chartHtmlAttributeName());
var menu=chartType.chartDisplayType()==epiviz.ui.charts.ChartType.DisplayType.PLOT?plotMenu:trackMenu;menu.append(sprintf('<li><a href="javascript:void(0)" id="%s">Add New %s</a></li>',id,chartType.chartName()));$("#"+id).click(function(){var dialog=new epiviz.ui.controls.Wizard(sprintf("Add new %s",chartType.chartName()),{finish:function(data){self._addChart.notify({type:chartType,measurements:data.measurements})}},chartType.isRestrictedToSameDatasourceGroup()?[new epiviz.ui.controls.DatasourceGroupWizardStep,
new epiviz.ui.controls.MeaurementsWizardStep]:[new epiviz.ui.controls.MeaurementsWizardStep],new epiviz.ui.controls.MeasurementsDialogData(self._measurementsManager.measurements(),chartType.chartContentType(),undefined,undefined,undefined,undefined,chartType.chartName(),chartType.minSelectedMeasurements()),"750",undefined,chartType.isRestrictedToSameDatasourceGroup());dialog.show()})});plotMenu.hide().menu();trackMenu.hide().menu()};
epiviz.ui.ControlManager.prototype._initializeComputedMeasurementsMenu=function(){var self=this;$("#computed-measurements-button").button({text:false,icons:{primary:"ui-icon ui-icon-calculator"}}).click(function(){var dialog=new epiviz.ui.controls.ComputedMeasurementsDialog("Computed Measurements",{add:function(measurement){self._measurementsManager.addMeasurement(measurement)},remove:function(measurement){self._measurementsManager.removeMeasurement(measurement)},close:function(){}},self._measurementsManager.measurements(),
self._chartManager.chartsMeasurements());dialog.show()})};epiviz.ui.ControlManager.prototype._initializeHelpButton=function(){$("#help-button").button({text:false,icons:{primary:"ui-icon ui-icon-help"}}).click(function(){var win=window.open("http://epiviz.github.io/","_blank");win.focus()})};
epiviz.ui.ControlManager.prototype._initializeSearchBox=function(){var self=this;var searchBox=$("#search-box");searchBox.watermark("Find Gene/Probe");searchBox.autocomplete({source:function(request,callback){self._search.notify({searchTerm:request.term,callback:function(results){var items=[];for(var i=0;i<results.length;++i)items.push({value:results[i].probe||results[i].gene,label:results[i].probe||results[i].gene,html:results[i].probe?sprintf("<b>%s</b>, %s, [%s: %s - %s]",results[i].probe,results[i].gene,
results[i].seqName,Globalize.format(results[i].start,"n0"),Globalize.format(results[i].end,"n0")):sprintf("<b>%s</b>, [%s: %s - %s]",results[i].gene,results[i].seqName,Globalize.format(results[i].start,"n0"),Globalize.format(results[i].end,"n0")),range:epiviz.datatypes.GenomicRange.fromStartEnd(results[i].seqName,results[i].start,results[i].end)});callback(items)}})},minLength:1,select:function(event,ui){var currentLocation=self._locationManager.lastUnfilledLocationChangeRequest()||self._locationManager.currentLocation();
var seqName=ui.item.range.seqName();var start=Math.round(ui.item.range.start()+ui.item.range.width()*.5-currentLocation.width()*.5);var width=currentLocation.width();self._updateSelectedLocation(new epiviz.datatypes.GenomicRange(seqName,start,width))},focus:function(event){event.preventDefault()},open:function(){},close:function(){}}).data("autocomplete")._renderItem=function(ul,item){return $("<li></li>").data("item.autocomplete",item).append(sprintf("<a>%s</a>",item.html)).appendTo(ul)}};
epiviz.ui.ControlManager.prototype._initializeWorkspaceSaving=function(){var self=this;var saveTextBox=$("#save-workspace-text");var saveWorkspaceButton=$("#save-workspace-button");var deleteWorkspaceButton=$("#delete-workspace-button");saveWorkspaceButton.button({text:false,icons:{primary:"ui-icon-disk"}}).click(function(){var dialog=null;try{var name=saveTextBox.val();var pattern=/[a-zA-Z0-9_\s]+/g;var result=pattern.exec(name);if(result==name){if(!epiviz.workspaces.UserManager.USER_STATUS.loggedIn){dialog=
new epiviz.ui.controls.MessageDialog("User not logged in",{Yes:function(){self._loginLinkClicked.notify()},No:function(){}},"You need to log in in order to save the workspace. Do you wish to log in now?",epiviz.ui.controls.MessageDialog.Icon.QUESTION);dialog.show();return}self._saveWorkspace.notify({name:name,id:name==self._activeWorkspaceInfo.name?self._activeWorkspaceInfo.id:null})}else{dialog=new epiviz.ui.controls.MessageDialog("Invalid workspace name",{Ok:function(){$(this).remove()}},"Invalid workspace name: "+
name,epiviz.ui.controls.MessageDialog.Icon.ERROR);dialog.show()}}catch(error){dialog=new epiviz.ui.controls.MessageDialog("Error",{ok:function(){$(this).remove()}},"An error occurred while trying to save workspace: "+error.message,epiviz.ui.controls.MessageDialog.Icon.ERROR);dialog.show()}});deleteWorkspaceButton.button({text:false,icons:{primary:"ui-icon-trash"}}).click(function(e){if(!epiviz.workspaces.UserManager.USER_STATUS.loggedIn)return;var dialog=new epiviz.ui.controls.MessageDialog("Delete active workspace",
{Yes:function(){self._deleteActiveWorkspace.notify()},No:function(){}},"Are you sure you want to delete the active workspace?",epiviz.ui.controls.MessageDialog.Icon.QUESTION);dialog.show()});saveTextBox.watermark("Save Workspace Name");saveTextBox.autocomplete({source:function(request,callback){self._searchWorkspaces.notify({searchTerm:request.term,callback:function(workspaces){var items=[];for(var i=0;i<workspaces.length;++i)items.push({value:workspaces[i].id,label:workspaces[i].name,html:sprintf("<b>%s</b> %s",
workspaces[i].name,workspaces[i].id||"")});callback(items)}})},minLength:0,select:function(event,ui){event.preventDefault();self.updateSelectedWorkspace({id:ui.item.value||saveTextBox.val(),name:ui.item.label})},focus:function(event){event.preventDefault()},open:function(){},close:function(){}}).data("autocomplete")._renderItem=function(ul,item){return $("<li></li>").data("item.autocomplete",item).append(sprintf("<a>%s</a>",item.html)).appendTo(ul)};saveTextBox.click(function(){saveTextBox.autocomplete("search",
"")})};epiviz.ui.ControlManager.prototype._initializeLoginLink=function(){var self=this;$("#login-link").live({click:function(){self._loginLinkClicked.notify()}})};epiviz.ui.ControlManager.prototype._initializeLayout=function(){var layout=$("body").layout({applyDefaultStyles:true,east__size:390,east__minSize:390,east__initHidden:true,north__resizable:false,north__initHidden:false,south__initHidden:true,east__initClosed:true})};
epiviz.ui.ControlManager.prototype._checkBrowserCompatibility=function(){var ie=epiviz.utils.getInternetExplorerVersion();if(ie>0){var dialog=new epiviz.ui.controls.MessageDialog("Browser compatibility warning",{Ok:function(){}},"EpiViz works best on Google Chrome, Apple Safari or Mozilla Firefox. Please open it using one of those browsers.",epiviz.ui.controls.MessageDialog.Icon.ERROR);dialog.show()}};epiviz.ui.ControlManager.prototype._registerLocationChanged=function(){var self=this;this._locationManager.onCurrentLocationChanged().addListener(new epiviz.events.EventListener(function(e){self._updateSelectedLocation(e.newValue)}))};
epiviz.ui.ControlManager.prototype._registerSeqInfosUpdated=function(){var self=this;this._locationManager.onSeqInfosUpdated().addListener(new epiviz.events.EventListener(function(seqNames){self._updateSeqNames(seqNames)}))};goog.provide("epiviz.ui.WebArgsManager");epiviz.ui.WebArgsManager=function(locationManager,workspaceManager){this._locationManager=locationManager;this._workspaceManager=workspaceManager;this._registerLocationChanged();this._registerActiveWorkspaceChanged()};epiviz.ui.WebArgsManager.WEB_ARGS=epiviz.ui.WebArgsManager.WEB_ARGS||{};
epiviz.ui.WebArgsManager.prototype._updateUrl=function(){var url="?";var args=epiviz.ui.WebArgsManager.WEB_ARGS;if(!("ws"in args)&&"workspace"in args){args["ws"]=args["workspace"];delete args["workspace"]}for(var arg in args){if(!args.hasOwnProperty(arg))continue;if(Array.isArray(args[arg]))for(var i=0;i<args[arg].length;++i)url+=sprintf("%s[]=%s&",arg,args[arg][i]);else url+=sprintf("%s=%s&",arg,args[arg])}var ie=epiviz.utils.getInternetExplorerVersion();if(ie<0||ie>=10)switch(window.location.protocol){case "http:":case "https:":history.replaceState(null,
"",url);break;case "file:":break;default:}};epiviz.ui.WebArgsManager.prototype._registerLocationChanged=function(){var self=this;this._locationManager.onCurrentLocationChanged().addListener(new epiviz.events.EventListener(function(e){epiviz.ui.WebArgsManager.WEB_ARGS["seqName"]=e.newValue.seqName();epiviz.ui.WebArgsManager.WEB_ARGS["start"]=e.newValue.start();epiviz.ui.WebArgsManager.WEB_ARGS["end"]=e.newValue.end();self._updateUrl()}))};
epiviz.ui.WebArgsManager.prototype._registerActiveWorkspaceChanged=function(){var self=this;this._workspaceManager.onActiveWorkspaceChanged().addListener(new epiviz.events.EventListener(function(e){epiviz.ui.WebArgsManager.WEB_ARGS["ws"]=e.workspaceId||"";delete epiviz.ui.WebArgsManager.WEB_ARGS["workspace"];self._updateUrl()}))};goog.provide("epiviz.EpiViz");goog.require("epiviz.Config");goog.require("epiviz.data.DataProviderFactory");goog.require("epiviz.data.DataManager");goog.require("epiviz.data.DataProvider");
epiviz.EpiViz=function(config,locationManager,measurementsManager,controlManager,dataManager,chartFactory,chartManager,workspaceManager,userManager,webArgsManager){this._config=config;this._locationManager=locationManager;this._measurementsManager=measurementsManager;this._controlManager=controlManager;this._dataManager=dataManager;this._chartFactory=chartFactory;this._chartManager=chartManager;this._workspaceManager=workspaceManager;this._userManager=userManager;this._webArgsManager=webArgsManager;
this._registerRequestSeqInfos();this._registerRequestMeasurements();this._registerUiAddChart();this._registerUiSaveWorkspace();this._registerUiDeleteActiveWorkspace();this._registerUiLoginLinkClicked();this._registerUiSearchWorkspaces();this._registerUiActiveWorkspaceChanged();this._registerUiSearch();this._registerDataAddMeasurements();this._registerDataRemoveMeasurements();this._registerDataAddChart();this._registerDataRemoveChart();this._registerDataAddSeqInfos();this._registerDataRemoveSeqNames();
this._registerDataNavigate();this._registerDataRedraw();this._registerDataGetCurrentLocation();this._registerRequestWorkspaces();this._registerWorkspacesLoaded();this._registerActiveWorkspaceChanged();this._registerLocationChanged();var self=this;window.onbeforeunload=function(){if(epiviz.workspaces.UserManager.USER_STATUS.loggedIn&&self._workspaceManager.activeWorkspace().changed())return"There are unsaved changes in the current workspace. Do you wish to discard them?";return undefined}};
epiviz.EpiViz.SETTINGS={};epiviz.EpiViz.VERSION="2";epiviz.EpiViz.prototype.start=function(){this._controlManager.initialize();this._workspaceManager.initialize();this._measurementsManager.initialize();this._locationManager.initialize()};epiviz.EpiViz.prototype.config=function(){return this._config};
epiviz.EpiViz.prototype._addChart=function(type,measurements,chartId,chartProperties){chartId=this._chartManager.addChart(type,measurements,chartId,chartProperties);var range=this._workspaceManager.activeWorkspace().range();this._chartManager.addChartsLoaderAnimation(chartId);var chartMeasurementsMap={};chartMeasurementsMap[chartId]=measurements;var self=this;this._dataManager.getData(range,chartMeasurementsMap,function(chartId,data){self._chartManager.updateCharts(range,data,[chartId])});return chartId};
epiviz.EpiViz.prototype._registerRequestSeqInfos=function(){var self=this;this._locationManager.onRequestSeqInfos().addListener(new epiviz.events.EventListener(function(){self._dataManager.getSeqInfos(function(seqInfos){self._locationManager.updateSeqInfos(seqInfos)})}))};epiviz.EpiViz.prototype._registerRequestMeasurements=function(){var self=this;this._measurementsManager.onRequestMeasurements().addListener(new epiviz.events.EventListener(function(){self._dataManager.getMeasurements(function(measurements){self._measurementsManager.addMeasurements(measurements)})}))};
epiviz.EpiViz.prototype._registerRequestWorkspaces=function(){var self=this;this._workspaceManager.onRequestWorkspaces().addListener(new epiviz.events.EventListener(function(e){self._dataManager.getWorkspaces(function(rawWorkspaces){var ws=[];var activeWorkspace=null;for(var i=0;i<rawWorkspaces.length;++i){var w=epiviz.workspaces.Workspace.fromRawObject(rawWorkspaces[i],self._chartFactory);if(w.id()===null){activeWorkspace=w;continue}if(w.id()==e.activeWorkspaceId)activeWorkspace=w;ws.push(w)}self._workspaceManager.updateWorkspaces(ws,
activeWorkspace,e.activeWorkspaceId);self._workspaceManager.activeWorkspace().resetChanged()},"",e.activeWorkspaceId)}))};epiviz.EpiViz.prototype._registerUiAddChart=function(){var self=this;this._controlManager.onAddChart().addListener(new epiviz.events.EventListener(function(e){self._addChart(e.type,e.measurements)}))};
epiviz.EpiViz.prototype._registerUiSaveWorkspace=function(){var self=this;this._controlManager.onSaveWorkspace().addListener(new epiviz.events.EventListener(function(e){var workspace=self._workspaceManager.getByName(e.name);if(workspace)workspace=self._workspaceManager.activeWorkspace().copy(e.name,workspace.id());else workspace=self._workspaceManager.activeWorkspace().copy(e.name);self._dataManager.saveWorkspace(workspace,function(id){workspace=workspace.copy(workspace.name(),id);workspace.resetChanged();
self._workspaceManager.updateWorkspace(workspace);self._workspaceManager.changeActiveWorkspace(id)})}))};epiviz.EpiViz.prototype._registerUiDeleteActiveWorkspace=function(){var self=this;this._controlManager.onDeleteActiveWorkspace().addListener(new epiviz.events.EventListener(function(){self._dataManager.deleteWorkspace(self._workspaceManager.activeWorkspace());self._workspaceManager.deleteActiveWorkspace()}))};epiviz.EpiViz.prototype._registerUiLoginLinkClicked=function(){var self=this;this._controlManager.onLoginLinkClicked().addListener(new epiviz.events.EventListener(function(){self._userManager.toggleLogin()}))};
epiviz.EpiViz.prototype._registerUiSearchWorkspaces=function(){var self=this;this._controlManager.onSearchWorkspaces().addListener(new epiviz.events.EventListener(function(e){self._dataManager.getWorkspaces(function(workspaces){e.callback(workspaces)},e.searchTerm,e.searchTerm)}))};
epiviz.EpiViz.prototype._registerUiActiveWorkspaceChanged=function(){var self=this;this._controlManager.onActiveWorkspaceChanged().addListener(new epiviz.events.EventListener(function(e){var doChangeActiveWorkspace=function(){if(!self._workspaceManager.get(e.newValue.id))self._dataManager.getWorkspaces(function(rawWorkspaces){var result=null;for(var i=0;i<rawWorkspaces.length;++i){var w=epiviz.workspaces.Workspace.fromRawObject(rawWorkspaces[i],self._chartFactory);if(w.id()===null){result=w;break}}if(result)self._workspaceManager.changeActiveWorkspace(e.newValue.id,
result)},e.newValue.name,e.newValue.id);else self._workspaceManager.changeActiveWorkspace(e.newValue.id)};if(epiviz.workspaces.UserManager.USER_STATUS.loggedIn&&!self._workspaceManager.activeWorkspaceChanging()&&self._workspaceManager.activeWorkspace().changed()){var dialog=new epiviz.ui.controls.MessageDialog("Discard workspace changes",{Yes:function(){doChangeActiveWorkspace()},No:function(){e.cancel()}},"There are unsaved changes in the current workspace. Do you wish to discard them?",epiviz.ui.controls.MessageDialog.Icon.QUESTION);
dialog.show()}else doChangeActiveWorkspace()}))};epiviz.EpiViz.prototype._registerUiSearch=function(){var self=this;this._controlManager.onSearch().addListener(new epiviz.events.EventListener(function(e){self._dataManager.search(function(results){e.callback(results)},e.searchTerm)}))};
epiviz.EpiViz.prototype._registerDataAddMeasurements=function(){var self=this;this._dataManager.onRequestAddMeasurements().addListener(new epiviz.events.EventListener(function(e){try{self._measurementsManager.addMeasurements(e.measurements);e.result.success=true}catch(error){e.result.success=false;e.result.errorMessage=error.toString()}}))};
epiviz.EpiViz.prototype._registerDataRemoveMeasurements=function(){var self=this;this._dataManager.onRequestRemoveMeasurements().addListener(new epiviz.events.EventListener(function(e){try{self._measurementsManager.removeMeasurements(e.measurements);e.result.success=true}catch(error){e.result.success=false;e.result.errorMessage=error.toString()}}))};
epiviz.EpiViz.prototype._registerDataAddChart=function(){var self=this;this._dataManager.onRequestAddChart().addListener(new epiviz.events.EventListener(function(e){try{var chartType=self._chartFactory.get(e.type);var chartId=self._addChart(chartType,e.measurements);e.result.success=true;e.result.value={id:chartId}}catch(error){e.result.success=false;e.result.errorMessage=error.toString()}}))};
epiviz.EpiViz.prototype._registerDataRemoveChart=function(){var self=this;this._dataManager.onRequestRemoveChart().addListener(new epiviz.events.EventListener(function(e){try{self._chartManager.removeChart(e.id);e.result.success=true}catch(error){e.result.success=false;e.errorMessage=error.toString()}}))};
epiviz.EpiViz.prototype._registerDataAddSeqInfos=function(){var self=this;this._dataManager.onRequestAddSeqInfos().addListener(new epiviz.events.EventListener(function(e){try{self._locationManager.addSeqInfos(e.seqInfos);e.result.success=true}catch(error){e.result.success=false;e.errorMessage=error.toString()}}))};
epiviz.EpiViz.prototype._registerDataRemoveSeqNames=function(){var self=this;this._dataManager.onRequestRemoveSeqNames().addListener(new epiviz.events.EventListener(function(e){try{self._locationManager.removeSeqNames(e.seqNames);e.result.success=true}catch(error){e.result.success=false;e.errorMessage=error.toString()}}))};
epiviz.EpiViz.prototype._registerDataNavigate=function(){var self=this;this._dataManager.onRequestNavigate().addListener(new epiviz.events.EventListener(function(e){try{self._locationManager.changeCurrentLocation(e.range);e.result.success=true}catch(error){e.result.success=false;e.errorMessage=error.toString()}}))};
epiviz.EpiViz.prototype._registerDataRedraw=function(){var self=this;this._dataManager.onRequestRedraw().addListener(new epiviz.events.EventListener(function(e){try{var currentLocation=self._locationManager.currentLocation();self._locationManager.changeCurrentLocation(currentLocation);e.result.success=true}catch(error){e.result.success=false;e.errorMessage=error.toString()}}))};
epiviz.EpiViz.prototype._registerDataGetCurrentLocation=function(){var self=this;this._dataManager.onRequestCurrentLocation().addListener(new epiviz.events.EventListener(function(e){try{var currentLocation=self._locationManager.currentLocation();e.result.value={seqName:currentLocation.seqName(),start:currentLocation.start(),end:currentLocation.end()};e.result.success=true}catch(error){e.result.success=false;e.errorMessage=error.toString()}}))};
epiviz.EpiViz.prototype._registerWorkspacesLoaded=function(){var self=this;this._workspaceManager.onWorkspacesLoaded().addListener(new epiviz.events.EventListener(function(e){}))};
epiviz.EpiViz.prototype._registerActiveWorkspaceChanged=function(){var self=this;this._workspaceManager.onActiveWorkspaceChanged().addListener(new epiviz.events.EventListener(function(e){self._workspaceManager.startChangingActiveWorkspace();self._controlManager.updateSelectedWorkspace({id:e.newValue.id(),name:e.newValue.name()});self._locationManager.changeCurrentLocation(e.newValue.range());self._measurementsManager.removeMeasurements(self._measurementsManager.computedMeasurements());self._measurementsManager.addMeasurements(e.newValue.computedMeasurements());
self._chartManager.clear();var charts=e.newValue.charts();for(var displayType in charts){if(!charts.hasOwnProperty(displayType))continue;for(var i=0;i<charts[displayType].length;++i)self._addChart(charts[displayType][i].type,charts[displayType][i].properties.measurements,charts[displayType][i].id,charts[displayType][i].properties.copy())}self._workspaceManager.endChangingActiveWorkspace()}))};
epiviz.EpiViz.prototype._registerLocationChanged=function(){var self=this;this._locationManager.onCurrentLocationChanged().addListener(new epiviz.events.EventListener(function(e){self._chartManager.addChartsLoaderAnimation();var chartMeasurementsMap=self._chartManager.chartsMeasurements();self._dataManager.getData(e.newValue,chartMeasurementsMap,function(chartId,data){self._chartManager.updateCharts(e.newValue,data,[chartId])})}))};